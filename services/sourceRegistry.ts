// Copyright James Burvel O’Callaghan III
// President Citibank Demo Business Inc.

// This file is a registry of all source code files in the application.
// It's used by the ActionManager to create a downloadable zip of the entire app source.
// THIS FILE IS AUTO-GENERATED. DO NOT EDIT BY HAND.

export const sourceFiles: Record<string, string> = {
  '.gitignore': `# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
`,
  'App.tsx': `import React, { Suspense, useCallback, useState, useEffect } from 'react';
import { ErrorBoundary } from './components/ErrorBoundary.tsx';
import { useGlobalState } from './contexts/GlobalStateContext.tsx';
import { logEvent } from './services/telemetryService.ts';
import type { ViewType, AppUser } from './types.ts';
import { CommandPalette } from './components/CommandPalette.tsx';
import { NotificationProvider } from './contexts/NotificationContext.tsx';
import { useTheme } from './hooks/useTheme.ts';
import { VaultProvider } from './components/vault/VaultProvider.tsx';
import { initGoogleAuth } from './services/googleAuthService.ts';
import { LoginView } from './components/LoginView.tsx';
import { DesktopView } from './components/desktop/DesktopView.tsx';
import { isApiKeyConfigured, initializeAiClient } from './services/aiService.ts';
import { ApiKeyPromptModal } from './components/ApiKeyPromptModal.tsx';
import { OctokitProvider } from './contexts/OctokitContext.tsx';
import { useVaultModal } from './contexts/VaultModalContext.tsx';
import { isVaultInitialized } from './services/vaultService.ts';


export const LoadingIndicator: React.FC = () => (
    <div className="w-full h-full flex items-center justify-center bg-surface">
        <div className="flex items-center justify-center space-x-2">
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.2s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.4s' }}></div>
            <span className="text-text-secondary ml-2">Loading...</span>
        </div>
    </div>
);

interface LocalStorageConsentModalProps {
  onAccept: () => void;
  onDecline: () => void;
}

const LocalStorageConsentModal: React.FC<LocalStorageConsentModalProps> = ({ onAccept, onDecline }) => {
  return (
    <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
      <div 
        className="bg-surface border border-border rounded-2xl shadow-2xl shadow-black/50 w-full max-w-md m-4 p-8 text-center animate-pop-in"
      >
        <h2 className="text-2xl mb-4">Store Data Locally?</h2>
        <p className="text-text-secondary mb-6">
          This application uses your browser's local storage to save your settings and remember your progress between sessions. This data stays on your computer and is not shared.
        </p>
        <div className="flex justify-center gap-4">
          <button
            onClick={onDecline}
            className="px-6 py-2 bg-surface border border-border text-text-primary font-bold rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
          >
            Decline
          </button>
          <button
            onClick={onAccept}
            className="btn-primary px-6 py-2"
          >
            Accept
          </button>
        </div>
      </div>
    </div>
  );
};

const AppContent: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { activeView } = state;
    const [isCommandPaletteOpen, setCommandPaletteOpen] = useState(false);
  
    useEffect(() => {
      const handleKeyDown = (e: KeyboardEvent) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              setCommandPaletteOpen(isOpen => !isOpen);
          }
      };
      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);
  
    const handleViewChange = useCallback((view: ViewType, props: any = {}) => {
      logEvent('view_changed', { view });
      dispatch({ type: 'SET_VIEW', payload: { view, props } });
      setCommandPaletteOpen(false);
    }, [dispatch]);
  
    return (
        <OctokitProvider>
            <div className="relative flex h-full w-full bg-slate-800" style={{
                backgroundImage: 'radial-gradient(circle at top left, var(--color-primary), transparent 60%), radial-gradient(circle at bottom right, #38bdf8, transparent 50%)',
                backgroundBlendMode: 'multiply',
            }}>
                <ErrorBoundary>
                    <Suspense fallback={<LoadingIndicator />}>
                        <DesktopView openFeatureId={activeView} onNavigate={handleViewChange} />
                    </Suspense>
                </ErrorBoundary>
                <CommandPalette isOpen={isCommandPaletteOpen} onClose={() => setCommandPaletteOpen(false)} onSelect={handleViewChange} />
            </div>
        </OctokitProvider>
    )
}

const AppShell: React.FC = () => {
    const [consent, setConsent] = useState<'pending' | 'granted' | 'denied'>();
    const { state, dispatch } = useGlobalState();
    const { user, vaultState, isApiKeyMissing } = state;
    const { requestCreation } = useVaultModal();
    useTheme();

    useEffect(() => {
      try {
          const consentStatus = localStorage.getItem('devcore_ls_consent');
          if (!consentStatus) {
              setConsent('pending');
          } else {
              setConsent(consentStatus as 'granted' | 'denied');
          }
      } catch (e) {
          console.warn("Could not access localStorage.", e);
          setConsent('denied');
      }
    }, []);
    
    // Onboarding flow effect
    useEffect(() => {
        const runOnboardingChecks = async () => {
            if (consent !== 'granted' || !user) return;
            
            // Check if vault needs to be created
            const vaultExists = await isVaultInitialized();
            if (!vaultExists) {
                dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: false, isUnlocked: false } });
                const created = await requestCreation();
                if (created) {
                     dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true, isUnlocked: true } });
                } else {
                    return; // Stop flow if vault creation is cancelled
                }
            } else {
                 dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true } });
            }

            // After vault is confirmed to exist/be created, check for API key
            const keyConfigured = await isApiKeyConfigured();
            if (!keyConfigured) {
                dispatch({ type: 'SET_API_KEY_MISSING', payload: true });
            } else {
                dispatch({ type: 'SET_API_KEY_MISSING', payload: false });
                initializeAiClient(); // Attempt initialization
            }
        };
        runOnboardingChecks();

    }, [consent, user, requestCreation, dispatch]);


    useEffect(() => {
        const handleUserChanged = (appUser: AppUser | null) => {
            dispatch({ type: 'SET_APP_USER', payload: appUser });
        };

        const initAuth = () => {
            if (window.google) {
                initGoogleAuth(handleUserChanged);
            }
        };

        const gsiScript = document.getElementById('gsi-client');
        if (window.google) {
            initAuth();
        } else if (gsiScript) {
            gsiScript.addEventListener('load', initAuth);
            return () => gsiScript.removeEventListener('load', initAuth);
        }
    }, [dispatch]);
  
    const handleAcceptConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'granted');
          window.location.reload(); // Reload to re-evaluate storage access
      } catch (e) {
          console.error("Could not write to localStorage.", e);
          setConsent('denied');
      }
    };
  
    const handleDeclineConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'denied');
      } catch (e) {
          console.error("Could not write to localStorage.", e);
      }
      setConsent('denied');
    };
    
    const renderContent = () => {
        if (consent === 'pending') {
            return <LocalStorageConsentModal onAccept={handleAcceptConsent} onDecline={handleDeclineConsent} />;
        }
        if (consent === 'denied') {
            return <div className="w-full h-full flex items-center justify-center p-8 text-center">Local storage access is required for this application to function. Please reload and accept the prompt.</div>
        }
        if (!user) {
            return <LoginView />;
        }
        if (!vaultState.isInitialized || !vaultState.isUnlocked) {
             // The VaultProvider modals will handle prompting for creation/unlock
             return <LoadingIndicator />;
        }
        if (isApiKeyMissing) {
            return <ApiKeyPromptModal />;
        }
         // Only show main app if user is logged in, vault is handled, and key is present.
        if (user && vaultState.isUnlocked && !isApiKeyMissing) {
            return <AppContent />;
        }
        // Default to a loading state while checks are running
        return <LoadingIndicator />;
    };

    return renderContent();
};


const App: React.FC = () => {
    return (
        <div className="h-screen w-screen font-sans overflow-hidden bg-background">
            <NotificationProvider>
                <VaultProvider>
                    <AppShell />
                </VaultProvider>
            </NotificationProvider>
        </div>
    );
};

export default App;`,
  'ErrorBoundary.tsx': `import React from 'react';
import { logError } from '../services/index.ts';
import { debugErrorStream } from '../services/index.ts';
import { SparklesIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  aiHelp: string;
  isAiLoading: boolean;
}

export class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null, aiHelp: '', isAiLoading: false };
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logError(error, { componentStack: errorInfo.componentStack });
  }
  
  handleRevert = () => {
    window.location.reload();
  };

  handleAskAi = async () => {
    if (!this.state.error) return;

    this.setState({ isAiLoading: true, aiHelp: '' });
    try {
        const stream = debugErrorStream(this.state.error);
        let fullResponse = '';
        for await (const chunk of stream) {
            fullResponse += chunk;
            this.setState({ aiHelp: fullResponse });
        }
    } catch (e) {
        this.setState({ aiHelp: 'Sorry, the AI assistant could not be reached.' });
        logError(e as Error, { context: 'AI Error Debugging' });
    } finally {
        this.setState({ isAiLoading: false });
    }
};

  render() {
    if (this.state.hasError) {
      return (
        <div className="w-full h-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 bg-background text-text-primary">
            <div className="w-full max-w-4xl bg-surface border border-border rounded-lg p-6 shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Column: Error Details & Actions */}
                <div className="flex flex-col">
                    <h1 className="text-2xl font-bold text-red-600 mb-2">An Unexpected Error Occurred</h1>
                    <p className="text-text-secondary mb-4">A component has crashed. You can try reloading or ask the AI for debugging help.</p>
                    
                    <details className="text-left bg-gray-50 p-2 rounded-md max-w-xl text-xs font-mono mb-4 flex-grow overflow-auto border border-border">
                        <summary className="cursor-pointer">Error Details</summary>
                        <pre className="mt-2 whitespace-pre-wrap">{this.state.error?.stack}</pre>
                    </details>
                    
                    <div className="flex gap-4 mt-auto">
                        <button
                            onClick={this.handleRevert}
                            className="flex-1 px-4 py-2 bg-yellow-400 text-yellow-900 font-bold rounded-md hover:bg-yellow-300 transition-colors"
                        >
                            Reload Application
                        </button>
                         <button
                            onClick={this.handleAskAi}
                            disabled={this.state.isAiLoading}
                            className="btn-primary flex-1 px-4 py-2 flex items-center justify-center gap-2"
                        >
                            <SparklesIcon />
                            {this.state.isAiLoading ? 'Analyzing...' : 'Ask AI for Help'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Help */}
                <div className="flex flex-col bg-gray-50 rounded-lg p-4 border border-border">
                    <h2 className="text-lg font-bold text-text-primary mb-2">AI Assistant</h2>
                    <div className="flex-grow overflow-y-auto">
                        {this.state.isAiLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {this.state.aiHelp && <MarkdownRenderer content={this.state.aiHelp} />}
                        {!this.state.isAiLoading && !this.state.aiHelp && <p className="text-text-secondary text-center pt-10">Click "Ask AI" to get debugging suggestions.</p>}
                    </div>
                </div>
            </div>
        </div>
      );
    }

    return this.props.children;
  }
}`,
  'README.md': `# DevCore AI Toolkit

> A supercharged, secure, client-side toolkit for modern developers, powered by Gemini. It runs entirely in your browser, keeping your code, data, and API keys private and secure on your local machine.

DevCore is a serverless web application designed to be a powerful assistant in your development workflow. It combines a suite of intelligent tools with a unique, AI-driven command center that can orchestrate actions across your favorite services like Jira, Slack, and GitHub.

---

## ✨ Key Features

-   **AI Command Center:** The heart of the toolkit. Use natural language (\`Ctrl+K\`) to navigate, run features, and execute complex, multi-service workflows.
-   **Workspace Connector Hub:** Connect to Jira, Slack, GitHub, and more. Let the AI execute commands like "create a high-priority Jira ticket and post a summary to the #dev channel in Slack."
-   **AI Feature Builder:** Generate multi-file components, unit tests, and conventional commit messages from a single, high-level prompt.
-   **Intelligent Code Tools:** Explain complex code, migrate between languages, review for bugs and security vulnerabilities, and refactor with one click.
-   **Performance & Auditing:** Profile runtime performance, analyze bundle stats, and audit live websites for accessibility issues with AI-powered advice.
-   **Visual Editors & Sandboxes:** A suite of focused tools, from a CSS Grid editor and a RegEx sandbox to a PWA Manifest generator, designed to streamline frontend development.

---

## 🏛️ Architecture: Secure & Client-Side

DevCore is built on a serverless, client-side architecture. This design choice offers several key advantages:

-   **Privacy First:** Your code, prompts, and sensitive data never leave your browser. All processing happens locally.
-   **Ultimate Security:** API keys and credentials for services like GitHub, Gemini, or Jira are encrypted with AES-GCM using the Web Crypto API. They are stored securely in your browser's IndexedDB and can only be decrypted with your master password.
-   **Runs Anywhere:** As a static application, you can deploy it on any CDN (like GitHub Pages or Netlify) or simply run it from your local filesystem. No backend, no databases, no complex setup.

---

## 🚀 Getting Started

1.  **Open the App:** Just open \`index.html\` in your browser.
2.  **Onboarding:** On first use, you'll be guided through a one-time setup:
    -   **Consent:** Grant permission for the app to use local storage.
    -   **Sign-In:** Sign in with your Google Account.
    -   **Create Vault:** Create a master password. This password encrypts and decrypts your credentials locally and is **never** stored.
    -   **Provide API Key:** If an API key was not provided during the build process, you will be prompted to enter your own Gemini API key, which will be stored securely in your new vault.
3.  **Connect Your Services:** Navigate to the **Workspace Connector Hub** to securely add your API keys for services like GitHub, Jira, and Slack.
4.  **Use the AI Command Center:** Press \`Ctrl+K\` (or \`Cmd+K\`) anywhere to open the command palette and start giving instructions to the AI.

---

## 🔌 The Workspace Connector Hub

This is the core of DevCore's workflow automation. Instead of just being a collection of tools, the Hub turns the app into a true command center.

-   **Connect Once, Use Everywhere:** Securely store your API tokens for essential developer services in the encrypted vault.
-   **AI-Powered Orchestration:** The AI Command Center can use these connections to perform multi-step actions across different platforms.
-   **Example Command:** _"A new critical bug was reported. Create a high-priority ticket in Jira, post a summary to the #engineering channel in Slack, and create a new git branch called \`hotfix/payment-bug\`."_

---

## 🔐 Security & Your Data

Your privacy is paramount. Here's how your data is handled:

-   **No Server-Side Storage:** All files, settings, and credentials reside exclusively in your browser's IndexedDB.
-   **End-to-End Encryption (Locally):** Credentials entered into the Vault are encrypted using the Web Crypto API before being stored. The encryption key is derived from your master password and is only held in memory during your session.
-   **Direct API Calls:** When you use an integrated service, the app makes direct, client-to-service API calls. Your data is not proxied through any intermediary server.

---

## 🛠️ Scope & Limitations

As a client-side application, DevCore has a focused scope. It is designed to be a powerful **assistant** for your development workflow, not a replacement for your primary IDE, backend services, or CI/CD platform. It excels at code generation, analysis, and API-based automation but does not run backend servers, train models, or manage infrastructure.`,
  'components/ActionManager.tsx': `import React, { useState } from 'react';
import JSZip from 'jszip';
import { getAllFiles } from '../services/dbService.ts';
import { ArrowDownTrayIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';
import { sourceFiles } from '../services/sourceRegistry.ts';

export const ActionManager: React.FC = () => {
    const [isLoading, setIsLoading] = useState<string | null>(null);

    const handleDownloadSource = async () => {
        setIsLoading('zip');
        try {
            const zip = new JSZip();

            for (const [filePath, content] of Object.entries(sourceFiles)) {
                zip.file(filePath, content);
            }

            const generatedFiles = await getAllFiles();
            if (generatedFiles.length > 0) {
                const generatedFolder = zip.folder('generated');
                generatedFiles.forEach(file => {
                    generatedFolder?.file(file.filePath, file.content);
                });
            }
            
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = 'devcore-ai-toolkit-source.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Failed to create ZIP file", error);
            alert(\`Error creating ZIP: \${error instanceof Error ? error.message : 'Unknown error'}\`);
        } finally {
            setIsLoading(null);
        }
    };

    return (
        <div className="absolute top-6 right-6 z-10">
            <button
                onClick={handleDownloadSource}
                disabled={!!isLoading}
                className="w-14 h-14 bg-primary text-text-on-primary rounded-full flex items-center justify-center shadow-lg hover:opacity-90 transition-colors disabled:bg-slate-600"
                aria-label="Download App Source Code & Generated Files"
                title="Download App Source Code & Generated Files"
            >
                {isLoading === 'zip' ? <LoadingSpinner /> : <ArrowDownTrayIcon />}
            </button>
        </div>
    );
};`,
  'components/AiCodeExplainer.tsx': `import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import mermaid from 'mermaid';
import { explainCodeStructured, generateMermaidJs } from '../services/index.ts';
import type { StructuredExplanation } from '../types.ts';
import { CpuChipIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

const exampleCode = \`const bubbleSort = (arr) => {
  for (let i = 0; i < arr.length; i++) {
    for (let j = 0; j < arr.length - i - 1; j++) {
      if (arr[j] > arr[j + 1]) {
        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
      }
    }
  }
  return arr;
};\`;

type ExplanationTab = 'summary' | 'lineByLine' | 'complexity' | 'suggestions' | 'flowchart';

const simpleSyntaxHighlight = (code: string) => {
    const escapedCode = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    return escapedCode
        .replace(/\\b(const|let|var|function|return|if|for|=>|import|from|export|default)\\b/g, '<span class="text-indigo-400 font-semibold">\$1</span>')
        .replace(/(\\\`|'|")(.*?)(\\\`|'|")/g, '<span class="text-emerald-400">\$1\$2\$3</span>')
        .replace(/(\\/\\/.*)/g, '<span class="text-gray-400 italic">\$1</span>')
        .replace(/(\\{|\\}|\\(|\\)|\\[|\\])/g, '<span class="text-gray-400">\$1</span>');
};

mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

export const AiCodeExplainer: React.FC<{ initialCode?: string }> = ({ initialCode }) => {
    const [code, setCode] = useState<string>(initialCode || exampleCode);
    const [explanation, setExplanation] = useState<StructuredExplanation | null>(null);
    const [mermaidCode, setMermaidCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [activeTab, setActiveTab] = useState<ExplanationTab>('summary');
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const preRef = useRef<HTMLPreElement>(null);
    const mermaidContainerRef = useRef<HTMLDivElement>(null);

    const handleExplain = useCallback(async (codeToExplain: string) => {
        if (!codeToExplain.trim()) {
            setError('Please enter some code to explain.');
            return;
        }
        setIsLoading(true);
        setError('');
        setExplanation(null);
        setMermaidCode('');
        setActiveTab('summary');
        try {
            const [explanationResult, mermaidResult] = await Promise.all([
                explainCodeStructured(codeToExplain),
                generateMermaidJs(codeToExplain)
            ]);
            setExplanation(explanationResult);
            setMermaidCode(mermaidResult.replace(/\`\`\`mermaid\\n|\`\`\`/g, ''));

        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to get explanation: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);
    
    useEffect(() => {
        if (initialCode) {
            setCode(initialCode);
            handleExplain(initialCode);
        }
    }, [initialCode, handleExplain]);

    useEffect(() => {
        const renderMermaid = async () => {
             if (activeTab === 'flowchart' && mermaidCode && mermaidContainerRef.current) {
                try {
                    mermaidContainerRef.current.innerHTML = ''; // Clear previous
                    const { svg } = await mermaid.render(\`mermaid-graph-\${Date.now()}\`, mermaidCode);
                    mermaidContainerRef.current.innerHTML = svg;
                } catch (e) {
                    console.error("Mermaid rendering error:", e);
                    mermaidContainerRef.current.innerHTML = \`<p class="text-red-500">Error rendering flowchart.</p>\`;
                }
            }
        }
        renderMermaid();
    }, [activeTab, mermaidCode]);


    const handleScroll = () => {
        if (preRef.current && textareaRef.current) {
            preRef.current.scrollTop = textareaRef.current.scrollTop;
            preRef.current.scrollLeft = textareaRef.current.scrollLeft;
        }
    };

    const highlightedCode = useMemo(() => simpleSyntaxHighlight(code), [code]);

    const renderTabContent = () => {
        if (!explanation) return null;
        switch(activeTab) {
            case 'summary':
                return <MarkdownRenderer content={explanation.summary} />;
            case 'lineByLine':
                return (
                    <div className="space-y-3">
                        {explanation.lineByLine.map((item, index) => (
                            <div key={index} className="p-3 bg-background rounded-md border border-border">
                                <p className="font-mono text-xs text-primary mb-1">Lines: {item.lines}</p>
                                <p className="text-sm">{item.explanation}</p>
                            </div>
                        ))}
                    </div>
                );
            case 'complexity':
                return (
                    <div>
                        <p><strong>Time Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.time}</span></p>
                        <p><strong>Space Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.space}</span></p>
                    </div>
                );
            case 'suggestions':
                return (
                     <ul className="list-disc list-inside space-y-2">
                        {explanation.suggestions.map((item, index) => <li key={index}>{item}</li>)}
                    </ul>
                );
            case 'flowchart':
                return (
                    <div ref={mermaidContainerRef} className="w-full h-full flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
        }
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex-shrink-0">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Explainer</span>
                </h1>
                <p className="text-text-secondary mt-1">Get a detailed, structured analysis of any code snippet.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                
                {/* Left Column: Code Input */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Your Code</label>
                    <div className="relative flex-grow bg-surface border border-border rounded-md focus-within:ring-2 focus-within:ring-primary overflow-hidden">
                        <textarea
                            ref={textareaRef}
                            id="code-input"
                            value={code}
                            onChange={(e) => setCode(e.target.value)}
                            onScroll={handleScroll}
                            placeholder="Paste your code here..."
                            spellCheck="false"
                            className="absolute inset-0 w-full h-full p-4 bg-transparent resize-none font-mono text-sm text-transparent caret-primary outline-none z-10"
                        />
                        <pre 
                            ref={preRef}
                            aria-hidden="true"
                            className="absolute inset-0 w-full h-full p-4 font-mono text-sm text-text-primary pointer-events-none z-0 whitespace-pre-wrap overflow-auto no-scrollbar"
                            dangerouslySetInnerHTML={{ __html: highlightedCode + '\\n' }}
                        />
                    </div>
                    <div className="mt-4 flex-shrink-0">
                        <button
                            onClick={() => handleExplain(code)}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner/> : 'Analyze Code'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Analysis */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Analysis</label>
                    <div className="relative flex-grow flex flex-col bg-surface border border-border rounded-md overflow-hidden">
                        <div className="flex-shrink-0 flex border-b border-border">
                           {(['summary', 'lineByLine', 'complexity', 'suggestions', 'flowchart'] as ExplanationTab[]).map(tab => (
                               <button key={tab} onClick={() => setActiveTab(tab)} disabled={!explanation}
                                className={\`px-4 py-2 text-sm font-medium capitalize transition-colors \${activeTab === tab ? 'bg-background text-primary font-semibold' : 'text-text-secondary hover:bg-gray-100 dark:hover:bg-slate-700 disabled:text-gray-400 dark:disabled:text-slate-500'}\`}>
                                   {tab.replace(/([A-Z])/g, ' \$1')}
                               </button>
                           ))}
                        </div>
                        <div className="p-4 flex-grow overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {explanation && !isLoading && renderTabContent()}
                            {!isLoading && !explanation && !error && <div className="text-text-secondary h-full flex items-center justify-center">The analysis will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/AiCodingChallenge.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { generateCodingChallengeStream } from '../services/index.ts';
import { BeakerIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';
import { MarkdownRenderer } from './shared/index.tsx';

export const AiCodingChallenge: React.FC = () => {
    const [challenge, setChallenge] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        setChallenge('');
        try {
            const stream = generateCodingChallengeStream(null);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChallenge(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate challenge: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        // Generate a challenge on initial load for a better user experience
        handleGenerate();
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold flex items-center">
                        <BeakerIcon />
                        <span className="ml-3">AI Coding Challenge Generator</span>
                    </h1>
                    <p className="text-text-secondary mt-1">Generate a unique coding problem to test your skills.</p>
                </div>
                <button
                    onClick={handleGenerate}
                    disabled={isLoading}
                    className="btn-primary flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Generate New Challenge'}
                </button>
            </header>
            <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                {isLoading && (
                     <div className="flex items-center justify-center h-full">
                        <LoadingSpinner />
                     </div>
                )}
                {error && <p className="text-red-500">{error}</p>}
                {challenge && !isLoading && (
                    <MarkdownRenderer content={challenge} />
                )}
                 {!isLoading && !challenge && !error && (
                    <div className="text-text-secondary h-full flex items-center justify-center">
                        Click "Generate New Challenge" to start.
                    </div>
                )}
            </div>
        </div>
    );
};`,
  'components/AiCommitGenerator.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { generateCommitMessageStream } from '../services/index.ts';
import { GitBranchIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';

const exampleDiff = \`diff --git a/src/components/Button.tsx b/src/components/Button.tsx
index 1b2c3d4..5e6f7g8 100644
--- a/src/components/Button.tsx
+++ b/src/components/Button.tsx
@@ -1,7 +1,7 @@
 import React from 'react';

 interface ButtonProps {
-  text: string;
+  label: string;
   onClick: () => void;
 }
\`;

export const AiCommitGenerator: React.FC<{ diff?: string }> = ({ diff: initialDiff }) => {
    const [diff, setDiff] = useState<string>(initialDiff || exampleDiff);
    const [message, setMessage] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async (diffToAnalyze: string) => {
        if (!diffToAnalyze.trim()) {
            setError('Please paste a diff to generate a message.');
            return;
        }
        setIsLoading(true);
        setError('');
        setMessage('');
        try {
            const stream = generateCommitMessageStream(diffToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setMessage(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate message: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialDiff) {
            setDiff(initialDiff);
            handleGenerate(initialDiff);
        }
    }, [initialDiff, handleGenerate]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(message);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Commit Message Generator</span>
                </h1>
                <p className="text-slate-400 mt-1">Paste your diff and let Gemini craft the perfect commit message.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                    <label htmlFor="diff-input" className="text-sm font-medium text-slate-400 mb-2">Git Diff</label>
                    <textarea
                        id="diff-input"
                        value={diff}
                        onChange={(e) => setDiff(e.target.value)}
                        placeholder="Paste your git diff here..."
                        className="flex-grow p-4 bg-slate-900 border border-slate-700 rounded-md resize-none font-mono text-sm text-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none"
                    />
                     <button
                        onClick={() => handleGenerate(diff)}
                        disabled={isLoading}
                        className="btn-primary mt-4 w-full flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Commit Message'}
                    </button>
                </div>
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-slate-400 mb-2">Generated Message</label>
                    <div className="relative flex-grow p-4 bg-slate-800/50 border border-slate-700/50 rounded-md overflow-y-auto">
                        {isLoading && (
                             <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                             </div>
                        )}
                        {error && <p className="text-red-400">{error}</p>}
                        {message && !isLoading && (
                            <>
                               <button onClick={handleCopy} className="absolute top-2 right-2 px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded-md text-xs">Copy</button>
                               <pre className="whitespace-pre-wrap font-sans text-slate-200">{message}</pre>
                            </>
                        )}
                         {!isLoading && !message && !error && (
                            <div className="text-slate-500 h-full flex items-center justify-center">
                                The commit message will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/ApiKeyPromptModal.tsx': `import React, { useState } from 'react';
import { useGlobalState } from '../contexts/GlobalStateContext.tsx';
import { useVaultModal } from '../contexts/VaultModalContext.tsx';
import { saveCredential } from '../services/vaultService.ts';
import { initializeAiClient } from '../services/aiService.ts';
import { LoadingSpinner } from './shared/LoadingSpinner.tsx';
import { useNotification } from '../contexts/NotificationContext.tsx';

export const ApiKeyPromptModal: React.FC = () => {
    const { dispatch } = useGlobalState();
    const { requestUnlock } = useVaultModal();
    const { addNotification } = useNotification();
    const [apiKey, setApiKey] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!apiKey.trim()) {
            addNotification('Please enter an API key.', 'error');
            return;
        }

        setIsLoading(true);

        try {
            // Ensure the vault is unlocked before saving
            const unlocked = await requestUnlock();
            if (!unlocked) {
                addNotification('Vault must be unlocked to save the API key.', 'error');
                setIsLoading(false);
                return;
            }

            // Save the key and re-initialize the AI client
            await saveCredential('gemini_api_key', apiKey);
            await initializeAiClient();

            addNotification('API Key saved successfully!', 'success');
            dispatch({ type: 'SET_API_KEY_MISSING', payload: false });

        } catch (error) {
            addNotification(error instanceof Error ? error.message : 'An unknown error occurred.', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-md m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Enter Gemini API Key</h2>
                <p className="text-sm text-text-secondary mb-4">
                    Your Gemini API key is required to power the AI features. It will be stored securely and encrypted in your browser's local storage.
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="api-key-input" className="block text-sm font-medium">API Key</label>
                        <input
                            id="api-key-input"
                            type="password"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[100px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Save & Continue'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};`,
  'components/CommandPalette.tsx': `
import React, { useState, useEffect, useMemo } from 'react';
import { ALL_FEATURES } from './features/index.ts';
import type { ViewType } from '../types.ts';

interface CommandPaletteProps {
  isOpen: boolean;
  onClose: () => void;
  onSelect: (view: ViewType) => void;
}

export const CommandPalette: React.FC<CommandPaletteProps> = ({ isOpen, onClose, onSelect }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);

  useEffect(() => {
    if (!isOpen) {
      setSearchTerm('');
      setSelectedIndex(0);
    }
  }, [isOpen]);
  
  const commandOptions = useMemo(() => {
    const navigationCommands = [
      { id: 'ai-feature-builder', name: 'Go to AI Builder', category: 'Navigation', icon: <span />, description: ''},
    ];
    
    const featureCommands = ALL_FEATURES.map(f => ({...f, name: \`Open: \${f.name}\`}));

     return [
      ...navigationCommands,
      ...featureCommands,
     ].filter(
        (feature) =>
          feature.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          feature.category.toLowerCase().includes(searchTerm.toLowerCase())
      );
  }, [searchTerm]);

  useEffect(() => {
    setSelectedIndex(0);
  }, [commandOptions.length]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isOpen) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedIndex((prev) => (prev + 1) % commandOptions.length);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedIndex((prev) => (prev - 1 + commandOptions.length) % commandOptions.length);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = commandOptions[selectedIndex];
        if (selected) {
          onSelect(selected.id as ViewType);
        }
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, commandOptions, selectedIndex, onSelect]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-start justify-center pt-20" onClick={onClose}>
      <div
        className="w-full max-w-xl bg-surface border border-border rounded-lg shadow-2xl overflow-hidden"
        onClick={(e) => e.stopPropagation()}
      >
        <input
          type="text"
          placeholder="Type a command or search..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          autoFocus
          className="w-full p-4 bg-surface text-text-primary text-lg focus:outline-none border-b border-border"
        />
        <ul className="max-h-96 overflow-y-auto p-2">
          {commandOptions.length > 0 ? (
            commandOptions.map((item, index) => (
              <li
                key={item.id + index}
                onMouseDown={() => {
                   onSelect(item.id as ViewType);
                }}
                className={\`flex items-center justify-between p-3 rounded-md cursor-pointer \${
                  selectedIndex === index ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100'
                }\`}
              >
                <div className="flex items-center space-x-3">
                    <div className="text-text-secondary">{item.icon}</div>
                    <span className="text-text-primary">{item.name}</span>
                </div>
                <span className="text-xs text-text-secondary bg-gray-100 px-2 py-1 rounded">{item.category}</span>
              </li>
            ))
          ) : (
            <li className="p-4 text-center text-text-secondary">No results found.</li>
          )}
        </ul>
      </div>
    </div>
  );
};`,
  'components/ErrorBoundary.tsx': `import React from 'react';
import { logError } from '../services/telemetryService.ts';
import { debugErrorStream } from '../services/aiService.ts';
import { SparklesIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  aiHelp: string;
  isAiLoading: boolean;
}

export class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null, aiHelp: '', isAiLoading: false };
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logError(error, { componentStack: errorInfo.componentStack });
  }
  
  handleRevert = () => {
    window.location.reload();
  };

  handleAskAi = async () => {
    if (!this.state.error) return;

    this.setState({ isAiLoading: true, aiHelp: '' });
    try {
        const stream = debugErrorStream(this.state.error);
        let fullResponse = '';
        for await (const chunk of stream) {
            fullResponse += chunk;
            this.setState({ aiHelp: fullResponse });
        }
    } catch (e) {
        this.setState({ aiHelp: 'Sorry, the AI assistant could not be reached.' });
        logError(e as Error, { context: 'AI Error Debugging' });
    } finally {
        this.setState({ isAiLoading: false });
    }
};

  render() {
    if (this.state.hasError) {
      return (
        <div className="w-full h-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 bg-background text-text-primary">
            <div className="w-full max-w-4xl bg-surface border border-border rounded-lg p-6 shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="flex flex-col">
                    <h1 className="text-2xl font-bold text-red-600 mb-2">An Unexpected Error Occurred</h1>
                    <p className="text-text-secondary mb-4">A component has crashed. You can try reloading or ask the AI for debugging help.</p>
                    
                    <details className="text-left bg-gray-50 dark:bg-slate-900 p-2 rounded-md max-w-xl text-xs font-mono mb-4 flex-grow overflow-auto border border-border">
                        <summary className="cursor-pointer">Error Details</summary>
                        <pre className="mt-2 whitespace-pre-wrap">{this.state.error?.stack}</pre>
                    </details>
                    
                    <div className="flex gap-4 mt-auto">
                        <button
                            onClick={this.handleRevert}
                            className="flex-1 px-4 py-2 bg-yellow-400 text-yellow-900 font-bold rounded-md hover:bg-yellow-300 transition-colors"
                        >
                            Reload Application
                        </button>
                         <button
                            onClick={this.handleAskAi}
                            disabled={this.state.isAiLoading}
                            className="btn-primary flex-1 px-4 py-2 flex items-center justify-center gap-2"
                        >
                            <SparklesIcon />
                            {this.state.isAiLoading ? 'Analyzing...' : 'Ask AI for Help'}
                        </button>
                    </div>
                </div>

                <div className="flex flex-col bg-gray-50 dark:bg-slate-900 rounded-lg p-4 border border-border">
                    <h2 className="text-lg font-bold text-text-primary mb-2">AI Assistant</h2>
                    <div className="flex-grow overflow-y-auto">
                        {this.state.isAiLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {this.state.aiHelp && <MarkdownRenderer content={this.state.aiHelp} />}
                        {!this.state.isAiLoading && !this.state.aiHelp && <p className="text-text-secondary text-center pt-10">Click "Ask AI" to get debugging suggestions.</p>}
                    </div>
                </div>
            </div>
        </div>
      );
    }

    return this.props.children;
  }
}
`,
  'components/FeatureGrid.tsx': `

import React, { useState, useMemo } from 'react';
import type { Feature } from '../types.ts';

interface FeatureCardProps {
  feature: Feature;
  onClick: () => void;
}

const FeatureCard: React.FC<FeatureCardProps> = ({ feature, onClick }) => {
  return (
    <div
      onClick={onClick}
      className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 flex flex-col justify-between transition-all duration-200 hover:bg-slate-800 hover:border-slate-700 hover:shadow-lg hover:shadow-cyan-500/10 cursor-pointer"
    >
      <div>
        <div className="flex items-center space-x-3 mb-2">
          <div className="text-cyan-400">{feature.icon}</div>
          <h3 className="font-bold text-slate-200">{feature.name}</h3>
        </div>
        <p className="text-sm text-slate-400">{feature.description}</p>
      </div>
      <div className="text-xs text-slate-500 mt-4">{feature.category}</div>
    </div>
  );
};


export const FeatureGrid: React.FC<{ features: Feature[], onFeatureSelect?: (id: string) => void }> = ({ features, onFeatureSelect }) => {
  const [searchTerm, setSearchTerm] = useState('');

  const filteredFeatures = useMemo(() => {
    const featureList = features || [];
    if (!searchTerm) return featureList;
    return featureList.filter(
      (feature) =>
        feature.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        feature.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        feature.category.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm, features]);

  return (
    <div className="p-4 sm:p-6 lg:p-8 h-full">
      <div className="mb-8 text-center">
        <h1 className="text-4xl font-extrabold text-slate-100 tracking-tight">DevCore AI Toolkit</h1>
        <p className="mt-2 text-lg text-slate-400">A focused toolkit for modern development, powered by AI.</p>
        <div className="mt-6 max-w-xl mx-auto">
          <input
            type="text"
            placeholder="Search features..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition-shadow"
          />
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {filteredFeatures.map((feature) => (
          <FeatureCard key={feature.id} feature={feature} onClick={() => onFeatureSelect?.(feature.id)} />
        ))}
      </div>
    </div>
  );
};`,
  'components/LoginView.tsx': `import React from 'react';
import { signInWithGoogle } from '../services/googleAuthService.ts';

export const LoginView: React.FC = () => {
    return (
        <div className="h-full w-full flex items-center justify-center bg-background">
            <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md shadow-lg animate-pop-in">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-primary mx-auto mb-4">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                <h1 className="text-2xl font-bold text-text-primary">Welcome to DevCore AI</h1>
                <p className="text-text-secondary my-4">
                    Please sign in with your Google account to securely access your workspace tools and manage API connections.
                </p>
                <button 
                    onClick={signInWithGoogle} 
                    className="btn-primary w-full px-6 py-3 flex items-center justify-center gap-2 mx-auto"
                >
                    Sign in with Google
                </button>
            </div>
        </div>
    );
};`,
  'components/SettingsView.tsx': `import React from 'react';
import { useGlobalState } from '../contexts/GlobalStateContext.tsx';
import { clearAllFiles } from '../services/dbService.ts';
import { useLocalStorage } from '../hooks/useLocalStorage.ts';
import { useTheme } from '../hooks/useTheme.ts';
import { ALL_FEATURES } from './features/index.ts';
import { TrashIcon, SunIcon, MoonIcon } from './icons.tsx';

const ToggleSwitch: React.FC<{ checked: boolean, onChange: () => void }> = ({ checked, onChange }) => {
    return (
        <button
            role="switch"
            aria-checked={checked}
            onClick={onChange}
            className={\`\${checked ? 'bg-primary' : 'bg-gray-300 dark:bg-slate-600'} relative inline-flex h-6 w-11 items-center rounded-full transition-colors\`}
        >
            <span className={\`\${checked ? 'translate-x-6' : 'translate-x-1'} inline-block h-4 w-4 transform rounded-full bg-white transition-transform\`} />
        </button>
    );
};

export const SettingsView: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const [themeState, toggleTheme, , clearCustomTheme] = useTheme();
    const [, setSnippets] = useLocalStorage('devcore_snippets', []);
    const [, setNotes] = useLocalStorage('devcore_moodboard', []);
    const [, setDevNotes] = useLocalStorage('devcore_notes', []);
    const [, setPersonalities] = useLocalStorage('devcore_ai_personalities', []);

    const handleClearGeneratedFiles = async () => {
        if (window.confirm("Are you sure you want to delete all AI-generated files? This cannot be undone.")) {
            await clearAllFiles();
            alert("Generated files cleared.");
        }
    };
    
    const handleClearSnippets = () => {
        if (window.confirm("Are you sure you want to delete all saved snippets? This cannot be undone.")) {
            setSnippets([]);
            alert("Snippets cleared.");
        }
    };

    const handleClearNotes = () => {
        if (window.confirm("Are you sure you want to delete all notes and moodboard items? This cannot be undone.")) {
            setNotes([]);
            setDevNotes([]);
            alert("Notes & Moodboard cleared.");
        }
    };
    
    const handleClearPersonalities = () => {
        if (window.confirm("Are you sure you want to delete all AI Personalities? This cannot be undone.")) {
            setPersonalities([]);
            alert("AI Personalities cleared.");
        }
    }

    return (
        <div className="w-full text-text-primary">
            <header className="sticky top-0 z-10 p-4 sm:p-6 lg:p-8 border-b border-border bg-surface/80 backdrop-blur-sm">
                <div className="max-w-4xl mx-auto w-full">
                    <h1 className="text-4xl font-extrabold tracking-tight">Settings</h1>
                    <p className="mt-2 text-lg text-text-secondary">Manage application preferences and data.</p>
                </div>
            </header>

            <div className="p-4 sm:p-6 lg:p-8 space-y-8 max-w-4xl mx-auto w-full">
                 {/* Appearance Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Appearance</h2>
                    <div className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg">
                        <div>
                            <p className="font-medium">Theme</p>
                            <p className="text-sm text-text-secondary">Switch between light and dark mode.</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <SunIcon />
                            <ToggleSwitch checked={themeState.mode === 'dark'} onChange={toggleTheme} />
                            <MoonIcon />
                        </div>
                    </div>
                    <div className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg mt-4">
                        <div>
                            <p className="font-medium">Custom Theme</p>
                            <p className="text-sm text-text-secondary">Revert to the default application theme.</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={clearCustomTheme} disabled={!themeState.customColors} className="px-4 py-2 text-sm rounded-md bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                Revert to Default
                            </button>
                        </div>
                    </div>
                </section>
                
                 {/* Feature Visibility Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Feature Visibility</h2>
                     <p className="text-sm text-text-secondary mb-4">
                        Hide or show features in the main sidebar. This does not disable them; they can still be accessed via the AI Command Center.
                    </p>
                    <div className="space-y-2">
                        {ALL_FEATURES.filter(f => !['ai-command-center', 'connections', 'project-explorer'].includes(f.id)).map(feature => {
                            const isVisible = !state.hiddenFeatures.includes(feature.id);
                            return (
                                <div key={feature.id} className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg">
                                    <div>
                                        <p className="font-medium">{feature.name}</p>
                                        <p className="text-sm text-text-secondary">{feature.description}</p>
                                    </div>
                                    <ToggleSwitch 
                                        checked={isVisible}
                                        onChange={() => dispatch({ type: 'TOGGLE_FEATURE_VISIBILITY', payload: { featureId: feature.id } })}
                                    />
                                </div>
                            );
                        })}
                    </div>
                </section>
                
                {/* Data Management Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Data Management</h2>
                    <div className="space-y-4">
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Generated Files</p>
                                <p className="text-sm text-text-secondary">Removes all files created by the AI Feature Builder.</p>
                             </div>
                             <button onClick={handleClearGeneratedFiles} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Snippet Vault</p>
                                <p className="text-sm text-text-secondary">Removes all saved code snippets.</p>
                             </div>
                             <button onClick={handleClearSnippets} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Notes & Whiteboard</p>
                                <p className="text-sm text-text-secondary">Removes all items from Dev Notes and Digital Whiteboard.</p>
                             </div>
                             <button onClick={handleClearNotes} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear AI Personalities</p>
                                <p className="text-sm text-text-secondary">Removes all custom AI personalities.</p>
                             </div>
                             <button onClick={handleClearPersonalities} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                    </div>
                </section>
            </div>
        </div>
    );
};
`,
  'components/StatusBar.tsx': `import React, { useState, useEffect } from 'react';
import { GitBranchIcon, BellIcon } from './icons.tsx';

type BgImageStatus = 'loading' | 'loaded' | 'error';

const StatusMessage: React.FC<{ status: BgImageStatus }> = ({ status }) => {
    const [visible, setVisible] = useState(true);

    useEffect(() => {
        setVisible(true);
        if (status === 'error') {
            const timer = setTimeout(() => setVisible(false), 5000);
            return () => clearTimeout(timer);
        }
    }, [status]);

    if (!visible || status === 'loaded') {
        return null;
    }

    if (status === 'loading') {
        return (
            <div className="flex items-center space-x-2">
                <div className="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
                <span>Generating background...</span>
            </div>
        );
    }

    if (status === 'error') {
        return (
            <div className="flex items-center space-x-2 text-yellow-600">
                <span>Background failed. Using fallback.</span>
            </div>
        );
    }

    return null;
};

const Clock: React.FC = () => {
    const [time, setTime] = useState(() => new Date());

    useEffect(() => {
        const timerId = setInterval(() => {
            setTime(new Date());
        }, 1000);

        return () => clearInterval(timerId);
    }, []);

    return <span>{time.toLocaleTimeString()}</span>
}


export const StatusBar: React.FC<{ bgImageStatus: BgImageStatus }> = ({ bgImageStatus }) => {
  return (
    <footer className="w-full bg-surface/70 backdrop-blur-sm border-t border-border px-4 py-1 flex items-center justify-between text-xs text-text-secondary">
      <div className="flex items-center space-x-4">
        <div className="flex items-center space-x-1 cursor-pointer hover:text-primary transition-colors">
          <GitBranchIcon />
          <span>main</span>
        </div>
        <StatusMessage status={bgImageStatus} />
      </div>
      <div className="flex items-center space-x-4">
        <Clock />
        <span className="hidden sm:block">Ready</span>
        <div className="flex items-center space-x-1 cursor-pointer hover:text-primary transition-colors">
          <BellIcon />
          <span>0</span>
        </div>
        <span className="hidden sm:block">
          Powered by Gemini
        </span>
      </div>
    </footer>
  );
};`,
  'components/desktop/.placeholder': ``,
  'components/desktop/DesktopView.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { FeatureDock } from './FeatureDock.tsx';
import { Window } from './Window.tsx';
import { Taskbar } from './Taskbar.tsx';
import { ALL_FEATURES } from '../features/index.ts';
import type { Feature, ViewType } from '../../types.ts';
import { ActionManager } from '../ActionManager.tsx';

interface WindowState {
  id: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  zIndex: number;
  isMinimized: boolean;
}

const Z_INDEX_BASE = 10;

export const DesktopView: React.FC<{ openFeatureId?: string, onNavigate: (view: ViewType, props?: any) => void; }> = ({ openFeatureId, onNavigate }) => {
    const [windows, setWindows] = useState<Record<string, WindowState>>({});
    const [activeId, setActiveId] = useState<string | null>(null);
    const [nextZIndex, setNextZIndex] = useState(Z_INDEX_BASE);
    
    const openWindow = useCallback((featureId: string) => {
        if (!featureId) return;
        const newZIndex = nextZIndex + 1;
        setNextZIndex(newZIndex);
        setActiveId(featureId);

        setWindows(prev => {
            const existingWindow = prev[featureId];
            if (existingWindow) {
                return {
                    ...prev,
                    [featureId]: {
                        ...existingWindow,
                        isMinimized: false,
                        zIndex: newZIndex,
                    }
                };
            }

            const openWindowsCount = Object.values(prev).filter(w => !w.isMinimized).length;
            const newWindow: WindowState = {
                id: featureId,
                position: { x: 50 + openWindowsCount * 30, y: 50 + openWindowsCount * 30 },
                size: { width: 800, height: 600 },
                zIndex: newZIndex,
                isMinimized: false,
            };
            return { ...prev, [featureId]: newWindow };
        });
    }, [nextZIndex]);
    
    useEffect(() => {
        if(openFeatureId) {
            openWindow(openFeatureId);
            // Reset the view in global state so it doesn't re-trigger
            onNavigate('dashboard', {});
        }
    }, [openFeatureId, openWindow, onNavigate]);

    const closeWindow = (id: string) => {
        setWindows(prev => {
            const newState = { ...prev };
            delete newState[id];
            return newState;
        });
        if (activeId === id) {
            setActiveId(null);
        }
    };

    const minimizeWindow = (id: string) => {
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], isMinimized: true }
        }));
        setActiveId(null);
    };

    const focusWindow = (id: string) => {
        if (id === activeId) return;
        const newZIndex = nextZIndex + 1;
        setNextZIndex(newZIndex);
        setActiveId(id);
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], zIndex: newZIndex }
        }));
    };
    
    const updateWindowState = (id: string, updates: Partial<WindowState>) => {
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], ...updates }
        }));
    }

    const openWindows = Object.values(windows).filter(w => !w.isMinimized);
    const minimizedWindows = Object.values(windows).filter(w => w.isMinimized);
    const featuresMap = new Map(ALL_FEATURES.map(f => [f.id, f]));

    return (
        <div className="h-full flex flex-row bg-transparent w-full">
            <FeatureDock onOpen={openWindow} />
            <div className="flex-grow relative overflow-hidden">
                {openWindows.map(win => {
                    const feature = featuresMap.get(win.id);
                    if (!feature) return null;
                    return (
                        <Window
                            key={win.id}
                            feature={feature}
                            state={win}
                            isActive={win.id === activeId}
                            onClose={() => closeWindow(win.id)}
                            onMinimize={() => minimizeWindow(win.id)}
                            onFocus={() => focusWindow(win.id)}
                            onUpdate={updateWindowState}
                        />
                    );
                })}
                <ActionManager />
            </div>
            <Taskbar
                minimizedWindows={minimizedWindows.map(w => featuresMap.get(w.id)).filter(Boolean) as Feature[]}
                onRestore={openWindow}
            />
        </div>
    );
};`,
  'components/desktop/FeatureDock.tsx': `import React from 'react';
import { ALL_FEATURES } from '../features/index.ts';
import type { Feature } from '../../types.ts';

interface FeatureButtonProps {
    feature: Feature;
    onOpen: (id: string) => void;
}

const FeatureButton: React.FC<FeatureButtonProps> = ({ feature, onOpen }) => {
    return (
        <button
            onClick={() => onOpen(feature.id)}
            className="w-24 h-24 flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/80 transition-colors group"
            title={feature.name}
        >
            <div className="text-cyan-400 group-hover:scale-110 transition-transform">{feature.icon}</div>
            <span className="text-xs text-slate-300 mt-2 text-center w-full break-words">{feature.name}</span>
        </button>
    );
};

interface FeatureDockProps {
    onOpen: (id: string) => void;
}

export const FeatureDock: React.FC<FeatureDockProps> = ({ onOpen }) => {
    return (
        <div className="h-96 flex-shrink-0 bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 p-3 overflow-y-auto">
            <div className="flex flex-wrap gap-3 justify-center">
                {ALL_FEATURES.map(feature => (
                    <FeatureButton key={feature.id} feature={feature} onOpen={onOpen} />
                ))}
            </div>
        </div>
    );
};
`,
  'components/desktop/Taskbar.tsx': `import React from 'react';
import type { Feature } from '../../types.ts';

interface TaskbarProps {
  minimizedWindows: Feature[];
  onRestore: (id: string) => void;
}

export const Taskbar: React.FC<TaskbarProps> = ({ minimizedWindows, onRestore }) => {
  if (minimizedWindows.length === 0) {
    return null;
  }

  return (
    <div className="absolute bottom-0 left-20 right-0 h-10 bg-slate-900/80 backdrop-blur-sm border-t border-slate-700 flex items-center px-2 gap-2 z-[999]">
      {minimizedWindows.map(feature => (
        <button
          key={feature.id}
          onClick={() => onRestore(feature.id)}
          className="h-8 px-3 flex items-center gap-2 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm"
          title={\`Restore \${feature.name}\`}
        >
          <div className="w-4 h-4">{feature.icon}</div>
          <span>{feature.name}</span>
        </button>
      ))}
    </div>
  );
};
`,
  'components/desktop/Window.tsx': `import React, { Suspense, useRef, useState } from 'react';
import type { Feature } from '../../types.ts';
import { FEATURES_MAP } from '../features/index.ts';
import { LoadingIndicator } from '../../App.tsx';
import { MinimizeIcon, XMarkIcon } from '../icons.tsx';

interface WindowState {
  id: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  zIndex: number;
  isMinimized: boolean;
}

interface WindowProps {
  feature: Feature;
  state: WindowState;
  isActive: boolean;
  onClose: (id: string) => void;
  onMinimize: (id: string) => void;
  onFocus: (id: string) => void;
  onUpdate: (id: string, updates: Partial<WindowState>) => void;
}

export const Window: React.FC<WindowProps> = ({ feature, state, isActive, onClose, onMinimize, onFocus, onUpdate }) => {
  const dragStartPos = useRef<{ x: number; y: number } | null>(null);
  const initialPos = useRef<{ x: number; y: number } | null>(null);
  
  const FeatureComponent = FEATURES_MAP.get(feature.id)?.component;

  const handleDragStart = (e: React.MouseEvent<HTMLDivElement>) => {
    e.preventDefault();
    onFocus(feature.id);
    dragStartPos.current = { x: e.clientX, y: e.clientY };
    initialPos.current = { x: state.position.x, y: state.position.y };
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('mouseup', handleDragEnd);
  };

  const handleDragMove = (e: MouseEvent) => {
    if (!dragStartPos.current || !initialPos.current) return;
    const dx = e.clientX - dragStartPos.current.x;
    const dy = e.clientY - dragStartPos.current.y;
    onUpdate(feature.id, { position: { x: initialPos.current.x + dx, y: initialPos.current.y + dy }});
  };

  const handleDragEnd = () => {
    dragStartPos.current = null;
    initialPos.current = null;
    window.removeEventListener('mousemove', handleDragMove);
    window.removeEventListener('mouseup', handleDragEnd);
  };
  
  return (
    <div
      className={\`absolute bg-slate-800/70 backdrop-blur-md border rounded-lg shadow-2xl shadow-black/50 flex flex-col transition-all duration-100 \${isActive ? 'border-cyan-500/50' : 'border-slate-700/50'}\`}
      style={{
        left: state.position.x,
        top: state.position.y,
        width: state.size.width,
        height: state.size.height,
        zIndex: state.zIndex
      }}
      onMouseDown={() => onFocus(feature.id)}
    >
      <header
        className={\`flex items-center justify-between h-8 px-2 border-b \${isActive ? 'bg-slate-700/50 border-slate-600' : 'bg-slate-800/50 border-slate-700'} rounded-t-lg cursor-move\`}
        onMouseDown={handleDragStart}
      >
        <div className="flex items-center gap-2 text-xs">
           <div className="w-4 h-4">{feature.icon}</div>
           <span>{feature.name}</span>
        </div>
        <div className="flex items-center gap-1">
          <button onClick={() => onMinimize(feature.id)} className="p-1 rounded hover:bg-slate-600"><MinimizeIcon /></button>
          <button onClick={() => onClose(feature.id)} className="p-1 rounded hover:bg-red-500/50"><XMarkIcon className="w-4 h-4"/></button>
        </div>
      </header>
      <main className="flex-1 overflow-auto bg-slate-800/50 rounded-b-lg">
        {FeatureComponent ? (
          <Suspense fallback={<LoadingIndicator/>}>
            <FeatureComponent />
          </Suspense>
        ) : (
            <div className="p-4 text-red-400">Error: Component not found for {feature.name}</div>
        )}
      </main>
    </div>
  );
};`,
  'components/features/AccessibilityAuditor.tsx': `import React, { useState, useRef } from 'react';
import { suggestA11yFix } from '../../services/index.ts';
import { runAxeAudit, AxeResult } from '../../services/auditing/accessibilityService.ts';
import { EyeIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const AccessibilityAuditor: React.FC = () => {
    const [url, setUrl] = useState('https://react.dev');
    const [auditUrl, setAuditUrl] = useState('');
    const [results, setResults] = useState<AxeResult | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isLoadingAi, setIsLoadingAi] = useState<string | null>(null);
    const [aiFixes, setAiFixes] = useState<Record<string, string>>({});
    const iframeRef = useRef<HTMLIFrameElement>(null);

    const handleAudit = () => {
        const targetUrl = url.startsWith('http') ? url : \`https://\${url}\`;
        setAuditUrl(targetUrl);
        setIsLoading(true);
        setResults(null);
        setAiFixes({});
    };
    
    const handleIframeLoad = async () => {
        if (isLoading && iframeRef.current) {
            try {
                const auditResults = await runAxeAudit(iframeRef.current.contentWindow!.document);
                setResults(auditResults);
            } catch (error) {
                console.error(error);
                alert('Could not audit this page. This may be due to security restrictions (CORS).');
            } finally {
                setIsLoading(false);
            }
        }
    };
    
    const handleGetFix = async (issue: any) => {
        const issueId = issue.id;
        setIsLoadingAi(issueId);
        try {
            const fix = await suggestA11yFix(issue);
            setAiFixes(prev => ({...prev, [issueId]: fix}));
        } catch(e) {
            setAiFixes(prev => ({...prev, [issueId]: 'Could not get suggestion.'}));
        } finally {
            setIsLoadingAi(null);
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><EyeIcon /><span className="ml-3">Automated Accessibility Auditor</span></h1><p className="text-text-secondary mt-1">Audit a live URL for accessibility issues and get AI-powered fixes.</p></header>
            <div className="flex gap-2 mb-4"><input type="text" value={url} onChange={e => setUrl(e.target.value)} placeholder="https://example.com" className="flex-grow p-2 border rounded"/><button onClick={handleAudit} disabled={isLoading} className="btn-primary px-6 py-2">{isLoading ? 'Auditing...' : 'Audit'}</button></div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"><iframe ref={iframeRef} src={auditUrl} title="Audit Target" className="w-full h-full bg-white" onLoad={handleIframeLoad} sandbox="allow-scripts allow-same-origin"/></div>
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <h3 className="text-lg font-bold mb-2">Audit Results</h3>
                    <div className="flex-grow overflow-y-auto pr-2">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                        {results && (results.violations.length === 0 ? <p>No violations found!</p> :
                            results.violations.map((v, i) => (
                                <div key={v.id + i} className="p-3 mb-2 bg-background border border-border rounded">
                                    <p className="font-bold text-red-600">{v.help}</p>
                                    <p className="text-sm my-1">{v.description}</p>
                                    <button onClick={() => handleGetFix(v)} disabled={!!isLoadingAi} className="text-xs flex items-center gap-1 text-primary font-semibold"><SparklesIcon/> {isLoadingAi === v.id ? 'Getting fix...' : 'Ask AI for a fix'}</button>
                                    {aiFixes[v.id] && <div className="mt-2 text-xs border-t pt-2"><MarkdownRenderer content={aiFixes[v.id]}/></div>}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AiCodeExplainer.tsx': `import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import mermaid from 'mermaid';
import { explainCodeStructured, generateMermaidJs } from '../../services/index.ts';
import type { StructuredExplanation } from '../../types.ts';
import { useTheme } from '../../hooks/useTheme.ts';
import { CpuChipIcon } from '../icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from '../shared/index.tsx';

const exampleCode = \`const bubbleSort = (arr) => {
  for (let i = 0; i < arr.length; i++) {
    for (let j = 0; j < arr.length - i - 1; j++) {
      if (arr[j] > arr[j + 1]) {
        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
      }
    }
  }
  return arr;
};\`;

type ExplanationTab = 'summary' | 'lineByLine' | 'complexity' | 'suggestions' | 'flowchart';

const simpleSyntaxHighlight = (code: string) => {
    const escapedCode = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    return escapedCode
        .replace(/\\b(const|let|var|function|return|if|for|=>|import|from|export|default)\\b/g, '<span class="text-indigo-400 font-semibold">\$1</span>')
        .replace(/(\\\`|'|")(.*?)(\\\`|'|")/g, '<span class="text-emerald-400">\$1\$2\$3</span>')
        .replace(/(\\/\\/.*)/g, '<span class="text-gray-400 italic">\$1</span>')
        .replace(/(\\{|\\}|\\(|\\)|\\[|\\])/g, '<span class="text-gray-400">\$1</span>');
};

mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });

export const AiCodeExplainer: React.FC<{ initialCode?: string }> = ({ initialCode }) => {
    const [code, setCode] = useState<string>(initialCode || exampleCode);
    const [explanation, setExplanation] = useState<StructuredExplanation | null>(null);
    const [mermaidCode, setMermaidCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [activeTab, setActiveTab] = useState<ExplanationTab>('summary');
    const [themeState] = useTheme();
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const preRef = useRef<HTMLPreElement>(null);
    const mermaidContainerRef = useRef<HTMLDivElement>(null);

    const handleExplain = useCallback(async (codeToExplain: string) => {
        if (!codeToExplain.trim()) {
            setError('Please enter some code to explain.');
            return;
        }
        setIsLoading(true);
        setError('');
        setExplanation(null);
        setMermaidCode('');
        setActiveTab('summary');
        try {
            const [explanationResult, mermaidResult] = await Promise.all([
                explainCodeStructured(codeToExplain),
                generateMermaidJs(codeToExplain)
            ]);
            setExplanation(explanationResult);
            setMermaidCode(mermaidResult.replace(/\`\`\`mermaid\\n|\`\`\`/g, ''));

        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to get explanation: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);
    
    useEffect(() => {
        if (initialCode) {
            setCode(initialCode);
            handleExplain(initialCode);
        }
    }, [initialCode, handleExplain]);

    useEffect(() => {
        const renderMermaid = async () => {
             if (activeTab === 'flowchart' && mermaidCode && mermaidContainerRef.current) {
                try {
                    mermaid.initialize({ startOnLoad: false, theme: themeState.mode === 'dark' ? 'dark' : 'neutral', securityLevel: 'loose' });
                    mermaidContainerRef.current.innerHTML = ''; // Clear previous
                    const { svg } = await mermaid.render(\`mermaid-graph-\${Date.now()}\`, mermaidCode);
                    mermaidContainerRef.current.innerHTML = svg;
                } catch (e) {
                    console.error("Mermaid rendering error:", e);
                    mermaidContainerRef.current.innerHTML = \`<p class="text-red-500">Error rendering flowchart.</p>\`;
                }
            }
        }
        renderMermaid();
    }, [activeTab, mermaidCode, themeState.mode]);


    const handleScroll = () => {
        if (preRef.current && textareaRef.current) {
            preRef.current.scrollTop = textareaRef.current.scrollTop;
            preRef.current.scrollLeft = textareaRef.current.scrollLeft;
        }
    };

    const highlightedCode = useMemo(() => simpleSyntaxHighlight(code), [code]);

    const renderTabContent = () => {
        if (!explanation) return null;
        switch(activeTab) {
            case 'summary':
                return <MarkdownRenderer content={explanation.summary} />;
            case 'lineByLine':
                return (
                    <div className="space-y-3">
                        {explanation.lineByLine.map((item, index) => (
                            <div key={index} className="p-3 bg-background rounded-md border border-border">
                                <p className="font-mono text-xs text-primary mb-1">Lines: {item.lines}</p>
                                <p className="text-sm">{item.explanation}</p>
                            </div>
                        ))}
                    </div>
                );
            case 'complexity':
                return (
                    <div>
                        <p><strong>Time Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.time}</span></p>
                        <p><strong>Space Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.space}</span></p>
                    </div>
                );
            case 'suggestions':
                return (
                     <ul className="list-disc list-inside space-y-2">
                        {explanation.suggestions.map((item, index) => <li key={index}>{item}</li>)}
                    </ul>
                );
            case 'flowchart':
                return (
                    <div ref={mermaidContainerRef} className="w-full h-full flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
        }
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex-shrink-0">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Explainer</span>
                </h1>
                <p className="text-text-secondary mt-1">Get a detailed, structured analysis of any code snippet.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                
                {/* Left Column: Code Input */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Your Code</label>
                    <div className="relative flex-grow bg-surface border border-border rounded-md focus-within:ring-2 focus-within:ring-primary overflow-hidden">
                        <textarea
                            ref={textareaRef}
                            id="code-input"
                            value={code}
                            onChange={(e) => setCode(e.target.value)}
                            onScroll={handleScroll}
                            placeholder="Paste your code here..."
                            spellCheck="false"
                            className="absolute inset-0 w-full h-full p-4 bg-transparent resize-none font-mono text-sm text-transparent caret-primary outline-none z-10"
                        />
                        <pre 
                            ref={preRef}
                            aria-hidden="true"
                            className="absolute inset-0 w-full h-full p-4 font-mono text-sm text-text-primary pointer-events-none z-0 whitespace-pre-wrap overflow-auto no-scrollbar"
                            dangerouslySetInnerHTML={{ __html: highlightedCode + '\\n' }}
                        />
                    </div>
                    <div className="mt-4 flex-shrink-0">
                        <button
                            onClick={() => handleExplain(code)}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner/> : 'Analyze Code'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Analysis */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Analysis</label>
                    <div className="relative flex-grow flex flex-col bg-surface border border-border rounded-md overflow-hidden">
                        <div className="flex-shrink-0 flex border-b border-border">
                           {(['summary', 'lineByLine', 'complexity', 'suggestions', 'flowchart'] as ExplanationTab[]).map(tab => (
                               <button key={tab} onClick={() => setActiveTab(tab)} disabled={!explanation}
                                className={\`px-4 py-2 text-sm font-medium capitalize transition-colors \${activeTab === tab ? 'bg-background text-primary font-semibold' : 'text-text-secondary hover:bg-gray-100 dark:hover:bg-slate-700 disabled:text-gray-400 dark:disabled:text-slate-500'}\`}>
                                   {tab.replace(/([A-Z])/g, ' \$1')}
                               </button>
                           ))}
                        </div>
                        <div className="p-4 flex-grow overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {explanation && !isLoading && renderTabContent()}
                            {!isLoading && !explanation && !error && <div className="text-text-secondary h-full flex items-center justify-center">The analysis will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AiCodeMigrator.tsx': `

import React, { useState, useCallback, useEffect } from 'react';
import { migrateCodeStream } from '../../services/index.ts';
import { ArrowPathIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const languages = ['SASS', 'CSS', 'JavaScript', 'TypeScript', 'Python', 'Go', 'React', 'Vue', 'Angular', 'Tailwind CSS'];

const exampleCode = \`// SASS
\$primary-color: #333;

body {
  color: \$primary-color;
  font-family: sans-serif;
}\`;

export const AiCodeMigrator: React.FC<{ inputCode?: string, fromLang?: string, toLang?: string }> = ({ inputCode: initialCode, fromLang: initialFrom, toLang: initialTo }) => {
    const [inputCode, setInputCode] = useState<string>(initialCode || exampleCode);
    const [outputCode, setOutputCode] = useState<string>('');
    const [fromLang, setFromLang] = useState(initialFrom || 'SASS');
    const [toLang, setToLang] = useState(initialTo || 'CSS');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleMigrate = useCallback(async (code: string, from: string, to: string) => {
        if (!code.trim()) {
            setError('Please enter some code to migrate.');
            return;
        }
        setIsLoading(true);
        setError('');
        setOutputCode('');
        try {
            const stream = migrateCodeStream(code, from, to);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setOutputCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to migrate code: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialCode && initialFrom && initialTo) {
            setInputCode(initialCode);
            setFromLang(initialFrom);
            setToLang(initialTo);
            handleMigrate(initialCode, initialFrom, initialTo);
        }
    }, [initialCode, initialFrom, initialTo, handleMigrate]);

    const LanguageSelector: React.FC<{ value: string, onChange: (val: string) => void }> = ({ value, onChange }) => (
        <select value={value} onChange={e => onChange(e.target.value)} className="w-full px-3 py-2 rounded-md bg-surface border border-border">
            {languages.map(lang => <option key={lang} value={lang}>{lang}</option>)}
        </select>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><ArrowPathIcon /><span className="ml-3">AI Code Migrator</span></h1>
                <p className="text-text-secondary mt-1">Translate code between languages, frameworks, and syntax styles.</p>
            </header>
            <div className="flex-grow flex flex-col min-h-0">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
                    <div className="flex flex-col h-full">
                        <div className="mb-2">
                            <label className="text-sm font-medium text-text-secondary">From:</label>
                            <LanguageSelector value={fromLang} onChange={setFromLang} />
                        </div>
                        <textarea
                            value={inputCode}
                            onChange={(e) => setInputCode(e.target.value)}
                            placeholder="Paste your source code here..."
                            className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                        />
                    </div>
                    <div className="flex flex-col h-full">
                        <div className="mb-2">
                            <label className="text-sm font-medium text-text-secondary">To:</label>
                            <LanguageSelector value={toLang} onChange={setToLang} />
                        </div>
                        <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                           {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="p-4 text-red-500">{error}</p>}
                            {outputCode && !isLoading && <MarkdownRenderer content={outputCode} />}
                            {!isLoading && !outputCode && !error && <div className="text-text-secondary h-full flex items-center justify-center">Migrated code will appear here.</div>}
                        </div>
                    </div>
                </div>
                 <button
                    onClick={() => handleMigrate(inputCode, fromLang, toLang)}
                    disabled={isLoading}
                    className="btn-primary mt-4 w-full max-w-sm mx-auto flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Migrate Code'}
                </button>
            </div>
        </div>
    );
};`,
  'components/features/AiCodingChallenge.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { generateCodingChallengeStream } from '../../services/index.ts';
import { BeakerIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

export const AiCodingChallenge: React.FC = () => {
    const [challenge, setChallenge] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        setChallenge('');
        try {
            const stream = generateCodingChallengeStream(null);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChallenge(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate challenge: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        // Generate a challenge on initial load for a better user experience
        handleGenerate();
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold flex items-center">
                        <BeakerIcon />
                        <span className="ml-3">AI Coding Challenge Generator</span>
                    </h1>
                    <p className="text-text-secondary mt-1">Generate a unique coding problem to test your skills.</p>
                </div>
                <button
                    onClick={handleGenerate}
                    disabled={isLoading}
                    className="btn-primary flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Generate New Challenge'}
                </button>
            </header>
            <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                {isLoading && (
                     <div className="flex items-center justify-center h-full">
                        <LoadingSpinner />
                     </div>
                )}
                {error && <p className="text-red-500">{error}</p>}
                {challenge && !isLoading && (
                    <MarkdownRenderer content={challenge} />
                )}
                 {!isLoading && !challenge && !error && (
                    <div className="text-text-secondary h-full flex items-center justify-center">
                        Click "Generate New Challenge" to start.
                    </div>
                )}
            </div>
        </div>
    );
};`,
  'components/features/AiCommandCenter.tsx': `import React, { useState, useCallback } from 'react';
import { Type, FunctionDeclaration } from "@google/genai";
import { logError } from '../../services/telemetryService.ts';
import { getInferenceFunction, CommandResponse } from '../../services/aiService.ts';
import { FEATURE_TAXONOMY } from '../../services/taxonomyService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { CommandLineIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { ALL_FEATURE_IDS } from '../../constants.tsx';
import { executeWorkspaceAction, ACTION_REGISTRY } from '../../services/workspaceConnectorService.ts';

const baseFunctionDeclarations: FunctionDeclaration[] = [
    {
        name: 'navigateTo',
        description: 'Navigates to a specific feature page.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                featureId: { 
                    type: Type.STRING, 
                    description: 'The ID of the feature to navigate to.',
                    enum: ALL_FEATURE_IDS
                },
            },
            required: ['featureId'],
        },
    },
    {
        name: 'runFeatureWithInput',
        description: 'Navigates to a feature and passes initial data to it.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                 featureId: { 
                    type: Type.STRING, 
                    description: 'The ID of the feature to run.',
                    enum: ALL_FEATURE_IDS
                },
                props: {
                    type: Type.OBJECT,
                    description: 'An object containing the initial properties for the feature, based on its required inputs.',
                    properties: {
                        initialCode: { type: Type.STRING },
                        initialPrompt: { type: Type.STRING },
                        beforeCode: { type: Type.STRING },
                        afterCode: { type: Type.STRING },
                        logInput: { type: Type.STRING },
                        diff: { type: Type.STRING },
                        codeInput: { type: Type.STRING },
                        jsonInput: { type: Type.STRING },
                    }
                }
            },
            required: ['featureId', 'props']
        }
    }
];

// Dynamically add the workspace action
const functionDeclarations: FunctionDeclaration[] = [
    ...baseFunctionDeclarations,
    {
        name: 'runWorkspaceAction',
        description: 'Executes a defined action on a connected workspace service like Jira, Slack, or GitHub.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                 actionId: {
                    type: Type.STRING,
                    description: 'The unique identifier for the action to execute.',
                    enum: [ ...ACTION_REGISTRY.keys() ]
                },
                params: {
                    type: Type.OBJECT,
                    description: 'An object containing the parameters for the action, matching its required inputs.'
                }
            },
            required: ['actionId', 'params']
        }
    }
]

const knowledgeBase = FEATURE_TAXONOMY.map(f => \`- \${f.name} (\${f.id}): \${f.description} Inputs: \${f.inputs}\`).join('\\n');

const ExamplePromptButton: React.FC<{ text: string, onClick: (text: string) => void }> = ({ text, onClick }) => (
    <button
        onClick={() => onClick(text)}
        className="px-3 py-1.5 bg-surface border border-border rounded-full text-xs hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
    >
        {text}
    </button>
)

export const AiCommandCenter: React.FC = () => {
    const { dispatch } = useGlobalState();
    const [prompt, setPrompt] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [lastResponse, setLastResponse] = useState('');

    const handleCommand = useCallback(async () => {
        if (!prompt.trim()) return;

        setIsLoading(true);
        setLastResponse('');

        try {
            const response: CommandResponse = await getInferenceFunction(prompt, functionDeclarations, knowledgeBase);
            
            if (response.functionCalls && response.functionCalls.length > 0) {
                const call = response.functionCalls[0];
                const { name, args } = call;

                setLastResponse(\`Understood! Executing command: \${name}\`);

                switch (name) {
                    case 'navigateTo':
                        dispatch({ type: 'SET_VIEW', payload: { view: args.featureId }});
                        break;
                    case 'runFeatureWithInput':
                         dispatch({ type: 'SET_VIEW', payload: { view: args.featureId, props: args.props } });
                        break;
                    case 'runWorkspaceAction':
                        try {
                            const result = await executeWorkspaceAction(args.actionId, args.params);
                            setLastResponse(\`Action '\${args.actionId}' executed successfully.\\n\\nResult: \\\`\\\`\\\`json\\n\${JSON.stringify(result, null, 2)}\\n\\\`\\\`\\\`\`);
                        } catch (e) {
                            setLastResponse(\`Action failed: \${e instanceof Error ? e.message : 'Unknown error'}\`);
                        }
                        break;
                    default:
                        setLastResponse(\`Unknown command: \${name}\`);
                }
                 setPrompt('');
            } else {
                 setLastResponse(response.text);
            }

        } catch (err) {
            logError(err as Error, { prompt });
            setLastResponse(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [prompt, dispatch]);

    const handleKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleCommand();
        }
    };
    
    const handleExampleClick = (text: string) => {
        setPrompt(text);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center justify-center">
                    <CommandLineIcon />
                    <span className="ml-3">AI Command Center</span>
                </h1>
                <p className="mt-2 text-lg text-text-secondary">What would you like to do?</p>
            </header>
            
            <div className="flex-grow flex flex-col justify-end max-w-3xl w-full mx-auto">
                {lastResponse && (
                    <div className="mb-4 p-4 bg-surface rounded-lg text-text-primary border border-border">
                        <p><strong>AI:</strong> {lastResponse}</p>
                    </div>
                )}
                 <div className="relative">
                    <textarea
                        value={prompt}
                        onChange={e => setPrompt(e.target.value)}
                        onKeyDown={handleKeyDown}
                        disabled={isLoading}
                        placeholder='Try "explain this code: const a = 1;" or "open the theme designer"'
                        className="w-full p-4 pr-28 rounded-lg bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none resize-none shadow-sm"
                        rows={2}
                    />
                    <button
                        onClick={handleCommand}
                        disabled={isLoading}
                        className="btn-primary absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2"
                    >
                       {isLoading ? <LoadingSpinner/> : 'Send'}
                    </button>
                </div>
                 <div className="flex flex-wrap items-center justify-center gap-2 mt-4">
                    <ExamplePromptButton text="Open Theme Designer" onClick={handleExampleClick} />
                    <ExamplePromptButton text="Generate a commit for a bug fix" onClick={handleExampleClick} />
                    <ExamplePromptButton text="Create a regex for email validation" onClick={handleExampleClick} />
                </div>
                 <p className="text-xs text-text-secondary text-center mt-2">Press Enter to send, Shift+Enter for new line.</p>
            </div>
        </div>
    );
};`,
  'components/features/AiCommitGenerator.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { generateCommitMessageStream } from '../../services/index.ts';
import { downloadFile } from '../../services/fileUtils.ts';
import { GitBranchIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const exampleDiff = \`diff --git a/src/components/Button.tsx b/src/components/Button.tsx
index 1b2c3d4..5e6f7g8 100644
--- a/src/components/Button.tsx
+++ b/src/components/Button.tsx
@@ -1,7 +1,7 @@
 import React from 'react';

 interface ButtonProps {
-  text: string;
+  label: string;
   onClick: () => void;
 }
\`;

export const AiCommitGenerator: React.FC<{ diff?: string }> = ({ diff: initialDiff }) => {
    const [diff, setDiff] = useState<string>(initialDiff || exampleDiff);
    const [message, setMessage] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async (diffToAnalyze: string) => {
        if (!diffToAnalyze.trim()) {
            setError('Please paste a diff to generate a message.');
            return;
        }
        setIsLoading(true);
        setError('');
        setMessage('');
        try {
            const stream = generateCommitMessageStream(diffToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setMessage(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate message: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialDiff) {
            setDiff(initialDiff);
            handleGenerate(initialDiff);
        }
    }, [initialDiff, handleGenerate]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(message);
    };
    
    const handleDownload = () => {
        downloadFile(message, 'commit_message.txt', 'text/plain');
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Commit Message Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your diff and let Gemini craft the perfect commit message.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="diff-input" className="text-sm font-medium text-text-secondary mb-2">Git Diff</label>
                    <textarea
                        id="diff-input"
                        value={diff}
                        onChange={(e) => setDiff(e.target.value)}
                        placeholder="Paste your git diff here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm text-text-primary focus:ring-2 focus:ring-primary focus:outline-none"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button
                        onClick={() => handleGenerate(diff)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Commit Message'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Message</label>
                        {message && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={handleCopy} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="relative flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                        {isLoading && (
                             <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                             </div>
                        )}
                        {error && <p className="text-red-500">{error}</p>}
                        {message && !isLoading && (
                           <pre className="whitespace-pre-wrap font-sans text-text-primary">{message}</pre>
                        )}
                         {!isLoading && !message && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">
                                The commit message will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AiFeatureBuilder.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import type { GeneratedFile } from '../../types.ts';
import { generateFeature, generateFullStackFeature, generateUnitTestsStream, generateCommitMessageStream, generateDockerfile } from '../../services/aiService.ts';
import { saveFile, getAllFiles, clearAllFiles } from '../../services/dbService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { CpuChipIcon, DocumentTextIcon, BeakerIcon, GitBranchIcon, CloudIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

type SupplementalTab = 'TESTS' | 'COMMIT' | 'DEPLOYMENT' | 'CODE';
type OutputTab = GeneratedFile | SupplementalTab;

export const AiFeatureBuilder: React.FC = () => {
    const [prompt, setPrompt] = useState<string>('A simple "Hello World" React component with a button that shows an alert.');
    const [framework] = useState('React');
    const [styling] = useState('Tailwind CSS');
    const [includeBackend, setIncludeBackend] = useState(false);

    const [generatedFiles, setGeneratedFiles] = useState<GeneratedFile[]>([]);
    const [unitTests, setUnitTests] = useState<string>('');
    const [commitMessage, setCommitMessage] = useState<string>('');
    const [dockerfile, setDockerfile] = useState<string>('');

    const [activeTab, setActiveTab] = useState<OutputTab>('CODE');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    
    useEffect(() => {
        const loadFiles = async () => {
            const files = await getAllFiles();
            setGeneratedFiles(files);
            if (files.length > 0) setActiveTab(files[0]);
        };
        loadFiles();
    }, []);

    const handleGenerate = useCallback(async () => {
        if (!prompt.trim()) { setError('Please enter a feature description.'); return; }
        setIsLoading(true);
        setError('');
        await clearAllFiles();
        setGeneratedFiles([]); setUnitTests(''); setCommitMessage(''); setDockerfile(''); setActiveTab('CODE');

        try {
            const resultFiles = includeBackend
                ? await generateFullStackFeature(prompt, framework, styling)
                : await generateFeature(prompt, framework, styling);
            
            for (const file of resultFiles) { await saveFile(file); }
            setGeneratedFiles(resultFiles);

            if (resultFiles.length > 0) {
                const componentFile = resultFiles.find(f => f.filePath.endsWith('.tsx') || f.filePath.endsWith('.jsx'));
                setActiveTab(componentFile || resultFiles[0]);

                const testStream = generateUnitTestsStream(componentFile?.content || resultFiles[0].content);
                const diffContext = resultFiles.map(f => \`File: \${f.filePath}\\n\\n\${f.content}\`).join('\\n---\\n');
                const commitStream = generateCommitMessageStream(diffContext);
                
                let tests = ''; for await (const chunk of testStream) { tests += chunk; setUnitTests(tests); }
                let commit = ''; for await (const chunk of commitStream) { commit += chunk; setCommitMessage(commit); }
                
                if (!includeBackend) {
                    const dockerfileStream = generateDockerfile(framework);
                    let docker = ''; for await (const chunk of dockerfileStream) { docker += chunk; setDockerfile(docker); }
                }
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate feature.');
        } finally {
            setIsLoading(false);
        }
    }, [prompt, framework, styling, includeBackend]);
    
    const renderContent = () => {
        if (typeof activeTab === 'string') {
            switch (activeTab) {
                case 'TESTS': return <MarkdownRenderer content={unitTests} />;
                case 'COMMIT': return <pre className="w-full h-full p-4 whitespace-pre-wrap font-sans text-sm">{commitMessage}</pre>;
                case 'DEPLOYMENT': return <MarkdownRenderer content={dockerfile} />;
                default: return <div className="p-4">Select a file</div>;
            }
        }
        return <MarkdownRenderer content={'\`\`\`tsx\\n' + activeTab.content + '\\n\`\`\`'} />;
    }

    return (
        <div className="h-full flex flex-col text-text-primary bg-surface">
            <header className="p-4 border-b border-border flex-shrink-0">
                <h1 className="text-xl font-bold flex items-center"><CpuChipIcon /><span className="ml-3">AI Feature Builder</span></h1>
            </header>
            <div className="flex-grow flex min-h-0">
                <main className="flex-1 flex flex-col min-w-0">
                    <div className="flex-grow flex flex-col bg-background">
                         <div className="border-b border-border flex items-center bg-surface overflow-x-auto">
                            {generatedFiles.map(file => (
                                <button key={file.filePath} onClick={() => setActiveTab(file)} className={\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \${activeTab === file ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\`}><DocumentTextIcon /> {file.filePath}</button>
                            ))}
                            {unitTests && <button onClick={() => setActiveTab('TESTS')} className={\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \${activeTab === 'TESTS' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\`}><BeakerIcon /> Tests</button>}
                            {commitMessage && <button onClick={() => setActiveTab('COMMIT')} className={\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \${activeTab === 'COMMIT' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\`}><GitBranchIcon /> Commit</button>}
                            {dockerfile && !includeBackend && <button onClick={() => setActiveTab('DEPLOYMENT')} className={\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \${activeTab === 'DEPLOYMENT' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\`}><CloudIcon /> Dockerfile</button>}
                        </div>
                        <div className="flex-grow p-2 overflow-auto">
                            {isLoading && !generatedFiles.length ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : renderContent()}
                        </div>
                    </div>
                    
                    <div className="flex-shrink-0 p-4 border-t border-border bg-surface">
                         <div className="flex items-center gap-2 mb-2">
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={includeBackend} onChange={e => setIncludeBackend(e.target.checked)} /> Include Backend (Cloud Function + Firestore)</label>
                        </div>
                        <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="e.g., A user profile card with an avatar, name, and bio." className="w-full p-2 bg-background border border-border rounded-md resize-none text-sm h-20"/>
                         <div className="flex gap-2 mt-2">
                             <button onClick={handleGenerate} disabled={isLoading} className="btn-primary flex-grow flex items-center justify-center gap-2 px-4 py-2">
                                {isLoading ? <><LoadingSpinner /> Generating...</> : 'Generate Feature'}
                            </button>
                         </div>
                         {error && <p className="text-red-600 text-xs mt-2 text-center">{error}</p>}
                    </div>
                </main>
            </div>
        </div>
    );
};
`,
  'components/features/AiImageGenerator.tsx': `import React, { useState, useCallback, useRef } from 'react';
import { generateImage, generateImageFromImageAndText } from '../../services/aiService.ts';
import { fileToBase64, blobToDataURL } from '../../services/fileUtils.ts';
import { ImageGeneratorIcon, SparklesIcon, ArrowDownTrayIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const surprisePrompts = [
    'A majestic lion wearing a crown, painted in the style of Van Gogh.',
    'A futuristic cityscape on another planet with two moons in the sky.',
    'A cozy, magical library inside a giant tree.',
    'A surreal image of a ship sailing on a sea of clouds.',
    'An astronaut riding a space-themed bicycle on the moon.',
];

interface UploadedImage {
    base64: string;
    dataUrl: string;
    mimeType: string;
}

export const AiImageGenerator: React.FC = () => {
    const [prompt, setPrompt] = useState<string>('A photorealistic image of a futuristic city at sunset, with flying cars.');
    const [uploadedImage, setUploadedImage] = useState<UploadedImage | null>(null);
    const [generatedImageUrl, setGeneratedImageUrl] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleGenerate = useCallback(async () => {
        if (!prompt.trim()) {
            setError('Please enter a prompt to generate an image.');
            return;
        }
        setIsLoading(true);
        setError('');
        setGeneratedImageUrl(null);
        try {
            let resultUrl: string;
            if (uploadedImage) {
                resultUrl = await generateImageFromImageAndText(prompt, uploadedImage.base64, uploadedImage.mimeType);
            } else {
                resultUrl = await generateImage(prompt);
            }
            setGeneratedImageUrl(resultUrl);
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate image: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [prompt, uploadedImage]);

    const handleSurpriseMe = () => {
        const randomPrompt = surprisePrompts[Math.floor(Math.random() * surprisePrompts.length)];
        setPrompt(randomPrompt);
    };

    const processImageBlob = async (blob: Blob) => {
        try {
            const [dataUrl, base64] = await Promise.all([
                blobToDataURL(blob),
                fileToBase64(blob as File)
            ]);
            setUploadedImage({ dataUrl, base64, mimeType: blob.type });
        } catch (e) {
            setError('Could not process the image.');
        }
    };

    const handlePaste = useCallback(async (event: React.ClipboardEvent) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) {
                    await processImageBlob(blob);
                    return;
                }
            }
        }
    }, []);

    const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (file) {
            await processImageBlob(file);
        }
    };
    
    const handleDownload = () => {
        if (!generatedImageUrl) return;
        const link = document.createElement('a');
        link.href = generatedImageUrl;
        link.download = \`\${prompt.slice(0, 30).replace(/\\s/g, '_')}.png\`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <ImageGeneratorIcon />
                    <span className="ml-3">AI Image Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate images from text, or provide an image for inspiration.</p>
            </header>
            
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                {/* Left Column: Inputs */}
                <div className="flex flex-col gap-4">
                    <div>
                        <label htmlFor="prompt-input" className="text-sm font-medium text-text-secondary">Your Prompt</label>
                        <textarea
                            id="prompt-input"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="e.g., A cute cat wearing a wizard hat"
                            className="w-full p-3 mt-1 rounded-md bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none resize-y"
                            rows={3}
                        />
                    </div>
                    
                    <div className="flex flex-col flex-grow min-h-[200px]">
                         <label className="text-sm font-medium text-text-secondary mb-1">Inspiration Image (Optional)</label>
                         <div onPaste={handlePaste} className="relative flex-grow flex flex-col items-center justify-center bg-surface p-4 rounded-lg border-2 border-dashed border-border focus:outline-none focus:border-primary" tabIndex={0}>
                            {uploadedImage ? (
                                <>
                                    <img src={uploadedImage.dataUrl} alt="Uploaded content" className="max-w-full max-h-full object-contain rounded-md shadow-lg" />
                                    <button onClick={() => setUploadedImage(null)} className="absolute top-2 right-2 p-1 bg-black/30 text-white rounded-full hover:bg-black/50"><XMarkIcon /></button>
                                </>
                            ) : (
                                <div className="text-center text-text-secondary">
                                    <h2 className="text-lg font-bold text-text-primary">Paste an image here</h2>
                                    <p className="text-sm">(Cmd/Ctrl + V)</p>
                                    <p className="text-xs my-1">or</p>
                                    <button onClick={() => fileInputRef.current?.click()} className="text-sm font-semibold text-primary hover:underline">Upload File</button>
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden"/>
                                </div>
                            )}
                         </div>
                    </div>
                    
                    <div className="flex gap-2">
                        <button
                            onClick={handleGenerate}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner /> : 'Generate Image'}
                        </button>
                        <button
                            onClick={handleSurpriseMe}
                            disabled={isLoading}
                            className="px-4 py-3 bg-surface border border-border rounded-md hover:bg-gray-100 transition-colors"
                            title="Surprise Me!"
                        >
                            <SparklesIcon />
                        </button>
                    </div>
                </div>

                {/* Right Column: Output */}
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Image</label>
                    <div className="flex-grow flex items-center justify-center bg-background border-2 border-dashed border-border rounded-lg p-4 relative overflow-auto">
                        {isLoading && <LoadingSpinner />}
                        {error && <p className="text-red-500 text-center">{error}</p>}
                        {generatedImageUrl && !isLoading && (
                            <>
                                <img src={generatedImageUrl} alt={prompt || "Generated by AI"} className="max-w-full max-h-full object-contain rounded-md shadow-lg" />
                                <button 
                                  onClick={handleDownload}
                                  className="absolute top-4 right-4 p-2 bg-black/30 text-white rounded-full hover:bg-black/50 backdrop-blur-sm"
                                  title="Download Image"
                                >
                                    <ArrowDownTrayIcon />
                                </button>
                            </>
                        )}
                        {!isLoading && !generatedImageUrl && !error && (
                            <div className="text-center text-text-secondary">
                                <p>Your generated image will appear here.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AiPersonalityForge.tsx': `import React, { useState, useEffect, useRef } from 'react';
import { SparklesIcon, PlusIcon, TrashIcon, ArrowDownTrayIcon, ArrowUpOnSquareIcon } from '../icons.tsx';
import { useAiPersonalities } from '../../hooks/useAiPersonalities.ts';
import { formatSystemPromptToString } from '../../utils/promptUtils.ts';
import { streamContent } from '../../services/index.ts';
import { downloadJson } from '../../services/fileUtils.ts';
import type { SystemPrompt } from '../../types.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';

const defaultNewPrompt: Omit<SystemPrompt, 'id' | 'name'> = {
    persona: 'You are a helpful assistant.',
    rules: [],
    outputFormat: 'markdown',
    exampleIO: [],
};

export const AiPersonalityForge: React.FC = () => {
    const [personalities, setPersonalities] = useAiPersonalities();
    const [activeId, setActiveId] = useState<string | null>(null);
    const { addNotification } = useNotification();
    const fileInputRef = useRef<HTMLInputElement>(null);

    // Testbed State
    const [testbedInput, setTestbedInput] = useState('');
    const [chatHistory, setChatHistory] = useState<{ role: 'user' | 'model'; content: string }[]>([]);
    const [isStreaming, setIsStreaming] = useState(false);

    const activePersonality = personalities.find(p => p.id === activeId);

    useEffect(() => {
        if (!activeId && personalities.length > 0) {
            setActiveId(personalities[0].id);
        }
    }, [personalities, activeId]);
    
    const handleUpdate = (field: keyof SystemPrompt, value: any) => {
        if (!activePersonality) return;
        const updated = { ...activePersonality, [field]: value };
        setPersonalities(personalities.map(p => (p.id === activeId ? updated : p)));
    };

    const handleAddNew = () => {
        const newId = Date.now().toString();
        const newPersonality: SystemPrompt = { ...defaultNewPrompt, id: newId, name: 'Untitled Personality' };
        setPersonalities([...personalities, newPersonality]);
        setActiveId(newId);
    };

    const handleDelete = (id: string) => {
        if (window.confirm('Are you sure you want to delete this personality?')) {
            setPersonalities(personalities.filter(p => p.id !== id));
            if (activeId === id) {
                setActiveId(personalities.length > 1 ? personalities[0].id : null);
            }
        }
    };
    
    const handleTestbedSend = async () => {
        if (!testbedInput.trim() || !activePersonality || isStreaming) return;
        
        const systemInstruction = formatSystemPromptToString(activePersonality);
        const newHistory = [...chatHistory, { role: 'user' as const, content: testbedInput }];
        setChatHistory(newHistory);
        setTestbedInput('');
        setIsStreaming(true);

        try {
            const stream = streamContent(testbedInput, systemInstruction, 0.7);
            let fullResponse = '';
            setChatHistory(prev => [...prev, { role: 'model', content: '' }]);
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChatHistory(prev => {
                    const last = prev[prev.length - 1];
                    if (last.role === 'model') {
                        return [...prev.slice(0, -1), { role: 'model', content: fullResponse }];
                    }
                    return prev;
                });
            }
        } catch (e) {
            const errorMsg = e instanceof Error ? e.message : 'An error occurred';
            setChatHistory(prev => [...prev, { role: 'model', content: \`**Error:** \${errorMsg}\` }]);
        } finally {
            setIsStreaming(false);
        }
    };
    
    const handleExport = () => {
        if (!activePersonality) return;
        downloadJson(activePersonality, \`\${activePersonality.name.replace(/\\s+/g, '_')}.json\`);
        addNotification('Personality exported!', 'success');
    };

    const handleImport = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const imported = JSON.parse(event.target?.result as string) as SystemPrompt;
                // Basic validation
                if (imported.id && imported.name && imported.persona) {
                    setPersonalities(prev => [...prev.filter(p => p.id !== imported.id), imported]);
                    setActiveId(imported.id);
                    addNotification('Personality imported!', 'success');
                } else {
                     addNotification('Invalid personality file.', 'error');
                }
            } catch {
                 addNotification('Failed to parse JSON file.', 'error');
            }
        };
        reader.readAsText(file);
    };

    return (
        <div className="h-full flex text-text-primary">
            {/* Sidebar */}
            <aside className="w-64 bg-surface border-r border-border flex flex-col">
                <div className="p-4 border-b border-border">
                    <h2 className="text-lg font-bold">Personalities</h2>
                </div>
                <div className="flex-grow overflow-y-auto">
                    {personalities.map(p => (
                        <div key={p.id} onClick={() => setActiveId(p.id)} className={\`group flex justify-between items-center p-3 text-sm cursor-pointer \${activeId === p.id ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\`}>
                            <span className="truncate">{p.name}</span>
                            <button onClick={(e) => { e.stopPropagation(); handleDelete(p.id)}} className="opacity-0 group-hover:opacity-100 text-text-secondary hover:text-red-500"><TrashIcon /></button>
                        </div>
                    ))}
                </div>
                <div className="p-4 border-t border-border space-y-2">
                    <button onClick={handleAddNew} className="btn-primary w-full py-2 text-sm flex items-center justify-center gap-2"><PlusIcon /> New</button>
                    <div className="flex gap-2">
                         <button onClick={() => fileInputRef.current?.click()} className="flex-1 py-2 text-sm bg-gray-100 dark:bg-slate-700 rounded-md flex items-center justify-center gap-2"><ArrowUpOnSquareIcon/> Import</button>
                         <button onClick={handleExport} className="flex-1 py-2 text-sm bg-gray-100 dark:bg-slate-700 rounded-md flex items-center justify-center gap-2"><ArrowDownTrayIcon/> Export</button>
                         <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden"/>
                    </div>
                </div>
            </aside>
            {/* Main Content */}
            {activePersonality ? (
                 <div className="flex-1 grid grid-cols-2 gap-px bg-border">
                    {/* Editor */}
                    <div className="bg-background p-4 flex flex-col gap-4 overflow-y-auto">
                        <div><label className="font-bold">Name</label><input type="text" value={activePersonality.name} onChange={e => handleUpdate('name', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/></div>
                        <div><label className="font-bold">Persona</label><textarea value={activePersonality.persona} onChange={e => handleUpdate('persona', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded h-24"/></div>
                        <div><label className="font-bold">Rules (one per line)</label><textarea value={activePersonality.rules.join('\\n')} onChange={e => handleUpdate('rules', e.target.value.split('\\n'))} className="w-full mt-1 p-2 bg-surface border rounded h-32"/></div>
                        <div><label className="font-bold">Output Format</label><select value={activePersonality.outputFormat} onChange={e => handleUpdate('outputFormat', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"><option>markdown</option><option>json</option><option>text</option></select></div>
                        <div>
                            <h3 className="font-bold mb-2">Examples</h3>
                            {activePersonality.exampleIO.map((ex, i) => (
                                <div key={i} className="grid grid-cols-2 gap-2 mb-2 p-2 border rounded bg-surface">
                                    <textarea placeholder="User Input" value={ex.input} onChange={e => handleUpdate('exampleIO', activePersonality.exampleIO.map((item, idx) => idx === i ? {...item, input: e.target.value} : item))} className="h-20 p-1 bg-background border rounded"/>
                                    <textarea placeholder="Model Output" value={ex.output} onChange={e => handleUpdate('exampleIO', activePersonality.exampleIO.map((item, idx) => idx === i ? {...item, output: e.target.value} : item))} className="h-20 p-1 bg-background border rounded"/>
                                </div>
                            ))}
                            <button onClick={() => handleUpdate('exampleIO', [...activePersonality.exampleIO, {input: '', output: ''}])} className="text-sm text-primary">+ Add Example</button>
                        </div>
                    </div>
                    {/* Testbed */}
                    <div className="bg-background p-4 flex flex-col">
                        <h2 className="text-lg font-bold mb-2 border-b pb-2">Live Testbed</h2>
                        <div className="flex-grow overflow-y-auto space-y-4 pr-2">
                           {chatHistory.map((msg, i) => (
                               <div key={i} className={\`p-3 rounded-lg \${msg.role === 'user' ? 'bg-primary/10' : 'bg-surface'}\`}>
                                    <strong className="capitalize">{msg.role}</strong>
                                    <MarkdownRenderer content={msg.content} />
                               </div>
                           ))}
                           {isStreaming && <div className="flex justify-center"><LoadingSpinner/></div>}
                        </div>
                        <div className="flex gap-2 mt-4">
                            <input value={testbedInput} onChange={e => setTestbedInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleTestbedSend()} className="flex-grow p-2 bg-surface border rounded" placeholder="Test your AI..."/>
                            <button onClick={handleTestbedSend} disabled={isStreaming} className="btn-primary px-4">Send</button>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="flex-1 flex items-center justify-center text-text-secondary">Select or create a personality to begin.</div>
            )}
        </div>
    );
};`,
  'components/features/AiPullRequestAssistant.tsx': `
import React, { useState, useMemo, useCallback } from 'react';
import * as Diff from 'diff';
import { generatePrSummaryStructured, generateTechnicalSpecFromDiff, downloadFile } from '../../services/index.ts';
import { createDocument, insertText } from '../../services/workspaceService.ts';
import type { StructuredPrSummary } from '../../types.ts';
import { AiPullRequestAssistantIcon, DocumentIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';

const exampleBefore = \`function Greeter(props) {
  return <h1>Hello, {props.name}!</h1>;
}\`;
const exampleAfter = \`function Greeter({ name, enthusiasmLevel = 1 }) {
  const punctuation = '!'.repeat(enthusiasmLevel);
  return <h1>Hello, {name}{punctuation}</h1>;
}\`;

export const AiPullRequestAssistant: React.FC = () => {
    const [beforeCode, setBeforeCode] = useState<string>(exampleBefore);
    const [afterCode, setAfterCode] = useState<string>(exampleAfter);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [isExporting, setIsExporting] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [summary, setSummary] = useState<StructuredPrSummary | null>(null);

    const { addNotification } = useNotification();
    const { state } = useGlobalState();
    const { user } = state;

    const diff = useMemo(() => Diff.createPatch('component.tsx', beforeCode, afterCode), [beforeCode, afterCode]);

    const handleGenerateSummary = useCallback(async () => {
        if (!beforeCode.trim() && !afterCode.trim()) {
            setError('Please provide code to generate a summary.');
            return;
        }
        setIsLoading(true);
        setError('');
        setSummary(null);
        
        try {
            const result: StructuredPrSummary = await generatePrSummaryStructured(diff);
            setSummary(result);
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate summary: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [diff, beforeCode, afterCode]);

    const handleExportToDocs = async () => {
        if (!summary || !user) {
            addNotification('Please generate a summary first and ensure you are signed in.', 'error');
            return;
        }
        setIsExporting(true);
        try {
            const specContent = await generateTechnicalSpecFromDiff(diff, summary);
            const doc = await createDocument(\`Tech Spec: \${summary.title}\`);
            await insertText(doc.documentId, specContent);
            addNotification('Successfully exported to Google Docs!', 'success');
            window.open(doc.webViewLink, '_blank');
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            addNotification(\`Failed to export: \${errorMessage}\`, 'error');
        } finally {
            setIsExporting(false);
        }
    };
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <AiPullRequestAssistantIcon />
                    <span className="ml-3">AI Pull Request Assistant</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate a PR summary from code changes and export a full tech spec.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                {/* Left side: Inputs and Generator */}
                <div className="flex flex-col gap-4 min-h-0">
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="before-code" className="text-sm font-medium text-text-secondary mb-2">Before</label>
                        <textarea id="before-code" value={beforeCode} onChange={e => setBeforeCode(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm" />
                    </div>
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="after-code" className="text-sm font-medium text-text-secondary mb-2">After</label>
                        <textarea id="after-code" value={afterCode} onChange={e => setAfterCode(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm" />
                    </div>
                    <button onClick={handleGenerateSummary} disabled={isLoading} className="btn-primary w-full flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Summary'}
                    </button>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                </div>

                {/* Right side: Summary and Export */}
                <div className="flex flex-col gap-4 min-h-0">
                    <div className="flex flex-col bg-surface border border-border p-4 rounded-lg flex-grow min-h-0">
                        <h3 className="text-lg font-bold mb-2">Generated Summary</h3>
                        <div className="flex-grow overflow-y-auto pr-2 space-y-2">
                            {summary ? (
                                <>
                                    <input type="text" readOnly value={summary.title} className="w-full font-bold p-2 bg-background rounded"/>
                                    <textarea readOnly value={summary.summary} className="w-full h-24 p-2 bg-background rounded resize-none"/>
                                    <div>
                                        <h4 className="font-semibold">Changes:</h4>
                                        <ul className="list-disc list-inside text-sm">
                                            {summary.changes.map((c, i) => <li key={i}>{c}</li>)}
                                        </ul>
                                    </div>
                                </>
                            ) : (
                                <div className="text-text-secondary h-full flex items-center justify-center">
                                    {isLoading ? <LoadingSpinner /> : 'PR summary will appear here.'}
                                </div>
                            )}
                        </div>
                         {summary && user && (
                            <div className="mt-4 pt-4 border-t border-border">
                                <button onClick={handleExportToDocs} disabled={isExporting} className="w-full btn-primary bg-blue-600 flex items-center justify-center gap-2 py-2">
                                    {isExporting ? <LoadingSpinner /> : <><DocumentIcon /> Export to Google Docs</>}
                                </button>
                            </div>
                         )}
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/AiStyleTransfer.tsx': `import React, { useState, useCallback } from 'react';
import { transferCodeStyleStream } from '../../services/index.ts';
import { SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \`function my_func(x,y){return x+y;}\`;
const exampleStyleGuide = \`- Use camelCase for function names.
- Add a space after commas in argument lists.
- Use semicolons at the end of statements.\`;

export const AiStyleTransfer: React.FC = () => {
    const [inputCode, setInputCode] = useState<string>(exampleCode);
    const [styleGuide, setStyleGuide] = useState<string>(exampleStyleGuide);
    const [outputCode, setOutputCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        if (!inputCode.trim() || !styleGuide.trim()) {
            setError('Please provide both code and a style guide.');
            return;
        }
        setIsLoading(true);
        setError('');
        setOutputCode('');
        try {
            const stream = transferCodeStyleStream({ code: inputCode, styleGuide });
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setOutputCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to transfer style: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [inputCode, styleGuide]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <SparklesIcon />
                    <span className="ml-3">AI Code Style Transfer</span>
                </h1>
                <p className="text-text-secondary mt-1">Rewrite code to match a specific style guide using AI.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="input-code" className="text-sm font-medium text-text-secondary mb-2">Original Code</label>
                    <textarea
                        id="input-code"
                        value={inputCode}
                        onChange={(e) => setInputCode(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm"
                    />
                </div>
                 <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="style-guide" className="text-sm font-medium text-text-secondary mb-2">Style Guide</label>
                    <textarea
                        id="style-guide"
                        value={styleGuide}
                        onChange={(e) => setStyleGuide(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Rewrite Code'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Rewritten Code</label>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !outputCode && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {outputCode && <MarkdownRenderer content={outputCode} />}
                         {!isLoading && !outputCode && !error && <div className="text-text-secondary h-full flex items-center justify-center">Rewritten code will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AiUnitTestGenerator.tsx': `import React, { useState, useCallback } from 'react';
import { generateUnitTestsStream, downloadFile } from '../../services/index.ts';
import { BeakerIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \`import React from 'react';

export const Greeting = ({ name }) => {
  if (!name) {
    return <div>Hello, Guest!</div>;
  }
  return <div>Hello, {name}!</div>;
};\`;

export const AiUnitTestGenerator: React.FC = () => {
    const [code, setCode] = useState<string>(exampleCode);
    const [tests, setTests] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        if (!code.trim()) {
            setError('Please enter some code to generate tests for.');
            return;
        }
        setIsLoading(true);
        setError('');
        setTests('');
        try {
            const stream = generateUnitTestsStream(code);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setTests(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate tests: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [code]);
    
    const cleanCodeForDownload = (markdown: string) => {
        return markdown.replace(/^\`\`\`(?:\\w+\\n)?/, '').replace(/\`\`\`\$/, '');
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BeakerIcon />
                    <span className="ml-3">AI Unit Test Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Provide a function or component and let AI write the tests.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Source Code</label>
                    <textarea
                        id="code-input"
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        placeholder="Paste your source code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Unit Tests'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Tests</label>
                        {tests && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={() => navigator.clipboard.writeText(cleanCodeForDownload(tests))} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy Code</button>
                                <button onClick={() => downloadFile(cleanCodeForDownload(tests), 'tests.tsx', 'text/typescript')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !tests && (
                            <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                            </div>
                        )}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {tests && <MarkdownRenderer content={tests} />}
                        {!isLoading && !tests && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">
                                The generated tests will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/ApiMockGenerator.tsx': `import React, { useState, useEffect, useCallback } from 'react';
import { generateMockData } from '../../services/aiService.ts';
import { startMockServer, stopMockServer, setMockRoutes, isMockServerRunning } from '../../services/mocking/mockServer.ts';
import { saveMockCollection, getAllMockCollections } from '../../services/mocking/db.ts';
import { ServerStackIcon, SparklesIcon, PlusIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

interface MockCollection {
    id: string;
    schemaDescription: string;
    data: any[];
}

interface MockRoute {
    id: number;
    path: string;
    method: 'GET' | 'POST';
    collectionId: string;
}

const exampleSchema = "a user with an id, name, email, and a nested address object containing a city and country";

export const ApiMockGenerator: React.FC = () => {
    const [schema, setSchema] = useState(exampleSchema);
    const [count, setCount] = useState(5);
    const [collectionName, setCollectionName] = useState('users');
    const [collections, setCollections] = useState<MockCollection[]>([]);
    const [generatedData, setGeneratedData] = useState<any[] | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isServerLoading, setIsServerLoading] = useState(false);
    const [error, setError] = useState('');
    const [isServerRunning, setIsServerRunning] = useState(isMockServerRunning());
    const [routes, setRoutes] = useState<MockRoute[]>([{ id: 1, path: '/api/users', method: 'GET', collectionId: 'users' }]);

    useEffect(() => {
        const loadCollections = async () => {
            const storedCollections = await getAllMockCollections();
            setCollections(storedCollections);
        };
        loadCollections();
    }, []);

    const handleGenerate = async () => {
        if (!schema.trim() || !collectionName.trim()) {
            setError('Schema description and collection name are required.');
            return;
        }
        setIsLoading(true);
        setError('');
        try {
            const data = await generateMockData(schema, count);
            setGeneratedData(data);
            const collectionId = collectionName.toLowerCase().replace(/\\s/g, '-');
            await saveMockCollection({ id: collectionId, schemaDescription: schema, data });
            setCollections(await getAllMockCollections());
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate data.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleServerToggle = async () => {
        setIsServerLoading(true);
        if (isServerRunning) {
            await stopMockServer();
            setIsServerRunning(false);
        } else {
            try {
                await startMockServer();
                setIsServerRunning(true);
                updateRoutesOnServer();
            } catch (err) {
                setError(err instanceof Error ? err.message : 'Could not start server.');
            }
        }
        setIsServerLoading(false);
    };

    const updateRoutesOnServer = useCallback(() => {
        const mockRoutes = routes.map(route => {
            const collection = collections.find(c => c.id === route.collectionId);
            return {
                path: route.path,
                method: route.method,
                response: {
                    status: 200,
                    body: collection ? collection.data : { message: \`No data found for collection '\${route.collectionId}'.\` }
                }
            };
        });
        setMockRoutes(mockRoutes as any);
    }, [routes, collections]);


    useEffect(() => {
        if (isServerRunning) {
            updateRoutesOnServer();
        }
    }, [routes, collections, isServerRunning, updateRoutesOnServer]);

    const handleRouteUpdate = (id: number, field: keyof MockRoute, value: string) => {
        setRoutes(routes.map(r => r.id === id ? { ...r, [field]: value } : r));
    };

    const handleAddRoute = () => {
        const newRoute: MockRoute = {
            id: Date.now(),
            path: '/api/new-route',
            method: 'GET',
            collectionId: collections.length > 0 ? collections[0].id : ''
        };
        setRoutes([...routes, newRoute]);
    };
    
    const getServerStatusText = () => {
        if (isServerLoading) return 'Starting...';
        return isServerRunning ? 'Server Running' : 'Server Stopped';
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-start">
                <div>
                    <h1 className="text-3xl font-bold flex items-center"><ServerStackIcon /><span className="ml-3">AI API Mock Server</span></h1>
                    <p className="text-text-secondary mt-1">Generate and serve mock API data locally using a service worker.</p>
                </div>
                <button onClick={handleServerToggle} disabled={isServerLoading} className={\`px-4 py-2 rounded-md font-semibold flex items-center gap-2 \${isServerRunning ? 'bg-green-100 text-green-700' : 'bg-gray-100'}\`}>
                    <span className={\`w-3 h-3 rounded-full \${isServerRunning ? 'bg-green-500' : 'bg-gray-400'} \${isServerLoading ? 'animate-pulse' : ''}\`}></span>
                    {getServerStatusText()}
                </button>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface p-4 border border-border rounded-lg">
                    <h3 className="text-lg font-bold">1. Generate Data</h3>
                    <div><label className="text-sm">Describe the data schema</label><textarea value={schema} onChange={e => setSchema(e.target.value)} className="w-full mt-1 p-2 bg-background border border-border rounded" rows={4}/></div>
                    <div className="flex gap-2">
                        <div className="flex-grow"><label className="text-sm">Collection Name</label><input type="text" value={collectionName} onChange={e => setCollectionName(e.target.value)} className="w-full mt-1 p-2 bg-background border border-border rounded"/></div>
                        <div><label className="text-sm">Count</label><input type="number" value={count} onChange={e => setCount(Number(e.target.value))} className="w-20 mt-1 p-2 bg-background border border-border rounded"/></div>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary py-2 flex items-center justify-center gap-2">{isLoading ? <LoadingSpinner/> : <><SparklesIcon/> Generate & Save</>}</button>
                    {error && <p className="text-red-500 text-xs">{error}</p>}
                </div>

                <div className="lg:col-span-2 flex flex-col gap-4 min-h-0">
                   <div className="bg-surface p-4 border border-border rounded-lg flex-grow flex flex-col min-h-0">
                        <h3 className="text-lg font-bold mb-2">2. View Data & Configure Routes</h3>
                        <div className="flex-grow grid grid-cols-2 gap-4 min-h-0">
                            <div className="overflow-y-auto">
                                <h4 className="font-semibold text-sm mb-1">Saved Collections</h4>
                                {collections.map(c => <div key={c.id} className="text-xs p-2 bg-background rounded border border-border mb-1">{c.id} ({c.data.length} items)</div>)}
                                <h4 className="font-semibold text-sm mb-1 mt-2">Last Generated Data</h4>
                                <pre className="text-xs p-2 bg-background rounded border border-border whitespace-pre-wrap">{generatedData ? JSON.stringify(generatedData, null, 2) : 'No data generated yet.'}</pre>
                            </div>
                            <div className="overflow-y-auto">
                                <h4 className="font-semibold text-sm mb-1">Mock Routes</h4>
                                {routes.map((r) => (
                                <div key={r.id} className="grid grid-cols-3 gap-1 items-center mb-1">
                                    <input type="text" value={r.path} onChange={e => handleRouteUpdate(r.id, 'path', e.target.value)} className="col-span-2 p-1 text-xs bg-background border rounded" />
                                    <select value={r.collectionId} onChange={e => handleRouteUpdate(r.id, 'collectionId', e.target.value)} className="p-1 text-xs bg-background border rounded">
                                        <option value="">Select Collection</option>
                                        {collections.map(c => <option key={c.id} value={c.id}>{c.id}</option>)}
                                    </select>
                                </div>
                                ))}
                                <button onClick={handleAddRoute} className="text-xs mt-2 p-1 bg-gray-100 rounded hover:bg-gray-200"><PlusIcon/></button>
                            </div>
                        </div>
                   </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AsyncCallTreeViewer.tsx': `

import React, { useState, useMemo } from 'react';
import { ChartBarIcon } from '../icons.tsx';

interface CallNode {
    name: string;
    duration: number;
    children?: CallNode[];
}

const exampleJson = \`{
    "name": "startApp",
    "duration": 500,
    "children": [
        {
            "name": "fetchUserData",
            "duration": 300,
            "children": [
                { "name": "authenticate", "duration": 100 },
                { "name": "fetchProfile", "duration": 150 }
            ]
        },
        {
            "name": "loadInitialAssets",
            "duration": 450,
            "children": [
                { "name": "loadImage.png", "duration": 200 },
                { "name": "loadScript.js", "duration": 250 }
            ]
        }
    ]
}\`;


const TreeNode: React.FC<{ node: CallNode, level: number, maxDuration: number }> = ({ node, level, maxDuration }) => {
    const [isOpen, setIsOpen] = React.useState(true);
    const hasChildren = node.children && node.children.length > 0;

    return (
        <div className="my-1">
            <div
                className="flex items-center p-2 rounded-md hover:bg-gray-100"
                style={{ paddingLeft: \`\${level * 20 + 8}px\` }}
            >
                {hasChildren && (
                    <button onClick={() => setIsOpen(!isOpen)} className={\`mr-2 text-text-secondary w-4 h-4 flex-shrink-0 transform transition-transform \${isOpen ? 'rotate-90' : ''}\`}>
                       ▶
                    </button>
                )}
                 {!hasChildren && <div className="w-6 mr-2 flex-shrink-0" />}
                 <div className="flex-grow flex items-center justify-between gap-4">
                    <span className="truncate">{node.name}</span>
                    <div className="flex items-center gap-2 flex-shrink-0">
                         <div className="w-24 h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div className="h-4 bg-primary" style={{ width: \`\${(node.duration / maxDuration) * 100}%\` }}/>
                         </div>
                        <span className="text-primary w-16 text-right">{node.duration.toFixed(0)}ms</span>
                    </div>
                </div>
            </div>
            {isOpen && hasChildren && (
                <div>
                    {node.children!.map((child, index) => (
                        <TreeNode key={index} node={child} level={level + 1} maxDuration={maxDuration} />
                    ))}
                </div>
            )}
        </div>
    );
};


export const AsyncCallTreeViewer: React.FC = () => {
    const [jsonInput, setJsonInput] = useState(exampleJson);
    const [error, setError] = useState('');

    const { treeData, maxDuration } = useMemo(() => {
        try {
            const data: CallNode = JSON.parse(jsonInput);
             let max = 0;
            const findMax = (node: CallNode) => {
                if (node.duration > max) max = node.duration;
                if (node.children) node.children.forEach(findMax);
            };
            findMax(data);
            setError('');
            return { treeData: data, maxDuration: max };
        } catch (e) {
            setError('Invalid JSON format.');
            return { treeData: null, maxDuration: 0 };
        }
    }, [jsonInput]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <ChartBarIcon />
                    <span className="ml-3">Async Call Tree Viewer</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste a JSON structure to visualize an asynchronous function call tree.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col h-2/5 min-h-[200px]">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={e => setJsonInput(e.target.value)}
                        className={\`flex-grow p-4 bg-surface border \${error ? 'border-red-500' : 'border-border'} rounded-md resize-y font-mono text-sm\`}
                        spellCheck="false"
                    />
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                </div>
                <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Visual Tree</label>
                    <div className="flex-grow bg-surface p-4 rounded-lg text-sm overflow-y-auto border border-border">
                        {treeData ? <TreeNode node={treeData} level={0} maxDuration={maxDuration} /> : <div className="text-text-secondary">{error || 'Enter valid JSON to see the tree.'}</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/AudioToCode.tsx': `import React, { useState, useRef, useCallback } from 'react';
import { transcribeAudioToCodeStream, blobToBase64 } from '../../services/index.ts';
import { MicrophoneIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

export const AudioToCode: React.FC = () => {
    const [isRecording, setIsRecording] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [code, setCode] = useState('');
    const [error, setError] = useState('');
    const mediaRecorderRef = useRef<MediaRecorder | null>(null);
    const audioChunksRef = useRef<Blob[]>([]);

    const handleStartRecording = async () => {
        setError('');
        setCode('');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setError('Audio recording is not supported by your browser.');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorderRef.current = new MediaRecorder(stream);
            mediaRecorderRef.current.ondataavailable = event => {
                audioChunksRef.current.push(event.data);
            };
            mediaRecorderRef.current.onstop = handleTranscribe;
            mediaRecorderRef.current.start();
            setIsRecording(true);
        } catch (err) {
            setError('Microphone access was denied. Please enable it in your browser settings.');
        }
    };

    const handleStopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
            mediaRecorderRef.current.stop();
            mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
            setIsRecording(false);
            setIsLoading(true);
        }
    };

    const handleTranscribe = useCallback(async () => {
        if (audioChunksRef.current.length === 0) {
            setIsLoading(false);
            return;
        }
        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
        audioChunksRef.current = [];
        try {
            const base64Audio = await blobToBase64(audioBlob);
            const stream = transcribeAudioToCodeStream(base64Audio, 'audio/webm');
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to transcribe audio: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-3xl font-bold flex items-center justify-center">
                    <MicrophoneIcon />
                    <span className="ml-3">AI Audio-to-Code</span>
                </h1>
                <p className="text-text-secondary mt-1">Speak your programming ideas and watch them turn into code.</p>
            </header>
            <div className="flex-grow flex flex-col items-center gap-6 min-h-0">
                <div className="flex flex-col items-center justify-center bg-surface p-6 rounded-lg w-full max-w-lg border border-border">
                     <button
                        onClick={isRecording ? handleStopRecording : handleStartRecording}
                        className={\`w-24 h-24 rounded-full flex items-center justify-center text-white font-bold text-lg transition-all \${isRecording ? 'bg-red-500 animate-pulse' : 'bg-primary'}\`}
                        disabled={isLoading}
                    >
                        {isLoading ? <LoadingSpinner/> : isRecording ? 'Stop' : 'Record'}
                    </button>
                    <p className="mt-4 text-text-secondary">
                        {isLoading ? 'Transcribing...' : isRecording ? 'Recording in progress...' : 'Click to start recording'}
                    </p>
                </div>
                 <div className="flex flex-col h-full w-full max-w-3xl">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Code</label>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto min-h-[200px]">
                        {isLoading && !code && (
                            <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>
                        )}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {code && <MarkdownRenderer content={code} />}
                        {!isLoading && !code && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">Code will appear here.</div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/BugReproducer.tsx': `import React, { useState, useCallback } from 'react';
import { generateBugReproductionTestStream } from '../../services/aiService.ts';
import { BugAntIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleStackTrace = \`TypeError: Cannot read properties of undefined (reading 'name')
    at UserProfile (UserProfile.jsx:5:21)
    at renderWithHooks (react-dom.development.js:14985:18)
    at mountIndeterminateComponent (react-dom.development.js:17811:13)
    at beginWork (react-dom.development.js:19049:16)\`;

export const BugReproducer: React.FC = () => {
    const [stackTrace, setStackTrace] = useState(exampleStackTrace);
    const [context, setContext] = useState('// The UserProfile component code:\\nconst UserProfile = ({ user }) => <div>{user.name}</div>;');
    const [generatedTest, setGeneratedTest] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!stackTrace.trim()) {
            setError('Please provide a stack trace.');
            return;
        }
        setIsLoading(true);
        setError('');
        setGeneratedTest('');
        try {
            const stream = generateBugReproductionTestStream(stackTrace, context);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setGeneratedTest(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [stackTrace, context]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BugAntIcon />
                    <span className="ml-3">Automated Bug Reproducer</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste a stack trace to automatically generate a failing unit test.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col gap-4">
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="stack-trace" className="text-sm font-medium mb-2">Stack Trace</label>
                        <textarea id="stack-trace" value={stackTrace} onChange={e => setStackTrace(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    </div>
                     <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="context" className="text-sm font-medium mb-2">Relevant Code / Context (Optional)</label>
                        <textarea id="context" value={context} onChange={e => setContext(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-3">{isLoading ? <LoadingSpinner/> : 'Generate Test'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Generated Test File</label>
                    <div className="flex-grow p-1 bg-background border rounded overflow-auto">
                        {isLoading && !generatedTest && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {generatedTest && <MarkdownRenderer content={generatedTest} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/ChangelogGenerator.tsx': `import React, { useState, useCallback } from 'react';
import { generateChangelogFromLogStream } from '../../services/aiService.ts';
import { GitBranchIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleLog = \`commit 3a4b5c...
Author: Dev One <dev.one@example.com>
Date:   Mon Jul 15 11:30:00 2024 -0400

    feat: add user login page

commit 1a2b3c...
Author: Dev Two <dev.two@example.com>
Date:   Mon Jul 15 10:00:00 2024 -0400

    fix: correct typo in header
\`;

export const ChangelogGenerator: React.FC = () => {
    const [log, setLog] = useState(exampleLog);
    const [changelog, setChangelog] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!log.trim()) {
            setError('Please paste your git log output.');
            return;
        }
        setIsLoading(true);
        setError('');
        setChangelog('');
        try {
            const stream = generateChangelogFromLogStream(log);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChangelog(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [log]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Changelog Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate a markdown changelog from your raw git log.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="commit-input" className="text-sm font-medium text-text-secondary mb-2">Raw Git Log</label>
                    <textarea
                        id="commit-input"
                        value={log}
                        onChange={(e) => setLog(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Changelog'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Changelog.md</label>
                    <div className="relative flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !changelog && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {changelog && <MarkdownRenderer content={changelog} />}
                        {!isLoading && changelog && <button onClick={() => navigator.clipboard.writeText(changelog)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy</button>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/CiCdPipelineGenerator.tsx': `import React, { useState } from 'react';
import { generateCiCdConfig } from '../../services/index.ts';
import { PaperAirplaneIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const platforms = ['GitHub Actions', 'GitLab CI', 'CircleCI', 'Jenkins'];
const exampleDescription = "Install Node.js dependencies, run linting and tests, build the production app, and then deploy to Vercel.";

export const CiCdPipelineGenerator: React.FC = () => {
    const [platform, setPlatform] = useState(platforms[0]);
    const [description, setDescription] = useState(exampleDescription);
    const [config, setConfig] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = async () => {
        if (!description.trim()) {
            setError('Please provide a description of the pipeline stages.');
            return;
        }
        setIsLoading(true);
        setError('');
        try {
            const result = await generateCiCdConfig(platform, description);
            setConfig(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate config.');
        } finally {
            setIsLoading(false);
        }
    };
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><PaperAirplaneIcon /><span className="ml-3">AI CI/CD Pipeline Architect</span></h1>
                <p className="text-text-secondary mt-1">Describe your deployment process and get a modern configuration file.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                 <div className="flex flex-col flex-1 min-h-0">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label className="block text-sm">Platform</label><select value={platform} onChange={e => setPlatform(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"><option>GitHub Actions</option><option>GitLab CI</option><option>CircleCI</option></select></div>
                        <div className="md:col-span-2"><label className="block text-sm">Describe Stages</label><input type="text" value={description} onChange={e => setDescription(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/></div>
                    </div>
                     <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center py-2"><SparklesIcon /> {isLoading ? 'Generating...' : 'Generate Configuration'}</button>
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Configuration File</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !config && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {config && <MarkdownRenderer content={config} />}
                         {!isLoading && !config && !error && <div className="text-text-secondary h-full flex items-center justify-center">Generated config will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/CodeDiffGhost.tsx': `import React, { useState, useEffect, useRef } from 'react';
import { EyeIcon } from '../icons.tsx';

const initialOldCode = \`function UserProfile({ user }) {
  return (
    <div className="profile">
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  );
}\`;

const initialNewCode = \`function UserProfile({ user }) {
  const { name, email, avatar } = user;
  return (
    <div className="profile-card">
      <img src={avatar} alt={name} />
      <h2>{name}</h2>
      <a href={\\\`mailto:\\\${email}\\\`}>{email}</a>
    </div>
  );
}\`;

export const CodeDiffGhost: React.FC = () => {
    const [oldCode, setOldCode] = useState(initialOldCode);
    const [newCode, setNewCode] = useState(initialNewCode);
    const [typedCode, setTypedCode] = useState('');
    const [isRunning, setIsRunning] = useState(false);
    const intervalRef = useRef<number | null>(null);

    const startAnimation = () => {
        if (intervalRef.current) clearInterval(intervalRef.current);
        setIsRunning(true);
        setTypedCode('');
        
        intervalRef.current = window.setInterval(() => {
            setTypedCode(prev => {
                if (prev.length < newCode.length) {
                    return newCode.substring(0, prev.length + 1);
                }
                if (intervalRef.current) clearInterval(intervalRef.current);
                setIsRunning(false);
                return newCode;
            });
        }, 15);
    };

    useEffect(() => {
        return () => {
            if (intervalRef.current) clearInterval(intervalRef.current);
        };
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <EyeIcon />
                    <span className="ml-3">Code Diff Ghost</span>
                </h1>
                <p className="text-text-secondary mt-1">Visualize code changes with a "ghost typing" effect.</p>
            </header>
            <div className="flex justify-center mb-4">
                <button
                    onClick={startAnimation}
                    disabled={isRunning}
                    className="btn-primary px-6 py-2"
                >
                    {isRunning ? 'Visualizing...' : 'Show Changes'}
                </button>
            </div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden font-mono text-sm">
                <div className="flex flex-col h-full">
                    <label htmlFor="before-code" className="text-sm font-medium text-text-secondary mb-2">Before</label>
                    <textarea
                        id="before-code"
                        value={oldCode}
                        onChange={e => setOldCode(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md text-red-600 whitespace-pre-wrap resize-none"
                        spellCheck="false"
                    />
                </div>
                 <div className="flex flex-col h-full">
                    <label htmlFor="after-code" className="text-sm font-medium text-text-secondary mb-2">After</label>
                     <div className="relative flex-grow">
                        <textarea
                            id="after-code"
                            value={newCode}
                            onChange={e => setNewCode(e.target.value)}
                            className="absolute inset-0 w-full h-full p-4 bg-surface border border-border rounded-md text-emerald-700 whitespace-pre-wrap resize-none z-0"
                            spellCheck="false"
                        />
                        {(isRunning || typedCode) && (
                            <pre className="absolute inset-0 w-full h-full p-4 bg-surface pointer-events-none text-emerald-700 whitespace-pre-wrap z-10">
                                {typedCode}{isRunning && <span className="animate-pulse">|</span>}
                            </pre>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/CodeFormatter.tsx': `import React, { useState, useCallback } from 'react';
import { formatCodeStream } from '../../services/index.ts';
import { CodeBracketSquareIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \`const MyComponent = (props) => {
  const {name, items}=props
    if(!items || items.length === 0){
  return <p>No items found for {name}</p>;
    }
  return <ul>{items.map(item=> <li key={item.id}>{item.name}</li>)}</ul>
}\`;

export const CodeFormatter: React.FC = () => {
    const [inputCode, setInputCode] = useState<string>(exampleCode);
    const [formattedCode, setFormattedCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleFormat = useCallback(async () => {
        if (!inputCode.trim()) {
            setError('Please enter some code to format.');
            return;
        }
        setIsLoading(true);
        setError('');
        setFormattedCode('');
        try {
            const stream = formatCodeStream(inputCode);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setFormattedCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to format code: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [inputCode]);
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CodeBracketSquareIcon />
                    <span className="ml-3">AI Code Formatter</span>
                </h1>
                <p className="text-text-secondary mt-1">Clean up your code with AI-powered formatting, like a smart Prettier.</p>
            </header>
            <div className="flex-grow flex flex-col min-h-0">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
                    <div className="flex flex-col h-full">
                        <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Input</label>
                        <textarea
                            id="code-input"
                            value={inputCode}
                            onChange={(e) => setInputCode(e.target.value)}
                            placeholder="Paste your unformatted code here..."
                            className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                        />
                    </div>
                    <div className="flex flex-col h-full">
                        <label className="text-sm font-medium text-text-secondary mb-2">Output</label>
                        <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                           {isLoading && !formattedCode && (
                                <div className="flex items-center justify-center h-full">
                                    <LoadingSpinner />
                                </div>
                            )}
                            {error && <p className="p-4 text-red-500">{error}</p>}
                            {formattedCode && <MarkdownRenderer content={formattedCode} />}
                            {!isLoading && !formattedCode && !error && (
                                <div className="text-text-secondary h-full flex items-center justify-center">
                                    Formatted code will appear here.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                 <button
                    onClick={handleFormat}
                    disabled={isLoading}
                    className="btn-primary mt-4 w-full max-w-sm mx-auto flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Format Code'}
                </button>
            </div>
        </div>
    );
};`,
  'components/features/CodeReviewBot.tsx': `import React, { useState, useCallback } from 'react';
import { reviewCodeStream } from '../../services/index.ts';
import { useAiPersonalities } from '../../hooks/useAiPersonalities.ts';
import { formatSystemPromptToString } from '../../utils/promptUtils.ts';
import { CpuChipIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \`function UserList(users) {
  if (users.length = 0) {
    return "no users";
  } else {
    return (
      users.map(u => {
        return <li>{u.name}</li>
      })
    )
  }
}\`;

export const CodeReviewBot: React.FC = () => {
    const [code, setCode] = useState<string>(exampleCode);
    const [review, setReview] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [personalities] = useAiPersonalities();
    const [selectedPersonalityId, setSelectedPersonalityId] = useState<string>('default');

    const handleGenerate = useCallback(async () => {
        if (!code.trim()) {
            setError('Please enter some code to review.');
            return;
        }
        setIsLoading(true);
        setError('');
        setReview('');

        let systemInstruction: string | undefined = undefined;
        if (selectedPersonalityId !== 'default') {
            const personality = personalities.find(p => p.id === selectedPersonalityId);
            if (personality) {
                systemInstruction = formatSystemPromptToString(personality);
            }
        }

        try {
            const stream = reviewCodeStream(code, systemInstruction);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setReview(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to get review: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [code, selectedPersonalityId, personalities]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Review Bot</span>
                </h1>
                <p className="text-text-secondary mt-1">Get an automated code review from Gemini.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Code to Review</label>
                    <textarea
                        id="code-input"
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        placeholder="Paste your code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0 flex items-center justify-center gap-4">
                     <div className="w-full max-w-xs">
                        <label htmlFor="personality-select" className="text-sm font-medium text-text-secondary">Reviewer Personality</label>
                        <select
                            id="personality-select"
                            value={selectedPersonalityId}
                            onChange={e => setSelectedPersonalityId(e.target.value)}
                            className="w-full mt-1 p-2 bg-surface border border-border rounded-md text-sm"
                        >
                            <option value="default">Default</option>
                            {personalities.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                     </div>
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary self-end h-[42px] w-full max-w-xs flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Request Review'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Feedback</label>
                    <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !review && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {review && <MarkdownRenderer content={review} />}
                         {!isLoading && !review && !error && <div className="text-text-secondary h-full flex items-center justify-center">Review will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/CodeSpellChecker.tsx': `import React, { useState, useMemo } from 'react';
import { BeakerIcon } from '../icons.tsx';

const commonTypos = [
    'funtion', 'functoin', 'funciton', 'contructor', 'cosntructor',
    'consle', 'conosle', 'cosnole', 'varable', 'varaible', 'vairable',
    'docment', 'docuemnt', 'docmunet', 'componnet', 'componenet', 'compnent',
    'retunr', 'retrun', 'asnyc', 'asycn', 'awai', 'awiat', 'promse',
    'resolv', 'rejct', 'catach', 'thne', 'lenght', 'lengt', 'prperty',
    'undefinded', 'nul', 'booleon', 'numbar', 'srtring', 'arrya', 'objcet',
    'elemnt', 'attriubte', 'eveent', 'listner', 'handeler', 'clieck',
    'submitt', 'resposne', 'requset', 'stauts', 'eror', 'sucess',
    'implemnt', 'overide', 'extned', 'pbulic', 'prvate', 'procted',
    'statci', 'abstact', 'interace', 'enmu', 'moduel', 'packge',
    'importt', 'exprot', 'defualt', 'namspace', 'tyep', 'clsas',
    'whiel', 'swich', 'cse', 'brek', 'contiune', 'thrwo', 'finnaly'
];

const typoRegex = new RegExp(\`\\\\b(\${commonTypos.join('|')})\\\\b\`, 'gi');

const HighlightedText: React.FC<{ text: string }> = React.memo(({ text }) => {
    const parts = useMemo(() => {
        return text.split(typoRegex).map((part, i) => {
            if (typoRegex.test(part)) {
                return <span key={i} className="underline decoration-red-500 decoration-wavy" title={\`Possible typo\`}>{part}</span>;
            }
            return part;
        });
    }, [text]);

    return <>{parts}</>;
});

export const CodeSpellChecker: React.FC = () => {
    const [code, setCode] = useState('funtion myFunction() {\\n  consle.log("Hello World");\\n  const myVarable = docment.getElementById("root");\\n  // This is a React componnet\\n}');

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <BeakerIcon />
                    <span className="ml-3">Code Spell Checker</span>
                </h1>
                <p className="text-text-secondary mt-1">A simple tool that finds and highlights common typos in code.</p>
            </header>
            <div className="relative flex-grow font-mono text-sm bg-surface border border-border rounded-lg p-4 overflow-auto">
                <textarea
                    value={code}
                    onChange={(e) => setCode(e.target.value)}
                    className="absolute inset-0 w-full h-full p-4 bg-transparent text-transparent caret-primary resize-none z-10"
                    spellCheck="false"
                />
                <pre className="absolute inset-0 w-full h-full p-4 pointer-events-none whitespace-pre-wrap" aria-hidden="true">
                    <HighlightedText text={code} />
                </pre>
            </div>
             <p className="text-xs text-text-secondary mt-2 text-center">This checker uses a predefined list of common typos and does not use AI.</p>
        </div>
    );
};`,
  'components/features/ColorPaletteGenerator.tsx': `import React, { useState, useCallback } from 'react';
import { HexColorPicker } from 'react-colorful';
import { generateColorPalette, downloadFile } from '../../services/index.ts';
import { SparklesIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

interface PreviewColors {
    cardBg: string;
    pillBg: string;
    pillText: string;
    buttonBg: string;
}

const PreviewCard: React.FC<{ palette: string[], colors: PreviewColors, setColors: React.Dispatch<React.SetStateAction<PreviewColors>> }> = ({ palette, colors, setColors }) => {
    
    const ColorSelector: React.FC<{ label: string, value: string, onChange: (val: string) => void }> = ({ label, value, onChange }) => (
        <div className="flex items-center justify-between text-sm">
            <label className="text-text-primary">{label}</label>
            <div className="flex items-center gap-2">
                {palette.map(color => (
                     <button 
                        key={color}
                        onClick={() => onChange(color)}
                        className={\`w-5 h-5 rounded-full border border-gray-300 \${value === color ? 'ring-2 ring-primary ring-offset-1' : ''}\`}
                        style={{ backgroundColor: color }}
                        title={color}
                     />
                ))}
            </div>
        </div>
    );
    
    return (
        <div className="bg-surface p-4 rounded-lg border border-border w-full max-w-sm">
            <h3 className="text-lg font-bold mb-4 text-text-primary">Live Preview</h3>
            <div className="p-8 rounded-xl mb-4" style={{ backgroundColor: colors.cardBg }}>
                <div className="px-4 py-1 rounded-full text-center text-sm inline-block" style={{ backgroundColor: colors.pillBg, color: colors.pillText }}>
                    New Feature
                </div>
                <div className="mt-8 text-center">
                     <button className="px-6 py-2 rounded-lg font-bold" style={{ backgroundColor: colors.buttonBg, color: colors.cardBg }}>
                        Get Started
                    </button>
                </div>
            </div>
            <div className="space-y-3">
                <ColorSelector label="Card Background" value={colors.cardBg} onChange={val => setColors(c => ({...c, cardBg: val}))} />
                <ColorSelector label="Pill Background" value={colors.pillBg} onChange={val => setColors(c => ({...c, pillBg: val}))} />
                <ColorSelector label="Pill Text" value={colors.pillText} onChange={val => setColors(c => ({...c, pillText: val}))} />
                <ColorSelector label="Button Background" value={colors.buttonBg} onChange={val => setColors(c => ({...c, buttonBg: val}))} />
            </div>
        </div>
    );
};

export const ColorPaletteGenerator: React.FC = () => {
    const [baseColor, setBaseColor] = useState("#0047AB");
    const [palette, setPalette] = useState<string[]>(['#F0F2F5', '#CCD3E8', '#99AADD', '#6688D1', '#3366CC', '#0047AB']);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [previewColors, setPreviewColors] = useState<PreviewColors>({
        cardBg: '#F0F2F5', pillBg: '#CCD3E8', pillText: '#0047AB', buttonBg: '#0047AB'
    });
    
    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        try {
            const result = await generateColorPalette(baseColor);
            setPalette(result.colors);
            setPreviewColors({
                cardBg: result.colors[0],
                pillBg: result.colors[2],
                pillText: result.colors[5],
                buttonBg: result.colors[5],
            })
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to generate palette: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, [baseColor]);
    
    const downloadColors = () => {
        const cssContent = \`:root {\\n\${palette.map((c, i) => \`  --color-palette-\${i+1}: \${c};\`).join('\\n')}\\n}\`;
        downloadFile(cssContent, 'palette.css', 'text/css');
    };
    
    const downloadCard = () => {
        const htmlContent = \`
<div class="card">
  <div class="pill">New Feature</div>
  <button class="button">Get Started</button>
</div>
        \`;
        const cssContent = \`
.card {
  background-color: \${previewColors.cardBg};
  padding: 2rem;
  border-radius: 1rem;
  text-align: center;
}
.pill {
  background-color: \${previewColors.pillBg};
  color: \${previewColors.pillText};
  display: inline-block;
  padding: 0.25rem 1rem;
  border-radius: 9999px;
  text-align: center;
  font-size: 0.875rem;
}
.button {
  margin-top: 2rem;
  background-color: \${previewColors.buttonBg};
  color: \${previewColors.cardBg};
  padding: 0.5rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: bold;
  border: none;
  cursor: pointer;
}
        \`;
        const combined = \`<!-- HTML -->\\n\${htmlContent}\\n\\n<!-- CSS -->\\n<style>\\n\${cssContent}\\n</style>\`;
        downloadFile(combined, 'preview-card.html', 'text/html');
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-3xl font-bold flex items-center justify-center">
                    <SparklesIcon />
                    <span className="ml-3">AI Color Palette Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Pick a base color, let Gemini design a palette, and preview it on a UI card.</p>
            </header>
            <div className="flex-grow flex flex-col lg:flex-row items-center justify-center gap-8">
                <div className="flex flex-col items-center gap-4">
                     <HexColorPicker color={baseColor} onChange={setBaseColor} className="!w-64 !h-64"/>
                     <div className="p-2 bg-surface rounded-md font-mono text-lg border border-border" style={{color: baseColor}}>{baseColor}</div>
                      <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Palette'}
                    </button>
                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                </div>
                <div className="flex flex-col gap-2 w-full max-w-sm">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Palette:</label>
                    {isLoading ? (
                         <div className="flex items-center justify-center h-48"><LoadingSpinner /></div>
                    ) : (
                        palette.map((color) => (
                            <div key={color} className="group flex items-center justify-between p-4 rounded-md shadow-sm border border-border" style={{ backgroundColor: color }}>
                                <span className="font-mono font-bold text-black/70 mix-blend-overlay">{color}</span>
                                <button onClick={() => navigator.clipboard.writeText(color)} className="opacity-0 group-hover:opacity-100 transition-opacity bg-white/30 hover:bg-white/50 px-3 py-1 rounded text-xs text-black font-semibold backdrop-blur-sm">Copy</button>
                            </div>
                        ))
                    )}
                    <div className="flex gap-2 mt-2">
                        <button onClick={downloadColors} className="flex-1 flex items-center justify-center gap-2 text-sm py-2 bg-gray-100 border border-border rounded-md hover:bg-gray-200"><ArrowDownTrayIcon className="w-4 h-4"/> Download Colors</button>
                        <button onClick={downloadCard} className="flex-1 flex items-center justify-center gap-2 text-sm py-2 bg-gray-100 border border-border rounded-md hover:bg-gray-200"><ArrowDownTrayIcon className="w-4 h-4"/> Download Card</button>
                    </div>
                </div>
                {!isLoading && <PreviewCard palette={palette} colors={previewColors} setColors={setPreviewColors} />}
            </div>
        </div>
    );
};`,
  'components/features/CommandPaletteTrigger.tsx': `import React from 'react';
import { CommandLineIcon } from '../icons.tsx';

export const CommandPaletteTrigger: React.FC = () => {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center text-text-secondary">
            <div className="text-6xl mb-4 text-primary" aria-hidden="true">
                <CommandLineIcon />
            </div>
            <h1 className="text-3xl font-bold text-text-primary mb-2">
                Command Palette
            </h1>
            <p className="text-lg mb-4 max-w-md">
                The Command Palette provides quick keyboard access to all features and commands.
            </p>
            <div className="bg-surface text-primary border border-border rounded-lg px-6 py-4 animate-pulse shadow-sm">
                <p className="font-semibold text-text-primary">Press <kbd className="mx-1 font-sans px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Ctrl</kbd> + <kbd className="mx-1 font-sans px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">K</kbd> to open.</p>
            </div>
        </div>
    );
};`,
  'components/features/Connections.tsx': `import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { validateToken } from '../../services/authService.ts';
import { ACTION_REGISTRY, executeWorkspaceAction } from '../../services/workspaceConnectorService.ts';
import { RectangleGroupIcon, GithubIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { signInWithGoogle } from '../../services/googleAuthService.ts';
import { useVaultModal } from '../../contexts/VaultModalContext.tsx';

const ServiceConnectionCard: React.FC<{
    serviceName: string;
    icon: React.ReactNode;
    fields: { id: string; label: string; placeholder: string }[];
    onConnect: (credentials: Record<string, string>) => Promise<void>;
    onDisconnect: () => Promise<void>;
    status: string;
    isLoading: boolean;
}> = ({ serviceName, icon, fields, onConnect, onDisconnect, status, isLoading }) => {
    const [creds, setCreds] = useState<Record<string, string>>({});

    const handleConnect = () => {
        onConnect(creds);
    };

    const isConnected = status.startsWith('Connected');

    return (
        <div className="bg-surface border border-border rounded-lg p-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10">{icon}</div>
                    <div>
                        <h3 className="text-lg font-bold text-text-primary">{serviceName}</h3>
                        <p className={\`text-sm \${isConnected ? 'text-green-600' : 'text-text-secondary'}\`}>{status}</p>
                    </div>
                </div>
                {isConnected && (
                    <button onClick={onDisconnect} className="px-4 py-2 bg-red-500/10 text-red-600 font-semibold rounded-lg hover:bg-red-500/20">
                        Disconnect
                    </button>
                )}
            </div>
            {!isConnected && (
                <div className="mt-4 pt-4 border-t border-border space-y-2">
                    {fields.map(field => (
                        <div key={field.id}>
                            <label className="text-xs text-text-secondary">{field.label}</label>
                            <input
                                type={field.id.includes('token') || field.id.includes('pat') ? 'password' : 'text'}
                                value={creds[field.id] || ''}
                                onChange={e => setCreds(prev => ({ ...prev, [field.id]: e.target.value }))}
                                placeholder={field.placeholder}
                                className="w-full mt-1 p-2 bg-background border border-border rounded-md text-sm"
                            />
                        </div>
                    ))}
                    <button onClick={handleConnect} disabled={isLoading} className="btn-primary w-full mt-2 py-2 flex items-center justify-center">
                        {isLoading ? <LoadingSpinner /> : 'Connect'}
                    </button>
                </div>
            )}
        </div>
    );
};


export const WorkspaceConnectorHub: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, vaultState } = state;
    const { addNotification } = useNotification();
    const { requestUnlock, requestCreation } = useVaultModal();
    const [loadingStates, setLoadingStates] = useState<Record<string, boolean>>({});
    const [connectionStatuses, setConnectionStatuses] = useState<Record<string, string>>({});
    
    // Manual action state
    const [selectedActionId, setSelectedActionId] = useState<string>([...ACTION_REGISTRY.keys()][0]);
    const [actionParams, setActionParams] = useState<Record<string, any>>({});
    const [isExecuting, setIsExecuting] = useState(false);
    const [actionResult, setActionResult] = useState<string>('');

    const services = useMemo(() => {
        const serviceMap = new Map();
        ACTION_REGISTRY.forEach(action => {
            if (!serviceMap.has(action.service)) {
                serviceMap.set(action.service, {
                    name: action.service,
                    actions: [],
                });
            }
            serviceMap.get(action.service).actions.push(action);
        });
        return Array.from(serviceMap.values());
    }, []);

    const checkConnections = useCallback(async () => {
        if (!user || !vaultState.isUnlocked) return;
        
        const checkCred = async (credId: string, serviceName: string, successMessage: string) => {
             const token = await vaultService.getDecryptedCredential(credId);
             setConnectionStatuses(s => ({ ...s, [serviceName]: token ? successMessage : 'Not Connected' }));
        };

        await checkCred('github_pat', 'GitHub', githubUser ? \`Connected as \${githubUser.login}\`: 'Connected');
        await checkCred('jira_pat', 'Jira', 'Connected');
        await checkCred('slack_bot_token', 'Slack', 'Connected');

    }, [user, vaultState.isUnlocked, githubUser]);

    useEffect(() => {
        checkConnections();
    }, [checkConnections]);
    
    const withVault = useCallback(async (callback: () => Promise<void>) => {
        if (!vaultState.isInitialized) {
            const created = await requestCreation();
            if (!created) { addNotification('Vault setup is required.', 'error'); return; }
        }
        if (!vaultState.isUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) { addNotification('Vault must be unlocked to manage connections.', 'error'); return; }
        }
        await callback();
    }, [vaultState, requestCreation, requestUnlock, addNotification]);


    const handleConnect = async (serviceName: string, credentials: Record<string, string>) => {
        await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const [key, value] of Object.entries(credentials)) {
                    if (value) await vaultService.saveCredential(key, value);
                }
                if (serviceName === 'GitHub' && credentials.github_pat) {
                     const githubProfile = await validateToken(credentials.github_pat);
                     dispatch({ type: 'SET_GITHUB_USER', payload: githubProfile });
                     await vaultService.saveCredential('github_user', JSON.stringify(githubProfile));
                }
                addNotification(\`\${serviceName} connected successfully!\`, 'success');
                checkConnections();
            } catch (e) {
                addNotification(\`Failed to connect \${serviceName}: \${e instanceof Error ? e.message : 'Unknown error'}\`, 'error');
            } finally {
                setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
        });
    };
    
    const handleDisconnect = async (serviceName: string, credIds: string[]) => {
       await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const id of credIds) {
                     await vaultService.saveCredential(id, ''); // Overwrite with empty string
                }
                 if (serviceName === 'GitHub') {
                     dispatch({ type: 'SET_GITHUB_USER', payload: null });
                     await vaultService.saveCredential('github_user', '');
                }
                addNotification(\`\${serviceName} disconnected.\`, 'info');
                checkConnections();
            } catch(e) {
                addNotification(\`Failed to disconnect \${serviceName}.\`, 'error');
            } finally {
                 setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
       });
    };
    
    const handleExecuteAction = async () => {
        await withVault(async () => {
            setIsExecuting(true);
            setActionResult('');
            try {
                const result = await executeWorkspaceAction(selectedActionId, actionParams);
                setActionResult(JSON.stringify(result, null, 2));
                addNotification('Action executed successfully!', 'success');
            } catch(e) {
                setActionResult(\`Error: \${e instanceof Error ? e.message : 'Unknown Error'}\`);
                addNotification('Action failed.', 'error');
            } finally {
                setIsExecuting(false);
            }
        });
    };

    const handleSignIn = () => {
        signInWithGoogle();
        // The result is handled by the global callback set in App.tsx
    };

    const selectedAction = ACTION_REGISTRY.get(selectedActionId);
    const actionParameters = selectedAction ? selectedAction.getParameters() : {};

    if (!user) {
        return (
            <div className="h-full flex items-center justify-center">
                <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md">
                    <h2 className="text-xl font-bold">Sign In Required</h2>
                    <p className="text-text-secondary my-4">Please sign in with your Google account to manage workspace connections.</p>
                    <button onClick={handleSignIn} disabled={loadingStates.google} className="btn-primary px-6 py-3 flex items-center justify-center gap-2 mx-auto">
                        {loadingStates.google ? <LoadingSpinner/> : 'Sign in with Google'}
                    </button>
                </div>
            </div>
        );
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
             <header className="mb-8">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center"><RectangleGroupIcon /><span className="ml-3">Workspace Connector Hub</span></h1>
                <p className="mt-2 text-lg text-text-secondary">Connect to your development services to unlock cross-platform AI actions.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                <div className="flex flex-col gap-6 overflow-y-auto pr-4">
                    <h2 className="text-2xl font-bold">Service Connections</h2>
                    <ServiceConnectionCard 
                        serviceName="GitHub"
                        icon={<GithubIcon />}
                        fields={[{ id: 'github_pat', label: 'Personal Access Token', placeholder: 'ghp_...' }]}
                        onConnect={(creds) => handleConnect('GitHub', creds)}
                        onDisconnect={() => handleDisconnect('GitHub', ['github_pat'])}
                        status={connectionStatuses.GitHub || 'Checking...'}
                        isLoading={loadingStates.GitHub}
                    />
                     {/* Placeholder cards for Jira and Slack */}
                    <ServiceConnectionCard 
                        serviceName="Jira"
                        icon={<div className="w-10 h-10 bg-[#0052CC] rounded flex items-center justify-center text-white font-bold text-xl">J</div>}
                        fields={[
                            { id: 'jira_domain', label: 'Jira Domain', placeholder: 'your-company.atlassian.net' },
                            { id: 'jira_email', label: 'Your Jira Email', placeholder: 'you@example.com' },
                            { id: 'jira_pat', label: 'API Token', placeholder: 'Your API Token' },
                        ]}
                        onConnect={(creds) => handleConnect('Jira', creds)}
                        onDisconnect={() => handleDisconnect('Jira', ['jira_domain', 'jira_email', 'jira_pat'])}
                        status={connectionStatuses.Jira || 'Checking...'}
                        isLoading={loadingStates.Jira}
                    />
                    <ServiceConnectionCard 
                        serviceName="Slack"
                        icon={<div className="w-10 h-10 bg-[#4A154B] rounded flex items-center justify-center text-white font-bold text-2xl">#</div>}
                        fields={[{ id: 'slack_bot_token', label: 'Bot User OAuth Token', placeholder: 'xoxb-...' }]}
                        onConnect={(creds) => handleConnect('Slack', creds)}
                        onDisconnect={() => handleDisconnect('Slack', ['slack_bot_token'])}
                        status={connectionStatuses.Slack || 'Checking...'}
                        isLoading={loadingStates.Slack}
                    />
                </div>
                <div className="flex flex-col gap-6 bg-surface p-6 border border-border rounded-lg">
                    <h2 className="text-2xl font-bold">Manual Action Runner</h2>
                    <div className="space-y-4">
                         <div>
                            <label className="text-sm font-medium">Action</label>
                            <select value={selectedActionId} onChange={e => setSelectedActionId(e.target.value)} className="w-full mt-1 p-2 bg-background border rounded">
                                {services.map(service => (
                                    <optgroup label={service.name} key={service.name}>
                                        {service.actions.map((action: any) => (
                                            <option key={action.id} value={action.id}>{action.description}</option>
                                        ))}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                        {Object.entries(actionParameters).map(([key, param]: [string, any]) => (
                            <div key={key}>
                                <label className="text-sm font-medium">{key} {param.required && '*'}</label>
                                <input 
                                    type={param.type}
                                    value={actionParams[key] || ''}
                                    onChange={e => setActionParams(p => ({...p, [key]: e.target.value}))}
                                    placeholder={param.default || ''}
                                    className="w-full mt-1 p-2 bg-background border rounded"
                                />
                            </div>
                        ))}
                        <button onClick={handleExecuteAction} disabled={isExecuting} className="btn-primary w-full py-2 flex items-center justify-center gap-2">
                           {isExecuting ? <LoadingSpinner/> : <><SparklesIcon /> Execute Action</>}
                        </button>
                    </div>
                    <div>
                        <label className="text-sm font-medium">Result</label>
                        <pre className="w-full h-48 mt-1 p-2 bg-background border rounded overflow-auto text-xs">{actionResult || 'Action results will appear here.'}</pre>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/CronJobBuilder.tsx': `import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { CommandLineIcon, SparklesIcon } from '../icons.tsx';
import { generateCronFromDescription, CronParts } from '../../services/index.ts';
import { LoadingSpinner } from '../shared/index.tsx';

const CronPartSelector: React.FC<{ label: string, value: string, onChange: (value: string) => void, options: (string|number)[] }> = ({ label, value, onChange, options }) => {
    return (
        <div>
            <label className="block text-sm font-medium text-text-secondary">{label}</label>
            <select value={value} onChange={e => onChange(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-md bg-surface border border-border">
                <option value="*">* (every)</option>
                {options.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
        </div>
    );
};

export const CronJobBuilder: React.FC<{ initialPrompt?: string }> = ({ initialPrompt }) => {
    const [minute, setMinute] = useState('0');
    const [hour, setHour] = useState('17');
    const [dayOfMonth, setDayOfMonth] = useState('*');
    const [month, setMonth] = useState('*');
    const [dayOfWeek, setDayOfWeek] = useState('1-5');
    const [aiPrompt, setAiPrompt] = useState(initialPrompt || 'every weekday at 5pm');
    const [isLoading, setIsLoading] = useState(false);
    
    const cronExpression = useMemo(() => {
        return \`\${minute} \${hour} \${dayOfMonth} \${month} \${dayOfWeek}\`;
    }, [minute, hour, dayOfMonth, month, dayOfWeek]);

    const handleAiGenerate = useCallback(async (p: string) => {
        if (!p) return;
        setIsLoading(true);
        try {
            const result: CronParts = await generateCronFromDescription(p);
            setMinute(result.minute);
            setHour(result.hour);
            setDayOfMonth(result.dayOfMonth);
            setMonth(result.month);
            setDayOfWeek(result.dayOfWeek);
        } catch (e) {
            console.error(e);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialPrompt) {
            setAiPrompt(initialPrompt);
            handleAiGenerate(initialPrompt);
        }
    }, [initialPrompt, handleAiGenerate]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CommandLineIcon />
                    <span className="ml-3">AI Cron Job Builder</span>
                </h1>
                <p className="text-text-secondary mt-1">Visually construct a cron expression or describe it in plain English.</p>
            </header>
             <div className="flex gap-2 mb-6">
                <input type="text" value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Describe a schedule..." className="flex-grow px-3 py-1.5 rounded-md bg-surface border border-border text-sm"/>
                <button onClick={() => handleAiGenerate(aiPrompt)} disabled={isLoading} className="btn-primary px-4 py-1.5 flex items-center gap-2">
                    {isLoading ? <LoadingSpinner /> : <SparklesIcon />} AI Generate
                </button>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <CronPartSelector label="Minute" value={minute} onChange={setMinute} options={Array.from({length: 60}, (_, i) => i)} />
                <CronPartSelector label="Hour" value={hour} onChange={setHour} options={Array.from({length: 24}, (_, i) => i)} />
                <CronPartSelector label="Day (Month)" value={dayOfMonth} onChange={setDayOfMonth} options={Array.from({length: 31}, (_, i) => i + 1)} />
                <CronPartSelector label="Month" value={month} onChange={setMonth} options={Array.from({length: 12}, (_, i) => i + 1)} />
                <CronPartSelector label="Day (Week)" value={dayOfWeek} onChange={setDayOfWeek} options={Array.from({length: 7}, (_, i) => i)} />
            </div>
            <div className="bg-surface p-4 rounded-lg text-center border border-border">
                <p className="text-text-secondary text-sm">Generated Expression</p>
                <p className="font-mono text-primary text-2xl mt-1">{cronExpression}</p>
                 <button onClick={() => navigator.clipboard.writeText(cronExpression)} className="mt-4 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button>
            </div>
        </div>
    );
};`,
  'components/features/CssGridEditor.tsx': `import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/index.ts';

const initialSettings = { rows: 3, cols: 4, rowGap: 1, colGap: 1 };

export const CssGridEditor: React.FC = () => {
    const [rows, setRows] = useState(initialSettings.rows);
    const [cols, setCols] = useState(initialSettings.cols);
    const [rowGap, setRowGap] = useState(initialSettings.rowGap);
    const [colGap, setColGap] = useState(initialSettings.colGap);

    const gridStyle = {
        display: 'grid',
        gridTemplateColumns: \`repeat(\${cols}, 1fr)\`,
        gridTemplateRows: \`repeat(\${rows}, 1fr)\`,
        gap: \`\${rowGap}rem \${colGap}rem\`,
        height: '100%',
        width: '100%'
    };

    const cssCode = useMemo(() => {
        return \`.grid-container {
  display: grid;
  grid-template-columns: repeat(\${cols}, 1fr);
  grid-template-rows: repeat(\${rows}, 1fr);
  gap: \${rowGap}rem \${colGap}rem;
}\`;
    }, [rows, cols, rowGap, colGap]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(cssCode);
    };
    
    const handleDownload = () => {
        downloadFile(cssCode, 'grid.css', 'text/css');
    };

    const handleReset = () => {
        setRows(initialSettings.rows);
        setCols(initialSettings.cols);
        setRowGap(initialSettings.rowGap);
        setColGap(initialSettings.colGap);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CodeBracketSquareIcon />
                    <span className="ml-3">CSS Grid Visual Editor</span>
                </h1>
                <p className="text-text-secondary mt-1">Configure your grid layout and copy the generated CSS.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <div className="flex justify-between items-center">
                        <h3 className="text-xl font-bold">Controls</h3>
                        <button onClick={handleReset} className="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md">Reset</button>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="rows" className="block text-sm font-medium text-text-secondary">Rows ({rows})</label>
                            <input id="rows" type="range" min="1" max="12" value={rows} onChange={e => setRows(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                        <div>
                            <label htmlFor="cols" className="block text-sm font-medium text-text-secondary">Columns ({cols})</label>
                            <input id="cols" type="range" min="1" max="12" value={cols} onChange={e => setCols(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                         <div>
                            <label htmlFor="rowGap" className="block text-sm font-medium text-text-secondary">Row Gap ({rowGap}rem)</label>
                            <input id="rowGap" type="range" min="0" max="8" step="0.25" value={rowGap} onChange={e => setRowGap(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                         <div>
                            <label htmlFor="colGap" className="block text-sm font-medium text-text-secondary">Column Gap ({colGap}rem)</label>
                            <input id="colGap" type="range" min="0" max="8" step="0.25" value={colGap} onChange={e => setColGap(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                    </div>
                     <div className="flex-grow mt-4 flex flex-col min-h-[150px]">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-sm font-medium text-text-secondary">Generated CSS</label>
                            <div className="flex gap-2">
                                <button onClick={handleCopy} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs"><ArrowDownTrayIcon className="w-4 h-4"/> Download</button>
                            </div>
                        </div>
                        <div className="relative flex-grow">
                            <pre className="bg-background p-4 rounded-md text-primary text-sm overflow-auto h-full w-full absolute">{cssCode}</pre>
                        </div>
                    </div>
                </div>
                <div className="lg:col-span-2 bg-background rounded-lg p-4 border-2 border-dashed border-border">
                    <div style={gridStyle}>
                        {Array.from({ length: rows * cols }).map((_, i) => (
                            <div key={i} className="bg-primary/10 rounded-lg border-2 border-dashed border-primary/50 flex items-center justify-center text-primary">
                                <span className="text-xs opacity-70">{i + 1}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/DeploymentPreview.tsx': `import React, { useState, useEffect, useRef } from 'react';
import { getAllFiles, getFileByPath } from '../../services/dbService.ts';
import type { GeneratedFile } from '../../types.ts';
import { CloudIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

export const DeploymentPreview: React.FC = () => {
    const [files, setFiles] = useState<GeneratedFile[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    const iframeRef = useRef<HTMLIFrameElement>(null);

    useEffect(() => {
        const loadAndRender = async () => {
            setIsLoading(true);
            setError('');
            try {
                const allFiles = await getAllFiles();
                if (allFiles.length === 0) {
                    setError('No files generated by AI Feature Builder found.');
                    setFiles([]);
                    setIsLoading(false);
                    return;
                }
                setFiles(allFiles);

                let indexHtmlFile = allFiles.find(f => f.filePath.endsWith('index.html'));
                if (!indexHtmlFile) {
                    setError('No index.html file found in the generated files.');
                    setIsLoading(false);
                    return;
                }

                let content = indexHtmlFile.content;
                
                // Create blob URLs for all assets and replace relative paths
                const blobUrlMap = new Map<string, string>();
                for (const file of allFiles) {
                    const mimeType = file.filePath.endsWith('.css') ? 'text/css' : 'application/javascript';
                    const blob = new Blob([file.content], { type: mimeType });
                    blobUrlMap.set(file.filePath, URL.createObjectURL(blob));
                }
                
                // Replace relative paths in index.html
                content = content.replace(/(href|src)=["'](\\.?\\/)?([^"']+)["']/g, (match, attr, prefix, path) => {
                    const blobUrl = blobUrlMap.get(path);
                    return blobUrl ? \`\${attr}="\${blobUrl}"\` : match;
                });

                if (iframeRef.current) {
                    iframeRef.current.srcdoc = content;
                }

            } catch (err) {
                setError(err instanceof Error ? err.message : 'Failed to load files.');
            } finally {
                setIsLoading(false);
            }
        };

        loadAndRender();
        
        // Cleanup blob URLs on unmount
        return () => {
             // This is a bit tricky since we don't have the map here, but the browser will clean them up.
        };
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><CloudIcon /><span className="ml-3">Static Deployment Previewer</span></h1>
                <p className="text-text-secondary mt-1">Live preview of the static site generated by the AI Feature Builder.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 bg-surface p-4 border border-border rounded-lg overflow-y-auto">
                    <h3 className="font-bold mb-2">File List</h3>
                    <ul className="text-sm space-y-1">
                        {files.map(f => <li key={f.filePath} className="truncate p-1 bg-background rounded">{f.filePath}</li>)}
                    </ul>
                </div>
                <div className="lg:col-span-2 bg-background border-2 border-dashed border-border rounded-lg overflow-hidden">
                    {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                    {error && <div className="flex justify-center items-center h-full text-red-500">{error}</div>}
                    {!isLoading && !error && <iframe ref={iframeRef} title="Deployment Preview" className="w-full h-full bg-white"/>}
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/DevNotesStickyPanel.tsx': `import React from 'react';

export const DevNotesStickyPanel: React.FC = () => {
    return (
        <div className="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
            <h4 className="font-bold">Developer Notes</h4>
            <p>This is a placeholder component for developer notes.</p>
        </div>
    );
};
`,
  'components/features/DigitalWhiteboard.tsx': `import React, { useState, useCallback } from 'react';
import { SparklesIcon, DigitalWhiteboardIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';
import { summarizeNotesStream } from '../../services/index.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

interface Note {
    id: number;
    text: string;
    x: number;
    y: number;
    color: string;
}

const colors = ['bg-yellow-400', 'bg-green-400', 'bg-blue-400', 'bg-pink-400', 'bg-purple-400', 'bg-orange-400'];
const textColors = ['text-yellow-900', 'text-green-900', 'text-blue-900', 'text-pink-900', 'text-purple-900', 'text-orange-900'];

export const DigitalWhiteboard: React.FC = () => {
    const [notes, setNotes] = useLocalStorage<Note[]>('devcore_whiteboard_notes', []);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const [isSummarizing, setIsSummarizing] = useState(false);
    const [summary, setSummary] = useState('');

    const handleSummarize = useCallback(async () => {
        if (notes.length === 0) return;
        setIsSummarizing(true);
        setSummary('');
        try {
            const allNotesText = notes.map((n: Note) => \`- \${n.text}\`).join('\\n');
            const stream = summarizeNotesStream(allNotesText);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setSummary(fullResponse);
            }
        } catch (error) {
            console.error(error);
            setSummary('Sorry, an error occurred while summarizing.');
        } finally {
            setIsSummarizing(false);
        }
    }, [notes]);

    const addNote = () => {
        const newNote: Note = {
            id: Date.now(),
            text: 'New idea...',
            x: 50,
            y: 50,
            color: colors[notes.length % colors.length],
        };
        setNotes([...notes, newNote]);
    };
    
    const deleteNote = (id: number, e: React.MouseEvent) => {
        e.stopPropagation();
        setNotes(notes.filter((n) => n.id !== id));
    };

    const updateNote = (id: number, updates: Partial<Note>) => {
        setNotes(notes.map((n) => n.id === id ? { ...n, ...updates } : n));
    };

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        const target = e.target as HTMLElement;
        if (target.tagName === 'TEXTAREA' || target.dataset.role === 'button') return;
        
        const noteElement = e.currentTarget;
        const rect = noteElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging) return;
        const boardRect = e.currentTarget.getBoundingClientRect();
        updateNote(dragging.id, {
            x: e.clientX - dragging.offsetX - boardRect.left,
            y: e.clientY - dragging.offsetY - boardRect.top
        });
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                 <div>
                    <h1 className="text-3xl font-bold flex items-center"><DigitalWhiteboardIcon /><span className="ml-3">Digital Whiteboard</span></h1>
                    <p className="text-text-secondary mt-1">Organize your ideas with interactive sticky notes and AI summaries.</p>
                </div>
                <div className="flex gap-2">
                    <button onClick={handleSummarize} disabled={isSummarizing || notes.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                        <SparklesIcon/> {isSummarizing ? 'Summarizing...' : 'AI Summarize'}
                    </button>
                    <button onClick={addNote} className="btn-primary px-6 py-2">Add Note</button>
                </div>
            </header>
            <div
                className="relative flex-grow bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}
            >
                {notes.map((note) => (
                    <div
                        key={note.id}
                        className={\`group absolute w-56 h-56 p-2 flex flex-col shadow-lg cursor-grab active:cursor-grabbing rounded-md transition-transform duration-100 border border-black/40 \${note.color} \${textColors[colors.indexOf(note.color)]}\`}
                        style={{ top: note.y, left: note.x, transform: dragging?.id === note.id ? 'scale(1.05)' : 'scale(1)' }}
                        onMouseDown={e => onMouseDown(e, note.id)}
                    >
                        <button data-role="button" onClick={(e) => deleteNote(note.id, e)} className="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-gray-700 text-white font-bold text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500 transition-all">&times;</button>
                        <textarea
                            value={note.text}
                            onChange={(e) => updateNote(note.id, { text: e.target.value })}
                            className="w-full h-full bg-transparent resize-none focus:outline-none font-medium p-1"
                        />
                        <div data-role="button" className="flex-shrink-0 flex justify-center gap-1 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            {colors.map((c, i) => <button key={c} onClick={() => updateNote(note.id, { color: c })} className={\`w-4 h-4 rounded-full \${c} border border-black/20 \${note.color === c ? 'ring-2 ring-offset-1 ring-black/50' : ''}\`}/>)}
                        </div>
                    </div>
                ))}
            </div>
             {(isSummarizing || summary) && (
                 <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center" onClick={() => setSummary('')}>
                    <div className="w-full max-w-2xl bg-surface border border-border rounded-lg shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-4">AI Summary of Notes</h2>
                        {isSummarizing && !summary ? <LoadingSpinner /> : <MarkdownRenderer content={summary} />}
                    </div>
                </div>
            )}
        </div>
    );
};`,
  'components/features/EnvManager.tsx': `import React, { useState } from 'react';
import { downloadEnvFile } from '../../services/fileUtils.ts';
import { DocumentTextIcon, PlusIcon, TrashIcon, ArrowDownTrayIcon } from '../icons.tsx';

interface EnvVar {
    id: number;
    key: string;
    value: string;
}

export const EnvManager: React.FC = () => {
    const [envVars, setEnvVars] = useState<EnvVar[]>([
        { id: 1, key: 'VITE_API_URL', value: 'https://api.example.com' },
        { id: 2, key: 'VITE_ENABLE_FEATURE_X', value: 'true' },
    ]);

    const handleAdd = () => {
        setEnvVars([...envVars, { id: Date.now(), key: '', value: '' }]);
    };

    const handleUpdate = (id: number, field: 'key' | 'value', val: string) => {
        setEnvVars(envVars.map(v => v.id === id ? { ...v, [field]: val } : v));
    };

    const handleRemove = (id: number) => {
        setEnvVars(envVars.filter(v => v.id !== id));
    };
    
    const handleDownload = () => {
        const envObject = envVars.reduce((acc, v) => {
            if (v.key) acc[v.key] = v.value;
            return acc;
        }, {} as Record<string, string>);
        downloadEnvFile(envObject);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><DocumentTextIcon /><span className="ml-3">Environment Variable Manager</span></h1>
                <p className="text-text-secondary mt-1">Create and manage your \`.env\` files with a simple interface.</p>
            </header>
            <div className="flex-grow bg-surface p-6 rounded-lg border border-border w-full max-w-4xl mx-auto overflow-y-auto">
                <div className="space-y-3">
                    <div className="grid grid-cols-12 gap-4 font-semibold text-sm text-text-secondary px-2">
                        <div className="col-span-5">Key</div>
                        <div className="col-span-6">Value</div>
                        <div className="col-span-1"></div>
                    </div>
                    {envVars.map((v, index) => (
                        <div key={v.id} className="grid grid-cols-12 gap-4 items-center">
                            <div className="col-span-5">
                                <input
                                    type="text"
                                    value={v.key}
                                    onChange={e => handleUpdate(v.id, 'key', e.target.value)}
                                    placeholder={\`KEY_\${index + 1}\`}
                                    className="w-full p-2 bg-background border border-border rounded-md font-mono text-sm"
                                />
                            </div>
                            <div className="col-span-6">
                                <input
                                    type="text"
                                    value={v.value}
                                    onChange={e => handleUpdate(v.id, 'value', e.target.value)}
                                    placeholder="value"
                                    className="w-full p-2 bg-background border border-border rounded-md font-mono text-sm"
                                />
                            </div>
                            <div className="col-span-1">
                                <button onClick={() => handleRemove(v.id)} className="p-2 text-text-secondary hover:text-red-500 rounded-md"><TrashIcon /></button>
                            </div>
                        </div>
                    ))}
                </div>
                 <div className="mt-4 pt-4 border-t border-border flex justify-between items-center">
                    <button onClick={handleAdd} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-sm font-semibold rounded-md hover:bg-gray-200">
                        <PlusIcon /> Add Variable
                    </button>
                    <button onClick={handleDownload} disabled={envVars.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                        <ArrowDownTrayIcon /> Download .env File
                    </button>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/FontPairingTool.tsx': `// This feature is an alias for the Typography Lab.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { TypographyLab as FontPairingTool } from './TypographyLab.tsx';`,
  'components/features/FontPreviewPicker.tsx': `import React, { useState, useEffect } from 'react';
import { TypographyLabIcon } from '../icons.tsx';

const popularFonts = [
    'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Source Sans Pro', 'Raleway', 'Poppins', 'Nunito', 'Merriweather',
    'Playfair Display', 'Lora', 'Noto Sans', 'Ubuntu', 'PT Sans', 'Slabo 27px', 'Great Vibes', 'EB Garamond'
];

export const FontPreviewPicker: React.FC = () => {
    const [text, setText] = useState('The quick brown fox jumps over the lazy dog.');
    const [fontSize, setFontSize] = useState(24);

    useEffect(() => {
        const fontsToLoad = popularFonts.join('|').replace(/ /g, '+');
        const linkId = 'font-picker-stylesheet';
        let link = document.getElementById(linkId) as HTMLLinkElement;
        if (!link) {
            link = document.createElement('link');
            link.id = linkId;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        }
        link.href = \`https://fonts.googleapis.com/css?family=\${fontsToLoad}:400,700&display=swap\`;
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <TypographyLabIcon />
                    <span className="ml-3">Font Preview Picker</span>
                </h1>
                <p className="text-text-secondary mt-1">Enter your text and see how it looks with different fonts.</p>
            </header>

            <div className="flex flex-col md:flex-row gap-4 mb-6">
                <div className="flex-grow">
                    <label htmlFor="preview-text" className="text-sm font-medium">Preview Text</label>
                    <input
                        id="preview-text"
                        type="text"
                        value={text}
                        onChange={e => setText(e.target.value)}
                        className="w-full mt-1 p-2 bg-surface border border-border rounded-md"
                    />
                </div>
                <div>
                    <label htmlFor="font-size" className="text-sm font-medium">Font Size ({fontSize}px)</label>
                    <input
                        id="font-size"
                        type="range"
                        min="12"
                        max="72"
                        value={fontSize}
                        onChange={e => setFontSize(Number(e.target.value))}
                        className="w-full mt-1"
                    />
                </div>
            </div>

            <div className="flex-grow bg-surface border border-border rounded-lg p-4 overflow-y-auto">
                <div className="space-y-4">
                    {popularFonts.map(font => (
                        <div key={font} className="border-b border-border pb-2">
                            <p className="text-sm text-text-secondary">{font}</p>
                            <p style={{ fontFamily: \`'\${font}', sans-serif\`, fontSize: \`\${fontSize}px\` }}>
                                {text}
                            </p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};`,
  'components/features/GmailAddonSimulator.tsx': `import React, { useState, useCallback } from 'react';
import { streamContent } from '../../services/aiService.ts';
import { MailIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const mockEmail = {
    from: 'Alice <alice@example.com>',
    to: 'Me <me@example.com>',
    subject: 'Project Update & Question',
    body: \`Hey,

Just wanted to give you a quick update. The new user authentication flow is complete and pushed to the staging server.

I had a question about the next task regarding the database migration. The ticket says we need to migrate the 'users' table, but it's not clear on the required schema changes. Should I just add the new 'last_login' column or are there other modifications needed?

Let me know when you have a chance.

Thanks,
Alice\`
};

export const GmailAddonSimulator: React.FC = () => {
    const [isComposeOpen, setComposeOpen] = useState(false);
    const [generatedReply, setGeneratedReply] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);

    const handleGenerateReply = useCallback(async () => {
        setIsGenerating(true);
        setGeneratedReply('');
        setComposeOpen(true);
        try {
            const prompt = \`Generate a professional and friendly reply to the following email. Acknowledge the update and answer the question by stating that only the 'last_login' column (as a DATETIME) is needed for now.\\n\\nEMAIL:\\n\${mockEmail.body}\`;
            const stream = streamContent(prompt, "You are a helpful assistant writing a professional email reply.", 0.7);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setGeneratedReply(fullResponse);
            }
        } catch(e) {
            setGeneratedReply(\`Error: \${e instanceof Error ? e.message : 'Could not generate reply.'}\`);
        }
        finally {
            setIsGenerating(false);
        }
    }, []);

    const ComposeModal = () => (
        <div className="absolute inset-0 bg-black/30 backdrop-blur-sm flex justify-center items-center p-4 z-20">
            <div className="w-full max-w-2xl h-[70vh] bg-surface rounded-lg shadow-2xl flex flex-col animate-pop-in">
                <header className="flex justify-between items-center p-3 bg-gray-100 dark:bg-slate-700 rounded-t-lg">
                    <h3 className="font-semibold text-sm">New Message</h3>
                    <button onClick={() => setComposeOpen(false)}><XMarkIcon /></button>
                </header>
                <div className="p-3 text-sm border-b border-border">
                    <p><span className="text-text-secondary">To:</span> {mockEmail.from}</p>
                </div>
                <div className="p-3 text-sm border-b border-border">
                     <p><span className="text-text-secondary">Subject:</span> Re: {mockEmail.subject}</p>
                </div>
                <div className="flex-grow p-3 overflow-y-auto">
                    {isGenerating ? <div className="flex justify-center items-center h-full"><LoadingSpinner /></div> : <MarkdownRenderer content={generatedReply} />}
                </div>
                 <footer className="p-3 border-t border-border">
                    <button className="btn-primary px-6 py-2">Send</button>
                 </footer>
            </div>
        </div>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><MailIcon /><span className="ml-3">Gmail Add-on Simulator</span></h1>
                <p className="text-text-secondary mt-1">A simulation of how contextual add-on scopes would work inside Gmail.</p>
            </header>
            <div className="relative flex-grow bg-surface border-2 border-dashed border-border rounded-lg p-6 flex items-center justify-center">
                {isComposeOpen && <ComposeModal />}
                <div className="w-full max-w-4xl h-full bg-white dark:bg-slate-800 rounded-xl shadow-2xl flex flex-col overflow-hidden">
                    {/* Header */}
                    <div className="flex-shrink-0 p-4 border-b border-border">
                        <h2 className="text-xl font-bold">{mockEmail.subject}</h2>
                        <div className="flex items-center gap-2 text-sm mt-2">
                             <img src="https://avatar.vercel.sh/alice" alt="Alice" className="w-8 h-8 rounded-full" />
                             <div>
                                <p className="font-semibold">{mockEmail.from.split('<')[0].trim()}</p>
                                <p className="text-text-secondary text-xs">to {mockEmail.to.split('<')[0].trim()}</p>
                             </div>
                        </div>
                    </div>
                    {/* Body */}
                    <div className="flex-grow p-4 overflow-y-auto">
                        <pre className="whitespace-pre-wrap font-sans text-sm">{mockEmail.body}</pre>
                    </div>
                    {/* Actions */}
                    <div className="flex-shrink-0 p-4 border-t border-border bg-gray-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div className="text-xs text-text-secondary">
                            <strong>Disclaimer:</strong> This is a simulation. The requested scopes allow this app to read the current email and compose replies <strong>if it were running inside Gmail.</strong>
                        </div>
                        <button onClick={handleGenerateReply} disabled={isGenerating} className="btn-primary flex items-center justify-center gap-2 px-4 py-2">
                           <SparklesIcon /> AI Reply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/IamPolicyGenerator.tsx': `import React, { useState, useCallback } from 'react';
import { generateIamPolicyStream } from '../../services/aiService.ts';
import { ShieldCheckIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const IamPolicyGenerator: React.FC = () => {
    const [description, setDescription] = useState('A user role that can read from S3 buckets but not write or delete.');
    const [platform, setPlatform] = useState<'aws' | 'gcp'>('aws');
    const [policy, setPolicy] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!description.trim()) {
            setError('Please provide a description.');
            return;
        }
        setIsLoading(true);
        setError('');
        setPolicy('');
        try {
            const stream = generateIamPolicyStream(description, platform);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setPolicy(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [description, platform]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <ShieldCheckIcon />
                    <span className="ml-3">IAM Policy Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate AWS or GCP IAM policies from a natural language description.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col gap-4">
                     <div>
                        <label htmlFor="platform" className="text-sm font-medium mb-2 block">Cloud Platform</label>
                        <div className="flex gap-2 p-1 bg-surface rounded-lg border">
                            <button onClick={() => setPlatform('aws')} className={\`flex-1 py-2 rounded-md text-sm \${platform === 'aws' ? 'bg-primary text-text-on-primary' : ''}\`}>AWS</button>
                            <button onClick={() => setPlatform('gcp')} className={\`flex-1 py-2 rounded-md text-sm \${platform === 'gcp' ? 'bg-primary text-text-on-primary' : ''}\`}>GCP</button>
                        </div>
                    </div>
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="description" className="text-sm font-medium mb-2">Describe the desired permissions</label>
                        <textarea id="description" value={description} onChange={e => setDescription(e.target.value)} className="flex-grow p-2 bg-surface border rounded text-sm"/>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-3">{isLoading ? <LoadingSpinner/> : 'Generate Policy'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Generated Policy (JSON)</label>
                    <div className="flex-grow p-1 bg-background border rounded overflow-auto">
                        {isLoading && !policy && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {policy && <MarkdownRenderer content={policy} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/IamPolicyVisualizer.tsx': `import React, { useState, useCallback, useMemo } from 'react';
import { testIamPermissions } from '../../services/gcpService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { GcpIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

type SimulationStatus = 'idle' | 'running' | 'completed' | 'error';
type NodeStatus = 'neutral' | 'pending' | 'success' | 'fail' | 'partial';

interface ResourceNode {
    id: string; // The full resource name
    name: string;
    type: 'project' | 'bucket' | 'instance' | 'unknown';
    status: NodeStatus;
    results?: { permission: string; granted: boolean }[];
}

const COMMON_ROLES = {
    'Viewer': ['resourcemanager.projects.get', 'storage.objects.list', 'compute.instances.list'],
    'Editor': ['storage.objects.create', 'storage.objects.delete', 'compute.instances.start', 'compute.instances.stop'],
    'Storage Object Admin': ['storage.objects.create', 'storage.objects.delete', 'storage.objects.get', 'storage.objects.list', 'storage.objects.update'],
};

const getResourceType = (resourceId: string): ResourceNode['type'] => {
    if (resourceId.includes('/projects/')) return 'project';
    if (resourceId.includes('/b/')) return 'bucket';
    if (resourceId.includes('/instances/')) return 'instance';
    return 'unknown';
};

export const IamPolicyVisualizer: React.FC = () => {
    const { state } = useGlobalState();
    const [resources, setResources] = useState<ResourceNode[]>([]);
    const [newResource, setNewResource] = useState('//cloudresourcemanager.googleapis.com/projects/your-gcp-project-id');
    const [permissions, setPermissions] = useState('storage.objects.get\\nstorage.objects.create');
    const [simulationStatus, setSimulationStatus] = useState<SimulationStatus>('idle');
    const [error, setError] = useState('');
    const [selectedNode, setSelectedNode] = useState<ResourceNode | null>(null);

    const permissionList = useMemo(() => permissions.split('\\n').map(p => p.trim()).filter(Boolean), [permissions]);

    const handleAddResource = () => {
        if (newResource.trim() && !resources.find(r => r.id === newResource)) {
            setResources(prev => [...prev, {
                id: newResource,
                name: newResource.split('/').pop() || newResource,
                type: getResourceType(newResource),
                status: 'neutral',
            }]);
            setNewResource('');
        }
    };

    const handleRunSimulation = useCallback(async () => {
        if (!state.user) {
            setError('You must be signed in to run a simulation.');
            return;
        }
        if (resources.length === 0 || permissionList.length === 0) {
            setError('Please add at least one resource and one permission.');
            return;
        }

        setSimulationStatus('running');
        setError('');
        setSelectedNode(null);
        setResources(r => r.map(res => ({ ...res, status: 'pending', results: [] })));

        const promises = resources.map(resource =>
            testIamPermissions(resource.id, permissionList)
                .then(result => ({ id: resource.id, success: true, data: result }))
                .catch(err => ({ id: resource.id, success: false, error: err }))
        );

        const results = await Promise.allSettled(promises);

        setResources(prevResources => prevResources.map(resource => {
            const result: any = results.find((r: any) => r.value?.id === resource.id);
            if (!result || !result.value.success) {
                return { ...resource, status: 'fail' as NodeStatus };
            }
            
            const grantedPermissions = result.value.data.permissions || [];
            const permissionResults = permissionList.map(p => ({ permission: p, granted: grantedPermissions.includes(p) }));
            const allGranted = permissionResults.every(r => r.granted);
            const noneGranted = permissionResults.every(r => !r.granted);

            let status: NodeStatus = 'partial';
            if (allGranted) status = 'success';
            if (noneGranted) status = 'fail';

            return { ...resource, status, results: permissionResults };
        }));

        setSimulationStatus('completed');

    }, [resources, permissionList, state.user]);
    
    const nodeColorClass: Record<NodeStatus, string> = {
        neutral: 'border-slate-600',
        pending: 'border-yellow-500 animate-pulse',
        success: 'border-green-500',
        fail: 'border-red-500',
        partial: 'border-orange-500',
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary bg-background">
            {selectedNode && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center" onClick={() => setSelectedNode(null)}>
                    <div className="bg-surface rounded-lg shadow-xl p-6 w-full max-w-lg animate-pop-in" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold truncate">{selectedNode.name}</h3>
                        <p className="text-xs text-text-secondary font-mono mb-4">{selectedNode.id}</p>
                        <ul className="space-y-2 max-h-96 overflow-y-auto">
                            {selectedNode.results?.map(res => (
                                <li key={res.permission} className={\`flex items-center justify-between p-2 rounded text-sm \${res.granted ? 'bg-green-500/10' : 'bg-red-500/10'}\`}>
                                    <span className="font-mono">{res.permission}</span>
                                    <span className={\`font-bold \${res.granted ? 'text-green-500' : 'text-red-500'}\`}>{res.granted ? 'GRANTED' : 'DENIED'}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            )}
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><GcpIcon /><span className="ml-3">GCP IAM Policy Visualizer</span></h1><p className="text-text-secondary mt-1">Visually test and audit GCP IAM permissions in real-time across your resources.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <aside className="lg:col-span-1 bg-surface p-4 rounded-lg border border-border flex flex-col gap-4">
                    <h3 className="text-xl font-bold">Simulation Controls</h3>
                    <div><label className="text-sm font-semibold">1. Add Resource</label><div className="flex gap-1 mt-1"><input value={newResource} onChange={e => setNewResource(e.target.value)} placeholder="Full GCP resource name..." className="flex-grow p-2 bg-background border rounded text-xs" /><button onClick={handleAddResource} className="btn-primary px-3 text-sm">+</button></div></div>
                    <div><label className="text-sm font-semibold">2. Define Permission Set</label><select onChange={e => setPermissions(COMMON_ROLES[e.target.value as keyof typeof COMMON_ROLES]?.join('\\n') || '')} className="w-full mt-1 p-2 bg-background border rounded text-xs mb-1"><option>Load common role...</option>{Object.keys(COMMON_ROLES).map(r => <option key={r}>{r}</option>)}</select><textarea value={permissions} onChange={e => setPermissions(e.target.value)} placeholder="One permission per line..." className="w-full h-32 p-2 bg-background border rounded text-xs font-mono"/></div>
                    <button onClick={handleRunSimulation} disabled={simulationStatus === 'running'} className="btn-primary py-3 flex items-center justify-center gap-2"><SparklesIcon /> {simulationStatus === 'running' ? 'Simulating...' : 'Run Simulation'}</button>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                </aside>
                <main className="lg:col-span-2 bg-gray-50 dark:bg-slate-900/50 rounded-lg p-4 border-2 border-dashed border-border overflow-auto relative">
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {resources.map(res => (
                            <div key={res.id} onClick={() => res.results && setSelectedNode(res)} className={\`p-4 bg-surface rounded-lg border-4 transition-colors duration-500 \${nodeColorClass[res.status]} \${res.results ? 'cursor-pointer hover:scale-105' : ''}\`}>
                                <h4 className="font-bold truncate">{res.name}</h4>
                                <p className="text-xs text-text-secondary capitalize">{res.type}</p>
                            </div>
                        ))}
                    </div>
                    {resources.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-text-secondary">Add resources to begin your simulation.</div>}
                </main>
            </div>
        </div>
    );
};`,
  'components/features/JsonTreeNavigator.tsx': `import React, { useState } from 'react';
import { FileCodeIcon } from '../icons.tsx';

interface JsonNodeProps {
    data: any;
    nodeKey: string;
    isRoot?: boolean;
}

const JsonNode: React.FC<JsonNodeProps> = ({ data, nodeKey, isRoot = false }) => {
    const [isOpen, setIsOpen] = useState(isRoot);
    const isObject = typeof data === 'object' && data !== null;

    const toggleOpen = () => setIsOpen(!isOpen);

    if (!isObject) {
        return (
            <div className="ml-4 pl-4 border-l border-border">
                <span className="text-purple-700">{nodeKey}: </span>
                <span className={typeof data === 'string' ? 'text-green-700' : 'text-orange-700'}>
                    {typeof data === 'string' ? \`"\${data}"\` : String(data)}
                </span>
            </div>
        );
    }

    const entries = Object.entries(data);
    const bracket = Array.isArray(data) ? '[]' : '{}';

    return (
        <div className={\`ml-4 \${!isRoot ? 'pl-4 border-l border-border' : ''}\`}>
            <button onClick={toggleOpen} className="flex items-center cursor-pointer hover:bg-gray-100 rounded px-1">
                <span className={\`transform transition-transform \${isOpen ? 'rotate-90' : 'rotate-0'}\`}>▶</span>
                <span className="ml-1 text-purple-700">{nodeKey}:</span>
                <span className="ml-2 text-text-secondary">{bracket[0]}</span>
                {!isOpen && <span className="text-text-secondary">...{bracket[1]}</span>}
            </button>
            {isOpen && (
                <div>
                    {entries.map(([key, value]) => (
                        <JsonNode key={key} nodeKey={key} data={value} />
                    ))}
                    <div className="text-text-secondary ml-4">{bracket[1]}</div>
                </div>
            )}
        </div>
    );
};

export const JsonTreeNavigator: React.FC<{ initialData?: object }> = ({ initialData }) => {
    const defaultJson = '{\\n  "id": "devcore-001",\\n  "active": true,\\n  "features": [\\n    "ai-explainer",\\n    "api-tester"\\n  ],\\n  "config": {\\n    "theme": "dark",\\n    "version": 1\\n  }\\n}';
    const [jsonInput, setJsonInput] = useState(initialData ? JSON.stringify(initialData, null, 2) : defaultJson);
    const [parsedData, setParsedData] = useState<any>(() => {
        try {
            return JSON.parse(jsonInput);
        } catch {
            return null;
        }
    });
    const [error, setError] = useState('');

    const parseJson = (input: string) => {
        try {
            const parsed = JSON.parse(input);
            setParsedData(parsed);
            setError('');
        } catch (e) {
            if (e instanceof Error) setError(e.message);
            setParsedData(null);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        setJsonInput(e.target.value);
        parseJson(e.target.value);
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <FileCodeIcon />
                    <span className="ml-3">JSON Tree Navigator</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your JSON data to visualize it as a collapsible tree.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col h-2/5 min-h-[200px]">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={handleInputChange}
                        className={\`flex-grow p-4 bg-surface border \${error ? 'border-red-500' : 'border-border'} rounded-md resize-y font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none\`}
                    />
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Tree View</label>
                    <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto font-mono text-sm">
                        {parsedData ? <JsonNode data={parsedData} nodeKey="root" isRoot /> : <div className="text-text-secondary">Enter valid JSON to view</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/LogicFlowBuilder.tsx': `import React, { useState, useRef, useMemo, useCallback } from 'react';
import { ALL_FEATURES } from './index.ts';
import { FEATURE_TAXONOMY } from '../../services/taxonomyService.ts';
import { generatePipelineCode } from '../../services/aiService.ts';
import type { Feature } from '../../types.ts';
import { MapIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

interface Node {
    id: number;
    featureId: string;
    x: number;
    y: number;
}

interface Link {
    from: number;
    to: number;
}

const featuresMap = new Map(ALL_FEATURES.map(f => [f.id, f]));
const taxonomyMap = new Map(FEATURE_TAXONOMY.map(f => [f.id, f]));

const FeaturePaletteItem: React.FC<{ feature: Feature, onDragStart: (e: React.DragEvent, featureId: string) => void }> = ({ feature, onDragStart }) => (
    <div
        draggable
        onDragStart={e => onDragStart(e, feature.id)}
        className="p-3 rounded-md bg-gray-50 border border-border flex items-center gap-3 cursor-grab hover:bg-gray-100 transition-colors"
    >
        <div className="text-primary flex-shrink-0">{feature.icon}</div>
        <div>
            <h4 className="font-bold text-sm text-text-primary">{feature.name}</h4>
            <p className="text-xs text-text-secondary">{feature.category}</p>
        </div>
    </div>
);

const NodeComponent: React.FC<{
    node: Node;
    feature: Feature;
    onMouseDown: (e: React.MouseEvent, id: number) => void;
    onLinkStart: (e: React.MouseEvent, id: number) => void;
    onLinkEnd: (e: React.MouseEvent, id: number) => void;
}> = ({ node, feature, onMouseDown, onLinkStart, onLinkEnd }) => (
    <div
        className="absolute w-52 bg-surface rounded-lg shadow-md border-2 border-border cursor-grab active:cursor-grabbing flex flex-col"
        style={{ left: node.x, top: node.y, transform: 'translate(-50%, -50%)' }}
        onMouseDown={e => onMouseDown(e, node.id)}
        onMouseUp={e => onLinkEnd(e, node.id)}
    >
        <div className="p-2 flex items-center gap-2 border-b border-border">
            <div className="w-5 h-5 text-primary">{feature.icon}</div>
            <span className="text-sm font-semibold truncate text-text-primary">{feature.name}</span>
        </div>
        <div className="relative p-3 text-xs text-text-secondary min-h-[40px] flex items-center justify-center">
            Workflow Node
            <div
                onMouseDown={e => onLinkStart(e, node.id)}
                className="absolute right-[-9px] top-1/2 -translate-y-1/2 w-4 h-4 bg-primary rounded-full border-2 border-surface cursor-crosshair hover:scale-125 transition-transform"
                title="Drag to connect"
            />
        </div>
    </div>
);

const SVGGrid: React.FC = React.memo(() => (
    <svg width="100%" height="100%" className="absolute inset-0">
        <defs>
            <pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(0, 0, 0, 0.05)" strokeWidth="0.5"/>
            </pattern>
            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                <rect width="50" height="50" fill="url(#smallGrid)"/>
                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0, 0, 0, 0.1)" strokeWidth="1"/>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#grid)" />
    </svg>
));

export const LogicFlowBuilder: React.FC = () => {
    const [nodes, setNodes] = useState<Node[]>([]);
    const [links, setLinks] = useState<Link[]>([]);
    const [draggingNode, setDraggingNode] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const [linking, setLinking] = useState<{ from: number; fromPos: { x: number; y: number }; toPos: { x: number; y: number } } | null>(null);
    const [generatedCode, setGeneratedCode] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);
    const canvasRef = useRef<HTMLDivElement>(null);
    
    const handleGenerateCode = useCallback(async () => {
        setIsGenerating(true);
        setGeneratedCode('');
        
        const sortedNodeIds: number[] = [];
        const inDegree = new Map<number, number>();
        nodes.forEach(node => inDegree.set(node.id, 0));
        links.forEach(link => inDegree.set(link.to, (inDegree.get(link.to) || 0) + 1));
        
        const queue = nodes.filter(node => inDegree.get(node.id) === 0).map(n => n.id);
        
        while(queue.length > 0) {
            const u = queue.shift()!;
            sortedNodeIds.push(u);
            links.filter(l => l.from === u).forEach(l => {
                inDegree.set(l.to, (inDegree.get(l.to) || 0) - 1);
                if(inDegree.get(l.to) === 0) queue.push(l.to);
            })
        }
        
        const flowDescription = sortedNodeIds.map((id, index) => {
            const node = nodes.find(n => n.id === id)!;
            const featureInfo = taxonomyMap.get(node.featureId);
            return \`Step \${index + 1}: Execute the '\${featureInfo?.name}' tool. Description: \${featureInfo?.description}. Inputs: \${featureInfo?.inputs}.\`;
        }).join('\\n');

        try {
            const code = await generatePipelineCode(flowDescription);
            setGeneratedCode(code);
        } catch (e) {
            setGeneratedCode(\`// Error generating code: \${e instanceof Error ? e.message : 'Unknown error'}\`);
        } finally {
            setIsGenerating(false);
        }

    }, [nodes, links]);

    const handleDragStart = (e: React.DragEvent, featureId: string) => {
        e.dataTransfer.setData('application/json', JSON.stringify({ featureId }));
    };

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault();
        if (!canvasRef.current) return;
        const { featureId } = JSON.parse(e.dataTransfer.getData('application/json'));
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const newNode: Node = {
            id: Date.now(),
            featureId,
            x: e.clientX - canvasRect.left,
            y: e.clientY - canvasRect.top,
        };
        setNodes(prev => [...prev, newNode]);
    };

    const handleNodeMouseDown = (e: React.MouseEvent, id: number) => {
        const node = nodes.find(n => n.id === id);
        if (!node || (e.target as HTMLElement).title === 'Drag to connect') return;
        const canvasRect = canvasRef.current!.getBoundingClientRect();
        setDraggingNode({ id, offsetX: e.clientX - canvasRect.left - node.x, offsetY: e.clientY - canvasRect.top - node.y });
    };

    const handleCanvasMouseMove = (e: React.MouseEvent) => {
        if (!canvasRef.current) return;
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const mouseX = e.clientX - canvasRect.left;
        const mouseY = e.clientY - canvasRect.top;

        if (draggingNode) {
            setNodes(nodes.map(n => n.id === draggingNode.id ? { ...n, x: mouseX - draggingNode.offsetX, y: mouseY - draggingNode.offsetY } : n));
        }
        if (linking) {
            setLinking({ ...linking, toPos: { x: mouseX, y: mouseY } });
        }
    };

    const handleCanvasMouseUp = () => {
        setDraggingNode(null);
        setLinking(null);
    };

    const handleLinkStart = (e: React.MouseEvent, id: number) => {
        e.stopPropagation();
        const fromNode = nodes.find(n => n.id === id);
        if (!fromNode) return;
        setLinking({ from: id, fromPos: { x: fromNode.x, y: fromNode.y }, toPos: { x: fromNode.x, y: fromNode.y } });
    };

    const handleLinkEnd = (e: React.MouseEvent, id: number) => {
        e.stopPropagation();
        if (linking && linking.from !== id) {
            setLinks(prev => [...prev, { from: linking.from, to: id }]);
        }
        setLinking(null);
    };

    const nodePositions = useMemo(() => new Map(nodes.map(n => [n.id, { x: n.x, y: n.y }])), [nodes]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-start">
                <div>
                    <h1 className="text-3xl font-bold flex items-center"><MapIcon /><span className="ml-3">Logic Flow Builder</span></h1>
                    <p className="text-text-secondary mt-1">Visually build application logic flows and generate pipeline code.</p>
                </div>
                <button onClick={handleGenerateCode} disabled={isGenerating || nodes.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                    <SparklesIcon /> {isGenerating ? 'Generating...' : 'Generate Code'}
                </button>
            </header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-72 flex-shrink-0 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <h3 className="font-bold mb-3 text-lg">Features</h3>
                    <div className="flex-grow overflow-y-auto space-y-3 pr-2">
                        {ALL_FEATURES.map(feature => <FeaturePaletteItem key={feature.id} feature={feature} onDragStart={handleDragStart} />)}
                    </div>
                </aside>
                <main
                    ref={canvasRef}
                    className="flex-grow relative bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                    onDrop={handleDrop}
                    onDragOver={e => e.preventDefault()}
                    onMouseMove={handleCanvasMouseMove}
                    onMouseUp={handleCanvasMouseUp}
                    onMouseLeave={handleCanvasMouseUp}
                >
                    <SVGGrid />
                    <svg width="100%" height="100%" className="absolute inset-0 pointer-events-none">
                        {links.map((link, i) => {
                            const fromNode = nodePositions.get(link.from);
                            const toNode = nodePositions.get(link.to);
                            if (!fromNode || !toNode) return null;
                            return <line key={i} x1={fromNode.x} y1={fromNode.y} x2={toNode.x} y2={toNode.y} stroke="var(--color-primary)" strokeWidth="2" markerEnd="url(#arrow)" />;
                        })}
                        {linking && <line x1={linking.fromPos.x} y1={linking.fromPos.y} x2={linking.toPos.x} y2={linking.toPos.y} stroke="var(--color-primary)" strokeWidth="2" strokeDasharray="5,5" />}
                        <defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="var(--color-primary)" /></marker></defs>
                    </svg>
                    {nodes.map(node => {
                        const feature = featuresMap.get(node.featureId);
                        return feature ? <NodeComponent key={node.id} node={node} feature={feature} onMouseDown={handleNodeMouseDown} onLinkStart={handleLinkStart} onLinkEnd={handleLinkEnd} /> : null;
                    })}
                </main>
            </div>
            {(isGenerating || generatedCode) && (
                <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center" onClick={() => setGeneratedCode('')}>
                    <div className="w-full max-w-3xl h-3/4 bg-surface border border-border rounded-lg shadow-2xl p-6 flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Generated Pipeline Code</h2>
                            <button onClick={() => setGeneratedCode('')}><XMarkIcon/></button>
                        </div>
                        <div className="flex-grow bg-background border border-border rounded-md overflow-auto">
                            {isGenerating && !generatedCode ? <div className="flex justify-center items-center h-full"><LoadingSpinner /></div> : <MarkdownRenderer content={'\`\`\`javascript\\n' + generatedCode + '\\n\`\`\`'} />}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};`,
  'components/features/MarkdownSlides.tsx': `

import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';
import { marked } from 'marked';
import { PhotoIcon } from '../icons.tsx';

const exampleMarkdown = \`# Slide 1: Welcome

This is a slide deck generated from Markdown.

- Use standard markdown syntax
- Like lists, headers, and **bold** text.

---

# Slide 2: Features

Navigate using the buttons below.

\\\`\\\`\\\`javascript
console.log("Code blocks work too!");
\\\`\\\`\\\`

---

# Slide 3: The End

Easy to create and present.
\`;

export const MarkdownSlides: React.FC = () => {
    const [markdown, setMarkdown] = useState(exampleMarkdown);
    const [currentSlide, setCurrentSlide] = useState(0);
    const [slideHtml, setSlideHtml] = useState<string | TrustedHTML>('');
    const presentationRef = useRef<HTMLDivElement>(null);

    const slides = useMemo(() => markdown.split(/^-{3,}\\s*\$/m), [markdown]);

    useEffect(() => {
        const parse = async () => {
            const currentSlideContent = slides[currentSlide] || '';
            const html = await marked.parse(currentSlideContent);
            setSlideHtml(html);
        };
        parse();
    }, [slides, currentSlide]);

    const goToNext = useCallback(() => setCurrentSlide(s => Math.min(s + 1, slides.length - 1)), [slides.length]);
    const goToPrev = useCallback(() => setCurrentSlide(s => Math.max(s - 1, 0)), []);

    const handleFullscreen = () => {
        presentationRef.current?.requestFullscreen();
    };
    
    useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
            if (document.fullscreenElement === presentationRef.current) {
                if (e.key === 'ArrowRight' || e.key === ' ') goToNext();
                if (e.key === 'ArrowLeft') goToPrev();
            }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
    }, [goToNext, goToPrev]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">Markdown to Slides</span></h1>
                <p className="text-text-secondary mt-1">Write markdown, present it as a slideshow. Use '---' to separate slides.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                     <label htmlFor="md-input" className="text-sm font-medium text-text-secondary mb-2">Markdown Editor</label>
                     <textarea id="md-input" value={markdown} onChange={e => setMarkdown(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                </div>
                 <div ref={presentationRef} className="flex flex-col h-full bg-surface fullscreen:bg-background border border-border rounded-md">
                    <div className="flex-shrink-0 flex justify-end items-center p-2 border-b border-border gap-2">
                        <button onClick={handleFullscreen} className="px-3 py-1 bg-gray-100 dark:bg-slate-700 rounded-md text-xs hover:bg-gray-200 dark:hover:bg-slate-600">Fullscreen</button>
                    </div>
                    <div className="relative flex-grow flex flex-col justify-center items-center p-8 overflow-y-auto">
                        <div className="prose prose-lg max-w-none w-full" dangerouslySetInnerHTML={{ __html: slideHtml }} />
                         <button onClick={goToPrev} disabled={currentSlide === 0} className="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-gray-200/50 dark:bg-slate-700/50 rounded-full disabled:opacity-30 hover:bg-gray-300/50 dark:hover:bg-slate-600/50">◀</button>
                         <button onClick={goToNext} disabled={currentSlide === slides.length - 1} className="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-gray-200/50 dark:bg-slate-700/50 rounded-full disabled:opacity-30 hover:bg-gray-300/50 dark:hover:bg-slate-600/50">▶</button>
                         <div className="absolute bottom-4 right-4 text-xs bg-black/50 px-2 py-1 rounded-md text-white">
                            {currentSlide + 1} / {slides.length}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/MetaTagEditor.tsx': `import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon } from '../icons.tsx';

interface MetaData {
    title: string;
    description: string;
    image: string;
    url: string;
}

const SocialCardPreview: React.FC<{ meta: MetaData }> = ({ meta }) => (
    <div className="w-full max-w-md mx-auto bg-surface border border-border rounded-2xl overflow-hidden shadow-lg">
        <div className="h-52 bg-gray-100 flex items-center justify-center">
            {meta.image ? <img src={meta.image} alt="Preview" className="w-full h-full object-cover" onError={(e) => e.currentTarget.style.display='none'}/> : <span className="text-text-secondary">Image Preview</span>}
        </div>
        <div className="p-4">
            <p className="text-xs text-text-secondary truncate">{new URL(meta.url || 'https://example.com').hostname}</p>
            <h3 className="font-bold text-text-primary truncate mt-1">{meta.title || 'Your Title Here'}</h3>
            <p className="text-sm text-text-secondary mt-1 line-clamp-2">{meta.description || 'A concise description of your content will appear here.'}</p>
        </div>
    </div>
);

export const MetaTagEditor: React.FC = () => {
    const [meta, setMeta] = useState<MetaData>({
        title: 'DevCore AI Toolkit', description: 'The ultimate toolkit for modern developers, powered by Gemini.',
        image: 'https://storage.googleapis.com/maker-studio-project-images-prod/programming_power_on_a_laptop_3a8f0bb1_39a9_4c2b_81f0_a74551480f2c.png',
        url: 'https://devcore.example.com'
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        setMeta({ ...meta, [e.target.name]: e.target.value });
    };

    const generatedHtml = useMemo(() => {
        return \`<!-- Primary Meta Tags -->
<title>\${meta.title}</title>
<meta name="title" content="\${meta.title}" />
<meta name="description" content="\${meta.description}" />
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="\${meta.url}" />
<meta property="og:title" content="\${meta.title}" />
<meta property="og:description" content="\${meta.description}" />
<meta property="og:image" content="\${meta.image}" />
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="\${meta.url}" />
<meta property="twitter:title" content="\${meta.title}" />
<meta property="twitter:description" content="\${meta.description}" />
<meta property="twitter:image" content="\${meta.image}" />\`;
    }, [meta]);
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">Meta Tag Editor</span></h1><p className="text-text-secondary mt-1">Generate SEO & social media meta tags with a live preview.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 min-h-0">
                <div className="xl:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Metadata</h3>
                    <div><label className="block text-sm">Title</label><input type="text" name="title" value={meta.title} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Description</label><input type="text" name="description" value={meta.description} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Canonical URL</label><input type="text" name="url" value={meta.url} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Social Image URL</label><input type="text" name="image" value={meta.image} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                </div>
                <div className="xl:col-span-1 flex flex-col">
                     <label className="text-sm font-medium text-text-secondary mb-2">Generated HTML</label>
                     <div className="relative flex-grow"><pre className="w-full h-full bg-background p-4 rounded-md text-primary text-sm overflow-auto">{generatedHtml}</pre><button onClick={() => navigator.clipboard.writeText(generatedHtml)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                </div>
                 <div className="hidden xl:flex flex-col items-center justify-center">
                    <label className="text-sm font-medium text-text-secondary mb-2">Live Preview</label>
                    <SocialCardPreview meta={meta} />
                </div>
            </div>
        </div>
    );
};`,
  'components/features/NetworkVisualizer.tsx': `import React, { useState, useEffect, useMemo } from 'react';
import { ChartBarIcon } from '../icons.tsx';

type SortKey = 'name' | 'initiatorType' | 'transferSize' | 'duration';
type SortDirection = 'asc' | 'desc';

const SummaryCard: React.FC<{ title: string, value: string | number }> = ({ title, value }) => (
    <div className="bg-surface border border-border p-3 rounded-lg text-center">
        <p className="text-xs text-text-secondary">{title}</p>
        <p className="text-xl font-bold text-text-primary">{value}</p>
    </div>
);

export const NetworkVisualizer: React.FC = () => {
    const [requests, setRequests] = useState<PerformanceResourceTiming[]>([]);
    const [sortKey, setSortKey] = useState<SortKey>('duration');
    const [sortDirection, setSortDirection] = useState<SortDirection>('desc');

    useEffect(() => {
        const entries = performance.getEntriesByType("resource") as PerformanceResourceTiming[];
        setRequests(entries);
    }, []);
    
    const sortedRequests = useMemo(() => {
        return [...requests].sort((a, b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }, [requests, sortKey, sortDirection]);

    const { totalSize, totalDuration, maxDuration } = useMemo(() => {
        const totalSize = requests.reduce((acc, req) => acc + req.transferSize, 0);
        const maxFinish = Math.max(...requests.map(r => r.startTime + r.duration), 0);
        return { totalSize, totalDuration: maxFinish, maxDuration: Math.max(...requests.map(r => r.duration), 0) };
    }, [requests]);

    const handleSort = (key: SortKey) => {
        setSortDirection(sortKey === key && sortDirection === 'desc' ? 'asc' : 'desc');
        setSortKey(key);
    };
    
    const formatBytes = (bytes: number) => {
        if (bytes === 0) return '0 B';
        const k = 1024; const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    };

    const SortableHeader: React.FC<{ skey: SortKey, label: string; className?: string }> = ({ skey, label, className }) => (
        <th onClick={() => handleSort(skey)} className={\`p-2 text-left cursor-pointer hover:bg-gray-100 \${className}\`}>
            {label} {sortKey === skey && (sortDirection === 'asc' ? '▲' : '▼')}
        </th>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><ChartBarIcon /><span className="ml-3">Network Visualizer</span></h1><p className="text-text-secondary mt-1">Inspect network resources with a summary and waterfall chart.</p></header>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <SummaryCard title="Total Requests" value={requests.length} />
                <SummaryCard title="Total Transferred" value={formatBytes(totalSize)} />
                <SummaryCard title="Finish Time" value={\`\${totalDuration.toFixed(0)}ms\`} />
                <SummaryCard title="Longest Request" value={\`\${maxDuration.toFixed(0)}ms\`} />
            </div>
            <div className="flex-grow overflow-auto bg-surface rounded-lg border border-border">
                <table className="w-full text-sm text-left table-fixed">
                    <thead className="sticky top-0 bg-surface z-10"><tr className="border-b border-border">
                        <SortableHeader skey="name" label="Name" className="w-2/5"/>
                        <SortableHeader skey="initiatorType" label="Type" className="w-1/5" />
                        <SortableHeader skey="transferSize" label="Size" className="w-1/5"/>
                        <SortableHeader skey="duration" label="Time / Waterfall" className="w-1/5"/>
                    </tr></thead>
                    <tbody>{sortedRequests.map((req, i) => (<tr key={i} className="border-b border-border hover:bg-gray-50">
                        <td className="p-2 text-primary truncate" title={req.name}>{req.name.split('/').pop()}</td>
                        <td className="p-2">{req.initiatorType}</td>
                        <td className="p-2">{formatBytes(req.transferSize)}</td>
                        <td className="p-2"><div className="flex items-center">
                            <span className="w-12">{req.duration.toFixed(0)}ms</span>
                            <div className="flex-grow h-4 bg-gray-200 rounded overflow-hidden">
                                <div className="h-4 bg-primary rounded" style={{ marginLeft: \`\${(req.startTime / totalDuration) * 100}%\`, width: \`\${(req.duration / totalDuration) * 100}%\` }} title={\`Start: \${req.startTime.toFixed(0)}ms\`}></div>
                            </div>
                        </div></td>
                    </tr>))}</tbody>
                </table>
            </div>
        </div>
    );
};`,
  'components/features/OneClickRefactor.tsx': `import React, { useState, useCallback } from 'react';
import * as Diff from 'diff';
import { applySpecificRefactor, refactorForPerformance, refactorForReadability, generateJsDoc, convertToFunctionalComponent } from '../../services/aiService.ts';
import { SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

type RefactorAction = 'readability' | 'performance' | 'jsdoc' | 'functional' | 'custom';

const exampleCode = \`const MyComponent = ({ data }) => {
  // A less readable component
  let transformedData = [];
  for (let i = 0; i < data.length; i++) {
    if (data[i].value > 50) {
      let item = { ...data[i], status: 'high' };
      transformedData.push(item);
    }
  }
  return (
    <div>
      {transformedData.map(d => <p key={d.id}>{d.name}</p>)}
    </div>
  );
}\`;

const DiffViewer: React.FC<{ oldCode: string, newCode: string }> = ({ oldCode, newCode }) => {
    const diff = Diff.diffLines(oldCode, newCode);

    return (
        <pre className="whitespace-pre-wrap font-mono text-xs">
            {diff.map((part, index) => {
                const color = part.added ? 'bg-green-500/20' : part.removed ? 'bg-red-500/20' : 'bg-transparent';
                return <div key={index} className={color}>{part.value}</div>;
            })}
        </pre>
    );
};


export const OneClickRefactor: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [refactoredCode, setRefactoredCode] = useState('');
    const [loadingAction, setLoadingAction] = useState<RefactorAction | null>(null);

    const handleRefactor = useCallback(async (action: RefactorAction) => {
        if (!code.trim()) return;
        setLoadingAction(action);
        setRefactoredCode('');

        let stream;
        switch(action) {
            case 'readability':
                stream = refactorForReadability(code);
                break;
            case 'performance':
                stream = refactorForPerformance(code);
                break;
            case 'jsdoc':
                stream = generateJsDoc(code);
                break;
            case 'functional':
                stream = convertToFunctionalComponent(code);
                break;
            default:
                setLoadingAction(null);
                return;
        }

        try {
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setRefactoredCode(fullResponse.replace(/^\`\`\`(?:\\w+\\n)?/, '').replace(/\`\`\`\$/, ''));
            }
        } catch (e) {
            console.error(e);
            setRefactoredCode(\`// Error during refactoring: \${e instanceof Error ? e.message : 'Unknown error'}\`);
        } finally {
            setLoadingAction(null);
        }
    }, [code]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <SparklesIcon />
                    <span className="ml-3">One-Click Refactor</span>
                </h1>
                <p className="text-text-secondary mt-1">Apply common refactoring patterns to your code with a single click.</p>
            </header>
            <div className="flex items-center justify-center flex-wrap gap-2 mb-4 p-4 bg-surface rounded-lg border border-border">
                <button onClick={() => handleRefactor('readability')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'readability' ? <LoadingSpinner/> : 'Improve Readability'}</button>
                <button onClick={() => handleRefactor('performance')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'performance' ? <LoadingSpinner/> : 'Boost Performance'}</button>
                <button onClick={() => handleRefactor('jsdoc')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'jsdoc' ? <LoadingSpinner/> : 'Add JSDoc'}</button>
                <button onClick={() => handleRefactor('functional')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'functional' ? <LoadingSpinner/> : 'To Functional Component'}</button>
            </div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Original Code</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                </div>
                 <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Refactored Code</label>
                    <div className="flex-grow p-2 bg-background border rounded overflow-auto">
                        {loadingAction ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : <DiffViewer oldCode={code} newCode={refactoredCode} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/PerformanceProfiler.tsx': `import React, { useState, useCallback } from 'react';
import { analyzePerformanceTrace } from '../../services/index.ts';
import { startTracing, stopTracing, TraceEntry } from '../../services/profiling/performanceService.ts';
import { parseViteStats, BundleStatsNode } from '../../services/profiling/bundleAnalyzer.ts';
import { ChartBarIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const FlameChart: React.FC<{ trace: TraceEntry[] }> = ({ trace }) => {
    if (trace.length === 0) return <p className="text-text-secondary">No trace data collected.</p>;
    const maxTime = Math.max(...trace.map(t => t.startTime + t.duration));
    return (
        <div className="space-y-1 font-mono text-xs">
            {trace.filter(t => t.entryType === 'measure').map((entry, i) => (
                <div key={i} className="group relative h-6 bg-primary/20 rounded">
                    <div className="h-full bg-primary" style={{ marginLeft: \`\${(entry.startTime / maxTime) * 100}%\`, width: \`\${(entry.duration / maxTime) * 100}%\` }}></div>
                    <div className="absolute inset-0 px-2 flex items-center text-primary font-bold">{entry.name} ({entry.duration.toFixed(1)}ms)</div>
                </div>
            ))}
        </div>
    );
};

export const PerformanceProfiler: React.FC = () => {
    const [activeTab, setActiveTab] = useState<'runtime' | 'bundle'>('runtime');
    const [isTracing, setIsTracing] = useState(false);
    const [trace, setTrace] = useState<TraceEntry[]>([]);
    const [bundleStats, setBundleStats] = useState<string>('');
    const [bundleTree, setBundleTree] = useState<BundleStatsNode | null>(null);
    const [isLoadingAi, setIsLoadingAi] = useState(false);
    const [aiAnalysis, setAiAnalysis] = useState('');

    const handleTraceToggle = () => {
        if (isTracing) {
            const collectedTrace = stopTracing();
            setTrace(collectedTrace);
            setIsTracing(false);
        } else {
            setTrace([]);
            startTracing();
            setIsTracing(true);
        }
    };

    const handleAnalyzeBundle = () => {
        try {
            setBundleTree(parseViteStats(bundleStats));
        } catch (e) {
            alert(e instanceof Error ? e.message : 'Parsing failed.');
        }
    };
    
    const handleAiAnalysis = async () => {
        const dataToAnalyze = activeTab === 'runtime' ? trace : bundleTree;
        if (!dataToAnalyze || (Array.isArray(dataToAnalyze) && dataToAnalyze.length === 0)) {
            alert('No data to analyze.');
            return;
        }
        setIsLoadingAi(true);
        setAiAnalysis('');
        try {
            const analysis = await analyzePerformanceTrace(dataToAnalyze);
            setAiAnalysis(analysis);
        } catch (e) {
            setAiAnalysis('Error getting analysis from AI.');
        } finally {
            setIsLoadingAi(false);
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><ChartBarIcon /><span className="ml-3">AI Performance Profiler</span></h1><p className="text-text-secondary mt-1">Analyze runtime performance and bundle sizes with AI insights.</p></header>
            <div className="flex border-b border-border mb-4"><button onClick={() => setActiveTab('runtime')} className={\`px-4 py-2 text-sm \${activeTab === 'runtime' ? 'border-b-2 border-primary' : ''}\`}>Runtime Performance</button><button onClick={() => setActiveTab('bundle')} className={\`px-4 py-2 text-sm \${activeTab === 'bundle' ? 'border-b-2 border-primary' : ''}\`}>Bundle Analysis</button></div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    {activeTab === 'runtime' ? (
                        <>
                            <button onClick={handleTraceToggle} className="btn-primary mb-4 py-2">{isTracing ? 'Stop Tracing' : 'Start Tracing'}</button>
                            <div className="flex-grow overflow-y-auto"><FlameChart trace={trace} /></div>
                        </>
                    ) : (
                         <>
                            <textarea value={bundleStats} onChange={e => setBundleStats(e.target.value)} placeholder="Paste your stats.json content here" className="w-full h-48 p-2 bg-background border rounded font-mono text-xs mb-2"/>
                            <button onClick={handleAnalyzeBundle} className="btn-primary py-2">Analyze Bundle</button>
                            <div className="flex-grow overflow-y-auto mt-2">
                                <pre className="text-xs">{bundleTree ? JSON.stringify(bundleTree, null, 2) : 'Analysis will appear here.'}</pre>
                            </div>
                        </>
                    )}
                </div>
                 <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <button onClick={handleAiAnalysis} disabled={isLoadingAi} className="btn-primary flex items-center justify-center gap-2 py-2 mb-4"><SparklesIcon />{isLoadingAi ? 'Analyzing...' : 'Get AI Optimization Suggestions'}</button>
                    <div className="flex-grow bg-background border border-border rounded p-2 overflow-y-auto">
                        {isLoadingAi ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : <MarkdownRenderer content={aiAnalysis} />}
                    </div>
                 </div>
            </div>
        </div>
    );
};`,
  'components/features/PrGenerator.tsx': `// This feature is an alias for the more comprehensively named AiPullRequestAssistant.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { AiPullRequestAssistant as PrGenerator } from './AiPullRequestAssistant.tsx';`,
  'components/features/PrSummaryGenerator.tsx': `// This feature is an alias for the more comprehensively named AiPullRequestAssistant.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { AiPullRequestAssistant as PrSummaryGenerator } from './AiPullRequestAssistant.tsx';`,
  'components/features/ProjectExplorer.tsx': `import React, { useState, useEffect, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useOctokit } from '../../contexts/OctokitContext.tsx';
import { getRepos, getRepoTree, getFileContent, commitFiles } from '../../services/githubService.ts';
import { generateCommitMessageStream } from '../../services/index.ts';
import type { Repo, FileNode } from '../../types.ts';
import { FolderIcon, DocumentIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import * as Diff from 'diff';

const FileTree: React.FC<{ node: FileNode, onFileSelect: (path: string, name: string) => void, activePath: string | null }> = ({ node, onFileSelect, activePath }) => {
    const [isOpen, setIsOpen] = useState(true);

    if (node.type === 'file') {
        const isActive = activePath === node.path;
        return (
            <div
                className={\`flex items-center space-x-2 pl-4 py-1 cursor-pointer rounded \${isActive ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\`}
                onClick={() => onFileSelect(node.path, node.name)}
            >
                <DocumentIcon />
                <span>{node.name}</span>
            </div>
        );
    }

    return (
        <div>
            <div
                className="flex items-center space-x-2 py-1 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 rounded"
                onClick={() => setIsOpen(!isOpen)}
            >
                <div className={\`transform transition-transform \${isOpen ? 'rotate-90' : ''}\`}>▶</div>
                <FolderIcon />
                <span className="font-semibold">{node.name}</span>
            </div>
            {isOpen && node.children && (
                <div className="pl-4 border-l border-border ml-3">
                    {node.children.map(child => <FileTree key={child.path} node={child} onFileSelect={onFileSelect} activePath={activePath} />)}
                </div>
            )}
        </div>
    );
};

export const ProjectExplorer: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, selectedRepo, projectFiles } = state;
    const { addNotification } = useNotification();
    const { octokit, reinitialize } = useOctokit();
    const [repos, setRepos] = useState<Repo[]>([]);
    const [isLoading, setIsLoading] = useState<'repos' | 'tree' | 'file' | 'commit' | null>(null);
    const [error, setError] = useState('');
    const [activeFile, setActiveFile] = useState<{ path: string; name: string; originalContent: string; editedContent: string} | null>(null);
    
    const handleApiError = useCallback((err: any) => {
        if (err.status === 401) {
            dispatch({ type: 'SET_GITHUB_USER', payload: null });
            addNotification('GitHub token is invalid or expired. Please update it in the Connections Hub.', 'error');
            setError('GitHub authentication failed. Please update your token.');
        } else {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
        }
    }, [dispatch, addNotification]);
    
    useEffect(() => {
        if (!octokit && githubUser) {
            reinitialize();
        }
    }, [octokit, githubUser, reinitialize]);

    useEffect(() => {
        const loadRepos = async () => {
            if (user && githubUser && octokit) {
                setIsLoading('repos');
                setError('');
                try {
                    const userRepos = await getRepos(octokit);
                    setRepos(userRepos);
                } catch (err) {
                    handleApiError(err);
                } finally {
                    setIsLoading(null);
                }
            } else {
                setRepos([]);
            }
        };
        loadRepos();
    }, [user, githubUser, octokit, handleApiError]);

    const loadTree = useCallback(async (repoToLoad: { owner: { login: string }, name: string, full_name: string }) => {
        if (user && githubUser && octokit) {
            setIsLoading('tree');
            setError('');
            setActiveFile(null);
            try {
                const tree = await getRepoTree(octokit, repoToLoad.owner.login, repoToLoad.name);
                dispatch({ type: 'LOAD_PROJECT_FILES', payload: tree });
            } catch (err) {
                handleApiError(err);
            } finally {
                setIsLoading(null);
            }
        }
    }, [user, githubUser, octokit, dispatch, handleApiError]);

    // Re-fetches the tree if a repo is selected from a previous session
    useEffect(() => {
        if (selectedRepo && octokit && (!projectFiles || projectFiles.name !== selectedRepo.repo)) {
             loadTree({
                name: selectedRepo.repo,
                full_name: selectedRepo.full_name,
                owner: { login: selectedRepo.owner }
            });
        }
    }, [selectedRepo, projectFiles, octokit, loadTree]);

    const handleFileSelect = async (path: string, name: string) => {
        if (!selectedRepo || !octokit) return;
        setIsLoading('file');
        try {
            const content = await getFileContent(octokit, selectedRepo.owner, selectedRepo.repo, path);
            setActiveFile({ path, name, originalContent: content, editedContent: content });
        } catch (err) {
            handleApiError(err);
        } finally {
            setIsLoading(null);
        }
    };

    const handleCommit = async () => {
        if (!activeFile || !selectedRepo || !octokit || activeFile.originalContent === activeFile.editedContent) return;

        setIsLoading('commit');
        setError('');
        try {
            const diff = Diff.createPatch(activeFile.path, activeFile.originalContent, activeFile.editedContent);
            
            const stream = generateCommitMessageStream(diff);
            let commitMessage = '';
            for await (const chunk of stream) { commitMessage += chunk; }
            
            const finalMessage = window.prompt("Confirm or edit commit message:", commitMessage);
            if (!finalMessage) {
                setIsLoading(null);
                return;
            }

            await commitFiles(
                octokit,
                selectedRepo.owner,
                selectedRepo.repo,
                [{ path: activeFile.path, content: activeFile.editedContent }],
                finalMessage
            );
            
            addNotification(\`Successfully committed to \${selectedRepo.repo}\`, 'success');
            setActiveFile(prev => prev ? { ...prev, originalContent: prev.editedContent } : null);

        } catch (err) {
            handleApiError(err);
        } finally {
            setIsLoading(null);
        }
    };
    
    if (!user) {
        return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Please Sign In</h2>
                <p>Sign in to explore your repositories.</p>
            </div>
        );
    }
    
    if (!githubUser) {
         return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Connect to GitHub</h2>
                <p>Please go to the "Connections" tab and provide a Personal Access Token to explore your repositories.</p>
            </div>
        );
    }

    const hasChanges = activeFile ? activeFile.originalContent !== activeFile.editedContent : false;

    return (
        <div className="h-full flex flex-col text-text-primary">
            <header className="p-4 border-b border-border flex-shrink-0">
                <h1 className="text-xl font-bold flex items-center"><FolderIcon /><span className="ml-3">Project Explorer</span></h1>
                <div className="mt-2">
                    <select
                        value={selectedRepo?.full_name ?? ''}
                        onChange={e => {
                            const repo = repos.find(r => r.full_name === e.target.value);
                            if (repo) {
                                dispatch({ type: 'SET_SELECTED_REPO', payload: { owner: repo.owner.login, repo: repo.name, full_name: repo.full_name, name: repo.name } });
                            }
                        }}
                        className="w-full p-2 bg-surface border border-border rounded-md text-sm"
                    >
                        <option value="" disabled>{isLoading === 'repos' ? 'Loading...' : 'Select a repository'}</option>
                        {repos.map(r => <option key={r.id} value={r.full_name}>{r.full_name}</option>)}
                    </select>
                </div>
                {error && <p className="text-red-500 text-xs mt-2">{error}</p>}
            </header>
            <div className="flex-grow flex min-h-0">
                <aside className="w-1/3 bg-background border-r border-border p-4 overflow-y-auto">
                    {isLoading === 'tree' && <div className="flex justify-center"><LoadingSpinner /></div>}
                    {projectFiles && <FileTree node={projectFiles} onFileSelect={handleFileSelect} activePath={activeFile?.path ?? null} />}
                </aside>
                <main className="flex-1 bg-surface flex flex-col">
                     <div className="flex justify-between items-center p-2 border-b border-border bg-gray-50 dark:bg-slate-800">
                        <span className="text-sm font-semibold">{activeFile?.name || 'No file selected'}</span>
                        <button onClick={handleCommit} disabled={!hasChanges || isLoading === 'commit'} className="btn-primary px-4 py-1 text-sm flex items-center justify-center min-w-[100px]">
                           {isLoading === 'commit' ? <LoadingSpinner/> : 'Commit'}
                        </button>
                     </div>
                     {isLoading === 'file' ? <div className="flex items-center justify-center h-full"><LoadingSpinner /></div> :
                        <textarea 
                            value={activeFile?.editedContent ?? 'Select a file to view its content.'}
                            onChange={e => setActiveFile(prev => prev ? { ...prev, editedContent: e.target.value } : null)}
                            disabled={!activeFile}
                            className="w-full h-full p-4 text-sm font-mono bg-transparent resize-none focus:outline-none"
                        />
                    }
                </main>
            </div>
        </div>
    );
};`,
  'components/features/ProjectMoodboard.tsx': `import React, { useState } from 'react';
import { PhotoIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';

interface MoodboardItem {
    id: number;
    text: string;
    x: number;
    y: number;
    color: string;
}

const colors = ['bg-yellow-200', 'bg-green-200', 'bg-blue-200', 'bg-pink-200', 'bg-purple-200', 'bg-orange-200'];
const textColors = ['text-yellow-800', 'text-green-800', 'text-blue-800', 'text-pink-800', 'text-purple-800', 'text-orange-800'];

export const ProjectMoodboard: React.FC = () => {
    const [items, setItems] = useLocalStorage<MoodboardItem[]>('devcore_moodboard_items', []);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);

    const addItem = () => {
        const newItem: MoodboardItem = {
            id: Date.now(),
            text: 'New Idea',
            x: 50,
            y: 50,
            color: colors[items.length % colors.length],
        };
        setItems([...items, newItem]);
    };
    
    const deleteItem = (id: number, e: React.MouseEvent) => {
        e.stopPropagation();
        setItems(items.filter((n) => n.id !== id));
    };

    const updateItem = (id: number, updates: Partial<MoodboardItem>) => {
        setItems(items.map((n) => n.id === id ? { ...n, ...updates } : n));
    };

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        if ((e.target as HTMLElement).tagName === 'TEXTAREA') return;
        const noteElement = e.currentTarget;
        const rect = noteElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging) return;
        const boardRect = e.currentTarget.getBoundingClientRect();
        updateItem(dragging.id, {
            x: e.clientX - dragging.offsetX - boardRect.left,
            y: e.clientY - dragging.offsetY - boardRect.top
        });
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                 <div>
                    <h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">Project Moodboard</span></h1>
                    <p className="text-text-secondary mt-1">A visual space to gather ideas, images, and notes.</p>
                </div>
                <button onClick={addItem} className="btn-primary px-6 py-2">Add Item</button>
            </header>
            <div
                className="relative flex-grow bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}
            >
                {items.map((item) => (
                    <div
                        key={item.id}
                        className={\`group absolute w-48 h-48 p-2 flex flex-col shadow-lg cursor-grab active:cursor-grabbing rounded-md transition-transform duration-100 border border-black/20 \${item.color} \${textColors[colors.indexOf(item.color)]}\`}
                        style={{ top: item.y, left: item.x, transform: dragging?.id === item.id ? 'scale(1.05)' : 'scale(1)' }}
                        onMouseDown={e => onMouseDown(e, item.id)}
                    >
                        <button onClick={(e) => deleteItem(item.id, e)} className="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-gray-700 text-white font-bold text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500 transition-all">&times;</button>
                        <textarea
                            value={item.text}
                            onChange={(e) => updateItem(item.id, { text: e.target.value })}
                            className="w-full h-full bg-transparent resize-none focus:outline-none font-medium p-1"
                        />
                    </div>
                ))}
            </div>
        </div>
    );
};`,
  'components/features/PromptCraftPad.tsx': `import React, { useState, useEffect, useMemo } from 'react';
import { SparklesIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';

interface Prompt {
    id: number;
    name: string;
    text: string;
}

export const PromptCraftPad: React.FC = () => {
    const [prompts, setPrompts] = useLocalStorage<Prompt[]>('devcore_prompts', [
        { id: 1, name: 'React Component Generator', text: 'Generate a React component named {name} that {description}. Style it with Tailwind CSS.'}
    ]);
    const [activePrompt, setActivePrompt] = useState<Prompt | null>(prompts[0] || null);
    const [editingId, setEditingId] = useState<number | null>(null);
    const [tempName, setTempName] = useState('');
    const [variables, setVariables] = useState<Record<string, string>>({});

    const variableNames = useMemo(() => {
        if (!activePrompt) return [];
        return [...activePrompt.text.matchAll(/\\{(\\w+)\\}/g)].map(match => match[1]);
    }, [activePrompt]);

    const renderedPrompt = useMemo(() => {
        if (!activePrompt) return '';
        return variableNames.reduce((acc, varName) => {
            return acc.replace(new RegExp(\`\\\\{\${varName}\\\\}\`, 'g'), variables[varName] || \`{\${varName}}\`);
        }, activePrompt.text);
    }, [activePrompt, variables, variableNames]);
    
    useEffect(() => {
        if(!activePrompt && prompts.length > 0) setActivePrompt(prompts[0]);
        if (activePrompt) setActivePrompt(prompts.find((p: Prompt) => p.id === activePrompt.id) || null);
    }, [prompts, activePrompt]);

    const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        if (!activePrompt) return;
        const updatedPrompt = { ...activePrompt, text: e.target.value };
        setPrompts(prompts.map((p: Prompt) => p.id === updatedPrompt.id ? updatedPrompt : p));
    };
    
    const handleNameUpdate = (id: number, newName: string) => {
        setPrompts(prompts.map((p: Prompt) => p.id === id ? {...p, name: newName} : p));
        setEditingId(null);
    };

    const handleAddNew = () => {
        const newPrompt = { id: Date.now(), name: 'New Untitled Prompt', text: '' };
        setPrompts([...prompts, newPrompt]);
        setActivePrompt(newPrompt);
    };
    
    const handleDelete = (id: number) => {
        setPrompts(prompts.filter((p: Prompt) => p.id !== id));
        if(activePrompt?.id === id) setActivePrompt(prompts.length > 1 ? prompts[0] : null);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><SparklesIcon /><span className="ml-3">Prompt Craft Pad</span></h1><p className="text-text-secondary mt-1">Create, save, and manage your favorite AI prompts.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-1/3 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <h3 className="font-bold mb-2">My Prompts</h3>
                    <ul className="space-y-2 flex-grow overflow-y-auto">{prompts.map((p: Prompt) => (<li key={p.id} className="group flex items-center justify-between"><div className={\`w-full text-left rounded-md \${activePrompt?.id === p.id ? 'bg-primary/10' : ''}\`}><button onClick={() => setActivePrompt(p)} onDoubleClick={() => {setEditingId(p.id); setTempName(p.name);}} className={\`w-full text-left px-3 py-2 \${activePrompt?.id === p.id ? 'text-primary' : 'hover:bg-gray-100'}\`}> {editingId === p.id ? <input autoFocus value={tempName} onChange={e => setTempName(e.target.value)} onBlur={() => handleNameUpdate(p.id, tempName)} onKeyDown={e => e.key === 'Enter' && handleNameUpdate(p.id, tempName)} className="bg-gray-100 text-text-primary w-full"/> : p.name} </button></div><button onClick={() => handleDelete(p.id)} className="ml-2 p-1 text-text-secondary hover:text-red-500 opacity-0 group-hover:opacity-100">&times;</button></li>))}</ul>
                    <div className="mt-4 pt-4 border-t border-border"><button onClick={handleAddNew} className="btn-primary w-full text-sm py-2">Add New Prompt</button></div>
                </aside>
                <main className="w-2/3 flex flex-col gap-4">
                    {activePrompt ? (<>
                        <textarea value={activePrompt.text} onChange={handleTextChange} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                        {variableNames.length > 0 && <div className="flex-shrink-0 bg-surface border border-border p-4 rounded-lg"><h4 className="font-bold mb-2">Test Variables</h4><div className="grid grid-cols-2 gap-2">{variableNames.map(v => (<div key={v}><label className="text-xs">{v}</label><input type="text" value={variables[v] || ''} onChange={e => setVariables({...variables, [v]: e.target.value})} className="w-full bg-background border border-border px-2 py-1 rounded text-sm"/></div>))}</div><h4 className="font-bold mt-4 mb-2">Live Preview</h4><p className="text-sm p-2 bg-background rounded border border-border">{renderedPrompt}</p></div>}
                    </>) : (<div className="flex-grow flex items-center justify-center bg-background rounded-lg text-text-secondary border border-border">Select a prompt or create a new one.</div>)}
                </main>
            </div>
        </div>
    );
};`,
  'components/features/PwaManifestEditor.tsx': `import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

interface ManifestData {
    name: string;
    short_name: string;
    start_url: string;
    scope: string;
    display: 'standalone' | 'fullscreen' | 'minimal-ui' | 'browser';
    orientation: 'any' | 'natural' | 'landscape' | 'portrait';
    background_color: string;
    theme_color: string;
}

const HomeScreenPreview: React.FC<{ manifest: ManifestData }> = ({ manifest }) => (
    <div className="w-full max-w-xs mx-auto flex flex-col items-center">
        <div className="w-72 h-[550px] bg-gray-800 rounded-[40px] border-[10px] border-black shadow-2xl p-4 flex flex-col">
            <div className="flex-shrink-0 h-6 flex justify-between items-center px-4">
                <span className="text-xs font-bold" style={{color: manifest.theme_color}}>9:41</span>
                <div className="w-16 h-4 bg-black rounded-full" />
                <span className="text-xs font-bold" style={{color: manifest.theme_color}}>100%</span>
            </div>
            <div className="flex-grow grid grid-cols-4 gap-4 p-4">
                <div className="flex flex-col items-center gap-1">
                    <div className="w-14 h-14 bg-white rounded-xl flex items-center justify-center text-3xl" style={{backgroundColor: manifest.background_color}}>
                        <span style={{color: manifest.theme_color}}>{manifest.short_name[0]}</span>
                    </div>
                    <p className="text-xs text-center text-white truncate w-full">{manifest.short_name}</p>
                </div>
            </div>
        </div>
         <p className="text-xs text-text-secondary mt-2 text-center">Home Screen Preview</p>
    </div>
);


export const PwaManifestEditor: React.FC = () => {
    const [manifest, setManifest] = useState<ManifestData>({
        name: 'DevCore Progressive Web App', short_name: 'DevCore', start_url: '/', scope: '/',
        display: 'standalone', orientation: 'any', background_color: '#F5F7FA', theme_color: '#0047AB',
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        setManifest({ ...manifest, [e.target.name]: e.target.value });
    };

    const generatedJson = useMemo(() => {
        const fullManifest = { ...manifest, icons: [{"src": "icon-192.png", "type": "image/png", "sizes": "192x192"}, {"src": "icon-512.png", "type": "image/png", "sizes": "512x512"}] };
        return JSON.stringify(fullManifest, null, 2);
    }, [manifest]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">PWA Manifest Editor</span></h1><p className="text-text-secondary mt-1">Configure and generate the \`manifest.json\` file for your PWA.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 min-h-0">
                <div className="xl:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Configuration</h3>
                    <div><label className="block text-sm">App Name</label><input type="text" name="name" value={manifest.name} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Short Name</label><input type="text" name="short_name" value={manifest.short_name} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Start URL</label><input type="text" name="start_url" value={manifest.start_url} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Scope</label><input type="text" name="scope" value={manifest.scope} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Display Mode</label><select name="display" value={manifest.display} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"><option>standalone</option><option>fullscreen</option><option>minimal-ui</option><option>browser</option></select></div>
                    <div><label className="block text-sm">Orientation</label><select name="orientation" value={manifest.orientation} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"><option>any</option><option>natural</option><option>landscape</option><option>portrait</option></select></div>
                     <div className="flex gap-4">
                        <div className="w-1/2"><label className="block text-sm">Background Color</label><input type="color" name="background_color" value={manifest.background_color} onChange={handleChange} className="w-full mt-1 h-10 rounded bg-background border border-border"/></div>
                        <div className="w-1/2"><label className="block text-sm">Theme Color</label><input type="color" name="theme_color" value={manifest.theme_color} onChange={handleChange} className="w-full mt-1 h-10 rounded bg-background border border-border"/></div>
                     </div>
                </div>
                <div className="xl:col-span-1 flex flex-col">
                    <div className="flex justify-between items-center mb-2">
                         <label className="text-sm font-medium text-text-secondary">Generated manifest.json</label>
                         <button onClick={() => downloadFile(generatedJson, 'manifest.json', 'application/json')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download
                        </button>
                    </div>
                     <div className="relative flex-grow"><pre className="w-full h-full bg-background p-4 rounded-md text-primary text-sm overflow-auto">{generatedJson}</pre></div>
                </div>
                <div className="hidden xl:flex flex-col items-center justify-center">
                    <label className="text-sm font-medium text-text-secondary mb-2">Live Preview</label>
                    <HomeScreenPreview manifest={manifest} />
                </div>
            </div>
        </div>
    );
};`,
  'components/features/RegexSandbox.tsx': `import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { generateRegExStream } from '../../services/aiService.ts';
import { BeakerIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const commonPatterns = [
    { name: 'Email', pattern: '/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}/g' },
    { name: 'URL', pattern: '/https?:\\\\/\\\\/(www\\\\.)?[-a-zA-Z0-9@:%._\\\\+~#=]{1,256}\\\\.[a-zA-Z0-9()]{1,6}\\\\b([-a-zA-Z0-9()@:%_\\\\+.~#?&//=]*)/g' },
    { name: 'IPv4 Address', pattern: '/((25[0-5]|(2[0-4]|1\\\\d|[1-9]|)\\\\d)\\\\.?\\\\b){4}/g' },
    { name: 'Date (YYYY-MM-DD)', pattern: '/\\\\d{4}-\\\\d{2}-\\\\d{2}/g' },
];

const CheatSheet = () => (
    <div className="bg-surface border border-border p-4 rounded-lg">
        <h3 className="text-lg font-bold mb-2">Regex Cheat Sheet</h3>
        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs font-mono">
            <p><span className="text-primary">.</span> - Any character</p>
            <p><span className="text-primary">\\d</span> - Any digit</p>
            <p><span className="text-primary">\\w</span> - Word character</p>
            <p><span className="text-primary">\\s</span> - Whitespace</p>
            <p><span className="text-primary">[abc]</span> - a, b, or c</p>
            <p><span className="text-primary">[^abc]</span> - Not a, b, or c</p>
            <p><span className="text-primary">*</span> - 0 or more</p>
            <p><span className="text-primary">+</span> - 1 or more</p>
            <p><span className="text-primary">?</span> - 0 or one</p>
            <p><span className="text-primary">^</span> - Start of string</p>
            <p><span className="text-primary">\$</span> - End of string</p>
            <p><span className="text-primary">\\b</span> - Word boundary</p>
        </div>
    </div>
);

export const RegexSandbox: React.FC<{ initialPrompt?: string }> = ({ initialPrompt }) => {
    const [pattern, setPattern] = useState<string>('/\\\\b([A-Z][a-z]+)\\\\s(\\\\w+)\\\\b/g');
    const [testString, setTestString] = useState<string>('The quick Brown Fox jumps over the Lazy Dog.');
    const [aiPrompt, setAiPrompt] = useState<string>(initialPrompt || 'find capitalized words and the word after');
    const [isAiLoading, setIsAiLoading] = useState<boolean>(false);

    const { matches, error } = useMemo(() => {
        try {
            const patternParts = pattern.match(/^\\/(.*)\\/([gimyus]*)\$/);
            if (!patternParts) return { matches: null, error: 'Invalid regex literal. Use /pattern/flags.' };
            const [, regexBody, regexFlags] = patternParts;
            const regex = new RegExp(regexBody, regexFlags);
            return { matches: [...testString.matchAll(regex)], error: null };
        } catch (e) { return { matches: null, error: e instanceof Error ? e.message : 'Unknown error.' }; }
    }, [pattern, testString]);
    
    const handleGenerateRegex = useCallback(async (p: string) => {
        if (!p) return;
        setIsAiLoading(true);
        try {
            const stream = generateRegExStream(p);
            let fullResponse = '';
            for await (const chunk of stream) { fullResponse += chunk; }
            setPattern(fullResponse.trim().replace(/^\`+|\`+\$/g, ''));
        } finally { setIsAiLoading(false); }
    }, []);

    useEffect(() => { if (initialPrompt) handleGenerateRegex(initialPrompt); }, [initialPrompt, handleGenerateRegex]);

    const highlightedString = useMemo(() => {
        if (!matches || matches.length === 0 || error) return testString;
        let lastIndex = 0;
        const parts: (string | JSX.Element)[] = [];
        matches.forEach((match, i) => {
            if (match.index === undefined) return;
            parts.push(testString.substring(lastIndex, match.index));
            parts.push(<mark key={i} className="bg-primary/20 text-primary rounded px-1">{match[0]}</mark>);
            lastIndex = match.index + match[0].length;
        });
        parts.push(testString.substring(lastIndex));
        return parts;
    }, [matches, testString, error]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><BeakerIcon /><span className="ml-3">RegEx Sandbox</span></h1><p className="text-text-secondary mt-1">Test your regular expressions and generate them with AI.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-2 flex flex-col gap-4">
                    <div className="flex gap-2"><input type="text" value={aiPrompt} onChange={(e) => setAiPrompt(e.target.value)} placeholder="Describe the pattern to find..." className="flex-grow px-3 py-1.5 rounded-md bg-surface border border-border text-sm focus:ring-2 focus:ring-primary" /><button onClick={() => handleGenerateRegex(aiPrompt)} disabled={isAiLoading} className="btn-primary px-4 py-1.5 flex items-center">{isAiLoading ? <LoadingSpinner/> : 'Generate'}</button></div>
                    <div><label htmlFor="regex-pattern" className="text-sm font-medium text-text-secondary">Regular Expression</label><input id="regex-pattern" type="text" value={pattern} onChange={(e) => setPattern(e.target.value)} className={\`w-full mt-1 px-3 py-2 rounded-md bg-surface border \${error ? 'border-red-500' : 'border-border'} font-mono text-sm focus:ring-2 focus:ring-primary\`} />{error && <p className="text-red-500 text-xs mt-1">{error}</p>}</div>
                    <div className="flex flex-col flex-grow min-h-0"><label htmlFor="test-string" className="text-sm font-medium text-text-secondary">Test String</label><textarea id="test-string" value={testString} onChange={(e) => setTestString(e.target.value)} className="w-full mt-1 p-3 rounded-md bg-surface border border-border font-mono text-sm resize-y h-32" /><div className="mt-2 p-3 bg-background rounded-md border border-border min-h-[50px] whitespace-pre-wrap">{highlightedString}</div></div>
                    <div className="flex-shrink-0"><h3 className="text-lg font-bold">Match Groups ({matches?.length || 0})</h3><div className="mt-2 p-2 bg-surface rounded-md overflow-y-auto max-h-48 font-mono text-xs border border-border">{matches && matches.length > 0 ? (matches.map((match, i) => (<details key={i} className="p-2 border-b border-border"><summary className="cursor-pointer text-green-700">Match {i + 1}: "{match[0]}"</summary><div className="pl-4 mt-1">{Array.from(match).map((group, gIndex) => <p key={gIndex} className="text-text-secondary">Group {gIndex}: <span className="text-amber-700">{String(group)}</span></p>)}</div></details>))) : (<p className="text-text-secondary text-sm p-2">No matches found.</p>)}</div></div>
                </div>
                <div className="lg:col-span-1 space-y-4">
                    <CheatSheet />
                    <div className="bg-surface border border-border p-4 rounded-lg">
                        <h3 className="text-lg font-bold mb-2">Common Patterns</h3>
                        <div className="flex flex-col items-start gap-2">
                            {commonPatterns.map(p => (
                                <button key={p.name} onClick={() => setPattern(p.pattern)} className="text-left text-sm text-primary hover:underline">
                                    {p.name}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/ResponsiveTester.tsx': `import React, { useState, useEffect } from 'react';
import { EyeIcon } from '../icons.tsx';

const devices = {
    'iPhone 12': { width: 390, height: 844 },
    'Pixel 5': { width: 393, height: 851 },
    'iPad Air': { width: 820, height: 1180 },
    'Surface Duo': { width: 540, height: 720 },
    'Laptop': { width: 1366, height: 768 },
    'Desktop': { width: 1920, height: 1080 },
    'Auto': { width: '100%', height: '100%' },
};

type DeviceName = keyof typeof devices;

export const ResponsiveTester: React.FC = () => {
    const [url, setUrl] = useState('https://react.dev');
    const [displayUrl, setDisplayUrl] = useState(url);
    const [size, setSize] = useState<{width: number | string, height: number | string}>(devices['Auto']);

    useEffect(() => {
        const handleResize = () => {
            if (size.width === '100%') {
                setSize({ width: '100%', height: '100%' });
            }
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, [size.width]);

    const handleUrlSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        setDisplayUrl(url.startsWith('http') ? url : \`https://\${url}\`);
    };

    const handleRotate = () => {
        if(typeof size.width === 'number' && typeof size.height === 'number') {
            setSize({ width: size.height, height: size.width });
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><EyeIcon /><span className="ml-3">Responsive Tester</span></h1><p className="text-text-secondary mt-1">Preview your web pages at different screen sizes.</p></header>
            <form onSubmit={handleUrlSubmit} className="flex items-center gap-2 mb-2">
                <input type="text" value={url} onChange={(e) => setUrl(e.target.value)} placeholder="https://example.com" className="flex-grow px-4 py-2 rounded-md bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none"/>
                <button type="submit" className="btn-primary px-6 py-2">Load</button>
            </form>
            <div className="bg-surface p-2 rounded-lg flex flex-wrap justify-center items-center gap-2 mb-4 border border-border">
                {Object.keys(devices).map(name => (
                    <button key={name} onClick={() => setSize(devices[name as DeviceName])} className={\`px-3 py-1 rounded-md text-sm \${JSON.stringify(size) === JSON.stringify(devices[name as DeviceName]) ? 'bg-primary/10 text-primary font-semibold' : 'hover:bg-gray-100'}\`}>{name}</button>
                ))}
                <div className="flex items-center gap-1 ml-4">
                    <input type="number" value={typeof size.width === 'number' ? size.width : ''} onChange={e => setSize({ ...size, width: Number(e.target.value) })} className="w-20 px-2 py-1 bg-gray-100 border border-border rounded-md text-sm"/>
                    <span className="text-sm text-text-secondary">x</span>
                    <input type="number" value={typeof size.height === 'number' ? size.height : ''} onChange={e => setSize({ ...size, height: Number(e.target.value) })} className="w-20 px-2 py-1 bg-gray-100 border border-border rounded-md text-sm"/>
                </div>
                 <button onClick={handleRotate} className="px-3 py-1 rounded-md text-sm hover:bg-gray-100" title="Rotate">🔄</button>
            </div>
            <div className="flex-grow bg-background rounded-lg p-4 overflow-auto border border-border">
                <iframe key={displayUrl} src={displayUrl} style={{ width: size.width, height: size.height }} className="bg-white border-4 border-gray-300 rounded-md transition-all duration-300 shadow-lg mx-auto" title="Responsive Preview"/>
            </div>
        </div>
    );
};`,
  'components/features/SassScssCompiler.tsx': `import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon } from '../icons.tsx';

const initialScss = \`\$primary-color: #0047AB;
\$font-size: 16px;

.container {
  padding: 20px;
  background-color: #f0f0f0;

  .title {
    color: \$primary-color;
    font-size: \$font-size * 1.5;

    &:hover {
      text-decoration: underline;
    }
  }
  
  > p {
    margin-top: 10px;
  }
}\`;

const escapeRegExp = (string: string): string => {
    // \$& means the whole matched string
    return string.replace(/[.*+?^\${}()|[\\]\\\\]/g, '\\\\\$&');
};

const compileScss = (scss: string): string => {
    try {
        let css = scss;
        css = css.replace(/\\/\\/.*\$/gm, '');
        
        const variables: Record<string, string> = {};
        css = css.replace(/\\\$([\\w-]+):\\s*(.*?);/g, (_, name, value) => {
            variables[name] = value.trim(); return '';
        });

        for (let i = 0; i < 5; i++) {
            Object.entries(variables).forEach(([name, value]) => {
                css = css.replace(new RegExp(\`\\\\\$\${escapeRegExp(name)}\`, 'g'), value);
            });
        }
        
        css = css.replace(/([\\d.]+)(px|rem|em|%)\\s*([*\\/])\\s*([\\d.]+)/g, (_, n1, unit, op, n2) => {
            const num1 = parseFloat(n1); const num2 = parseFloat(n2);
            const result = op === '*' ? num1 * num2 : num1 / num2;
            return \`\${result}\${unit}\`;
        });

        const processBlock = (block: string, parentSelector: string = ''): string => {
            let currentCss = '';
            let nestedCss = '';
            const properties = [];
            
            const regex = /((?:[\\w-:.#&>+~*\\s,]+|\\([^)]*\\))\\s*\\{[^{}]*\\})|((?:[\\w-]+\\s*:[^;]+;))/g;
            const content = block.substring(block.indexOf('{') + 1, block.lastIndexOf('}'));
            let match;
            while ((match = regex.exec(content)) !== null) {
                if (match[1]) {
                    const nestedSelector = match[1].substring(0, match[1].indexOf('{')).trim();
                    const fullSelector = nestedSelector.includes('&') ? nestedSelector.replace(/&/g, parentSelector) : \`\${parentSelector} \${nestedSelector}\`.trim();
                    nestedCss += processBlock(match[1], fullSelector);
                } else if (match[2]) {
                    properties.push(\`  \${match[2].trim()}\`);
                }
            }
            
            if (properties.length > 0) {
                currentCss = \`\${parentSelector} {\\n\${properties.join('\\n')}\\n}\\n\`;
            }

            return currentCss + nestedCss;
        };
        
        let result = processBlock(\`root{\${css}}\`, '').trim();
        return result.replace(/root\\s*\\{\\s*\\}/, '').trim();

    } catch(e) {
        console.error("SCSS Compilation Error:", e);
        return "/* Error compiling SCSS. Check console for details. */";
    }
};


export const SassScssCompiler: React.FC = () => {
    const [scss, setScss] = useState(initialScss);
    const compiledCss = useMemo(() => compileScss(scss), [scss]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center"><CodeBracketSquareIcon /><span className="ml-3">SASS/SCSS Compiler</span></h1>
                <p className="text-text-secondary mt-1">A real-time SASS/SCSS to CSS compiler.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="scss-input" className="text-sm font-medium text-text-secondary mb-2">SASS/SCSS Input</label>
                    <textarea id="scss-input" value={scss} onChange={(e) => setScss(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm text-pink-600" spellCheck="false" />
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Compiled CSS Output</label>
                    <pre className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto text-blue-700 font-mono text-sm whitespace-pre-wrap">{compiledCss}</pre>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/SchemaDesigner.tsx': `import React, { useState, useRef } from 'react';
import { MapIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

interface Column { id: number; name: string; type: string; }
interface Table { id: number; name: string; columns: Column[]; x: number; y: number; }

const exportToSQL = (tables: Table[]) => {
    return tables.map(table => {
        const columnsSQL = table.columns.map(col => \`  "\${col.name}" \${col.type.toUpperCase()}\`).join(',\\n');
        return \`CREATE TABLE "\${table.name}" (\\n\${columnsSQL}\\n);\`;
    }).join('\\n\\n');
};

export const SchemaDesigner: React.FC = () => {
    const [tables, setTables] = useState<Table[]>([
        { id: 1, name: 'users', columns: [{ id: 1, name: 'id', type: 'INTEGER PRIMARY KEY' }, {id: 2, name: 'username', type: 'VARCHAR(255)'}], x: 50, y: 50 },
        { id: 2, name: 'posts', columns: [{ id: 1, name: 'id', type: 'INTEGER PRIMARY KEY' }, {id: 2, name: 'user_id', type: 'INTEGER'}, {id: 3, name: 'content', type: 'TEXT'}], x: 300, y: 100 },
    ]);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const canvasRef = useRef<HTMLDivElement>(null);

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        const tableElement = e.currentTarget;
        const rect = tableElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging || !canvasRef.current) return;
        const canvasRect = canvasRef.current.getBoundingClientRect();
        setTables(tables.map(t => t.id === dragging.id ? { ...t, x: e.clientX - dragging.offsetX - canvasRect.left + canvasRef.current.scrollLeft, y: e.clientY - dragging.offsetY - canvasRect.top + canvasRef.current.scrollTop } : t));
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><MapIcon /><span className="ml-3">Schema Designer</span></h1><p className="text-text-secondary mt-1">Visually design your database schema with drag-and-drop.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <main ref={canvasRef} className="flex-grow relative bg-background rounded-lg border-2 border-dashed border-border overflow-auto" onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}>
                    {tables.map(table => (
                        <div key={table.id} className={\`absolute w-64 bg-surface rounded-lg shadow-xl border cursor-grab active:cursor-grabbing \${dragging?.id === table.id ? 'border-primary' : 'border-border'}\`} style={{ top: table.y, left: table.x }} onMouseDown={e => onMouseDown(e, table.id)}>
                            <h3 className="font-bold text-primary text-lg p-2 bg-gray-50 rounded-t-lg border-b border-border">{table.name}</h3>
                            <div className="p-2 space-y-1 font-mono text-xs">
                                {table.columns.map(col => (<div key={col.id} className="flex justify-between items-center"><span className="text-text-primary">{col.name}</span><span className="text-text-secondary">{col.type}</span></div>))}
                            </div>
                        </div>
                    ))}
                </main>
                <aside className="w-80 flex-shrink-0 flex flex-col gap-4">
                    <div className="flex flex-col gap-2">
                         <button onClick={() => downloadFile(JSON.stringify(tables, null, 2), 'schema.json', 'application/json')} className="flex-1 text-sm py-2 bg-gray-100 border border-border rounded-md flex items-center justify-center gap-2 hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download JSON
                        </button>
                         <button onClick={() => downloadFile(exportToSQL(tables), 'schema.sql', 'application/sql')} className="btn-primary flex-1 text-sm py-2 flex items-center justify-center gap-2">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download SQL
                         </button>
                    </div>
                    <div className="flex-grow bg-surface border border-border p-4 rounded-lg overflow-y-auto">
                        <h3 className="font-bold mb-2">Editor</h3>
                        <p className="text-xs text-text-secondary">Schema editing coming soon!</p>
                    </div>
                </aside>
            </div>
        </div>
    );
};`,
  'components/features/ScreenshotToComponent.tsx': `import React, { useState, useCallback, useRef } from 'react';
import { generateComponentFromImageStream } from '../../services/index.ts';
import { PhotoIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { fileToBase64, blobToDataURL, downloadFile } from '../../services/fileUtils.ts';

export const ScreenshotToComponent: React.FC = () => {
    const [previewImage, setPreviewImage] = useState<string | null>(null);
    const [rawCode, setRawCode] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleGenerate = async (base64Image: string) => {
        setIsLoading(true);
        setError('');
        setRawCode('');
        try {
            const stream = generateComponentFromImageStream(base64Image);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setRawCode(fullResponse.replace(/^\`\`\`(?:\\w+\\n)?/, '').replace(/\`\`\`\$/, ''));
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    };

    const processImageBlob = async (blob: Blob) => {
        try {
            const [dataUrl, base64Image] = await Promise.all([blobToDataURL(blob), fileToBase64(blob as File)]);
            setPreviewImage(dataUrl);
            handleGenerate(base64Image);
        } catch (e) {
            setError('Could not process the image.');
        }
    };
    
    const handlePaste = useCallback(async (event: React.ClipboardEvent) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) await processImageBlob(blob);
                return;
            }
        }
    }, []);

    const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (file) await processImageBlob(file);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">AI Screenshot-to-Component</span></h1><p className="text-text-secondary mt-1">Paste or upload a screenshot of a UI element to generate React/Tailwind code.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div onPaste={handlePaste} className="flex flex-col items-center justify-center bg-surface p-6 rounded-lg border-2 border-dashed border-border focus:outline-none focus:border-primary overflow-y-auto" tabIndex={0}>
                    {previewImage ? (<img src={previewImage} alt="Pasted content" className="max-w-full max-h-full object-contain rounded-md shadow-lg" />) : (<div className="text-center text-text-secondary">
                            <h2 className="text-xl font-bold text-text-primary">Paste an image here</h2>
                            <p className="mb-2">(Cmd/Ctrl + V)</p>
                            <p className="text-sm">or</p>
                            <button onClick={() => fileInputRef.current?.click()} className="mt-2 btn-primary px-4 py-2 text-sm">Upload File</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden"/>
                        </div>)}
                </div>
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Code</label>
                        {rawCode && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={() => navigator.clipboard.writeText(rawCode)} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy Code</button>
                                <button onClick={() => downloadFile(rawCode, 'Component.tsx', 'text/typescript')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-grow bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && (<div className="flex items-center justify-center h-full"><LoadingSpinner /></div>)}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {rawCode && !isLoading && <MarkdownRenderer content={\`\\\`\\\`\\\`tsx\\n\${rawCode}\\n\\\`\\\`\\\`\`} />}
                        {!isLoading && !rawCode && !error && (<div className="text-text-secondary h-full flex items-center justify-center">Generated component code will appear here.</div>)}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/SecurityScanner.tsx': `import React, { useState } from 'react';
import { analyzeCodeForVulnerabilities } from '../../services/aiService.ts';
import { runStaticScan, SecurityIssue } from '../../services/security/staticAnalysisService.ts';
import type { SecurityVulnerability } from '../../types.ts';
import { ShieldCheckIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \`function UserProfile({ user }) {
  // TODO: remove this temporary api key
  const API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx";
  const userContent = user.bio; // This might contain malicious scripts

  return (
    <div>
      <h2>{user.name}</h2>
      <div dangerouslySetInnerHTML={{ __html: userContent }} />
    </div>
  );
}\`;

export const SecurityScanner: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [localIssues, setLocalIssues] = useState<SecurityIssue[]>([]);
    const [aiIssues, setAiIssues] = useState<SecurityVulnerability[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleScan = async () => {
        if (!code.trim()) {
            setError('Please enter code to scan.');
            return;
        }
        setIsLoading(true);
        setError('');
        setLocalIssues([]);
        setAiIssues([]);
        try {
            // Run local scan first
            const staticIssues = runStaticScan(code);
            setLocalIssues(staticIssues);
            
            // Then run AI scan
            const geminiIssues = await analyzeCodeForVulnerabilities(code);
            setAiIssues(geminiIssues);

        } catch (err) {
            setError(err instanceof Error ? err.message : 'An error occurred during scanning.');
        } finally {
            setIsLoading(false);
        }
    };

    const SeverityBadge: React.FC<{ severity: string }> = ({ severity }) => {
        const colors: Record<string, string> = {
            'Critical': 'bg-red-500 text-white',
            'High': 'bg-red-400 text-white',
            'Medium': 'bg-yellow-400 text-yellow-900',
            'Low': 'bg-blue-400 text-white',
            'Informational': 'bg-gray-400 text-gray-900',
        };
        return <span className={\`px-2 py-0.5 text-xs font-bold rounded-full \${colors[severity] || 'bg-gray-300'}\`}>{severity}</span>
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><ShieldCheckIcon /><span className="ml-3">AI Security Co-Pilot</span></h1>
                <p className="text-text-secondary mt-1">Find vulnerabilities in your code with static analysis and AI.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm mb-2">Code to Scan</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="w-full flex-grow p-2 bg-surface border rounded font-mono text-xs" />
                    <button onClick={handleScan} disabled={isLoading} className="btn-primary w-full mt-4 py-2 flex justify-center items-center gap-2">{isLoading ? <LoadingSpinner/> : 'Scan Code'}</button>
                </div>
                <div className="flex flex-col bg-surface p-4 border rounded-lg">
                    <h3 className="text-lg font-bold mb-2">Scan Results</h3>
                    {error && <p className="text-red-500">{error}</p>}
                    <div className="flex-grow overflow-y-auto pr-2 space-y-4">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                        {!isLoading && localIssues.length === 0 && aiIssues.length === 0 && <p className="text-text-secondary text-center mt-8">No issues found. Run a scan to begin.</p>}
                        
                        {localIssues.length > 0 && <div>
                            <h4 className="font-semibold text-sm mb-1">Static Analysis Findings</h4>
                            {localIssues.map((issue, i) => <div key={\`local-\${i}\`} className="p-2 bg-background border rounded mb-2"><p className="font-bold flex items-center gap-2">{issue.type} <SeverityBadge severity={issue.severity} /></p><p className="text-xs">Line {issue.line}: {issue.description}</p></div>)}
                        </div>}

                         {aiIssues.length > 0 && <div>
                            <h4 className="font-semibold text-sm mb-1 flex items-center gap-1"><SparklesIcon/> AI-Powered Findings</h4>
                            {aiIssues.map((issue, i) => (
                                <details key={\`ai-\${i}\`} className="p-2 bg-background border rounded mb-2">
                                    <summary className="cursor-pointer font-bold flex items-center gap-2">{issue.vulnerability} <SeverityBadge severity={issue.severity} /></summary>
                                    <div className="mt-2 pt-2 border-t text-xs space-y-2">
                                        <p><strong>Description:</strong> {issue.description}</p>
                                        <p><strong>Mitigation:</strong> {issue.mitigation}</p>
                                        {issue.exploitSuggestion && (
                                            <div>
                                                <strong>Exploit Simulation:</strong>
                                                <div className="mt-1 p-2 bg-gray-50 rounded">
                                                     <MarkdownRenderer content={'\`\`\`bash\\n' + issue.exploitSuggestion + '\\n\`\`\`'}/>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </details>
                            ))}
                        </div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/SnippetVault.tsx': `import React, { useState, useEffect, useMemo } from 'react';
import { LockClosedIcon, SparklesIcon, TrashIcon, ClipboardDocumentIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';
import { enhanceSnippetStream, generateTagsForCode } from '../../services/aiService.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';

interface Snippet {
    id: number; name: string; code: string; language: string; tags: string[];
}

const langToExt: Record<string, string> = {
    javascript: 'js',
    typescript: 'ts',
    python: 'py',
    css: 'css',
    html: 'html',
    json: 'json',
    markdown: 'md',
    plaintext: 'txt',
};

export const SnippetVault: React.FC = () => {
    const [snippets, setSnippets] = useLocalStorage<Snippet[]>('devcore_snippets', [{ id: 1, name: 'React Hook Boilerplate', language: 'javascript', code: \`import { useState } from 'react';\\n\\nconst useCustomHook = () => {\\n  const [value, setValue] = useState(null);\\n  return { value, setValue };\\n};\`, tags: ['react', 'hook'] }]);
    const [activeSnippet, setActiveSnippet] = useState<Snippet | null>(null);
    const [isEnhancing, setIsEnhancing] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [isEditingName, setIsEditingName] = useState(false);
    const { addNotification } = useNotification();

    const filteredSnippets = useMemo(() => {
        if (!searchTerm) return snippets;
        const lowerSearch = searchTerm.toLowerCase();
        return snippets.filter((s: Snippet) => 
            s.name.toLowerCase().includes(lowerSearch) || 
            s.code.toLowerCase().includes(lowerSearch) ||
            (s.tags && s.tags.some(t => t.toLowerCase().includes(lowerSearch)))
        );
    }, [snippets, searchTerm]);

    useEffect(() => {
        if (!activeSnippet && filteredSnippets.length > 0) setActiveSnippet(filteredSnippets[0]);
        if (activeSnippet) setActiveSnippet(snippets.find((s: Snippet) => s.id === activeSnippet.id) || null);
    }, [snippets, activeSnippet, filteredSnippets]);

    const updateSnippet = (snippet: Snippet) => {
        setSnippets(snippets.map((s: Snippet) => s.id === snippet.id ? snippet : s));
        setActiveSnippet(snippet);
    };

    const handleEnhance = async () => {
        if (!activeSnippet) return;
        setIsEnhancing(true);
        try {
            const stream = enhanceSnippetStream(activeSnippet.code);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                updateSnippet({ ...activeSnippet, code: fullResponse.replace(/^\`\`\`(?:\\w+\\n)?/, '').replace(/\`\`\`\$/, '') });
            }
        } finally { setIsEnhancing(false); }
    };
    
    const handleAiTagging = async (snippet: Snippet) => {
        if (!snippet.code.trim()) return;
        try {
            const suggestedTags = await generateTagsForCode(snippet.code);
            const newTags = [...new Set([...(snippet.tags || []), ...suggestedTags])];
            updateSnippet({...snippet, tags: newTags});
            addNotification('AI tags added!', 'success');
        } catch(e) {
            console.error("AI tagging failed:", e);
            addNotification('AI tagging failed.', 'error');
        }
    };

    const handleAddNew = () => {
        const newSnippet: Snippet = { id: Date.now(), name: 'New Snippet', language: 'plaintext', code: '', tags: [] };
        setSnippets([...snippets, newSnippet]);
        setActiveSnippet(newSnippet);
    };
    
    const handleDelete = (id: number) => {
        setSnippets(snippets.filter((s: Snippet) => s.id !== id));
        if(activeSnippet?.id === id) setActiveSnippet(filteredSnippets.length > 1 ? filteredSnippets[0] : null);
    };
    
    const handleDownload = () => {
        if(!activeSnippet) return;
        const extension = langToExt[activeSnippet.language] || 'txt';
        const filename = \`\${activeSnippet.name.replace(/\\s/g, '_')}.\${extension}\`;
        downloadFile(activeSnippet.code, filename);
    }

    const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (activeSnippet) updateSnippet({...activeSnippet, name: e.target.value});
    };
    
    const handleTagsChange = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter' && activeSnippet) {
            const newTag = e.currentTarget.value.trim();
            if (newTag && !activeSnippet.tags.includes(newTag)) {
                updateSnippet({...activeSnippet, tags: [...(activeSnippet.tags ?? []), newTag]});
            }
            e.currentTarget.value = '';
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><LockClosedIcon /><span className="ml-3">Snippet Vault</span></h1><p className="text-text-secondary mt-1">Store, search, tag, and enhance your reusable code snippets with AI.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-1/3 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <input type="text" placeholder="Search snippets..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-3 py-1.5 mb-3 rounded-md bg-background border border-border text-sm"/>
                    <ul className="space-y-2 flex-grow overflow-y-auto pr-2">{filteredSnippets.map((s: Snippet) => (<li key={s.id} className="group flex items-center justify-between"><button onClick={() => setActiveSnippet(s)} className={\`w-full text-left px-3 py-2 rounded-md \${activeSnippet?.id === s.id ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\`}>{s.name}</button><div className="flex opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => {navigator.clipboard.writeText(s.code); addNotification("Copied snippet!", "success")}} className="ml-2 p-1 text-text-secondary hover:text-primary" title="Copy"><ClipboardDocumentIcon /></button><button onClick={() => handleDelete(s.id)} className="ml-2 p-1 text-text-secondary hover:text-red-500" title="Delete"><TrashIcon/></button></div></li>))}</ul>
                    <div className="mt-4 pt-4 border-t border-border"><button onClick={handleAddNew} className="btn-primary w-full text-sm py-2">Add New Snippet</button></div>
                </aside>
                <main className="w-2/3 flex flex-col">
                    {activeSnippet ? (<>
                        <div className="flex justify-between items-center mb-2">
                            {isEditingName ? <input type="text" value={activeSnippet.name} onChange={handleNameChange} onBlur={() => setIsEditingName(false)} autoFocus className="text-lg font-bold bg-gray-100 dark:bg-slate-700 rounded px-2"/> : <h3 onDoubleClick={() => setIsEditingName(true)} className="text-lg font-bold cursor-pointer">{activeSnippet.name}</h3>}
                            <div className="flex gap-2">
                                <button onClick={() => handleAiTagging(activeSnippet)} className="flex items-center gap-2 px-3 py-1 bg-teal-500/80 text-white font-bold text-xs rounded-md"><SparklesIcon /> AI Tag</button>
                                <button onClick={handleEnhance} disabled={isEnhancing} className="flex items-center gap-2 px-3 py-1 bg-purple-500/80 text-white font-bold text-xs rounded-md disabled:bg-gray-400"><SparklesIcon /> AI Enhance</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-slate-700 text-xs rounded-md"><ArrowDownTrayIcon className="w-4 h-4"/> Download</button>
                            </div>
                        </div>
                        <textarea value={activeSnippet.code} onChange={e => updateSnippet({...activeSnippet, code: e.target.value})} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                        <div className="mt-2 text-xs text-text-secondary">
                           <div className="flex items-center gap-2 flex-wrap">
                             <span className="font-bold">Tags:</span> {(activeSnippet.tags ?? []).map(t => <span key={t} className="bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded-full">{t}</span>)}
                             <input type="text" placeholder="+ Add tag" onKeyDown={handleTagsChange} className="bg-transparent border-b border-border focus:outline-none focus:border-primary w-24 text-xs px-1"/>
                           </div>
                        </div>
                    </>) : (<div className="flex-grow flex items-center justify-center bg-background border border-border rounded-lg text-text-secondary">Select a snippet or create a new one.</div>)}
                </main>
            </div>
        </div>
    );
};`,
  'components/features/SvgPathEditor.tsx': `import React, { useState, useRef } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const initialPath = "M 20 80 Q 100 20 180 80 T 340 80";

const parsePath = (d: string) => {
    const commands = d.match(/[a-df-z][^a-df-z]*/ig) || [];
    return commands.map((cmdStr, i) => {
        const command = cmdStr[0];
        const args = cmdStr.slice(1).trim().split(/[\\s,]+/).map(parseFloat).filter(n => !isNaN(n));
        const points = [];
        for (let j = 0; j < args.length; j += 2) {
            points.push({ x: args[j], y: args[j + 1] });
        }
        return { id: i, command, points };
    });
};

const buildPath = (parsed: any[]) => {
    return parsed.map(cmd => \`\${cmd.command} \${cmd.points.map((p:any) => \`\${p.x} \${p.y}\`).join(' ')}\`).join(' ');
};

export const SvgPathEditor: React.FC = () => {
    const [pathData, setPathData] = useState(initialPath);
    const svgRef = useRef<SVGSVGElement>(null);
    const [draggingPoint, setDraggingPoint] = useState<any>(null);
    const parsedPath = parsePath(pathData);

    const handleMouseDown = (e: React.MouseEvent, cmdIndex: number, pointIndex: number) => {
        e.stopPropagation();
        setDraggingPoint({ cmdIndex, pointIndex });
    };

    const handleMouseMove = (e: React.MouseEvent) => {
        if (!draggingPoint || !svgRef.current) return;
        const pt = new DOMPoint(e.clientX, e.clientY);
        const svgPoint = pt.matrixTransform(svgRef.current.getScreenCTM()?.inverse());
        
        const newParsedPath = parsedPath.map((cmd, cIdx) => {
            if (cIdx === draggingPoint.cmdIndex) {
                const newPoints = cmd.points.map((p, pIdx) => {
                    if (pIdx === draggingPoint.pointIndex) {
                        return { x: Math.round(svgPoint.x), y: Math.round(svgPoint.y) };
                    }
                    return p;
                });
                return { ...cmd, points: newPoints };
            }
            return cmd;
        });
        setPathData(buildPath(newParsedPath));
    };
    
    const handleMouseUp = () => setDraggingPoint(null);
    
    const handleAddPoint = (e: React.MouseEvent) => {
        if (!svgRef.current) return;
        const pt = new DOMPoint(e.clientX, e.clientY);
        const svgPoint = pt.matrixTransform(svgRef.current.getScreenCTM()?.inverse());
        const newPathData = \`\${pathData} L \${Math.round(svgPoint.x)} \${Math.round(svgPoint.y)}\`;
        setPathData(newPathData);
    };

    const handleDownload = () => {
        const svgContent = \`<svg viewBox="0 0 400 160" xmlns="http://www.w3.org/2000/svg">
  <path d="\${pathData}" stroke="black" fill="transparent" stroke-width="2"/>
</svg>\`;
        downloadFile(svgContent, 'path.svg', 'image/svg+xml');
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">SVG Path Editor</span></h1><p className="text-text-secondary mt-1">Visually create and manipulate SVG path data by dragging points.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full overflow-y-auto">
                    <div className="flex justify-between items-center mb-2">
                        <label htmlFor="path-input" className="text-sm font-medium text-text-secondary">Path Data (d attribute)</label>
                         <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download SVG
                        </button>
                    </div>
                    <textarea id="path-input" value={pathData} onChange={(e) => setPathData(e.target.value)} className="h-24 p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm text-primary" />
                     <div className="flex-grow mt-4 p-4 bg-surface border-2 border-dashed border-border rounded-md overflow-hidden flex items-center justify-center min-h-[200px]">
                        <svg ref={svgRef} viewBox="0 0 400 160" className="w-full h-full cursor-crosshair" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onDoubleClick={handleAddPoint}>
                           <rect width="400" height="160" fill="var(--color-background)" />
                            <path d={pathData} stroke="var(--color-primary)" fill="transparent" strokeWidth="2" />
                            {parsedPath.flatMap((cmd, cmdIndex) => 
                                cmd.points.map((p, pointIndex) => (
                                    <circle
                                        key={\`\${cmd.id}-\${pointIndex}\`}
                                        cx={p.x}
                                        cy={p.y}
                                        r="5"
                                        fill={cmd.command.toLowerCase() === 'c' || cmd.command.toLowerCase() === 'q' || cmd.command.toLowerCase() === 's' || cmd.command.toLowerCase() === 't' ? '#fde047' : '#f87171'}
                                        stroke="var(--color-surface)"
                                        strokeWidth="2"
                                        className="cursor-move hover:stroke-primary"
                                        onMouseDown={(e) => handleMouseDown(e, cmdIndex, pointIndex)}
                                    />
                                ))
                            )}
                        </svg>
                    </div>
                    <p className="text-xs text-center text-text-secondary mt-2">Double-click on the canvas to add a new point.</p>
                </div>
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-text-secondary mb-2">Parsed Commands</label>
                    <div className="flex-grow p-2 bg-background border border-border rounded-md overflow-y-auto font-mono text-xs space-y-2">
                        {parsedPath.map(cmd => (
                            <div key={cmd.id} className="p-2 bg-surface rounded">
                                <span className="font-bold text-amber-600">{cmd.command}</span>
                                <span className="text-text-secondary"> {cmd.points.map(p => \`(\${p.x},\${p.y})\`).join(' ')}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/TechDebtSonar.tsx': `import React, { useState, useCallback } from 'react';
import { detectCodeSmells } from '../../services/aiService.ts';
import type { CodeSmell } from '../../types.ts';
import { MagnifyingGlassIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const exampleCode = \`class DataProcessor {
    process(data) {
        // Long method with multiple responsibilities
        if (data.type === 'A') {
            const results = [];
            for (let i = 0; i < data.items.length; i++) {
                // complex logic
                const item = data.items[i];
                if(item.value > 100) {
                   results.push({ ...item, status: 'processed' });
                }
            }
            return results;
        } else {
            // Duplicated logic
            const results = [];
            for (let i = 0; i < data.items.length; i++) {
                const item = data.items[i];
                 if(item.value > 100) {
                   results.push({ ...item, status: 'processed_special' });
                }
            }
            return results;
        }
    }
}\`;

export const TechDebtSonar: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [smells, setSmells] = useState<CodeSmell[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleScan = useCallback(async () => {
        if (!code.trim()) {
            setError('Please provide code to scan.');
            return;
        }
        setIsLoading(true);
        setError('');
        setSmells([]);
        try {
            const result = await detectCodeSmells(code);
            setSmells(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [code]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <MagnifyingGlassIcon />
                    <span className="ml-3">Tech Debt Sonar</span>
                </h1>
                <p className="text-text-secondary mt-1">Scan code to find code smells and areas with high complexity.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Code to Analyze</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    <button onClick={handleScan} disabled={isLoading} className="btn-primary w-full mt-4 py-3">{isLoading ? <LoadingSpinner/> : 'Scan for Code Smells'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Detected Smells</label>
                    <div className="flex-grow p-2 bg-background border rounded overflow-auto">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {!isLoading && smells.length === 0 && <p className="text-text-secondary text-center pt-8">No smells detected, or scan not run.</p>}
                        {smells.length > 0 && (
                            <div className="space-y-3">
                                {smells.map((smell, i) => (
                                    <div key={i} className="p-3 bg-surface border border-border rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <h4 className="font-bold text-primary">{smell.smell}</h4>
                                            <span className="text-xs font-mono bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">Line: {smell.line}</span>
                                        </div>
                                        <p className="text-sm mt-1">{smell.explanation}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};
`,
  'components/features/TerraformGenerator.tsx': `import React, { useState, useCallback } from 'react';
import { generateTerraformConfig } from '../../services/index.ts';
import { CpuChipIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const TerraformGenerator: React.FC = () => {
    const [description, setDescription] = useState('An S3 bucket for static website hosting');
    const [cloud, setCloud] = useState<'aws' | 'gcp'>('aws');
    const [config, setConfig] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!description.trim()) {
            setError('Please provide a description.');
            return;
        }
        setIsLoading(true);
        setError('');
        setConfig('');
        try {
            // Context is stubbed for now but demonstrates future capability
            const context = 'User might have existing VPCs. Check before creating new ones.';
            const result = await generateTerraformConfig(cloud, description, context);
            setConfig(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate config.');
        } finally {
            setIsLoading(false);
        }
    }, [description, cloud]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><CpuChipIcon /><span className="ml-3">AI Terraform Generator</span></h1>
                <p className="text-text-secondary mt-1">Generate infrastructure-as-code from a description, with context from your cloud provider.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                 <div className="flex flex-col flex-1 min-h-0">
                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label className="block text-sm">Cloud Provider</label>
                            <select value={cloud} onChange={e => setCloud(e.target.value as 'aws' | 'gcp')} className="w-full mt-1 p-2 bg-surface border rounded">
                                <option value="aws">AWS</option>
                                <option value="gcp">GCP</option>
                            </select>
                        </div>
                        <div className="md:col-span-2">
                            <label className="block text-sm">Describe the infrastructure</label>
                            <input type="text" value={description} onChange={e => setDescription(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/>
                        </div>
                    </div>
                     <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center py-2"><SparklesIcon /> {isLoading ? 'Generating...' : 'Generate Configuration'}</button>
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Terraform (.tf)</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !config && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {config && <MarkdownRenderer content={config} />}
                         {!isLoading && !config && !error && <div className="text-text-secondary h-full flex items-center justify-center">Generated config will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/ThemeDesigner.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { SparklesIcon, ArrowDownTrayIcon, PhotoIcon } from '../icons.tsx';
import { generateSemanticTheme } from '../../services/index.ts';
import { fileToBase64 } from '../../services/fileUtils.ts';
import type { SemanticColorTheme, ColorTheme } from '../../types.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { useTheme } from '../../hooks/useTheme.ts';

const ColorDisplay: React.FC<{ name: string; color: { name: string; value: string; } }> = ({ name, color }) => (
    <div className="flex items-center justify-between p-2 bg-background rounded-md border border-border">
        <div className="flex items-center gap-3">
            <div className="w-6 h-6 rounded-full border border-border" style={{ backgroundColor: color.value }} />
            <div>
                <p className="text-sm font-semibold text-text-primary capitalize">{name}</p>
                <p className="text-xs text-text-secondary">{color.name}</p>
            </div>
        </div>
        <span className="font-mono text-sm text-text-secondary">{color.value}</span>
    </div>
);

const AccessibilityCheck: React.FC<{ name: string, check: { ratio: number; score: string; } }> = ({ name, check }) => {
    const scoreColor = check.score === 'AAA' ? 'text-green-600' : check.score === 'AA' ? 'text-emerald-600' : 'text-red-600';
    return (
        <div className="flex items-center justify-between p-2 bg-background rounded-md border border-border text-sm">
            <p className="text-text-secondary">{name}</p>
            <div className="flex items-center gap-2">
                <span className="font-mono">{check.ratio.toFixed(2)}</span>
                <span className={\`font-bold px-2 py-0.5 rounded-full text-xs \${scoreColor} \${scoreColor.replace('text-', 'bg-')}/10\`}>{check.score}</span>
            </div>
        </div>
    );
}

export const ThemeDesigner: React.FC = () => {
    const [theme, setTheme] = useState<SemanticColorTheme | null>(null);
    const [prompt, setPrompt] = useState('A calming, minimalist theme for a blog');
    const [image, setImage] = useState<{ base64: string, name: string } | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const [, , applyCustomTheme] = useTheme();

    const handleGenerate = useCallback(async () => {
        const textPart = { text: \`Generate a theme based on this description: "\${prompt}"\` };
        const imagePart = image ? { inlineData: { mimeType: 'image/png', data: image.base64 } } : null;
        const parts = imagePart ? [textPart, imagePart] : [textPart];

        setIsLoading(true); setError('');
        try {
            const newTheme = await generateSemanticTheme({ parts });
            setTheme(newTheme);
        } catch (err) {
            setError(err instanceof Error ? err.message : "An unknown error occurred.");
        } finally {
            setIsLoading(false);
        }
    }, [prompt, image]);
    
    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            const base64 = await fileToBase64(file);
            setImage({ base64, name: file.name });
            setPrompt(\`A theme based on the uploaded image: \${file.name}\`);
        }
    };
    
    useEffect(() => { handleGenerate(); }, []);

    const handleApplyTheme = () => {
        if (!theme) return;
        const colorsToApply: ColorTheme = {
            primary: theme.palette.primary.value,
            background: theme.theme.background.value,
            surface: theme.theme.surface.value,
            textPrimary: theme.theme.textPrimary.value,
            textSecondary: theme.theme.textSecondary.value,
            textOnPrimary: theme.theme.textOnPrimary.value,
            border: theme.theme.border.value,
        };
        applyCustomTheme(colorsToApply, theme.mode);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><SparklesIcon /><span className="ml-3">AI Theme Designer</span></h1>
                <p className="text-text-secondary mt-1">Generate a full design system from a description or image.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                <div className="md:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Describe or Upload</h3>
                    <textarea value={prompt} onChange={e => setPrompt(e.target.value)} className="p-2 bg-background border border-border rounded-md resize-none text-sm h-24" placeholder="e.g., A light, airy theme for a blog" />
                     <div className="relative border border-dashed border-border rounded-lg p-4 text-center">
                        <input type="file" onChange={handleFileChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        <PhotoIcon/>
                        <p className="text-sm mt-1">{image ? \`Image: \${image.name}\` : 'Upload an image (optional)'}</p>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={handleGenerate} disabled={isLoading} className="btn-primary flex-grow flex items-center justify-center gap-2 px-4 py-2">
                            {isLoading ? <LoadingSpinner /> : 'Generate New Theme'}
                        </button>
                         <button onClick={handleApplyTheme} disabled={isLoading || !theme} className="px-4 py-2 bg-emerald-600 text-white font-bold rounded-md hover:opacity-90 transition-all disabled:opacity-50 shadow-md">
                            Apply to App
                        </button>
                    </div>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}

                    {theme && !isLoading && (
                        <div className="mt-4 border-t border-border pt-4 space-y-4">
                            <div><h3 className="text-lg font-bold mb-2">Palette</h3><div className="space-y-2"><ColorDisplay name="Primary" color={theme.palette.primary}/><ColorDisplay name="Secondary" color={theme.palette.secondary}/><ColorDisplay name="Accent" color={theme.palette.accent}/><ColorDisplay name="Neutral" color={theme.palette.neutral}/></div></div>
                            <div><h3 className="text-lg font-bold mb-2">Theme Roles</h3><div className="space-y-2"><ColorDisplay name="Background" color={theme.theme.background}/><ColorDisplay name="Surface" color={theme.theme.surface}/><ColorDisplay name="Text Primary" color={theme.theme.textPrimary}/><ColorDisplay name="Text Secondary" color={theme.theme.textSecondary}/><ColorDisplay name="Text on Primary" color={theme.theme.textOnPrimary}/><ColorDisplay name="Border" color={theme.theme.border}/></div></div>
                            <div><h3 className="text-lg font-bold mb-2">Accessibility (WCAG 2.1)</h3><div className="space-y-2"><AccessibilityCheck name="Primary on Surface" check={theme.accessibility.primaryOnSurface}/><AccessibilityCheck name="Text on Surface" check={theme.accessibility.textPrimaryOnSurface}/><AccessibilityCheck name="Subtle Text on Surface" check={theme.accessibility.textSecondaryOnSurface}/><AccessibilityCheck name="Text on Primary" check={theme.accessibility.textOnPrimaryOnPrimary}/></div></div>
                        </div>
                    )}
                </div>
                <div className="md:col-span-1 rounded-lg p-8 overflow-y-auto border border-border" style={{ backgroundColor: theme?.theme.background.value, color: theme?.theme.textPrimary.value }}>
                     <h3 className="text-2xl font-bold mb-6">Live Preview</h3>
                     {theme ? (
                         <div className="p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-6" style={{ backgroundColor: theme.theme.surface.value }}>
                            <div className="space-y-4">
                                <h4 className="text-lg font-bold">Sample Card</h4>
                                <p className="text-sm" style={{color: theme.theme.textSecondary.value}}>This is a sample card to demonstrate the theme colors. It contains a primary button and some secondary text.</p>
                                <button className="px-4 py-2 rounded-md font-bold transition-colors" style={{ backgroundColor: theme.palette.primary.value, color: theme.theme.textOnPrimary.value }}>Primary Button</button>
                            </div>
                             <div className="space-y-4">
                                <input type="text" placeholder="Text input" className="w-full px-3 py-2 rounded-md border" style={{backgroundColor: theme.theme.background.value, borderColor: theme.theme.border.value, color: theme.theme.textPrimary.value}} />
                                <div className="p-3 border rounded" style={{borderColor: theme.theme.border.value, color: theme.theme.textSecondary.value}}>
                                    <p>A bordered container.</p>
                                </div>
                             </div>
                         </div>
                     ) : <div className="flex items-center justify-center h-full text-text-secondary">Theme preview will appear here.</div>}
                </div>
            </div>
        </div>
    );
};`,
  'components/features/TypographyLab.tsx': `import React, { useState, useEffect } from 'react';
import { TypographyLabIcon } from '../icons.tsx';

const popularFonts = [
    'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Source Sans Pro', 'Raleway', 'Poppins', 'Nunito', 'Merriweather',
    'Playfair Display', 'Lora', 'Noto Sans', 'Ubuntu', 'PT Sans', 'Slabo 27px'
];

export const TypographyLab: React.FC = () => {
    const [headingFont, setHeadingFont] = useState('Oswald');
    const [bodyFont, setBodyFont] = useState('Roboto');

    useEffect(() => {
        const fontsToLoad = [headingFont, bodyFont].filter(Boolean).join('|');
        if (fontsToLoad) {
            const linkId = 'font-pairing-stylesheet';
            let link = document.getElementById(linkId) as HTMLLinkElement;
            if (!link) {
                link = document.createElement('link');
                link.id = linkId;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = \`https://fonts.googleapis.com/css?family=\${fontsToLoad.replace(/ /g, '+')}:400,700&display=swap\`;
        }
    }, [headingFont, bodyFont]);
    
    const FontSelector: React.FC<{ label: string, value: string, onChange: (font: string) => void }> = ({ label, value, onChange }) => (
        <div>
            <label className="block text-sm font-medium text-text-secondary">{label}</label>
            <select value={value} onChange={e => onChange(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-md bg-surface border border-border">
                {popularFonts.map(font => <option key={font} value={font}>{font}</option>)}
            </select>
        </div>
    );

    const headingImport = \`@import url('https://fonts.googleapis.com/css?family=\${headingFont.replace(/ /g, '+')}:700&display=swap');\`;
    const bodyImport = \`@import url('https://fonts.googleapis.com/css?family=\${bodyFont.replace(/ /g, '+')}:400&display=swap');\`;
    const headingRule = \`font-family: '\${headingFont}', sans-serif;\`;
    const bodyRule = \`font-family: '\${bodyFont}', sans-serif;\`;

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <TypographyLabIcon />
                    <span className="ml-3">Typography Lab</span>
                </h1>
                <p className="text-text-secondary mt-1">Preview font pairings and get the necessary CSS rules.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg">
                    <h3 className="text-xl font-bold">Controls</h3>
                    <FontSelector label="Heading Font" value={headingFont} onChange={setHeadingFont} />
                    <FontSelector label="Body Font" value={bodyFont} onChange={setBodyFont} />
                    <div className="space-y-2 mt-4 pt-4 border-t border-border">
                        <label className="block text-sm font-medium text-text-secondary">CSS Rules</label>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{headingImport}</pre><button onClick={() => navigator.clipboard.writeText(headingImport)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{headingRule}</pre><button onClick={() => navigator.clipboard.writeText(headingRule)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{bodyImport}</pre><button onClick={() => navigator.clipboard.writeText(bodyImport)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{bodyRule}</pre><button onClick={() => navigator.clipboard.writeText(bodyRule)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                    </div>
                </div>
                <div className="lg:col-span-2 bg-background border border-border rounded-lg p-8 overflow-y-auto">
                    <h2 className="text-4xl font-bold mb-4" style={{ fontFamily: \`'\${headingFont}', sans-serif\` }}>
                        The Quick Brown Fox Jumps Over the Lazy Dog
                    </h2>
                    <p className="text-lg" style={{ fontFamily: \`'\${bodyFont}', sans-serif\` }}>
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat.
                    </p>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/VisualGitTree.tsx': `import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { GitBranchIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { generateChangelogFromLogStream } from '../../services/aiService.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const exampleLog = \`* commit 3a4b5c6d7e8f9g0h1i2j3k4l5m6n7o8p9q0r (HEAD -> main, origin/main)
|\\\\  Merge: 1a2b3c4 2d3e4f5
| | Author: Dev One <dev.one@example.com>
| | Date:   Mon Jul 15 11:30:00 2024 -0400
| |
| |     feat: Implement collapsible sidebar navigation
| |
* | commit 2d3e4f5g6h7i8j9k0l1m2n3o4p5q6r7s8t9u (feature/new-sidebar)
| | Author: Dev Two <dev.two@example.com>
| | Date:   Mon Jul 15 10:00:00 2024 -0400
| |
| |     feat: Add icons to sidebar items
| |
* | commit 1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r
|/  Author: Dev One <dev.one@example.com>
|   Date:   Fri Jul 12 16:45:00 2024 -0400
|
|       fix: Correct user authentication bug\`;

const CommitGraph = ({ logInput }: { logInput: string }) => {
    const commits = useMemo(() => {
        const lines = logInput.split('\\n');
        const parsedCommits: any[] = [];
        let currentCommit: any = null;

        lines.forEach(line => {
            const commitMatch = line.match(/^.?[\\\\|/ ]*\\* commit (\\w+)(.*)/);
            if (commitMatch) {
                if (currentCommit) parsedCommits.push(currentCommit);
                currentCommit = {
                    hash: commitMatch[1],
                    shortHash: commitMatch[1].substring(0, 7),
                    refs: commitMatch[2].trim(),
                    message: '',
                    author: '',
                };
            } else if (currentCommit) {
                 if (line.includes('Author:')) currentCommit.author = line.split('Author:')[1].trim();
                 else if (line.trim().length > 0 && !line.match(/^[\\\\|/ ]*[\\\\|/ ]/)) {
                     currentCommit.message += line.trim() + ' ';
                 }
            }
        });
        if (currentCommit) parsedCommits.push(currentCommit);
        
        return parsedCommits.map((c, i) => ({ ...c, x: 50, y: 50 + i * 60 }));
    }, [logInput]);

    return (
         <svg width="100%" height={50 + commits.length * 60} className="min-h-[200px]">
            {commits.map((commit, i) => {
                const parent = commits[i + 1];
                return (
                    <g key={commit.hash}>
                        {parent && <line x1={commit.x} y1={commit.y} x2={parent.x} y2={parent.y} stroke="var(--color-border)" strokeWidth="2" />}
                        <g className="group cursor-pointer">
                            <circle cx={commit.x} cy={commit.y} r="8" fill="var(--color-primary)" stroke="var(--color-surface)" strokeWidth="3" />
                            <foreignObject x={commit.x + 20} y={commit.y - 25} width="350" height="50">
                                <div className="text-sm p-1">
                                    <p className="font-bold truncate text-text-primary">{commit.message}</p>
                                    <p className="text-xs text-text-secondary font-mono">{commit.shortHash} <span className="text-amber-600">{commit.refs}</span></p>
                                </div>
                            </foreignObject>
                            <title>{\`Commit: \${commit.hash}\\nAuthor: \${commit.author}\\n\\n\${commit.message}\`}</title>
                        </g>
                    </g>
                );
            })}
        </svg>
    );
};

export const VisualGitTree: React.FC<{ logInput?: string }> = ({ logInput: initialLogInput }) => {
    const [logInput, setLogInput] = useState(initialLogInput || exampleLog);
    const [analysis, setAnalysis] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleAnalyze = useCallback(async (logToAnalyze: string) => {
        if (!logToAnalyze.trim()) {
            setError('Please paste git log output.');
            return;
        }
        setIsLoading(true);
        setError('');
        setAnalysis('');
        try {
            const stream = generateChangelogFromLogStream(logToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setAnalysis(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to analyze log: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialLogInput) {
            setLogInput(initialLogInput);
            handleAnalyze(initialLogInput);
        }
    }, [initialLogInput, handleAnalyze]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">Visual Git Tree</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your \`git log --graph\` output to visualize the history and get an AI summary.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                    <label htmlFor="log-input" className="text-sm font-medium text-text-secondary mb-2">Git Log Output</label>
                    <textarea
                        id="log-input"
                        value={logInput}
                        onChange={(e) => setLogInput(e.target.value)}
                        placeholder="Paste your git log output here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                    <button
                        onClick={() => handleAnalyze(logInput)}
                        disabled={isLoading}
                        className="btn-primary mt-4 w-full flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Analyze & Summarize'}
                    </button>
                </div>
                <div className="flex flex-col h-full gap-4">
                    <div className="flex flex-col h-1/2">
                        <label className="text-sm font-medium text-text-secondary mb-2">Commit Graph</label>
                        <div className="flex-grow p-2 bg-surface border border-border rounded-md overflow-auto">
                            <CommitGraph logInput={logInput} />
                        </div>
                    </div>
                     <div className="flex flex-col h-1/2">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-sm font-medium text-text-secondary">AI Summary</label>
                            {analysis && !isLoading && (
                                <button onClick={() => downloadFile(analysis, 'summary.md', 'text/markdown')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4"/> Download Summary
                                </button>
                            )}
                        </div>
                        <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {analysis && !isLoading && <MarkdownRenderer content={analysis} />}
                            {!isLoading && !analysis && !error && <div className="text-text-secondary h-full flex items-center justify-center">AI summary will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/WeeklyDigestGenerator.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { generateWeeklyDigest } from '../../services/index.ts';
import { getCommitHistory } from '../../services/githubService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { useOctokit } from '../../contexts/OctokitContext.tsx';
import { MailIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const dummyTelemetry = {
    avgPageLoad: 120,
    errorRate: '0.5%',
    uptime: '99.98%'
};

export const WeeklyDigestGenerator: React.FC = () => {
    const { addNotification } = useNotification();
    const { state } = useGlobalState();
    const { selectedRepo } = state;
    const { octokit, reinitialize } = useOctokit();

    const [emailHtml, setEmailHtml] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    
    // Re-check for Octokit client if it's not available initially
    useEffect(() => {
        if (!octokit) {
            reinitialize();
        }
    }, [octokit, reinitialize]);

    const handleGenerate = useCallback(async () => {
        if (!selectedRepo || !octokit) {
            addNotification('Please select a repository and ensure GitHub is connected.', 'error');
            return;
        }

        setIsLoading(true);
        setEmailHtml('');
        try {
            const [owner, repo] = selectedRepo.full_name.split('/');
            const commits = await getCommitHistory(octokit, owner, repo);
            const commitLogs = commits.map(c => c.commit.message).join('\\n');
            
            const html = await generateWeeklyDigest(commitLogs, dummyTelemetry);
            setEmailHtml(html);
            addNotification('Digest content generated!', 'success');
        } catch (e) {
            addNotification(e instanceof Error ? e.message : 'Failed to generate digest', 'error');
        } finally {
            setIsLoading(false);
        }
    }, [addNotification, octokit, selectedRepo]);


    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><MailIcon /><span className="ml-3">Weekly Digest Generator</span></h1>
                <p className="text-text-secondary mt-1">Generate an AI-powered weekly summary based on project data.</p>
            </header>

            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col items-center justify-center text-center">
                    <h3 className="text-lg font-bold">Generate Digest</h3>
                    <p className="text-sm text-text-secondary my-4">
                        This tool will use the commit history from your selected repository ({selectedRepo ? selectedRepo.full_name : 'none selected'}) to generate a summary. The send functionality has been removed due to updated permissions.
                    </p>
                    <div className="flex flex-col gap-4 w-full max-w-xs">
                        <button onClick={handleGenerate} disabled={isLoading || !selectedRepo || !octokit} className="btn-primary flex items-center justify-center gap-2 py-3">
                            {isLoading ? <LoadingSpinner /> : <><SparklesIcon /> Generate Digest</>}
                        </button>
                    </div>
                </div>

                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <h3 className="text-lg font-bold mb-2">Email Preview</h3>
                    <div className="flex-grow bg-white border rounded overflow-hidden">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {emailHtml && <iframe srcDoc={emailHtml} title="Email Preview" className="w-full h-full" />}
                        {!isLoading && !emailHtml && <div className="flex justify-center items-center h-full text-text-secondary">Preview will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/WorkerThreadDebugger.tsx': `import React, { useState, useCallback, useEffect } from 'react';
import { BugAntIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { analyzeConcurrencyStream } from '../../services/index.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const exampleCode = \`// main.js
const worker = new Worker('worker.js');

// This object is sent back and forth.
// A race condition can occur because both threads
// read the counter, increment it, and send it back.
// The final value depends on which thread's message
// is processed last.
const data = { counter: 0 };

worker.onmessage = function(e) {
  // Main thread reads and updates
  data.counter = e.data.counter;
  console.log('Main received:', data.counter);
  data.counter++;
  worker.postMessage(data);
};

// Start the process
console.log('Main starting with:', data.counter);
data.counter++;
worker.postMessage(data);


// worker.js
// onmessage = function(e) {
//   // Worker reads and updates
//   let receivedCounter = e.data.counter;
//   console.log('Worker received:', receivedCounter);
//   receivedCounter++;
//   postMessage({ counter: receivedCounter });
// }
\`;

export const WorkerThreadDebugger: React.FC<{ codeInput?: string }> = ({ codeInput: initialCode }) => {
    const [codeInput, setCodeInput] = useState(initialCode || exampleCode);
    const [analysis, setAnalysis] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleAnalyze = useCallback(async (codeToAnalyze: string) => {
        if (!codeToAnalyze.trim()) {
            setError('Please paste some code to analyze.');
            return;
        }
        setIsLoading(true);
        setError('');
        setAnalysis('');
        try {
            const stream = analyzeConcurrencyStream(codeToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setAnalysis(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to analyze code: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialCode) {
            setCodeInput(initialCode);
            handleAnalyze(initialCode);
        }
    }, [initialCode, handleAnalyze]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BugAntIcon />
                    <span className="ml-3">AI Concurrency Analyzer</span>
                </h1>
                <p className="text-text-secondary mt-1">Analyze JavaScript code for potential Web Worker concurrency issues.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">JavaScript Code</label>
                    <textarea
                        id="code-input"
                        value={codeInput}
                        onChange={(e) => setCodeInput(e.target.value)}
                        placeholder="Paste your worker-related JS code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={() => handleAnalyze(codeInput)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Analyze Code'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">AI Analysis</label>
                        {analysis && !isLoading && (
                             <button onClick={() => downloadFile(analysis, 'analysis.md', 'text/markdown')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                <ArrowDownTrayIcon className="w-4 h-4"/> Download
                            </button>
                        )}
                    </div>
                    <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {analysis && !isLoading && <MarkdownRenderer content={analysis} />}
                        {!isLoading && !analysis && !error && <div className="text-text-secondary h-full flex items-center justify-center">Analysis will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/WorkspaceConnectorHub.tsx': `import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { validateToken } from '../../services/authService.ts';
import { ACTION_REGISTRY, executeWorkspaceAction } from '../../services/workspaceConnectorService.ts';
import { RectangleGroupIcon, GithubIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { signInWithGoogle } from '../../services/googleAuthService.ts';
import { useVaultModal } from '../../contexts/VaultModalContext.tsx';

const ServiceConnectionCard: React.FC<{
    serviceName: string;
    icon: React.ReactNode;
    fields: { id: string; label: string; placeholder: string }[];
    onConnect: (credentials: Record<string, string>) => Promise<void>;
    onDisconnect: () => Promise<void>;
    status: string;
    isLoading: boolean;
}> = ({ serviceName, icon, fields, onConnect, onDisconnect, status, isLoading }) => {
    const [creds, setCreds] = useState<Record<string, string>>({});

    const handleConnect = () => {
        onConnect(creds);
    };

    const isConnected = status.startsWith('Connected');

    return (
        <div className="bg-surface border border-border rounded-lg p-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10">{icon}</div>
                    <div>
                        <h3 className="text-lg font-bold text-text-primary">{serviceName}</h3>
                        <p className={\`text-sm \${isConnected ? 'text-green-600' : 'text-text-secondary'}\`}>{status}</p>
                    </div>
                </div>
                {isConnected && (
                    <button onClick={onDisconnect} className="px-4 py-2 bg-red-500/10 text-red-600 font-semibold rounded-lg hover:bg-red-500/20">
                        Disconnect
                    </button>
                )}
            </div>
            {!isConnected && (
                <div className="mt-4 pt-4 border-t border-border space-y-2">
                    {fields.map(field => (
                        <div key={field.id}>
                            <label className="text-xs text-text-secondary">{field.label}</label>
                            <input
                                type={field.id.includes('token') || field.id.includes('pat') ? 'password' : 'text'}
                                value={creds[field.id] || ''}
                                onChange={e => setCreds(prev => ({ ...prev, [field.id]: e.target.value }))}
                                placeholder={field.placeholder}
                                className="w-full mt-1 p-2 bg-background border border-border rounded-md text-sm"
                            />
                        </div>
                    ))}
                    <button onClick={handleConnect} disabled={isLoading} className="btn-primary w-full mt-2 py-2 flex items-center justify-center">
                        {isLoading ? <LoadingSpinner /> : 'Connect'}
                    </button>
                </div>
            )}
        </div>
    );
};


export const WorkspaceConnectorHub: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, vaultState } = state;
    const { addNotification } = useNotification();
    const { requestUnlock, requestCreation } = useVaultModal();
    const [loadingStates, setLoadingStates] = useState<Record<string, boolean>>({});
    const [connectionStatuses, setConnectionStatuses] = useState<Record<string, string>>({});
    
    // Manual action state
    const [selectedActionId, setSelectedActionId] = useState<string>([...ACTION_REGISTRY.keys()][0]);
    const [actionParams, setActionParams] = useState<Record<string, any>>({});
    const [isExecuting, setIsExecuting] = useState(false);
    const [actionResult, setActionResult] = useState<string>('');

    const services = useMemo(() => {
        const serviceMap = new Map();
        ACTION_REGISTRY.forEach(action => {
            if (!serviceMap.has(action.service)) {
                serviceMap.set(action.service, {
                    name: action.service,
                    actions: [],
                });
            }
            serviceMap.get(action.service).actions.push(action);
        });
        return Array.from(serviceMap.values());
    }, []);

    const checkConnections = useCallback(async () => {
        if (!user || !vaultState.isUnlocked) return;
        
        const checkCred = async (credId: string, serviceName: string, successMessage: string) => {
             const token = await vaultService.getDecryptedCredential(credId);
             setConnectionStatuses(s => ({ ...s, [serviceName]: token ? successMessage : 'Not Connected' }));
        };

        await checkCred('github_pat', 'GitHub', githubUser ? \`Connected as \${githubUser.login}\`: 'Connected');
        await checkCred('jira_pat', 'Jira', 'Connected');
        await checkCred('slack_bot_token', 'Slack', 'Connected');

    }, [user, vaultState.isUnlocked, githubUser]);

    useEffect(() => {
        checkConnections();
    }, [checkConnections]);
    
    const withVault = useCallback(async (callback: () => Promise<void>) => {
        if (!vaultState.isInitialized) {
            const created = await requestCreation();
            if (!created) { addNotification('Vault setup is required.', 'error'); return; }
        }
        if (!vaultState.isUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) { addNotification('Vault must be unlocked to manage connections.', 'error'); return; }
        }
        await callback();
    }, [vaultState, requestCreation, requestUnlock, addNotification]);


    const handleConnect = async (serviceName: string, credentials: Record<string, string>) => {
        await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const [key, value] of Object.entries(credentials)) {
                    if (value) await vaultService.saveCredential(key, value);
                }
                if (serviceName === 'GitHub' && credentials.github_pat) {
                     const githubProfile = await validateToken(credentials.github_pat);
                     dispatch({ type: 'SET_GITHUB_USER', payload: githubProfile });
                     await vaultService.saveCredential('github_user', JSON.stringify(githubProfile));
                }
                addNotification(\`\${serviceName} connected successfully!\`, 'success');
                checkConnections();
            } catch (e) {
                addNotification(\`Failed to connect \${serviceName}: \${e instanceof Error ? e.message : 'Unknown error'}\`, 'error');
            } finally {
                setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
        });
    };
    
    const handleDisconnect = async (serviceName: string, credIds: string[]) => {
       await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const id of credIds) {
                     await vaultService.saveCredential(id, ''); // Overwrite with empty string
                }
                 if (serviceName === 'GitHub') {
                     dispatch({ type: 'SET_GITHUB_USER', payload: null });
                     await vaultService.saveCredential('github_user', '');
                }
                addNotification(\`\${serviceName} disconnected.\`, 'info');
                checkConnections();
            } catch(e) {
                addNotification(\`Failed to disconnect \${serviceName}.\`, 'error');
            } finally {
                 setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
       });
    };
    
    const handleExecuteAction = async () => {
        await withVault(async () => {
            setIsExecuting(true);
            setActionResult('');
            try {
                const result = await executeWorkspaceAction(selectedActionId, actionParams);
                setActionResult(JSON.stringify(result, null, 2));
                addNotification('Action executed successfully!', 'success');
            } catch(e) {
                setActionResult(\`Error: \${e instanceof Error ? e.message : 'Unknown Error'}\`);
                addNotification('Action failed.', 'error');
            } finally {
                setIsExecuting(false);
            }
        });
    };

    const handleSignIn = () => {
        signInWithGoogle();
        // The result is handled by the global callback set in App.tsx
    };

    const selectedAction = ACTION_REGISTRY.get(selectedActionId);
    const actionParameters = selectedAction ? selectedAction.getParameters() : {};

    if (!user) {
        return (
            <div className="h-full flex items-center justify-center">
                <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md">
                    <h2 className="text-xl font-bold">Sign In Required</h2>
                    <p className="text-text-secondary my-4">Please sign in with your Google account to manage workspace connections.</p>
                    <button onClick={handleSignIn} className="btn-primary px-6 py-3 flex items-center justify-center gap-2 mx-auto">
                        Sign in with Google
                    </button>
                </div>
            </div>
        );
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
             <header className="mb-8">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center"><RectangleGroupIcon /><span className="ml-3">Workspace Connector Hub</span></h1>
                <p className="mt-2 text-lg text-text-secondary">Connect to your development services to unlock cross-platform AI actions.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                <div className="flex flex-col gap-6 overflow-y-auto pr-4">
                    <h2 className="text-2xl font-bold">Service Connections</h2>
                    <ServiceConnectionCard 
                        serviceName="GitHub"
                        icon={<GithubIcon />}
                        fields={[{ id: 'github_pat', label: 'Personal Access Token', placeholder: 'ghp_...' }]}
                        onConnect={(creds) => handleConnect('GitHub', creds)}
                        onDisconnect={() => handleDisconnect('GitHub', ['github_pat'])}
                        status={connectionStatuses.GitHub || 'Checking...'}
                        isLoading={loadingStates.GitHub}
                    />
                     {/* Placeholder cards for Jira and Slack */}
                    <ServiceConnectionCard 
                        serviceName="Jira"
                        icon={<div className="w-10 h-10 bg-[#0052CC] rounded flex items-center justify-center text-white font-bold text-xl">J</div>}
                        fields={[
                            { id: 'jira_domain', label: 'Jira Domain', placeholder: 'your-company.atlassian.net' },
                            { id: 'jira_email', label: 'Your Jira Email', placeholder: 'you@example.com' },
                            { id: 'jira_pat', label: 'API Token', placeholder: 'Your API Token' },
                        ]}
                        onConnect={(creds) => handleConnect('Jira', creds)}
                        onDisconnect={() => handleDisconnect('Jira', ['jira_domain', 'jira_email', 'jira_pat'])}
                        status={connectionStatuses.Jira || 'Checking...'}
                        isLoading={loadingStates.Jira}
                    />
                    <ServiceConnectionCard 
                        serviceName="Slack"
                        icon={<div className="w-10 h-10 bg-[#4A154B] rounded flex items-center justify-center text-white font-bold text-2xl">#</div>}
                        fields={[{ id: 'slack_bot_token', label: 'Bot User OAuth Token', placeholder: 'xoxb-...' }]}
                        onConnect={(creds) => handleConnect('Slack', creds)}
                        onDisconnect={() => handleDisconnect('Slack', ['slack_bot_token'])}
                        status={connectionStatuses.Slack || 'Checking...'}
                        isLoading={loadingStates.Slack}
                    />
                </div>
                <div className="flex flex-col gap-6 bg-surface p-6 border border-border rounded-lg">
                    <h2 className="text-2xl font-bold">Manual Action Runner</h2>
                    <div className="space-y-4">
                         <div>
                            <label className="text-sm font-medium">Action</label>
                            <select value={selectedActionId} onChange={e => setSelectedActionId(e.target.value)} className="w-full mt-1 p-2 bg-background border rounded">
                                {services.map(service => (
                                    <optgroup label={service.name} key={service.name}>
                                        {service.actions.map((action: any) => (
                                            <option key={action.id} value={action.id}>{action.description}</option>
                                        ))}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                        {Object.entries(actionParameters).map(([key, param]: [string, any]) => (
                            <div key={key}>
                                <label className="text-sm font-medium">{key} {param.required && '*'}</label>
                                <input 
                                    type={param.type}
                                    value={actionParams[key] || ''}
                                    onChange={e => setActionParams(p => ({...p, [key]: e.target.value}))}
                                    placeholder={param.default || ''}
                                    className="w-full mt-1 p-2 bg-background border rounded"
                                />
                            </div>
                        ))}
                        <button onClick={handleExecuteAction} disabled={isExecuting} className="btn-primary w-full py-2 flex items-center justify-center gap-2">
                           {isExecuting ? <LoadingSpinner/> : <><SparklesIcon /> Execute Action</>}
                        </button>
                    </div>
                    <div>
                        <label className="text-sm font-medium">Result</label>
                        <pre className="w-full h-48 mt-1 p-2 bg-background border rounded overflow-auto text-xs">{actionResult || 'Action results will appear here.'}</pre>
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/XbrlConverter.tsx': `import React, { useState, useCallback } from 'react';
import { convertJsonToXbrlStream } from '../../services/aiService.ts';
import { XbrlConverterIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleJson = \`{
  "company": "ExampleCorp",
  "year": 2024,
  "quarter": 2,
  "revenue": {
    "amount": 1500000,
    "currency": "USD"
  },
  "profit": {
    "amount": 250000,
    "currency": "USD"
  }
}\`;

export const XbrlConverter: React.FC<{ jsonInput?: string }> = ({ jsonInput: initialJsonInput }) => {
    const [jsonInput, setJsonInput] = useState<string>(initialJsonInput || exampleJson);
    const [xbrlOutput, setXbrlOutput] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleConvert = useCallback(async (jsonToConvert: string) => {
        if (!jsonToConvert.trim()) {
            setError('Please enter valid JSON to convert.');
            return;
        }
        setIsLoading(true);
        setError('');
        setXbrlOutput('');
        try {
            const stream = convertJsonToXbrlStream(jsonToConvert);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setXbrlOutput(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\`Failed to convert: \${errorMessage}\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <XbrlConverterIcon />
                    <span className="ml-3">JSON to XBRL Converter</span>
                </h1>
                <p className="text-text-secondary mt-1">Convert JSON data into a simplified XBRL-like XML format using AI.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={(e) => setJsonInput(e.target.value)}
                        placeholder="Paste your JSON here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={() => handleConvert(jsonInput)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Convert to XBRL'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">XBRL-like XML Output</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !xbrlOutput && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {xbrlOutput && <MarkdownRenderer content={'\`\`\`xml\\n' + xbrlOutput.replace(/\`\`\`xml\\n|\`\`\`/g, '') + '\\n\`\`\`'} />}
                        {!isLoading && xbrlOutput && <button onClick={() => navigator.clipboard.writeText(xbrlOutput)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy XML</button>}
                        {!isLoading && !xbrlOutput && !error && <div className="text-text-secondary h-full flex items-center justify-center">Output will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};`,
  'components/features/index.ts': `import React from 'react';
import type { Feature } from '../../types.ts';
import { RAW_FEATURES } from '../../constants.tsx';
import { lazyWithRetry } from '../../services/componentLoader.ts';

const componentMap: Record<string, React.FC<any>> = {
    'ai-command-center': lazyWithRetry(() => import('./AiCommandCenter.tsx'), 'AiCommandCenter'),
    'project-explorer': lazyWithRetry(() => import('./ProjectExplorer.tsx'), 'ProjectExplorer'),
    'workspace-connector-hub': lazyWithRetry(() => import('./WorkspaceConnectorHub.tsx'), 'WorkspaceConnectorHub'),
    'ai-code-explainer': lazyWithRetry(() => import('./AiCodeExplainer.tsx'), 'AiCodeExplainer'),
    'ai-feature-builder': lazyWithRetry(() => import('./AiFeatureBuilder.tsx'), 'AiFeatureBuilder'),
    'regex-sandbox': lazyWithRetry(() => import('./RegexSandbox.tsx'), 'RegexSandbox'),
    'portable-snippet-vault': lazyWithRetry(() => import('./SnippetVault.tsx'), 'SnippetVault'),
    'css-grid-editor': lazyWithRetry(() => import('./CssGridEditor.tsx'), 'CssGridEditor'),
    'ai-commit-generator': lazyWithRetry(() => import('./AiCommitGenerator.tsx'), 'AiCommitGenerator'),
    'json-tree-navigator': lazyWithRetry(() => import('./JsonTreeNavigator.tsx'), 'JsonTreeNavigator'),
    'xbrl-converter': lazyWithRetry(() => import('./XbrlConverter.tsx'), 'XbrlConverter'),
    'ai-unit-test-generator': lazyWithRetry(() => import('./AiUnitTestGenerator.tsx'), 'AiUnitTestGenerator'),
    'prompt-craft-pad': lazyWithRetry(() => import('./PromptCraftPad.tsx'), 'PromptCraftPad'),
    'linter-formatter': lazyWithRetry(() => import('./CodeFormatter.tsx'), 'CodeFormatter'),
    'schema-designer': lazyWithRetry(() => import('./SchemaDesigner.tsx'), 'SchemaDesigner'),
    'pwa-manifest-editor': lazyWithRetry(() => import('./PwaManifestEditor.tsx'), 'PwaManifestEditor'),
    'markdown-slides-generator': lazyWithRetry(() => import('./MarkdownSlides.tsx'), 'MarkdownSlides'),
    'screenshot-to-component': lazyWithRetry(() => import('./ScreenshotToComponent.tsx'), 'ScreenshotToComponent'),
    'digital-whiteboard': lazyWithRetry(() => import('./DigitalWhiteboard.tsx'), 'DigitalWhiteboard'),
    'theme-designer': lazyWithRetry(() => import('./ThemeDesigner.tsx'), 'ThemeDesigner'),
    'svg-path-editor': lazyWithRetry(() => import('./SvgPathEditor.tsx'), 'SvgPathEditor'),
    'ai-style-transfer': lazyWithRetry(() => import('./AiStyleTransfer.tsx'), 'AiStyleTransfer'),
    'ai-coding-challenge': lazyWithRetry(() => import('./AiCodingChallenge.tsx'), 'AiCodingChallenge'),
    'typography-lab': lazyWithRetry(() => import('./TypographyLab.tsx'), 'TypographyLab'),
    'code-review-bot': lazyWithRetry(() => import('./CodeReviewBot.tsx'), 'CodeReviewBot'),
    'ai-pull-request-assistant': lazyWithRetry(() => import('./AiPullRequestAssistant.tsx'), 'AiPullRequestAssistant'),
    'changelog-generator': lazyWithRetry(() => import('./ChangelogGenerator.tsx'), 'ChangelogGenerator'),
    'cron-job-builder': lazyWithRetry(() => import('./CronJobBuilder.tsx'), 'CronJobBuilder'),
    'ai-code-migrator': lazyWithRetry(() => import('./AiCodeMigrator.tsx'), 'AiCodeMigrator'),
    'visual-git-tree': lazyWithRetry(() => import('./VisualGitTree.tsx'), 'VisualGitTree'),
    'worker-thread-debugger': lazyWithRetry(() => import('./WorkerThreadDebugger.tsx'), 'WorkerThreadDebugger'),
    'ai-image-generator': lazyWithRetry(() => import('./AiImageGenerator.tsx'), 'AiImageGenerator'),
    'async-call-tree-viewer': lazyWithRetry(() => import('./AsyncCallTreeViewer.tsx'), 'AsyncCallTreeViewer'),
    'audio-to-code': lazyWithRetry(() => import('./AudioToCode.tsx'), 'AudioToCode'),
    'code-diff-ghost': lazyWithRetry(() => import('./CodeDiffGhost.tsx'), 'CodeDiffGhost'),
    'code-spell-checker': lazyWithRetry(() => import('./CodeSpellChecker.tsx'), 'CodeSpellChecker'),
    'color-palette-generator': lazyWithRetry(() => import('./ColorPaletteGenerator.tsx'), 'ColorPaletteGenerator'),
    'logic-flow-builder': lazyWithRetry(() => import('./LogicFlowBuilder.tsx'), 'LogicFlowBuilder'),
    'meta-tag-editor': lazyWithRetry(() => import('./MetaTagEditor.tsx'), 'MetaTagEditor'),
    'network-visualizer': lazyWithRetry(() => import('./NetworkVisualizer.tsx'), 'NetworkVisualizer'),
    'responsive-tester': lazyWithRetry(() => import('./ResponsiveTester.tsx'), 'ResponsiveTester'),
    'sass-scss-compiler': lazyWithRetry(() => import('./SassScssCompiler.tsx'), 'SassScssCompiler'),
    'api-mock-generator': lazyWithRetry(() => import('./ApiMockGenerator.tsx'), 'ApiMockGenerator'),
    'env-manager': lazyWithRetry(() => import('./EnvManager.tsx'), 'EnvManager'),
    'performance-profiler': lazyWithRetry(() => import('./PerformanceProfiler.tsx'), 'PerformanceProfiler'),
    'a11y-auditor': lazyWithRetry(() => import('./AccessibilityAuditor.tsx'), 'AccessibilityAuditor'),
    'ci-cd-generator': lazyWithRetry(() => import('./CiCdPipelineGenerator.tsx'), 'CiCdPipelineGenerator'),
    'deployment-preview': lazyWithRetry(() => import('./DeploymentPreview.tsx'), 'DeploymentPreview'),
    'security-scanner': lazyWithRetry(() => import('./SecurityScanner.tsx'), 'SecurityScanner'),
    'terraform-generator': lazyWithRetry(() => import('./TerraformGenerator.tsx'), 'TerraformGenerator'),
    'ai-personality-forge': lazyWithRetry(() => import('./AiPersonalityForge.tsx'), 'AiPersonalityForge'),
    'weekly-digest-generator': lazyWithRetry(() => import('./WeeklyDigestGenerator.tsx'), 'WeeklyDigestGenerator'),
    'one-click-refactor': lazyWithRetry(() => import('./OneClickRefactor.tsx'), 'OneClickRefactor'),
    'bug-reproducer': lazyWithRetry(() => import('./BugReproducer.tsx'), 'BugReproducer'),
    'tech-debt-sonar': lazyWithRetry(() => import('./TechDebtSonar.tsx'), 'TechDebtSonar'),
    'iam-policy-generator': lazyWithRetry(() => import('./IamPolicyGenerator.tsx'), 'IamPolicyGenerator'),
    'iam-policy-visualizer': lazyWithRetry(() => import('./IamPolicyVisualizer.tsx'), 'IamPolicyVisualizer'),
    'gmail-addon-simulator': lazyWithRetry(() => import('./GmailAddonSimulator.tsx'), 'GmailAddonSimulator'),
    'pr-summary-generator': lazyWithRetry(() => import('./PrSummaryGenerator.tsx'), 'PrSummaryGenerator'),
    'project-moodboard': lazyWithRetry(() => import('./ProjectMoodboard.tsx'), 'ProjectMoodboard'),
    'font-preview-picker': lazyWithRetry(() => import('./FontPreviewPicker.tsx'), 'FontPreviewPicker'),
    'font-pairing-tool': lazyWithRetry(() => import('./FontPairingTool.tsx'), 'FontPairingTool'),
};

export const ALL_FEATURES: Feature[] = RAW_FEATURES.map(feature => ({
    ...feature,
    component: componentMap[feature.id],
}));

export const FEATURES_MAP = new Map(ALL_FEATURES.map(f => [f.id, f]));`,
  'components/features/manifest.ts': `// This file can be used to export feature metadata or related constants.
// For now, it's a placeholder.
export {};
`,
  'components/features/shared/.placeholder': ``,
  'components/features/shared/LoadingSpinner.tsx': `
import React from 'react';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);
`,
  'components/features/shared/index.tsx': `import React, { useState, useEffect } from 'react';
import { marked } from 'marked';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);

interface MarkdownRendererProps {
    content: string;
}

export const MarkdownRenderer: React.FC<MarkdownRendererProps> = ({ content }) => {
    const [sanitizedHtml, setSanitizedHtml] = useState<string | TrustedHTML>('');

    useEffect(() => {
        const parse = async () => {
            if (content) {
                const html = await marked.parse(content);
                setSanitizedHtml(html);
            } else {
                setSanitizedHtml('');
            }
        };
        parse();
    }, [content]);

    return (
        <div
            className="prose prose-sm max-w-none prose-headings:text-text-primary prose-p:text-text-primary prose-strong:text-text-primary prose-code:text-primary prose-code:before:content-none prose-code:after:content-none prose-pre:bg-gray-50 prose-pre:border prose-pre:border-border prose-pre:p-4 prose-pre:m-0"
            dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
        />
    );
};
`,
  'components/icons.tsx': `

import React from 'react';

const IconWrapper: React.FC<{children: React.ReactNode; className?: string}> = ({ children, className }) => (
    <div className={className ?? 'w-6 h-6'}>{children}</div>
);

// --- From InterfaceIcons.tsx ---
export const CpuChipIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M8.25 21v-1.5M4.5 15.75H3m18 0h-1.5M21 8.25v7.5A2.25 2.25 0 0 1 18.75 18H5.25A2.25 2.25 0 0 1 3 15.75v-7.5A2.25 2.25 0 0 1 5.25 6h13.5A2.25 2.25 0 0 1 21 8.25ZM12 18V6" /></svg></IconWrapper>;
export const DocumentIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const FolderIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg></IconWrapper>;
export const LinkIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg></IconWrapper>;
export const ArchiveBoxIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg></IconWrapper>;
export const ClipboardDocumentIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876C9.083 2.25 6.105 5.106 6.105 9.125v3.375c0 .621.504 1.125 1.125 1.125h9.75Z" /></svg></IconWrapper>;
export const ArrowDownTrayIcon: React.FC<{className?: string}> = ({className}) => <IconWrapper className={className}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg></IconWrapper>;
export const XMarkIcon: React.FC<{className?: string}> = ({className}) => <IconWrapper className={className}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></IconWrapper>;
export const PlusIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></IconWrapper>;
export const TrashIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></IconWrapper>;
export const PencilIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></IconWrapper>;
export const MagnifyingGlassIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></IconWrapper>;
export const Cog6ToothIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-1.008 1.11-1.212l2.39-1.062a1.25 1.25 0 0 1 1.415.602l.62 1.24a1.25 1.25 0 0 0 1.282.693l2.394-.852a1.25 1.25 0 0 1 1.415 1.415l-.852 2.394a1.25 1.25 0 0 0 .693 1.282l1.24.62a1.25 1.25 0 0 1 .602 1.415l-1.062 2.39a1.25 1.25 0 0 0-1.212 1.11l-.22 1.319a1.25 1.25 0 0 1-1.393 1.053l-2.32-.82a1.25 1.25 0 0 0-1.353 0l-2.32.82a1.25 1.25 0 0 1-1.393-1.053l-.22-1.319a1.25 1.25 0 0 0-1.212-1.11l-1.062-2.39a1.25 1.25 0 0 1 .602-1.415l1.24-.62a1.25 1.25 0 0 0 .693-1.282l-.852-2.394a1.25 1.25 0 0 1 1.415-1.415l2.394.852a1.25 1.25 0 0 0 1.282-.693l.62-1.24a1.25 1.25 0 0 1 1.415-.602l-2.39 1.062a1.25 1.25 0 0 0-1.11 1.212Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></IconWrapper>;
export const HomeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg></IconWrapper>;
export const ChevronDownIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg></IconWrapper>;
export const SunIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg></IconWrapper>;
export const MoonIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg></IconWrapper>;
export const ArrowLeftOnRectangleIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H5" /></svg></IconWrapper>;
export const ArrowUpOnSquareIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3v12" /></svg></IconWrapper>;
const WindowIconWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => (<div className="w-4 h-4">{children}</div>);
export const MinimizeIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14" /></svg></WindowIconWrapper>;
export const MaximizeIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 4.5h15v15h-15z" /></svg></WindowIconWrapper>;
export const RestoreIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.5 8.5h11v11h-11z M4.5 4.5h11v11h-11z" /></svg></WindowIconWrapper>;

// --- From FeatureIcons.tsx ---
export const FileCodeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const GitBranchIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 3v4a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3V3M6 21v-4a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v4M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" /></svg></IconWrapper>;
export const SparklesIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg></IconWrapper>;
export const EyeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639l4.368-7.28A1.012 1.012 0 0 1 7.105 4.5h9.79a1.012 1.012 0 0 1 .701.293l4.368 7.28c.15.25.228.538.228.828s-.078.578-.228.828l-4.368 7.28a1.012 1.012 0 0 1-.701.293h-9.79a1.012 1.012 0 0 1-.701-.293l-4.368-7.28Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></IconWrapper>;
export const MapIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 6.75V15m6-6v8.25m.5-10.5h-7a.5.5 0 0 0-.5.5v13.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V4.25a.5.5 0 0 0-.5-.5Z" /></svg></IconWrapper>;
export const BeakerIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c.139-.02.28-.032.427-.032.147 0 .288.012.427.032M5 14.5h14M14.25 3.104v5.714c0 .822-.394 1.573-.986 2.05l-2.014.915a2.25 2.25 0 0 0-.659 1.591v5.714m-3.468-18.222.01.001" /></svg></IconWrapper>;
export const CommandLineIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 7.5 3 11.25l3.75 3.75M17.25 7.5 21 11.25l-3.75 3.75" /></svg></IconWrapper>;
export const LockClosedIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg></IconWrapper>;
export const CodeBracketSquareIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.25 9.75 16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg></IconWrapper>;
export const PhotoIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg></IconWrapper>;
export const BellIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg></IconWrapper>;
export const ChartBarIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625Zm6.75-5.25c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V3.375Z" /></svg></IconWrapper>;
export const BugAntIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m15.182 16.318A4.5 4.5 0 0 0 18 12a4.5 4.5 0 0 0-3.818-4.318m-3.564 4.318a4.5 4.5 0 0 1 3.564 0M6 12a4.5 4.5 0 0 1 3.818-4.318M12 12a4.5 4.5 0 0 1-3.818-4.318m0 8.636a4.5 4.5 0 0 1 3.818 0M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Zm0 0a8.949 8.949 0 0 0 5.482-1.611m-10.964 0A8.949 8.949 0 0 1 12 21Zm0 0a8.949 8.949 0 0 0-5.482-1.611m10.964 0A8.949 8.949 0 0 0 12 21Zm-5.482 1.61a8.973 8.973 0 0 1-2.18-1.001m10.342 0a8.973 8.973 0 0 0-2.18-1.001m-6-1.611a8.973 8.973 0 0 1-2.18-1.001M18 12a8.973 8.973 0 0 0-2.18-1.001m-6 0a8.973 8.973 0 0 1-2.18-1.001M6 12a8.973 8.973 0 0 0-2.18-1.001m10.342 0a8.973 8.973 0 0 0-2.18-1.001M12 3a8.973 8.973 0 0 1 2.18 1.001m-4.36 0A8.973 8.973 0 0 1 12 3m0 18a8.973 8.973 0 0 0 2.18-1.001m-4.36 0A8.973 8.973 0 0 0 12 21Zm0-18a8.973 8.973 0 0 0-2.18-1.001m4.36 0A8.973 8.973 0 0 0 12 3Z" /></svg></IconWrapper>;
export const TerminalIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 7.5l3.75 3.75L6.75 15m6-7.5h4.5" /></svg></IconWrapper>;
export const ServerStackIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 20.25h12m-7.5-3.75v3.75m3.75-3.75v3.75M12 3c-5.12 0-9.25 4.13-9.25 9.25s4.13 9.25 9.25 9.25 9.25-4.13 9.25-9.25S17.12 3 12 3Z" /></svg></IconWrapper>;
export const CloudIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15a4.5 4.5 0 0 0 4.5 4.5H18a3.75 3.75 0 0 0 1.332-7.257 3 3 0 0 0-5.056-2.287 4.5 4.5 0 0 0-8.25-2.287 4.5 4.5 0 0 0-1.25 8.25Z" /></svg></IconWrapper>;
export const PaperAirplaneIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg></IconWrapper>;
export const ShieldCheckIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286Z" /></svg></IconWrapper>;
export const ArrowPathIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691V5.25a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75" /></svg></IconWrapper>;
export const RectangleGroupIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 7.125A2.25 2.25 0 0 1 4.5 4.875h15A2.25 2.25 0 0 1 21.75 7.125v10.5A2.25 2.25 0 0 1 19.5 19.875h-15A2.25 2.25 0 0 1 2.25 17.625v-10.5ZM11.25 4.875v10.5a2.25 2.25 0 0 1-2.25 2.25h-1.5a2.25 2.25 0 0 1-2.25-2.25v-10.5a2.25 2.25 0 0 1 2.25-2.25h1.5a2.25 2.25 0 0 1 2.25 2.25Z" /></svg></IconWrapper>;
export const MusicalNoteIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 9V4.5M9 9c0 .54.06.913.175 1.313M9 9H4.5M9.175 10.313C9.06 10.087 9 9.85 9 9.6V4.5a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v5.1a.75.75 0 0 1-.75.75h-.625a.75.75 0 0 1-.75-.75V9.75" /></svg></IconWrapper>;
export const VideoCameraIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9A2.25 2.25 0 0 0 13.5 5.25h-9A2.25 2.25 0 0 0 2.25 7.5v9A2.25 2.25 0 0 0 4.5 18.75Z" /></svg></IconWrapper>;
export const DocumentTextIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const PaintBrushIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></IconWrapper>;
export const PuzzlePieceIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.25 6.087c0-1.036-.84-1.875-1.875-1.875s-1.875.84-1.875 1.875v.563c-1.036 0-1.875.84-1.875 1.875v1.5c0 1.036.84 1.875 1.875 1.875h1.5c1.036 0 1.875-.84 1.875-1.875v-1.5c0-1.036-.84-1.875-1.875-1.875v-.563Zm-4.5 0v.563c-1.036 0-1.875.84-1.875 1.875v1.5c0 1.036.84 1.875 1.875 1.875h1.5c1.036 0 1.875-.84 1.875-1.875v-1.5c0-1.036-.84-1.875-1.875-1.875v-.563a1.875 1.875 0 0 0-3.75 0Z" /></svg></IconWrapper>;
export const MicrophoneIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m12 4.5v-1.5a6 6 0 0 0-12 0v1.5m12 0v-1.5a6 6 0 0 0-12 0v1.5m6 3.75a3 3 0 0 1-3-3V6.75a3 3 0 0 1 6 0v6a3 3 0 0 1-3 3Z" /></svg></IconWrapper>;
export const MailIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg></IconWrapper>;


// --- From CustomFeatureIcons.tsx ---
export const CommandCenterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 9V5l-7 7 7 7v-4.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 14.5V19l7-7-7-7v4.5" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"/></svg></IconWrapper>;
export const ProjectExplorerIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></IconWrapper>;
export const ConnectionsIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg></IconWrapper>;
export const CodeExplainerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><circle cx="12" cy="15" r="3"/><path d="M12 18v2"/></svg></IconWrapper>;
export const FeatureBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/><path d="M17 8.5l-5 2.5-5-2.5"/><path d="M12 17.5V14"/></svg></IconWrapper>;
export const CodeMigratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 22H5a2 2 0 01-2-2V4a2 2 0 012-2h5"/><path d="M14 2h5a2 2 0 012 2v16a2 2 0 01-2 2h-5"/><path d="M7 8h2m-2 4h4m-4 4h2"/></svg></IconWrapper>;
export const ThemeDesignerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 000 20z"/><path d="M22 12c-5.523 0-10-4.477-10-10"/></svg></IconWrapper>;
export const SnippetVaultIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"/><circle cx="12" cy="12" r="3"/><path d="M8 12h8m-4-4v8"/></svg></IconWrapper>;
export const DigitalWhiteboardIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><path d="M7 8h4m-4 4h8m-8 4h6" /></svg></IconWrapper>;
export const UnitTestGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4.5 12.5l3-3 3 3 6-6"/><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></IconWrapper>;
export const CommitGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></IconWrapper>;
export const GitLogAnalyzerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M6 3v18"/><path d="M18 3v18"/><path d="M12 3v18"/><circle cx="6" cy="6" r="3" fill="currentColor" opacity="0.4"/><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"/><circle cx="18" cy="18" r="3" fill="currentColor" opacity="0.4"/></svg></IconWrapper>;
export const ConcurrencyAnalyzerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M18 6l-6 6-6-6"/><path d="M18 18l-6-6-6 6"/></svg></IconWrapper>;
export const RegexSandboxIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M15 4l-8 16"/><path d="M22 12H2"/><path d="M10 3L6 21"/></svg></IconWrapper>;
export const PromptCraftPadIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></IconWrapper>;
export const CodeFormatterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h3m-3 6h3m-3 6h3M9 6h12M9 12h12M9 18h12"/></svg></IconWrapper>;
export const JsonTreeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 21v-4a2 2 0 012-2h8"/><path d="M10 17H5a2 2 0 01-2-2V5a2 2 0 012-2h8a2 2 0 012 2v2"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const XbrlConverterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M8 8l-4 4 4 4m8-8l4 4-4-4" strokeLinecap="round" strokeLinejoin="round"/><path d="M14.5 5.5l-5 13" strokeLinecap="round"/></svg></IconWrapper>;
export const CssGridEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></IconWrapper>;
export const SchemaDesignerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4 7V4h16v3"/><path d="M4 12h16"/><path d="M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const PwaManifestEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 22a10 10 0 100-20 10 10 0 000 20z"/><path d="M12 12l4-4m-4 8l-4-4"/></svg></IconWrapper>;
export const MarkdownSlidesIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 3H4a2 2 0 00-2 2v14a2 2 0 002 2h16a2 2 0 002-2V5a2 2 0 00-2-2z"/><path d="M9 16V8h6"/></svg></IconWrapper>;
export const ScreenshotToComponentIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><path d="M7 10l5-5 5 5m-5 8v-13"/></svg></IconWrapper>;
export const TypographyLabIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4 7V4h16v3"/><path d="M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const SvgPathEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 20.9l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 20.9z"/></svg></IconWrapper>;
export const StyleTransferIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69z"/><path d="M12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69zM12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69zM3.5 13.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5-3.806 8.5-8.5 8.5-8.5-3.806-8.5-8.5z"/></svg></IconWrapper>;
export const CodingChallengeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 8V6m0 12v-2m-4-6H6m12 0h-2m-2-4l-1.5-1.5M18 18l-1.5-1.5M6 18l1.5-1.5M6 6l1.5 1.5"/><circle cx="12" cy="12" r="3"/></svg></IconWrapper>;
export const CodeReviewBotIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 20V10m0 0V4m0 6h8m-8 0H4"/><path d="M12 20a8 8 0 100-16 8 8 0 000 16z"/></svg></IconWrapper>;
export const AiPullRequestAssistantIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><path d="M13 2v7h7"/><path d="M17.5 2.5l-2-2m2 2l2-2m-2 2v4"/></svg></IconWrapper>;
export const ChangelogGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8m8 4H8m-1-8l-2-2-2 2"/></svg></IconWrapper>;
export const CronJobBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></IconWrapper>;
export const AsyncCallTreeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h18M3 12h18M3 18h18"/><path d="M6 3v18m12-18v18"/></svg></IconWrapper>;
export const AudioToCodeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><path d="M12 19v4"/></svg></IconWrapper>;
export const CodeDiffGhostIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 16l-4-4 4-4m-8 8l4-4-4-4"/></svg></IconWrapper>;
export const CodeSpellCheckerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.72-1.72"/></svg></IconWrapper>;
export const ColorPaletteGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></IconWrapper>;
export const LogicFlowBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h18m-9 6H3m9 6H3"/><path d="M8 3v18m8-18v18"/></svg></IconWrapper>;
export const MetaTagEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><path d="M7 7h.01"/></svg></IconWrapper>;
export const NetworkVisualizerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M18 10h4V6h-4V2l-4 4 4 4zM6 14H2v4h4v4l4-4-4-4z"/><path d="M10 14v-4h4v4"/></svg></IconWrapper>;
export const ResponsiveTesterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M21 12a9 9 0 00-9-9m9 9a9 9 0 01-9 9"/></svg></IconWrapper>;
export const SassCompilerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21.168 18.168A10 10 0 118.832 2.832m12.336 15.336L8.832 2.832"/></svg></IconWrapper>;
export const ImageGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></IconWrapper>;
export const GithubIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fillRule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clipRule="evenodd" /></svg></IconWrapper>;
export const HuggingFaceIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.25,4.01A2.25,2.25,0,0,0,18,1.76H6A2.25,2.25,0,0,0,3.75,4.01V15.5A2.25,2.25,0,0,0,6,17.75H8.6l3.4,3.4,3.4-3.4H18a2.25,2.25,0,0,0,2.25-2.25V4.01ZM8.5,12.06a1,1,0,0,1,1,1,1,1,0,0,1-2,0,1,1,0,0,1,1-1Zm4.9,0a1,1,0,0,1,1,1,1,1,0,0,1-2,0,1,1,0,0,1,1-1Zm2.6,3.44a3.25,3.25,0,0,1-6,0,.75.75,0,0,1,1.5,0,1.75,1.75,0,0,0,3,0,.75.75,0,0,1,1.5,0Z"/></svg></IconWrapper>;
export const GcpIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2L2 7l10 5 10-5-10-5z" fill="#4285F4" stroke="none"/><path d="M2 12l10 5 10-5-10-5-10 5z" fill="#34A853" stroke="none" opacity="0.7"/><path d="M12 22L2 17l10-5 10 5-10 5z" fill="#FBBC05" stroke="none" opacity="0.7"/></svg></IconWrapper>;
`,
  'components/shared/.placeholder': ``,
  'components/shared/LoadingSpinner.tsx': `
import React from 'react';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);
`,
  'components/shared/Notification.tsx': `// This file is intentionally left blank. 
// The NotificationProvider in contexts/NotificationContext.tsx handles rendering.
// This simplifies the architecture by co-locating the rendering logic with the state management.
export {};
`,
  'components/shared/index.tsx': `import React, { useState, useEffect } from 'react';
import { marked } from 'marked';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);

interface MarkdownRendererProps {
    content: string;
}

export const MarkdownRenderer: React.FC<MarkdownRendererProps> = ({ content }) => {
    const [sanitizedHtml, setSanitizedHtml] = useState<string | TrustedHTML>('');

    useEffect(() => {
        const parse = async () => {
            if (content) {
                const html = await marked.parse(content);
                setSanitizedHtml(html);
            } else {
                setSanitizedHtml('');
            }
        };
        parse();
    }, [content]);

    return (
        <div
            className="prose prose-sm max-w-none prose-headings:text-text-primary prose-p:text-text-primary prose-strong:text-text-primary prose-code:text-primary prose-code:before:content-none prose-code:after:content-none prose-pre:bg-gray-50 prose-pre:border prose-pre:border-border prose-pre:p-4 prose-pre:m-0"
            dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
        />
    );
};
`,
  'components/vault/.placeholder': ``,
  'components/vault/CreateMasterPasswordModal.tsx': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState } from 'react';
import * as vaultService from '../../services/vaultService.ts';
import { LoadingSpinner } from '../shared/LoadingSpinner.tsx';

interface Props {
    onSuccess: () => void;
    onCancel: () => void;
}

export const CreateMasterPasswordModal: React.FC<Props> = ({ onSuccess, onCancel }) => {
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');

        if (password.length < 8) {
            setError('Password must be at least 8 characters long.');
            return;
        }
        if (password !== confirmPassword) {
            setError('Passwords do not match.');
            return;
        }

        setIsLoading(true);
        try {
            await vaultService.initializeVault(password);
            onSuccess();
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-md m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Create Master Password</h2>
                <p className="text-sm text-text-secondary mb-4">
                    This password encrypts your API keys locally on your device. It is never stored or sent anywhere.
                    <strong> If you forget it, your data will be unrecoverable.</strong>
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">New Master Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Confirm Password</label>
                        <input
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-100 rounded-md">Cancel</button>
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[120px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Create Vault'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
`,
  'components/vault/UnlockVaultModal.tsx': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState } from 'react';
import * as vaultService from '../../services/vaultService.ts';
import { LoadingSpinner } from '../shared/LoadingSpinner.tsx';

interface Props {
    onSuccess: () => void;
    onCancel: () => void;
}

export const UnlockVaultModal: React.FC<Props> = ({ onSuccess, onCancel }) => {
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            await vaultService.unlockVault(password);
            onSuccess();
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-sm m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Unlock Vault</h2>
                <p className="text-sm text-text-secondary mb-4">
                    Enter your Master Password to access your encrypted API keys for this session.
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">Master Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-100 rounded-md">Cancel</button>
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[100px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Unlock'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
`,
  'components/vault/VaultProvider.tsx': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState, useCallback, useMemo } from 'react';
import { VaultModalContext } from '../../contexts/VaultModalContext.tsx';
import { CreateMasterPasswordModal } from './CreateMasterPasswordModal.tsx';
import { UnlockVaultModal } from './UnlockVaultModal.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';

type PromiseResolver = (value: boolean) => void;

export const VaultProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const { dispatch } = useGlobalState();
    const [isCreateModalOpen, setCreateModalOpen] = useState(false);
    const [isUnlockModalOpen, setUnlockModalOpen] = useState(false);
    const [createPromise, setCreatePromise] = useState<{ resolve: PromiseResolver } | null>(null);
    const [unlockPromise, setUnlockPromise] = useState<{ resolve: PromiseResolver } | null>(null);

    const requestCreation = useCallback(() => {
        return new Promise<boolean>((resolve) => {
            setCreatePromise({ resolve });
            setCreateModalOpen(true);
        });
    }, []);

    const requestUnlock = useCallback(() => {
        return new Promise<boolean>((resolve) => {
            setUnlockPromise({ resolve });
            setUnlockModalOpen(true);
        });
    }, []);

    const handleCreateSuccess = () => {
        dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true, isUnlocked: true } });
        createPromise?.resolve(true);
        setCreateModalOpen(false);
        setCreatePromise(null);
    };

    const handleCreateCancel = () => {
        createPromise?.resolve(false);
        setCreateModalOpen(false);
        setCreatePromise(null);
    };

    const handleUnlockSuccess = () => {
        dispatch({ type: 'SET_VAULT_STATE', payload: { isUnlocked: true } });
        unlockPromise?.resolve(true);
        setUnlockModalOpen(false);
        setUnlockPromise(null);
    };

    const handleUnlockCancel = () => {
        unlockPromise?.resolve(false);
        setUnlockModalOpen(false);
        setUnlockPromise(null);
    };

    const contextValue = useMemo(() => ({ requestUnlock, requestCreation }), [requestUnlock, requestCreation]);

    return (
        <VaultModalContext.Provider value={contextValue}>
            {children}
            {isCreateModalOpen && (
                <CreateMasterPasswordModal
                    onSuccess={handleCreateSuccess}
                    onCancel={handleCreateCancel}
                />
            )}
            {isUnlockModalOpen && (
                <UnlockVaultModal
                    onSuccess={handleUnlockSuccess}
                    onCancel={handleUnlockCancel}
                />
            )}
        </VaultModalContext.Provider>
    );
};
`,
  'constants.tsx': `

import React from 'react';
import {
    CommandCenterIcon, CodeExplainerIcon, FeatureBuilderIcon, CodeMigratorIcon, ThemeDesignerIcon, SnippetVaultIcon,
    UnitTestGeneratorIcon, CommitGeneratorIcon, GitLogAnalyzerIcon, ConcurrencyAnalyzerIcon, RegexSandboxIcon,
    PromptCraftPadIcon, CodeFormatterIcon, JsonTreeIcon, CssGridEditorIcon, SchemaDesignerIcon, PwaManifestEditorIcon,
    MarkdownSlidesIcon, ScreenshotToComponentIcon, SvgPathEditorIcon, StyleTransferIcon, CodingChallengeIcon,
    CodeReviewBotIcon, ChangelogGeneratorIcon, CronJobBuilderIcon,
    AsyncCallTreeIcon, AudioToCodeIcon, CodeDiffGhostIcon, CodeSpellCheckerIcon, ColorPaletteGeneratorIcon, LogicFlowBuilderIcon,
    MetaTagEditorIcon, NetworkVisualizerIcon, ResponsiveTesterIcon, SassCompilerIcon, ImageGeneratorIcon, XbrlConverterIcon,
    DigitalWhiteboardIcon, TypographyLabIcon, AiPullRequestAssistantIcon, ProjectExplorerIcon,
    ServerStackIcon, DocumentTextIcon, ChartBarIcon, EyeIcon, PaperAirplaneIcon, CloudIcon, ShieldCheckIcon, CpuChipIcon, SparklesIcon,
    MailIcon, BugAntIcon, MagnifyingGlassIcon, RectangleGroupIcon, GcpIcon, HomeIcon, PhotoIcon
} from './components/icons.tsx';

export const CHROME_VIEW_IDS = ['features-list'] as const;

export const FEATURE_CATEGORIES = ['Core', 'AI Tools', 'Frontend', 'Testing', 'Database', 'Data', 'Productivity', 'Git', 'Local Dev', 'Performance & Auditing', 'Deployment & CI/CD', 'Security', 'Workflow', 'Cloud'] as const;
export type FeatureCategory = typeof FEATURE_CATEGORIES[number];

export type SlotCategory = FeatureCategory;
export const SLOTS: SlotCategory[] = ['Core', 'AI Tools', 'Frontend', 'Testing', 'Git', 'Productivity'];

interface RawFeature {
    id: string;
    name: string;
    description: string;
    icon: React.ReactNode;
    category: FeatureCategory;
}

export const RAW_FEATURES: RawFeature[] = [
    // --- Domain 1: Local Development & Testing Parity ---
    { id: "api-mock-generator", name: "API Mock Server", description: "Generate mock API data from a description and serve it locally.", icon: <ServerStackIcon />, category: "Local Dev" },
    { id: "env-manager", name: ".env Manager", description: "A graphical interface for creating and managing .env files.", icon: <DocumentTextIcon />, category: "Local Dev" },

    // --- Domain 2: Performance & Optimization Intelligence ---
    { id: "performance-profiler", name: "AI Performance Profiler", description: "Analyze runtime traces and bundle stats with AI-powered advice.", icon: <ChartBarIcon />, category: "Performance & Auditing" },
    { id: "a11y-auditor", name: "Accessibility Auditor", description: "Audit a live URL for accessibility issues and get AI-powered fixes.", icon: <EyeIcon />, category: "Performance & Auditing" },
    { id: "tech-debt-sonar", name: "Tech Debt Sonar", description: "Scan code to find code smells and areas with high complexity.", icon: <MagnifyingGlassIcon />, category: "Performance & Auditing" },

    // --- Domain 3: Deployment & CI/CD Automation ---
    { id: "ci-cd-generator", name: "AI CI/CD Architect", description: "Generate CI/CD config files from a natural language description.", icon: <PaperAirplaneIcon />, category: "Deployment & CI/CD" },
    { id: "deployment-preview", name: "Static Deployment Preview", description: "See a live preview of files generated by the AI Feature Builder.", icon: <CloudIcon />, category: "Deployment & CI/CD" },
    { id: "terraform-generator", name: "AI Terraform Generator", description: "Generate Terraform config from a description and cloud context.", icon: <CpuChipIcon />, category: "Deployment & CI/CD" },

    // --- Domain 4: Security & Vulnerability Scanning ---
    { id: "security-scanner", name: "AI Security Scanner", description: "Find common vulnerabilities in code with static analysis and AI.", icon: <ShieldCheckIcon />, category: "Security" },
    { id: "iam-policy-generator", name: "IAM Policy Generator", description: "Generate AWS or GCP IAM policies from a natural language description.", icon: <ShieldCheckIcon />, category: "Security" },
    { id: "iam-policy-visualizer", name: "GCP IAM Policy Visualizer", description: "Visually test and audit GCP IAM permissions in real-time across your resources.", icon: <GcpIcon />, category: "Cloud" },

    // --- Existing Features (Re-categorized and Ordered) ---
    { id: "ai-command-center", name: "AI Command Center", description: "Use natural language to navigate and control the toolkit.", icon: <CommandCenterIcon />, category: "Core" },
    { id: "project-explorer", name: "Project Explorer", description: "Manage and edit files from your connected repositories.", icon: <ProjectExplorerIcon />, category: "Core" },
    { id: "workspace-connector-hub", name: "Workspace Connector Hub", description: "Connect to services like Jira, Slack & GitHub to orchestrate actions with AI.", icon: <RectangleGroupIcon />, category: "Workflow" },
    { id: "linter-formatter", name: "AI Code Formatter", description: "AI-powered, real-time code formatting.", icon: <CodeFormatterIcon />, category: "Core" },
    { id: "json-tree-navigator", name: "JSON Tree Navigator", description: "Navigate large JSON objects as a collapsible tree.", icon: <JsonTreeIcon />, category: "Core" },
    
    { id: "ai-image-generator", name: "AI Image Generator", description: "Generate high-quality images from a text prompt.", icon: <ImageGeneratorIcon />, category: "AI Tools" },
    { id: "ai-code-explainer", name: "AI Code Explainer", description: "Get a structured analysis of code, including complexity.", icon: <CodeExplainerIcon />, category: "AI Tools" },
    { id: "ai-feature-builder", name: "AI Feature Builder", description: "Generate code, tests, and commit messages from a prompt or API schema.", icon: <FeatureBuilderIcon />, category: "AI Tools" },
    { id: "ai-personality-forge", name: "AI Personality Forge", description: "Architect, test, and save complex system prompts to create different 'AI personalities'.", icon: <SparklesIcon />, category: "AI Tools" },
    { id: "ai-code-migrator", name: "AI Code Migrator", description: "Translate code between languages & frameworks.", icon: <CodeMigratorIcon />, category: "AI Tools" },
    { id: "theme-designer", name: "AI Theme Designer", description: "Generate, fine-tune, and export UI color themes from a text description or image.", icon: <ThemeDesignerIcon />, category: "AI Tools" },
    { id: "one-click-refactor", name: "One-Click Refactor", description: "Apply common refactoring patterns to your code with a single click.", icon: <SparklesIcon />, category: "AI Tools" },
    { id: "ai-commit-generator", name: "AI Commit Message Generator", description: "Smart, conventional commits via AI.", icon: <CommitGeneratorIcon />, category: "AI Tools" },
    { id: "prompt-craft-pad", name: "Prompt Craft Pad", description: "Save, edit, and manage your custom AI prompts with variable testing.", icon: <PromptCraftPadIcon />, category: "AI Tools" },
    { id: "screenshot-to-component", name: "Screenshot to Component", description: "Turn UI screenshots into functional component code.", icon: <ScreenshotToComponentIcon />, category: "AI Tools" },
    { id: "ai-style-transfer", name: "AI Code Style Transfer", description: "Rewrite code to match a specific style guide.", icon: <StyleTransferIcon />, category: "AI Tools" },
    { id: "ai-coding-challenge", name: "AI Coding Challenge Generator", description: "Generate unique coding exercises.", icon: <CodingChallengeIcon />, category: "AI Tools" },
    { id: "code-review-bot", name: "AI Code Review Bot", description: "Get an automated code review with one-click refactoring.", icon: <CodeReviewBotIcon />, category: "AI Tools" },
    { id: "ai-pull-request-assistant", name: "AI Pull Request Assistant", description: "Generate a structured PR summary from code diffs and populate a full template.", icon: <AiPullRequestAssistantIcon />, category: "AI Tools" },
    { id: "pr-summary-generator", name: "PR Summary Generator", description: "Generate a structured PR summary from code diffs.", icon: <AiPullRequestAssistantIcon />, category: "AI Tools" },
    { id: "audio-to-code", name: "AI Audio-to-Code", description: "Speak your programming ideas and watch them turn into code.", icon: <AudioToCodeIcon />, category: "AI Tools" },
    
    { id: "css-grid-editor", name: "CSS Grid Visual Editor", description: "Drag-based layout builder for CSS Grid.", icon: <CssGridEditorIcon />, category: "Frontend" },
    { id: "pwa-manifest-editor", name: "PWA Manifest Editor", description: "Configure and preview Progressive Web App manifests with a home screen simulator.", icon: <PwaManifestEditorIcon />, category: "Frontend" },
    { id: "typography-lab", name: "Typography Lab", description: "Preview font pairings and get CSS import rules.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "font-preview-picker", name: "Font Preview Picker", description: "Preview custom text with different fonts.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "font-pairing-tool", name: "Font Pairing Tool", description: "Experiment with different font pairings for headings and body text.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "svg-path-editor", name: "SVG Path Editor", description: "Visually create and manipulate SVG path data with an interactive canvas.", icon: <SvgPathEditorIcon />, category: "Frontend" },
    { id: "color-palette-generator", name: "AI Color Palette Generator", description: "Pick a base color and let Gemini design a beautiful palette.", icon: <ColorPaletteGeneratorIcon />, category: "Frontend" },
    { id: "meta-tag-editor", name: "Meta Tag Editor", description: "Generate SEO/social media meta tags with a live social card preview.", icon: <MetaTagEditorIcon />, category: "Frontend" },
    { id: "responsive-tester", name: "Responsive Tester", description: "Preview your web pages at different screen sizes and custom resolutions.", icon: <ResponsiveTesterIcon />, category: "Frontend" },
    { id: "sass-scss-compiler", name: "SASS/SCSS Compiler", description: "A real-time SASS/SCSS to CSS compiler.", icon: <SassCompilerIcon />, category: "Frontend" },
    
    { id: "ai-unit-test-generator", name: "AI Unit Test Generator", description: "Generate unit tests from source code.", icon: <UnitTestGeneratorIcon />, category: "Testing" },
    { id: "bug-reproducer", name: "Bug Reproducer", description: "Paste a stack trace to automatically generate a failing unit test.", icon: <BugAntIcon />, category: "Testing" },
    { id: "worker-thread-debugger", name: "AI Concurrency Analyzer", description: "Analyze JS for Web Worker issues like race conditions.", icon: <ConcurrencyAnalyzerIcon />, category: "Testing" },
    { id: "regex-sandbox", name: "RegEx Sandbox", description: "Visually test regular expressions, generate them with AI, and inspect match groups.", icon: <RegexSandboxIcon />, category: "Testing" },
    { id: "async-call-tree-viewer", name: "Async Call Tree Viewer", description: "Visualize a tree of asynchronous function calls from JSON data.", icon: <AsyncCallTreeIcon />, category: "Testing" },
    { id: "code-spell-checker", name: "Code Spell Checker", description: "A spell checker that finds common typos in code.", icon: <CodeSpellCheckerIcon />, category: "Testing" },
    { id: "network-visualizer", name: "Network Visualizer", description: "Inspect network resources with a summary and visual waterfall chart.", icon: <NetworkVisualizerIcon />, category: "Testing" },
    
    { id: "visual-git-tree", name: "Visual Git Tree", description: "Visually trace your git commit history with an interactive graph and an AI-powered summary.", icon: <GitLogAnalyzerIcon />, category: "Git" },
    { id: "changelog-generator", name: "AI Changelog Generator", description: "Auto-build changelogs from raw git logs.", icon: <ChangelogGeneratorIcon />, category: "Git" },
    { id: "code-diff-ghost", name: "Code Diff Ghost", description: "Visualize code changes with a 'ghost typing' effect.", icon: <CodeDiffGhostIcon />, category: "Git" },
    
    { id: "cron-job-builder", name: "AI Cron Job Builder", description: "Visually tool to configure cron jobs, with AI.", icon: <CronJobBuilderIcon />, category: "Deployment & CI/CD" },
    
    { id: "portable-snippet-vault", name: "Snippet Vault", description: "Store, search, tag, and enhance reusable code snippets with AI.", icon: <SnippetVaultIcon />, category: "Productivity" },
    { id: "digital-whiteboard", name: "Digital Whiteboard", description: "Organize ideas with interactive sticky notes and get AI-powered summaries.", icon: <DigitalWhiteboardIcon />, category: "Productivity" },
    { id: "project-moodboard", name: "Project Moodboard", description: "A visual space to gather ideas, images, and notes.", icon: <PhotoIcon />, category: "Productivity" },
    { id: "markdown-slides-generator", name: "Markdown Slides", description: "Turn markdown into a fullscreen presentation with an interactive overlay.", icon: <MarkdownSlidesIcon />, category: "Productivity" },
    { id: "weekly-digest-generator", name: "Weekly Digest Generator", description: "Generate and send a weekly project summary email via Gmail.", icon: <MailIcon />, category: "Productivity" },
    { id: "gmail-addon-simulator", name: "Gmail Add-on Simulator", description: "A simulation of how contextual add-on scopes would work inside Gmail.", icon: <MailIcon />, category: "Productivity" },
    
    { id: "schema-designer", name: "Schema Designer", description: "Visually design a database schema with a drag-and-drop interface and SQL export.", icon: <SchemaDesignerIcon />, category: "Database" },
    { id: "xbrl-converter", name: "XBRL Converter", description: "Convert JSON data to a simplified XBRL-like XML format using AI.", icon: <XbrlConverterIcon />, category: "Data" },
    { id: "logic-flow-builder", name: "Logic Flow Builder", description: "A visual tool for building application logic flows.", icon: <LogicFlowBuilderIcon />, category: "Workflow" },
];

export const ALL_FEATURE_IDS = RAW_FEATURES.map(f => f.id);`,
  'contexts/.placeholder': ``,
  'contexts/GlobalStateContext.tsx': `import React, { createContext, useReducer, useContext, useEffect } from 'react';
import type { ViewType, AppUser, GitHubUser, FileNode } from '../types.ts';

// State shape
interface GlobalState {
  activeView: ViewType;
  viewProps: any;
  hiddenFeatures: string[];
  user: AppUser | null;
  githubUser: GitHubUser | null;
  projectFiles: FileNode | null;
  // Fix: Expand selectedRepo to include full_name and name for consistent usage across components
  selectedRepo: { owner: string; repo: string; full_name: string; name: string; } | null;
  vaultState: {
    isInitialized: boolean;
    isUnlocked: boolean;
  };
  isApiKeyMissing: boolean;
}

// Action types
type Action =
  | { type: 'SET_VIEW'; payload: { view: ViewType, props?: any } }
  | { type: 'TOGGLE_FEATURE_VISIBILITY'; payload: { featureId: string } }
  | { type: 'SET_APP_USER', payload: AppUser | null }
  | { type: 'SET_GITHUB_USER', payload: GitHubUser | null }
  | { type: 'LOAD_PROJECT_FILES'; payload: FileNode | null }
  // Fix: Expand selectedRepo payload to include full_name and name
  | { type: 'SET_SELECTED_REPO'; payload: { owner: string; repo: string; full_name: string; name: string; } | null }
  | { type: 'SET_VAULT_STATE'; payload: Partial<{ isInitialized: boolean, isUnlocked: boolean }> }
  | { type: 'SET_API_KEY_MISSING', payload: boolean };


const initialState: GlobalState = {
  activeView: 'project-explorer',
  viewProps: {},
  hiddenFeatures: [],
  user: null,
  githubUser: null,
  projectFiles: null,
  selectedRepo: null,
  vaultState: {
    isInitialized: false,
    isUnlocked: false,
  },
  isApiKeyMissing: false,
};

const reducer = (state: GlobalState, action: Action): GlobalState => {
  switch (action.type) {
    case 'SET_VIEW':
      return { ...state, activeView: action.payload.view, viewProps: action.payload.props || {} };
    case 'TOGGLE_FEATURE_VISIBILITY': {
        const { featureId } = action.payload;
        const isHidden = state.hiddenFeatures.includes(featureId);
        const newHiddenFeatures = isHidden
            ? state.hiddenFeatures.filter(id => id !== featureId)
            : [...state.hiddenFeatures, featureId];
        return { ...state, hiddenFeatures: newHiddenFeatures };
    }
    case 'SET_APP_USER':
        if (action.payload === null) { // User logged out
            return {
                ...initialState, // Reset to initial state on logout
                user: null,
            }
        }
        return { ...state, user: action.payload };
    case 'SET_GITHUB_USER':
        return {
            ...state,
            githubUser: action.payload,
             // Reset repo-specific data if disconnected
            selectedRepo: action.payload ? state.selectedRepo : null,
            projectFiles: action.payload ? state.projectFiles : null,
        }
    case 'LOAD_PROJECT_FILES':
      return { ...state, projectFiles: action.payload };
    case 'SET_SELECTED_REPO':
      return { ...state, selectedRepo: action.payload, projectFiles: null }; // Reset files on repo change
    case 'SET_VAULT_STATE':
        return {
            ...state,
            vaultState: { ...state.vaultState, ...action.payload },
        };
    case 'SET_API_KEY_MISSING':
        return { ...state, isApiKeyMissing: action.payload };
    default:
      return state;
  }
};

const GlobalStateContext = createContext<{
  state: GlobalState;
  dispatch: React.Dispatch<Action>;
}>({
  state: initialState,
  dispatch: () => null,
});

const LOCAL_STORAGE_KEY = 'devcore_snapshot';
const CONSENT_KEY = 'devcore_ls_consent';

export const GlobalStateProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const canPersist = (() => {
        try {
            return localStorage.getItem(CONSENT_KEY) === 'granted';
        } catch (e) {
            return false;
        }
    })();

    const [state, dispatch] = useReducer(reducer, initialState, (initial) => {
        if (!canPersist) return initial;
        
        try {
            const storedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedStateJSON) return initial;
            
            const storedState = JSON.parse(storedStateJSON);
            const hydratedState = { ...initial };

            // Hydrate state from local storage
            if (storedState.selectedRepo) hydratedState.selectedRepo = storedState.selectedRepo;
            if (storedState.activeView) hydratedState.activeView = storedState.activeView;
            if (storedState.viewProps) hydratedState.viewProps = storedState.viewProps;
            if (storedState.hiddenFeatures) hydratedState.hiddenFeatures = storedState.hiddenFeatures;
            
            return hydratedState;
        } catch (error) {
            console.error("Failed to parse state from localStorage", error);
            return initial;
        }
    });

    useEffect(() => {
        if (!canPersist) return;

        const handler = setTimeout(() => {
            try {
                const stateToSave = { 
                    selectedRepo: state.selectedRepo,
                    activeView: state.activeView,
                    viewProps: state.viewProps,
                    hiddenFeatures: state.hiddenFeatures, 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (error) {
                console.error("Failed to save state to localStorage", error);
            }
        }, 500);

        return () => clearTimeout(handler);
    }, [state, canPersist]);

    return (
        <GlobalStateContext.Provider value={{ state, dispatch }}>
            {children}
        </GlobalStateContext.Provider>
    );
};

export const useGlobalState = () => useContext(GlobalStateContext);`,
  'contexts/NotificationContext.tsx': `import React, { createContext, useContext, useState, useCallback } from 'react';

type NotificationType = 'success' | 'error' | 'info';

interface Notification {
  id: number;
  message: string;
  type: NotificationType;
}

interface NotificationContextType {
  addNotification: (message: string, type?: NotificationType) => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export const useNotification = () => {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotification must be used within a NotificationProvider');
  }
  return context;
};

export const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [notifications, setNotifications] = useState<Notification[]>([]);

  const addNotification = useCallback((message: string, type: NotificationType = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 4000);
  }, []);
  
  const typeStyles = {
    success: 'bg-emerald-500 border-emerald-600',
    error: 'bg-red-500 border-red-600',
    info: 'bg-sky-500 border-sky-600'
  };

  return (
    <NotificationContext.Provider value={{ addNotification }}>
      {children}
      <div className="fixed bottom-4 right-4 z-[100] space-y-2 w-full max-w-sm">
        {notifications.map(notification => (
           <div key={notification.id} role="alert" className={\`relative animate-pop-in shadow-lg rounded-lg text-white font-medium p-4 border-b-4 \${typeStyles[notification.type]}\`}>
               {notification.message}
           </div>
        ))}
      </div>
    </NotificationContext.Provider>
  );
};`,
  'contexts/OctokitContext.tsx': `import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import type { Octokit } from 'octokit';
import { initializeOctokit } from '../services/authService.ts';
import { getDecryptedCredential } from '../services/vaultService.ts';
import { useGlobalState } from './GlobalStateContext.tsx';
import { useVaultModal } from './VaultModalContext.tsx';
import { useNotification } from './NotificationContext.tsx';

interface OctokitContextType {
    octokit: Octokit | null;
    reinitialize: () => Promise<void>;
}

const OctokitContext = createContext<OctokitContextType | undefined>(undefined);

export const useOctokit = (): OctokitContextType => {
    const context = useContext(OctokitContext);
    if (!context) {
        throw new Error('useOctokit must be used within an OctokitProvider');
    }
    return context;
};

export const OctokitProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [octokit, setOctokit] = useState<Octokit | null>(null);
    const { state, dispatch } = useGlobalState();
    const { user, vaultState } = state;
    const { requestUnlock } = useVaultModal();
    const { addNotification } = useNotification();
    
    const initialize = useCallback(async () => {
        if (!user) {
            setOctokit(null);
            return;
        }

        let isVaultUnlocked = vaultState.isUnlocked;

        if (!isVaultUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) {
                setOctokit(null);
                return;
            }
        }

        try {
            const token = await getDecryptedCredential('github_pat');
            if (token) {
                const client = initializeOctokit(token);
                setOctokit(client);
            } else {
                setOctokit(null); // No token stored, so no client.
            }
        } catch (e) {
            if (e instanceof Error && e.message.includes('Decryption failed')) {
                 dispatch({ type: 'SET_VAULT_STATE', payload: { isUnlocked: false } });
            }
            addNotification('Failed to initialize GitHub client.', 'error');
            setOctokit(null);
        }

    }, [user, vaultState.isUnlocked, requestUnlock, addNotification, dispatch]);

    useEffect(() => {
        // Initialize when the user logs in or vault state changes to unlocked
        if (user && vaultState.isUnlocked) {
            initialize();
        } else {
            setOctokit(null);
        }
    }, [user, vaultState.isUnlocked, initialize]);

    return (
        <OctokitContext.Provider value={{ octokit, reinitialize: initialize }}>
            {children}
        </OctokitContext.Provider>
    );
};`,
  'contexts/VaultModalContext.tsx': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { createContext, useContext } from 'react';

interface VaultModalContextType {
    requestUnlock: () => Promise<boolean>;
    requestCreation: () => Promise<boolean>;
}

export const VaultModalContext = createContext<VaultModalContextType | undefined>(undefined);

export const useVaultModal = (): VaultModalContextType => {
    const context = useContext(VaultModalContext);
    if (!context) {
        throw new Error('useVaultModal must be used within a VaultProvider');
    }
    return context;
};
`,
  'githubService.ts': `import type { Octokit } from 'octokit';
import type { Repo, FileNode } from './types.ts';
import { logEvent, logError, measurePerformance } from './services/index.ts';

// --- Repository-Level Functions ---

/**
 * Fetches the repositories for the authenticated user.
 * @param octokit An authenticated Octokit instance.
 * @returns A promise that resolves to an array of Repo objects.
 */
export const getRepos = async (octokit: Octokit): Promise<Repo[]> => {
    return measurePerformance('getRepos', async () => {
        logEvent('getRepos_start');
        try {
            const { data } = await octokit.request('GET /user/repos', {
                type: 'owner',
                sort: 'updated',
                per_page: 100,
            });
            logEvent('getRepos_success', { count: data.length });
            return data as Repo[];
        } catch (error) {
            logError(error as Error, { context: 'getRepos' });
            throw new Error(\`Failed to fetch repositories: \${(error as Error).message}\`);
        }
    });
};

/**
 * Deletes a repository. This is a destructive action.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves when the deletion is complete.
 */
export const deleteRepo = async (octokit: Octokit, owner: string, repo: string): Promise<void> => {
     return measurePerformance('deleteRepo', async () => {
        logEvent('deleteRepo_start', { owner, repo });
        try {
            await octokit.request('DELETE /repos/{owner}/{repo}', {
                owner,
                repo,
            });
            logEvent('deleteRepo_success', { owner, repo });
        } catch (error) {
            logError(error as Error, { context: 'deleteRepo', owner, repo });
            throw new Error(\`Failed to delete repository: \${(error as Error).message}\`);
        }
    });
};

// --- File and Tree Functions ---

/**
 * Fetches the file tree for a repository recursively.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to the root FileNode of the repository.
 */
export const getRepoTree = async (octokit: Octokit, owner: string, repo: string): Promise<FileNode> => {
     return measurePerformance('getRepoTree', async () => {
        logEvent('getRepoTree_start', { owner, repo });
        try {
            const { data: repoData } = await octokit.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defaultBranch = repoData.default_branch;

            const { data: branch } = await octokit.request('GET /repos/{owner}/{repo}/branches/{branch}', {
                owner,
                repo,
                branch: defaultBranch,
            });
            const treeSha = branch.commit.commit.tree.sha;
            
            const { data: treeData } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
                owner,
                repo,
                tree_sha: treeSha,
                recursive: 'true',
            });

            const root: FileNode = { name: repo, type: 'folder', path: '', children: [] };
            
            treeData.tree.forEach((item: any) => {
                const pathParts = item.path.split('/');
                let currentNode = root;

                pathParts.forEach((part) => {
                    if (!currentNode.children) {
                        currentNode.children = [];
                    }
                    let childNode = currentNode.children.find(child => child.name === part);

                    if (!childNode) {
                        childNode = {
                            name: part,
                            path: item.path,
                            type: item.type === 'tree' ? 'folder' : 'file',
                        };
                        if(item.type === 'tree') childNode.children = [];
                        currentNode.children.push(childNode);
                    }
                    currentNode = childNode;
                });
            });

            logEvent('getRepoTree_success', { owner, repo, items: treeData.tree.length });
            return root;
        } catch (error) {
            logError(error as Error, { context: 'getRepoTree', owner, repo });
            throw new Error(\`Failed to fetch repository tree: \${(error as Error).message}\`);
        }
    });
};

/**
 * Fetches the content of a specific file from a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param path The full path to the file within the repository.
 * @returns A promise that resolves to the string content of the file.
 */
export const getFileContent = async (octokit: Octokit, owner: string, repo: string, path: string): Promise<string> => {
    return measurePerformance('getFileContent', async () => {
        logEvent('getFileContent_start', { owner, repo, path });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                owner,
                repo,
                path,
            });

            if (Array.isArray(data) || data.type !== 'file' || typeof data.content !== 'string') {
                 throw new Error("Path did not point to a valid file or content was missing.");
            }

            // The content is Base64 encoded, so we need to decode it.
            const content = atob(data.content);
            logEvent('getFileContent_success', { owner, repo, path });
            return content;
        } catch (error) {
             logError(error as Error, { context: 'getFileContent', owner, repo, path });
             throw new Error(\`Failed to fetch file content: \${(error as Error).message}\`);
        }
    });
};

// --- Commit and Branching Functions ---

/**
 * Commits one or more files to a repository in a single commit.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param files An array of file objects with path and content.
 * @param message The commit message.
 * @param branch The branch to commit to (defaults to 'main').
 * @returns A promise that resolves with the URL of the new commit.
 */
export const commitFiles = async (
    octokit: Octokit,
    owner: string,
    repo: string,
    files: { path: string; content: string }[],
    message: string,
    branch: string = 'main'
): Promise<string> => {
    return measurePerformance('commitFiles', async () => {
        logEvent('commitFiles_start', { owner, repo, fileCount: files.length, branch });

        try {
            // 1. Get the latest commit SHA and base tree SHA
            const { data: refData } = await octokit.request('GET /repos/{owner}/{repo}/git/ref/{ref}', {
                owner,
                repo,
                ref: \`heads/\${branch}\`,
            });
            const latestCommitSha = refData.object.sha;
            const { data: commitData } = await octokit.request('GET /repos/{owner}/{repo}/git/commits/{commit_sha}', {
                owner,
                repo,
                commit_sha: latestCommitSha,
            });
            const baseTreeSha = commitData.tree.sha;

            // 2. Create blobs for all new file contents
            const blobPromises = files.map(file =>
                octokit.request('POST /repos/{owner}/{repo}/git/blobs', {
                    owner,
                    repo,
                    content: file.content,
                    encoding: 'utf-8',
                })
            );
            const blobs = await Promise.all(blobPromises);
            
            // 3. Create the tree object
            const tree = blobs.map((blob, index) => ({
                path: files[index].path,
                mode: '100644' as const, // file mode
                type: 'blob' as const,
                sha: blob.data.sha,
            }));

            // 4. Create a new tree
            const { data: newTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
                owner,
                repo,
                base_tree: baseTreeSha,
                tree,
            });

            // 5. Create a new commit
            const { data: newCommit } = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
                owner,
                repo,
                message,
                tree: newTree.sha,
                parents: [latestCommitSha],
            });

            // 6. Update the branch reference (fast-forward)
            await octokit.request('PATCH /repos/{owner}/{repo}/git/refs/{ref}', {
                owner,
                repo,
                ref: \`heads/\${branch}\`,
                sha: newCommit.sha,
            });

            logEvent('commitFiles_success', { commitUrl: newCommit.html_url });
            return newCommit.html_url;

        } catch (error) {
            logError(error as Error, { context: 'commitFiles', owner, repo, branch });
            throw new Error(\`Failed to commit files: \${(error as Error).message}\`);
        }
    });
};`,
  'globals.d.ts': `// globals.d.ts
declare global {
  /**
   * Loads the Pyodide WebAssembly module.
   * @param config Optional configuration for Pyodide.
   */
  function loadPyodide(config?: { indexURL?: string }): Promise<any>;

  interface Window {
    google?: {
      accounts: {
        id: {
          disableAutoSelect: () => void;
        };
      };
    };
  }
}

// This export statement is required to make the file a module.
export {};`,
  'hooks/.placeholder': ``,
  'hooks/useAiPersonalities.ts': `import { useLocalStorage } from './useLocalStorage.ts';
import type { SystemPrompt } from '../types.ts';

const defaultPersonalities: SystemPrompt[] = [
    {
        id: '1',
        name: 'Default Reviewer',
        persona: 'You are a senior software engineer performing a code review. You are meticulous, helpful, and provide constructive feedback.',
        rules: ['Be clear and concise.', 'Provide code examples for suggestions.', 'Explain the "why" behind your suggestions.'],
        outputFormat: 'markdown',
        exampleIO: []
    },
    {
        id: '2',
        name: 'Sarcastic Senior Dev',
        persona: 'You are a cynical, sarcastic, but brilliant senior software engineer. Your feedback is brutally honest and often humorous, but always technically correct.',
        rules: ['Use a sarcastic tone.', 'Point out rookie mistakes without mercy.', 'Your code suggestions must be flawless.'],
        outputFormat: 'markdown',
        exampleIO: [
            {
                input: 'I wrote this function: \`function add(a,b){return a+b}\`',
                output: 'Wow, a function that adds two numbers. Groundbreaking. Did you consider that maybe, just maybe, you should add a semicolon at the end? \`function add(a, b) { return a + b; };\`'
            }
        ]
    }
];


/**
 * A custom hook to access the list of saved AI personalities.
 * @returns An array of SystemPrompt objects.
 */
export const useAiPersonalities = (): [SystemPrompt[], (value: SystemPrompt[] | ((val: SystemPrompt[]) => SystemPrompt[])) => void] => {
    const [personalities, setPersonalities] = useLocalStorage<SystemPrompt[]>('devcore_ai_personalities', defaultPersonalities);
    return [personalities, setPersonalities];
};`,
  'hooks/useLocalStorage.ts': `import { useState } from 'react';

export const useLocalStorage = <T,>(key: string, initialValue: T) => {
    const [storedValue, setStoredValue] = useState<T>(() => {
        try {
            const consent = window.localStorage.getItem('devcore_ls_consent');
            if (consent !== 'granted') return initialValue;

            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
        } catch (error) {
            console.error(\`Error reading localStorage key “\${key}”:\`, error);
            return initialValue;
        }
    });

    const setValue = (value: T | ((val: T) => T)) => {
        try {
            const consent = window.localStorage.getItem('devcore_ls_consent');
            if (consent !== 'granted') {
                // If consent is not granted, only update the in-memory state
                const valueToStore = value instanceof Function ? value(storedValue) : value;
                setStoredValue(valueToStore);
                return;
            };

            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
            console.error(\`Error setting localStorage key “\${key}”:\`, error);
        }
    };

    return [storedValue, setValue] as const;
};`,
  'hooks/useTheme.ts': `import { useEffect } from 'react';
import { useLocalStorage } from './useLocalStorage.ts';
import type { ThemeState, ColorTheme, Theme } from '../types.ts';

const defaultThemeState: ThemeState = {
    mode: 'light',
    customColors: null,
};

const applyColors = (colors: ColorTheme | null) => {
    const root = window.document.documentElement;
    if (colors) {
        root.style.setProperty('--color-primary', colors.primary);
        root.style.setProperty('--color-background', colors.background);
        root.style.setProperty('--color-surface', colors.surface);
        root.style.setProperty('--color-text-primary', colors.textPrimary);
        root.style.setProperty('--color-text-secondary', colors.textSecondary);
        root.style.setProperty('--color-text-on-primary', colors.textOnPrimary);
        root.style.setProperty('--color-border', colors.border);
        const rgb = colors.primary.match(/\\w\\w/g)?.map(x => parseInt(x, 16));
        if (rgb) {
             root.style.setProperty('--color-primary-rgb', rgb.join(', '));
        }
    } else {
        // Clear inline styles to revert to CSS-defined variables
        root.style.removeProperty('--color-primary');
        root.style.removeProperty('--color-background');
        root.style.removeProperty('--color-surface');
        root.style.removeProperty('--color-text-primary');
        root.style.removeProperty('--color-text-secondary');
        root.style.removeProperty('--color-text-on-primary');
        root.style.removeProperty('--color-border');
        root.style.removeProperty('--color-primary-rgb');
    }
}

export const useTheme = (): [ThemeState, () => void, (colors: ColorTheme, mode: Theme) => void, () => void] => {
    const [themeState, setThemeState] = useLocalStorage<ThemeState>('devcore_theme_state', defaultThemeState);

    useEffect(() => {
        const root = window.document.documentElement;
        root.classList.remove('light', 'dark');
        root.classList.add(themeState.mode);
        applyColors(themeState.customColors);
    }, [themeState]);

    const toggleTheme = () => {
        setThemeState(prev => ({
            ...prev,
            mode: prev.mode === 'light' ? 'dark' : 'light'
        }));
    };
    
    const applyCustomTheme = (colors: ColorTheme, mode: Theme) => {
        setThemeState({ mode, customColors: colors });
    };

    const clearCustomTheme = () => {
        // We keep the mode, but clear custom colors
        setThemeState(prev => ({ ...prev, customColors: null }));
    };

    return [themeState, toggleTheme, applyCustomTheme, clearCustomTheme];
};
`,
  'index.css': `@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --color-primary: #0047AB; /* Cobalt Blue */
  --color-primary-rgb: 0, 71, 171;
  --color-background: #F5F7FA; /* Light silver-blue */
  --color-surface: #FFFFFF;
  --color-text-primary: #111827; /* Gray 900 */
  --color-text-secondary: #6B7280; /* Gray 500 */
  --color-text-on-primary: #FFFFFF;
  --color-border: #E5E7EB; /* Gray 200 */
}

.dark {
  --color-primary: #38bdf8; /* sky-400 */
  --color-primary-rgb: 56, 189, 248;
  --color-background: #0f172a; /* slate-900 */
  --color-surface: #1e293b; /* slate-800 */
  --color-text-primary: #f8fafc; /* slate-50 */
  --color-text-secondary: #94a3b8; /* slate-400 */
  --color-text-on-primary: #0f172a; /* slate-900 */
  --color-border: #334155; /* slate-700 */
}

/* Custom global styles */
body {
  @apply bg-background text-text-primary transition-colors duration-300;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

html.dark body {
    background-image: none;
}


#root {
  position: relative;
  z-index: 1;
}

#root::before {
  content: 'CitiBank demo business inc';
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-family: theme('fontFamily.serif');
  font-size: clamp(2rem, 8vw, 6rem); /* Responsive font size */
  font-weight: bold;
  color: theme('colors.gold');
  opacity: 0.08;
  pointer-events: none;
  z-index: -1;
  white-space: nowrap;
}

h1, h2, h3, h4, h5, h6 {
  @apply font-serif text-text-primary;
}

h1 {
  @apply text-text-primary;
}

/* Update primary buttons for a professional look */
.btn-primary {
  @apply bg-primary text-text-on-primary font-bold rounded-md hover:opacity-90 transition-all disabled:opacity-50 shadow-md;
}

/* Custom scrollbars for the new light theme */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  @apply bg-gray-100 dark:bg-slate-800;
}
::-webkit-scrollbar-thumb {
  @apply bg-gray-400 dark:bg-slate-600 rounded;
}
::-webkit-scrollbar-thumb:hover {
  @apply bg-gray-500 dark:bg-slate-500;
}

/* Base transitions for interactive elements */
button, a, input, textarea, select {
  transition: all 0.2s ease-in-out;
}

/* Keyframe Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes shake {
  10%, 90% { transform: translateX(-1px); }
  20%, 80% { transform: translateX(2px); }
  30%, 50%, 70% { transform: translateX(-3px); }
  40%, 60% { transform: translateX(3px); }
}

@keyframes pop-in {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
.animate-shake { animation: shake 0.4s ease-in-out; }
.animate-pop-in { animation: pop-in 0.3s ease-out forwards; }

/* For hiding scrollbar but keeping functionality */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { 
  -ms-overflow-style: none; 
  scrollbar-width: none; 
  scroll-behavior: smooth;
}`,
  'index.html': `<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Citibank Demo Business Inc</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      html, body, #root {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
  <link rel="stylesheet" href="/index.css">
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "vite": "https://aistudiocdn.com/vite@^7.1.3",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "url": "https://aistudiocdn.com/url@^0.11.4",
    "marked": "https://aistudiocdn.com/marked@^16.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.15.0",
    "react-colorful": "https://aistudiocdn.com/react-colorful@^5.6.1",
    "mermaid": "https://aistudiocdn.com/mermaid@^11.10.1",
    "idb": "https://aistudiocdn.com/idb@^8.0.3",
    "axe-core": "https://aistudiocdn.com/axe-core@^4.10.3",
    "@tailwindcss/typography": "https://aistudiocdn.com/@tailwindcss/typography@^0.5.16",
    "diff": "https://aistudiocdn.com/diff@^8.0.2",
    "octokit": "https://aistudiocdn.com/octokit@^5.0.3",
    "jszip": "https://aistudiocdn.com/jszip@^3.10.1",
    "fs": "https://aistudiocdn.com/fs@^0.0.1-security"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script id="gsi-client" src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>`,
  'index.tsx': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.tsx';
import { GlobalStateProvider } from './contexts/GlobalStateContext.tsx';
import './index.css';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <GlobalStateProvider>
        <App />
    </GlobalStateProvider>
  </React.StrictMode>
);`,
  'metadata.json': `{
  "name": "as",
  "description": "A scaffolded project with a professional directory structure for building scalable and maintainable front-end applications.",
  "requestFramePermissions": []
}`,
  'package.json': `{
  "name": "devcore-ai-toolkit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "prebuild": "node --loader ts-node/esm ./scripts/generateSourceRegistry.ts",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.12.0",
    "axe-core": "^4.9.1",
    "diff": "^5.2.0",
    "idb": "^8.0.0",
    "jszip": "^3.10.1",
    "marked": "^13.0.2",
    "mermaid": "^10.9.1",
    "octokit": "^4.0.2",
    "react": "^18.2.0",
    "react-colorful": "^5.6.1",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@tailwindcss/typography": "^0.5.13",
    "@types/diff": "^5.2.1",
    "@types/jszip": "^3.4.1",
    "@types/marked": "^6.0.0",
    "@types/node": "^20.14.9",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "ts-node": "^10.9.2",
    "typescript": "^5.5.2",
    "vite": "^7.1.2"
  }
}`,
  'postcss.config.js': `export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
`,
  'public/.placeholder': ``,
  'public/mock-service-worker.js': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const MOCK_ROUTES = new Map();

self.addEventListener('install', (event) => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});

self.addEventListener('message', (event) => {
  if (event.data.type === 'SET_ROUTES') {
    const routes = event.data.routes || [];
    MOCK_ROUTES.clear();
    routes.forEach(route => {
        // Simple wildcard support
        const regex = new RegExp('^' + route.path.replace(/\\*/g, '.*') + '\$');
        MOCK_ROUTES.set(regex, {
            method: route.method,
            response: route.response,
        });
    });
  }
});

self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);
  const path = url.pathname;
  const method = event.request.method;

  for (const [routeRegex, routeInfo] of MOCK_ROUTES.entries()) {
    if (routeRegex.test(path) && routeInfo.method === method) {
      event.respondWith(
        new Response(JSON.stringify(routeInfo.response.body), {
          status: routeInfo.response.status,
          headers: { 'Content-Type': 'application/json', ...routeInfo.response.headers },
        })
      );
      return;
    }
  }

  // If no mock route matches, fall back to the network.
  event.respondWith(fetch(event.request));
});
`,
  'services/aiProviderState.ts': ``,
  'services/aiService.ts': `import { GoogleGenAI, Type, GenerateContentResponse, FunctionDeclaration, Modality } from "@google/genai";
import type { GeneratedFile, StructuredPrSummary, StructuredExplanation, ColorTheme, SemanticColorTheme, StructuredReview, SlideSummary, SecurityVulnerability, CodeSmell } from '../types.ts';
import { logError } from './telemetryService.ts';
import { getDecryptedCredential, isUnlocked, isVaultInitialized } from './vaultService.ts';

let ai: GoogleGenAI | null = null;

export async function isApiKeyConfigured(): Promise<boolean> {
    const envKey = process.env.GEMINI_API_KEY;
    if (envKey && envKey !== 'undefined' && envKey !== '') return true;
    
    // Only check vault if it's initialized and unlocked.
    if (await isVaultInitialized() && isUnlocked()) {
        try {
            const vaultKey = await getDecryptedCredential('gemini_api_key');
            return !!vaultKey;
        } catch (e) {
            console.error("Could not check for API key in vault:", e);
            return false;
        }
    }
    return false;
}

export async function initializeAiClient(): Promise<GoogleGenAI> {
    if (ai) return ai;

    let apiKey = process.env.GEMINI_API_KEY;
    
    if (!apiKey || apiKey === 'undefined' || apiKey === '') {
        try {
             apiKey = await getDecryptedCredential('gemini_api_key');
        } catch(e) {
             throw new Error("Vault is locked. Cannot retrieve API Key.");
        }
    }
    
    if (!apiKey) {
      throw new Error("Gemini API key not found. Please provide it when prompted.");
    }
    
    ai = new GoogleGenAI({ apiKey });
    return ai;
}

const getAi = async () => {
    if (!ai) {
        return await initializeAiClient();
    }
    return ai;
}


const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// --- Unified AI Helpers ---

export async function* streamContent(prompt: string | { parts: any[] }, systemInstruction: string, temperature = 0.5) {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContentStream({
            model: 'gemini-2.5-flash',
            contents: prompt as any,
            config: { systemInstruction, temperature }
        });

        for await (const chunk of response) {
            yield chunk.text;
        }
    } catch (error) {
        console.error("Error streaming from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        if (error instanceof Error) {
            yield \`An error occurred while communicating with the AI model: \${error.message}\`;
        } else {
            yield "An unknown error occurred while generating the response.";
        }
    }
}

export async function generateContent(prompt: string, systemInstruction: string, temperature = 0.5): Promise<string> {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: { systemInstruction, temperature }
        });
        return response.text;
    } catch (error) {
         console.error("Error generating content from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        throw error;
    }
}


export async function generateJson<T>(prompt: any, systemInstruction: string, schema: any, temperature = 0.2): Promise<T> {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
                systemInstruction,
                responseMimeType: "application/json",
                responseSchema: schema,
                temperature,
            }
        });
        return JSON.parse(response.text.trim());
    } catch (error) {
        console.error("Error generating JSON from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        throw error;
    }
}


// --- Unified Feature Functions (Streaming) ---

export const explainCodeStream = (code: string) => streamContent(
    \`Please explain the following code snippet:\\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an expert software engineer providing a clear, concise explanation of code."
);

export const generateRegExStream = (description: string) => streamContent(
    \`Generate a single valid JavaScript regex literal (e.g., /abc/gi) for the following description. Respond with ONLY the regex literal and nothing else: "\${description}"\`,
    "You are an expert in regular expressions. You only output valid JavaScript regex literals.",
    0.7
);

export const generateCommitMessageStream = (diff: string) => streamContent(
    \`Generate a conventional commit message for the following context of new files being added:\\n\\n\${diff}\`,
    "You are an expert programmer who writes excellent, conventional commit messages. The response should be only the commit message text.",
    0.8
);

export const generateUnitTestsStream = (code: string) => streamContent(
    \`Generate Vitest unit tests for this React component code:\\n\\n\\\`\\\`\\\`tsx\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are a software quality engineer specializing in writing comprehensive and clear unit tests using Vitest and React Testing Library.",
    0.6
);

export const formatCodeStream = (code: string) => streamContent(
    \`Format this code:\\n\\n\\\`\\\`\\\`javascript\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are a code formatter. Your only purpose is to format code. Respond with only the formatted code, enclosed in a single markdown block.",
    0.2
);

export const generateComponentFromImageStream = (base64Image: string) => streamContent(
    {
        parts: [
            { text: "Generate a single-file React component using Tailwind CSS that looks like this image. Respond with only the code in a markdown block." },
            { inlineData: { mimeType: 'image/png', data: base64Image } }
        ]
    },
    "You are an expert frontend developer specializing in React and Tailwind CSS. You create clean, functional components from screenshots."
);

export const transcribeAudioToCodeStream = (base64Audio: string, mimeType: string) => streamContent(
    {
        parts: [
            { text: "Transcribe my speech into a code snippet. If I describe a function or component, write it out." },
            { inlineData: { mimeType, data: base64Audio } }
        ]
    },
    "You are an expert programmer. You listen to a user's voice and transcribe their ideas into code."
);

export const transferCodeStyleStream = (args: { code: string, styleGuide: string }) => streamContent(
    \`Rewrite the following code to match the provided style guide.\\n\\nStyle Guide:\\n\${args.styleGuide}\\n\\nCode to rewrite:\\n\\\`\\\`\\\`\\n\${args.code}\\n\\\`\\\`\\\`\`,
    "You are an AI assistant that rewrites code to match a specific style guide. Respond with only the rewritten code in a markdown block.",
    0.3
);

export const generateCodingChallengeStream = (_: any) => streamContent(
    \`Generate a new, interesting coding challenge suitable for an intermediate developer. Include a clear problem description, one or two examples, and any constraints. Format it in markdown.\`,
    "You are an AI that creates unique and interesting coding challenges for software developers.",
    0.9
);

export const reviewCodeStream = (code: string, systemInstruction?: string) => streamContent(
    \`Please perform a detailed code review on the following code snippet. Identify potential bugs, suggest improvements for readability and performance, and point out any anti-patterns. Structure your feedback with clear headings.\\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    systemInstruction || "You are a senior software engineer performing a code review. You are meticulous, helpful, and provide constructive feedback.",
    0.6
);

export const generateChangelogFromLogStream = (log: string) => streamContent(
    \`Analyze this git log and create a changelog:\\n\\n\\\`\\\`\\\`\\n\${log}\\n\\\`\\\`\\\`\`,
    "You are a git expert and project manager. Analyze the provided git log and generate a clean, categorized changelog in Markdown format. Group changes under 'Features' and 'Fixes'.",
    0.6
);

export const enhanceSnippetStream = (code: string) => streamContent(
    \`Enhance this code snippet. Add comments, improve variable names, and refactor for clarity or performance if possible.\\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are a senior software engineer who excels at improving code. Respond with only the enhanced code in a markdown block.",
    0.5
);

export const summarizeNotesStream = (notes: string) => streamContent(
    \`Summarize these developer notes into a bulleted list of key points and action items:\\n\\n\${notes}\`,
    "You are a productivity assistant who is an expert at summarizing technical notes.",
    0.7
);

export const migrateCodeStream = (code: string, from: string, to: string) => streamContent(
    \`Translate this \${from} code to \${to}. Respond with only the translated code in a markdown block.\\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    \`You are an expert polyglot programmer who specializes in migrating code between languages and frameworks.\`,
    0.4
);

export const analyzeConcurrencyStream = (code: string) => streamContent(
    \`Analyze this JavaScript code for potential concurrency issues, especially related to Web Workers. Identify race conditions, deadlocks, or inefficient data passing.\\n\\n\\\`\\\`\\\`javascript\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an expert in JavaScript concurrency, web workers, and multi-threaded programming concepts.",
    0.6
);

export const debugErrorStream = (error: Error) => streamContent(
    \`I encountered an error in my React application. Here are the details:\\n    \\n    Message: \${error.message}\\n    \\n    Stack Trace:\\n    \${error.stack}\\n    \\n    Please analyze this error. Provide a brief explanation of the likely cause, followed by a bulleted list of potential solutions or debugging steps. Structure your response in clear, concise markdown.\`,
    "You are an expert software engineer specializing in debugging React applications. You provide clear, actionable advice to help developers solve errors."
);

export const convertJsonToXbrlStream = (json: string) => streamContent(
    \`Convert the following JSON to a simplified, XBRL-like XML format. Use meaningful tags based on the JSON keys. The root element should be <xbrl>. Do not include XML declarations or namespaces.\\n\\nJSON:\\n\${json}\`,
    "You are an expert in data formats who converts JSON to clean, XBRL-like XML."
);

// --- New Streaming Functions ---

export const refactorForPerformance = (code: string) => streamContent(
    \`Refactor the following code for maximum performance. Focus on algorithmic efficiency, efficient data structures, and avoiding unnecessary computations. Respond with only the refactored code in a markdown block.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an expert software engineer specializing in code performance optimization."
);

export const refactorForReadability = (code: string) => streamContent(
    \`Refactor the following code for maximum readability. Focus on clear variable names, breaking down complex functions, and adding helpful comments. Respond with only the refactored code in a markdown block.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an expert software engineer who writes exceptionally clean and readable code."
);

export const convertToFunctionalComponent = (classComponent: string) => streamContent(
    \`Convert the following React class component to a functional component using hooks (useState, useEffect, etc.). Ensure all lifecycle methods are correctly mapped. Respond with only the refactored code in a markdown block.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${classComponent}\\n\\\`\\\`\\\`\`,
    "You are a React expert specializing in modernizing codebases by converting class components to functional components with hooks."
);

export const generateJsDoc = (code: string) => streamContent(
    \`Generate a complete JSDoc block for the following function or component. Include descriptions for the function, its parameters, and what it returns. Respond with only the JSDoc block and the original function.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an AI assistant that writes comprehensive and accurate JSDoc documentation."
);

export const translateComments = (code: string, targetLanguage: string) => streamContent(
    \`Translate only the code comments in the following snippet to \${targetLanguage}. Do not alter the code itself. Respond with the full code snippet including the translated comments.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an AI assistant that translates code comments into different languages without changing any of the code."
);

export const generateDockerfile = (framework: string) => streamContent(
    \`Generate a basic, multi-stage Dockerfile for a \${framework} project. The Dockerfile should be production-ready, including build and serve stages. Respond with only the Dockerfile content in a markdown block.\`,
    "You are a DevOps expert specializing in containerization with Docker."
);

export const convertCssToTailwind = (css: string) => streamContent(
    \`Convert the following CSS code to Tailwind CSS utility classes. Provide the equivalent HTML structure with the Tailwind classes. Respond with only the HTML in a markdown block.\\n\\nCSS:\\n\\\`\\\`\\\`css\\n\${css}\\n\\\`\\\`\\\`\`,
    "You are an expert in Tailwind CSS and modern CSS practices."
);

export const applySpecificRefactor = (code: string, instruction: string) => streamContent(
    \`Apply this specific refactoring instruction to the code: "\${instruction}". Respond with only the complete, refactored code in a markdown block.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an AI assistant that precisely applies refactoring instructions to code."
);

export const generateBugReproductionTestStream = (stackTrace: string, context?: string) => streamContent(
    \`Generate a minimal, runnable unit test (using Vitest) that reproduces the bug described by the following stack trace. Respond with only the code in a markdown block.\\n\\nStack Trace:\\n\${stackTrace}\\n\\n\${context ? \`Additional Context:\\n\${context}\` : ''}\`,
    "You are a senior software engineer specializing in debugging and automated testing. You create concise, effective unit tests to reproduce bugs."
);

export const generateIamPolicyStream = (description: string, platform: 'aws' | 'gcp') => streamContent(
    \`Generate a valid \${platform.toUpperCase()} IAM policy in JSON format based on this description: "\${description}". Respond with only the JSON policy in a markdown block.\`,
    "You are a cloud security expert specializing in IAM policies for AWS and GCP."
);


// --- Simple Generate Content ---
export const generatePipelineCode = (flow: string): Promise<string> => generateContent(\`Based on the following described workflow, generate a single asynchronous JavaScript function that orchestrates the steps. Use placeholder functions for the actual tool logic. The workflow is: \${flow}\`, "You are an expert software architect who writes clean, asynchronous JavaScript code to orchestrate complex workflows based on a description.", 0.5);

export const generateCiCdConfig = (platform: string, description: string): Promise<string> => generateContent(
    \`Generate a CI/CD configuration file for \${platform} based on this description: "\${description}". Respond with only the YAML/config file content inside a markdown block.\`,
    "You are a DevOps expert specializing in CI/CD pipelines."
);

export const analyzePerformanceTrace = (trace: object): Promise<string> => generateContent(
    \`Analyze the following performance trace data and provide optimization suggestions in markdown format. Data: \${JSON.stringify(trace, null, 2)}\`,
    "You are an expert performance engineer."
);

export const suggestA11yFix = (issue: object): Promise<string> => generateContent(
    \`Explain this accessibility issue and suggest a code fix in markdown. Issue: \${JSON.stringify(issue, null, 2)}\`,
    "You are an expert in web accessibility (a11y)."
);

export const createApiDocumentation = (apiCode: string): Promise<string> => generateContent(
    \`Generate Markdown documentation for the following API endpoint code. Include the endpoint, HTTP method, parameters, and example request/response.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${apiCode}\\n\\\`\\\`\\\`\`,
    "You are a technical writer who creates clear and concise API documentation."
);

export const jsonToTypescriptInterface = (json: string): Promise<string> => generateContent(
    \`Generate a TypeScript interface from this JSON object. Respond with only the TypeScript code in a markdown block.\\n\\nJSON:\\n\${json}\`,
    "You are an expert in TypeScript and data modeling."
);

export const suggestAlternativeLibraries = (code: string): Promise<string> => generateContent(
    \`Analyze the following code, particularly its import statements and common patterns (like date manipulation). Suggest modern, more efficient library alternatives where applicable (e.g., suggest 'date-fns' or 'dayjs' over 'moment.js'). Explain why.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are a senior software engineer with deep knowledge of the JavaScript ecosystem."
);

export const explainRegex = (regex: string): Promise<string> => generateContent(
    \`Provide a step-by-step explanation of what each part of this regular expression does: \\\`\${regex}\\\`\`,
    "You are an expert in regular expressions who can explain complex patterns simply."
);

export const generateMermaidJs = (code: string): Promise<string> => generateContent(
    \`Generate a Mermaid.js flowchart string that represents the logic of the following code. Respond with only the Mermaid.js code in a markdown block (e.g., \\\`\\\`\\\`mermaid\\n...\\n\\\`\\\`\\\`).\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`,
    "You are an expert in code analysis and can visualize logic flows using Mermaid.js."
);

export const generateWeeklyDigest = (commitLogs: string, telemetryData: object): Promise<string> => generateContent(
    \`Generate a concise, professional weekly summary email in HTML format based on the following data.
    
    Commit Logs:
    \\\`\\\`\\\`
    \${commitLogs}
    \\\`\\\`\\\`
    
    Performance Telemetry:
    \\\`\\\`\\\`json
    \${JSON.stringify(telemetryData, null, 2)}
    \\\`\\\`\\\`
    
    The email should have sections for "New Features", "Bug Fixes", and "Performance Notes". It should be visually clean and easy to read.\`,
    "You are an AI assistant that generates weekly engineering progress reports in HTML format."
);

export const generateTechnicalSpecFromDiff = (diff: string, summary: StructuredPrSummary): Promise<string> => generateContent(
    \`Generate a comprehensive technical specification document in Markdown format based on the following pull request information.

The spec should include the following sections:
- **Problem:** A brief description of the issue being addressed.
- **Solution:** A detailed explanation of the changes made.
- **Technical Details:** An overview of the implementation, including any new functions, components, or patterns.
- **Impact:** How this change affects other parts of the application.

**PR Title:** \${summary.title}
**PR Summary:** \${summary.summary}

**Code Diff:**
\\\`\\\`\\\`diff
\${diff}
\\\`\\\`\\\`
\`,
    "You are an expert programmer who writes excellent, clear, and comprehensive technical specification documents from pull request data."
);

// --- STRUCTURED JSON ---

export const explainCodeStructured = async (code: string): Promise<StructuredExplanation> => {
    const systemInstruction = "You are an expert software engineer providing a structured analysis of a code snippet. In the summary, identify any imported dependencies and explain their purpose within the code.";
    const prompt = \`Analyze this code: \\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`;
    const schema = { type: Type.OBJECT, properties: { summary: { type: Type.STRING }, lineByLine: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { lines: { type: Type.STRING }, explanation: { type: Type.STRING } }, required: ["lines", "explanation"] } }, complexity: { type: Type.OBJECT, properties: { time: { type: Type.STRING }, space: { type: Type.STRING } }, required: ["time", "space"] }, suggestions: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["summary", "lineByLine", "complexity", "suggestions"] };
    return generateJson(prompt, systemInstruction, schema);
}

export const generateThemeFromDescription = async (description: string): Promise<ColorTheme> => {
    const systemInstruction = "You are a UI/UX design expert specializing in color theory. Generate a color theme based on the user's description. Provide hex codes for each color.";
    const prompt = \`Generate a color theme for: "\${description}"\`;
    const schema = { type: Type.OBJECT, properties: { primary: { type: Type.STRING }, background: { type: Type.STRING }, surface: { type: Type.STRING }, textPrimary: { type: Type.STRING }, textSecondary: { type: Type.STRING }, textOnPrimary: { type: Type.STRING }, border: { type: Type.STRING } }, required: ["primary", "background", "surface", "textPrimary", "textSecondary", "textOnPrimary", "border"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateSemanticTheme = (prompt: { parts: any[] }): Promise<SemanticColorTheme> => {
    const systemInstruction = \`You are a world-class UI/UX designer with an expert understanding of color theory, accessibility, and branding.
    Your task is to generate a comprehensive, semantically named color theme from a user's prompt (which could be text or an image).
    - Determine if the theme should be 'light' or 'dark' mode.
    - Palette colors should be harmonious and versatile.
    - Theme colors must be derived from the palette and assigned to specific UI roles (background, text, border, etc.).
    - 'textOnPrimary' MUST have a high contrast ratio against 'primary'.
    - You MUST calculate the WCAG 2.1 contrast ratio for key text/background pairs and provide a score (AAA, AA, or Fail).
    - Provide creative, evocative names for each color (e.g., "Midnight Blue", "Dune Sand").\`;

    const colorObjectSchema = {
        type: Type.OBJECT,
        properties: {
            value: { type: Type.STRING, description: "The hex code of the color, e.g., #RRGGBB" },
            name: { type: Type.STRING, description: "A creative, evocative name for the color." }
        },
        required: ["value", "name"]
    };

    const accessibilityCheckSchema = {
        type: Type.OBJECT,
        properties: {
            ratio: { type: Type.NUMBER, description: "The calculated contrast ratio." },
            score: { type: Type.STRING, enum: ["AAA", "AA", "Fail"], description: "The WCAG 2.1 accessibility score." }
        },
        required: ["ratio", "score"]
    };

    const schema = {
        type: Type.OBJECT,
        properties: {
            mode: {
                type: Type.STRING, enum: ["light", "dark"],
                description: "The recommended UI mode for this theme, 'light' or 'dark'."
            },
            palette: {
                type: Type.OBJECT,
                description: "A harmonious 4-color palette extracted from the prompt.",
                properties: {
                    primary: colorObjectSchema,
                    secondary: colorObjectSchema,
                    accent: colorObjectSchema,
                    neutral: colorObjectSchema,
                },
                required: ["primary", "secondary", "accent", "neutral"]
            },
            theme: {
                type: Type.OBJECT,
                description: "Specific color assignments for UI elements, derived from the palette.",
                properties: {
                    background: colorObjectSchema,
                    surface: colorObjectSchema,
                    textPrimary: colorObjectSchema,
                    textSecondary: colorObjectSchema,
                    textOnPrimary: colorObjectSchema,
                    border: colorObjectSchema,
                },
                required: ["background", "surface", "textPrimary", "textSecondary", "textOnPrimary", "border"]
            },
            accessibility: {
                type: Type.OBJECT,
                description: "WCAG 2.1 contrast ratio checks for common text/background pairings.",
                properties: {
                    primaryOnSurface: accessibilityCheckSchema,
                    textPrimaryOnSurface: accessibilityCheckSchema,
                    textSecondaryOnSurface: accessibilityCheckSchema,
                    textOnPrimaryOnPrimary: accessibilityCheckSchema,
                },
                required: ["primaryOnSurface", "textPrimaryOnSurface", "textSecondaryOnSurface", "textOnPrimaryOnPrimary"]
            }
        },
        required: ["mode", "palette", "theme", "accessibility"]
    };
    return generateJson(prompt, systemInstruction, schema);
};


export const generatePrSummaryStructured = (diff: string): Promise<StructuredPrSummary> => {
    const systemInstruction = "You are an expert programmer who writes excellent PR summaries.";
    const prompt = \`Generate a PR summary for the following diff:\\n\\n\\\`\\\`\\\`diff\\n\${diff}\\n\\\`\\\`\\\`\`;
    const schema = { type: Type.OBJECT, properties: { title: { type: Type.STRING }, summary: { type: Type.STRING }, changes: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["title", "summary", "changes"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateFeature = (prompt: string, framework: string, styling: string): Promise<GeneratedFile[]> => {
    const systemInstruction = \`You are an AI that generates complete, production-ready components. Create all necessary files for the requested framework and styling option.
    IMPORTANT: When the user's prompt is about maps, location, addresses, or stores, you MUST use the Google Maps JavaScript API. Generate a component that accepts an 'apiKey' prop and uses it to load the Maps script.\`;
    const userPrompt = \`Generate the files for a \${framework} component using \${styling} for the following feature request: "\${prompt}". Make sure to include a .tsx component file.\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(userPrompt, systemInstruction, schema);
};

export const generateFullStackFeature = (prompt: string, framework: string, styling: string): Promise<GeneratedFile[]> => {
    const systemInstruction = \`You are an AI that generates complete, production-ready full-stack features.
    You must generate three files:
    1. A frontend \${framework} component using \${styling}. File path should be 'Component.tsx'.
    2. A backend Google Cloud Function in Node.js. File path should be a simple HTTP-triggered function.
    3. Firestore Security Rules that allow public reads but only authenticated writes. File path should be 'firestore.rules'.
    Ensure the frontend component knows how to call the cloud function.
    IMPORTANT: When the user's prompt is about maps, location, addresses, or stores, you MUST prioritize using the Google Maps JavaScript API in the frontend component. Generate a component that accepts an 'apiKey' prop and uses it to load the Maps script.\`;
    const userPrompt = \`Generate a full-stack feature for: "\${prompt}"\`;
    const schema = {
        type: Type.ARRAY,
        items: {
            type: Type.OBJECT,
            properties: {
                filePath: { type: Type.STRING, enum: ['Component.tsx', 'functions/index.js', 'firestore.rules'] },
                content: { type: Type.STRING },
                description: { type: Type.STRING }
            },
            required: ["filePath", "content", "description"]
        }
    };
    return generateJson(userPrompt, systemInstruction, schema);
};

export interface CronParts { minute: string; hour: string; dayOfMonth: string; month: string; dayOfWeek: string; }
export const generateCronFromDescription = (description: string): Promise<CronParts> => {
    const systemInstruction = "You are an expert in cron expressions. Convert the user's description into a valid cron expression parts.";
    const prompt = \`Convert this schedule to a cron expression: "\${description}"\`;
    const schema = { type: Type.OBJECT, properties: { minute: { type: Type.STRING }, hour: { type: Type.STRING }, dayOfMonth: { type: Type.STRING }, month: { type: Type.STRING }, dayOfWeek: { type: Type.STRING } }, required: ["minute", "hour", "dayOfMonth", "month", "dayOfWeek"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateColorPalette = (baseColor: string): Promise<{ colors: string[] }> => {
    const systemInstruction = "You are a color theory expert. Generate a 6-color palette based on the given base color.";
    const prompt = \`Generate a harmonious 6-color palette based on the color \${baseColor}.\`;
    const schema = { type: Type.OBJECT, properties: { colors: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["colors"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateMockData = (description: string, count: number): Promise<object[]> => {
    const systemInstruction = "You are an expert data scientist who creates realistic mock data based on a schema description. You must respond with only a valid JSON array of objects.";
    const prompt = \`Generate an array of \${count} mock data objects based on the following schema description. Respond with only the JSON array.\\n\\nSchema: "\${description}"\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: {} }}; // Freeform objects
    return generateJson(prompt, systemInstruction, schema, 0.8);
};

export const analyzeCodeForVulnerabilities = (code: string): Promise<SecurityVulnerability[]> => {
    const systemInstruction = "You are an expert security engineer. Analyze the code for vulnerabilities. For each vulnerability, provide a structured response including a potential cURL command or code snippet to demonstrate the exploit.";
    const prompt = \`Analyze this code for security issues like XSS, injection, hardcoded secrets, etc. Provide detailed explanations, mitigation advice, and an exploit suggestion.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`;
    const schema = {
        type: Type.ARRAY,
        items: {
            type: Type.OBJECT,
            properties: {
                vulnerability: { type: Type.STRING },
                severity: { type: Type.STRING, enum: ['Critical', 'High', 'Medium', 'Low', 'Informational'] },
                description: { type: Type.STRING },
                mitigation: { type: Type.STRING },
                exploitSuggestion: { type: Type.STRING, description: "A cURL command, code snippet, or description of how to exploit the vulnerability." }
            },
            required: ['vulnerability', 'severity', 'description', 'mitigation', 'exploitSuggestion']
        }
    };
    return generateJson(prompt, systemInstruction, schema);
};

export const sqlToApiEndpoints = (schema: string, framework: 'express' | 'fastify'): Promise<GeneratedFile[]> => {
    const systemInstruction = "You are an expert backend developer who generates boilerplate CRUD API endpoints from a SQL schema.";
    const prompt = \`Generate boilerplate CRUD API endpoint files for a \${framework} server based on the following SQL table schema. Create separate files for routes, controllers, and models.\\n\\nSQL:\\n\\\`\\\`\\\`sql\\n\${schema}\\n\\\`\\\`\\\`\`;
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(prompt, systemInstruction, filesSchema);
};

export const detectCodeSmells = (code: string): Promise<CodeSmell[]> => {
    const systemInstruction = "You are an expert software engineer who identifies code smells like long methods, large classes, feature envy, etc.";
    const prompt = \`Analyze the following code for code smells and provide explanations.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { smell: { type: Type.STRING }, line: { type: Type.INTEGER }, explanation: { type: Type.STRING } }, required: ["smell", "line", "explanation"] } };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateTagsForCode = (code: string): Promise<string[]> => {
    const systemInstruction = "You are an AI assistant that analyzes code and suggests relevant tags.";
    const prompt = \`Generate 3-5 relevant, single-word, lowercase tags for this code snippet to help categorize it. Respond with only a JSON array of strings.\\n\\nCode:\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`;
    const schema = { type: Type.ARRAY, items: { type: Type.STRING } };
    return generateJson(prompt, systemInstruction, schema);
};

export const reviewCodeStructured = (code: string): Promise<StructuredReview> => {
    const systemInstruction = "You are a senior software engineer performing a meticulous code review. Provide a summary and a list of specific, actionable suggestions for improvement.";
    const prompt = \`Review this code and provide structured feedback:\\n\\n\\\`\\\`\\\`\\n\${code}\\n\\\`\\\`\\\`\`;
    const schema = {
        type: Type.OBJECT,
        properties: {
            summary: { type: Type.STRING, description: "A high-level summary of the code quality, identifying the main issues." },
            suggestions: {
                type: Type.ARRAY,
                items: {
                    type: Type.OBJECT,
                    properties: {
                        suggestion: { type: Type.STRING, description: "A concise description of the suggested change." },
                        codeBlock: { type: Type.STRING, description: "The exact block of code that should be replaced." },
                        explanation: { type: Type.STRING, description: "Why the change is recommended (e.g., performance, readability)." }
                    },
                    required: ["suggestion", "codeBlock", "explanation"]
                }
            }
        },
        required: ["summary", "suggestions"]
    };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateClientFromApiSchema = (schema: string, framework: string): Promise<GeneratedFile[]> => {
    const systemInstruction = "You are an expert full-stack developer. Generate client-side code from an API schema.";
    const prompt = \`Generate all necessary files for a \${framework} client based on the following OpenAPI/GraphQL schema. This should include data-fetching hooks, type definitions, and basic display components.\\n\\nSchema:\\n\\\`\\\`\\\`\\n\${schema}\\n\\\`\\\`\\\`\`;
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(prompt, systemInstruction, filesSchema);
};

export const generateTerraformConfig = (cloud: 'aws' | 'gcp', description: string, context?: string): Promise<string> => {
    const systemInstruction = \`You are a DevOps expert specializing in Terraform. Generate a complete .tf file based on the user's description.\`;
    const prompt = \`Generate a Terraform configuration for \${cloud}.
    Description: "\${description}"
    \${context ? \`\\n\\nCloud Context (e.g., existing resources):\\n\${context}\` : ''}
    Respond with only the HCL code in a markdown block.\`;
    return generateContent(prompt, systemInstruction);
};


// --- FUNCTION CALLING ---
export interface CommandResponse { text: string; functionCalls?: { name: string; args: any; }[]; }
export const getInferenceFunction = async (prompt: string, functionDeclarations: FunctionDeclaration[], knowledgeBase: string): Promise<CommandResponse> => {
    try {
        const aiClient = await getAi();
        const response: GenerateContentResponse = await aiClient.models.generateContent({ model: "gemini-2.5-flash", contents: prompt, config: { systemInstruction: \`You are a helpful assistant for a developer tool. You must decide which function to call to satisfy the user's request, based on your knowledge base. If no specific tool seems appropriate, respond with text.\\n\\nKnowledge Base:\\n\${knowledgeBase}\`, tools: [{ functionDeclarations }] } });
        const functionCalls: { name: string, args: any }[] = [];
        const parts = response.candidates?.[0]?.content?.parts ?? [];
        for (const part of parts) { if (part.functionCall) { functionCalls.push({ name: part.functionCall.name, args: part.functionCall.args }); } }
        return { text: response.text, functionCalls: functionCalls.length > 0 ? functionCalls : undefined };
    } catch (error) {
        logError(error as Error, { prompt });
        throw error;
    }
};


// --- IMAGE & VIDEO GENERATION ---
export const generateImage = async (prompt: string): Promise<string> => {
    const aiClient = await getAi();
    const response = await aiClient.models.generateImages({
        model: 'imagen-4.0-generate-001',
        prompt: prompt,
        config: { numberOfImages: 1, outputMimeType: 'image/png' },
    });
    const base64ImageBytes: string = response.generatedImages[0].image.imageBytes;
    return \`data:image/png;base64,\${base64ImageBytes}\`;
};

export const generateImageFromImageAndText = async (prompt: string, base64Image: string, mimeType: string): Promise<string> => {
    const aiClient = await getAi();
    const response = await aiClient.models.generateContent({
        model: 'gemini-2.5-flash-image-preview',
        contents: {
            parts: [
                { inlineData: { data: base64Image, mimeType: mimeType } },
                { text: prompt },
            ],
        },
        config: {
            responseModalities: [Modality.IMAGE, Modality.TEXT],
        },
    });

    for (const part of response.candidates[0].content.parts) {
        if (part.inlineData) {
            const base64ImageBytes: string = part.inlineData.data;
            return \`data:\${part.inlineData.mimeType};base64,\${base64ImageBytes}\`;
        }
    }

    throw new Error("AI did not return an image. It may have refused the request.");
};


export const generateMultiComponentFlowFromVideo = async (videoBase64: string, mimeType: string, onUpdate: (message: string) => void): Promise<GeneratedFile[]> => {
    const aiClient = await getAi();
    const systemInstruction = "You are an expert frontend developer. Analyze the user flow in this screen recording and generate all the necessary React components and routing logic to replicate it. Create separate files for each component.";
    
    onUpdate("Starting video analysis...");
    let operation = await aiClient.models.generateVideos({
      model: 'veo-2.0-generate-001',
      prompt: "A short, silent video showing a user interacting with a web UI. Transcribe the actions and UI elements into a step-by-step description of the user flow.",
      config: { numberOfVideos: 1 }
    });

    onUpdate("Video processing initiated. This may take several minutes...");
    while (!operation.done) {
      await sleep(10000);
      onUpdate("Checking video status...");
      operation = await aiClient.operations.getVideosOperation({operation: operation});
    }

    onUpdate("Video processing complete. Generating code from flow...");
    // This is a conceptual placeholder. A real implementation would require a multimodal model that can output structured data from video.
    const flowDescription = operation.response?.generatedVideos?.[0]?.video?.uri || "A user clicks a list item, sees a detail page, and clicks a button.";
    
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(flowDescription, systemInstruction, filesSchema);
};`,
  'services/auditing/.placeholder': ``,
  'services/auditing/accessibilityService.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
import * as axe from 'axe-core';

// Configure axe-core to be less noisy in the console
axe.configure({
    reporter: 'v2',
    rules: [
        { id: 'region', enabled: false } // A common false positive in isolated components
    ]
});

export type AxeResult = axe.AxeResults;

/**
 * Runs an axe accessibility audit on a given HTML element.
 * @param context The element or selector string to run the audit on.
 * @returns A promise that resolves with the axe audit results.
 */
export const runAxeAudit = async (context: axe.ElementContext): Promise<AxeResult> => {
    try {
        const results = await axe.run(context, {
             resultTypes: ['violations', 'incomplete']
        });
        return results;
    } catch (error) {
        console.error('Error running axe audit:', error);
        throw new Error('Accessibility audit failed to execute.');
    }
};`,
  'services/authService.ts': `import { Octokit } from 'octokit';
import type { GitHubUser as User } from '../types.ts';
import { logEvent } from './telemetryService.ts';

/**
 * Creates a new Octokit instance with the provided token.
 * This function is now stateless and should be called with a plaintext token
 * that has been securely decrypted from the vault just before use.
 * @param token The plaintext GitHub Personal Access Token.
 * @returns A new Octokit instance.
 */
export const initializeOctokit = (token: string): Octokit => {
    if (!token) {
        throw new Error("Cannot initialize Octokit without a token.");
    }
    logEvent('octokit_initialized');
    return new Octokit({ auth: token, request: { headers: { 'X-GitHub-Api-Version': '2022-11-28' } } });
};

/**
 * Validates a plaintext token by fetching the user profile.
 * @param token The plaintext GitHub token to validate.
 * @returns A promise that resolves to the user's profile information.
 */
export const validateToken = async (token: string): Promise<User> => {
    const tempOctokit = new Octokit({ auth: token });
    const { data: user } = await tempOctokit.request('GET /user');
    return user as unknown as User;
};`,
  'services/componentLoader.ts': `import React, { lazy } from 'react';

/**
 * A wrapper around React.lazy to retry loading a component if it fails.
 * This is useful for handling "chunk load failed" errors that can occur
 * when a user has an old version of the site and a new version is deployed.
 *
 * @param componentImport A function that returns a dynamic import, e.g., () => import('./MyComponent')
 * @param exportName The named export of the component to be loaded.
 * @returns A lazy-loaded React component.
 */
export const lazyWithRetry = <T extends React.ComponentType<any>>(
    componentImport: () => Promise<{ [key: string]: T }>,
    exportName: string
) => {
    return lazy(async () => {
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 1000;

        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const module = await componentImport();
                if (module[exportName]) {
                    return { default: module[exportName] };
                }
                // This would be a developer error (wrong export name), not a chunk load error.
                throw new Error(\`Named export '\${exportName}' not found in module.\`);
            } catch (error) {
                console.error(error); // Log error for debugging
                if (i < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                } else {
                    // After all retries, force a page reload.
                    // This is the most effective way to solve stale chunk issues after a new deployment.
                    console.error("Failed to load component after multiple retries. Reloading page.");
                    window.location.reload();
                    // Throw to allow an ErrorBoundary to catch this, although reload will likely intervene.
                    throw error;
                }
            }
        }
        // This part of the code should not be reachable
        throw new Error('Component failed to load and retries were exhausted.');
    });
};`,
  'services/cryptoService.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const KEY_ALGORITHM = 'AES-GCM';
const KEY_LENGTH = 256;
const PBKDF2_ALGORITHM = 'PBKDF2';
const PBKDF2_HASH = 'SHA-256';
const PBKDF2_ITERATIONS = 100000;
const SALT_LENGTH_BYTES = 16;
const IV_LENGTH_BYTES = 12;

const textEncoder = new TextEncoder();
const textDecoder = new TextDecoder();

/**
 * Derives a cryptographic key from a master password and a salt using PBKDF2.
 * @param password The master password string.
 * @param salt The salt as an ArrayBuffer.
 * @returns A promise that resolves to a CryptoKey.
 */
export const deriveKey = async (password: string, salt: ArrayBuffer): Promise<CryptoKey> => {
    const masterKey = await crypto.subtle.importKey(
        'raw',
        textEncoder.encode(password),
        { name: PBKDF2_ALGORITHM },
        false,
        ['deriveKey']
    );

    return await crypto.subtle.deriveKey(
        {
            name: PBKDF2_ALGORITHM,
            salt,
            iterations: PBKDF2_ITERATIONS,
            hash: PBKDF2_HASH,
        },
        masterKey,
        { name: KEY_ALGORITHM, length: KEY_LENGTH },
        true,
        ['encrypt', 'decrypt']
    );
};

/**
 * Generates a cryptographically secure random salt.
 * @returns A new salt as an ArrayBuffer.
 */
export const generateSalt = (): ArrayBuffer => {
    return crypto.getRandomValues(new Uint8Array(SALT_LENGTH_BYTES)).buffer;
};

/**
 * Encrypts a plaintext string using a derived key.
 * @param plaintext The string to encrypt.
 * @param key The CryptoKey to use for encryption.
 * @returns A promise that resolves to an object containing the encrypted data (ciphertext), and the initialization vector (iv).
 */
export const encrypt = async (plaintext: string, key: CryptoKey): Promise<{ ciphertext: ArrayBuffer, iv: Uint8Array }> => {
    const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH_BYTES));
    const encodedPlaintext = textEncoder.encode(plaintext);

    const ciphertext = await crypto.subtle.encrypt(
        {
            name: KEY_ALGORITHM,
            iv,
        },
        key,
        encodedPlaintext
    );

    return { ciphertext, iv };
};

/**
 * Decrypts a ciphertext ArrayBuffer using a derived key and IV.
 * @param ciphertext The ArrayBuffer of the encrypted data.
 * @param key The CryptoKey to use for decryption.
 * @param iv The initialization vector used during encryption.
 * @returns A promise that resolves to the decrypted plaintext string.
 */
export const decrypt = async (ciphertext: ArrayBuffer, key: CryptoKey, iv: Uint8Array): Promise<string> => {
    const decrypted = await crypto.subtle.decrypt(
        {
            name: KEY_ALGORITHM,
            iv,
        },
        key,
        ciphertext
    );

    return textDecoder.decode(decrypted);
};
`,
  'services/dbService.ts': `import { openDB, DBSchema } from 'idb';
import type { GeneratedFile, EncryptedData } from '../types.ts';

const DB_NAME = 'devcore-db';
const DB_VERSION = 2;
const FILES_STORE_NAME = 'generated-files';
const VAULT_STORE_NAME = 'vault-data';
const ENCRYPTED_TOKENS_STORE_NAME = 'encrypted-tokens';


interface DevCoreDB extends DBSchema {
  [FILES_STORE_NAME]: {
    key: string;
    value: GeneratedFile;
    indexes: { 'by-filePath': string };
  };
  [VAULT_STORE_NAME]: {
    key: string;
    value: any;
  };
  [ENCRYPTED_TOKENS_STORE_NAME]: {
    key: string;
    value: EncryptedData;
  };
}

const dbPromise = openDB<DevCoreDB>(DB_NAME, DB_VERSION, {
  upgrade(db, oldVersion) {
    switch (oldVersion) {
        case 0: {
            const store = db.createObjectStore(FILES_STORE_NAME, {
                keyPath: 'filePath',
            });
            store.createIndex('by-filePath', 'filePath');
        }
        // fall-through for new installations
        case 1: {
            if (!db.objectStoreNames.contains(VAULT_STORE_NAME)) {
                db.createObjectStore(VAULT_STORE_NAME);
            }
            if (!db.objectStoreNames.contains(ENCRYPTED_TOKENS_STORE_NAME)) {
                db.createObjectStore(ENCRYPTED_TOKENS_STORE_NAME, { keyPath: 'id' });
            }
        }
    }
  },
});

// --- Generated Files Store ---
export const saveFile = async (file: GeneratedFile): Promise<void> => {
  const db = await dbPromise;
  await db.put(FILES_STORE_NAME, file);
};

export const getAllFiles = async (): Promise<GeneratedFile[]> => {
  const db = await dbPromise;
  return db.getAll(FILES_STORE_NAME);
};

export const getFileByPath = async (filePath: string): Promise<GeneratedFile | undefined> => {
  const db = await dbPromise;
  return db.get(FILES_STORE_NAME, filePath);
};

export const clearAllFiles = async (): Promise<void> => {
  const db = await dbPromise;
  await db.clear(FILES_STORE_NAME);
};

// --- Vault Store ---
export const saveVaultData = async (key: string, value: any): Promise<void> => {
  const db = await dbPromise;
  await db.put(VAULT_STORE_NAME, value, key);
};

export const getVaultData = async (key: string): Promise<any | undefined> => {
  const db = await dbPromise;
  return db.get(VAULT_STORE_NAME, key);
};

// --- Encrypted Tokens Store ---
export const saveEncryptedToken = async (data: EncryptedData): Promise<void> => {
  const db = await dbPromise;
  await db.put(ENCRYPTED_TOKENS_STORE_NAME, data);
};

export const getEncryptedToken = async (id: string): Promise<EncryptedData | undefined> => {
  const db = await dbPromise;
  return db.get(ENCRYPTED_TOKENS_STORE_NAME, id);
};

export const getAllEncryptedTokenIds = async (): Promise<string[]> => {
    const db = await dbPromise;
    return db.getAllKeys(ENCRYPTED_TOKENS_STORE_NAME);
};


// --- Global Actions ---
export const clearAllData = async (): Promise<void> => {
    const db = await dbPromise;
    await db.clear(FILES_STORE_NAME);
    await db.clear(VAULT_STORE_NAME);
    await db.clear(ENCRYPTED_TOKENS_STORE_NAME);
}`,
  'services/fileUtils.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

/**
 * A robust way to convert an ArrayBuffer to a Base64 string.
 * @param buffer The ArrayBuffer to convert.
 * @returns The Base64 encoded string.
 */
const arrayBufferToBase64 = (buffer: ArrayBuffer): string => {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
};

/**
 * Converts a Blob object to a Base64 encoded string.
 * This implementation uses readAsArrayBuffer for greater robustness across environments.
 * @param blob The Blob object to convert.
 * @returns A promise that resolves with the Base64 string.
 */
export const blobToBase64 = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            resolve(arrayBufferToBase64(reader.result as ArrayBuffer));
        };
        reader.onerror = (error) => reject(error);
        reader.readAsArrayBuffer(blob);
    });
};

/**
 * Converts a File object to a Base64 encoded string.
 * This function is an alias for blobToBase64.
 * @param file The File object to convert.
 * @returns A promise that resolves with the Base64 string.
 */
export const fileToBase64 = (file: File): Promise<string> => {
    return blobToBase64(file);
};

/**
 * Converts a Blob object to a Data URL string.
 * This implementation uses readAsArrayBuffer for greater robustness across environments.
 * This function keeps the Data URL prefix (e.g., "data:image/png;base64,").
 * @param blob The Blob object to convert.
 * @returns A promise that resolves with the Data URL string.
 */
export const blobToDataURL = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64 = arrayBufferToBase64(reader.result as ArrayBuffer);
            resolve(\`data:\${blob.type};base64,\${base64}\`);
        };
        reader.onerror = (error) => reject(error);
        reader.readAsArrayBuffer(blob);
    });
};

/**
 * Triggers a browser download for the given content.
 * @param content The string content to download.
 * @param filename The name of the file.
 * @param mimeType The MIME type of the file.
 */
export const downloadFile = (content: string, filename: string, mimeType: string = 'text/plain') => {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

/**
 * Generates and triggers a download for a .env formatted file.
 * @param env A record of key-value pairs for the environment variables.
 */
export const downloadEnvFile = (env: Record<string, string>): void => {
    const content = Object.entries(env)
        .map(([key, value]) => \`\${key}=\${JSON.stringify(value)}\`)
        .join('\\n');
    downloadFile(content, '.env', 'text/plain');
};

/**
 * Generates and triggers a download for a JSON file.
 * @param data The JavaScript object to stringify and download.
 * @param filename The name of the file.
 */
export const downloadJson = (data: object, filename: string): void => {
    const content = JSON.stringify(data, null, 2);
    downloadFile(content, filename, 'application/json');
};`,
  'services/gcpService.ts': `import { ensureGapiClient } from './googleApiService.ts';
import { logError, measurePerformance } from './telemetryService.ts';

declare var gapi: any;

/**
 * Tests a set of permissions against a specified GCP resource.
 * @param resource The full resource name of the GCP resource (e.g., '//cloudresourcemanager.googleapis.com/projects/my-project').
 * @param permissions An array of permission strings to test (e.g., ['storage.objects.create', 'storage.objects.get']).
 * @returns A promise that resolves with the API response, containing the set of permissions the caller is allowed.
 */
export const testIamPermissions = async (resource: string, permissions: string[]): Promise<{ permissions: string[] }> => {
    return measurePerformance('gcp.testIamPermissions', async () => {
        try {
            const isReady = await ensureGapiClient();
            if (!isReady) throw new Error("Google API client not ready.");

            // The resource name for IAM API is slightly different
            const iamResourcePath = resource.startsWith('//') ? resource.substring(2) : resource;

            const response = await gapi.client.iam.permissions.testIamPermissions({
                resource: iamResourcePath,
                resource_body: { permissions }
            });

            return response.result;
        } catch (error) {
            logError(error as Error, {
                service: 'gcpService',
                function: 'testIamPermissions',
                resource
            });
            // Re-throw a more user-friendly error
            const gapiError = error as any;
            if (gapiError.result?.error?.message) {
                 throw new Error(\`GCP API Error: \${gapiError.result.error.message}\`);
            }
            throw error;
        }
    });
};`,
  'services/geminiService.ts': ``,
  'services/githubService.ts': `import type { Octokit } from 'octokit';
import type { Repo, FileNode } from '../types.ts';
import { logEvent, logError, measurePerformance } from './index.ts';

// --- Repository-Level Functions ---

/**
 * Fetches the repositories for the authenticated user.
 * @param octokit An authenticated Octokit instance.
 * @returns A promise that resolves to an array of Repo objects.
 */
export const getRepos = async (octokit: Octokit): Promise<Repo[]> => {
    return measurePerformance('getRepos', async () => {
        logEvent('getRepos_start');
        try {
            const { data } = await octokit.request('GET /user/repos', {
                type: 'owner',
                sort: 'updated',
                per_page: 100,
            });
            logEvent('getRepos_success', { count: data.length });
            return data as Repo[];
        } catch (error) {
            logError(error as Error, { context: 'getRepos' });
            throw error;
        }
    });
};

/**
 * Deletes a repository. This is a destructive action.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves when the deletion is complete.
 */
export const deleteRepo = async (octokit: Octokit, owner: string, repo: string): Promise<void> => {
     return measurePerformance('deleteRepo', async () => {
        logEvent('deleteRepo_start', { owner, repo });
        try {
            await octokit.request('DELETE /repos/{owner}/{repo}', {
                owner,
                repo,
            });
            logEvent('deleteRepo_success', { owner, repo });
        } catch (error) {
            logError(error as Error, { context: 'deleteRepo', owner, repo });
            throw error;
        }
    });
};

/**
 * Fetches the last 30 commits for a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to an array of commit objects.
 */
export const getCommitHistory = async (octokit: Octokit, owner: string, repo: string): Promise<any[]> => {
    return measurePerformance('getCommitHistory', async () => {
        logEvent('getCommitHistory_start', { owner, repo });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/commits', {
                owner,
                repo,
                per_page: 30,
            });
            logEvent('getCommitHistory_success', { count: data.length });
            return data;
        } catch (error) {
            logError(error as Error, { context: 'getCommitHistory' });
            throw error;
        }
    });
};

// --- File and Tree Functions ---

/**
 * Fetches the file tree for a repository recursively.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to the root FileNode of the repository.
 */
export const getRepoTree = async (octokit: Octokit, owner: string, repo: string): Promise<FileNode> => {
     return measurePerformance('getRepoTree', async () => {
        logEvent('getRepoTree_start', { owner, repo });
        try {
            const { data: repoData } = await octokit.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defaultBranch = repoData.default_branch;

            const { data: branch } = await octokit.request('GET /repos/{owner}/{repo}/branches/{branch}', {
                owner,
                repo,
                branch: defaultBranch,
            });
            const treeSha = branch.commit.commit.tree.sha;
            
            const { data: treeData } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
                owner,
                repo,
                tree_sha: treeSha,
                recursive: 'true',
            });

            const root: FileNode = { name: repo, type: 'folder', path: '', children: [] };
            
            treeData.tree.forEach((item: any) => {
                const pathParts = item.path.split('/');
                let currentNode = root;

                pathParts.forEach((part, index) => {
                    if (!currentNode.children) {
                        currentNode.children = [];
                    }
                    const currentPath = pathParts.slice(0, index + 1).join('/');
                    let childNode = currentNode.children.find(child => child.name === part && child.path === currentPath);

                    if (!childNode) {
                        childNode = {
                            name: part,
                            path: item.path,
                            type: item.type === 'tree' ? 'folder' : 'file',
                        };
                        if(item.type === 'tree') {
                            childNode.children = [];
                            childNode.path = currentPath; 
                        }
                        currentNode.children.push(childNode);
                    }
                    currentNode = childNode;
                });
            });

            logEvent('getRepoTree_success', { owner, repo, items: treeData.tree.length });
            return root;
        } catch (error) {
            logError(error as Error, { context: 'getRepoTree', owner, repo });
            throw new Error(\`Failed to fetch repository tree: \${(error as Error).message}\`);
        }
    });
};

/**
 * Fetches the content of a specific file from a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param path The full path to the file within the repository.
 * @returns A promise that resolves to the string content of the file.
 */
export const getFileContent = async (octokit: Octokit, owner: string, repo: string, path: string): Promise<string> => {
    return measurePerformance('getFileContent', async () => {
        logEvent('getFileContent_start', { owner, repo, path });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                owner,
                repo,
                path,
            });

            if (Array.isArray(data) || data.type !== 'file' || typeof data.content !== 'string') {
                 throw new Error("Path did not point to a valid file or content was missing.");
            }

            // The content is Base64 encoded, so we need to decode it.
            const content = atob(data.content);
            logEvent('getFileContent_success', { owner, repo, path });
            return content;
        } catch (error) {
             logError(error as Error, { context: 'getFileContent', owner, repo, path });
             throw new Error(\`Failed to fetch file content: \${(error as Error).message}\`);
        }
    });
};

// --- Commit and Branching Functions ---

/**
 * Commits one or more files to a repository in a single commit.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param files An array of file objects with path and content.
 * @param message The commit message.
 * @param branch The branch to commit to (defaults to 'main').
 * @returns A promise that resolves with the URL of the new commit.
 */
export const commitFiles = async (
    octokit: Octokit,
    owner: string,
    repo: string,
    files: { path: string; content: string }[],
    message: string,
    branch: string = 'main'
): Promise<string> => {
    return measurePerformance('commitFiles', async () => {
        logEvent('commitFiles_start', { owner, repo, fileCount: files.length, branch });

        try {
            // 1. Get the latest commit SHA and base tree SHA
            const { data: refData } = await octokit.request('GET /repos/{owner}/{repo}/git/ref/{ref}', {
                owner,
                repo,
                ref: \`heads/\${branch}\`,
            });
            const latestCommitSha = refData.object.sha;
            const { data: commitData } = await octokit.request('GET /repos/{owner}/{repo}/git/commits/{commit_sha}', {
                owner,
                repo,
                commit_sha: latestCommitSha,
            });
            const baseTreeSha = commitData.tree.sha;

            // 2. Create blobs for all new file contents
            const blobPromises = files.map(file =>
                octokit.request('POST /repos/{owner}/{repo}/git/blobs', {
                    owner,
                    repo,
                    content: file.content,
                    encoding: 'utf-8',
                })
            );
            const blobs = await Promise.all(blobPromises);
            
            // 3. Create the tree object
            const tree = blobs.map((blob, index) => ({
                path: files[index].path,
                mode: '100644' as const, // file mode
                type: 'blob' as const,
                sha: blob.data.sha,
            }));

            // 4. Create a new tree
            const { data: newTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
                owner,
                repo,
                base_tree: baseTreeSha,
                tree,
            });

            // 5. Create a new commit
            const { data: newCommit } = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
                owner,
                repo,
                message,
                tree: newTree.sha,
                parents: [latestCommitSha],
            });

            // 6. Update the branch reference (fast-forward)
            await octokit.request('PATCH /repos/{owner}/{repo}/git/refs/{ref}', {
                owner,
                repo,
                ref: \`heads/\${branch}\`,
                sha: newCommit.sha,
            });

            logEvent('commitFiles_success', { commitUrl: newCommit.html_url });
            return newCommit.html_url;

        } catch (error) {
            logError(error as Error, { context: 'commitFiles', owner, repo, branch });
            throw new Error(\`Failed to commit files: \${(error as Error).message}\`);
        }
    });
};`,
  'services/googleApiService.ts': `// services/googleApiService.ts
const API_KEY = process.env.GEMINI_API_KEY;
const CLIENT_ID = "555179712981-36hlicm802genhfo9iq1ufnp1n8cikt9.apps.googleusercontent.com";

declare global { interface Window { gapi: any; } }

let gapiInitialized = false;

const loadGapiScript = () => new Promise<void>((resolve, reject) => {
    if (window.gapi) {
        window.gapi.load('client', resolve);
        return;
    };
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.onload = () => window.gapi.load('client', resolve);
    script.onerror = reject;
    document.body.appendChild(script);
});

export const ensureGapiClient = async (): Promise<boolean> => {
    if (gapiInitialized) return true;
    
    try {
        await loadGapiScript();

        await window.gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
                "https://docs.googleapis.com/\$discovery/rest?version=v1",
                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
                "https://iam.googleapis.com/\$discovery/rest?version=v1"
            ],
        });

        const accessToken = sessionStorage.getItem('google_access_token');
        if (!accessToken) {
            console.error("GAPI: Access token not found. User may need to sign in again.");
            return false;
        }
        
        window.gapi.client.setToken({ access_token: accessToken });
        gapiInitialized = true;
        return true;
    } catch (error) {
        console.error("GAPI client initialization failed:", error);
        gapiInitialized = false;
        return false;
    }
};`,
  'services/googleAuthService.ts': `import type { AppUser } from '../types.ts';
import { logError } from './telemetryService.ts';

declare global {
  const google: any;
}

const GOOGLE_CLIENT_ID = "555179712981-36hlicm802genhfo9iq1ufnp1n8cikt9.apps.googleusercontent.com";

const SCOPES = [
    'openid',
    'https://www.googleapis.com/auth/userinfo.profile',
    'https://www.googleapis.com/auth/userinfo.email',
    'https://www.googleapis.com/auth/drive.appdata',
    'https://www.googleapis.com/auth/drive.install',
    'https://www.googleapis.com/auth/drive.file',
    'https://www.googleapis.com/auth/iam.test',
    'https://www.googleapis.com/auth/gmail.addons.current.action.compose',
    'https://www.googleapis.com/auth/gmail.addons.current.message.action'
].join(' ');

let tokenClient: any;
let onUserChangedCallback: (user: AppUser | null) => void = () => {};

const getGoogleUserProfile = async (accessToken: string) => {
    const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: \`Bearer \${accessToken}\` },
    });
    if (!response.ok) {
        throw new Error('Failed to fetch user profile');
    }
    return response.json();
};

export function initGoogleAuth(callback: (user: AppUser | null) => void) {
  if (!GOOGLE_CLIENT_ID) {
    console.error('Google Client ID not configured.');
    return;
  }
  onUserChangedCallback = callback;
  
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: async (tokenResponse: any) => {
      if (tokenResponse && tokenResponse.access_token) {
        sessionStorage.setItem('google_access_token', tokenResponse.access_token);
        try {
            const profile = await getGoogleUserProfile(tokenResponse.access_token);
            const appUser: AppUser = {
                uid: profile.sub, // 'sub' is the standard OIDC field for user ID
                displayName: profile.name,
                email: profile.email,
                photoURL: profile.picture,
                tier: 'free',
            };
            onUserChangedCallback(appUser);
        } catch (error) {
            logError(error as Error, { context: 'googleAuthInitCallback' });
            onUserChangedCallback(null);
        }
      } else {
        logError(new Error('Google sign-in failed: No access token received.'), { tokenResponse });
        onUserChangedCallback(null);
      }
    },
  });
}

export function signInWithGoogle() {
  if (tokenClient) {
    tokenClient.requestAccessToken({ prompt: 'consent' });
  } else {
    logError(new Error("Google Token Client not initialized."));
  }
}

export function signOutUser() {
  const token = sessionStorage.getItem('google_access_token');
  if (token && window.google) {
      google.accounts.oauth2.revoke(token, () => {
        console.log('Google token revoked');
      });
  }
  sessionStorage.removeItem('google_access_token');
  onUserChangedCallback(null);
}`,
  'services/index.ts': `

export * from './aiService.ts';
export * from './fileUtils.ts';
export * from './telemetryService.ts';
export * from './dbService.ts';
export * from './googleAuthService.ts';
export * from './githubService.ts';
export * from './componentLoader.ts';
export * from './taxonomyService.ts';
export * from './mocking/mockServer.ts';
export * from './mocking/db.ts';
export * from './profiling/performanceService.ts';
export * from './profiling/bundleAnalyzer.ts';
export * from './auditing/accessibilityService.ts';
export * from './security/staticAnalysisService.ts';
export * from './googleApiService.ts';
export * from './workspaceService.ts';
export * from './gcpService.ts';
export * from './workspaceConnectorService.ts';`,
  'services/mocking/.placeholder': ``,
  'services/mocking/db.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import { openDB, DBSchema } from 'idb';

const DB_NAME = 'devcore-mock-db';
const DB_VERSION = 1;
const STORE_NAME = 'mock-collections';

interface MockDB extends DBSchema {
  [STORE_NAME]: {
    key: string;
    value: {
        id: string;
        schemaDescription: string;
        data: any[];
    };
  };
}

const dbPromise = openDB<MockDB>(DB_NAME, DB_VERSION, {
  upgrade(db) {
    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
  },
});

export const saveMockCollection = async (collection: { id: string; schemaDescription: string; data: any[] }): Promise<void> => {
  const db = await dbPromise;
  await db.put(STORE_NAME, collection);
};

export const getMockCollection = async (id: string): Promise<{ id: string; schemaDescription: string; data: any[] } | undefined> => {
  const db = await dbPromise;
  return db.get(STORE_NAME, id);
};

export const getAllMockCollections = async (): Promise<{ id: string; schemaDescription: string; data: any[] }[]> => {
    const db = await dbPromise;
    return db.getAll(STORE_NAME);
}

export const deleteMockCollection = async (id: string): Promise<void> => {
  const db = await dbPromise;
  await db.delete(STORE_NAME, id);
};
`,
  'services/mocking/mockServer.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const SERVICE_WORKER_URL = '/mock-service-worker.js';
let registration: ServiceWorkerRegistration | null = null;

export const startMockServer = (): Promise<void> => {
    return new Promise(async (resolve, reject) => {
        if (!('serviceWorker' in navigator)) {
            return reject(new Error('Service workers are not supported in this browser.'));
        }
        
        try {
            registration = await navigator.serviceWorker.register(SERVICE_WORKER_URL);
            
            if (registration.installing) {
                registration.installing.addEventListener('statechange', () => {
                    if (registration.installing?.state === 'installed') {
                        // The new worker is installed, now wait for it to activate
                    }
                });
            }

            if (registration.active) {
                 console.log('Mock Service Worker already active.');
                 return resolve();
            }

            // Wait for the worker to become active
            await navigator.serviceWorker.ready;
            console.log('Mock Service Worker registered and ready with scope:', registration.scope);
            resolve();
            
        } catch (error) {
            console.error('Mock Service Worker registration failed:', error);
            reject(new Error('Could not start mock server.'));
        }
    });
};

export const stopMockServer = async (): Promise<void> => {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
        await reg.unregister();
        registration = null;
        console.log('Mock Service Worker unregistered.');
    }
};

export const isMockServerRunning = (): boolean => {
    // Check registration and controller status to determine if server is active.
    return !!registration && !!navigator.serviceWorker.controller;
};

interface MockRoute {
    path: string; // e.g., /api/users/*
    method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';
    response: {
        status: number;
        body: any;
        headers?: Record<string, string>;
    }
}

export const setMockRoutes = (routes: MockRoute[]): void => {
    if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SET_ROUTES',
            routes
        });
        console.log('Mock routes sent to service worker:', routes);
    } else {
        console.warn('Mock server is not active. Routes were not set.');
    }
};`,
  'services/profiling/.placeholder': ``,
  'services/profiling/bundleAnalyzer.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface BundleStatsNode {
    name: string;
    value: number;
    children?: BundleStatsNode[];
}

// This is a simplified parser for Vite's \`stats.json\` output.
// A real-world implementation would need to handle different formats (Webpack, Rollup, etc.).
export const parseViteStats = (statsJson: string): BundleStatsNode => {
    try {
        const stats = JSON.parse(statsJson);
        const root: BundleStatsNode = { name: 'root', value: 0, children: [] };

        if (stats.output) { // Vite 5+ stats format
             Object.entries(stats.output).forEach(([path, chunk]: [string, any]) => {
                const node: BundleStatsNode = {
                    name: path,
                    value: chunk.size,
                };
                root.children?.push(node);
                root.value += chunk.size;
            });
        }

        return root;
    } catch (error) {
        console.error("Failed to parse bundle stats:", error);
        throw new Error("Invalid stats JSON format.");
    }
};
`,
  'services/profiling/performanceService.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface TraceEntry {
    name: string;
    startTime: number;
    duration: number;
    entryType: 'mark' | 'measure';
}

let isTracing = false;
const TRACE_PREFIX = 'devcore-trace-';

export const startTracing = (): void => {
    if (isTracing) {
        console.warn('Tracing is already active.');
        return;
    }
    performance.clearMarks();
    performance.clearMeasures();
    isTracing = true;
    console.log('Performance tracing started.');
};

export const stopTracing = (): TraceEntry[] => {
    if (!isTracing) {
        console.warn('Tracing is not active.');
        return [];
    }
    isTracing = false;
    console.log('Performance tracing stopped.');

    const entries = performance.getEntries().filter(
        entry => entry.name.startsWith(TRACE_PREFIX)
    );

    performance.clearMarks();
    performance.clearMeasures();

    return entries.map(entry => ({
        name: entry.name.replace(TRACE_PREFIX, ''),
        startTime: entry.startTime,
        duration: entry.duration,
        entryType: entry.entryType as 'mark' | 'measure',
    }));
};

export const mark = (name: string): void => {
    if (!isTracing) return;
    performance.mark(\`\${TRACE_PREFIX}\${name}\`);
};

export const measure = (name: string, startMark: string, endMark: string): void => {
    if (!isTracing) return;
    try {
        performance.measure(\`\${TRACE_PREFIX}\${name}\`, \`\${TRACE_PREFIX}\${startMark}\`, \`\${TRACE_PREFIX}\${endMark}\`);
    } catch (e) {
        console.error(\`Failed to measure '\${name}'\`, e);
    }
};
`,
  'services/security/.placeholder': ``,
  'services/security/staticAnalysisService.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface SecurityIssue {
    line: number;
    type: string;
    description: string;
    severity: 'High' | 'Medium' | 'Low';
}

const rules = [
    {
        name: 'Hardcoded Secret',
        regex: /(key|secret|token|password)['"]?\\s*[:=]\\s*['"]([a-zA-Z0-9-_.]{16,})['"]/gi,
        description: 'A hardcoded secret or API key was found. These should be stored in environment variables.',
        severity: 'High' as const,
    },
    {
        name: 'dangerouslySetInnerHTML',
        regex: /dangerouslySetInnerHTML/g,
        description: 'Use of dangerouslySetInnerHTML can open your application to XSS attacks. Ensure the source is sanitized.',
        severity: 'Medium' as const,
    },
    {
        name: 'eval() usage',
        regex: /eval\\(/g,
        description: 'The use of eval() is a major security risk as it can execute arbitrary code.',
        severity: 'High' as const,
    },
    {
        name: 'Insecure URL',
        regex: /http:\\/\\//g,
        description: 'Found an insecure "http://" URL. Use "https://" for all external resources.',
        severity: 'Low' as const,
    }
];

export const runStaticScan = (code: string): SecurityIssue[] => {
    const issues: SecurityIssue[] = [];
    const lines = code.split('\\n');

    lines.forEach((line, index) => {
        rules.forEach(rule => {
            if (rule.regex.test(line)) {
                issues.push({
                    line: index + 1,
                    type: rule.name,
                    description: rule.description,
                    severity: rule.severity,
                });
            }
        });
    });

    return issues;
};
`,
  'services/sourceRegistry.ts': `// This file is a registry of all source code files in the application.
// It's used by the ActionManager to create a downloadable zip of the entire app source.
// THIS FILE IS AUTO-GENERATED. DO NOT EDIT BY HAND.

export const sourceFiles: Record<string, string> = {
  '.gitignore': \`# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
\`,
  'App.tsx': \`import React, { Suspense, useCallback, useState, useEffect } from 'react';
import { ErrorBoundary } from './components/ErrorBoundary.tsx';
import { useGlobalState } from './contexts/GlobalStateContext.tsx';
import { logEvent } from './services/telemetryService.ts';
import type { ViewType, AppUser } from './types.ts';
import { CommandPalette } from './components/CommandPalette.tsx';
import { NotificationProvider } from './contexts/NotificationContext.tsx';
import { useTheme } from './hooks/useTheme.ts';
import { VaultProvider } from './components/vault/VaultProvider.tsx';
import { initGoogleAuth } from './services/googleAuthService.ts';
import { LoginView } from './components/LoginView.tsx';
import { DesktopView } from './components/desktop/DesktopView.tsx';
import { isApiKeyConfigured, initializeAiClient } from './services/aiService.ts';
import { ApiKeyPromptModal } from './components/ApiKeyPromptModal.tsx';
import { OctokitProvider } from './contexts/OctokitContext.tsx';
import { useVaultModal } from './contexts/VaultModalContext.tsx';
import { isVaultInitialized } from './services/vaultService.ts';


export const LoadingIndicator: React.FC = () => (
    <div className="w-full h-full flex items-center justify-center bg-surface">
        <div className="flex items-center justify-center space-x-2">
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.2s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.4s' }}></div>
            <span className="text-text-secondary ml-2">Loading...</span>
        </div>
    </div>
);

interface LocalStorageConsentModalProps {
  onAccept: () => void;
  onDecline: () => void;
}

const LocalStorageConsentModal: React.FC<LocalStorageConsentModalProps> = ({ onAccept, onDecline }) => {
  return (
    <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
      <div 
        className="bg-surface border border-border rounded-2xl shadow-2xl shadow-black/50 w-full max-w-md m-4 p-8 text-center animate-pop-in"
      >
        <h2 className="text-2xl mb-4">Store Data Locally?</h2>
        <p className="text-text-secondary mb-6">
          This application uses your browser's local storage to save your settings and remember your progress between sessions. This data stays on your computer and is not shared.
        </p>
        <div className="flex justify-center gap-4">
          <button
            onClick={onDecline}
            className="px-6 py-2 bg-surface border border-border text-text-primary font-bold rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
          >
            Decline
          </button>
          <button
            onClick={onAccept}
            className="btn-primary px-6 py-2"
          >
            Accept
          </button>
        </div>
      </div>
    </div>
  );
};

const AppContent: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { activeView } = state;
    const [isCommandPaletteOpen, setCommandPaletteOpen] = useState(false);
  
    useEffect(() => {
      const handleKeyDown = (e: KeyboardEvent) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              setCommandPaletteOpen(isOpen => !isOpen);
          }
      };
      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);
  
    const handleViewChange = useCallback((view: ViewType, props: any = {}) => {
      logEvent('view_changed', { view });
      dispatch({ type: 'SET_VIEW', payload: { view, props } });
      setCommandPaletteOpen(false);
    }, [dispatch]);
  
    return (
        <OctokitProvider>
            <div className="relative flex h-full w-full bg-slate-800" style={{
                backgroundImage: 'radial-gradient(circle at top left, var(--color-primary), transparent 60%), radial-gradient(circle at bottom right, #38bdf8, transparent 50%)',
                backgroundBlendMode: 'multiply',
            }}>
                <ErrorBoundary>
                    <Suspense fallback={<LoadingIndicator />}>
                        <DesktopView openFeatureId={activeView} onNavigate={handleViewChange} />
                    </Suspense>
                </ErrorBoundary>
                <CommandPalette isOpen={isCommandPaletteOpen} onClose={() => setCommandPaletteOpen(false)} onSelect={handleViewChange} />
            </div>
        </OctokitProvider>
    )
}

const AppShell: React.FC = () => {
    const [consent, setConsent] = useState<'pending' | 'granted' | 'denied'>();
    const { state, dispatch } = useGlobalState();
    const { user, vaultState, isApiKeyMissing } = state;
    const { requestCreation } = useVaultModal();
    useTheme();

    useEffect(() => {
      try {
          const consentStatus = localStorage.getItem('devcore_ls_consent');
          if (!consentStatus) {
              setConsent('pending');
          } else {
              setConsent(consentStatus as 'granted' | 'denied');
          }
      } catch (e) {
          console.warn("Could not access localStorage.", e);
          setConsent('denied');
      }
    }, []);
    
    // Onboarding flow effect
    useEffect(() => {
        const runOnboardingChecks = async () => {
            if (consent !== 'granted' || !user) return;
            
            // Check if vault needs to be created
            const vaultExists = await isVaultInitialized();
            if (!vaultExists) {
                dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: false, isUnlocked: false } });
                const created = await requestCreation();
                if (created) {
                     dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true, isUnlocked: true } });
                } else {
                    return; // Stop flow if vault creation is cancelled
                }
            } else {
                 dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true } });
            }

            // After vault is confirmed to exist/be created, check for API key
            const keyConfigured = await isApiKeyConfigured();
            if (!keyConfigured) {
                dispatch({ type: 'SET_API_KEY_MISSING', payload: true });
            } else {
                dispatch({ type: 'SET_API_KEY_MISSING', payload: false });
                initializeAiClient(); // Attempt initialization
            }
        };
        runOnboardingChecks();

    }, [consent, user, requestCreation, dispatch]);


    useEffect(() => {
        const handleUserChanged = (appUser: AppUser | null) => {
            dispatch({ type: 'SET_APP_USER', payload: appUser });
        };

        const initAuth = () => {
            if (window.google) {
                initGoogleAuth(handleUserChanged);
            }
        };

        const gsiScript = document.getElementById('gsi-client');
        if (window.google) {
            initAuth();
        } else if (gsiScript) {
            gsiScript.addEventListener('load', initAuth);
            return () => gsiScript.removeEventListener('load', initAuth);
        }
    }, [dispatch]);
  
    const handleAcceptConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'granted');
          window.location.reload(); // Reload to re-evaluate storage access
      } catch (e) {
          console.error("Could not write to localStorage.", e);
          setConsent('denied');
      }
    };
  
    const handleDeclineConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'denied');
      } catch (e) {
          console.error("Could not write to localStorage.", e);
      }
      setConsent('denied');
    };
    
    const renderContent = () => {
        if (consent === 'pending') {
            return <LocalStorageConsentModal onAccept={handleAcceptConsent} onDecline={handleDeclineConsent} />;
        }
        if (consent === 'denied') {
            return <div className="w-full h-full flex items-center justify-center p-8 text-center">Local storage access is required for this application to function. Please reload and accept the prompt.</div>
        }
        if (!user) {
            return <LoginView />;
        }
        if (!vaultState.isInitialized || !vaultState.isUnlocked) {
             // The VaultProvider modals will handle prompting for creation/unlock
             return <LoadingIndicator />;
        }
        if (isApiKeyMissing) {
            return <ApiKeyPromptModal />;
        }
         // Only show main app if user is logged in, vault is handled, and key is present.
        if (user && vaultState.isUnlocked && !isApiKeyMissing) {
            return <AppContent />;
        }
        // Default to a loading state while checks are running
        return <LoadingIndicator />;
    };

    return renderContent();
};


const App: React.FC = () => {
    return (
        <div className="h-screen w-screen font-sans overflow-hidden bg-background">
            <NotificationProvider>
                <VaultProvider>
                    <AppShell />
                </VaultProvider>
            </NotificationProvider>
        </div>
    );
};

export default App;\`,
  'ErrorBoundary.tsx': \`import React from 'react';
import { logError } from '../services/index.ts';
import { debugErrorStream } from '../services/index.ts';
import { SparklesIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  aiHelp: string;
  isAiLoading: boolean;
}

export class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null, aiHelp: '', isAiLoading: false };
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logError(error, { componentStack: errorInfo.componentStack });
  }
  
  handleRevert = () => {
    window.location.reload();
  };

  handleAskAi = async () => {
    if (!this.state.error) return;

    this.setState({ isAiLoading: true, aiHelp: '' });
    try {
        const stream = debugErrorStream(this.state.error);
        let fullResponse = '';
        for await (const chunk of stream) {
            fullResponse += chunk;
            this.setState({ aiHelp: fullResponse });
        }
    } catch (e) {
        this.setState({ aiHelp: 'Sorry, the AI assistant could not be reached.' });
        logError(e as Error, { context: 'AI Error Debugging' });
    } finally {
        this.setState({ isAiLoading: false });
    }
};

  render() {
    if (this.state.hasError) {
      return (
        <div className="w-full h-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 bg-background text-text-primary">
            <div className="w-full max-w-4xl bg-surface border border-border rounded-lg p-6 shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Column: Error Details & Actions */}
                <div className="flex flex-col">
                    <h1 className="text-2xl font-bold text-red-600 mb-2">An Unexpected Error Occurred</h1>
                    <p className="text-text-secondary mb-4">A component has crashed. You can try reloading or ask the AI for debugging help.</p>
                    
                    <details className="text-left bg-gray-50 p-2 rounded-md max-w-xl text-xs font-mono mb-4 flex-grow overflow-auto border border-border">
                        <summary className="cursor-pointer">Error Details</summary>
                        <pre className="mt-2 whitespace-pre-wrap">{this.state.error?.stack}</pre>
                    </details>
                    
                    <div className="flex gap-4 mt-auto">
                        <button
                            onClick={this.handleRevert}
                            className="flex-1 px-4 py-2 bg-yellow-400 text-yellow-900 font-bold rounded-md hover:bg-yellow-300 transition-colors"
                        >
                            Reload Application
                        </button>
                         <button
                            onClick={this.handleAskAi}
                            disabled={this.state.isAiLoading}
                            className="btn-primary flex-1 px-4 py-2 flex items-center justify-center gap-2"
                        >
                            <SparklesIcon />
                            {this.state.isAiLoading ? 'Analyzing...' : 'Ask AI for Help'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Help */}
                <div className="flex flex-col bg-gray-50 rounded-lg p-4 border border-border">
                    <h2 className="text-lg font-bold text-text-primary mb-2">AI Assistant</h2>
                    <div className="flex-grow overflow-y-auto">
                        {this.state.isAiLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {this.state.aiHelp && <MarkdownRenderer content={this.state.aiHelp} />}
                        {!this.state.isAiLoading && !this.state.aiHelp && <p className="text-text-secondary text-center pt-10">Click "Ask AI" to get debugging suggestions.</p>}
                    </div>
                </div>
            </div>
        </div>
      );
    }

    return this.props.children;
  }
}\`,
  'README.md': \`# DevCore AI Toolkit

> A supercharged, secure, client-side toolkit for modern developers, powered by Gemini. It runs entirely in your browser, keeping your code, data, and API keys private and secure on your local machine.

DevCore is a serverless web application designed to be a powerful assistant in your development workflow. It combines a suite of intelligent tools with a unique, AI-driven command center that can orchestrate actions across your favorite services like Jira, Slack, and GitHub.

---

## ✨ Key Features

-   **AI Command Center:** The heart of the toolkit. Use natural language (\\\`Ctrl+K\\\`) to navigate, run features, and execute complex, multi-service workflows.
-   **Workspace Connector Hub:** Connect to Jira, Slack, GitHub, and more. Let the AI execute commands like "create a high-priority Jira ticket and post a summary to the #dev channel in Slack."
-   **AI Feature Builder:** Generate multi-file components, unit tests, and conventional commit messages from a single, high-level prompt.
-   **Intelligent Code Tools:** Explain complex code, migrate between languages, review for bugs and security vulnerabilities, and refactor with one click.
-   **Performance & Auditing:** Profile runtime performance, analyze bundle stats, and audit live websites for accessibility issues with AI-powered advice.
-   **Visual Editors & Sandboxes:** A suite of focused tools, from a CSS Grid editor and a RegEx sandbox to a PWA Manifest generator, designed to streamline frontend development.

---

## 🏛️ Architecture: Secure & Client-Side

DevCore is built on a serverless, client-side architecture. This design choice offers several key advantages:

-   **Privacy First:** Your code, prompts, and sensitive data never leave your browser. All processing happens locally.
-   **Ultimate Security:** API keys and credentials for services like GitHub, Gemini, or Jira are encrypted with AES-GCM using the Web Crypto API. They are stored securely in your browser's IndexedDB and can only be decrypted with your master password.
-   **Runs Anywhere:** As a static application, you can deploy it on any CDN (like GitHub Pages or Netlify) or simply run it from your local filesystem. No backend, no databases, no complex setup.

---

## 🚀 Getting Started

1.  **Open the App:** Just open \\\`index.html\\\` in your browser.
2.  **Onboarding:** On first use, you'll be guided through a one-time setup:
    -   **Consent:** Grant permission for the app to use local storage.
    -   **Sign-In:** Sign in with your Google Account.
    -   **Create Vault:** Create a master password. This password encrypts and decrypts your credentials locally and is **never** stored.
    -   **Provide API Key:** If an API key was not provided during the build process, you will be prompted to enter your own Gemini API key, which will be stored securely in your new vault.
3.  **Connect Your Services:** Navigate to the **Workspace Connector Hub** to securely add your API keys for services like GitHub, Jira, and Slack.
4.  **Use the AI Command Center:** Press \\\`Ctrl+K\\\` (or \\\`Cmd+K\\\`) anywhere to open the command palette and start giving instructions to the AI.

---

## 🔌 The Workspace Connector Hub

This is the core of DevCore's workflow automation. Instead of just being a collection of tools, the Hub turns the app into a true command center.

-   **Connect Once, Use Everywhere:** Securely store your API tokens for essential developer services in the encrypted vault.
-   **AI-Powered Orchestration:** The AI Command Center can use these connections to perform multi-step actions across different platforms.
-   **Example Command:** _"A new critical bug was reported. Create a high-priority ticket in Jira, post a summary to the #engineering channel in Slack, and create a new git branch called \\\`hotfix/payment-bug\\\`."_

---

## 🔐 Security & Your Data

Your privacy is paramount. Here's how your data is handled:

-   **No Server-Side Storage:** All files, settings, and credentials reside exclusively in your browser's IndexedDB.
-   **End-to-End Encryption (Locally):** Credentials entered into the Vault are encrypted using the Web Crypto API before being stored. The encryption key is derived from your master password and is only held in memory during your session.
-   **Direct API Calls:** When you use an integrated service, the app makes direct, client-to-service API calls. Your data is not proxied through any intermediary server.

---

## 🛠️ Scope & Limitations

As a client-side application, DevCore has a focused scope. It is designed to be a powerful **assistant** for your development workflow, not a replacement for your primary IDE, backend services, or CI/CD platform. It excels at code generation, analysis, and API-based automation but does not run backend servers, train models, or manage infrastructure.\`,
  'components/ActionManager.tsx': \`import React, { useState } from 'react';
import JSZip from 'jszip';
import { getAllFiles } from '../services/dbService.ts';
import { ArrowDownTrayIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';
import { sourceFiles } from '../services/sourceRegistry.ts';

export const ActionManager: React.FC = () => {
    const [isLoading, setIsLoading] = useState<string | null>(null);

    const handleDownloadSource = async () => {
        setIsLoading('zip');
        try {
            const zip = new JSZip();

            for (const [filePath, content] of Object.entries(sourceFiles)) {
                zip.file(filePath, content);
            }

            const generatedFiles = await getAllFiles();
            if (generatedFiles.length > 0) {
                const generatedFolder = zip.folder('generated');
                generatedFiles.forEach(file => {
                    generatedFolder?.file(file.filePath, file.content);
                });
            }
            
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = 'devcore-ai-toolkit-source.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Failed to create ZIP file", error);
            alert(\\\`Error creating ZIP: \\\${error instanceof Error ? error.message : 'Unknown error'}\\\`);
        } finally {
            setIsLoading(null);
        }
    };

    return (
        <div className="absolute top-6 right-6 z-10">
            <button
                onClick={handleDownloadSource}
                disabled={!!isLoading}
                className="w-14 h-14 bg-primary text-text-on-primary rounded-full flex items-center justify-center shadow-lg hover:opacity-90 transition-colors disabled:bg-slate-600"
                aria-label="Download App Source Code & Generated Files"
                title="Download App Source Code & Generated Files"
            >
                {isLoading === 'zip' ? <LoadingSpinner /> : <ArrowDownTrayIcon />}
            </button>
        </div>
    );
};\`,
  'components/AiCodeExplainer.tsx': \`import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import mermaid from 'mermaid';
import { explainCodeStructured, generateMermaidJs } from '../services/index.ts';
import type { StructuredExplanation } from '../types.ts';
import { CpuChipIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

const exampleCode = \\\`const bubbleSort = (arr) => {
  for (let i = 0; i < arr.length; i++) {
    for (let j = 0; j < arr.length - i - 1; j++) {
      if (arr[j] > arr[j + 1]) {
        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
      }
    }
  }
  return arr;
};\\\`;

type ExplanationTab = 'summary' | 'lineByLine' | 'complexity' | 'suggestions' | 'flowchart';

const simpleSyntaxHighlight = (code: string) => {
    const escapedCode = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    return escapedCode
        .replace(/\\\\b(const|let|var|function|return|if|for|=>|import|from|export|default)\\\\b/g, '<span class="text-indigo-400 font-semibold">\\\$1</span>')
        .replace(/(\\\\\\\`|'|")(.*?)(\\\\\\\`|'|")/g, '<span class="text-emerald-400">\\\$1\\\$2\\\$3</span>')
        .replace(/(\\\\/\\\\/.*)/g, '<span class="text-gray-400 italic">\\\$1</span>')
        .replace(/(\\\\{|\\\\}|\\\\(|\\\\)|\\\\[|\\\\])/g, '<span class="text-gray-400">\\\$1</span>');
};

mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

export const AiCodeExplainer: React.FC<{ initialCode?: string }> = ({ initialCode }) => {
    const [code, setCode] = useState<string>(initialCode || exampleCode);
    const [explanation, setExplanation] = useState<StructuredExplanation | null>(null);
    const [mermaidCode, setMermaidCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [activeTab, setActiveTab] = useState<ExplanationTab>('summary');
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const preRef = useRef<HTMLPreElement>(null);
    const mermaidContainerRef = useRef<HTMLDivElement>(null);

    const handleExplain = useCallback(async (codeToExplain: string) => {
        if (!codeToExplain.trim()) {
            setError('Please enter some code to explain.');
            return;
        }
        setIsLoading(true);
        setError('');
        setExplanation(null);
        setMermaidCode('');
        setActiveTab('summary');
        try {
            const [explanationResult, mermaidResult] = await Promise.all([
                explainCodeStructured(codeToExplain),
                generateMermaidJs(codeToExplain)
            ]);
            setExplanation(explanationResult);
            setMermaidCode(mermaidResult.replace(/\\\`\\\`\\\`mermaid\\\\n|\\\`\\\`\\\`/g, ''));

        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to get explanation: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);
    
    useEffect(() => {
        if (initialCode) {
            setCode(initialCode);
            handleExplain(initialCode);
        }
    }, [initialCode, handleExplain]);

    useEffect(() => {
        const renderMermaid = async () => {
             if (activeTab === 'flowchart' && mermaidCode && mermaidContainerRef.current) {
                try {
                    mermaidContainerRef.current.innerHTML = ''; // Clear previous
                    const { svg } = await mermaid.render(\\\`mermaid-graph-\\\${Date.now()}\\\`, mermaidCode);
                    mermaidContainerRef.current.innerHTML = svg;
                } catch (e) {
                    console.error("Mermaid rendering error:", e);
                    mermaidContainerRef.current.innerHTML = \\\`<p class="text-red-500">Error rendering flowchart.</p>\\\`;
                }
            }
        }
        renderMermaid();
    }, [activeTab, mermaidCode]);


    const handleScroll = () => {
        if (preRef.current && textareaRef.current) {
            preRef.current.scrollTop = textareaRef.current.scrollTop;
            preRef.current.scrollLeft = textareaRef.current.scrollLeft;
        }
    };

    const highlightedCode = useMemo(() => simpleSyntaxHighlight(code), [code]);

    const renderTabContent = () => {
        if (!explanation) return null;
        switch(activeTab) {
            case 'summary':
                return <MarkdownRenderer content={explanation.summary} />;
            case 'lineByLine':
                return (
                    <div className="space-y-3">
                        {explanation.lineByLine.map((item, index) => (
                            <div key={index} className="p-3 bg-background rounded-md border border-border">
                                <p className="font-mono text-xs text-primary mb-1">Lines: {item.lines}</p>
                                <p className="text-sm">{item.explanation}</p>
                            </div>
                        ))}
                    </div>
                );
            case 'complexity':
                return (
                    <div>
                        <p><strong>Time Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.time}</span></p>
                        <p><strong>Space Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.space}</span></p>
                    </div>
                );
            case 'suggestions':
                return (
                     <ul className="list-disc list-inside space-y-2">
                        {explanation.suggestions.map((item, index) => <li key={index}>{item}</li>)}
                    </ul>
                );
            case 'flowchart':
                return (
                    <div ref={mermaidContainerRef} className="w-full h-full flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
        }
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex-shrink-0">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Explainer</span>
                </h1>
                <p className="text-text-secondary mt-1">Get a detailed, structured analysis of any code snippet.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                
                {/* Left Column: Code Input */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Your Code</label>
                    <div className="relative flex-grow bg-surface border border-border rounded-md focus-within:ring-2 focus-within:ring-primary overflow-hidden">
                        <textarea
                            ref={textareaRef}
                            id="code-input"
                            value={code}
                            onChange={(e) => setCode(e.target.value)}
                            onScroll={handleScroll}
                            placeholder="Paste your code here..."
                            spellCheck="false"
                            className="absolute inset-0 w-full h-full p-4 bg-transparent resize-none font-mono text-sm text-transparent caret-primary outline-none z-10"
                        />
                        <pre 
                            ref={preRef}
                            aria-hidden="true"
                            className="absolute inset-0 w-full h-full p-4 font-mono text-sm text-text-primary pointer-events-none z-0 whitespace-pre-wrap overflow-auto no-scrollbar"
                            dangerouslySetInnerHTML={{ __html: highlightedCode + '\\\\n' }}
                        />
                    </div>
                    <div className="mt-4 flex-shrink-0">
                        <button
                            onClick={() => handleExplain(code)}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner/> : 'Analyze Code'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Analysis */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Analysis</label>
                    <div className="relative flex-grow flex flex-col bg-surface border border-border rounded-md overflow-hidden">
                        <div className="flex-shrink-0 flex border-b border-border">
                           {(['summary', 'lineByLine', 'complexity', 'suggestions', 'flowchart'] as ExplanationTab[]).map(tab => (
                               <button key={tab} onClick={() => setActiveTab(tab)} disabled={!explanation}
                                className={\\\`px-4 py-2 text-sm font-medium capitalize transition-colors \\\${activeTab === tab ? 'bg-background text-primary font-semibold' : 'text-text-secondary hover:bg-gray-100 dark:hover:bg-slate-700 disabled:text-gray-400 dark:disabled:text-slate-500'}\\\`}>
                                   {tab.replace(/([A-Z])/g, ' \\\$1')}
                               </button>
                           ))}
                        </div>
                        <div className="p-4 flex-grow overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {explanation && !isLoading && renderTabContent()}
                            {!isLoading && !explanation && !error && <div className="text-text-secondary h-full flex items-center justify-center">The analysis will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/AiCodingChallenge.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { generateCodingChallengeStream } from '../services/index.ts';
import { BeakerIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';
import { MarkdownRenderer } from './shared/index.tsx';

export const AiCodingChallenge: React.FC = () => {
    const [challenge, setChallenge] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        setChallenge('');
        try {
            const stream = generateCodingChallengeStream(null);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChallenge(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate challenge: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        // Generate a challenge on initial load for a better user experience
        handleGenerate();
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold flex items-center">
                        <BeakerIcon />
                        <span className="ml-3">AI Coding Challenge Generator</span>
                    </h1>
                    <p className="text-text-secondary mt-1">Generate a unique coding problem to test your skills.</p>
                </div>
                <button
                    onClick={handleGenerate}
                    disabled={isLoading}
                    className="btn-primary flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Generate New Challenge'}
                </button>
            </header>
            <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                {isLoading && (
                     <div className="flex items-center justify-center h-full">
                        <LoadingSpinner />
                     </div>
                )}
                {error && <p className="text-red-500">{error}</p>}
                {challenge && !isLoading && (
                    <MarkdownRenderer content={challenge} />
                )}
                 {!isLoading && !challenge && !error && (
                    <div className="text-text-secondary h-full flex items-center justify-center">
                        Click "Generate New Challenge" to start.
                    </div>
                )}
            </div>
        </div>
    );
};\`,
  'components/AiCommitGenerator.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { generateCommitMessageStream } from '../services/index.ts';
import { GitBranchIcon } from './icons.tsx';
import { LoadingSpinner } from './shared/index.tsx';

const exampleDiff = \\\`diff --git a/src/components/Button.tsx b/src/components/Button.tsx
index 1b2c3d4..5e6f7g8 100644
--- a/src/components/Button.tsx
+++ b/src/components/Button.tsx
@@ -1,7 +1,7 @@
 import React from 'react';

 interface ButtonProps {
-  text: string;
+  label: string;
   onClick: () => void;
 }
\\\`;

export const AiCommitGenerator: React.FC<{ diff?: string }> = ({ diff: initialDiff }) => {
    const [diff, setDiff] = useState<string>(initialDiff || exampleDiff);
    const [message, setMessage] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async (diffToAnalyze: string) => {
        if (!diffToAnalyze.trim()) {
            setError('Please paste a diff to generate a message.');
            return;
        }
        setIsLoading(true);
        setError('');
        setMessage('');
        try {
            const stream = generateCommitMessageStream(diffToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setMessage(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate message: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialDiff) {
            setDiff(initialDiff);
            handleGenerate(initialDiff);
        }
    }, [initialDiff, handleGenerate]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(message);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Commit Message Generator</span>
                </h1>
                <p className="text-slate-400 mt-1">Paste your diff and let Gemini craft the perfect commit message.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                    <label htmlFor="diff-input" className="text-sm font-medium text-slate-400 mb-2">Git Diff</label>
                    <textarea
                        id="diff-input"
                        value={diff}
                        onChange={(e) => setDiff(e.target.value)}
                        placeholder="Paste your git diff here..."
                        className="flex-grow p-4 bg-slate-900 border border-slate-700 rounded-md resize-none font-mono text-sm text-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none"
                    />
                     <button
                        onClick={() => handleGenerate(diff)}
                        disabled={isLoading}
                        className="btn-primary mt-4 w-full flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Commit Message'}
                    </button>
                </div>
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-slate-400 mb-2">Generated Message</label>
                    <div className="relative flex-grow p-4 bg-slate-800/50 border border-slate-700/50 rounded-md overflow-y-auto">
                        {isLoading && (
                             <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                             </div>
                        )}
                        {error && <p className="text-red-400">{error}</p>}
                        {message && !isLoading && (
                            <>
                               <button onClick={handleCopy} className="absolute top-2 right-2 px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded-md text-xs">Copy</button>
                               <pre className="whitespace-pre-wrap font-sans text-slate-200">{message}</pre>
                            </>
                        )}
                         {!isLoading && !message && !error && (
                            <div className="text-slate-500 h-full flex items-center justify-center">
                                The commit message will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/ApiKeyPromptModal.tsx': \`import React, { useState } from 'react';
import { useGlobalState } from '../contexts/GlobalStateContext.tsx';
import { useVaultModal } from '../contexts/VaultModalContext.tsx';
import { saveCredential } from '../services/vaultService.ts';
import { initializeAiClient } from '../services/aiService.ts';
import { LoadingSpinner } from './shared/LoadingSpinner.tsx';
import { useNotification } from '../contexts/NotificationContext.tsx';

export const ApiKeyPromptModal: React.FC = () => {
    const { dispatch } = useGlobalState();
    const { requestUnlock } = useVaultModal();
    const { addNotification } = useNotification();
    const [apiKey, setApiKey] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!apiKey.trim()) {
            addNotification('Please enter an API key.', 'error');
            return;
        }

        setIsLoading(true);

        try {
            // Ensure the vault is unlocked before saving
            const unlocked = await requestUnlock();
            if (!unlocked) {
                addNotification('Vault must be unlocked to save the API key.', 'error');
                setIsLoading(false);
                return;
            }

            // Save the key and re-initialize the AI client
            await saveCredential('gemini_api_key', apiKey);
            await initializeAiClient();

            addNotification('API Key saved successfully!', 'success');
            dispatch({ type: 'SET_API_KEY_MISSING', payload: false });

        } catch (error) {
            addNotification(error instanceof Error ? error.message : 'An unknown error occurred.', 'error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-md m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Enter Gemini API Key</h2>
                <p className="text-sm text-text-secondary mb-4">
                    Your Gemini API key is required to power the AI features. It will be stored securely and encrypted in your browser's local storage.
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="api-key-input" className="block text-sm font-medium">API Key</label>
                        <input
                            id="api-key-input"
                            type="password"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[100px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Save & Continue'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};\`,
  'components/CommandPalette.tsx': \`
import React, { useState, useEffect, useMemo } from 'react';
import { ALL_FEATURES } from './features/index.ts';
import type { ViewType } from '../types.ts';

interface CommandPaletteProps {
  isOpen: boolean;
  onClose: () => void;
  onSelect: (view: ViewType) => void;
}

export const CommandPalette: React.FC<CommandPaletteProps> = ({ isOpen, onClose, onSelect }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);

  useEffect(() => {
    if (!isOpen) {
      setSearchTerm('');
      setSelectedIndex(0);
    }
  }, [isOpen]);
  
  const commandOptions = useMemo(() => {
    const navigationCommands = [
      { id: 'ai-feature-builder', name: 'Go to AI Builder', category: 'Navigation', icon: <span />, description: ''},
    ];
    
    const featureCommands = ALL_FEATURES.map(f => ({...f, name: \\\`Open: \\\${f.name}\\\`}));

     return [
      ...navigationCommands,
      ...featureCommands,
     ].filter(
        (feature) =>
          feature.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          feature.category.toLowerCase().includes(searchTerm.toLowerCase())
      );
  }, [searchTerm]);

  useEffect(() => {
    setSelectedIndex(0);
  }, [commandOptions.length]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!isOpen) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setSelectedIndex((prev) => (prev + 1) % commandOptions.length);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setSelectedIndex((prev) => (prev - 1 + commandOptions.length) % commandOptions.length);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        const selected = commandOptions[selectedIndex];
        if (selected) {
          onSelect(selected.id as ViewType);
        }
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, commandOptions, selectedIndex, onSelect]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-start justify-center pt-20" onClick={onClose}>
      <div
        className="w-full max-w-xl bg-surface border border-border rounded-lg shadow-2xl overflow-hidden"
        onClick={(e) => e.stopPropagation()}
      >
        <input
          type="text"
          placeholder="Type a command or search..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          autoFocus
          className="w-full p-4 bg-surface text-text-primary text-lg focus:outline-none border-b border-border"
        />
        <ul className="max-h-96 overflow-y-auto p-2">
          {commandOptions.length > 0 ? (
            commandOptions.map((item, index) => (
              <li
                key={item.id + index}
                onMouseDown={() => {
                   onSelect(item.id as ViewType);
                }}
                className={\\\`flex items-center justify-between p-3 rounded-md cursor-pointer \\\${
                  selectedIndex === index ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100'
                }\\\`}
              >
                <div className="flex items-center space-x-3">
                    <div className="text-text-secondary">{item.icon}</div>
                    <span className="text-text-primary">{item.name}</span>
                </div>
                <span className="text-xs text-text-secondary bg-gray-100 px-2 py-1 rounded">{item.category}</span>
              </li>
            ))
          ) : (
            <li className="p-4 text-center text-text-secondary">No results found.</li>
          )}
        </ul>
      </div>
    </div>
  );
};\`,
  'components/ErrorBoundary.tsx': \`import React from 'react';
import { logError } from '../services/telemetryService.ts';
import { debugErrorStream } from '../services/aiService.ts';
import { SparklesIcon } from './icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from './shared/index.tsx';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  aiHelp: string;
  isAiLoading: boolean;
}

export class ErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null, aiHelp: '', isAiLoading: false };
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logError(error, { componentStack: errorInfo.componentStack });
  }
  
  handleRevert = () => {
    window.location.reload();
  };

  handleAskAi = async () => {
    if (!this.state.error) return;

    this.setState({ isAiLoading: true, aiHelp: '' });
    try {
        const stream = debugErrorStream(this.state.error);
        let fullResponse = '';
        for await (const chunk of stream) {
            fullResponse += chunk;
            this.setState({ aiHelp: fullResponse });
        }
    } catch (e) {
        this.setState({ aiHelp: 'Sorry, the AI assistant could not be reached.' });
        logError(e as Error, { context: 'AI Error Debugging' });
    } finally {
        this.setState({ isAiLoading: false });
    }
};

  render() {
    if (this.state.hasError) {
      return (
        <div className="w-full h-full flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 bg-background text-text-primary">
            <div className="w-full max-w-4xl bg-surface border border-border rounded-lg p-6 shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="flex flex-col">
                    <h1 className="text-2xl font-bold text-red-600 mb-2">An Unexpected Error Occurred</h1>
                    <p className="text-text-secondary mb-4">A component has crashed. You can try reloading or ask the AI for debugging help.</p>
                    
                    <details className="text-left bg-gray-50 dark:bg-slate-900 p-2 rounded-md max-w-xl text-xs font-mono mb-4 flex-grow overflow-auto border border-border">
                        <summary className="cursor-pointer">Error Details</summary>
                        <pre className="mt-2 whitespace-pre-wrap">{this.state.error?.stack}</pre>
                    </details>
                    
                    <div className="flex gap-4 mt-auto">
                        <button
                            onClick={this.handleRevert}
                            className="flex-1 px-4 py-2 bg-yellow-400 text-yellow-900 font-bold rounded-md hover:bg-yellow-300 transition-colors"
                        >
                            Reload Application
                        </button>
                         <button
                            onClick={this.handleAskAi}
                            disabled={this.state.isAiLoading}
                            className="btn-primary flex-1 px-4 py-2 flex items-center justify-center gap-2"
                        >
                            <SparklesIcon />
                            {this.state.isAiLoading ? 'Analyzing...' : 'Ask AI for Help'}
                        </button>
                    </div>
                </div>

                <div className="flex flex-col bg-gray-50 dark:bg-slate-900 rounded-lg p-4 border border-border">
                    <h2 className="text-lg font-bold text-text-primary mb-2">AI Assistant</h2>
                    <div className="flex-grow overflow-y-auto">
                        {this.state.isAiLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {this.state.aiHelp && <MarkdownRenderer content={this.state.aiHelp} />}
                        {!this.state.isAiLoading && !this.state.aiHelp && <p className="text-text-secondary text-center pt-10">Click "Ask AI" to get debugging suggestions.</p>}
                    </div>
                </div>
            </div>
        </div>
      );
    }

    return this.props.children;
  }
}
\`,
  'components/FeatureGrid.tsx': \`

import React, { useState, useMemo } from 'react';
import type { Feature } from '../types.ts';

interface FeatureCardProps {
  feature: Feature;
  onClick: () => void;
}

const FeatureCard: React.FC<FeatureCardProps> = ({ feature, onClick }) => {
  return (
    <div
      onClick={onClick}
      className="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 flex flex-col justify-between transition-all duration-200 hover:bg-slate-800 hover:border-slate-700 hover:shadow-lg hover:shadow-cyan-500/10 cursor-pointer"
    >
      <div>
        <div className="flex items-center space-x-3 mb-2">
          <div className="text-cyan-400">{feature.icon}</div>
          <h3 className="font-bold text-slate-200">{feature.name}</h3>
        </div>
        <p className="text-sm text-slate-400">{feature.description}</p>
      </div>
      <div className="text-xs text-slate-500 mt-4">{feature.category}</div>
    </div>
  );
};


export const FeatureGrid: React.FC<{ features: Feature[], onFeatureSelect?: (id: string) => void }> = ({ features, onFeatureSelect }) => {
  const [searchTerm, setSearchTerm] = useState('');

  const filteredFeatures = useMemo(() => {
    const featureList = features || [];
    if (!searchTerm) return featureList;
    return featureList.filter(
      (feature) =>
        feature.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        feature.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        feature.category.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm, features]);

  return (
    <div className="p-4 sm:p-6 lg:p-8 h-full">
      <div className="mb-8 text-center">
        <h1 className="text-4xl font-extrabold text-slate-100 tracking-tight">DevCore AI Toolkit</h1>
        <p className="mt-2 text-lg text-slate-400">A focused toolkit for modern development, powered by AI.</p>
        <div className="mt-6 max-w-xl mx-auto">
          <input
            type="text"
            placeholder="Search features..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition-shadow"
          />
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {filteredFeatures.map((feature) => (
          <FeatureCard key={feature.id} feature={feature} onClick={() => onFeatureSelect?.(feature.id)} />
        ))}
      </div>
    </div>
  );
};\`,
  'components/LoginView.tsx': \`import React from 'react';
import { signInWithGoogle } from '../services/googleAuthService.ts';

export const LoginView: React.FC = () => {
    return (
        <div className="h-full w-full flex items-center justify-center bg-background">
            <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md shadow-lg animate-pop-in">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-primary mx-auto mb-4">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                <h1 className="text-2xl font-bold text-text-primary">Welcome to DevCore AI</h1>
                <p className="text-text-secondary my-4">
                    Please sign in with your Google account to securely access your workspace tools and manage API connections.
                </p>
                <button 
                    onClick={signInWithGoogle} 
                    className="btn-primary w-full px-6 py-3 flex items-center justify-center gap-2 mx-auto"
                >
                    Sign in with Google
                </button>
            </div>
        </div>
    );
};\`,
  'components/SettingsView.tsx': \`import React from 'react';
import { useGlobalState } from '../contexts/GlobalStateContext.tsx';
import { clearAllFiles } from '../services/dbService.ts';
import { useLocalStorage } from '../hooks/useLocalStorage.ts';
import { useTheme } from '../hooks/useTheme.ts';
import { ALL_FEATURES } from './features/index.ts';
import { TrashIcon, SunIcon, MoonIcon } from './icons.tsx';

const ToggleSwitch: React.FC<{ checked: boolean, onChange: () => void }> = ({ checked, onChange }) => {
    return (
        <button
            role="switch"
            aria-checked={checked}
            onClick={onChange}
            className={\\\`\\\${checked ? 'bg-primary' : 'bg-gray-300 dark:bg-slate-600'} relative inline-flex h-6 w-11 items-center rounded-full transition-colors\\\`}
        >
            <span className={\\\`\\\${checked ? 'translate-x-6' : 'translate-x-1'} inline-block h-4 w-4 transform rounded-full bg-white transition-transform\\\`} />
        </button>
    );
};

export const SettingsView: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const [themeState, toggleTheme, , clearCustomTheme] = useTheme();
    const [, setSnippets] = useLocalStorage('devcore_snippets', []);
    const [, setNotes] = useLocalStorage('devcore_moodboard', []);
    const [, setDevNotes] = useLocalStorage('devcore_notes', []);
    const [, setPersonalities] = useLocalStorage('devcore_ai_personalities', []);

    const handleClearGeneratedFiles = async () => {
        if (window.confirm("Are you sure you want to delete all AI-generated files? This cannot be undone.")) {
            await clearAllFiles();
            alert("Generated files cleared.");
        }
    };
    
    const handleClearSnippets = () => {
        if (window.confirm("Are you sure you want to delete all saved snippets? This cannot be undone.")) {
            setSnippets([]);
            alert("Snippets cleared.");
        }
    };

    const handleClearNotes = () => {
        if (window.confirm("Are you sure you want to delete all notes and moodboard items? This cannot be undone.")) {
            setNotes([]);
            setDevNotes([]);
            alert("Notes & Moodboard cleared.");
        }
    };
    
    const handleClearPersonalities = () => {
        if (window.confirm("Are you sure you want to delete all AI Personalities? This cannot be undone.")) {
            setPersonalities([]);
            alert("AI Personalities cleared.");
        }
    }

    return (
        <div className="w-full text-text-primary">
            <header className="sticky top-0 z-10 p-4 sm:p-6 lg:p-8 border-b border-border bg-surface/80 backdrop-blur-sm">
                <div className="max-w-4xl mx-auto w-full">
                    <h1 className="text-4xl font-extrabold tracking-tight">Settings</h1>
                    <p className="mt-2 text-lg text-text-secondary">Manage application preferences and data.</p>
                </div>
            </header>

            <div className="p-4 sm:p-6 lg:p-8 space-y-8 max-w-4xl mx-auto w-full">
                 {/* Appearance Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Appearance</h2>
                    <div className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg">
                        <div>
                            <p className="font-medium">Theme</p>
                            <p className="text-sm text-text-secondary">Switch between light and dark mode.</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <SunIcon />
                            <ToggleSwitch checked={themeState.mode === 'dark'} onChange={toggleTheme} />
                            <MoonIcon />
                        </div>
                    </div>
                    <div className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg mt-4">
                        <div>
                            <p className="font-medium">Custom Theme</p>
                            <p className="text-sm text-text-secondary">Revert to the default application theme.</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={clearCustomTheme} disabled={!themeState.customColors} className="px-4 py-2 text-sm rounded-md bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                Revert to Default
                            </button>
                        </div>
                    </div>
                </section>
                
                 {/* Feature Visibility Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Feature Visibility</h2>
                     <p className="text-sm text-text-secondary mb-4">
                        Hide or show features in the main sidebar. This does not disable them; they can still be accessed via the AI Command Center.
                    </p>
                    <div className="space-y-2">
                        {ALL_FEATURES.filter(f => !['ai-command-center', 'connections', 'project-explorer'].includes(f.id)).map(feature => {
                            const isVisible = !state.hiddenFeatures.includes(feature.id);
                            return (
                                <div key={feature.id} className="flex items-center justify-between p-4 bg-surface border border-border rounded-lg">
                                    <div>
                                        <p className="font-medium">{feature.name}</p>
                                        <p className="text-sm text-text-secondary">{feature.description}</p>
                                    </div>
                                    <ToggleSwitch 
                                        checked={isVisible}
                                        onChange={() => dispatch({ type: 'TOGGLE_FEATURE_VISIBILITY', payload: { featureId: feature.id } })}
                                    />
                                </div>
                            );
                        })}
                    </div>
                </section>
                
                {/* Data Management Section */}
                <section>
                    <h2 className="text-2xl font-bold border-b border-border pb-2 mb-4">Data Management</h2>
                    <div className="space-y-4">
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Generated Files</p>
                                <p className="text-sm text-text-secondary">Removes all files created by the AI Feature Builder.</p>
                             </div>
                             <button onClick={handleClearGeneratedFiles} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Snippet Vault</p>
                                <p className="text-sm text-text-secondary">Removes all saved code snippets.</p>
                             </div>
                             <button onClick={handleClearSnippets} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear Notes & Whiteboard</p>
                                <p className="text-sm text-text-secondary">Removes all items from Dev Notes and Digital Whiteboard.</p>
                             </div>
                             <button onClick={handleClearNotes} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                         <div className="flex items-center justify-between p-4 bg-surface border border-red-500/20 rounded-lg">
                             <div>
                                <p className="font-medium text-red-700 dark:text-red-400">Clear AI Personalities</p>
                                <p className="text-sm text-text-secondary">Removes all custom AI personalities.</p>
                             </div>
                             <button onClick={handleClearPersonalities} className="flex items-center gap-2 px-4 py-2 rounded-md bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors">
                                <TrashIcon /> Clear
                             </button>
                         </div>
                    </div>
                </section>
            </div>
        </div>
    );
};
\`,
  'components/StatusBar.tsx': \`import React, { useState, useEffect } from 'react';
import { GitBranchIcon, BellIcon } from './icons.tsx';

type BgImageStatus = 'loading' | 'loaded' | 'error';

const StatusMessage: React.FC<{ status: BgImageStatus }> = ({ status }) => {
    const [visible, setVisible] = useState(true);

    useEffect(() => {
        setVisible(true);
        if (status === 'error') {
            const timer = setTimeout(() => setVisible(false), 5000);
            return () => clearTimeout(timer);
        }
    }, [status]);

    if (!visible || status === 'loaded') {
        return null;
    }

    if (status === 'loading') {
        return (
            <div className="flex items-center space-x-2">
                <div className="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
                <span>Generating background...</span>
            </div>
        );
    }

    if (status === 'error') {
        return (
            <div className="flex items-center space-x-2 text-yellow-600">
                <span>Background failed. Using fallback.</span>
            </div>
        );
    }

    return null;
};

const Clock: React.FC = () => {
    const [time, setTime] = useState(() => new Date());

    useEffect(() => {
        const timerId = setInterval(() => {
            setTime(new Date());
        }, 1000);

        return () => clearInterval(timerId);
    }, []);

    return <span>{time.toLocaleTimeString()}</span>
}


export const StatusBar: React.FC<{ bgImageStatus: BgImageStatus }> = ({ bgImageStatus }) => {
  return (
    <footer className="w-full bg-surface/70 backdrop-blur-sm border-t border-border px-4 py-1 flex items-center justify-between text-xs text-text-secondary">
      <div className="flex items-center space-x-4">
        <div className="flex items-center space-x-1 cursor-pointer hover:text-primary transition-colors">
          <GitBranchIcon />
          <span>main</span>
        </div>
        <StatusMessage status={bgImageStatus} />
      </div>
      <div className="flex items-center space-x-4">
        <Clock />
        <span className="hidden sm:block">Ready</span>
        <div className="flex items-center space-x-1 cursor-pointer hover:text-primary transition-colors">
          <BellIcon />
          <span>0</span>
        </div>
        <span className="hidden sm:block">
          Powered by Gemini
        </span>
      </div>
    </footer>
  );
};\`,
  'components/desktop/.placeholder': \`\`,
  'components/desktop/DesktopView.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { FeatureDock } from './FeatureDock.tsx';
import { Window } from './Window.tsx';
import { Taskbar } from './Taskbar.tsx';
import { ALL_FEATURES } from '../features/index.ts';
import type { Feature, ViewType } from '../../types.ts';
import { ActionManager } from '../ActionManager.tsx';

interface WindowState {
  id: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  zIndex: number;
  isMinimized: boolean;
}

const Z_INDEX_BASE = 10;

export const DesktopView: React.FC<{ openFeatureId?: string, onNavigate: (view: ViewType, props?: any) => void; }> = ({ openFeatureId, onNavigate }) => {
    const [windows, setWindows] = useState<Record<string, WindowState>>({});
    const [activeId, setActiveId] = useState<string | null>(null);
    const [nextZIndex, setNextZIndex] = useState(Z_INDEX_BASE);
    
    const openWindow = useCallback((featureId: string) => {
        if (!featureId) return;
        const newZIndex = nextZIndex + 1;
        setNextZIndex(newZIndex);
        setActiveId(featureId);

        setWindows(prev => {
            const existingWindow = prev[featureId];
            if (existingWindow) {
                return {
                    ...prev,
                    [featureId]: {
                        ...existingWindow,
                        isMinimized: false,
                        zIndex: newZIndex,
                    }
                };
            }

            const openWindowsCount = Object.values(prev).filter(w => !w.isMinimized).length;
            const newWindow: WindowState = {
                id: featureId,
                position: { x: 50 + openWindowsCount * 30, y: 50 + openWindowsCount * 30 },
                size: { width: 800, height: 600 },
                zIndex: newZIndex,
                isMinimized: false,
            };
            return { ...prev, [featureId]: newWindow };
        });
    }, [nextZIndex]);
    
    useEffect(() => {
        if(openFeatureId) {
            openWindow(openFeatureId);
            // Reset the view in global state so it doesn't re-trigger
            onNavigate('dashboard', {});
        }
    }, [openFeatureId, openWindow, onNavigate]);

    const closeWindow = (id: string) => {
        setWindows(prev => {
            const newState = { ...prev };
            delete newState[id];
            return newState;
        });
        if (activeId === id) {
            setActiveId(null);
        }
    };

    const minimizeWindow = (id: string) => {
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], isMinimized: true }
        }));
        setActiveId(null);
    };

    const focusWindow = (id: string) => {
        if (id === activeId) return;
        const newZIndex = nextZIndex + 1;
        setNextZIndex(newZIndex);
        setActiveId(id);
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], zIndex: newZIndex }
        }));
    };
    
    const updateWindowState = (id: string, updates: Partial<WindowState>) => {
        setWindows(prev => ({
            ...prev,
            [id]: { ...prev[id], ...updates }
        }));
    }

    const openWindows = Object.values(windows).filter(w => !w.isMinimized);
    const minimizedWindows = Object.values(windows).filter(w => w.isMinimized);
    const featuresMap = new Map(ALL_FEATURES.map(f => [f.id, f]));

    return (
        <div className="h-full flex flex-row bg-transparent w-full">
            <FeatureDock onOpen={openWindow} />
            <div className="flex-grow relative overflow-hidden">
                {openWindows.map(win => {
                    const feature = featuresMap.get(win.id);
                    if (!feature) return null;
                    return (
                        <Window
                            key={win.id}
                            feature={feature}
                            state={win}
                            isActive={win.id === activeId}
                            onClose={() => closeWindow(win.id)}
                            onMinimize={() => minimizeWindow(win.id)}
                            onFocus={() => focusWindow(win.id)}
                            onUpdate={updateWindowState}
                        />
                    );
                })}
                <ActionManager />
            </div>
            <Taskbar
                minimizedWindows={minimizedWindows.map(w => featuresMap.get(w.id)).filter(Boolean) as Feature[]}
                onRestore={openWindow}
            />
        </div>
    );
};\`,
  'components/desktop/FeatureDock.tsx': \`import React from 'react';
import { ALL_FEATURES } from '../features/index.ts';
import type { Feature } from '../../types.ts';

interface FeatureButtonProps {
    feature: Feature;
    onOpen: (id: string) => void;
}

const FeatureButton: React.FC<FeatureButtonProps> = ({ feature, onOpen }) => {
    return (
        <button
            onClick={() => onOpen(feature.id)}
            className="w-24 h-24 flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/80 transition-colors group"
            title={feature.name}
        >
            <div className="text-cyan-400 group-hover:scale-110 transition-transform">{feature.icon}</div>
            <span className="text-xs text-slate-300 mt-2 text-center w-full break-words">{feature.name}</span>
        </button>
    );
};

interface FeatureDockProps {
    onOpen: (id: string) => void;
}

export const FeatureDock: React.FC<FeatureDockProps> = ({ onOpen }) => {
    return (
        <div className="h-96 flex-shrink-0 bg-slate-900/50 backdrop-blur-sm border-b border-slate-800 p-3 overflow-y-auto">
            <div className="flex flex-wrap gap-3 justify-center">
                {ALL_FEATURES.map(feature => (
                    <FeatureButton key={feature.id} feature={feature} onOpen={onOpen} />
                ))}
            </div>
        </div>
    );
};
\`,
  'components/desktop/Taskbar.tsx': \`import React from 'react';
import type { Feature } from '../../types.ts';

interface TaskbarProps {
  minimizedWindows: Feature[];
  onRestore: (id: string) => void;
}

export const Taskbar: React.FC<TaskbarProps> = ({ minimizedWindows, onRestore }) => {
  if (minimizedWindows.length === 0) {
    return null;
  }

  return (
    <div className="absolute bottom-0 left-20 right-0 h-10 bg-slate-900/80 backdrop-blur-sm border-t border-slate-700 flex items-center px-2 gap-2 z-[999]">
      {minimizedWindows.map(feature => (
        <button
          key={feature.id}
          onClick={() => onRestore(feature.id)}
          className="h-8 px-3 flex items-center gap-2 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm"
          title={\\\`Restore \\\${feature.name}\\\`}
        >
          <div className="w-4 h-4">{feature.icon}</div>
          <span>{feature.name}</span>
        </button>
      ))}
    </div>
  );
};
\`,
  'components/desktop/Window.tsx': \`import React, { Suspense, useRef, useState } from 'react';
import type { Feature } from '../../types.ts';
import { FEATURES_MAP } from '../features/index.ts';
import { LoadingIndicator } from '../../App.tsx';
import { MinimizeIcon, XMarkIcon } from '../icons.tsx';

interface WindowState {
  id: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  zIndex: number;
  isMinimized: boolean;
}

interface WindowProps {
  feature: Feature;
  state: WindowState;
  isActive: boolean;
  onClose: (id: string) => void;
  onMinimize: (id: string) => void;
  onFocus: (id: string) => void;
  onUpdate: (id: string, updates: Partial<WindowState>) => void;
}

export const Window: React.FC<WindowProps> = ({ feature, state, isActive, onClose, onMinimize, onFocus, onUpdate }) => {
  const dragStartPos = useRef<{ x: number; y: number } | null>(null);
  const initialPos = useRef<{ x: number; y: number } | null>(null);
  
  const FeatureComponent = FEATURES_MAP.get(feature.id)?.component;

  const handleDragStart = (e: React.MouseEvent<HTMLDivElement>) => {
    e.preventDefault();
    onFocus(feature.id);
    dragStartPos.current = { x: e.clientX, y: e.clientY };
    initialPos.current = { x: state.position.x, y: state.position.y };
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('mouseup', handleDragEnd);
  };

  const handleDragMove = (e: MouseEvent) => {
    if (!dragStartPos.current || !initialPos.current) return;
    const dx = e.clientX - dragStartPos.current.x;
    const dy = e.clientY - dragStartPos.current.y;
    onUpdate(feature.id, { position: { x: initialPos.current.x + dx, y: initialPos.current.y + dy }});
  };

  const handleDragEnd = () => {
    dragStartPos.current = null;
    initialPos.current = null;
    window.removeEventListener('mousemove', handleDragMove);
    window.removeEventListener('mouseup', handleDragEnd);
  };
  
  return (
    <div
      className={\\\`absolute bg-slate-800/70 backdrop-blur-md border rounded-lg shadow-2xl shadow-black/50 flex flex-col transition-all duration-100 \\\${isActive ? 'border-cyan-500/50' : 'border-slate-700/50'}\\\`}
      style={{
        left: state.position.x,
        top: state.position.y,
        width: state.size.width,
        height: state.size.height,
        zIndex: state.zIndex
      }}
      onMouseDown={() => onFocus(feature.id)}
    >
      <header
        className={\\\`flex items-center justify-between h-8 px-2 border-b \\\${isActive ? 'bg-slate-700/50 border-slate-600' : 'bg-slate-800/50 border-slate-700'} rounded-t-lg cursor-move\\\`}
        onMouseDown={handleDragStart}
      >
        <div className="flex items-center gap-2 text-xs">
           <div className="w-4 h-4">{feature.icon}</div>
           <span>{feature.name}</span>
        </div>
        <div className="flex items-center gap-1">
          <button onClick={() => onMinimize(feature.id)} className="p-1 rounded hover:bg-slate-600"><MinimizeIcon /></button>
          <button onClick={() => onClose(feature.id)} className="p-1 rounded hover:bg-red-500/50"><XMarkIcon className="w-4 h-4"/></button>
        </div>
      </header>
      <main className="flex-1 overflow-auto bg-slate-800/50 rounded-b-lg">
        {FeatureComponent ? (
          <Suspense fallback={<LoadingIndicator/>}>
            <FeatureComponent />
          </Suspense>
        ) : (
            <div className="p-4 text-red-400">Error: Component not found for {feature.name}</div>
        )}
      </main>
    </div>
  );
};\`,
  'components/features/AccessibilityAuditor.tsx': \`import React, { useState, useRef } from 'react';
import { suggestA11yFix } from '../../services/index.ts';
import { runAxeAudit, AxeResult } from '../../services/auditing/accessibilityService.ts';
import { EyeIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const AccessibilityAuditor: React.FC = () => {
    const [url, setUrl] = useState('https://react.dev');
    const [auditUrl, setAuditUrl] = useState('');
    const [results, setResults] = useState<AxeResult | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isLoadingAi, setIsLoadingAi] = useState<string | null>(null);
    const [aiFixes, setAiFixes] = useState<Record<string, string>>({});
    const iframeRef = useRef<HTMLIFrameElement>(null);

    const handleAudit = () => {
        const targetUrl = url.startsWith('http') ? url : \\\`https://\\\${url}\\\`;
        setAuditUrl(targetUrl);
        setIsLoading(true);
        setResults(null);
        setAiFixes({});
    };
    
    const handleIframeLoad = async () => {
        if (isLoading && iframeRef.current) {
            try {
                const auditResults = await runAxeAudit(iframeRef.current.contentWindow!.document);
                setResults(auditResults);
            } catch (error) {
                console.error(error);
                alert('Could not audit this page. This may be due to security restrictions (CORS).');
            } finally {
                setIsLoading(false);
            }
        }
    };
    
    const handleGetFix = async (issue: any) => {
        const issueId = issue.id;
        setIsLoadingAi(issueId);
        try {
            const fix = await suggestA11yFix(issue);
            setAiFixes(prev => ({...prev, [issueId]: fix}));
        } catch(e) {
            setAiFixes(prev => ({...prev, [issueId]: 'Could not get suggestion.'}));
        } finally {
            setIsLoadingAi(null);
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><EyeIcon /><span className="ml-3">Automated Accessibility Auditor</span></h1><p className="text-text-secondary mt-1">Audit a live URL for accessibility issues and get AI-powered fixes.</p></header>
            <div className="flex gap-2 mb-4"><input type="text" value={url} onChange={e => setUrl(e.target.value)} placeholder="https://example.com" className="flex-grow p-2 border rounded"/><button onClick={handleAudit} disabled={isLoading} className="btn-primary px-6 py-2">{isLoading ? 'Auditing...' : 'Audit'}</button></div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"><iframe ref={iframeRef} src={auditUrl} title="Audit Target" className="w-full h-full bg-white" onLoad={handleIframeLoad} sandbox="allow-scripts allow-same-origin"/></div>
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <h3 className="text-lg font-bold mb-2">Audit Results</h3>
                    <div className="flex-grow overflow-y-auto pr-2">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                        {results && (results.violations.length === 0 ? <p>No violations found!</p> :
                            results.violations.map((v, i) => (
                                <div key={v.id + i} className="p-3 mb-2 bg-background border border-border rounded">
                                    <p className="font-bold text-red-600">{v.help}</p>
                                    <p className="text-sm my-1">{v.description}</p>
                                    <button onClick={() => handleGetFix(v)} disabled={!!isLoadingAi} className="text-xs flex items-center gap-1 text-primary font-semibold"><SparklesIcon/> {isLoadingAi === v.id ? 'Getting fix...' : 'Ask AI for a fix'}</button>
                                    {aiFixes[v.id] && <div className="mt-2 text-xs border-t pt-2"><MarkdownRenderer content={aiFixes[v.id]}/></div>}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AiCodeExplainer.tsx': \`import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import mermaid from 'mermaid';
import { explainCodeStructured, generateMermaidJs } from '../../services/index.ts';
import type { StructuredExplanation } from '../../types.ts';
import { useTheme } from '../../hooks/useTheme.ts';
import { CpuChipIcon } from '../icons.tsx';
import { MarkdownRenderer, LoadingSpinner } from '../shared/index.tsx';

const exampleCode = \\\`const bubbleSort = (arr) => {
  for (let i = 0; i < arr.length; i++) {
    for (let j = 0; j < arr.length - i - 1; j++) {
      if (arr[j] > arr[j + 1]) {
        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
      }
    }
  }
  return arr;
};\\\`;

type ExplanationTab = 'summary' | 'lineByLine' | 'complexity' | 'suggestions' | 'flowchart';

const simpleSyntaxHighlight = (code: string) => {
    const escapedCode = code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    return escapedCode
        .replace(/\\\\b(const|let|var|function|return|if|for|=>|import|from|export|default)\\\\b/g, '<span class="text-indigo-400 font-semibold">\\\$1</span>')
        .replace(/(\\\\\\\`|'|")(.*?)(\\\\\\\`|'|")/g, '<span class="text-emerald-400">\\\$1\\\$2\\\$3</span>')
        .replace(/(\\\\/\\\\/.*)/g, '<span class="text-gray-400 italic">\\\$1</span>')
        .replace(/(\\\\{|\\\\}|\\\\(|\\\\)|\\\\[|\\\\])/g, '<span class="text-gray-400">\\\$1</span>');
};

mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });

export const AiCodeExplainer: React.FC<{ initialCode?: string }> = ({ initialCode }) => {
    const [code, setCode] = useState<string>(initialCode || exampleCode);
    const [explanation, setExplanation] = useState<StructuredExplanation | null>(null);
    const [mermaidCode, setMermaidCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [activeTab, setActiveTab] = useState<ExplanationTab>('summary');
    const [themeState] = useTheme();
    const textareaRef = useRef<HTMLTextAreaElement>(null);
    const preRef = useRef<HTMLPreElement>(null);
    const mermaidContainerRef = useRef<HTMLDivElement>(null);

    const handleExplain = useCallback(async (codeToExplain: string) => {
        if (!codeToExplain.trim()) {
            setError('Please enter some code to explain.');
            return;
        }
        setIsLoading(true);
        setError('');
        setExplanation(null);
        setMermaidCode('');
        setActiveTab('summary');
        try {
            const [explanationResult, mermaidResult] = await Promise.all([
                explainCodeStructured(codeToExplain),
                generateMermaidJs(codeToExplain)
            ]);
            setExplanation(explanationResult);
            setMermaidCode(mermaidResult.replace(/\\\`\\\`\\\`mermaid\\\\n|\\\`\\\`\\\`/g, ''));

        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to get explanation: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);
    
    useEffect(() => {
        if (initialCode) {
            setCode(initialCode);
            handleExplain(initialCode);
        }
    }, [initialCode, handleExplain]);

    useEffect(() => {
        const renderMermaid = async () => {
             if (activeTab === 'flowchart' && mermaidCode && mermaidContainerRef.current) {
                try {
                    mermaid.initialize({ startOnLoad: false, theme: themeState.mode === 'dark' ? 'dark' : 'neutral', securityLevel: 'loose' });
                    mermaidContainerRef.current.innerHTML = ''; // Clear previous
                    const { svg } = await mermaid.render(\\\`mermaid-graph-\\\${Date.now()}\\\`, mermaidCode);
                    mermaidContainerRef.current.innerHTML = svg;
                } catch (e) {
                    console.error("Mermaid rendering error:", e);
                    mermaidContainerRef.current.innerHTML = \\\`<p class="text-red-500">Error rendering flowchart.</p>\\\`;
                }
            }
        }
        renderMermaid();
    }, [activeTab, mermaidCode, themeState.mode]);


    const handleScroll = () => {
        if (preRef.current && textareaRef.current) {
            preRef.current.scrollTop = textareaRef.current.scrollTop;
            preRef.current.scrollLeft = textareaRef.current.scrollLeft;
        }
    };

    const highlightedCode = useMemo(() => simpleSyntaxHighlight(code), [code]);

    const renderTabContent = () => {
        if (!explanation) return null;
        switch(activeTab) {
            case 'summary':
                return <MarkdownRenderer content={explanation.summary} />;
            case 'lineByLine':
                return (
                    <div className="space-y-3">
                        {explanation.lineByLine.map((item, index) => (
                            <div key={index} className="p-3 bg-background rounded-md border border-border">
                                <p className="font-mono text-xs text-primary mb-1">Lines: {item.lines}</p>
                                <p className="text-sm">{item.explanation}</p>
                            </div>
                        ))}
                    </div>
                );
            case 'complexity':
                return (
                    <div>
                        <p><strong>Time Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.time}</span></p>
                        <p><strong>Space Complexity:</strong> <span className="font-mono text-amber-600">{explanation.complexity.space}</span></p>
                    </div>
                );
            case 'suggestions':
                return (
                     <ul className="list-disc list-inside space-y-2">
                        {explanation.suggestions.map((item, index) => <li key={index}>{item}</li>)}
                    </ul>
                );
            case 'flowchart':
                return (
                    <div ref={mermaidContainerRef} className="w-full h-full flex items-center justify-center">
                        <LoadingSpinner />
                    </div>
                );
        }
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex-shrink-0">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Explainer</span>
                </h1>
                <p className="text-text-secondary mt-1">Get a detailed, structured analysis of any code snippet.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                
                {/* Left Column: Code Input */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Your Code</label>
                    <div className="relative flex-grow bg-surface border border-border rounded-md focus-within:ring-2 focus-within:ring-primary overflow-hidden">
                        <textarea
                            ref={textareaRef}
                            id="code-input"
                            value={code}
                            onChange={(e) => setCode(e.target.value)}
                            onScroll={handleScroll}
                            placeholder="Paste your code here..."
                            spellCheck="false"
                            className="absolute inset-0 w-full h-full p-4 bg-transparent resize-none font-mono text-sm text-transparent caret-primary outline-none z-10"
                        />
                        <pre 
                            ref={preRef}
                            aria-hidden="true"
                            className="absolute inset-0 w-full h-full p-4 font-mono text-sm text-text-primary pointer-events-none z-0 whitespace-pre-wrap overflow-auto no-scrollbar"
                            dangerouslySetInnerHTML={{ __html: highlightedCode + '\\\\n' }}
                        />
                    </div>
                    <div className="mt-4 flex-shrink-0">
                        <button
                            onClick={() => handleExplain(code)}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner/> : 'Analyze Code'}
                        </button>
                    </div>
                </div>

                {/* Right Column: AI Analysis */}
                <div className="flex flex-col min-h-0 md:col-span-1">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Analysis</label>
                    <div className="relative flex-grow flex flex-col bg-surface border border-border rounded-md overflow-hidden">
                        <div className="flex-shrink-0 flex border-b border-border">
                           {(['summary', 'lineByLine', 'complexity', 'suggestions', 'flowchart'] as ExplanationTab[]).map(tab => (
                               <button key={tab} onClick={() => setActiveTab(tab)} disabled={!explanation}
                                className={\\\`px-4 py-2 text-sm font-medium capitalize transition-colors \\\${activeTab === tab ? 'bg-background text-primary font-semibold' : 'text-text-secondary hover:bg-gray-100 dark:hover:bg-slate-700 disabled:text-gray-400 dark:disabled:text-slate-500'}\\\`}>
                                   {tab.replace(/([A-Z])/g, ' \\\$1')}
                               </button>
                           ))}
                        </div>
                        <div className="p-4 flex-grow overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {explanation && !isLoading && renderTabContent()}
                            {!isLoading && !explanation && !error && <div className="text-text-secondary h-full flex items-center justify-center">The analysis will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AiCodeMigrator.tsx': \`

import React, { useState, useCallback, useEffect } from 'react';
import { migrateCodeStream } from '../../services/index.ts';
import { ArrowPathIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const languages = ['SASS', 'CSS', 'JavaScript', 'TypeScript', 'Python', 'Go', 'React', 'Vue', 'Angular', 'Tailwind CSS'];

const exampleCode = \\\`// SASS
\\\$primary-color: #333;

body {
  color: \\\$primary-color;
  font-family: sans-serif;
}\\\`;

export const AiCodeMigrator: React.FC<{ inputCode?: string, fromLang?: string, toLang?: string }> = ({ inputCode: initialCode, fromLang: initialFrom, toLang: initialTo }) => {
    const [inputCode, setInputCode] = useState<string>(initialCode || exampleCode);
    const [outputCode, setOutputCode] = useState<string>('');
    const [fromLang, setFromLang] = useState(initialFrom || 'SASS');
    const [toLang, setToLang] = useState(initialTo || 'CSS');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleMigrate = useCallback(async (code: string, from: string, to: string) => {
        if (!code.trim()) {
            setError('Please enter some code to migrate.');
            return;
        }
        setIsLoading(true);
        setError('');
        setOutputCode('');
        try {
            const stream = migrateCodeStream(code, from, to);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setOutputCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to migrate code: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialCode && initialFrom && initialTo) {
            setInputCode(initialCode);
            setFromLang(initialFrom);
            setToLang(initialTo);
            handleMigrate(initialCode, initialFrom, initialTo);
        }
    }, [initialCode, initialFrom, initialTo, handleMigrate]);

    const LanguageSelector: React.FC<{ value: string, onChange: (val: string) => void }> = ({ value, onChange }) => (
        <select value={value} onChange={e => onChange(e.target.value)} className="w-full px-3 py-2 rounded-md bg-surface border border-border">
            {languages.map(lang => <option key={lang} value={lang}>{lang}</option>)}
        </select>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><ArrowPathIcon /><span className="ml-3">AI Code Migrator</span></h1>
                <p className="text-text-secondary mt-1">Translate code between languages, frameworks, and syntax styles.</p>
            </header>
            <div className="flex-grow flex flex-col min-h-0">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
                    <div className="flex flex-col h-full">
                        <div className="mb-2">
                            <label className="text-sm font-medium text-text-secondary">From:</label>
                            <LanguageSelector value={fromLang} onChange={setFromLang} />
                        </div>
                        <textarea
                            value={inputCode}
                            onChange={(e) => setInputCode(e.target.value)}
                            placeholder="Paste your source code here..."
                            className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                        />
                    </div>
                    <div className="flex flex-col h-full">
                        <div className="mb-2">
                            <label className="text-sm font-medium text-text-secondary">To:</label>
                            <LanguageSelector value={toLang} onChange={setToLang} />
                        </div>
                        <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                           {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="p-4 text-red-500">{error}</p>}
                            {outputCode && !isLoading && <MarkdownRenderer content={outputCode} />}
                            {!isLoading && !outputCode && !error && <div className="text-text-secondary h-full flex items-center justify-center">Migrated code will appear here.</div>}
                        </div>
                    </div>
                </div>
                 <button
                    onClick={() => handleMigrate(inputCode, fromLang, toLang)}
                    disabled={isLoading}
                    className="btn-primary mt-4 w-full max-w-sm mx-auto flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Migrate Code'}
                </button>
            </div>
        </div>
    );
};\`,
  'components/features/AiCodingChallenge.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { generateCodingChallengeStream } from '../../services/index.ts';
import { BeakerIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

export const AiCodingChallenge: React.FC = () => {
    const [challenge, setChallenge] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        setChallenge('');
        try {
            const stream = generateCodingChallengeStream(null);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChallenge(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate challenge: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        // Generate a challenge on initial load for a better user experience
        handleGenerate();
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold flex items-center">
                        <BeakerIcon />
                        <span className="ml-3">AI Coding Challenge Generator</span>
                    </h1>
                    <p className="text-text-secondary mt-1">Generate a unique coding problem to test your skills.</p>
                </div>
                <button
                    onClick={handleGenerate}
                    disabled={isLoading}
                    className="btn-primary flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Generate New Challenge'}
                </button>
            </header>
            <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                {isLoading && (
                     <div className="flex items-center justify-center h-full">
                        <LoadingSpinner />
                     </div>
                )}
                {error && <p className="text-red-500">{error}</p>}
                {challenge && !isLoading && (
                    <MarkdownRenderer content={challenge} />
                )}
                 {!isLoading && !challenge && !error && (
                    <div className="text-text-secondary h-full flex items-center justify-center">
                        Click "Generate New Challenge" to start.
                    </div>
                )}
            </div>
        </div>
    );
};\`,
  'components/features/AiCommandCenter.tsx': \`import React, { useState, useCallback } from 'react';
import { Type, FunctionDeclaration } from "@google/genai";
import { logError } from '../../services/telemetryService.ts';
import { getInferenceFunction, CommandResponse } from '../../services/aiService.ts';
import { FEATURE_TAXONOMY } from '../../services/taxonomyService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { CommandLineIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { ALL_FEATURE_IDS } from '../../constants.tsx';
import { executeWorkspaceAction, ACTION_REGISTRY } from '../../services/workspaceConnectorService.ts';

const baseFunctionDeclarations: FunctionDeclaration[] = [
    {
        name: 'navigateTo',
        description: 'Navigates to a specific feature page.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                featureId: { 
                    type: Type.STRING, 
                    description: 'The ID of the feature to navigate to.',
                    enum: ALL_FEATURE_IDS
                },
            },
            required: ['featureId'],
        },
    },
    {
        name: 'runFeatureWithInput',
        description: 'Navigates to a feature and passes initial data to it.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                 featureId: { 
                    type: Type.STRING, 
                    description: 'The ID of the feature to run.',
                    enum: ALL_FEATURE_IDS
                },
                props: {
                    type: Type.OBJECT,
                    description: 'An object containing the initial properties for the feature, based on its required inputs.',
                    properties: {
                        initialCode: { type: Type.STRING },
                        initialPrompt: { type: Type.STRING },
                        beforeCode: { type: Type.STRING },
                        afterCode: { type: Type.STRING },
                        logInput: { type: Type.STRING },
                        diff: { type: Type.STRING },
                        codeInput: { type: Type.STRING },
                        jsonInput: { type: Type.STRING },
                    }
                }
            },
            required: ['featureId', 'props']
        }
    }
];

// Dynamically add the workspace action
const functionDeclarations: FunctionDeclaration[] = [
    ...baseFunctionDeclarations,
    {
        name: 'runWorkspaceAction',
        description: 'Executes a defined action on a connected workspace service like Jira, Slack, or GitHub.',
        parameters: {
            type: Type.OBJECT,
            properties: {
                 actionId: {
                    type: Type.STRING,
                    description: 'The unique identifier for the action to execute.',
                    enum: [ ...ACTION_REGISTRY.keys() ]
                },
                params: {
                    type: Type.OBJECT,
                    description: 'An object containing the parameters for the action, matching its required inputs.'
                }
            },
            required: ['actionId', 'params']
        }
    }
]

const knowledgeBase = FEATURE_TAXONOMY.map(f => \\\`- \\\${f.name} (\\\${f.id}): \\\${f.description} Inputs: \\\${f.inputs}\\\`).join('\\\\n');

const ExamplePromptButton: React.FC<{ text: string, onClick: (text: string) => void }> = ({ text, onClick }) => (
    <button
        onClick={() => onClick(text)}
        className="px-3 py-1.5 bg-surface border border-border rounded-full text-xs hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
    >
        {text}
    </button>
)

export const AiCommandCenter: React.FC = () => {
    const { dispatch } = useGlobalState();
    const [prompt, setPrompt] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [lastResponse, setLastResponse] = useState('');

    const handleCommand = useCallback(async () => {
        if (!prompt.trim()) return;

        setIsLoading(true);
        setLastResponse('');

        try {
            const response: CommandResponse = await getInferenceFunction(prompt, functionDeclarations, knowledgeBase);
            
            if (response.functionCalls && response.functionCalls.length > 0) {
                const call = response.functionCalls[0];
                const { name, args } = call;

                setLastResponse(\\\`Understood! Executing command: \\\${name}\\\`);

                switch (name) {
                    case 'navigateTo':
                        dispatch({ type: 'SET_VIEW', payload: { view: args.featureId }});
                        break;
                    case 'runFeatureWithInput':
                         dispatch({ type: 'SET_VIEW', payload: { view: args.featureId, props: args.props } });
                        break;
                    case 'runWorkspaceAction':
                        try {
                            const result = await executeWorkspaceAction(args.actionId, args.params);
                            setLastResponse(\\\`Action '\\\${args.actionId}' executed successfully.\\\\n\\\\nResult: \\\\\\\`\\\\\\\`\\\\\\\`json\\\\n\\\${JSON.stringify(result, null, 2)}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`);
                        } catch (e) {
                            setLastResponse(\\\`Action failed: \\\${e instanceof Error ? e.message : 'Unknown error'}\\\`);
                        }
                        break;
                    default:
                        setLastResponse(\\\`Unknown command: \\\${name}\\\`);
                }
                 setPrompt('');
            } else {
                 setLastResponse(response.text);
            }

        } catch (err) {
            logError(err as Error, { prompt });
            setLastResponse(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [prompt, dispatch]);

    const handleKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleCommand();
        }
    };
    
    const handleExampleClick = (text: string) => {
        setPrompt(text);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center justify-center">
                    <CommandLineIcon />
                    <span className="ml-3">AI Command Center</span>
                </h1>
                <p className="mt-2 text-lg text-text-secondary">What would you like to do?</p>
            </header>
            
            <div className="flex-grow flex flex-col justify-end max-w-3xl w-full mx-auto">
                {lastResponse && (
                    <div className="mb-4 p-4 bg-surface rounded-lg text-text-primary border border-border">
                        <p><strong>AI:</strong> {lastResponse}</p>
                    </div>
                )}
                 <div className="relative">
                    <textarea
                        value={prompt}
                        onChange={e => setPrompt(e.target.value)}
                        onKeyDown={handleKeyDown}
                        disabled={isLoading}
                        placeholder='Try "explain this code: const a = 1;" or "open the theme designer"'
                        className="w-full p-4 pr-28 rounded-lg bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none resize-none shadow-sm"
                        rows={2}
                    />
                    <button
                        onClick={handleCommand}
                        disabled={isLoading}
                        className="btn-primary absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2"
                    >
                       {isLoading ? <LoadingSpinner/> : 'Send'}
                    </button>
                </div>
                 <div className="flex flex-wrap items-center justify-center gap-2 mt-4">
                    <ExamplePromptButton text="Open Theme Designer" onClick={handleExampleClick} />
                    <ExamplePromptButton text="Generate a commit for a bug fix" onClick={handleExampleClick} />
                    <ExamplePromptButton text="Create a regex for email validation" onClick={handleExampleClick} />
                </div>
                 <p className="text-xs text-text-secondary text-center mt-2">Press Enter to send, Shift+Enter for new line.</p>
            </div>
        </div>
    );
};\`,
  'components/features/AiCommitGenerator.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { generateCommitMessageStream } from '../../services/index.ts';
import { downloadFile } from '../../services/fileUtils.ts';
import { GitBranchIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const exampleDiff = \\\`diff --git a/src/components/Button.tsx b/src/components/Button.tsx
index 1b2c3d4..5e6f7g8 100644
--- a/src/components/Button.tsx
+++ b/src/components/Button.tsx
@@ -1,7 +1,7 @@
 import React from 'react';

 interface ButtonProps {
-  text: string;
+  label: string;
   onClick: () => void;
 }
\\\`;

export const AiCommitGenerator: React.FC<{ diff?: string }> = ({ diff: initialDiff }) => {
    const [diff, setDiff] = useState<string>(initialDiff || exampleDiff);
    const [message, setMessage] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async (diffToAnalyze: string) => {
        if (!diffToAnalyze.trim()) {
            setError('Please paste a diff to generate a message.');
            return;
        }
        setIsLoading(true);
        setError('');
        setMessage('');
        try {
            const stream = generateCommitMessageStream(diffToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setMessage(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate message: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialDiff) {
            setDiff(initialDiff);
            handleGenerate(initialDiff);
        }
    }, [initialDiff, handleGenerate]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(message);
    };
    
    const handleDownload = () => {
        downloadFile(message, 'commit_message.txt', 'text/plain');
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Commit Message Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your diff and let Gemini craft the perfect commit message.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="diff-input" className="text-sm font-medium text-text-secondary mb-2">Git Diff</label>
                    <textarea
                        id="diff-input"
                        value={diff}
                        onChange={(e) => setDiff(e.target.value)}
                        placeholder="Paste your git diff here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm text-text-primary focus:ring-2 focus:ring-primary focus:outline-none"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button
                        onClick={() => handleGenerate(diff)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Commit Message'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Message</label>
                        {message && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={handleCopy} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="relative flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto">
                        {isLoading && (
                             <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                             </div>
                        )}
                        {error && <p className="text-red-500">{error}</p>}
                        {message && !isLoading && (
                           <pre className="whitespace-pre-wrap font-sans text-text-primary">{message}</pre>
                        )}
                         {!isLoading && !message && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">
                                The commit message will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AiFeatureBuilder.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import type { GeneratedFile } from '../../types.ts';
import { generateFeature, generateFullStackFeature, generateUnitTestsStream, generateCommitMessageStream, generateDockerfile } from '../../services/aiService.ts';
import { saveFile, getAllFiles, clearAllFiles } from '../../services/dbService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { CpuChipIcon, DocumentTextIcon, BeakerIcon, GitBranchIcon, CloudIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

type SupplementalTab = 'TESTS' | 'COMMIT' | 'DEPLOYMENT' | 'CODE';
type OutputTab = GeneratedFile | SupplementalTab;

export const AiFeatureBuilder: React.FC = () => {
    const [prompt, setPrompt] = useState<string>('A simple "Hello World" React component with a button that shows an alert.');
    const [framework] = useState('React');
    const [styling] = useState('Tailwind CSS');
    const [includeBackend, setIncludeBackend] = useState(false);

    const [generatedFiles, setGeneratedFiles] = useState<GeneratedFile[]>([]);
    const [unitTests, setUnitTests] = useState<string>('');
    const [commitMessage, setCommitMessage] = useState<string>('');
    const [dockerfile, setDockerfile] = useState<string>('');

    const [activeTab, setActiveTab] = useState<OutputTab>('CODE');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    
    useEffect(() => {
        const loadFiles = async () => {
            const files = await getAllFiles();
            setGeneratedFiles(files);
            if (files.length > 0) setActiveTab(files[0]);
        };
        loadFiles();
    }, []);

    const handleGenerate = useCallback(async () => {
        if (!prompt.trim()) { setError('Please enter a feature description.'); return; }
        setIsLoading(true);
        setError('');
        await clearAllFiles();
        setGeneratedFiles([]); setUnitTests(''); setCommitMessage(''); setDockerfile(''); setActiveTab('CODE');

        try {
            const resultFiles = includeBackend
                ? await generateFullStackFeature(prompt, framework, styling)
                : await generateFeature(prompt, framework, styling);
            
            for (const file of resultFiles) { await saveFile(file); }
            setGeneratedFiles(resultFiles);

            if (resultFiles.length > 0) {
                const componentFile = resultFiles.find(f => f.filePath.endsWith('.tsx') || f.filePath.endsWith('.jsx'));
                setActiveTab(componentFile || resultFiles[0]);

                const testStream = generateUnitTestsStream(componentFile?.content || resultFiles[0].content);
                const diffContext = resultFiles.map(f => \\\`File: \\\${f.filePath}\\\\n\\\\n\\\${f.content}\\\`).join('\\\\n---\\\\n');
                const commitStream = generateCommitMessageStream(diffContext);
                
                let tests = ''; for await (const chunk of testStream) { tests += chunk; setUnitTests(tests); }
                let commit = ''; for await (const chunk of commitStream) { commit += chunk; setCommitMessage(commit); }
                
                if (!includeBackend) {
                    const dockerfileStream = generateDockerfile(framework);
                    let docker = ''; for await (const chunk of dockerfileStream) { docker += chunk; setDockerfile(docker); }
                }
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate feature.');
        } finally {
            setIsLoading(false);
        }
    }, [prompt, framework, styling, includeBackend]);
    
    const renderContent = () => {
        if (typeof activeTab === 'string') {
            switch (activeTab) {
                case 'TESTS': return <MarkdownRenderer content={unitTests} />;
                case 'COMMIT': return <pre className="w-full h-full p-4 whitespace-pre-wrap font-sans text-sm">{commitMessage}</pre>;
                case 'DEPLOYMENT': return <MarkdownRenderer content={dockerfile} />;
                default: return <div className="p-4">Select a file</div>;
            }
        }
        return <MarkdownRenderer content={'\\\`\\\`\\\`tsx\\\\n' + activeTab.content + '\\\\n\\\`\\\`\\\`'} />;
    }

    return (
        <div className="h-full flex flex-col text-text-primary bg-surface">
            <header className="p-4 border-b border-border flex-shrink-0">
                <h1 className="text-xl font-bold flex items-center"><CpuChipIcon /><span className="ml-3">AI Feature Builder</span></h1>
            </header>
            <div className="flex-grow flex min-h-0">
                <main className="flex-1 flex flex-col min-w-0">
                    <div className="flex-grow flex flex-col bg-background">
                         <div className="border-b border-border flex items-center bg-surface overflow-x-auto">
                            {generatedFiles.map(file => (
                                <button key={file.filePath} onClick={() => setActiveTab(file)} className={\\\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \\\${activeTab === file ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\\\`}><DocumentTextIcon /> {file.filePath}</button>
                            ))}
                            {unitTests && <button onClick={() => setActiveTab('TESTS')} className={\\\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \\\${activeTab === 'TESTS' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\\\`}><BeakerIcon /> Tests</button>}
                            {commitMessage && <button onClick={() => setActiveTab('COMMIT')} className={\\\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \\\${activeTab === 'COMMIT' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\\\`}><GitBranchIcon /> Commit</button>}
                            {dockerfile && !includeBackend && <button onClick={() => setActiveTab('DEPLOYMENT')} className={\\\`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm \\\${activeTab === 'DEPLOYMENT' ? 'bg-background border-b-2 border-primary text-text-primary' : 'text-text-secondary hover:bg-gray-50'}\\\`}><CloudIcon /> Dockerfile</button>}
                        </div>
                        <div className="flex-grow p-2 overflow-auto">
                            {isLoading && !generatedFiles.length ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : renderContent()}
                        </div>
                    </div>
                    
                    <div className="flex-shrink-0 p-4 border-t border-border bg-surface">
                         <div className="flex items-center gap-2 mb-2">
                            <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={includeBackend} onChange={e => setIncludeBackend(e.target.checked)} /> Include Backend (Cloud Function + Firestore)</label>
                        </div>
                        <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder="e.g., A user profile card with an avatar, name, and bio." className="w-full p-2 bg-background border border-border rounded-md resize-none text-sm h-20"/>
                         <div className="flex gap-2 mt-2">
                             <button onClick={handleGenerate} disabled={isLoading} className="btn-primary flex-grow flex items-center justify-center gap-2 px-4 py-2">
                                {isLoading ? <><LoadingSpinner /> Generating...</> : 'Generate Feature'}
                            </button>
                         </div>
                         {error && <p className="text-red-600 text-xs mt-2 text-center">{error}</p>}
                    </div>
                </main>
            </div>
        </div>
    );
};
\`,
  'components/features/AiImageGenerator.tsx': \`import React, { useState, useCallback, useRef } from 'react';
import { generateImage, generateImageFromImageAndText } from '../../services/aiService.ts';
import { fileToBase64, blobToDataURL } from '../../services/fileUtils.ts';
import { ImageGeneratorIcon, SparklesIcon, ArrowDownTrayIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const surprisePrompts = [
    'A majestic lion wearing a crown, painted in the style of Van Gogh.',
    'A futuristic cityscape on another planet with two moons in the sky.',
    'A cozy, magical library inside a giant tree.',
    'A surreal image of a ship sailing on a sea of clouds.',
    'An astronaut riding a space-themed bicycle on the moon.',
];

interface UploadedImage {
    base64: string;
    dataUrl: string;
    mimeType: string;
}

export const AiImageGenerator: React.FC = () => {
    const [prompt, setPrompt] = useState<string>('A photorealistic image of a futuristic city at sunset, with flying cars.');
    const [uploadedImage, setUploadedImage] = useState<UploadedImage | null>(null);
    const [generatedImageUrl, setGeneratedImageUrl] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleGenerate = useCallback(async () => {
        if (!prompt.trim()) {
            setError('Please enter a prompt to generate an image.');
            return;
        }
        setIsLoading(true);
        setError('');
        setGeneratedImageUrl(null);
        try {
            let resultUrl: string;
            if (uploadedImage) {
                resultUrl = await generateImageFromImageAndText(prompt, uploadedImage.base64, uploadedImage.mimeType);
            } else {
                resultUrl = await generateImage(prompt);
            }
            setGeneratedImageUrl(resultUrl);
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate image: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [prompt, uploadedImage]);

    const handleSurpriseMe = () => {
        const randomPrompt = surprisePrompts[Math.floor(Math.random() * surprisePrompts.length)];
        setPrompt(randomPrompt);
    };

    const processImageBlob = async (blob: Blob) => {
        try {
            const [dataUrl, base64] = await Promise.all([
                blobToDataURL(blob),
                fileToBase64(blob as File)
            ]);
            setUploadedImage({ dataUrl, base64, mimeType: blob.type });
        } catch (e) {
            setError('Could not process the image.');
        }
    };

    const handlePaste = useCallback(async (event: React.ClipboardEvent) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) {
                    await processImageBlob(blob);
                    return;
                }
            }
        }
    }, []);

    const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (file) {
            await processImageBlob(file);
        }
    };
    
    const handleDownload = () => {
        if (!generatedImageUrl) return;
        const link = document.createElement('a');
        link.href = generatedImageUrl;
        link.download = \\\`\\\${prompt.slice(0, 30).replace(/\\\\s/g, '_')}.png\\\`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <ImageGeneratorIcon />
                    <span className="ml-3">AI Image Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate images from text, or provide an image for inspiration.</p>
            </header>
            
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                {/* Left Column: Inputs */}
                <div className="flex flex-col gap-4">
                    <div>
                        <label htmlFor="prompt-input" className="text-sm font-medium text-text-secondary">Your Prompt</label>
                        <textarea
                            id="prompt-input"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="e.g., A cute cat wearing a wizard hat"
                            className="w-full p-3 mt-1 rounded-md bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none resize-y"
                            rows={3}
                        />
                    </div>
                    
                    <div className="flex flex-col flex-grow min-h-[200px]">
                         <label className="text-sm font-medium text-text-secondary mb-1">Inspiration Image (Optional)</label>
                         <div onPaste={handlePaste} className="relative flex-grow flex flex-col items-center justify-center bg-surface p-4 rounded-lg border-2 border-dashed border-border focus:outline-none focus:border-primary" tabIndex={0}>
                            {uploadedImage ? (
                                <>
                                    <img src={uploadedImage.dataUrl} alt="Uploaded content" className="max-w-full max-h-full object-contain rounded-md shadow-lg" />
                                    <button onClick={() => setUploadedImage(null)} className="absolute top-2 right-2 p-1 bg-black/30 text-white rounded-full hover:bg-black/50"><XMarkIcon /></button>
                                </>
                            ) : (
                                <div className="text-center text-text-secondary">
                                    <h2 className="text-lg font-bold text-text-primary">Paste an image here</h2>
                                    <p className="text-sm">(Cmd/Ctrl + V)</p>
                                    <p className="text-xs my-1">or</p>
                                    <button onClick={() => fileInputRef.current?.click()} className="text-sm font-semibold text-primary hover:underline">Upload File</button>
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden"/>
                                </div>
                            )}
                         </div>
                    </div>
                    
                    <div className="flex gap-2">
                        <button
                            onClick={handleGenerate}
                            disabled={isLoading}
                            className="btn-primary w-full flex items-center justify-center px-6 py-3"
                        >
                            {isLoading ? <LoadingSpinner /> : 'Generate Image'}
                        </button>
                        <button
                            onClick={handleSurpriseMe}
                            disabled={isLoading}
                            className="px-4 py-3 bg-surface border border-border rounded-md hover:bg-gray-100 transition-colors"
                            title="Surprise Me!"
                        >
                            <SparklesIcon />
                        </button>
                    </div>
                </div>

                {/* Right Column: Output */}
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Image</label>
                    <div className="flex-grow flex items-center justify-center bg-background border-2 border-dashed border-border rounded-lg p-4 relative overflow-auto">
                        {isLoading && <LoadingSpinner />}
                        {error && <p className="text-red-500 text-center">{error}</p>}
                        {generatedImageUrl && !isLoading && (
                            <>
                                <img src={generatedImageUrl} alt={prompt || "Generated by AI"} className="max-w-full max-h-full object-contain rounded-md shadow-lg" />
                                <button 
                                  onClick={handleDownload}
                                  className="absolute top-4 right-4 p-2 bg-black/30 text-white rounded-full hover:bg-black/50 backdrop-blur-sm"
                                  title="Download Image"
                                >
                                    <ArrowDownTrayIcon />
                                </button>
                            </>
                        )}
                        {!isLoading && !generatedImageUrl && !error && (
                            <div className="text-center text-text-secondary">
                                <p>Your generated image will appear here.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AiPersonalityForge.tsx': \`import React, { useState, useEffect, useRef } from 'react';
import { SparklesIcon, PlusIcon, TrashIcon, ArrowDownTrayIcon, ArrowUpOnSquareIcon } from '../icons.tsx';
import { useAiPersonalities } from '../../hooks/useAiPersonalities.ts';
import { formatSystemPromptToString } from '../../utils/promptUtils.ts';
import { streamContent } from '../../services/index.ts';
import { downloadJson } from '../../services/fileUtils.ts';
import type { SystemPrompt } from '../../types.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';

const defaultNewPrompt: Omit<SystemPrompt, 'id' | 'name'> = {
    persona: 'You are a helpful assistant.',
    rules: [],
    outputFormat: 'markdown',
    exampleIO: [],
};

export const AiPersonalityForge: React.FC = () => {
    const [personalities, setPersonalities] = useAiPersonalities();
    const [activeId, setActiveId] = useState<string | null>(null);
    const { addNotification } = useNotification();
    const fileInputRef = useRef<HTMLInputElement>(null);

    // Testbed State
    const [testbedInput, setTestbedInput] = useState('');
    const [chatHistory, setChatHistory] = useState<{ role: 'user' | 'model'; content: string }[]>([]);
    const [isStreaming, setIsStreaming] = useState(false);

    const activePersonality = personalities.find(p => p.id === activeId);

    useEffect(() => {
        if (!activeId && personalities.length > 0) {
            setActiveId(personalities[0].id);
        }
    }, [personalities, activeId]);
    
    const handleUpdate = (field: keyof SystemPrompt, value: any) => {
        if (!activePersonality) return;
        const updated = { ...activePersonality, [field]: value };
        setPersonalities(personalities.map(p => (p.id === activeId ? updated : p)));
    };

    const handleAddNew = () => {
        const newId = Date.now().toString();
        const newPersonality: SystemPrompt = { ...defaultNewPrompt, id: newId, name: 'Untitled Personality' };
        setPersonalities([...personalities, newPersonality]);
        setActiveId(newId);
    };

    const handleDelete = (id: string) => {
        if (window.confirm('Are you sure you want to delete this personality?')) {
            setPersonalities(personalities.filter(p => p.id !== id));
            if (activeId === id) {
                setActiveId(personalities.length > 1 ? personalities[0].id : null);
            }
        }
    };
    
    const handleTestbedSend = async () => {
        if (!testbedInput.trim() || !activePersonality || isStreaming) return;
        
        const systemInstruction = formatSystemPromptToString(activePersonality);
        const newHistory = [...chatHistory, { role: 'user' as const, content: testbedInput }];
        setChatHistory(newHistory);
        setTestbedInput('');
        setIsStreaming(true);

        try {
            const stream = streamContent(testbedInput, systemInstruction, 0.7);
            let fullResponse = '';
            setChatHistory(prev => [...prev, { role: 'model', content: '' }]);
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChatHistory(prev => {
                    const last = prev[prev.length - 1];
                    if (last.role === 'model') {
                        return [...prev.slice(0, -1), { role: 'model', content: fullResponse }];
                    }
                    return prev;
                });
            }
        } catch (e) {
            const errorMsg = e instanceof Error ? e.message : 'An error occurred';
            setChatHistory(prev => [...prev, { role: 'model', content: \\\`**Error:** \\\${errorMsg}\\\` }]);
        } finally {
            setIsStreaming(false);
        }
    };
    
    const handleExport = () => {
        if (!activePersonality) return;
        downloadJson(activePersonality, \\\`\\\${activePersonality.name.replace(/\\\\s+/g, '_')}.json\\\`);
        addNotification('Personality exported!', 'success');
    };

    const handleImport = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const imported = JSON.parse(event.target?.result as string) as SystemPrompt;
                // Basic validation
                if (imported.id && imported.name && imported.persona) {
                    setPersonalities(prev => [...prev.filter(p => p.id !== imported.id), imported]);
                    setActiveId(imported.id);
                    addNotification('Personality imported!', 'success');
                } else {
                     addNotification('Invalid personality file.', 'error');
                }
            } catch {
                 addNotification('Failed to parse JSON file.', 'error');
            }
        };
        reader.readAsText(file);
    };

    return (
        <div className="h-full flex text-text-primary">
            {/* Sidebar */}
            <aside className="w-64 bg-surface border-r border-border flex flex-col">
                <div className="p-4 border-b border-border">
                    <h2 className="text-lg font-bold">Personalities</h2>
                </div>
                <div className="flex-grow overflow-y-auto">
                    {personalities.map(p => (
                        <div key={p.id} onClick={() => setActiveId(p.id)} className={\\\`group flex justify-between items-center p-3 text-sm cursor-pointer \\\${activeId === p.id ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\\\`}>
                            <span className="truncate">{p.name}</span>
                            <button onClick={(e) => { e.stopPropagation(); handleDelete(p.id)}} className="opacity-0 group-hover:opacity-100 text-text-secondary hover:text-red-500"><TrashIcon /></button>
                        </div>
                    ))}
                </div>
                <div className="p-4 border-t border-border space-y-2">
                    <button onClick={handleAddNew} className="btn-primary w-full py-2 text-sm flex items-center justify-center gap-2"><PlusIcon /> New</button>
                    <div className="flex gap-2">
                         <button onClick={() => fileInputRef.current?.click()} className="flex-1 py-2 text-sm bg-gray-100 dark:bg-slate-700 rounded-md flex items-center justify-center gap-2"><ArrowUpOnSquareIcon/> Import</button>
                         <button onClick={handleExport} className="flex-1 py-2 text-sm bg-gray-100 dark:bg-slate-700 rounded-md flex items-center justify-center gap-2"><ArrowDownTrayIcon/> Export</button>
                         <input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden"/>
                    </div>
                </div>
            </aside>
            {/* Main Content */}
            {activePersonality ? (
                 <div className="flex-1 grid grid-cols-2 gap-px bg-border">
                    {/* Editor */}
                    <div className="bg-background p-4 flex flex-col gap-4 overflow-y-auto">
                        <div><label className="font-bold">Name</label><input type="text" value={activePersonality.name} onChange={e => handleUpdate('name', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/></div>
                        <div><label className="font-bold">Persona</label><textarea value={activePersonality.persona} onChange={e => handleUpdate('persona', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded h-24"/></div>
                        <div><label className="font-bold">Rules (one per line)</label><textarea value={activePersonality.rules.join('\\\\n')} onChange={e => handleUpdate('rules', e.target.value.split('\\\\n'))} className="w-full mt-1 p-2 bg-surface border rounded h-32"/></div>
                        <div><label className="font-bold">Output Format</label><select value={activePersonality.outputFormat} onChange={e => handleUpdate('outputFormat', e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"><option>markdown</option><option>json</option><option>text</option></select></div>
                        <div>
                            <h3 className="font-bold mb-2">Examples</h3>
                            {activePersonality.exampleIO.map((ex, i) => (
                                <div key={i} className="grid grid-cols-2 gap-2 mb-2 p-2 border rounded bg-surface">
                                    <textarea placeholder="User Input" value={ex.input} onChange={e => handleUpdate('exampleIO', activePersonality.exampleIO.map((item, idx) => idx === i ? {...item, input: e.target.value} : item))} className="h-20 p-1 bg-background border rounded"/>
                                    <textarea placeholder="Model Output" value={ex.output} onChange={e => handleUpdate('exampleIO', activePersonality.exampleIO.map((item, idx) => idx === i ? {...item, output: e.target.value} : item))} className="h-20 p-1 bg-background border rounded"/>
                                </div>
                            ))}
                            <button onClick={() => handleUpdate('exampleIO', [...activePersonality.exampleIO, {input: '', output: ''}])} className="text-sm text-primary">+ Add Example</button>
                        </div>
                    </div>
                    {/* Testbed */}
                    <div className="bg-background p-4 flex flex-col">
                        <h2 className="text-lg font-bold mb-2 border-b pb-2">Live Testbed</h2>
                        <div className="flex-grow overflow-y-auto space-y-4 pr-2">
                           {chatHistory.map((msg, i) => (
                               <div key={i} className={\\\`p-3 rounded-lg \\\${msg.role === 'user' ? 'bg-primary/10' : 'bg-surface'}\\\`}>
                                    <strong className="capitalize">{msg.role}</strong>
                                    <MarkdownRenderer content={msg.content} />
                               </div>
                           ))}
                           {isStreaming && <div className="flex justify-center"><LoadingSpinner/></div>}
                        </div>
                        <div className="flex gap-2 mt-4">
                            <input value={testbedInput} onChange={e => setTestbedInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleTestbedSend()} className="flex-grow p-2 bg-surface border rounded" placeholder="Test your AI..."/>
                            <button onClick={handleTestbedSend} disabled={isStreaming} className="btn-primary px-4">Send</button>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="flex-1 flex items-center justify-center text-text-secondary">Select or create a personality to begin.</div>
            )}
        </div>
    );
};\`,
  'components/features/AiPullRequestAssistant.tsx': \`
import React, { useState, useMemo, useCallback } from 'react';
import * as Diff from 'diff';
import { generatePrSummaryStructured, generateTechnicalSpecFromDiff, downloadFile } from '../../services/index.ts';
import { createDocument, insertText } from '../../services/workspaceService.ts';
import type { StructuredPrSummary } from '../../types.ts';
import { AiPullRequestAssistantIcon, DocumentIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';

const exampleBefore = \\\`function Greeter(props) {
  return <h1>Hello, {props.name}!</h1>;
}\\\`;
const exampleAfter = \\\`function Greeter({ name, enthusiasmLevel = 1 }) {
  const punctuation = '!'.repeat(enthusiasmLevel);
  return <h1>Hello, {name}{punctuation}</h1>;
}\\\`;

export const AiPullRequestAssistant: React.FC = () => {
    const [beforeCode, setBeforeCode] = useState<string>(exampleBefore);
    const [afterCode, setAfterCode] = useState<string>(exampleAfter);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [isExporting, setIsExporting] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [summary, setSummary] = useState<StructuredPrSummary | null>(null);

    const { addNotification } = useNotification();
    const { state } = useGlobalState();
    const { user } = state;

    const diff = useMemo(() => Diff.createPatch('component.tsx', beforeCode, afterCode), [beforeCode, afterCode]);

    const handleGenerateSummary = useCallback(async () => {
        if (!beforeCode.trim() && !afterCode.trim()) {
            setError('Please provide code to generate a summary.');
            return;
        }
        setIsLoading(true);
        setError('');
        setSummary(null);
        
        try {
            const result: StructuredPrSummary = await generatePrSummaryStructured(diff);
            setSummary(result);
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate summary: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [diff, beforeCode, afterCode]);

    const handleExportToDocs = async () => {
        if (!summary || !user) {
            addNotification('Please generate a summary first and ensure you are signed in.', 'error');
            return;
        }
        setIsExporting(true);
        try {
            const specContent = await generateTechnicalSpecFromDiff(diff, summary);
            const doc = await createDocument(\\\`Tech Spec: \\\${summary.title}\\\`);
            await insertText(doc.documentId, specContent);
            addNotification('Successfully exported to Google Docs!', 'success');
            window.open(doc.webViewLink, '_blank');
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            addNotification(\\\`Failed to export: \\\${errorMessage}\\\`, 'error');
        } finally {
            setIsExporting(false);
        }
    };
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <AiPullRequestAssistantIcon />
                    <span className="ml-3">AI Pull Request Assistant</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate a PR summary from code changes and export a full tech spec.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                {/* Left side: Inputs and Generator */}
                <div className="flex flex-col gap-4 min-h-0">
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="before-code" className="text-sm font-medium text-text-secondary mb-2">Before</label>
                        <textarea id="before-code" value={beforeCode} onChange={e => setBeforeCode(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm" />
                    </div>
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="after-code" className="text-sm font-medium text-text-secondary mb-2">After</label>
                        <textarea id="after-code" value={afterCode} onChange={e => setAfterCode(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm" />
                    </div>
                    <button onClick={handleGenerateSummary} disabled={isLoading} className="btn-primary w-full flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Summary'}
                    </button>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                </div>

                {/* Right side: Summary and Export */}
                <div className="flex flex-col gap-4 min-h-0">
                    <div className="flex flex-col bg-surface border border-border p-4 rounded-lg flex-grow min-h-0">
                        <h3 className="text-lg font-bold mb-2">Generated Summary</h3>
                        <div className="flex-grow overflow-y-auto pr-2 space-y-2">
                            {summary ? (
                                <>
                                    <input type="text" readOnly value={summary.title} className="w-full font-bold p-2 bg-background rounded"/>
                                    <textarea readOnly value={summary.summary} className="w-full h-24 p-2 bg-background rounded resize-none"/>
                                    <div>
                                        <h4 className="font-semibold">Changes:</h4>
                                        <ul className="list-disc list-inside text-sm">
                                            {summary.changes.map((c, i) => <li key={i}>{c}</li>)}
                                        </ul>
                                    </div>
                                </>
                            ) : (
                                <div className="text-text-secondary h-full flex items-center justify-center">
                                    {isLoading ? <LoadingSpinner /> : 'PR summary will appear here.'}
                                </div>
                            )}
                        </div>
                         {summary && user && (
                            <div className="mt-4 pt-4 border-t border-border">
                                <button onClick={handleExportToDocs} disabled={isExporting} className="w-full btn-primary bg-blue-600 flex items-center justify-center gap-2 py-2">
                                    {isExporting ? <LoadingSpinner /> : <><DocumentIcon /> Export to Google Docs</>}
                                </button>
                            </div>
                         )}
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/AiStyleTransfer.tsx': \`import React, { useState, useCallback } from 'react';
import { transferCodeStyleStream } from '../../services/index.ts';
import { SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \\\`function my_func(x,y){return x+y;}\\\`;
const exampleStyleGuide = \\\`- Use camelCase for function names.
- Add a space after commas in argument lists.
- Use semicolons at the end of statements.\\\`;

export const AiStyleTransfer: React.FC = () => {
    const [inputCode, setInputCode] = useState<string>(exampleCode);
    const [styleGuide, setStyleGuide] = useState<string>(exampleStyleGuide);
    const [outputCode, setOutputCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        if (!inputCode.trim() || !styleGuide.trim()) {
            setError('Please provide both code and a style guide.');
            return;
        }
        setIsLoading(true);
        setError('');
        setOutputCode('');
        try {
            const stream = transferCodeStyleStream({ code: inputCode, styleGuide });
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setOutputCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to transfer style: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [inputCode, styleGuide]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <SparklesIcon />
                    <span className="ml-3">AI Code Style Transfer</span>
                </h1>
                <p className="text-text-secondary mt-1">Rewrite code to match a specific style guide using AI.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="input-code" className="text-sm font-medium text-text-secondary mb-2">Original Code</label>
                    <textarea
                        id="input-code"
                        value={inputCode}
                        onChange={(e) => setInputCode(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm"
                    />
                </div>
                 <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="style-guide" className="text-sm font-medium text-text-secondary mb-2">Style Guide</label>
                    <textarea
                        id="style-guide"
                        value={styleGuide}
                        onChange={(e) => setStyleGuide(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Rewrite Code'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Rewritten Code</label>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !outputCode && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {outputCode && <MarkdownRenderer content={outputCode} />}
                         {!isLoading && !outputCode && !error && <div className="text-text-secondary h-full flex items-center justify-center">Rewritten code will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AiUnitTestGenerator.tsx': \`import React, { useState, useCallback } from 'react';
import { generateUnitTestsStream, downloadFile } from '../../services/index.ts';
import { BeakerIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \\\`import React from 'react';

export const Greeting = ({ name }) => {
  if (!name) {
    return <div>Hello, Guest!</div>;
  }
  return <div>Hello, {name}!</div>;
};\\\`;

export const AiUnitTestGenerator: React.FC = () => {
    const [code, setCode] = useState<string>(exampleCode);
    const [tests, setTests] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleGenerate = useCallback(async () => {
        if (!code.trim()) {
            setError('Please enter some code to generate tests for.');
            return;
        }
        setIsLoading(true);
        setError('');
        setTests('');
        try {
            const stream = generateUnitTestsStream(code);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setTests(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate tests: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [code]);
    
    const cleanCodeForDownload = (markdown: string) => {
        return markdown.replace(/^\\\`\\\`\\\`(?:\\\\w+\\\\n)?/, '').replace(/\\\`\\\`\\\`\\\$/, '');
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BeakerIcon />
                    <span className="ml-3">AI Unit Test Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Provide a function or component and let AI write the tests.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Source Code</label>
                    <textarea
                        id="code-input"
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        placeholder="Paste your source code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Generate Unit Tests'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Tests</label>
                        {tests && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={() => navigator.clipboard.writeText(cleanCodeForDownload(tests))} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy Code</button>
                                <button onClick={() => downloadFile(cleanCodeForDownload(tests), 'tests.tsx', 'text/typescript')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !tests && (
                            <div className="flex items-center justify-center h-full">
                                <LoadingSpinner />
                            </div>
                        )}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {tests && <MarkdownRenderer content={tests} />}
                        {!isLoading && !tests && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">
                                The generated tests will appear here.
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/ApiMockGenerator.tsx': \`import React, { useState, useEffect, useCallback } from 'react';
import { generateMockData } from '../../services/aiService.ts';
import { startMockServer, stopMockServer, setMockRoutes, isMockServerRunning } from '../../services/mocking/mockServer.ts';
import { saveMockCollection, getAllMockCollections } from '../../services/mocking/db.ts';
import { ServerStackIcon, SparklesIcon, PlusIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

interface MockCollection {
    id: string;
    schemaDescription: string;
    data: any[];
}

interface MockRoute {
    id: number;
    path: string;
    method: 'GET' | 'POST';
    collectionId: string;
}

const exampleSchema = "a user with an id, name, email, and a nested address object containing a city and country";

export const ApiMockGenerator: React.FC = () => {
    const [schema, setSchema] = useState(exampleSchema);
    const [count, setCount] = useState(5);
    const [collectionName, setCollectionName] = useState('users');
    const [collections, setCollections] = useState<MockCollection[]>([]);
    const [generatedData, setGeneratedData] = useState<any[] | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isServerLoading, setIsServerLoading] = useState(false);
    const [error, setError] = useState('');
    const [isServerRunning, setIsServerRunning] = useState(isMockServerRunning());
    const [routes, setRoutes] = useState<MockRoute[]>([{ id: 1, path: '/api/users', method: 'GET', collectionId: 'users' }]);

    useEffect(() => {
        const loadCollections = async () => {
            const storedCollections = await getAllMockCollections();
            setCollections(storedCollections);
        };
        loadCollections();
    }, []);

    const handleGenerate = async () => {
        if (!schema.trim() || !collectionName.trim()) {
            setError('Schema description and collection name are required.');
            return;
        }
        setIsLoading(true);
        setError('');
        try {
            const data = await generateMockData(schema, count);
            setGeneratedData(data);
            const collectionId = collectionName.toLowerCase().replace(/\\\\s/g, '-');
            await saveMockCollection({ id: collectionId, schemaDescription: schema, data });
            setCollections(await getAllMockCollections());
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate data.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleServerToggle = async () => {
        setIsServerLoading(true);
        if (isServerRunning) {
            await stopMockServer();
            setIsServerRunning(false);
        } else {
            try {
                await startMockServer();
                setIsServerRunning(true);
                updateRoutesOnServer();
            } catch (err) {
                setError(err instanceof Error ? err.message : 'Could not start server.');
            }
        }
        setIsServerLoading(false);
    };

    const updateRoutesOnServer = useCallback(() => {
        const mockRoutes = routes.map(route => {
            const collection = collections.find(c => c.id === route.collectionId);
            return {
                path: route.path,
                method: route.method,
                response: {
                    status: 200,
                    body: collection ? collection.data : { message: \\\`No data found for collection '\\\${route.collectionId}'.\\\` }
                }
            };
        });
        setMockRoutes(mockRoutes as any);
    }, [routes, collections]);


    useEffect(() => {
        if (isServerRunning) {
            updateRoutesOnServer();
        }
    }, [routes, collections, isServerRunning, updateRoutesOnServer]);

    const handleRouteUpdate = (id: number, field: keyof MockRoute, value: string) => {
        setRoutes(routes.map(r => r.id === id ? { ...r, [field]: value } : r));
    };

    const handleAddRoute = () => {
        const newRoute: MockRoute = {
            id: Date.now(),
            path: '/api/new-route',
            method: 'GET',
            collectionId: collections.length > 0 ? collections[0].id : ''
        };
        setRoutes([...routes, newRoute]);
    };
    
    const getServerStatusText = () => {
        if (isServerLoading) return 'Starting...';
        return isServerRunning ? 'Server Running' : 'Server Stopped';
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-start">
                <div>
                    <h1 className="text-3xl font-bold flex items-center"><ServerStackIcon /><span className="ml-3">AI API Mock Server</span></h1>
                    <p className="text-text-secondary mt-1">Generate and serve mock API data locally using a service worker.</p>
                </div>
                <button onClick={handleServerToggle} disabled={isServerLoading} className={\\\`px-4 py-2 rounded-md font-semibold flex items-center gap-2 \\\${isServerRunning ? 'bg-green-100 text-green-700' : 'bg-gray-100'}\\\`}>
                    <span className={\\\`w-3 h-3 rounded-full \\\${isServerRunning ? 'bg-green-500' : 'bg-gray-400'} \\\${isServerLoading ? 'animate-pulse' : ''}\\\`}></span>
                    {getServerStatusText()}
                </button>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface p-4 border border-border rounded-lg">
                    <h3 className="text-lg font-bold">1. Generate Data</h3>
                    <div><label className="text-sm">Describe the data schema</label><textarea value={schema} onChange={e => setSchema(e.target.value)} className="w-full mt-1 p-2 bg-background border border-border rounded" rows={4}/></div>
                    <div className="flex gap-2">
                        <div className="flex-grow"><label className="text-sm">Collection Name</label><input type="text" value={collectionName} onChange={e => setCollectionName(e.target.value)} className="w-full mt-1 p-2 bg-background border border-border rounded"/></div>
                        <div><label className="text-sm">Count</label><input type="number" value={count} onChange={e => setCount(Number(e.target.value))} className="w-20 mt-1 p-2 bg-background border border-border rounded"/></div>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary py-2 flex items-center justify-center gap-2">{isLoading ? <LoadingSpinner/> : <><SparklesIcon/> Generate & Save</>}</button>
                    {error && <p className="text-red-500 text-xs">{error}</p>}
                </div>

                <div className="lg:col-span-2 flex flex-col gap-4 min-h-0">
                   <div className="bg-surface p-4 border border-border rounded-lg flex-grow flex flex-col min-h-0">
                        <h3 className="text-lg font-bold mb-2">2. View Data & Configure Routes</h3>
                        <div className="flex-grow grid grid-cols-2 gap-4 min-h-0">
                            <div className="overflow-y-auto">
                                <h4 className="font-semibold text-sm mb-1">Saved Collections</h4>
                                {collections.map(c => <div key={c.id} className="text-xs p-2 bg-background rounded border border-border mb-1">{c.id} ({c.data.length} items)</div>)}
                                <h4 className="font-semibold text-sm mb-1 mt-2">Last Generated Data</h4>
                                <pre className="text-xs p-2 bg-background rounded border border-border whitespace-pre-wrap">{generatedData ? JSON.stringify(generatedData, null, 2) : 'No data generated yet.'}</pre>
                            </div>
                            <div className="overflow-y-auto">
                                <h4 className="font-semibold text-sm mb-1">Mock Routes</h4>
                                {routes.map((r) => (
                                <div key={r.id} className="grid grid-cols-3 gap-1 items-center mb-1">
                                    <input type="text" value={r.path} onChange={e => handleRouteUpdate(r.id, 'path', e.target.value)} className="col-span-2 p-1 text-xs bg-background border rounded" />
                                    <select value={r.collectionId} onChange={e => handleRouteUpdate(r.id, 'collectionId', e.target.value)} className="p-1 text-xs bg-background border rounded">
                                        <option value="">Select Collection</option>
                                        {collections.map(c => <option key={c.id} value={c.id}>{c.id}</option>)}
                                    </select>
                                </div>
                                ))}
                                <button onClick={handleAddRoute} className="text-xs mt-2 p-1 bg-gray-100 rounded hover:bg-gray-200"><PlusIcon/></button>
                            </div>
                        </div>
                   </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AsyncCallTreeViewer.tsx': \`

import React, { useState, useMemo } from 'react';
import { ChartBarIcon } from '../icons.tsx';

interface CallNode {
    name: string;
    duration: number;
    children?: CallNode[];
}

const exampleJson = \\\`{
    "name": "startApp",
    "duration": 500,
    "children": [
        {
            "name": "fetchUserData",
            "duration": 300,
            "children": [
                { "name": "authenticate", "duration": 100 },
                { "name": "fetchProfile", "duration": 150 }
            ]
        },
        {
            "name": "loadInitialAssets",
            "duration": 450,
            "children": [
                { "name": "loadImage.png", "duration": 200 },
                { "name": "loadScript.js", "duration": 250 }
            ]
        }
    ]
}\\\`;


const TreeNode: React.FC<{ node: CallNode, level: number, maxDuration: number }> = ({ node, level, maxDuration }) => {
    const [isOpen, setIsOpen] = React.useState(true);
    const hasChildren = node.children && node.children.length > 0;

    return (
        <div className="my-1">
            <div
                className="flex items-center p-2 rounded-md hover:bg-gray-100"
                style={{ paddingLeft: \\\`\\\${level * 20 + 8}px\\\` }}
            >
                {hasChildren && (
                    <button onClick={() => setIsOpen(!isOpen)} className={\\\`mr-2 text-text-secondary w-4 h-4 flex-shrink-0 transform transition-transform \\\${isOpen ? 'rotate-90' : ''}\\\`}>
                       ▶
                    </button>
                )}
                 {!hasChildren && <div className="w-6 mr-2 flex-shrink-0" />}
                 <div className="flex-grow flex items-center justify-between gap-4">
                    <span className="truncate">{node.name}</span>
                    <div className="flex items-center gap-2 flex-shrink-0">
                         <div className="w-24 h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div className="h-4 bg-primary" style={{ width: \\\`\\\${(node.duration / maxDuration) * 100}%\\\` }}/>
                         </div>
                        <span className="text-primary w-16 text-right">{node.duration.toFixed(0)}ms</span>
                    </div>
                </div>
            </div>
            {isOpen && hasChildren && (
                <div>
                    {node.children!.map((child, index) => (
                        <TreeNode key={index} node={child} level={level + 1} maxDuration={maxDuration} />
                    ))}
                </div>
            )}
        </div>
    );
};


export const AsyncCallTreeViewer: React.FC = () => {
    const [jsonInput, setJsonInput] = useState(exampleJson);
    const [error, setError] = useState('');

    const { treeData, maxDuration } = useMemo(() => {
        try {
            const data: CallNode = JSON.parse(jsonInput);
             let max = 0;
            const findMax = (node: CallNode) => {
                if (node.duration > max) max = node.duration;
                if (node.children) node.children.forEach(findMax);
            };
            findMax(data);
            setError('');
            return { treeData: data, maxDuration: max };
        } catch (e) {
            setError('Invalid JSON format.');
            return { treeData: null, maxDuration: 0 };
        }
    }, [jsonInput]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <ChartBarIcon />
                    <span className="ml-3">Async Call Tree Viewer</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste a JSON structure to visualize an asynchronous function call tree.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col h-2/5 min-h-[200px]">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={e => setJsonInput(e.target.value)}
                        className={\\\`flex-grow p-4 bg-surface border \\\${error ? 'border-red-500' : 'border-border'} rounded-md resize-y font-mono text-sm\\\`}
                        spellCheck="false"
                    />
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                </div>
                <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Visual Tree</label>
                    <div className="flex-grow bg-surface p-4 rounded-lg text-sm overflow-y-auto border border-border">
                        {treeData ? <TreeNode node={treeData} level={0} maxDuration={maxDuration} /> : <div className="text-text-secondary">{error || 'Enter valid JSON to see the tree.'}</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/AudioToCode.tsx': \`import React, { useState, useRef, useCallback } from 'react';
import { transcribeAudioToCodeStream, blobToBase64 } from '../../services/index.ts';
import { MicrophoneIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

export const AudioToCode: React.FC = () => {
    const [isRecording, setIsRecording] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [code, setCode] = useState('');
    const [error, setError] = useState('');
    const mediaRecorderRef = useRef<MediaRecorder | null>(null);
    const audioChunksRef = useRef<Blob[]>([]);

    const handleStartRecording = async () => {
        setError('');
        setCode('');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setError('Audio recording is not supported by your browser.');
            return;
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorderRef.current = new MediaRecorder(stream);
            mediaRecorderRef.current.ondataavailable = event => {
                audioChunksRef.current.push(event.data);
            };
            mediaRecorderRef.current.onstop = handleTranscribe;
            mediaRecorderRef.current.start();
            setIsRecording(true);
        } catch (err) {
            setError('Microphone access was denied. Please enable it in your browser settings.');
        }
    };

    const handleStopRecording = () => {
        if (mediaRecorderRef.current && isRecording) {
            mediaRecorderRef.current.stop();
            mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
            setIsRecording(false);
            setIsLoading(true);
        }
    };

    const handleTranscribe = useCallback(async () => {
        if (audioChunksRef.current.length === 0) {
            setIsLoading(false);
            return;
        }
        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
        audioChunksRef.current = [];
        try {
            const base64Audio = await blobToBase64(audioBlob);
            const stream = transcribeAudioToCodeStream(base64Audio, 'audio/webm');
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to transcribe audio: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-3xl font-bold flex items-center justify-center">
                    <MicrophoneIcon />
                    <span className="ml-3">AI Audio-to-Code</span>
                </h1>
                <p className="text-text-secondary mt-1">Speak your programming ideas and watch them turn into code.</p>
            </header>
            <div className="flex-grow flex flex-col items-center gap-6 min-h-0">
                <div className="flex flex-col items-center justify-center bg-surface p-6 rounded-lg w-full max-w-lg border border-border">
                     <button
                        onClick={isRecording ? handleStopRecording : handleStartRecording}
                        className={\\\`w-24 h-24 rounded-full flex items-center justify-center text-white font-bold text-lg transition-all \\\${isRecording ? 'bg-red-500 animate-pulse' : 'bg-primary'}\\\`}
                        disabled={isLoading}
                    >
                        {isLoading ? <LoadingSpinner/> : isRecording ? 'Stop' : 'Record'}
                    </button>
                    <p className="mt-4 text-text-secondary">
                        {isLoading ? 'Transcribing...' : isRecording ? 'Recording in progress...' : 'Click to start recording'}
                    </p>
                </div>
                 <div className="flex flex-col h-full w-full max-w-3xl">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Code</label>
                    <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto min-h-[200px]">
                        {isLoading && !code && (
                            <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>
                        )}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {code && <MarkdownRenderer content={code} />}
                        {!isLoading && !code && !error && (
                            <div className="text-text-secondary h-full flex items-center justify-center">Code will appear here.</div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/BugReproducer.tsx': \`import React, { useState, useCallback } from 'react';
import { generateBugReproductionTestStream } from '../../services/aiService.ts';
import { BugAntIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleStackTrace = \\\`TypeError: Cannot read properties of undefined (reading 'name')
    at UserProfile (UserProfile.jsx:5:21)
    at renderWithHooks (react-dom.development.js:14985:18)
    at mountIndeterminateComponent (react-dom.development.js:17811:13)
    at beginWork (react-dom.development.js:19049:16)\\\`;

export const BugReproducer: React.FC = () => {
    const [stackTrace, setStackTrace] = useState(exampleStackTrace);
    const [context, setContext] = useState('// The UserProfile component code:\\\\nconst UserProfile = ({ user }) => <div>{user.name}</div>;');
    const [generatedTest, setGeneratedTest] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!stackTrace.trim()) {
            setError('Please provide a stack trace.');
            return;
        }
        setIsLoading(true);
        setError('');
        setGeneratedTest('');
        try {
            const stream = generateBugReproductionTestStream(stackTrace, context);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setGeneratedTest(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [stackTrace, context]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BugAntIcon />
                    <span className="ml-3">Automated Bug Reproducer</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste a stack trace to automatically generate a failing unit test.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col gap-4">
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="stack-trace" className="text-sm font-medium mb-2">Stack Trace</label>
                        <textarea id="stack-trace" value={stackTrace} onChange={e => setStackTrace(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    </div>
                     <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="context" className="text-sm font-medium mb-2">Relevant Code / Context (Optional)</label>
                        <textarea id="context" value={context} onChange={e => setContext(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-3">{isLoading ? <LoadingSpinner/> : 'Generate Test'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Generated Test File</label>
                    <div className="flex-grow p-1 bg-background border rounded overflow-auto">
                        {isLoading && !generatedTest && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {generatedTest && <MarkdownRenderer content={generatedTest} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/ChangelogGenerator.tsx': \`import React, { useState, useCallback } from 'react';
import { generateChangelogFromLogStream } from '../../services/aiService.ts';
import { GitBranchIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleLog = \\\`commit 3a4b5c...
Author: Dev One <dev.one@example.com>
Date:   Mon Jul 15 11:30:00 2024 -0400

    feat: add user login page

commit 1a2b3c...
Author: Dev Two <dev.two@example.com>
Date:   Mon Jul 15 10:00:00 2024 -0400

    fix: correct typo in header
\\\`;

export const ChangelogGenerator: React.FC = () => {
    const [log, setLog] = useState(exampleLog);
    const [changelog, setChangelog] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!log.trim()) {
            setError('Please paste your git log output.');
            return;
        }
        setIsLoading(true);
        setError('');
        setChangelog('');
        try {
            const stream = generateChangelogFromLogStream(log);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setChangelog(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [log]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">AI Changelog Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate a markdown changelog from your raw git log.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="commit-input" className="text-sm font-medium text-text-secondary mb-2">Raw Git Log</label>
                    <textarea
                        id="commit-input"
                        value={log}
                        onChange={(e) => setLog(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                <div className="flex-shrink-0">
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Changelog'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Changelog.md</label>
                    <div className="relative flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !changelog && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {changelog && <MarkdownRenderer content={changelog} />}
                        {!isLoading && changelog && <button onClick={() => navigator.clipboard.writeText(changelog)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy</button>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/CiCdPipelineGenerator.tsx': \`import React, { useState } from 'react';
import { generateCiCdConfig } from '../../services/index.ts';
import { PaperAirplaneIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const platforms = ['GitHub Actions', 'GitLab CI', 'CircleCI', 'Jenkins'];
const exampleDescription = "Install Node.js dependencies, run linting and tests, build the production app, and then deploy to Vercel.";

export const CiCdPipelineGenerator: React.FC = () => {
    const [platform, setPlatform] = useState(platforms[0]);
    const [description, setDescription] = useState(exampleDescription);
    const [config, setConfig] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = async () => {
        if (!description.trim()) {
            setError('Please provide a description of the pipeline stages.');
            return;
        }
        setIsLoading(true);
        setError('');
        try {
            const result = await generateCiCdConfig(platform, description);
            setConfig(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate config.');
        } finally {
            setIsLoading(false);
        }
    };
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><PaperAirplaneIcon /><span className="ml-3">AI CI/CD Pipeline Architect</span></h1>
                <p className="text-text-secondary mt-1">Describe your deployment process and get a modern configuration file.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                 <div className="flex flex-col flex-1 min-h-0">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div><label className="block text-sm">Platform</label><select value={platform} onChange={e => setPlatform(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"><option>GitHub Actions</option><option>GitLab CI</option><option>CircleCI</option></select></div>
                        <div className="md:col-span-2"><label className="block text-sm">Describe Stages</label><input type="text" value={description} onChange={e => setDescription(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/></div>
                    </div>
                     <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center py-2"><SparklesIcon /> {isLoading ? 'Generating...' : 'Generate Configuration'}</button>
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Configuration File</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !config && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {config && <MarkdownRenderer content={config} />}
                         {!isLoading && !config && !error && <div className="text-text-secondary h-full flex items-center justify-center">Generated config will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/CodeDiffGhost.tsx': \`import React, { useState, useEffect, useRef } from 'react';
import { EyeIcon } from '../icons.tsx';

const initialOldCode = \\\`function UserProfile({ user }) {
  return (
    <div className="profile">
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  );
}\\\`;

const initialNewCode = \\\`function UserProfile({ user }) {
  const { name, email, avatar } = user;
  return (
    <div className="profile-card">
      <img src={avatar} alt={name} />
      <h2>{name}</h2>
      <a href={\\\\\\\`mailto:\\\\\\\${email}\\\\\\\`}>{email}</a>
    </div>
  );
}\\\`;

export const CodeDiffGhost: React.FC = () => {
    const [oldCode, setOldCode] = useState(initialOldCode);
    const [newCode, setNewCode] = useState(initialNewCode);
    const [typedCode, setTypedCode] = useState('');
    const [isRunning, setIsRunning] = useState(false);
    const intervalRef = useRef<number | null>(null);

    const startAnimation = () => {
        if (intervalRef.current) clearInterval(intervalRef.current);
        setIsRunning(true);
        setTypedCode('');
        
        intervalRef.current = window.setInterval(() => {
            setTypedCode(prev => {
                if (prev.length < newCode.length) {
                    return newCode.substring(0, prev.length + 1);
                }
                if (intervalRef.current) clearInterval(intervalRef.current);
                setIsRunning(false);
                return newCode;
            });
        }, 15);
    };

    useEffect(() => {
        return () => {
            if (intervalRef.current) clearInterval(intervalRef.current);
        };
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <EyeIcon />
                    <span className="ml-3">Code Diff Ghost</span>
                </h1>
                <p className="text-text-secondary mt-1">Visualize code changes with a "ghost typing" effect.</p>
            </header>
            <div className="flex justify-center mb-4">
                <button
                    onClick={startAnimation}
                    disabled={isRunning}
                    className="btn-primary px-6 py-2"
                >
                    {isRunning ? 'Visualizing...' : 'Show Changes'}
                </button>
            </div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden font-mono text-sm">
                <div className="flex flex-col h-full">
                    <label htmlFor="before-code" className="text-sm font-medium text-text-secondary mb-2">Before</label>
                    <textarea
                        id="before-code"
                        value={oldCode}
                        onChange={e => setOldCode(e.target.value)}
                        className="flex-grow p-4 bg-surface border border-border rounded-md text-red-600 whitespace-pre-wrap resize-none"
                        spellCheck="false"
                    />
                </div>
                 <div className="flex flex-col h-full">
                    <label htmlFor="after-code" className="text-sm font-medium text-text-secondary mb-2">After</label>
                     <div className="relative flex-grow">
                        <textarea
                            id="after-code"
                            value={newCode}
                            onChange={e => setNewCode(e.target.value)}
                            className="absolute inset-0 w-full h-full p-4 bg-surface border border-border rounded-md text-emerald-700 whitespace-pre-wrap resize-none z-0"
                            spellCheck="false"
                        />
                        {(isRunning || typedCode) && (
                            <pre className="absolute inset-0 w-full h-full p-4 bg-surface pointer-events-none text-emerald-700 whitespace-pre-wrap z-10">
                                {typedCode}{isRunning && <span className="animate-pulse">|</span>}
                            </pre>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/CodeFormatter.tsx': \`import React, { useState, useCallback } from 'react';
import { formatCodeStream } from '../../services/index.ts';
import { CodeBracketSquareIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \\\`const MyComponent = (props) => {
  const {name, items}=props
    if(!items || items.length === 0){
  return <p>No items found for {name}</p>;
    }
  return <ul>{items.map(item=> <li key={item.id}>{item.name}</li>)}</ul>
}\\\`;

export const CodeFormatter: React.FC = () => {
    const [inputCode, setInputCode] = useState<string>(exampleCode);
    const [formattedCode, setFormattedCode] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleFormat = useCallback(async () => {
        if (!inputCode.trim()) {
            setError('Please enter some code to format.');
            return;
        }
        setIsLoading(true);
        setError('');
        setFormattedCode('');
        try {
            const stream = formatCodeStream(inputCode);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setFormattedCode(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to format code: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [inputCode]);
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CodeBracketSquareIcon />
                    <span className="ml-3">AI Code Formatter</span>
                </h1>
                <p className="text-text-secondary mt-1">Clean up your code with AI-powered formatting, like a smart Prettier.</p>
            </header>
            <div className="flex-grow flex flex-col min-h-0">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-grow min-h-0">
                    <div className="flex flex-col h-full">
                        <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Input</label>
                        <textarea
                            id="code-input"
                            value={inputCode}
                            onChange={(e) => setInputCode(e.target.value)}
                            placeholder="Paste your unformatted code here..."
                            className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                        />
                    </div>
                    <div className="flex flex-col h-full">
                        <label className="text-sm font-medium text-text-secondary mb-2">Output</label>
                        <div className="flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                           {isLoading && !formattedCode && (
                                <div className="flex items-center justify-center h-full">
                                    <LoadingSpinner />
                                </div>
                            )}
                            {error && <p className="p-4 text-red-500">{error}</p>}
                            {formattedCode && <MarkdownRenderer content={formattedCode} />}
                            {!isLoading && !formattedCode && !error && (
                                <div className="text-text-secondary h-full flex items-center justify-center">
                                    Formatted code will appear here.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                 <button
                    onClick={handleFormat}
                    disabled={isLoading}
                    className="btn-primary mt-4 w-full max-w-sm mx-auto flex items-center justify-center px-6 py-3"
                >
                    {isLoading ? <LoadingSpinner /> : 'Format Code'}
                </button>
            </div>
        </div>
    );
};\`,
  'components/features/CodeReviewBot.tsx': \`import React, { useState, useCallback } from 'react';
import { reviewCodeStream } from '../../services/index.ts';
import { useAiPersonalities } from '../../hooks/useAiPersonalities.ts';
import { formatSystemPromptToString } from '../../utils/promptUtils.ts';
import { CpuChipIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \\\`function UserList(users) {
  if (users.length = 0) {
    return "no users";
  } else {
    return (
      users.map(u => {
        return <li>{u.name}</li>
      })
    )
  }
}\\\`;

export const CodeReviewBot: React.FC = () => {
    const [code, setCode] = useState<string>(exampleCode);
    const [review, setReview] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [personalities] = useAiPersonalities();
    const [selectedPersonalityId, setSelectedPersonalityId] = useState<string>('default');

    const handleGenerate = useCallback(async () => {
        if (!code.trim()) {
            setError('Please enter some code to review.');
            return;
        }
        setIsLoading(true);
        setError('');
        setReview('');

        let systemInstruction: string | undefined = undefined;
        if (selectedPersonalityId !== 'default') {
            const personality = personalities.find(p => p.id === selectedPersonalityId);
            if (personality) {
                systemInstruction = formatSystemPromptToString(personality);
            }
        }

        try {
            const stream = reviewCodeStream(code, systemInstruction);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setReview(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to get review: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [code, selectedPersonalityId, personalities]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CpuChipIcon />
                    <span className="ml-3">AI Code Review Bot</span>
                </h1>
                <p className="text-text-secondary mt-1">Get an automated code review from Gemini.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">Code to Review</label>
                    <textarea
                        id="code-input"
                        value={code}
                        onChange={(e) => setCode(e.target.value)}
                        placeholder="Paste your code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0 flex items-center justify-center gap-4">
                     <div className="w-full max-w-xs">
                        <label htmlFor="personality-select" className="text-sm font-medium text-text-secondary">Reviewer Personality</label>
                        <select
                            id="personality-select"
                            value={selectedPersonalityId}
                            onChange={e => setSelectedPersonalityId(e.target.value)}
                            className="w-full mt-1 p-2 bg-surface border border-border rounded-md text-sm"
                        >
                            <option value="default">Default</option>
                            {personalities.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                     </div>
                    <button
                        onClick={handleGenerate}
                        disabled={isLoading}
                        className="btn-primary self-end h-[42px] w-full max-w-xs flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Request Review'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">AI Feedback</label>
                    <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !review && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {review && <MarkdownRenderer content={review} />}
                         {!isLoading && !review && !error && <div className="text-text-secondary h-full flex items-center justify-center">Review will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/CodeSpellChecker.tsx': \`import React, { useState, useMemo } from 'react';
import { BeakerIcon } from '../icons.tsx';

const commonTypos = [
    'funtion', 'functoin', 'funciton', 'contructor', 'cosntructor',
    'consle', 'conosle', 'cosnole', 'varable', 'varaible', 'vairable',
    'docment', 'docuemnt', 'docmunet', 'componnet', 'componenet', 'compnent',
    'retunr', 'retrun', 'asnyc', 'asycn', 'awai', 'awiat', 'promse',
    'resolv', 'rejct', 'catach', 'thne', 'lenght', 'lengt', 'prperty',
    'undefinded', 'nul', 'booleon', 'numbar', 'srtring', 'arrya', 'objcet',
    'elemnt', 'attriubte', 'eveent', 'listner', 'handeler', 'clieck',
    'submitt', 'resposne', 'requset', 'stauts', 'eror', 'sucess',
    'implemnt', 'overide', 'extned', 'pbulic', 'prvate', 'procted',
    'statci', 'abstact', 'interace', 'enmu', 'moduel', 'packge',
    'importt', 'exprot', 'defualt', 'namspace', 'tyep', 'clsas',
    'whiel', 'swich', 'cse', 'brek', 'contiune', 'thrwo', 'finnaly'
];

const typoRegex = new RegExp(\\\`\\\\\\\\b(\\\${commonTypos.join('|')})\\\\\\\\b\\\`, 'gi');

const HighlightedText: React.FC<{ text: string }> = React.memo(({ text }) => {
    const parts = useMemo(() => {
        return text.split(typoRegex).map((part, i) => {
            if (typoRegex.test(part)) {
                return <span key={i} className="underline decoration-red-500 decoration-wavy" title={\\\`Possible typo\\\`}>{part}</span>;
            }
            return part;
        });
    }, [text]);

    return <>{parts}</>;
});

export const CodeSpellChecker: React.FC = () => {
    const [code, setCode] = useState('funtion myFunction() {\\\\n  consle.log("Hello World");\\\\n  const myVarable = docment.getElementById("root");\\\\n  // This is a React componnet\\\\n}');

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center">
                    <BeakerIcon />
                    <span className="ml-3">Code Spell Checker</span>
                </h1>
                <p className="text-text-secondary mt-1">A simple tool that finds and highlights common typos in code.</p>
            </header>
            <div className="relative flex-grow font-mono text-sm bg-surface border border-border rounded-lg p-4 overflow-auto">
                <textarea
                    value={code}
                    onChange={(e) => setCode(e.target.value)}
                    className="absolute inset-0 w-full h-full p-4 bg-transparent text-transparent caret-primary resize-none z-10"
                    spellCheck="false"
                />
                <pre className="absolute inset-0 w-full h-full p-4 pointer-events-none whitespace-pre-wrap" aria-hidden="true">
                    <HighlightedText text={code} />
                </pre>
            </div>
             <p className="text-xs text-text-secondary mt-2 text-center">This checker uses a predefined list of common typos and does not use AI.</p>
        </div>
    );
};\`,
  'components/features/ColorPaletteGenerator.tsx': \`import React, { useState, useCallback } from 'react';
import { HexColorPicker } from 'react-colorful';
import { generateColorPalette, downloadFile } from '../../services/index.ts';
import { SparklesIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

interface PreviewColors {
    cardBg: string;
    pillBg: string;
    pillText: string;
    buttonBg: string;
}

const PreviewCard: React.FC<{ palette: string[], colors: PreviewColors, setColors: React.Dispatch<React.SetStateAction<PreviewColors>> }> = ({ palette, colors, setColors }) => {
    
    const ColorSelector: React.FC<{ label: string, value: string, onChange: (val: string) => void }> = ({ label, value, onChange }) => (
        <div className="flex items-center justify-between text-sm">
            <label className="text-text-primary">{label}</label>
            <div className="flex items-center gap-2">
                {palette.map(color => (
                     <button 
                        key={color}
                        onClick={() => onChange(color)}
                        className={\\\`w-5 h-5 rounded-full border border-gray-300 \\\${value === color ? 'ring-2 ring-primary ring-offset-1' : ''}\\\`}
                        style={{ backgroundColor: color }}
                        title={color}
                     />
                ))}
            </div>
        </div>
    );
    
    return (
        <div className="bg-surface p-4 rounded-lg border border-border w-full max-w-sm">
            <h3 className="text-lg font-bold mb-4 text-text-primary">Live Preview</h3>
            <div className="p-8 rounded-xl mb-4" style={{ backgroundColor: colors.cardBg }}>
                <div className="px-4 py-1 rounded-full text-center text-sm inline-block" style={{ backgroundColor: colors.pillBg, color: colors.pillText }}>
                    New Feature
                </div>
                <div className="mt-8 text-center">
                     <button className="px-6 py-2 rounded-lg font-bold" style={{ backgroundColor: colors.buttonBg, color: colors.cardBg }}>
                        Get Started
                    </button>
                </div>
            </div>
            <div className="space-y-3">
                <ColorSelector label="Card Background" value={colors.cardBg} onChange={val => setColors(c => ({...c, cardBg: val}))} />
                <ColorSelector label="Pill Background" value={colors.pillBg} onChange={val => setColors(c => ({...c, pillBg: val}))} />
                <ColorSelector label="Pill Text" value={colors.pillText} onChange={val => setColors(c => ({...c, pillText: val}))} />
                <ColorSelector label="Button Background" value={colors.buttonBg} onChange={val => setColors(c => ({...c, buttonBg: val}))} />
            </div>
        </div>
    );
};

export const ColorPaletteGenerator: React.FC = () => {
    const [baseColor, setBaseColor] = useState("#0047AB");
    const [palette, setPalette] = useState<string[]>(['#F0F2F5', '#CCD3E8', '#99AADD', '#6688D1', '#3366CC', '#0047AB']);
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');
    const [previewColors, setPreviewColors] = useState<PreviewColors>({
        cardBg: '#F0F2F5', pillBg: '#CCD3E8', pillText: '#0047AB', buttonBg: '#0047AB'
    });
    
    const handleGenerate = useCallback(async () => {
        setIsLoading(true);
        setError('');
        try {
            const result = await generateColorPalette(baseColor);
            setPalette(result.colors);
            setPreviewColors({
                cardBg: result.colors[0],
                pillBg: result.colors[2],
                pillText: result.colors[5],
                buttonBg: result.colors[5],
            })
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to generate palette: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, [baseColor]);
    
    const downloadColors = () => {
        const cssContent = \\\`:root {\\\\n\\\${palette.map((c, i) => \\\`  --color-palette-\\\${i+1}: \\\${c};\\\`).join('\\\\n')}\\\\n}\\\`;
        downloadFile(cssContent, 'palette.css', 'text/css');
    };
    
    const downloadCard = () => {
        const htmlContent = \\\`
<div class="card">
  <div class="pill">New Feature</div>
  <button class="button">Get Started</button>
</div>
        \\\`;
        const cssContent = \\\`
.card {
  background-color: \\\${previewColors.cardBg};
  padding: 2rem;
  border-radius: 1rem;
  text-align: center;
}
.pill {
  background-color: \\\${previewColors.pillBg};
  color: \\\${previewColors.pillText};
  display: inline-block;
  padding: 0.25rem 1rem;
  border-radius: 9999px;
  text-align: center;
  font-size: 0.875rem;
}
.button {
  margin-top: 2rem;
  background-color: \\\${previewColors.buttonBg};
  color: \\\${previewColors.cardBg};
  padding: 0.5rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: bold;
  border: none;
  cursor: pointer;
}
        \\\`;
        const combined = \\\`<!-- HTML -->\\\\n\\\${htmlContent}\\\\n\\\\n<!-- CSS -->\\\\n<style>\\\\n\\\${cssContent}\\\\n</style>\\\`;
        downloadFile(combined, 'preview-card.html', 'text/html');
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 text-center">
                <h1 className="text-3xl font-bold flex items-center justify-center">
                    <SparklesIcon />
                    <span className="ml-3">AI Color Palette Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Pick a base color, let Gemini design a palette, and preview it on a UI card.</p>
            </header>
            <div className="flex-grow flex flex-col lg:flex-row items-center justify-center gap-8">
                <div className="flex flex-col items-center gap-4">
                     <HexColorPicker color={baseColor} onChange={setBaseColor} className="!w-64 !h-64"/>
                     <div className="p-2 bg-surface rounded-md font-mono text-lg border border-border" style={{color: baseColor}}>{baseColor}</div>
                      <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full flex items-center justify-center px-6 py-3">
                        {isLoading ? <LoadingSpinner /> : 'Generate Palette'}
                    </button>
                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                </div>
                <div className="flex flex-col gap-2 w-full max-w-sm">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Palette:</label>
                    {isLoading ? (
                         <div className="flex items-center justify-center h-48"><LoadingSpinner /></div>
                    ) : (
                        palette.map((color) => (
                            <div key={color} className="group flex items-center justify-between p-4 rounded-md shadow-sm border border-border" style={{ backgroundColor: color }}>
                                <span className="font-mono font-bold text-black/70 mix-blend-overlay">{color}</span>
                                <button onClick={() => navigator.clipboard.writeText(color)} className="opacity-0 group-hover:opacity-100 transition-opacity bg-white/30 hover:bg-white/50 px-3 py-1 rounded text-xs text-black font-semibold backdrop-blur-sm">Copy</button>
                            </div>
                        ))
                    )}
                    <div className="flex gap-2 mt-2">
                        <button onClick={downloadColors} className="flex-1 flex items-center justify-center gap-2 text-sm py-2 bg-gray-100 border border-border rounded-md hover:bg-gray-200"><ArrowDownTrayIcon className="w-4 h-4"/> Download Colors</button>
                        <button onClick={downloadCard} className="flex-1 flex items-center justify-center gap-2 text-sm py-2 bg-gray-100 border border-border rounded-md hover:bg-gray-200"><ArrowDownTrayIcon className="w-4 h-4"/> Download Card</button>
                    </div>
                </div>
                {!isLoading && <PreviewCard palette={palette} colors={previewColors} setColors={setPreviewColors} />}
            </div>
        </div>
    );
};\`,
  'components/features/CommandPaletteTrigger.tsx': \`import React from 'react';
import { CommandLineIcon } from '../icons.tsx';

export const CommandPaletteTrigger: React.FC = () => {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center text-text-secondary">
            <div className="text-6xl mb-4 text-primary" aria-hidden="true">
                <CommandLineIcon />
            </div>
            <h1 className="text-3xl font-bold text-text-primary mb-2">
                Command Palette
            </h1>
            <p className="text-lg mb-4 max-w-md">
                The Command Palette provides quick keyboard access to all features and commands.
            </p>
            <div className="bg-surface text-primary border border-border rounded-lg px-6 py-4 animate-pulse shadow-sm">
                <p className="font-semibold text-text-primary">Press <kbd className="mx-1 font-sans px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Ctrl</kbd> + <kbd className="mx-1 font-sans px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">K</kbd> to open.</p>
            </div>
        </div>
    );
};\`,
  'components/features/Connections.tsx': \`import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { validateToken } from '../../services/authService.ts';
import { ACTION_REGISTRY, executeWorkspaceAction } from '../../services/workspaceConnectorService.ts';
import { RectangleGroupIcon, GithubIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { signInWithGoogle } from '../../services/googleAuthService.ts';
import { useVaultModal } from '../../contexts/VaultModalContext.tsx';

const ServiceConnectionCard: React.FC<{
    serviceName: string;
    icon: React.ReactNode;
    fields: { id: string; label: string; placeholder: string }[];
    onConnect: (credentials: Record<string, string>) => Promise<void>;
    onDisconnect: () => Promise<void>;
    status: string;
    isLoading: boolean;
}> = ({ serviceName, icon, fields, onConnect, onDisconnect, status, isLoading }) => {
    const [creds, setCreds] = useState<Record<string, string>>({});

    const handleConnect = () => {
        onConnect(creds);
    };

    const isConnected = status.startsWith('Connected');

    return (
        <div className="bg-surface border border-border rounded-lg p-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10">{icon}</div>
                    <div>
                        <h3 className="text-lg font-bold text-text-primary">{serviceName}</h3>
                        <p className={\\\`text-sm \\\${isConnected ? 'text-green-600' : 'text-text-secondary'}\\\`}>{status}</p>
                    </div>
                </div>
                {isConnected && (
                    <button onClick={onDisconnect} className="px-4 py-2 bg-red-500/10 text-red-600 font-semibold rounded-lg hover:bg-red-500/20">
                        Disconnect
                    </button>
                )}
            </div>
            {!isConnected && (
                <div className="mt-4 pt-4 border-t border-border space-y-2">
                    {fields.map(field => (
                        <div key={field.id}>
                            <label className="text-xs text-text-secondary">{field.label}</label>
                            <input
                                type={field.id.includes('token') || field.id.includes('pat') ? 'password' : 'text'}
                                value={creds[field.id] || ''}
                                onChange={e => setCreds(prev => ({ ...prev, [field.id]: e.target.value }))}
                                placeholder={field.placeholder}
                                className="w-full mt-1 p-2 bg-background border border-border rounded-md text-sm"
                            />
                        </div>
                    ))}
                    <button onClick={handleConnect} disabled={isLoading} className="btn-primary w-full mt-2 py-2 flex items-center justify-center">
                        {isLoading ? <LoadingSpinner /> : 'Connect'}
                    </button>
                </div>
            )}
        </div>
    );
};


export const WorkspaceConnectorHub: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, vaultState } = state;
    const { addNotification } = useNotification();
    const { requestUnlock, requestCreation } = useVaultModal();
    const [loadingStates, setLoadingStates] = useState<Record<string, boolean>>({});
    const [connectionStatuses, setConnectionStatuses] = useState<Record<string, string>>({});
    
    // Manual action state
    const [selectedActionId, setSelectedActionId] = useState<string>([...ACTION_REGISTRY.keys()][0]);
    const [actionParams, setActionParams] = useState<Record<string, any>>({});
    const [isExecuting, setIsExecuting] = useState(false);
    const [actionResult, setActionResult] = useState<string>('');

    const services = useMemo(() => {
        const serviceMap = new Map();
        ACTION_REGISTRY.forEach(action => {
            if (!serviceMap.has(action.service)) {
                serviceMap.set(action.service, {
                    name: action.service,
                    actions: [],
                });
            }
            serviceMap.get(action.service).actions.push(action);
        });
        return Array.from(serviceMap.values());
    }, []);

    const checkConnections = useCallback(async () => {
        if (!user || !vaultState.isUnlocked) return;
        
        const checkCred = async (credId: string, serviceName: string, successMessage: string) => {
             const token = await vaultService.getDecryptedCredential(credId);
             setConnectionStatuses(s => ({ ...s, [serviceName]: token ? successMessage : 'Not Connected' }));
        };

        await checkCred('github_pat', 'GitHub', githubUser ? \\\`Connected as \\\${githubUser.login}\\\`: 'Connected');
        await checkCred('jira_pat', 'Jira', 'Connected');
        await checkCred('slack_bot_token', 'Slack', 'Connected');

    }, [user, vaultState.isUnlocked, githubUser]);

    useEffect(() => {
        checkConnections();
    }, [checkConnections]);
    
    const withVault = useCallback(async (callback: () => Promise<void>) => {
        if (!vaultState.isInitialized) {
            const created = await requestCreation();
            if (!created) { addNotification('Vault setup is required.', 'error'); return; }
        }
        if (!vaultState.isUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) { addNotification('Vault must be unlocked to manage connections.', 'error'); return; }
        }
        await callback();
    }, [vaultState, requestCreation, requestUnlock, addNotification]);


    const handleConnect = async (serviceName: string, credentials: Record<string, string>) => {
        await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const [key, value] of Object.entries(credentials)) {
                    if (value) await vaultService.saveCredential(key, value);
                }
                if (serviceName === 'GitHub' && credentials.github_pat) {
                     const githubProfile = await validateToken(credentials.github_pat);
                     dispatch({ type: 'SET_GITHUB_USER', payload: githubProfile });
                     await vaultService.saveCredential('github_user', JSON.stringify(githubProfile));
                }
                addNotification(\\\`\\\${serviceName} connected successfully!\\\`, 'success');
                checkConnections();
            } catch (e) {
                addNotification(\\\`Failed to connect \\\${serviceName}: \\\${e instanceof Error ? e.message : 'Unknown error'}\\\`, 'error');
            } finally {
                setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
        });
    };
    
    const handleDisconnect = async (serviceName: string, credIds: string[]) => {
       await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const id of credIds) {
                     await vaultService.saveCredential(id, ''); // Overwrite with empty string
                }
                 if (serviceName === 'GitHub') {
                     dispatch({ type: 'SET_GITHUB_USER', payload: null });
                     await vaultService.saveCredential('github_user', '');
                }
                addNotification(\\\`\\\${serviceName} disconnected.\\\`, 'info');
                checkConnections();
            } catch(e) {
                addNotification(\\\`Failed to disconnect \\\${serviceName}.\\\`, 'error');
            } finally {
                 setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
       });
    };
    
    const handleExecuteAction = async () => {
        await withVault(async () => {
            setIsExecuting(true);
            setActionResult('');
            try {
                const result = await executeWorkspaceAction(selectedActionId, actionParams);
                setActionResult(JSON.stringify(result, null, 2));
                addNotification('Action executed successfully!', 'success');
            } catch(e) {
                setActionResult(\\\`Error: \\\${e instanceof Error ? e.message : 'Unknown Error'}\\\`);
                addNotification('Action failed.', 'error');
            } finally {
                setIsExecuting(false);
            }
        });
    };

    const handleSignIn = () => {
        signInWithGoogle();
        // The result is handled by the global callback set in App.tsx
    };

    const selectedAction = ACTION_REGISTRY.get(selectedActionId);
    const actionParameters = selectedAction ? selectedAction.getParameters() : {};

    if (!user) {
        return (
            <div className="h-full flex items-center justify-center">
                <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md">
                    <h2 className="text-xl font-bold">Sign In Required</h2>
                    <p className="text-text-secondary my-4">Please sign in with your Google account to manage workspace connections.</p>
                    <button onClick={handleSignIn} disabled={loadingStates.google} className="btn-primary px-6 py-3 flex items-center justify-center gap-2 mx-auto">
                        {loadingStates.google ? <LoadingSpinner/> : 'Sign in with Google'}
                    </button>
                </div>
            </div>
        );
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
             <header className="mb-8">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center"><RectangleGroupIcon /><span className="ml-3">Workspace Connector Hub</span></h1>
                <p className="mt-2 text-lg text-text-secondary">Connect to your development services to unlock cross-platform AI actions.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                <div className="flex flex-col gap-6 overflow-y-auto pr-4">
                    <h2 className="text-2xl font-bold">Service Connections</h2>
                    <ServiceConnectionCard 
                        serviceName="GitHub"
                        icon={<GithubIcon />}
                        fields={[{ id: 'github_pat', label: 'Personal Access Token', placeholder: 'ghp_...' }]}
                        onConnect={(creds) => handleConnect('GitHub', creds)}
                        onDisconnect={() => handleDisconnect('GitHub', ['github_pat'])}
                        status={connectionStatuses.GitHub || 'Checking...'}
                        isLoading={loadingStates.GitHub}
                    />
                     {/* Placeholder cards for Jira and Slack */}
                    <ServiceConnectionCard 
                        serviceName="Jira"
                        icon={<div className="w-10 h-10 bg-[#0052CC] rounded flex items-center justify-center text-white font-bold text-xl">J</div>}
                        fields={[
                            { id: 'jira_domain', label: 'Jira Domain', placeholder: 'your-company.atlassian.net' },
                            { id: 'jira_email', label: 'Your Jira Email', placeholder: 'you@example.com' },
                            { id: 'jira_pat', label: 'API Token', placeholder: 'Your API Token' },
                        ]}
                        onConnect={(creds) => handleConnect('Jira', creds)}
                        onDisconnect={() => handleDisconnect('Jira', ['jira_domain', 'jira_email', 'jira_pat'])}
                        status={connectionStatuses.Jira || 'Checking...'}
                        isLoading={loadingStates.Jira}
                    />
                    <ServiceConnectionCard 
                        serviceName="Slack"
                        icon={<div className="w-10 h-10 bg-[#4A154B] rounded flex items-center justify-center text-white font-bold text-2xl">#</div>}
                        fields={[{ id: 'slack_bot_token', label: 'Bot User OAuth Token', placeholder: 'xoxb-...' }]}
                        onConnect={(creds) => handleConnect('Slack', creds)}
                        onDisconnect={() => handleDisconnect('Slack', ['slack_bot_token'])}
                        status={connectionStatuses.Slack || 'Checking...'}
                        isLoading={loadingStates.Slack}
                    />
                </div>
                <div className="flex flex-col gap-6 bg-surface p-6 border border-border rounded-lg">
                    <h2 className="text-2xl font-bold">Manual Action Runner</h2>
                    <div className="space-y-4">
                         <div>
                            <label className="text-sm font-medium">Action</label>
                            <select value={selectedActionId} onChange={e => setSelectedActionId(e.target.value)} className="w-full mt-1 p-2 bg-background border rounded">
                                {services.map(service => (
                                    <optgroup label={service.name} key={service.name}>
                                        {service.actions.map((action: any) => (
                                            <option key={action.id} value={action.id}>{action.description}</option>
                                        ))}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                        {Object.entries(actionParameters).map(([key, param]: [string, any]) => (
                            <div key={key}>
                                <label className="text-sm font-medium">{key} {param.required && '*'}</label>
                                <input 
                                    type={param.type}
                                    value={actionParams[key] || ''}
                                    onChange={e => setActionParams(p => ({...p, [key]: e.target.value}))}
                                    placeholder={param.default || ''}
                                    className="w-full mt-1 p-2 bg-background border rounded"
                                />
                            </div>
                        ))}
                        <button onClick={handleExecuteAction} disabled={isExecuting} className="btn-primary w-full py-2 flex items-center justify-center gap-2">
                           {isExecuting ? <LoadingSpinner/> : <><SparklesIcon /> Execute Action</>}
                        </button>
                    </div>
                    <div>
                        <label className="text-sm font-medium">Result</label>
                        <pre className="w-full h-48 mt-1 p-2 bg-background border rounded overflow-auto text-xs">{actionResult || 'Action results will appear here.'}</pre>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/CronJobBuilder.tsx': \`import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { CommandLineIcon, SparklesIcon } from '../icons.tsx';
import { generateCronFromDescription, CronParts } from '../../services/index.ts';
import { LoadingSpinner } from '../shared/index.tsx';

const CronPartSelector: React.FC<{ label: string, value: string, onChange: (value: string) => void, options: (string|number)[] }> = ({ label, value, onChange, options }) => {
    return (
        <div>
            <label className="block text-sm font-medium text-text-secondary">{label}</label>
            <select value={value} onChange={e => onChange(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-md bg-surface border border-border">
                <option value="*">* (every)</option>
                {options.map(o => <option key={o} value={o}>{o}</option>)}
            </select>
        </div>
    );
};

export const CronJobBuilder: React.FC<{ initialPrompt?: string }> = ({ initialPrompt }) => {
    const [minute, setMinute] = useState('0');
    const [hour, setHour] = useState('17');
    const [dayOfMonth, setDayOfMonth] = useState('*');
    const [month, setMonth] = useState('*');
    const [dayOfWeek, setDayOfWeek] = useState('1-5');
    const [aiPrompt, setAiPrompt] = useState(initialPrompt || 'every weekday at 5pm');
    const [isLoading, setIsLoading] = useState(false);
    
    const cronExpression = useMemo(() => {
        return \\\`\\\${minute} \\\${hour} \\\${dayOfMonth} \\\${month} \\\${dayOfWeek}\\\`;
    }, [minute, hour, dayOfMonth, month, dayOfWeek]);

    const handleAiGenerate = useCallback(async (p: string) => {
        if (!p) return;
        setIsLoading(true);
        try {
            const result: CronParts = await generateCronFromDescription(p);
            setMinute(result.minute);
            setHour(result.hour);
            setDayOfMonth(result.dayOfMonth);
            setMonth(result.month);
            setDayOfWeek(result.dayOfWeek);
        } catch (e) {
            console.error(e);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialPrompt) {
            setAiPrompt(initialPrompt);
            handleAiGenerate(initialPrompt);
        }
    }, [initialPrompt, handleAiGenerate]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CommandLineIcon />
                    <span className="ml-3">AI Cron Job Builder</span>
                </h1>
                <p className="text-text-secondary mt-1">Visually construct a cron expression or describe it in plain English.</p>
            </header>
             <div className="flex gap-2 mb-6">
                <input type="text" value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Describe a schedule..." className="flex-grow px-3 py-1.5 rounded-md bg-surface border border-border text-sm"/>
                <button onClick={() => handleAiGenerate(aiPrompt)} disabled={isLoading} className="btn-primary px-4 py-1.5 flex items-center gap-2">
                    {isLoading ? <LoadingSpinner /> : <SparklesIcon />} AI Generate
                </button>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <CronPartSelector label="Minute" value={minute} onChange={setMinute} options={Array.from({length: 60}, (_, i) => i)} />
                <CronPartSelector label="Hour" value={hour} onChange={setHour} options={Array.from({length: 24}, (_, i) => i)} />
                <CronPartSelector label="Day (Month)" value={dayOfMonth} onChange={setDayOfMonth} options={Array.from({length: 31}, (_, i) => i + 1)} />
                <CronPartSelector label="Month" value={month} onChange={setMonth} options={Array.from({length: 12}, (_, i) => i + 1)} />
                <CronPartSelector label="Day (Week)" value={dayOfWeek} onChange={setDayOfWeek} options={Array.from({length: 7}, (_, i) => i)} />
            </div>
            <div className="bg-surface p-4 rounded-lg text-center border border-border">
                <p className="text-text-secondary text-sm">Generated Expression</p>
                <p className="font-mono text-primary text-2xl mt-1">{cronExpression}</p>
                 <button onClick={() => navigator.clipboard.writeText(cronExpression)} className="mt-4 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button>
            </div>
        </div>
    );
};\`,
  'components/features/CssGridEditor.tsx': \`import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/index.ts';

const initialSettings = { rows: 3, cols: 4, rowGap: 1, colGap: 1 };

export const CssGridEditor: React.FC = () => {
    const [rows, setRows] = useState(initialSettings.rows);
    const [cols, setCols] = useState(initialSettings.cols);
    const [rowGap, setRowGap] = useState(initialSettings.rowGap);
    const [colGap, setColGap] = useState(initialSettings.colGap);

    const gridStyle = {
        display: 'grid',
        gridTemplateColumns: \\\`repeat(\\\${cols}, 1fr)\\\`,
        gridTemplateRows: \\\`repeat(\\\${rows}, 1fr)\\\`,
        gap: \\\`\\\${rowGap}rem \\\${colGap}rem\\\`,
        height: '100%',
        width: '100%'
    };

    const cssCode = useMemo(() => {
        return \\\`.grid-container {
  display: grid;
  grid-template-columns: repeat(\\\${cols}, 1fr);
  grid-template-rows: repeat(\\\${rows}, 1fr);
  gap: \\\${rowGap}rem \\\${colGap}rem;
}\\\`;
    }, [rows, cols, rowGap, colGap]);
    
    const handleCopy = () => {
        navigator.clipboard.writeText(cssCode);
    };
    
    const handleDownload = () => {
        downloadFile(cssCode, 'grid.css', 'text/css');
    };

    const handleReset = () => {
        setRows(initialSettings.rows);
        setCols(initialSettings.cols);
        setRowGap(initialSettings.rowGap);
        setColGap(initialSettings.colGap);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <CodeBracketSquareIcon />
                    <span className="ml-3">CSS Grid Visual Editor</span>
                </h1>
                <p className="text-text-secondary mt-1">Configure your grid layout and copy the generated CSS.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <div className="flex justify-between items-center">
                        <h3 className="text-xl font-bold">Controls</h3>
                        <button onClick={handleReset} className="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md">Reset</button>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="rows" className="block text-sm font-medium text-text-secondary">Rows ({rows})</label>
                            <input id="rows" type="range" min="1" max="12" value={rows} onChange={e => setRows(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                        <div>
                            <label htmlFor="cols" className="block text-sm font-medium text-text-secondary">Columns ({cols})</label>
                            <input id="cols" type="range" min="1" max="12" value={cols} onChange={e => setCols(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                         <div>
                            <label htmlFor="rowGap" className="block text-sm font-medium text-text-secondary">Row Gap ({rowGap}rem)</label>
                            <input id="rowGap" type="range" min="0" max="8" step="0.25" value={rowGap} onChange={e => setRowGap(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                         <div>
                            <label htmlFor="colGap" className="block text-sm font-medium text-text-secondary">Column Gap ({colGap}rem)</label>
                            <input id="colGap" type="range" min="0" max="8" step="0.25" value={colGap} onChange={e => setColGap(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                        </div>
                    </div>
                     <div className="flex-grow mt-4 flex flex-col min-h-[150px]">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-sm font-medium text-text-secondary">Generated CSS</label>
                            <div className="flex gap-2">
                                <button onClick={handleCopy} className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs"><ArrowDownTrayIcon className="w-4 h-4"/> Download</button>
                            </div>
                        </div>
                        <div className="relative flex-grow">
                            <pre className="bg-background p-4 rounded-md text-primary text-sm overflow-auto h-full w-full absolute">{cssCode}</pre>
                        </div>
                    </div>
                </div>
                <div className="lg:col-span-2 bg-background rounded-lg p-4 border-2 border-dashed border-border">
                    <div style={gridStyle}>
                        {Array.from({ length: rows * cols }).map((_, i) => (
                            <div key={i} className="bg-primary/10 rounded-lg border-2 border-dashed border-primary/50 flex items-center justify-center text-primary">
                                <span className="text-xs opacity-70">{i + 1}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/DeploymentPreview.tsx': \`import React, { useState, useEffect, useRef } from 'react';
import { getAllFiles, getFileByPath } from '../../services/dbService.ts';
import type { GeneratedFile } from '../../types.ts';
import { CloudIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

export const DeploymentPreview: React.FC = () => {
    const [files, setFiles] = useState<GeneratedFile[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState('');
    const iframeRef = useRef<HTMLIFrameElement>(null);

    useEffect(() => {
        const loadAndRender = async () => {
            setIsLoading(true);
            setError('');
            try {
                const allFiles = await getAllFiles();
                if (allFiles.length === 0) {
                    setError('No files generated by AI Feature Builder found.');
                    setFiles([]);
                    setIsLoading(false);
                    return;
                }
                setFiles(allFiles);

                let indexHtmlFile = allFiles.find(f => f.filePath.endsWith('index.html'));
                if (!indexHtmlFile) {
                    setError('No index.html file found in the generated files.');
                    setIsLoading(false);
                    return;
                }

                let content = indexHtmlFile.content;
                
                // Create blob URLs for all assets and replace relative paths
                const blobUrlMap = new Map<string, string>();
                for (const file of allFiles) {
                    const mimeType = file.filePath.endsWith('.css') ? 'text/css' : 'application/javascript';
                    const blob = new Blob([file.content], { type: mimeType });
                    blobUrlMap.set(file.filePath, URL.createObjectURL(blob));
                }
                
                // Replace relative paths in index.html
                content = content.replace(/(href|src)=["'](\\\\.?\\\\/)?([^"']+)["']/g, (match, attr, prefix, path) => {
                    const blobUrl = blobUrlMap.get(path);
                    return blobUrl ? \\\`\\\${attr}="\\\${blobUrl}"\\\` : match;
                });

                if (iframeRef.current) {
                    iframeRef.current.srcdoc = content;
                }

            } catch (err) {
                setError(err instanceof Error ? err.message : 'Failed to load files.');
            } finally {
                setIsLoading(false);
            }
        };

        loadAndRender();
        
        // Cleanup blob URLs on unmount
        return () => {
             // This is a bit tricky since we don't have the map here, but the browser will clean them up.
        };
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><CloudIcon /><span className="ml-3">Static Deployment Previewer</span></h1>
                <p className="text-text-secondary mt-1">Live preview of the static site generated by the AI Feature Builder.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 bg-surface p-4 border border-border rounded-lg overflow-y-auto">
                    <h3 className="font-bold mb-2">File List</h3>
                    <ul className="text-sm space-y-1">
                        {files.map(f => <li key={f.filePath} className="truncate p-1 bg-background rounded">{f.filePath}</li>)}
                    </ul>
                </div>
                <div className="lg:col-span-2 bg-background border-2 border-dashed border-border rounded-lg overflow-hidden">
                    {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                    {error && <div className="flex justify-center items-center h-full text-red-500">{error}</div>}
                    {!isLoading && !error && <iframe ref={iframeRef} title="Deployment Preview" className="w-full h-full bg-white"/>}
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/DevNotesStickyPanel.tsx': \`import React from 'react';

export const DevNotesStickyPanel: React.FC = () => {
    return (
        <div className="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
            <h4 className="font-bold">Developer Notes</h4>
            <p>This is a placeholder component for developer notes.</p>
        </div>
    );
};
\`,
  'components/features/DigitalWhiteboard.tsx': \`import React, { useState, useCallback } from 'react';
import { SparklesIcon, DigitalWhiteboardIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';
import { summarizeNotesStream } from '../../services/index.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { MarkdownRenderer } from '../shared/index.tsx';

interface Note {
    id: number;
    text: string;
    x: number;
    y: number;
    color: string;
}

const colors = ['bg-yellow-400', 'bg-green-400', 'bg-blue-400', 'bg-pink-400', 'bg-purple-400', 'bg-orange-400'];
const textColors = ['text-yellow-900', 'text-green-900', 'text-blue-900', 'text-pink-900', 'text-purple-900', 'text-orange-900'];

export const DigitalWhiteboard: React.FC = () => {
    const [notes, setNotes] = useLocalStorage<Note[]>('devcore_whiteboard_notes', []);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const [isSummarizing, setIsSummarizing] = useState(false);
    const [summary, setSummary] = useState('');

    const handleSummarize = useCallback(async () => {
        if (notes.length === 0) return;
        setIsSummarizing(true);
        setSummary('');
        try {
            const allNotesText = notes.map((n: Note) => \\\`- \\\${n.text}\\\`).join('\\\\n');
            const stream = summarizeNotesStream(allNotesText);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setSummary(fullResponse);
            }
        } catch (error) {
            console.error(error);
            setSummary('Sorry, an error occurred while summarizing.');
        } finally {
            setIsSummarizing(false);
        }
    }, [notes]);

    const addNote = () => {
        const newNote: Note = {
            id: Date.now(),
            text: 'New idea...',
            x: 50,
            y: 50,
            color: colors[notes.length % colors.length],
        };
        setNotes([...notes, newNote]);
    };
    
    const deleteNote = (id: number, e: React.MouseEvent) => {
        e.stopPropagation();
        setNotes(notes.filter((n) => n.id !== id));
    };

    const updateNote = (id: number, updates: Partial<Note>) => {
        setNotes(notes.map((n) => n.id === id ? { ...n, ...updates } : n));
    };

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        const target = e.target as HTMLElement;
        if (target.tagName === 'TEXTAREA' || target.dataset.role === 'button') return;
        
        const noteElement = e.currentTarget;
        const rect = noteElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging) return;
        const boardRect = e.currentTarget.getBoundingClientRect();
        updateNote(dragging.id, {
            x: e.clientX - dragging.offsetX - boardRect.left,
            y: e.clientY - dragging.offsetY - boardRect.top
        });
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                 <div>
                    <h1 className="text-3xl font-bold flex items-center"><DigitalWhiteboardIcon /><span className="ml-3">Digital Whiteboard</span></h1>
                    <p className="text-text-secondary mt-1">Organize your ideas with interactive sticky notes and AI summaries.</p>
                </div>
                <div className="flex gap-2">
                    <button onClick={handleSummarize} disabled={isSummarizing || notes.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                        <SparklesIcon/> {isSummarizing ? 'Summarizing...' : 'AI Summarize'}
                    </button>
                    <button onClick={addNote} className="btn-primary px-6 py-2">Add Note</button>
                </div>
            </header>
            <div
                className="relative flex-grow bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}
            >
                {notes.map((note) => (
                    <div
                        key={note.id}
                        className={\\\`group absolute w-56 h-56 p-2 flex flex-col shadow-lg cursor-grab active:cursor-grabbing rounded-md transition-transform duration-100 border border-black/40 \\\${note.color} \\\${textColors[colors.indexOf(note.color)]}\\\`}
                        style={{ top: note.y, left: note.x, transform: dragging?.id === note.id ? 'scale(1.05)' : 'scale(1)' }}
                        onMouseDown={e => onMouseDown(e, note.id)}
                    >
                        <button data-role="button" onClick={(e) => deleteNote(note.id, e)} className="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-gray-700 text-white font-bold text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500 transition-all">&times;</button>
                        <textarea
                            value={note.text}
                            onChange={(e) => updateNote(note.id, { text: e.target.value })}
                            className="w-full h-full bg-transparent resize-none focus:outline-none font-medium p-1"
                        />
                        <div data-role="button" className="flex-shrink-0 flex justify-center gap-1 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            {colors.map((c, i) => <button key={c} onClick={() => updateNote(note.id, { color: c })} className={\\\`w-4 h-4 rounded-full \\\${c} border border-black/20 \\\${note.color === c ? 'ring-2 ring-offset-1 ring-black/50' : ''}\\\`}/>)}
                        </div>
                    </div>
                ))}
            </div>
             {(isSummarizing || summary) && (
                 <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center" onClick={() => setSummary('')}>
                    <div className="w-full max-w-2xl bg-surface border border-border rounded-lg shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                        <h2 className="text-xl font-bold mb-4">AI Summary of Notes</h2>
                        {isSummarizing && !summary ? <LoadingSpinner /> : <MarkdownRenderer content={summary} />}
                    </div>
                </div>
            )}
        </div>
    );
};\`,
  'components/features/EnvManager.tsx': \`import React, { useState } from 'react';
import { downloadEnvFile } from '../../services/fileUtils.ts';
import { DocumentTextIcon, PlusIcon, TrashIcon, ArrowDownTrayIcon } from '../icons.tsx';

interface EnvVar {
    id: number;
    key: string;
    value: string;
}

export const EnvManager: React.FC = () => {
    const [envVars, setEnvVars] = useState<EnvVar[]>([
        { id: 1, key: 'VITE_API_URL', value: 'https://api.example.com' },
        { id: 2, key: 'VITE_ENABLE_FEATURE_X', value: 'true' },
    ]);

    const handleAdd = () => {
        setEnvVars([...envVars, { id: Date.now(), key: '', value: '' }]);
    };

    const handleUpdate = (id: number, field: 'key' | 'value', val: string) => {
        setEnvVars(envVars.map(v => v.id === id ? { ...v, [field]: val } : v));
    };

    const handleRemove = (id: number) => {
        setEnvVars(envVars.filter(v => v.id !== id));
    };
    
    const handleDownload = () => {
        const envObject = envVars.reduce((acc, v) => {
            if (v.key) acc[v.key] = v.value;
            return acc;
        }, {} as Record<string, string>);
        downloadEnvFile(envObject);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><DocumentTextIcon /><span className="ml-3">Environment Variable Manager</span></h1>
                <p className="text-text-secondary mt-1">Create and manage your \\\`.env\\\` files with a simple interface.</p>
            </header>
            <div className="flex-grow bg-surface p-6 rounded-lg border border-border w-full max-w-4xl mx-auto overflow-y-auto">
                <div className="space-y-3">
                    <div className="grid grid-cols-12 gap-4 font-semibold text-sm text-text-secondary px-2">
                        <div className="col-span-5">Key</div>
                        <div className="col-span-6">Value</div>
                        <div className="col-span-1"></div>
                    </div>
                    {envVars.map((v, index) => (
                        <div key={v.id} className="grid grid-cols-12 gap-4 items-center">
                            <div className="col-span-5">
                                <input
                                    type="text"
                                    value={v.key}
                                    onChange={e => handleUpdate(v.id, 'key', e.target.value)}
                                    placeholder={\\\`KEY_\\\${index + 1}\\\`}
                                    className="w-full p-2 bg-background border border-border rounded-md font-mono text-sm"
                                />
                            </div>
                            <div className="col-span-6">
                                <input
                                    type="text"
                                    value={v.value}
                                    onChange={e => handleUpdate(v.id, 'value', e.target.value)}
                                    placeholder="value"
                                    className="w-full p-2 bg-background border border-border rounded-md font-mono text-sm"
                                />
                            </div>
                            <div className="col-span-1">
                                <button onClick={() => handleRemove(v.id)} className="p-2 text-text-secondary hover:text-red-500 rounded-md"><TrashIcon /></button>
                            </div>
                        </div>
                    ))}
                </div>
                 <div className="mt-4 pt-4 border-t border-border flex justify-between items-center">
                    <button onClick={handleAdd} className="flex items-center gap-2 px-4 py-2 bg-gray-100 text-sm font-semibold rounded-md hover:bg-gray-200">
                        <PlusIcon /> Add Variable
                    </button>
                    <button onClick={handleDownload} disabled={envVars.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                        <ArrowDownTrayIcon /> Download .env File
                    </button>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/FontPairingTool.tsx': \`// This feature is an alias for the Typography Lab.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { TypographyLab as FontPairingTool } from './TypographyLab.tsx';\`,
  'components/features/FontPreviewPicker.tsx': \`import React, { useState, useEffect } from 'react';
import { TypographyLabIcon } from '../icons.tsx';

const popularFonts = [
    'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Source Sans Pro', 'Raleway', 'Poppins', 'Nunito', 'Merriweather',
    'Playfair Display', 'Lora', 'Noto Sans', 'Ubuntu', 'PT Sans', 'Slabo 27px', 'Great Vibes', 'EB Garamond'
];

export const FontPreviewPicker: React.FC = () => {
    const [text, setText] = useState('The quick brown fox jumps over the lazy dog.');
    const [fontSize, setFontSize] = useState(24);

    useEffect(() => {
        const fontsToLoad = popularFonts.join('|').replace(/ /g, '+');
        const linkId = 'font-picker-stylesheet';
        let link = document.getElementById(linkId) as HTMLLinkElement;
        if (!link) {
            link = document.createElement('link');
            link.id = linkId;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        }
        link.href = \\\`https://fonts.googleapis.com/css?family=\\\${fontsToLoad}:400,700&display=swap\\\`;
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <TypographyLabIcon />
                    <span className="ml-3">Font Preview Picker</span>
                </h1>
                <p className="text-text-secondary mt-1">Enter your text and see how it looks with different fonts.</p>
            </header>

            <div className="flex flex-col md:flex-row gap-4 mb-6">
                <div className="flex-grow">
                    <label htmlFor="preview-text" className="text-sm font-medium">Preview Text</label>
                    <input
                        id="preview-text"
                        type="text"
                        value={text}
                        onChange={e => setText(e.target.value)}
                        className="w-full mt-1 p-2 bg-surface border border-border rounded-md"
                    />
                </div>
                <div>
                    <label htmlFor="font-size" className="text-sm font-medium">Font Size ({fontSize}px)</label>
                    <input
                        id="font-size"
                        type="range"
                        min="12"
                        max="72"
                        value={fontSize}
                        onChange={e => setFontSize(Number(e.target.value))}
                        className="w-full mt-1"
                    />
                </div>
            </div>

            <div className="flex-grow bg-surface border border-border rounded-lg p-4 overflow-y-auto">
                <div className="space-y-4">
                    {popularFonts.map(font => (
                        <div key={font} className="border-b border-border pb-2">
                            <p className="text-sm text-text-secondary">{font}</p>
                            <p style={{ fontFamily: \\\`'\\\${font}', sans-serif\\\`, fontSize: \\\`\\\${fontSize}px\\\` }}>
                                {text}
                            </p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/GmailAddonSimulator.tsx': \`import React, { useState, useCallback } from 'react';
import { streamContent } from '../../services/aiService.ts';
import { MailIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const mockEmail = {
    from: 'Alice <alice@example.com>',
    to: 'Me <me@example.com>',
    subject: 'Project Update & Question',
    body: \\\`Hey,

Just wanted to give you a quick update. The new user authentication flow is complete and pushed to the staging server.

I had a question about the next task regarding the database migration. The ticket says we need to migrate the 'users' table, but it's not clear on the required schema changes. Should I just add the new 'last_login' column or are there other modifications needed?

Let me know when you have a chance.

Thanks,
Alice\\\`
};

export const GmailAddonSimulator: React.FC = () => {
    const [isComposeOpen, setComposeOpen] = useState(false);
    const [generatedReply, setGeneratedReply] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);

    const handleGenerateReply = useCallback(async () => {
        setIsGenerating(true);
        setGeneratedReply('');
        setComposeOpen(true);
        try {
            const prompt = \\\`Generate a professional and friendly reply to the following email. Acknowledge the update and answer the question by stating that only the 'last_login' column (as a DATETIME) is needed for now.\\\\n\\\\nEMAIL:\\\\n\\\${mockEmail.body}\\\`;
            const stream = streamContent(prompt, "You are a helpful assistant writing a professional email reply.", 0.7);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setGeneratedReply(fullResponse);
            }
        } catch(e) {
            setGeneratedReply(\\\`Error: \\\${e instanceof Error ? e.message : 'Could not generate reply.'}\\\`);
        }
        finally {
            setIsGenerating(false);
        }
    }, []);

    const ComposeModal = () => (
        <div className="absolute inset-0 bg-black/30 backdrop-blur-sm flex justify-center items-center p-4 z-20">
            <div className="w-full max-w-2xl h-[70vh] bg-surface rounded-lg shadow-2xl flex flex-col animate-pop-in">
                <header className="flex justify-between items-center p-3 bg-gray-100 dark:bg-slate-700 rounded-t-lg">
                    <h3 className="font-semibold text-sm">New Message</h3>
                    <button onClick={() => setComposeOpen(false)}><XMarkIcon /></button>
                </header>
                <div className="p-3 text-sm border-b border-border">
                    <p><span className="text-text-secondary">To:</span> {mockEmail.from}</p>
                </div>
                <div className="p-3 text-sm border-b border-border">
                     <p><span className="text-text-secondary">Subject:</span> Re: {mockEmail.subject}</p>
                </div>
                <div className="flex-grow p-3 overflow-y-auto">
                    {isGenerating ? <div className="flex justify-center items-center h-full"><LoadingSpinner /></div> : <MarkdownRenderer content={generatedReply} />}
                </div>
                 <footer className="p-3 border-t border-border">
                    <button className="btn-primary px-6 py-2">Send</button>
                 </footer>
            </div>
        </div>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><MailIcon /><span className="ml-3">Gmail Add-on Simulator</span></h1>
                <p className="text-text-secondary mt-1">A simulation of how contextual add-on scopes would work inside Gmail.</p>
            </header>
            <div className="relative flex-grow bg-surface border-2 border-dashed border-border rounded-lg p-6 flex items-center justify-center">
                {isComposeOpen && <ComposeModal />}
                <div className="w-full max-w-4xl h-full bg-white dark:bg-slate-800 rounded-xl shadow-2xl flex flex-col overflow-hidden">
                    {/* Header */}
                    <div className="flex-shrink-0 p-4 border-b border-border">
                        <h2 className="text-xl font-bold">{mockEmail.subject}</h2>
                        <div className="flex items-center gap-2 text-sm mt-2">
                             <img src="https://avatar.vercel.sh/alice" alt="Alice" className="w-8 h-8 rounded-full" />
                             <div>
                                <p className="font-semibold">{mockEmail.from.split('<')[0].trim()}</p>
                                <p className="text-text-secondary text-xs">to {mockEmail.to.split('<')[0].trim()}</p>
                             </div>
                        </div>
                    </div>
                    {/* Body */}
                    <div className="flex-grow p-4 overflow-y-auto">
                        <pre className="whitespace-pre-wrap font-sans text-sm">{mockEmail.body}</pre>
                    </div>
                    {/* Actions */}
                    <div className="flex-shrink-0 p-4 border-t border-border bg-gray-50 dark:bg-slate-900/50 flex justify-between items-center">
                        <div className="text-xs text-text-secondary">
                            <strong>Disclaimer:</strong> This is a simulation. The requested scopes allow this app to read the current email and compose replies <strong>if it were running inside Gmail.</strong>
                        </div>
                        <button onClick={handleGenerateReply} disabled={isGenerating} className="btn-primary flex items-center justify-center gap-2 px-4 py-2">
                           <SparklesIcon /> AI Reply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/IamPolicyGenerator.tsx': \`import React, { useState, useCallback } from 'react';
import { generateIamPolicyStream } from '../../services/aiService.ts';
import { ShieldCheckIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const IamPolicyGenerator: React.FC = () => {
    const [description, setDescription] = useState('A user role that can read from S3 buckets but not write or delete.');
    const [platform, setPlatform] = useState<'aws' | 'gcp'>('aws');
    const [policy, setPolicy] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!description.trim()) {
            setError('Please provide a description.');
            return;
        }
        setIsLoading(true);
        setError('');
        setPolicy('');
        try {
            const stream = generateIamPolicyStream(description, platform);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setPolicy(fullResponse);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [description, platform]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <ShieldCheckIcon />
                    <span className="ml-3">IAM Policy Generator</span>
                </h1>
                <p className="text-text-secondary mt-1">Generate AWS or GCP IAM policies from a natural language description.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col gap-4">
                     <div>
                        <label htmlFor="platform" className="text-sm font-medium mb-2 block">Cloud Platform</label>
                        <div className="flex gap-2 p-1 bg-surface rounded-lg border">
                            <button onClick={() => setPlatform('aws')} className={\\\`flex-1 py-2 rounded-md text-sm \\\${platform === 'aws' ? 'bg-primary text-text-on-primary' : ''}\\\`}>AWS</button>
                            <button onClick={() => setPlatform('gcp')} className={\\\`flex-1 py-2 rounded-md text-sm \\\${platform === 'gcp' ? 'bg-primary text-text-on-primary' : ''}\\\`}>GCP</button>
                        </div>
                    </div>
                    <div className="flex flex-col flex-1 min-h-0">
                        <label htmlFor="description" className="text-sm font-medium mb-2">Describe the desired permissions</label>
                        <textarea id="description" value={description} onChange={e => setDescription(e.target.value)} className="flex-grow p-2 bg-surface border rounded text-sm"/>
                    </div>
                    <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-3">{isLoading ? <LoadingSpinner/> : 'Generate Policy'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Generated Policy (JSON)</label>
                    <div className="flex-grow p-1 bg-background border rounded overflow-auto">
                        {isLoading && !policy && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {policy && <MarkdownRenderer content={policy} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/IamPolicyVisualizer.tsx': \`import React, { useState, useCallback, useMemo } from 'react';
import { testIamPermissions } from '../../services/gcpService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { GcpIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

type SimulationStatus = 'idle' | 'running' | 'completed' | 'error';
type NodeStatus = 'neutral' | 'pending' | 'success' | 'fail' | 'partial';

interface ResourceNode {
    id: string; // The full resource name
    name: string;
    type: 'project' | 'bucket' | 'instance' | 'unknown';
    status: NodeStatus;
    results?: { permission: string; granted: boolean }[];
}

const COMMON_ROLES = {
    'Viewer': ['resourcemanager.projects.get', 'storage.objects.list', 'compute.instances.list'],
    'Editor': ['storage.objects.create', 'storage.objects.delete', 'compute.instances.start', 'compute.instances.stop'],
    'Storage Object Admin': ['storage.objects.create', 'storage.objects.delete', 'storage.objects.get', 'storage.objects.list', 'storage.objects.update'],
};

const getResourceType = (resourceId: string): ResourceNode['type'] => {
    if (resourceId.includes('/projects/')) return 'project';
    if (resourceId.includes('/b/')) return 'bucket';
    if (resourceId.includes('/instances/')) return 'instance';
    return 'unknown';
};

export const IamPolicyVisualizer: React.FC = () => {
    const { state } = useGlobalState();
    const [resources, setResources] = useState<ResourceNode[]>([]);
    const [newResource, setNewResource] = useState('//cloudresourcemanager.googleapis.com/projects/your-gcp-project-id');
    const [permissions, setPermissions] = useState('storage.objects.get\\\\nstorage.objects.create');
    const [simulationStatus, setSimulationStatus] = useState<SimulationStatus>('idle');
    const [error, setError] = useState('');
    const [selectedNode, setSelectedNode] = useState<ResourceNode | null>(null);

    const permissionList = useMemo(() => permissions.split('\\\\n').map(p => p.trim()).filter(Boolean), [permissions]);

    const handleAddResource = () => {
        if (newResource.trim() && !resources.find(r => r.id === newResource)) {
            setResources(prev => [...prev, {
                id: newResource,
                name: newResource.split('/').pop() || newResource,
                type: getResourceType(newResource),
                status: 'neutral',
            }]);
            setNewResource('');
        }
    };

    const handleRunSimulation = useCallback(async () => {
        if (!state.user) {
            setError('You must be signed in to run a simulation.');
            return;
        }
        if (resources.length === 0 || permissionList.length === 0) {
            setError('Please add at least one resource and one permission.');
            return;
        }

        setSimulationStatus('running');
        setError('');
        setSelectedNode(null);
        setResources(r => r.map(res => ({ ...res, status: 'pending', results: [] })));

        const promises = resources.map(resource =>
            testIamPermissions(resource.id, permissionList)
                .then(result => ({ id: resource.id, success: true, data: result }))
                .catch(err => ({ id: resource.id, success: false, error: err }))
        );

        const results = await Promise.allSettled(promises);

        setResources(prevResources => prevResources.map(resource => {
            const result: any = results.find((r: any) => r.value?.id === resource.id);
            if (!result || !result.value.success) {
                return { ...resource, status: 'fail' as NodeStatus };
            }
            
            const grantedPermissions = result.value.data.permissions || [];
            const permissionResults = permissionList.map(p => ({ permission: p, granted: grantedPermissions.includes(p) }));
            const allGranted = permissionResults.every(r => r.granted);
            const noneGranted = permissionResults.every(r => !r.granted);

            let status: NodeStatus = 'partial';
            if (allGranted) status = 'success';
            if (noneGranted) status = 'fail';

            return { ...resource, status, results: permissionResults };
        }));

        setSimulationStatus('completed');

    }, [resources, permissionList, state.user]);
    
    const nodeColorClass: Record<NodeStatus, string> = {
        neutral: 'border-slate-600',
        pending: 'border-yellow-500 animate-pulse',
        success: 'border-green-500',
        fail: 'border-red-500',
        partial: 'border-orange-500',
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary bg-background">
            {selectedNode && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center" onClick={() => setSelectedNode(null)}>
                    <div className="bg-surface rounded-lg shadow-xl p-6 w-full max-w-lg animate-pop-in" onClick={e => e.stopPropagation()}>
                        <h3 className="text-lg font-bold truncate">{selectedNode.name}</h3>
                        <p className="text-xs text-text-secondary font-mono mb-4">{selectedNode.id}</p>
                        <ul className="space-y-2 max-h-96 overflow-y-auto">
                            {selectedNode.results?.map(res => (
                                <li key={res.permission} className={\\\`flex items-center justify-between p-2 rounded text-sm \\\${res.granted ? 'bg-green-500/10' : 'bg-red-500/10'}\\\`}>
                                    <span className="font-mono">{res.permission}</span>
                                    <span className={\\\`font-bold \\\${res.granted ? 'text-green-500' : 'text-red-500'}\\\`}>{res.granted ? 'GRANTED' : 'DENIED'}</span>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            )}
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><GcpIcon /><span className="ml-3">GCP IAM Policy Visualizer</span></h1><p className="text-text-secondary mt-1">Visually test and audit GCP IAM permissions in real-time across your resources.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <aside className="lg:col-span-1 bg-surface p-4 rounded-lg border border-border flex flex-col gap-4">
                    <h3 className="text-xl font-bold">Simulation Controls</h3>
                    <div><label className="text-sm font-semibold">1. Add Resource</label><div className="flex gap-1 mt-1"><input value={newResource} onChange={e => setNewResource(e.target.value)} placeholder="Full GCP resource name..." className="flex-grow p-2 bg-background border rounded text-xs" /><button onClick={handleAddResource} className="btn-primary px-3 text-sm">+</button></div></div>
                    <div><label className="text-sm font-semibold">2. Define Permission Set</label><select onChange={e => setPermissions(COMMON_ROLES[e.target.value as keyof typeof COMMON_ROLES]?.join('\\\\n') || '')} className="w-full mt-1 p-2 bg-background border rounded text-xs mb-1"><option>Load common role...</option>{Object.keys(COMMON_ROLES).map(r => <option key={r}>{r}</option>)}</select><textarea value={permissions} onChange={e => setPermissions(e.target.value)} placeholder="One permission per line..." className="w-full h-32 p-2 bg-background border rounded text-xs font-mono"/></div>
                    <button onClick={handleRunSimulation} disabled={simulationStatus === 'running'} className="btn-primary py-3 flex items-center justify-center gap-2"><SparklesIcon /> {simulationStatus === 'running' ? 'Simulating...' : 'Run Simulation'}</button>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                </aside>
                <main className="lg:col-span-2 bg-gray-50 dark:bg-slate-900/50 rounded-lg p-4 border-2 border-dashed border-border overflow-auto relative">
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        {resources.map(res => (
                            <div key={res.id} onClick={() => res.results && setSelectedNode(res)} className={\\\`p-4 bg-surface rounded-lg border-4 transition-colors duration-500 \\\${nodeColorClass[res.status]} \\\${res.results ? 'cursor-pointer hover:scale-105' : ''}\\\`}>
                                <h4 className="font-bold truncate">{res.name}</h4>
                                <p className="text-xs text-text-secondary capitalize">{res.type}</p>
                            </div>
                        ))}
                    </div>
                    {resources.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-text-secondary">Add resources to begin your simulation.</div>}
                </main>
            </div>
        </div>
    );
};\`,
  'components/features/JsonTreeNavigator.tsx': \`import React, { useState } from 'react';
import { FileCodeIcon } from '../icons.tsx';

interface JsonNodeProps {
    data: any;
    nodeKey: string;
    isRoot?: boolean;
}

const JsonNode: React.FC<JsonNodeProps> = ({ data, nodeKey, isRoot = false }) => {
    const [isOpen, setIsOpen] = useState(isRoot);
    const isObject = typeof data === 'object' && data !== null;

    const toggleOpen = () => setIsOpen(!isOpen);

    if (!isObject) {
        return (
            <div className="ml-4 pl-4 border-l border-border">
                <span className="text-purple-700">{nodeKey}: </span>
                <span className={typeof data === 'string' ? 'text-green-700' : 'text-orange-700'}>
                    {typeof data === 'string' ? \\\`"\\\${data}"\\\` : String(data)}
                </span>
            </div>
        );
    }

    const entries = Object.entries(data);
    const bracket = Array.isArray(data) ? '[]' : '{}';

    return (
        <div className={\\\`ml-4 \\\${!isRoot ? 'pl-4 border-l border-border' : ''}\\\`}>
            <button onClick={toggleOpen} className="flex items-center cursor-pointer hover:bg-gray-100 rounded px-1">
                <span className={\\\`transform transition-transform \\\${isOpen ? 'rotate-90' : 'rotate-0'}\\\`}>▶</span>
                <span className="ml-1 text-purple-700">{nodeKey}:</span>
                <span className="ml-2 text-text-secondary">{bracket[0]}</span>
                {!isOpen && <span className="text-text-secondary">...{bracket[1]}</span>}
            </button>
            {isOpen && (
                <div>
                    {entries.map(([key, value]) => (
                        <JsonNode key={key} nodeKey={key} data={value} />
                    ))}
                    <div className="text-text-secondary ml-4">{bracket[1]}</div>
                </div>
            )}
        </div>
    );
};

export const JsonTreeNavigator: React.FC<{ initialData?: object }> = ({ initialData }) => {
    const defaultJson = '{\\\\n  "id": "devcore-001",\\\\n  "active": true,\\\\n  "features": [\\\\n    "ai-explainer",\\\\n    "api-tester"\\\\n  ],\\\\n  "config": {\\\\n    "theme": "dark",\\\\n    "version": 1\\\\n  }\\\\n}';
    const [jsonInput, setJsonInput] = useState(initialData ? JSON.stringify(initialData, null, 2) : defaultJson);
    const [parsedData, setParsedData] = useState<any>(() => {
        try {
            return JSON.parse(jsonInput);
        } catch {
            return null;
        }
    });
    const [error, setError] = useState('');

    const parseJson = (input: string) => {
        try {
            const parsed = JSON.parse(input);
            setParsedData(parsed);
            setError('');
        } catch (e) {
            if (e instanceof Error) setError(e.message);
            setParsedData(null);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        setJsonInput(e.target.value);
        parseJson(e.target.value);
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <FileCodeIcon />
                    <span className="ml-3">JSON Tree Navigator</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your JSON data to visualize it as a collapsible tree.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col h-2/5 min-h-[200px]">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={handleInputChange}
                        className={\\\`flex-grow p-4 bg-surface border \\\${error ? 'border-red-500' : 'border-border'} rounded-md resize-y font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none\\\`}
                    />
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Tree View</label>
                    <div className="flex-grow p-4 bg-surface border border-border rounded-md overflow-y-auto font-mono text-sm">
                        {parsedData ? <JsonNode data={parsedData} nodeKey="root" isRoot /> : <div className="text-text-secondary">Enter valid JSON to view</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/LogicFlowBuilder.tsx': \`import React, { useState, useRef, useMemo, useCallback } from 'react';
import { ALL_FEATURES } from './index.ts';
import { FEATURE_TAXONOMY } from '../../services/taxonomyService.ts';
import { generatePipelineCode } from '../../services/aiService.ts';
import type { Feature } from '../../types.ts';
import { MapIcon, SparklesIcon, XMarkIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

interface Node {
    id: number;
    featureId: string;
    x: number;
    y: number;
}

interface Link {
    from: number;
    to: number;
}

const featuresMap = new Map(ALL_FEATURES.map(f => [f.id, f]));
const taxonomyMap = new Map(FEATURE_TAXONOMY.map(f => [f.id, f]));

const FeaturePaletteItem: React.FC<{ feature: Feature, onDragStart: (e: React.DragEvent, featureId: string) => void }> = ({ feature, onDragStart }) => (
    <div
        draggable
        onDragStart={e => onDragStart(e, feature.id)}
        className="p-3 rounded-md bg-gray-50 border border-border flex items-center gap-3 cursor-grab hover:bg-gray-100 transition-colors"
    >
        <div className="text-primary flex-shrink-0">{feature.icon}</div>
        <div>
            <h4 className="font-bold text-sm text-text-primary">{feature.name}</h4>
            <p className="text-xs text-text-secondary">{feature.category}</p>
        </div>
    </div>
);

const NodeComponent: React.FC<{
    node: Node;
    feature: Feature;
    onMouseDown: (e: React.MouseEvent, id: number) => void;
    onLinkStart: (e: React.MouseEvent, id: number) => void;
    onLinkEnd: (e: React.MouseEvent, id: number) => void;
}> = ({ node, feature, onMouseDown, onLinkStart, onLinkEnd }) => (
    <div
        className="absolute w-52 bg-surface rounded-lg shadow-md border-2 border-border cursor-grab active:cursor-grabbing flex flex-col"
        style={{ left: node.x, top: node.y, transform: 'translate(-50%, -50%)' }}
        onMouseDown={e => onMouseDown(e, node.id)}
        onMouseUp={e => onLinkEnd(e, node.id)}
    >
        <div className="p-2 flex items-center gap-2 border-b border-border">
            <div className="w-5 h-5 text-primary">{feature.icon}</div>
            <span className="text-sm font-semibold truncate text-text-primary">{feature.name}</span>
        </div>
        <div className="relative p-3 text-xs text-text-secondary min-h-[40px] flex items-center justify-center">
            Workflow Node
            <div
                onMouseDown={e => onLinkStart(e, node.id)}
                className="absolute right-[-9px] top-1/2 -translate-y-1/2 w-4 h-4 bg-primary rounded-full border-2 border-surface cursor-crosshair hover:scale-125 transition-transform"
                title="Drag to connect"
            />
        </div>
    </div>
);

const SVGGrid: React.FC = React.memo(() => (
    <svg width="100%" height="100%" className="absolute inset-0">
        <defs>
            <pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
                <path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(0, 0, 0, 0.05)" strokeWidth="0.5"/>
            </pattern>
            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                <rect width="50" height="50" fill="url(#smallGrid)"/>
                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0, 0, 0, 0.1)" strokeWidth="1"/>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#grid)" />
    </svg>
));

export const LogicFlowBuilder: React.FC = () => {
    const [nodes, setNodes] = useState<Node[]>([]);
    const [links, setLinks] = useState<Link[]>([]);
    const [draggingNode, setDraggingNode] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const [linking, setLinking] = useState<{ from: number; fromPos: { x: number; y: number }; toPos: { x: number; y: number } } | null>(null);
    const [generatedCode, setGeneratedCode] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);
    const canvasRef = useRef<HTMLDivElement>(null);
    
    const handleGenerateCode = useCallback(async () => {
        setIsGenerating(true);
        setGeneratedCode('');
        
        const sortedNodeIds: number[] = [];
        const inDegree = new Map<number, number>();
        nodes.forEach(node => inDegree.set(node.id, 0));
        links.forEach(link => inDegree.set(link.to, (inDegree.get(link.to) || 0) + 1));
        
        const queue = nodes.filter(node => inDegree.get(node.id) === 0).map(n => n.id);
        
        while(queue.length > 0) {
            const u = queue.shift()!;
            sortedNodeIds.push(u);
            links.filter(l => l.from === u).forEach(l => {
                inDegree.set(l.to, (inDegree.get(l.to) || 0) - 1);
                if(inDegree.get(l.to) === 0) queue.push(l.to);
            })
        }
        
        const flowDescription = sortedNodeIds.map((id, index) => {
            const node = nodes.find(n => n.id === id)!;
            const featureInfo = taxonomyMap.get(node.featureId);
            return \\\`Step \\\${index + 1}: Execute the '\\\${featureInfo?.name}' tool. Description: \\\${featureInfo?.description}. Inputs: \\\${featureInfo?.inputs}.\\\`;
        }).join('\\\\n');

        try {
            const code = await generatePipelineCode(flowDescription);
            setGeneratedCode(code);
        } catch (e) {
            setGeneratedCode(\\\`// Error generating code: \\\${e instanceof Error ? e.message : 'Unknown error'}\\\`);
        } finally {
            setIsGenerating(false);
        }

    }, [nodes, links]);

    const handleDragStart = (e: React.DragEvent, featureId: string) => {
        e.dataTransfer.setData('application/json', JSON.stringify({ featureId }));
    };

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault();
        if (!canvasRef.current) return;
        const { featureId } = JSON.parse(e.dataTransfer.getData('application/json'));
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const newNode: Node = {
            id: Date.now(),
            featureId,
            x: e.clientX - canvasRect.left,
            y: e.clientY - canvasRect.top,
        };
        setNodes(prev => [...prev, newNode]);
    };

    const handleNodeMouseDown = (e: React.MouseEvent, id: number) => {
        const node = nodes.find(n => n.id === id);
        if (!node || (e.target as HTMLElement).title === 'Drag to connect') return;
        const canvasRect = canvasRef.current!.getBoundingClientRect();
        setDraggingNode({ id, offsetX: e.clientX - canvasRect.left - node.x, offsetY: e.clientY - canvasRect.top - node.y });
    };

    const handleCanvasMouseMove = (e: React.MouseEvent) => {
        if (!canvasRef.current) return;
        const canvasRect = canvasRef.current.getBoundingClientRect();
        const mouseX = e.clientX - canvasRect.left;
        const mouseY = e.clientY - canvasRect.top;

        if (draggingNode) {
            setNodes(nodes.map(n => n.id === draggingNode.id ? { ...n, x: mouseX - draggingNode.offsetX, y: mouseY - draggingNode.offsetY } : n));
        }
        if (linking) {
            setLinking({ ...linking, toPos: { x: mouseX, y: mouseY } });
        }
    };

    const handleCanvasMouseUp = () => {
        setDraggingNode(null);
        setLinking(null);
    };

    const handleLinkStart = (e: React.MouseEvent, id: number) => {
        e.stopPropagation();
        const fromNode = nodes.find(n => n.id === id);
        if (!fromNode) return;
        setLinking({ from: id, fromPos: { x: fromNode.x, y: fromNode.y }, toPos: { x: fromNode.x, y: fromNode.y } });
    };

    const handleLinkEnd = (e: React.MouseEvent, id: number) => {
        e.stopPropagation();
        if (linking && linking.from !== id) {
            setLinks(prev => [...prev, { from: linking.from, to: id }]);
        }
        setLinking(null);
    };

    const nodePositions = useMemo(() => new Map(nodes.map(n => [n.id, { x: n.x, y: n.y }])), [nodes]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-start">
                <div>
                    <h1 className="text-3xl font-bold flex items-center"><MapIcon /><span className="ml-3">Logic Flow Builder</span></h1>
                    <p className="text-text-secondary mt-1">Visually build application logic flows and generate pipeline code.</p>
                </div>
                <button onClick={handleGenerateCode} disabled={isGenerating || nodes.length === 0} className="btn-primary flex items-center gap-2 px-4 py-2">
                    <SparklesIcon /> {isGenerating ? 'Generating...' : 'Generate Code'}
                </button>
            </header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-72 flex-shrink-0 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <h3 className="font-bold mb-3 text-lg">Features</h3>
                    <div className="flex-grow overflow-y-auto space-y-3 pr-2">
                        {ALL_FEATURES.map(feature => <FeaturePaletteItem key={feature.id} feature={feature} onDragStart={handleDragStart} />)}
                    </div>
                </aside>
                <main
                    ref={canvasRef}
                    className="flex-grow relative bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                    onDrop={handleDrop}
                    onDragOver={e => e.preventDefault()}
                    onMouseMove={handleCanvasMouseMove}
                    onMouseUp={handleCanvasMouseUp}
                    onMouseLeave={handleCanvasMouseUp}
                >
                    <SVGGrid />
                    <svg width="100%" height="100%" className="absolute inset-0 pointer-events-none">
                        {links.map((link, i) => {
                            const fromNode = nodePositions.get(link.from);
                            const toNode = nodePositions.get(link.to);
                            if (!fromNode || !toNode) return null;
                            return <line key={i} x1={fromNode.x} y1={fromNode.y} x2={toNode.x} y2={toNode.y} stroke="var(--color-primary)" strokeWidth="2" markerEnd="url(#arrow)" />;
                        })}
                        {linking && <line x1={linking.fromPos.x} y1={linking.fromPos.y} x2={linking.toPos.x} y2={linking.toPos.y} stroke="var(--color-primary)" strokeWidth="2" strokeDasharray="5,5" />}
                        <defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="var(--color-primary)" /></marker></defs>
                    </svg>
                    {nodes.map(node => {
                        const feature = featuresMap.get(node.featureId);
                        return feature ? <NodeComponent key={node.id} node={node} feature={feature} onMouseDown={handleNodeMouseDown} onLinkStart={handleLinkStart} onLinkEnd={handleLinkEnd} /> : null;
                    })}
                </main>
            </div>
            {(isGenerating || generatedCode) && (
                <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center" onClick={() => setGeneratedCode('')}>
                    <div className="w-full max-w-3xl h-3/4 bg-surface border border-border rounded-lg shadow-2xl p-6 flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Generated Pipeline Code</h2>
                            <button onClick={() => setGeneratedCode('')}><XMarkIcon/></button>
                        </div>
                        <div className="flex-grow bg-background border border-border rounded-md overflow-auto">
                            {isGenerating && !generatedCode ? <div className="flex justify-center items-center h-full"><LoadingSpinner /></div> : <MarkdownRenderer content={'\\\`\\\`\\\`javascript\\\\n' + generatedCode + '\\\\n\\\`\\\`\\\`'} />}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};\`,
  'components/features/MarkdownSlides.tsx': \`

import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';
import { marked } from 'marked';
import { PhotoIcon } from '../icons.tsx';

const exampleMarkdown = \\\`# Slide 1: Welcome

This is a slide deck generated from Markdown.

- Use standard markdown syntax
- Like lists, headers, and **bold** text.

---

# Slide 2: Features

Navigate using the buttons below.

\\\\\\\`\\\\\\\`\\\\\\\`javascript
console.log("Code blocks work too!");
\\\\\\\`\\\\\\\`\\\\\\\`

---

# Slide 3: The End

Easy to create and present.
\\\`;

export const MarkdownSlides: React.FC = () => {
    const [markdown, setMarkdown] = useState(exampleMarkdown);
    const [currentSlide, setCurrentSlide] = useState(0);
    const [slideHtml, setSlideHtml] = useState<string | TrustedHTML>('');
    const presentationRef = useRef<HTMLDivElement>(null);

    const slides = useMemo(() => markdown.split(/^-{3,}\\\\s*\\\$/m), [markdown]);

    useEffect(() => {
        const parse = async () => {
            const currentSlideContent = slides[currentSlide] || '';
            const html = await marked.parse(currentSlideContent);
            setSlideHtml(html);
        };
        parse();
    }, [slides, currentSlide]);

    const goToNext = useCallback(() => setCurrentSlide(s => Math.min(s + 1, slides.length - 1)), [slides.length]);
    const goToPrev = useCallback(() => setCurrentSlide(s => Math.max(s - 1, 0)), []);

    const handleFullscreen = () => {
        presentationRef.current?.requestFullscreen();
    };
    
    useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
            if (document.fullscreenElement === presentationRef.current) {
                if (e.key === 'ArrowRight' || e.key === ' ') goToNext();
                if (e.key === 'ArrowLeft') goToPrev();
            }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
    }, [goToNext, goToPrev]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">Markdown to Slides</span></h1>
                <p className="text-text-secondary mt-1">Write markdown, present it as a slideshow. Use '---' to separate slides.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                     <label htmlFor="md-input" className="text-sm font-medium text-text-secondary mb-2">Markdown Editor</label>
                     <textarea id="md-input" value={markdown} onChange={e => setMarkdown(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                </div>
                 <div ref={presentationRef} className="flex flex-col h-full bg-surface fullscreen:bg-background border border-border rounded-md">
                    <div className="flex-shrink-0 flex justify-end items-center p-2 border-b border-border gap-2">
                        <button onClick={handleFullscreen} className="px-3 py-1 bg-gray-100 dark:bg-slate-700 rounded-md text-xs hover:bg-gray-200 dark:hover:bg-slate-600">Fullscreen</button>
                    </div>
                    <div className="relative flex-grow flex flex-col justify-center items-center p-8 overflow-y-auto">
                        <div className="prose prose-lg max-w-none w-full" dangerouslySetInnerHTML={{ __html: slideHtml }} />
                         <button onClick={goToPrev} disabled={currentSlide === 0} className="absolute left-4 top-1/2 -translate-y-1/2 p-2 bg-gray-200/50 dark:bg-slate-700/50 rounded-full disabled:opacity-30 hover:bg-gray-300/50 dark:hover:bg-slate-600/50">◀</button>
                         <button onClick={goToNext} disabled={currentSlide === slides.length - 1} className="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-gray-200/50 dark:bg-slate-700/50 rounded-full disabled:opacity-30 hover:bg-gray-300/50 dark:hover:bg-slate-600/50">▶</button>
                         <div className="absolute bottom-4 right-4 text-xs bg-black/50 px-2 py-1 rounded-md text-white">
                            {currentSlide + 1} / {slides.length}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/MetaTagEditor.tsx': \`import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon } from '../icons.tsx';

interface MetaData {
    title: string;
    description: string;
    image: string;
    url: string;
}

const SocialCardPreview: React.FC<{ meta: MetaData }> = ({ meta }) => (
    <div className="w-full max-w-md mx-auto bg-surface border border-border rounded-2xl overflow-hidden shadow-lg">
        <div className="h-52 bg-gray-100 flex items-center justify-center">
            {meta.image ? <img src={meta.image} alt="Preview" className="w-full h-full object-cover" onError={(e) => e.currentTarget.style.display='none'}/> : <span className="text-text-secondary">Image Preview</span>}
        </div>
        <div className="p-4">
            <p className="text-xs text-text-secondary truncate">{new URL(meta.url || 'https://example.com').hostname}</p>
            <h3 className="font-bold text-text-primary truncate mt-1">{meta.title || 'Your Title Here'}</h3>
            <p className="text-sm text-text-secondary mt-1 line-clamp-2">{meta.description || 'A concise description of your content will appear here.'}</p>
        </div>
    </div>
);

export const MetaTagEditor: React.FC = () => {
    const [meta, setMeta] = useState<MetaData>({
        title: 'DevCore AI Toolkit', description: 'The ultimate toolkit for modern developers, powered by Gemini.',
        image: 'https://storage.googleapis.com/maker-studio-project-images-prod/programming_power_on_a_laptop_3a8f0bb1_39a9_4c2b_81f0_a74551480f2c.png',
        url: 'https://devcore.example.com'
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        setMeta({ ...meta, [e.target.name]: e.target.value });
    };

    const generatedHtml = useMemo(() => {
        return \\\`<!-- Primary Meta Tags -->
<title>\\\${meta.title}</title>
<meta name="title" content="\\\${meta.title}" />
<meta name="description" content="\\\${meta.description}" />
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="\\\${meta.url}" />
<meta property="og:title" content="\\\${meta.title}" />
<meta property="og:description" content="\\\${meta.description}" />
<meta property="og:image" content="\\\${meta.image}" />
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="\\\${meta.url}" />
<meta property="twitter:title" content="\\\${meta.title}" />
<meta property="twitter:description" content="\\\${meta.description}" />
<meta property="twitter:image" content="\\\${meta.image}" />\\\`;
    }, [meta]);
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">Meta Tag Editor</span></h1><p className="text-text-secondary mt-1">Generate SEO & social media meta tags with a live preview.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 min-h-0">
                <div className="xl:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Metadata</h3>
                    <div><label className="block text-sm">Title</label><input type="text" name="title" value={meta.title} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Description</label><input type="text" name="description" value={meta.description} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Canonical URL</label><input type="text" name="url" value={meta.url} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Social Image URL</label><input type="text" name="image" value={meta.image} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                </div>
                <div className="xl:col-span-1 flex flex-col">
                     <label className="text-sm font-medium text-text-secondary mb-2">Generated HTML</label>
                     <div className="relative flex-grow"><pre className="w-full h-full bg-background p-4 rounded-md text-primary text-sm overflow-auto">{generatedHtml}</pre><button onClick={() => navigator.clipboard.writeText(generatedHtml)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                </div>
                 <div className="hidden xl:flex flex-col items-center justify-center">
                    <label className="text-sm font-medium text-text-secondary mb-2">Live Preview</label>
                    <SocialCardPreview meta={meta} />
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/NetworkVisualizer.tsx': \`import React, { useState, useEffect, useMemo } from 'react';
import { ChartBarIcon } from '../icons.tsx';

type SortKey = 'name' | 'initiatorType' | 'transferSize' | 'duration';
type SortDirection = 'asc' | 'desc';

const SummaryCard: React.FC<{ title: string, value: string | number }> = ({ title, value }) => (
    <div className="bg-surface border border-border p-3 rounded-lg text-center">
        <p className="text-xs text-text-secondary">{title}</p>
        <p className="text-xl font-bold text-text-primary">{value}</p>
    </div>
);

export const NetworkVisualizer: React.FC = () => {
    const [requests, setRequests] = useState<PerformanceResourceTiming[]>([]);
    const [sortKey, setSortKey] = useState<SortKey>('duration');
    const [sortDirection, setSortDirection] = useState<SortDirection>('desc');

    useEffect(() => {
        const entries = performance.getEntriesByType("resource") as PerformanceResourceTiming[];
        setRequests(entries);
    }, []);
    
    const sortedRequests = useMemo(() => {
        return [...requests].sort((a, b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
    }, [requests, sortKey, sortDirection]);

    const { totalSize, totalDuration, maxDuration } = useMemo(() => {
        const totalSize = requests.reduce((acc, req) => acc + req.transferSize, 0);
        const maxFinish = Math.max(...requests.map(r => r.startTime + r.duration), 0);
        return { totalSize, totalDuration: maxFinish, maxDuration: Math.max(...requests.map(r => r.duration), 0) };
    }, [requests]);

    const handleSort = (key: SortKey) => {
        setSortDirection(sortKey === key && sortDirection === 'desc' ? 'asc' : 'desc');
        setSortKey(key);
    };
    
    const formatBytes = (bytes: number) => {
        if (bytes === 0) return '0 B';
        const k = 1024; const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    };

    const SortableHeader: React.FC<{ skey: SortKey, label: string; className?: string }> = ({ skey, label, className }) => (
        <th onClick={() => handleSort(skey)} className={\\\`p-2 text-left cursor-pointer hover:bg-gray-100 \\\${className}\\\`}>
            {label} {sortKey === skey && (sortDirection === 'asc' ? '▲' : '▼')}
        </th>
    );

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><ChartBarIcon /><span className="ml-3">Network Visualizer</span></h1><p className="text-text-secondary mt-1">Inspect network resources with a summary and waterfall chart.</p></header>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <SummaryCard title="Total Requests" value={requests.length} />
                <SummaryCard title="Total Transferred" value={formatBytes(totalSize)} />
                <SummaryCard title="Finish Time" value={\\\`\\\${totalDuration.toFixed(0)}ms\\\`} />
                <SummaryCard title="Longest Request" value={\\\`\\\${maxDuration.toFixed(0)}ms\\\`} />
            </div>
            <div className="flex-grow overflow-auto bg-surface rounded-lg border border-border">
                <table className="w-full text-sm text-left table-fixed">
                    <thead className="sticky top-0 bg-surface z-10"><tr className="border-b border-border">
                        <SortableHeader skey="name" label="Name" className="w-2/5"/>
                        <SortableHeader skey="initiatorType" label="Type" className="w-1/5" />
                        <SortableHeader skey="transferSize" label="Size" className="w-1/5"/>
                        <SortableHeader skey="duration" label="Time / Waterfall" className="w-1/5"/>
                    </tr></thead>
                    <tbody>{sortedRequests.map((req, i) => (<tr key={i} className="border-b border-border hover:bg-gray-50">
                        <td className="p-2 text-primary truncate" title={req.name}>{req.name.split('/').pop()}</td>
                        <td className="p-2">{req.initiatorType}</td>
                        <td className="p-2">{formatBytes(req.transferSize)}</td>
                        <td className="p-2"><div className="flex items-center">
                            <span className="w-12">{req.duration.toFixed(0)}ms</span>
                            <div className="flex-grow h-4 bg-gray-200 rounded overflow-hidden">
                                <div className="h-4 bg-primary rounded" style={{ marginLeft: \\\`\\\${(req.startTime / totalDuration) * 100}%\\\`, width: \\\`\\\${(req.duration / totalDuration) * 100}%\\\` }} title={\\\`Start: \\\${req.startTime.toFixed(0)}ms\\\`}></div>
                            </div>
                        </div></td>
                    </tr>))}</tbody>
                </table>
            </div>
        </div>
    );
};\`,
  'components/features/OneClickRefactor.tsx': \`import React, { useState, useCallback } from 'react';
import * as Diff from 'diff';
import { applySpecificRefactor, refactorForPerformance, refactorForReadability, generateJsDoc, convertToFunctionalComponent } from '../../services/aiService.ts';
import { SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

type RefactorAction = 'readability' | 'performance' | 'jsdoc' | 'functional' | 'custom';

const exampleCode = \\\`const MyComponent = ({ data }) => {
  // A less readable component
  let transformedData = [];
  for (let i = 0; i < data.length; i++) {
    if (data[i].value > 50) {
      let item = { ...data[i], status: 'high' };
      transformedData.push(item);
    }
  }
  return (
    <div>
      {transformedData.map(d => <p key={d.id}>{d.name}</p>)}
    </div>
  );
}\\\`;

const DiffViewer: React.FC<{ oldCode: string, newCode: string }> = ({ oldCode, newCode }) => {
    const diff = Diff.diffLines(oldCode, newCode);

    return (
        <pre className="whitespace-pre-wrap font-mono text-xs">
            {diff.map((part, index) => {
                const color = part.added ? 'bg-green-500/20' : part.removed ? 'bg-red-500/20' : 'bg-transparent';
                return <div key={index} className={color}>{part.value}</div>;
            })}
        </pre>
    );
};


export const OneClickRefactor: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [refactoredCode, setRefactoredCode] = useState('');
    const [loadingAction, setLoadingAction] = useState<RefactorAction | null>(null);

    const handleRefactor = useCallback(async (action: RefactorAction) => {
        if (!code.trim()) return;
        setLoadingAction(action);
        setRefactoredCode('');

        let stream;
        switch(action) {
            case 'readability':
                stream = refactorForReadability(code);
                break;
            case 'performance':
                stream = refactorForPerformance(code);
                break;
            case 'jsdoc':
                stream = generateJsDoc(code);
                break;
            case 'functional':
                stream = convertToFunctionalComponent(code);
                break;
            default:
                setLoadingAction(null);
                return;
        }

        try {
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setRefactoredCode(fullResponse.replace(/^\\\`\\\`\\\`(?:\\\\w+\\\\n)?/, '').replace(/\\\`\\\`\\\`\\\$/, ''));
            }
        } catch (e) {
            console.error(e);
            setRefactoredCode(\\\`// Error during refactoring: \\\${e instanceof Error ? e.message : 'Unknown error'}\\\`);
        } finally {
            setLoadingAction(null);
        }
    }, [code]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <SparklesIcon />
                    <span className="ml-3">One-Click Refactor</span>
                </h1>
                <p className="text-text-secondary mt-1">Apply common refactoring patterns to your code with a single click.</p>
            </header>
            <div className="flex items-center justify-center flex-wrap gap-2 mb-4 p-4 bg-surface rounded-lg border border-border">
                <button onClick={() => handleRefactor('readability')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'readability' ? <LoadingSpinner/> : 'Improve Readability'}</button>
                <button onClick={() => handleRefactor('performance')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'performance' ? <LoadingSpinner/> : 'Boost Performance'}</button>
                <button onClick={() => handleRefactor('jsdoc')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'jsdoc' ? <LoadingSpinner/> : 'Add JSDoc'}</button>
                <button onClick={() => handleRefactor('functional')} disabled={!!loadingAction} className="btn-primary px-3 py-1.5 text-sm">{loadingAction === 'functional' ? <LoadingSpinner/> : 'To Functional Component'}</button>
            </div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Original Code</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                </div>
                 <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Refactored Code</label>
                    <div className="flex-grow p-2 bg-background border rounded overflow-auto">
                        {loadingAction ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : <DiffViewer oldCode={code} newCode={refactoredCode} />}
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/PerformanceProfiler.tsx': \`import React, { useState, useCallback } from 'react';
import { analyzePerformanceTrace } from '../../services/index.ts';
import { startTracing, stopTracing, TraceEntry } from '../../services/profiling/performanceService.ts';
import { parseViteStats, BundleStatsNode } from '../../services/profiling/bundleAnalyzer.ts';
import { ChartBarIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const FlameChart: React.FC<{ trace: TraceEntry[] }> = ({ trace }) => {
    if (trace.length === 0) return <p className="text-text-secondary">No trace data collected.</p>;
    const maxTime = Math.max(...trace.map(t => t.startTime + t.duration));
    return (
        <div className="space-y-1 font-mono text-xs">
            {trace.filter(t => t.entryType === 'measure').map((entry, i) => (
                <div key={i} className="group relative h-6 bg-primary/20 rounded">
                    <div className="h-full bg-primary" style={{ marginLeft: \\\`\\\${(entry.startTime / maxTime) * 100}%\\\`, width: \\\`\\\${(entry.duration / maxTime) * 100}%\\\` }}></div>
                    <div className="absolute inset-0 px-2 flex items-center text-primary font-bold">{entry.name} ({entry.duration.toFixed(1)}ms)</div>
                </div>
            ))}
        </div>
    );
};

export const PerformanceProfiler: React.FC = () => {
    const [activeTab, setActiveTab] = useState<'runtime' | 'bundle'>('runtime');
    const [isTracing, setIsTracing] = useState(false);
    const [trace, setTrace] = useState<TraceEntry[]>([]);
    const [bundleStats, setBundleStats] = useState<string>('');
    const [bundleTree, setBundleTree] = useState<BundleStatsNode | null>(null);
    const [isLoadingAi, setIsLoadingAi] = useState(false);
    const [aiAnalysis, setAiAnalysis] = useState('');

    const handleTraceToggle = () => {
        if (isTracing) {
            const collectedTrace = stopTracing();
            setTrace(collectedTrace);
            setIsTracing(false);
        } else {
            setTrace([]);
            startTracing();
            setIsTracing(true);
        }
    };

    const handleAnalyzeBundle = () => {
        try {
            setBundleTree(parseViteStats(bundleStats));
        } catch (e) {
            alert(e instanceof Error ? e.message : 'Parsing failed.');
        }
    };
    
    const handleAiAnalysis = async () => {
        const dataToAnalyze = activeTab === 'runtime' ? trace : bundleTree;
        if (!dataToAnalyze || (Array.isArray(dataToAnalyze) && dataToAnalyze.length === 0)) {
            alert('No data to analyze.');
            return;
        }
        setIsLoadingAi(true);
        setAiAnalysis('');
        try {
            const analysis = await analyzePerformanceTrace(dataToAnalyze);
            setAiAnalysis(analysis);
        } catch (e) {
            setAiAnalysis('Error getting analysis from AI.');
        } finally {
            setIsLoadingAi(false);
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><ChartBarIcon /><span className="ml-3">AI Performance Profiler</span></h1><p className="text-text-secondary mt-1">Analyze runtime performance and bundle sizes with AI insights.</p></header>
            <div className="flex border-b border-border mb-4"><button onClick={() => setActiveTab('runtime')} className={\\\`px-4 py-2 text-sm \\\${activeTab === 'runtime' ? 'border-b-2 border-primary' : ''}\\\`}>Runtime Performance</button><button onClick={() => setActiveTab('bundle')} className={\\\`px-4 py-2 text-sm \\\${activeTab === 'bundle' ? 'border-b-2 border-primary' : ''}\\\`}>Bundle Analysis</button></div>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    {activeTab === 'runtime' ? (
                        <>
                            <button onClick={handleTraceToggle} className="btn-primary mb-4 py-2">{isTracing ? 'Stop Tracing' : 'Start Tracing'}</button>
                            <div className="flex-grow overflow-y-auto"><FlameChart trace={trace} /></div>
                        </>
                    ) : (
                         <>
                            <textarea value={bundleStats} onChange={e => setBundleStats(e.target.value)} placeholder="Paste your stats.json content here" className="w-full h-48 p-2 bg-background border rounded font-mono text-xs mb-2"/>
                            <button onClick={handleAnalyzeBundle} className="btn-primary py-2">Analyze Bundle</button>
                            <div className="flex-grow overflow-y-auto mt-2">
                                <pre className="text-xs">{bundleTree ? JSON.stringify(bundleTree, null, 2) : 'Analysis will appear here.'}</pre>
                            </div>
                        </>
                    )}
                </div>
                 <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <button onClick={handleAiAnalysis} disabled={isLoadingAi} className="btn-primary flex items-center justify-center gap-2 py-2 mb-4"><SparklesIcon />{isLoadingAi ? 'Analyzing...' : 'Get AI Optimization Suggestions'}</button>
                    <div className="flex-grow bg-background border border-border rounded p-2 overflow-y-auto">
                        {isLoadingAi ? <div className="flex justify-center items-center h-full"><LoadingSpinner/></div> : <MarkdownRenderer content={aiAnalysis} />}
                    </div>
                 </div>
            </div>
        </div>
    );
};\`,
  'components/features/PrGenerator.tsx': \`// This feature is an alias for the more comprehensively named AiPullRequestAssistant.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { AiPullRequestAssistant as PrGenerator } from './AiPullRequestAssistant.tsx';\`,
  'components/features/PrSummaryGenerator.tsx': \`// This feature is an alias for the more comprehensively named AiPullRequestAssistant.
// Re-exporting it here to keep the codebase DRY while satisfying the feature registry.
export { AiPullRequestAssistant as PrSummaryGenerator } from './AiPullRequestAssistant.tsx';\`,
  'components/features/ProjectExplorer.tsx': \`import React, { useState, useEffect, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useOctokit } from '../../contexts/OctokitContext.tsx';
import { getRepos, getRepoTree, getFileContent, commitFiles } from '../../services/githubService.ts';
import { generateCommitMessageStream } from '../../services/index.ts';
import type { Repo, FileNode } from '../../types.ts';
import { FolderIcon, DocumentIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import * as Diff from 'diff';

const FileTree: React.FC<{ node: FileNode, onFileSelect: (path: string, name: string) => void, activePath: string | null }> = ({ node, onFileSelect, activePath }) => {
    const [isOpen, setIsOpen] = useState(true);

    if (node.type === 'file') {
        const isActive = activePath === node.path;
        return (
            <div
                className={\\\`flex items-center space-x-2 pl-4 py-1 cursor-pointer rounded \\\${isActive ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\\\`}
                onClick={() => onFileSelect(node.path, node.name)}
            >
                <DocumentIcon />
                <span>{node.name}</span>
            </div>
        );
    }

    return (
        <div>
            <div
                className="flex items-center space-x-2 py-1 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 rounded"
                onClick={() => setIsOpen(!isOpen)}
            >
                <div className={\\\`transform transition-transform \\\${isOpen ? 'rotate-90' : ''}\\\`}>▶</div>
                <FolderIcon />
                <span className="font-semibold">{node.name}</span>
            </div>
            {isOpen && node.children && (
                <div className="pl-4 border-l border-border ml-3">
                    {node.children.map(child => <FileTree key={child.path} node={child} onFileSelect={onFileSelect} activePath={activePath} />)}
                </div>
            )}
        </div>
    );
};

export const ProjectExplorer: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, selectedRepo, projectFiles } = state;
    const { addNotification } = useNotification();
    const { octokit, reinitialize } = useOctokit();
    const [repos, setRepos] = useState<Repo[]>([]);
    const [isLoading, setIsLoading] = useState<'repos' | 'tree' | 'file' | 'commit' | null>(null);
    const [error, setError] = useState('');
    const [activeFile, setActiveFile] = useState<{ path: string; name: string; originalContent: string; editedContent: string} | null>(null);
    
    const handleApiError = useCallback((err: any) => {
        if (err.status === 401) {
            dispatch({ type: 'SET_GITHUB_USER', payload: null });
            addNotification('GitHub token is invalid or expired. Please update it in the Connections Hub.', 'error');
            setError('GitHub authentication failed. Please update your token.');
        } else {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
        }
    }, [dispatch, addNotification]);
    
    useEffect(() => {
        if (!octokit && githubUser) {
            reinitialize();
        }
    }, [octokit, githubUser, reinitialize]);

    useEffect(() => {
        const loadRepos = async () => {
            if (user && githubUser && octokit) {
                setIsLoading('repos');
                setError('');
                try {
                    const userRepos = await getRepos(octokit);
                    setRepos(userRepos);
                } catch (err) {
                    handleApiError(err);
                } finally {
                    setIsLoading(null);
                }
            } else {
                setRepos([]);
            }
        };
        loadRepos();
    }, [user, githubUser, octokit, handleApiError]);

    const loadTree = useCallback(async (repoToLoad: { owner: { login: string }, name: string, full_name: string }) => {
        if (user && githubUser && octokit) {
            setIsLoading('tree');
            setError('');
            setActiveFile(null);
            try {
                const tree = await getRepoTree(octokit, repoToLoad.owner.login, repoToLoad.name);
                dispatch({ type: 'LOAD_PROJECT_FILES', payload: tree });
            } catch (err) {
                handleApiError(err);
            } finally {
                setIsLoading(null);
            }
        }
    }, [user, githubUser, octokit, dispatch, handleApiError]);

    // Re-fetches the tree if a repo is selected from a previous session
    useEffect(() => {
        if (selectedRepo && octokit && (!projectFiles || projectFiles.name !== selectedRepo.repo)) {
             loadTree({
                name: selectedRepo.repo,
                full_name: selectedRepo.full_name,
                owner: { login: selectedRepo.owner }
            });
        }
    }, [selectedRepo, projectFiles, octokit, loadTree]);

    const handleFileSelect = async (path: string, name: string) => {
        if (!selectedRepo || !octokit) return;
        setIsLoading('file');
        try {
            const content = await getFileContent(octokit, selectedRepo.owner, selectedRepo.repo, path);
            setActiveFile({ path, name, originalContent: content, editedContent: content });
        } catch (err) {
            handleApiError(err);
        } finally {
            setIsLoading(null);
        }
    };

    const handleCommit = async () => {
        if (!activeFile || !selectedRepo || !octokit || activeFile.originalContent === activeFile.editedContent) return;

        setIsLoading('commit');
        setError('');
        try {
            const diff = Diff.createPatch(activeFile.path, activeFile.originalContent, activeFile.editedContent);
            
            const stream = generateCommitMessageStream(diff);
            let commitMessage = '';
            for await (const chunk of stream) { commitMessage += chunk; }
            
            const finalMessage = window.prompt("Confirm or edit commit message:", commitMessage);
            if (!finalMessage) {
                setIsLoading(null);
                return;
            }

            await commitFiles(
                octokit,
                selectedRepo.owner,
                selectedRepo.repo,
                [{ path: activeFile.path, content: activeFile.editedContent }],
                finalMessage
            );
            
            addNotification(\\\`Successfully committed to \\\${selectedRepo.repo}\\\`, 'success');
            setActiveFile(prev => prev ? { ...prev, originalContent: prev.editedContent } : null);

        } catch (err) {
            handleApiError(err);
        } finally {
            setIsLoading(null);
        }
    };
    
    if (!user) {
        return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Please Sign In</h2>
                <p>Sign in to explore your repositories.</p>
            </div>
        );
    }
    
    if (!githubUser) {
         return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Connect to GitHub</h2>
                <p>Please go to the "Connections" tab and provide a Personal Access Token to explore your repositories.</p>
            </div>
        );
    }

    const hasChanges = activeFile ? activeFile.originalContent !== activeFile.editedContent : false;

    return (
        <div className="h-full flex flex-col text-text-primary">
            <header className="p-4 border-b border-border flex-shrink-0">
                <h1 className="text-xl font-bold flex items-center"><FolderIcon /><span className="ml-3">Project Explorer</span></h1>
                <div className="mt-2">
                    <select
                        value={selectedRepo?.full_name ?? ''}
                        onChange={e => {
                            const repo = repos.find(r => r.full_name === e.target.value);
                            if (repo) {
                                dispatch({ type: 'SET_SELECTED_REPO', payload: { owner: repo.owner.login, repo: repo.name, full_name: repo.full_name, name: repo.name } });
                            }
                        }}
                        className="w-full p-2 bg-surface border border-border rounded-md text-sm"
                    >
                        <option value="" disabled>{isLoading === 'repos' ? 'Loading...' : 'Select a repository'}</option>
                        {repos.map(r => <option key={r.id} value={r.full_name}>{r.full_name}</option>)}
                    </select>
                </div>
                {error && <p className="text-red-500 text-xs mt-2">{error}</p>}
            </header>
            <div className="flex-grow flex min-h-0">
                <aside className="w-1/3 bg-background border-r border-border p-4 overflow-y-auto">
                    {isLoading === 'tree' && <div className="flex justify-center"><LoadingSpinner /></div>}
                    {projectFiles && <FileTree node={projectFiles} onFileSelect={handleFileSelect} activePath={activeFile?.path ?? null} />}
                </aside>
                <main className="flex-1 bg-surface flex flex-col">
                     <div className="flex justify-between items-center p-2 border-b border-border bg-gray-50 dark:bg-slate-800">
                        <span className="text-sm font-semibold">{activeFile?.name || 'No file selected'}</span>
                        <button onClick={handleCommit} disabled={!hasChanges || isLoading === 'commit'} className="btn-primary px-4 py-1 text-sm flex items-center justify-center min-w-[100px]">
                           {isLoading === 'commit' ? <LoadingSpinner/> : 'Commit'}
                        </button>
                     </div>
                     {isLoading === 'file' ? <div className="flex items-center justify-center h-full"><LoadingSpinner /></div> :
                        <textarea 
                            value={activeFile?.editedContent ?? 'Select a file to view its content.'}
                            onChange={e => setActiveFile(prev => prev ? { ...prev, editedContent: e.target.value } : null)}
                            disabled={!activeFile}
                            className="w-full h-full p-4 text-sm font-mono bg-transparent resize-none focus:outline-none"
                        />
                    }
                </main>
            </div>
        </div>
    );
};\`,
  'components/features/ProjectMoodboard.tsx': \`import React, { useState } from 'react';
import { PhotoIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';

interface MoodboardItem {
    id: number;
    text: string;
    x: number;
    y: number;
    color: string;
}

const colors = ['bg-yellow-200', 'bg-green-200', 'bg-blue-200', 'bg-pink-200', 'bg-purple-200', 'bg-orange-200'];
const textColors = ['text-yellow-800', 'text-green-800', 'text-blue-800', 'text-pink-800', 'text-purple-800', 'text-orange-800'];

export const ProjectMoodboard: React.FC = () => {
    const [items, setItems] = useLocalStorage<MoodboardItem[]>('devcore_moodboard_items', []);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);

    const addItem = () => {
        const newItem: MoodboardItem = {
            id: Date.now(),
            text: 'New Idea',
            x: 50,
            y: 50,
            color: colors[items.length % colors.length],
        };
        setItems([...items, newItem]);
    };
    
    const deleteItem = (id: number, e: React.MouseEvent) => {
        e.stopPropagation();
        setItems(items.filter((n) => n.id !== id));
    };

    const updateItem = (id: number, updates: Partial<MoodboardItem>) => {
        setItems(items.map((n) => n.id === id ? { ...n, ...updates } : n));
    };

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        if ((e.target as HTMLElement).tagName === 'TEXTAREA') return;
        const noteElement = e.currentTarget;
        const rect = noteElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging) return;
        const boardRect = e.currentTarget.getBoundingClientRect();
        updateItem(dragging.id, {
            x: e.clientX - dragging.offsetX - boardRect.left,
            y: e.clientY - dragging.offsetY - boardRect.top
        });
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6 flex justify-between items-center">
                 <div>
                    <h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">Project Moodboard</span></h1>
                    <p className="text-text-secondary mt-1">A visual space to gather ideas, images, and notes.</p>
                </div>
                <button onClick={addItem} className="btn-primary px-6 py-2">Add Item</button>
            </header>
            <div
                className="relative flex-grow bg-background border-2 border-dashed border-border rounded-lg overflow-hidden"
                onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}
            >
                {items.map((item) => (
                    <div
                        key={item.id}
                        className={\\\`group absolute w-48 h-48 p-2 flex flex-col shadow-lg cursor-grab active:cursor-grabbing rounded-md transition-transform duration-100 border border-black/20 \\\${item.color} \\\${textColors[colors.indexOf(item.color)]}\\\`}
                        style={{ top: item.y, left: item.x, transform: dragging?.id === item.id ? 'scale(1.05)' : 'scale(1)' }}
                        onMouseDown={e => onMouseDown(e, item.id)}
                    >
                        <button onClick={(e) => deleteItem(item.id, e)} className="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-gray-700 text-white font-bold text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 hover:bg-red-500 transition-all">&times;</button>
                        <textarea
                            value={item.text}
                            onChange={(e) => updateItem(item.id, { text: e.target.value })}
                            className="w-full h-full bg-transparent resize-none focus:outline-none font-medium p-1"
                        />
                    </div>
                ))}
            </div>
        </div>
    );
};\`,
  'components/features/PromptCraftPad.tsx': \`import React, { useState, useEffect, useMemo } from 'react';
import { SparklesIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';

interface Prompt {
    id: number;
    name: string;
    text: string;
}

export const PromptCraftPad: React.FC = () => {
    const [prompts, setPrompts] = useLocalStorage<Prompt[]>('devcore_prompts', [
        { id: 1, name: 'React Component Generator', text: 'Generate a React component named {name} that {description}. Style it with Tailwind CSS.'}
    ]);
    const [activePrompt, setActivePrompt] = useState<Prompt | null>(prompts[0] || null);
    const [editingId, setEditingId] = useState<number | null>(null);
    const [tempName, setTempName] = useState('');
    const [variables, setVariables] = useState<Record<string, string>>({});

    const variableNames = useMemo(() => {
        if (!activePrompt) return [];
        return [...activePrompt.text.matchAll(/\\\\{(\\\\w+)\\\\}/g)].map(match => match[1]);
    }, [activePrompt]);

    const renderedPrompt = useMemo(() => {
        if (!activePrompt) return '';
        return variableNames.reduce((acc, varName) => {
            return acc.replace(new RegExp(\\\`\\\\\\\\{\\\${varName}\\\\\\\\}\\\`, 'g'), variables[varName] || \\\`{\\\${varName}}\\\`);
        }, activePrompt.text);
    }, [activePrompt, variables, variableNames]);
    
    useEffect(() => {
        if(!activePrompt && prompts.length > 0) setActivePrompt(prompts[0]);
        if (activePrompt) setActivePrompt(prompts.find((p: Prompt) => p.id === activePrompt.id) || null);
    }, [prompts, activePrompt]);

    const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        if (!activePrompt) return;
        const updatedPrompt = { ...activePrompt, text: e.target.value };
        setPrompts(prompts.map((p: Prompt) => p.id === updatedPrompt.id ? updatedPrompt : p));
    };
    
    const handleNameUpdate = (id: number, newName: string) => {
        setPrompts(prompts.map((p: Prompt) => p.id === id ? {...p, name: newName} : p));
        setEditingId(null);
    };

    const handleAddNew = () => {
        const newPrompt = { id: Date.now(), name: 'New Untitled Prompt', text: '' };
        setPrompts([...prompts, newPrompt]);
        setActivePrompt(newPrompt);
    };
    
    const handleDelete = (id: number) => {
        setPrompts(prompts.filter((p: Prompt) => p.id !== id));
        if(activePrompt?.id === id) setActivePrompt(prompts.length > 1 ? prompts[0] : null);
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><SparklesIcon /><span className="ml-3">Prompt Craft Pad</span></h1><p className="text-text-secondary mt-1">Create, save, and manage your favorite AI prompts.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-1/3 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <h3 className="font-bold mb-2">My Prompts</h3>
                    <ul className="space-y-2 flex-grow overflow-y-auto">{prompts.map((p: Prompt) => (<li key={p.id} className="group flex items-center justify-between"><div className={\\\`w-full text-left rounded-md \\\${activePrompt?.id === p.id ? 'bg-primary/10' : ''}\\\`}><button onClick={() => setActivePrompt(p)} onDoubleClick={() => {setEditingId(p.id); setTempName(p.name);}} className={\\\`w-full text-left px-3 py-2 \\\${activePrompt?.id === p.id ? 'text-primary' : 'hover:bg-gray-100'}\\\`}> {editingId === p.id ? <input autoFocus value={tempName} onChange={e => setTempName(e.target.value)} onBlur={() => handleNameUpdate(p.id, tempName)} onKeyDown={e => e.key === 'Enter' && handleNameUpdate(p.id, tempName)} className="bg-gray-100 text-text-primary w-full"/> : p.name} </button></div><button onClick={() => handleDelete(p.id)} className="ml-2 p-1 text-text-secondary hover:text-red-500 opacity-0 group-hover:opacity-100">&times;</button></li>))}</ul>
                    <div className="mt-4 pt-4 border-t border-border"><button onClick={handleAddNew} className="btn-primary w-full text-sm py-2">Add New Prompt</button></div>
                </aside>
                <main className="w-2/3 flex flex-col gap-4">
                    {activePrompt ? (<>
                        <textarea value={activePrompt.text} onChange={handleTextChange} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                        {variableNames.length > 0 && <div className="flex-shrink-0 bg-surface border border-border p-4 rounded-lg"><h4 className="font-bold mb-2">Test Variables</h4><div className="grid grid-cols-2 gap-2">{variableNames.map(v => (<div key={v}><label className="text-xs">{v}</label><input type="text" value={variables[v] || ''} onChange={e => setVariables({...variables, [v]: e.target.value})} className="w-full bg-background border border-border px-2 py-1 rounded text-sm"/></div>))}</div><h4 className="font-bold mt-4 mb-2">Live Preview</h4><p className="text-sm p-2 bg-background rounded border border-border">{renderedPrompt}</p></div>}
                    </>) : (<div className="flex-grow flex items-center justify-center bg-background rounded-lg text-text-secondary border border-border">Select a prompt or create a new one.</div>)}
                </main>
            </div>
        </div>
    );
};\`,
  'components/features/PwaManifestEditor.tsx': \`import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

interface ManifestData {
    name: string;
    short_name: string;
    start_url: string;
    scope: string;
    display: 'standalone' | 'fullscreen' | 'minimal-ui' | 'browser';
    orientation: 'any' | 'natural' | 'landscape' | 'portrait';
    background_color: string;
    theme_color: string;
}

const HomeScreenPreview: React.FC<{ manifest: ManifestData }> = ({ manifest }) => (
    <div className="w-full max-w-xs mx-auto flex flex-col items-center">
        <div className="w-72 h-[550px] bg-gray-800 rounded-[40px] border-[10px] border-black shadow-2xl p-4 flex flex-col">
            <div className="flex-shrink-0 h-6 flex justify-between items-center px-4">
                <span className="text-xs font-bold" style={{color: manifest.theme_color}}>9:41</span>
                <div className="w-16 h-4 bg-black rounded-full" />
                <span className="text-xs font-bold" style={{color: manifest.theme_color}}>100%</span>
            </div>
            <div className="flex-grow grid grid-cols-4 gap-4 p-4">
                <div className="flex flex-col items-center gap-1">
                    <div className="w-14 h-14 bg-white rounded-xl flex items-center justify-center text-3xl" style={{backgroundColor: manifest.background_color}}>
                        <span style={{color: manifest.theme_color}}>{manifest.short_name[0]}</span>
                    </div>
                    <p className="text-xs text-center text-white truncate w-full">{manifest.short_name}</p>
                </div>
            </div>
        </div>
         <p className="text-xs text-text-secondary mt-2 text-center">Home Screen Preview</p>
    </div>
);


export const PwaManifestEditor: React.FC = () => {
    const [manifest, setManifest] = useState<ManifestData>({
        name: 'DevCore Progressive Web App', short_name: 'DevCore', start_url: '/', scope: '/',
        display: 'standalone', orientation: 'any', background_color: '#F5F7FA', theme_color: '#0047AB',
    });

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        setManifest({ ...manifest, [e.target.name]: e.target.value });
    };

    const generatedJson = useMemo(() => {
        const fullManifest = { ...manifest, icons: [{"src": "icon-192.png", "type": "image/png", "sizes": "192x192"}, {"src": "icon-512.png", "type": "image/png", "sizes": "512x512"}] };
        return JSON.stringify(fullManifest, null, 2);
    }, [manifest]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">PWA Manifest Editor</span></h1><p className="text-text-secondary mt-1">Configure and generate the \\\`manifest.json\\\` file for your PWA.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 min-h-0">
                <div className="xl:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Configuration</h3>
                    <div><label className="block text-sm">App Name</label><input type="text" name="name" value={manifest.name} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Short Name</label><input type="text" name="short_name" value={manifest.short_name} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Start URL</label><input type="text" name="start_url" value={manifest.start_url} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Scope</label><input type="text" name="scope" value={manifest.scope} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"/></div>
                    <div><label className="block text-sm">Display Mode</label><select name="display" value={manifest.display} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"><option>standalone</option><option>fullscreen</option><option>minimal-ui</option><option>browser</option></select></div>
                    <div><label className="block text-sm">Orientation</label><select name="orientation" value={manifest.orientation} onChange={handleChange} className="w-full mt-1 p-2 rounded bg-background border border-border"><option>any</option><option>natural</option><option>landscape</option><option>portrait</option></select></div>
                     <div className="flex gap-4">
                        <div className="w-1/2"><label className="block text-sm">Background Color</label><input type="color" name="background_color" value={manifest.background_color} onChange={handleChange} className="w-full mt-1 h-10 rounded bg-background border border-border"/></div>
                        <div className="w-1/2"><label className="block text-sm">Theme Color</label><input type="color" name="theme_color" value={manifest.theme_color} onChange={handleChange} className="w-full mt-1 h-10 rounded bg-background border border-border"/></div>
                     </div>
                </div>
                <div className="xl:col-span-1 flex flex-col">
                    <div className="flex justify-between items-center mb-2">
                         <label className="text-sm font-medium text-text-secondary">Generated manifest.json</label>
                         <button onClick={() => downloadFile(generatedJson, 'manifest.json', 'application/json')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download
                        </button>
                    </div>
                     <div className="relative flex-grow"><pre className="w-full h-full bg-background p-4 rounded-md text-primary text-sm overflow-auto">{generatedJson}</pre></div>
                </div>
                <div className="hidden xl:flex flex-col items-center justify-center">
                    <label className="text-sm font-medium text-text-secondary mb-2">Live Preview</label>
                    <HomeScreenPreview manifest={manifest} />
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/RegexSandbox.tsx': \`import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { generateRegExStream } from '../../services/aiService.ts';
import { BeakerIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const commonPatterns = [
    { name: 'Email', pattern: '/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\\\\\.[a-zA-Z]{2,}/g' },
    { name: 'URL', pattern: '/https?:\\\\\\\\/\\\\\\\\/(www\\\\\\\\.)?[-a-zA-Z0-9@:%._\\\\\\\\+~#=]{1,256}\\\\\\\\.[a-zA-Z0-9()]{1,6}\\\\\\\\b([-a-zA-Z0-9()@:%_\\\\\\\\+.~#?&//=]*)/g' },
    { name: 'IPv4 Address', pattern: '/((25[0-5]|(2[0-4]|1\\\\\\\\d|[1-9]|)\\\\\\\\d)\\\\\\\\.?\\\\\\\\b){4}/g' },
    { name: 'Date (YYYY-MM-DD)', pattern: '/\\\\\\\\d{4}-\\\\\\\\d{2}-\\\\\\\\d{2}/g' },
];

const CheatSheet = () => (
    <div className="bg-surface border border-border p-4 rounded-lg">
        <h3 className="text-lg font-bold mb-2">Regex Cheat Sheet</h3>
        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs font-mono">
            <p><span className="text-primary">.</span> - Any character</p>
            <p><span className="text-primary">\\\\d</span> - Any digit</p>
            <p><span className="text-primary">\\\\w</span> - Word character</p>
            <p><span className="text-primary">\\\\s</span> - Whitespace</p>
            <p><span className="text-primary">[abc]</span> - a, b, or c</p>
            <p><span className="text-primary">[^abc]</span> - Not a, b, or c</p>
            <p><span className="text-primary">*</span> - 0 or more</p>
            <p><span className="text-primary">+</span> - 1 or more</p>
            <p><span className="text-primary">?</span> - 0 or one</p>
            <p><span className="text-primary">^</span> - Start of string</p>
            <p><span className="text-primary">\\\$</span> - End of string</p>
            <p><span className="text-primary">\\\\b</span> - Word boundary</p>
        </div>
    </div>
);

export const RegexSandbox: React.FC<{ initialPrompt?: string }> = ({ initialPrompt }) => {
    const [pattern, setPattern] = useState<string>('/\\\\\\\\b([A-Z][a-z]+)\\\\\\\\s(\\\\\\\\w+)\\\\\\\\b/g');
    const [testString, setTestString] = useState<string>('The quick Brown Fox jumps over the Lazy Dog.');
    const [aiPrompt, setAiPrompt] = useState<string>(initialPrompt || 'find capitalized words and the word after');
    const [isAiLoading, setIsAiLoading] = useState<boolean>(false);

    const { matches, error } = useMemo(() => {
        try {
            const patternParts = pattern.match(/^\\\\/(.*)\\\\/([gimyus]*)\\\$/);
            if (!patternParts) return { matches: null, error: 'Invalid regex literal. Use /pattern/flags.' };
            const [, regexBody, regexFlags] = patternParts;
            const regex = new RegExp(regexBody, regexFlags);
            return { matches: [...testString.matchAll(regex)], error: null };
        } catch (e) { return { matches: null, error: e instanceof Error ? e.message : 'Unknown error.' }; }
    }, [pattern, testString]);
    
    const handleGenerateRegex = useCallback(async (p: string) => {
        if (!p) return;
        setIsAiLoading(true);
        try {
            const stream = generateRegExStream(p);
            let fullResponse = '';
            for await (const chunk of stream) { fullResponse += chunk; }
            setPattern(fullResponse.trim().replace(/^\\\`+|\\\`+\\\$/g, ''));
        } finally { setIsAiLoading(false); }
    }, []);

    useEffect(() => { if (initialPrompt) handleGenerateRegex(initialPrompt); }, [initialPrompt, handleGenerateRegex]);

    const highlightedString = useMemo(() => {
        if (!matches || matches.length === 0 || error) return testString;
        let lastIndex = 0;
        const parts: (string | JSX.Element)[] = [];
        matches.forEach((match, i) => {
            if (match.index === undefined) return;
            parts.push(testString.substring(lastIndex, match.index));
            parts.push(<mark key={i} className="bg-primary/20 text-primary rounded px-1">{match[0]}</mark>);
            lastIndex = match.index + match[0].length;
        });
        parts.push(testString.substring(lastIndex));
        return parts;
    }, [matches, testString, error]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><BeakerIcon /><span className="ml-3">RegEx Sandbox</span></h1><p className="text-text-secondary mt-1">Test your regular expressions and generate them with AI.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-2 flex flex-col gap-4">
                    <div className="flex gap-2"><input type="text" value={aiPrompt} onChange={(e) => setAiPrompt(e.target.value)} placeholder="Describe the pattern to find..." className="flex-grow px-3 py-1.5 rounded-md bg-surface border border-border text-sm focus:ring-2 focus:ring-primary" /><button onClick={() => handleGenerateRegex(aiPrompt)} disabled={isAiLoading} className="btn-primary px-4 py-1.5 flex items-center">{isAiLoading ? <LoadingSpinner/> : 'Generate'}</button></div>
                    <div><label htmlFor="regex-pattern" className="text-sm font-medium text-text-secondary">Regular Expression</label><input id="regex-pattern" type="text" value={pattern} onChange={(e) => setPattern(e.target.value)} className={\\\`w-full mt-1 px-3 py-2 rounded-md bg-surface border \\\${error ? 'border-red-500' : 'border-border'} font-mono text-sm focus:ring-2 focus:ring-primary\\\`} />{error && <p className="text-red-500 text-xs mt-1">{error}</p>}</div>
                    <div className="flex flex-col flex-grow min-h-0"><label htmlFor="test-string" className="text-sm font-medium text-text-secondary">Test String</label><textarea id="test-string" value={testString} onChange={(e) => setTestString(e.target.value)} className="w-full mt-1 p-3 rounded-md bg-surface border border-border font-mono text-sm resize-y h-32" /><div className="mt-2 p-3 bg-background rounded-md border border-border min-h-[50px] whitespace-pre-wrap">{highlightedString}</div></div>
                    <div className="flex-shrink-0"><h3 className="text-lg font-bold">Match Groups ({matches?.length || 0})</h3><div className="mt-2 p-2 bg-surface rounded-md overflow-y-auto max-h-48 font-mono text-xs border border-border">{matches && matches.length > 0 ? (matches.map((match, i) => (<details key={i} className="p-2 border-b border-border"><summary className="cursor-pointer text-green-700">Match {i + 1}: "{match[0]}"</summary><div className="pl-4 mt-1">{Array.from(match).map((group, gIndex) => <p key={gIndex} className="text-text-secondary">Group {gIndex}: <span className="text-amber-700">{String(group)}</span></p>)}</div></details>))) : (<p className="text-text-secondary text-sm p-2">No matches found.</p>)}</div></div>
                </div>
                <div className="lg:col-span-1 space-y-4">
                    <CheatSheet />
                    <div className="bg-surface border border-border p-4 rounded-lg">
                        <h3 className="text-lg font-bold mb-2">Common Patterns</h3>
                        <div className="flex flex-col items-start gap-2">
                            {commonPatterns.map(p => (
                                <button key={p.name} onClick={() => setPattern(p.pattern)} className="text-left text-sm text-primary hover:underline">
                                    {p.name}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/ResponsiveTester.tsx': \`import React, { useState, useEffect } from 'react';
import { EyeIcon } from '../icons.tsx';

const devices = {
    'iPhone 12': { width: 390, height: 844 },
    'Pixel 5': { width: 393, height: 851 },
    'iPad Air': { width: 820, height: 1180 },
    'Surface Duo': { width: 540, height: 720 },
    'Laptop': { width: 1366, height: 768 },
    'Desktop': { width: 1920, height: 1080 },
    'Auto': { width: '100%', height: '100%' },
};

type DeviceName = keyof typeof devices;

export const ResponsiveTester: React.FC = () => {
    const [url, setUrl] = useState('https://react.dev');
    const [displayUrl, setDisplayUrl] = useState(url);
    const [size, setSize] = useState<{width: number | string, height: number | string}>(devices['Auto']);

    useEffect(() => {
        const handleResize = () => {
            if (size.width === '100%') {
                setSize({ width: '100%', height: '100%' });
            }
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, [size.width]);

    const handleUrlSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        setDisplayUrl(url.startsWith('http') ? url : \\\`https://\\\${url}\\\`);
    };

    const handleRotate = () => {
        if(typeof size.width === 'number' && typeof size.height === 'number') {
            setSize({ width: size.height, height: size.width });
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><EyeIcon /><span className="ml-3">Responsive Tester</span></h1><p className="text-text-secondary mt-1">Preview your web pages at different screen sizes.</p></header>
            <form onSubmit={handleUrlSubmit} className="flex items-center gap-2 mb-2">
                <input type="text" value={url} onChange={(e) => setUrl(e.target.value)} placeholder="https://example.com" className="flex-grow px-4 py-2 rounded-md bg-surface border border-border focus:ring-2 focus:ring-primary focus:outline-none"/>
                <button type="submit" className="btn-primary px-6 py-2">Load</button>
            </form>
            <div className="bg-surface p-2 rounded-lg flex flex-wrap justify-center items-center gap-2 mb-4 border border-border">
                {Object.keys(devices).map(name => (
                    <button key={name} onClick={() => setSize(devices[name as DeviceName])} className={\\\`px-3 py-1 rounded-md text-sm \\\${JSON.stringify(size) === JSON.stringify(devices[name as DeviceName]) ? 'bg-primary/10 text-primary font-semibold' : 'hover:bg-gray-100'}\\\`}>{name}</button>
                ))}
                <div className="flex items-center gap-1 ml-4">
                    <input type="number" value={typeof size.width === 'number' ? size.width : ''} onChange={e => setSize({ ...size, width: Number(e.target.value) })} className="w-20 px-2 py-1 bg-gray-100 border border-border rounded-md text-sm"/>
                    <span className="text-sm text-text-secondary">x</span>
                    <input type="number" value={typeof size.height === 'number' ? size.height : ''} onChange={e => setSize({ ...size, height: Number(e.target.value) })} className="w-20 px-2 py-1 bg-gray-100 border border-border rounded-md text-sm"/>
                </div>
                 <button onClick={handleRotate} className="px-3 py-1 rounded-md text-sm hover:bg-gray-100" title="Rotate">🔄</button>
            </div>
            <div className="flex-grow bg-background rounded-lg p-4 overflow-auto border border-border">
                <iframe key={displayUrl} src={displayUrl} style={{ width: size.width, height: size.height }} className="bg-white border-4 border-gray-300 rounded-md transition-all duration-300 shadow-lg mx-auto" title="Responsive Preview"/>
            </div>
        </div>
    );
};\`,
  'components/features/SassScssCompiler.tsx': \`import React, { useState, useMemo } from 'react';
import { CodeBracketSquareIcon } from '../icons.tsx';

const initialScss = \\\`\\\$primary-color: #0047AB;
\\\$font-size: 16px;

.container {
  padding: 20px;
  background-color: #f0f0f0;

  .title {
    color: \\\$primary-color;
    font-size: \\\$font-size * 1.5;

    &:hover {
      text-decoration: underline;
    }
  }
  
  > p {
    margin-top: 10px;
  }
}\\\`;

const escapeRegExp = (string: string): string => {
    // \\\$& means the whole matched string
    return string.replace(/[.*+?^\\\${}()|[\\\\]\\\\\\\\]/g, '\\\\\\\\\\\$&');
};

const compileScss = (scss: string): string => {
    try {
        let css = scss;
        css = css.replace(/\\\\/\\\\/.*\\\$/gm, '');
        
        const variables: Record<string, string> = {};
        css = css.replace(/\\\\\\\$([\\\\w-]+):\\\\s*(.*?);/g, (_, name, value) => {
            variables[name] = value.trim(); return '';
        });

        for (let i = 0; i < 5; i++) {
            Object.entries(variables).forEach(([name, value]) => {
                css = css.replace(new RegExp(\\\`\\\\\\\\\\\$\\\${escapeRegExp(name)}\\\`, 'g'), value);
            });
        }
        
        css = css.replace(/([\\\\d.]+)(px|rem|em|%)\\\\s*([*\\\\/])\\\\s*([\\\\d.]+)/g, (_, n1, unit, op, n2) => {
            const num1 = parseFloat(n1); const num2 = parseFloat(n2);
            const result = op === '*' ? num1 * num2 : num1 / num2;
            return \\\`\\\${result}\\\${unit}\\\`;
        });

        const processBlock = (block: string, parentSelector: string = ''): string => {
            let currentCss = '';
            let nestedCss = '';
            const properties = [];
            
            const regex = /((?:[\\\\w-:.#&>+~*\\\\s,]+|\\\\([^)]*\\\\))\\\\s*\\\\{[^{}]*\\\\})|((?:[\\\\w-]+\\\\s*:[^;]+;))/g;
            const content = block.substring(block.indexOf('{') + 1, block.lastIndexOf('}'));
            let match;
            while ((match = regex.exec(content)) !== null) {
                if (match[1]) {
                    const nestedSelector = match[1].substring(0, match[1].indexOf('{')).trim();
                    const fullSelector = nestedSelector.includes('&') ? nestedSelector.replace(/&/g, parentSelector) : \\\`\\\${parentSelector} \\\${nestedSelector}\\\`.trim();
                    nestedCss += processBlock(match[1], fullSelector);
                } else if (match[2]) {
                    properties.push(\\\`  \\\${match[2].trim()}\\\`);
                }
            }
            
            if (properties.length > 0) {
                currentCss = \\\`\\\${parentSelector} {\\\\n\\\${properties.join('\\\\n')}\\\\n}\\\\n\\\`;
            }

            return currentCss + nestedCss;
        };
        
        let result = processBlock(\\\`root{\\\${css}}\\\`, '').trim();
        return result.replace(/root\\\\s*\\\\{\\\\s*\\\\}/, '').trim();

    } catch(e) {
        console.error("SCSS Compilation Error:", e);
        return "/* Error compiling SCSS. Check console for details. */";
    }
};


export const SassScssCompiler: React.FC = () => {
    const [scss, setScss] = useState(initialScss);
    const compiledCss = useMemo(() => compileScss(scss), [scss]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl flex items-center"><CodeBracketSquareIcon /><span className="ml-3">SASS/SCSS Compiler</span></h1>
                <p className="text-text-secondary mt-1">A real-time SASS/SCSS to CSS compiler.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="scss-input" className="text-sm font-medium text-text-secondary mb-2">SASS/SCSS Input</label>
                    <textarea id="scss-input" value={scss} onChange={(e) => setScss(e.target.value)} className="flex-grow p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm text-pink-600" spellCheck="false" />
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Compiled CSS Output</label>
                    <pre className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto text-blue-700 font-mono text-sm whitespace-pre-wrap">{compiledCss}</pre>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/SchemaDesigner.tsx': \`import React, { useState, useRef } from 'react';
import { MapIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

interface Column { id: number; name: string; type: string; }
interface Table { id: number; name: string; columns: Column[]; x: number; y: number; }

const exportToSQL = (tables: Table[]) => {
    return tables.map(table => {
        const columnsSQL = table.columns.map(col => \\\`  "\\\${col.name}" \\\${col.type.toUpperCase()}\\\`).join(',\\\\n');
        return \\\`CREATE TABLE "\\\${table.name}" (\\\\n\\\${columnsSQL}\\\\n);\\\`;
    }).join('\\\\n\\\\n');
};

export const SchemaDesigner: React.FC = () => {
    const [tables, setTables] = useState<Table[]>([
        { id: 1, name: 'users', columns: [{ id: 1, name: 'id', type: 'INTEGER PRIMARY KEY' }, {id: 2, name: 'username', type: 'VARCHAR(255)'}], x: 50, y: 50 },
        { id: 2, name: 'posts', columns: [{ id: 1, name: 'id', type: 'INTEGER PRIMARY KEY' }, {id: 2, name: 'user_id', type: 'INTEGER'}, {id: 3, name: 'content', type: 'TEXT'}], x: 300, y: 100 },
    ]);
    const [dragging, setDragging] = useState<{ id: number; offsetX: number; offsetY: number } | null>(null);
    const canvasRef = useRef<HTMLDivElement>(null);

    const onMouseDown = (e: React.MouseEvent<HTMLDivElement>, id: number) => {
        const tableElement = e.currentTarget;
        const rect = tableElement.getBoundingClientRect();
        setDragging({ id, offsetX: e.clientX - rect.left, offsetY: e.clientY - rect.top });
    };

    const onMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
        if (!dragging || !canvasRef.current) return;
        const canvasRect = canvasRef.current.getBoundingClientRect();
        setTables(tables.map(t => t.id === dragging.id ? { ...t, x: e.clientX - dragging.offsetX - canvasRect.left + canvasRef.current.scrollLeft, y: e.clientY - dragging.offsetY - canvasRect.top + canvasRef.current.scrollTop } : t));
    };

    const onMouseUp = () => setDragging(null);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><MapIcon /><span className="ml-3">Schema Designer</span></h1><p className="text-text-secondary mt-1">Visually design your database schema with drag-and-drop.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <main ref={canvasRef} className="flex-grow relative bg-background rounded-lg border-2 border-dashed border-border overflow-auto" onMouseMove={onMouseMove} onMouseUp={onMouseUp} onMouseLeave={onMouseUp}>
                    {tables.map(table => (
                        <div key={table.id} className={\\\`absolute w-64 bg-surface rounded-lg shadow-xl border cursor-grab active:cursor-grabbing \\\${dragging?.id === table.id ? 'border-primary' : 'border-border'}\\\`} style={{ top: table.y, left: table.x }} onMouseDown={e => onMouseDown(e, table.id)}>
                            <h3 className="font-bold text-primary text-lg p-2 bg-gray-50 rounded-t-lg border-b border-border">{table.name}</h3>
                            <div className="p-2 space-y-1 font-mono text-xs">
                                {table.columns.map(col => (<div key={col.id} className="flex justify-between items-center"><span className="text-text-primary">{col.name}</span><span className="text-text-secondary">{col.type}</span></div>))}
                            </div>
                        </div>
                    ))}
                </main>
                <aside className="w-80 flex-shrink-0 flex flex-col gap-4">
                    <div className="flex flex-col gap-2">
                         <button onClick={() => downloadFile(JSON.stringify(tables, null, 2), 'schema.json', 'application/json')} className="flex-1 text-sm py-2 bg-gray-100 border border-border rounded-md flex items-center justify-center gap-2 hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download JSON
                        </button>
                         <button onClick={() => downloadFile(exportToSQL(tables), 'schema.sql', 'application/sql')} className="btn-primary flex-1 text-sm py-2 flex items-center justify-center gap-2">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download SQL
                         </button>
                    </div>
                    <div className="flex-grow bg-surface border border-border p-4 rounded-lg overflow-y-auto">
                        <h3 className="font-bold mb-2">Editor</h3>
                        <p className="text-xs text-text-secondary">Schema editing coming soon!</p>
                    </div>
                </aside>
            </div>
        </div>
    );
};\`,
  'components/features/ScreenshotToComponent.tsx': \`import React, { useState, useCallback, useRef } from 'react';
import { generateComponentFromImageStream } from '../../services/index.ts';
import { PhotoIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { fileToBase64, blobToDataURL, downloadFile } from '../../services/fileUtils.ts';

export const ScreenshotToComponent: React.FC = () => {
    const [previewImage, setPreviewImage] = useState<string | null>(null);
    const [rawCode, setRawCode] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const fileInputRef = useRef<HTMLInputElement>(null);

    const handleGenerate = async (base64Image: string) => {
        setIsLoading(true);
        setError('');
        setRawCode('');
        try {
            const stream = generateComponentFromImageStream(base64Image);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setRawCode(fullResponse.replace(/^\\\`\\\`\\\`(?:\\\\w+\\\\n)?/, '').replace(/\\\`\\\`\\\`\\\$/, ''));
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    };

    const processImageBlob = async (blob: Blob) => {
        try {
            const [dataUrl, base64Image] = await Promise.all([blobToDataURL(blob), fileToBase64(blob as File)]);
            setPreviewImage(dataUrl);
            handleGenerate(base64Image);
        } catch (e) {
            setError('Could not process the image.');
        }
    };
    
    const handlePaste = useCallback(async (event: React.ClipboardEvent) => {
        const items = event.clipboardData.items;
        for (const item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                if (blob) await processImageBlob(blob);
                return;
            }
        }
    }, []);

    const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (file) await processImageBlob(file);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><PhotoIcon /><span className="ml-3">AI Screenshot-to-Component</span></h1><p className="text-text-secondary mt-1">Paste or upload a screenshot of a UI element to generate React/Tailwind code.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div onPaste={handlePaste} className="flex flex-col items-center justify-center bg-surface p-6 rounded-lg border-2 border-dashed border-border focus:outline-none focus:border-primary overflow-y-auto" tabIndex={0}>
                    {previewImage ? (<img src={previewImage} alt="Pasted content" className="max-w-full max-h-full object-contain rounded-md shadow-lg" />) : (<div className="text-center text-text-secondary">
                            <h2 className="text-xl font-bold text-text-primary">Paste an image here</h2>
                            <p className="mb-2">(Cmd/Ctrl + V)</p>
                            <p className="text-sm">or</p>
                            <button onClick={() => fileInputRef.current?.click()} className="mt-2 btn-primary px-4 py-2 text-sm">Upload File</button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden"/>
                        </div>)}
                </div>
                <div className="flex flex-col h-full">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">Generated Code</label>
                        {rawCode && !isLoading && (
                            <div className="flex items-center gap-2">
                                <button onClick={() => navigator.clipboard.writeText(rawCode)} className="px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">Copy Code</button>
                                <button onClick={() => downloadFile(rawCode, 'Component.tsx', 'text/typescript')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4" /> Download
                                </button>
                            </div>
                        )}
                    </div>
                    <div className="flex-grow bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && (<div className="flex items-center justify-center h-full"><LoadingSpinner /></div>)}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {rawCode && !isLoading && <MarkdownRenderer content={\\\`\\\\\\\`\\\\\\\`\\\\\\\`tsx\\\\n\\\${rawCode}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`} />}
                        {!isLoading && !rawCode && !error && (<div className="text-text-secondary h-full flex items-center justify-center">Generated component code will appear here.</div>)}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/SecurityScanner.tsx': \`import React, { useState } from 'react';
import { analyzeCodeForVulnerabilities } from '../../services/aiService.ts';
import { runStaticScan, SecurityIssue } from '../../services/security/staticAnalysisService.ts';
import type { SecurityVulnerability } from '../../types.ts';
import { ShieldCheckIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleCode = \\\`function UserProfile({ user }) {
  // TODO: remove this temporary api key
  const API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxx";
  const userContent = user.bio; // This might contain malicious scripts

  return (
    <div>
      <h2>{user.name}</h2>
      <div dangerouslySetInnerHTML={{ __html: userContent }} />
    </div>
  );
}\\\`;

export const SecurityScanner: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [localIssues, setLocalIssues] = useState<SecurityIssue[]>([]);
    const [aiIssues, setAiIssues] = useState<SecurityVulnerability[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleScan = async () => {
        if (!code.trim()) {
            setError('Please enter code to scan.');
            return;
        }
        setIsLoading(true);
        setError('');
        setLocalIssues([]);
        setAiIssues([]);
        try {
            // Run local scan first
            const staticIssues = runStaticScan(code);
            setLocalIssues(staticIssues);
            
            // Then run AI scan
            const geminiIssues = await analyzeCodeForVulnerabilities(code);
            setAiIssues(geminiIssues);

        } catch (err) {
            setError(err instanceof Error ? err.message : 'An error occurred during scanning.');
        } finally {
            setIsLoading(false);
        }
    };

    const SeverityBadge: React.FC<{ severity: string }> = ({ severity }) => {
        const colors: Record<string, string> = {
            'Critical': 'bg-red-500 text-white',
            'High': 'bg-red-400 text-white',
            'Medium': 'bg-yellow-400 text-yellow-900',
            'Low': 'bg-blue-400 text-white',
            'Informational': 'bg-gray-400 text-gray-900',
        };
        return <span className={\\\`px-2 py-0.5 text-xs font-bold rounded-full \\\${colors[severity] || 'bg-gray-300'}\\\`}>{severity}</span>
    }

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><ShieldCheckIcon /><span className="ml-3">AI Security Co-Pilot</span></h1>
                <p className="text-text-secondary mt-1">Find vulnerabilities in your code with static analysis and AI.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm mb-2">Code to Scan</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="w-full flex-grow p-2 bg-surface border rounded font-mono text-xs" />
                    <button onClick={handleScan} disabled={isLoading} className="btn-primary w-full mt-4 py-2 flex justify-center items-center gap-2">{isLoading ? <LoadingSpinner/> : 'Scan Code'}</button>
                </div>
                <div className="flex flex-col bg-surface p-4 border rounded-lg">
                    <h3 className="text-lg font-bold mb-2">Scan Results</h3>
                    {error && <p className="text-red-500">{error}</p>}
                    <div className="flex-grow overflow-y-auto pr-2 space-y-4">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner/></div>}
                        {!isLoading && localIssues.length === 0 && aiIssues.length === 0 && <p className="text-text-secondary text-center mt-8">No issues found. Run a scan to begin.</p>}
                        
                        {localIssues.length > 0 && <div>
                            <h4 className="font-semibold text-sm mb-1">Static Analysis Findings</h4>
                            {localIssues.map((issue, i) => <div key={\\\`local-\\\${i}\\\`} className="p-2 bg-background border rounded mb-2"><p className="font-bold flex items-center gap-2">{issue.type} <SeverityBadge severity={issue.severity} /></p><p className="text-xs">Line {issue.line}: {issue.description}</p></div>)}
                        </div>}

                         {aiIssues.length > 0 && <div>
                            <h4 className="font-semibold text-sm mb-1 flex items-center gap-1"><SparklesIcon/> AI-Powered Findings</h4>
                            {aiIssues.map((issue, i) => (
                                <details key={\\\`ai-\\\${i}\\\`} className="p-2 bg-background border rounded mb-2">
                                    <summary className="cursor-pointer font-bold flex items-center gap-2">{issue.vulnerability} <SeverityBadge severity={issue.severity} /></summary>
                                    <div className="mt-2 pt-2 border-t text-xs space-y-2">
                                        <p><strong>Description:</strong> {issue.description}</p>
                                        <p><strong>Mitigation:</strong> {issue.mitigation}</p>
                                        {issue.exploitSuggestion && (
                                            <div>
                                                <strong>Exploit Simulation:</strong>
                                                <div className="mt-1 p-2 bg-gray-50 rounded">
                                                     <MarkdownRenderer content={'\\\`\\\`\\\`bash\\\\n' + issue.exploitSuggestion + '\\\\n\\\`\\\`\\\`'}/>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </details>
                            ))}
                        </div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/SnippetVault.tsx': \`import React, { useState, useEffect, useMemo } from 'react';
import { LockClosedIcon, SparklesIcon, TrashIcon, ClipboardDocumentIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { useLocalStorage } from '../../hooks/useLocalStorage.ts';
import { enhanceSnippetStream, generateTagsForCode } from '../../services/aiService.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';

interface Snippet {
    id: number; name: string; code: string; language: string; tags: string[];
}

const langToExt: Record<string, string> = {
    javascript: 'js',
    typescript: 'ts',
    python: 'py',
    css: 'css',
    html: 'html',
    json: 'json',
    markdown: 'md',
    plaintext: 'txt',
};

export const SnippetVault: React.FC = () => {
    const [snippets, setSnippets] = useLocalStorage<Snippet[]>('devcore_snippets', [{ id: 1, name: 'React Hook Boilerplate', language: 'javascript', code: \\\`import { useState } from 'react';\\\\n\\\\nconst useCustomHook = () => {\\\\n  const [value, setValue] = useState(null);\\\\n  return { value, setValue };\\\\n};\\\`, tags: ['react', 'hook'] }]);
    const [activeSnippet, setActiveSnippet] = useState<Snippet | null>(null);
    const [isEnhancing, setIsEnhancing] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [isEditingName, setIsEditingName] = useState(false);
    const { addNotification } = useNotification();

    const filteredSnippets = useMemo(() => {
        if (!searchTerm) return snippets;
        const lowerSearch = searchTerm.toLowerCase();
        return snippets.filter((s: Snippet) => 
            s.name.toLowerCase().includes(lowerSearch) || 
            s.code.toLowerCase().includes(lowerSearch) ||
            (s.tags && s.tags.some(t => t.toLowerCase().includes(lowerSearch)))
        );
    }, [snippets, searchTerm]);

    useEffect(() => {
        if (!activeSnippet && filteredSnippets.length > 0) setActiveSnippet(filteredSnippets[0]);
        if (activeSnippet) setActiveSnippet(snippets.find((s: Snippet) => s.id === activeSnippet.id) || null);
    }, [snippets, activeSnippet, filteredSnippets]);

    const updateSnippet = (snippet: Snippet) => {
        setSnippets(snippets.map((s: Snippet) => s.id === snippet.id ? snippet : s));
        setActiveSnippet(snippet);
    };

    const handleEnhance = async () => {
        if (!activeSnippet) return;
        setIsEnhancing(true);
        try {
            const stream = enhanceSnippetStream(activeSnippet.code);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                updateSnippet({ ...activeSnippet, code: fullResponse.replace(/^\\\`\\\`\\\`(?:\\\\w+\\\\n)?/, '').replace(/\\\`\\\`\\\`\\\$/, '') });
            }
        } finally { setIsEnhancing(false); }
    };
    
    const handleAiTagging = async (snippet: Snippet) => {
        if (!snippet.code.trim()) return;
        try {
            const suggestedTags = await generateTagsForCode(snippet.code);
            const newTags = [...new Set([...(snippet.tags || []), ...suggestedTags])];
            updateSnippet({...snippet, tags: newTags});
            addNotification('AI tags added!', 'success');
        } catch(e) {
            console.error("AI tagging failed:", e);
            addNotification('AI tagging failed.', 'error');
        }
    };

    const handleAddNew = () => {
        const newSnippet: Snippet = { id: Date.now(), name: 'New Snippet', language: 'plaintext', code: '', tags: [] };
        setSnippets([...snippets, newSnippet]);
        setActiveSnippet(newSnippet);
    };
    
    const handleDelete = (id: number) => {
        setSnippets(snippets.filter((s: Snippet) => s.id !== id));
        if(activeSnippet?.id === id) setActiveSnippet(filteredSnippets.length > 1 ? filteredSnippets[0] : null);
    };
    
    const handleDownload = () => {
        if(!activeSnippet) return;
        const extension = langToExt[activeSnippet.language] || 'txt';
        const filename = \\\`\\\${activeSnippet.name.replace(/\\\\s/g, '_')}.\\\${extension}\\\`;
        downloadFile(activeSnippet.code, filename);
    }

    const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (activeSnippet) updateSnippet({...activeSnippet, name: e.target.value});
    };
    
    const handleTagsChange = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter' && activeSnippet) {
            const newTag = e.currentTarget.value.trim();
            if (newTag && !activeSnippet.tags.includes(newTag)) {
                updateSnippet({...activeSnippet, tags: [...(activeSnippet.tags ?? []), newTag]});
            }
            e.currentTarget.value = '';
        }
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><LockClosedIcon /><span className="ml-3">Snippet Vault</span></h1><p className="text-text-secondary mt-1">Store, search, tag, and enhance your reusable code snippets with AI.</p></header>
            <div className="flex-grow flex gap-6 min-h-0">
                <aside className="w-1/3 bg-surface border border-border p-4 rounded-lg flex flex-col">
                    <input type="text" placeholder="Search snippets..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-3 py-1.5 mb-3 rounded-md bg-background border border-border text-sm"/>
                    <ul className="space-y-2 flex-grow overflow-y-auto pr-2">{filteredSnippets.map((s: Snippet) => (<li key={s.id} className="group flex items-center justify-between"><button onClick={() => setActiveSnippet(s)} className={\\\`w-full text-left px-3 py-2 rounded-md \\\${activeSnippet?.id === s.id ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\\\`}>{s.name}</button><div className="flex opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => {navigator.clipboard.writeText(s.code); addNotification("Copied snippet!", "success")}} className="ml-2 p-1 text-text-secondary hover:text-primary" title="Copy"><ClipboardDocumentIcon /></button><button onClick={() => handleDelete(s.id)} className="ml-2 p-1 text-text-secondary hover:text-red-500" title="Delete"><TrashIcon/></button></div></li>))}</ul>
                    <div className="mt-4 pt-4 border-t border-border"><button onClick={handleAddNew} className="btn-primary w-full text-sm py-2">Add New Snippet</button></div>
                </aside>
                <main className="w-2/3 flex flex-col">
                    {activeSnippet ? (<>
                        <div className="flex justify-between items-center mb-2">
                            {isEditingName ? <input type="text" value={activeSnippet.name} onChange={handleNameChange} onBlur={() => setIsEditingName(false)} autoFocus className="text-lg font-bold bg-gray-100 dark:bg-slate-700 rounded px-2"/> : <h3 onDoubleClick={() => setIsEditingName(true)} className="text-lg font-bold cursor-pointer">{activeSnippet.name}</h3>}
                            <div className="flex gap-2">
                                <button onClick={() => handleAiTagging(activeSnippet)} className="flex items-center gap-2 px-3 py-1 bg-teal-500/80 text-white font-bold text-xs rounded-md"><SparklesIcon /> AI Tag</button>
                                <button onClick={handleEnhance} disabled={isEnhancing} className="flex items-center gap-2 px-3 py-1 bg-purple-500/80 text-white font-bold text-xs rounded-md disabled:bg-gray-400"><SparklesIcon /> AI Enhance</button>
                                <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 dark:bg-slate-700 text-xs rounded-md"><ArrowDownTrayIcon className="w-4 h-4"/> Download</button>
                            </div>
                        </div>
                        <textarea value={activeSnippet.code} onChange={e => updateSnippet({...activeSnippet, code: e.target.value})} className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm focus:ring-2 focus:ring-primary focus:outline-none"/>
                        <div className="mt-2 text-xs text-text-secondary">
                           <div className="flex items-center gap-2 flex-wrap">
                             <span className="font-bold">Tags:</span> {(activeSnippet.tags ?? []).map(t => <span key={t} className="bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded-full">{t}</span>)}
                             <input type="text" placeholder="+ Add tag" onKeyDown={handleTagsChange} className="bg-transparent border-b border-border focus:outline-none focus:border-primary w-24 text-xs px-1"/>
                           </div>
                        </div>
                    </>) : (<div className="flex-grow flex items-center justify-center bg-background border border-border rounded-lg text-text-secondary">Select a snippet or create a new one.</div>)}
                </main>
            </div>
        </div>
    );
};\`,
  'components/features/SvgPathEditor.tsx': \`import React, { useState, useRef } from 'react';
import { CodeBracketSquareIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const initialPath = "M 20 80 Q 100 20 180 80 T 340 80";

const parsePath = (d: string) => {
    const commands = d.match(/[a-df-z][^a-df-z]*/ig) || [];
    return commands.map((cmdStr, i) => {
        const command = cmdStr[0];
        const args = cmdStr.slice(1).trim().split(/[\\\\s,]+/).map(parseFloat).filter(n => !isNaN(n));
        const points = [];
        for (let j = 0; j < args.length; j += 2) {
            points.push({ x: args[j], y: args[j + 1] });
        }
        return { id: i, command, points };
    });
};

const buildPath = (parsed: any[]) => {
    return parsed.map(cmd => \\\`\\\${cmd.command} \\\${cmd.points.map((p:any) => \\\`\\\${p.x} \\\${p.y}\\\`).join(' ')}\\\`).join(' ');
};

export const SvgPathEditor: React.FC = () => {
    const [pathData, setPathData] = useState(initialPath);
    const svgRef = useRef<SVGSVGElement>(null);
    const [draggingPoint, setDraggingPoint] = useState<any>(null);
    const parsedPath = parsePath(pathData);

    const handleMouseDown = (e: React.MouseEvent, cmdIndex: number, pointIndex: number) => {
        e.stopPropagation();
        setDraggingPoint({ cmdIndex, pointIndex });
    };

    const handleMouseMove = (e: React.MouseEvent) => {
        if (!draggingPoint || !svgRef.current) return;
        const pt = new DOMPoint(e.clientX, e.clientY);
        const svgPoint = pt.matrixTransform(svgRef.current.getScreenCTM()?.inverse());
        
        const newParsedPath = parsedPath.map((cmd, cIdx) => {
            if (cIdx === draggingPoint.cmdIndex) {
                const newPoints = cmd.points.map((p, pIdx) => {
                    if (pIdx === draggingPoint.pointIndex) {
                        return { x: Math.round(svgPoint.x), y: Math.round(svgPoint.y) };
                    }
                    return p;
                });
                return { ...cmd, points: newPoints };
            }
            return cmd;
        });
        setPathData(buildPath(newParsedPath));
    };
    
    const handleMouseUp = () => setDraggingPoint(null);
    
    const handleAddPoint = (e: React.MouseEvent) => {
        if (!svgRef.current) return;
        const pt = new DOMPoint(e.clientX, e.clientY);
        const svgPoint = pt.matrixTransform(svgRef.current.getScreenCTM()?.inverse());
        const newPathData = \\\`\\\${pathData} L \\\${Math.round(svgPoint.x)} \\\${Math.round(svgPoint.y)}\\\`;
        setPathData(newPathData);
    };

    const handleDownload = () => {
        const svgContent = \\\`<svg viewBox="0 0 400 160" xmlns="http://www.w3.org/2000/svg">
  <path d="\\\${pathData}" stroke="black" fill="transparent" stroke-width="2"/>
</svg>\\\`;
        downloadFile(svgContent, 'path.svg', 'image/svg+xml');
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6"><h1 className="text-3xl font-bold flex items-center"><CodeBracketSquareIcon /><span className="ml-3">SVG Path Editor</span></h1><p className="text-text-secondary mt-1">Visually create and manipulate SVG path data by dragging points.</p></header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full overflow-y-auto">
                    <div className="flex justify-between items-center mb-2">
                        <label htmlFor="path-input" className="text-sm font-medium text-text-secondary">Path Data (d attribute)</label>
                         <button onClick={handleDownload} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                            <ArrowDownTrayIcon className="w-4 h-4"/> Download SVG
                        </button>
                    </div>
                    <textarea id="path-input" value={pathData} onChange={(e) => setPathData(e.target.value)} className="h-24 p-4 bg-surface border border-border rounded-md resize-y font-mono text-sm text-primary" />
                     <div className="flex-grow mt-4 p-4 bg-surface border-2 border-dashed border-border rounded-md overflow-hidden flex items-center justify-center min-h-[200px]">
                        <svg ref={svgRef} viewBox="0 0 400 160" className="w-full h-full cursor-crosshair" onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} onDoubleClick={handleAddPoint}>
                           <rect width="400" height="160" fill="var(--color-background)" />
                            <path d={pathData} stroke="var(--color-primary)" fill="transparent" strokeWidth="2" />
                            {parsedPath.flatMap((cmd, cmdIndex) => 
                                cmd.points.map((p, pointIndex) => (
                                    <circle
                                        key={\\\`\\\${cmd.id}-\\\${pointIndex}\\\`}
                                        cx={p.x}
                                        cy={p.y}
                                        r="5"
                                        fill={cmd.command.toLowerCase() === 'c' || cmd.command.toLowerCase() === 'q' || cmd.command.toLowerCase() === 's' || cmd.command.toLowerCase() === 't' ? '#fde047' : '#f87171'}
                                        stroke="var(--color-surface)"
                                        strokeWidth="2"
                                        className="cursor-move hover:stroke-primary"
                                        onMouseDown={(e) => handleMouseDown(e, cmdIndex, pointIndex)}
                                    />
                                ))
                            )}
                        </svg>
                    </div>
                    <p className="text-xs text-center text-text-secondary mt-2">Double-click on the canvas to add a new point.</p>
                </div>
                <div className="flex flex-col h-full">
                    <label className="text-sm font-medium text-text-secondary mb-2">Parsed Commands</label>
                    <div className="flex-grow p-2 bg-background border border-border rounded-md overflow-y-auto font-mono text-xs space-y-2">
                        {parsedPath.map(cmd => (
                            <div key={cmd.id} className="p-2 bg-surface rounded">
                                <span className="font-bold text-amber-600">{cmd.command}</span>
                                <span className="text-text-secondary"> {cmd.points.map(p => \\\`(\\\${p.x},\\\${p.y})\\\`).join(' ')}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/TechDebtSonar.tsx': \`import React, { useState, useCallback } from 'react';
import { detectCodeSmells } from '../../services/aiService.ts';
import type { CodeSmell } from '../../types.ts';
import { MagnifyingGlassIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const exampleCode = \\\`class DataProcessor {
    process(data) {
        // Long method with multiple responsibilities
        if (data.type === 'A') {
            const results = [];
            for (let i = 0; i < data.items.length; i++) {
                // complex logic
                const item = data.items[i];
                if(item.value > 100) {
                   results.push({ ...item, status: 'processed' });
                }
            }
            return results;
        } else {
            // Duplicated logic
            const results = [];
            for (let i = 0; i < data.items.length; i++) {
                const item = data.items[i];
                 if(item.value > 100) {
                   results.push({ ...item, status: 'processed_special' });
                }
            }
            return results;
        }
    }
}\\\`;

export const TechDebtSonar: React.FC = () => {
    const [code, setCode] = useState(exampleCode);
    const [smells, setSmells] = useState<CodeSmell[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleScan = useCallback(async () => {
        if (!code.trim()) {
            setError('Please provide code to scan.');
            return;
        }
        setIsLoading(true);
        setError('');
        setSmells([]);
        try {
            const result = await detectCodeSmells(code);
            setSmells(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred.');
        } finally {
            setIsLoading(false);
        }
    }, [code]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <MagnifyingGlassIcon />
                    <span className="ml-3">Tech Debt Sonar</span>
                </h1>
                <p className="text-text-secondary mt-1">Scan code to find code smells and areas with high complexity.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Code to Analyze</label>
                    <textarea value={code} onChange={e => setCode(e.target.value)} className="flex-grow p-2 bg-surface border rounded font-mono text-xs"/>
                    <button onClick={handleScan} disabled={isLoading} className="btn-primary w-full mt-4 py-3">{isLoading ? <LoadingSpinner/> : 'Scan for Code Smells'}</button>
                </div>
                <div className="flex flex-col">
                    <label className="text-sm font-medium mb-2">Detected Smells</label>
                    <div className="flex-grow p-2 bg-background border rounded overflow-auto">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500 p-4">{error}</p>}
                        {!isLoading && smells.length === 0 && <p className="text-text-secondary text-center pt-8">No smells detected, or scan not run.</p>}
                        {smells.length > 0 && (
                            <div className="space-y-3">
                                {smells.map((smell, i) => (
                                    <div key={i} className="p-3 bg-surface border border-border rounded-lg">
                                        <div className="flex justify-between items-center">
                                            <h4 className="font-bold text-primary">{smell.smell}</h4>
                                            <span className="text-xs font-mono bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded">Line: {smell.line}</span>
                                        </div>
                                        <p className="text-sm mt-1">{smell.explanation}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};
\`,
  'components/features/TerraformGenerator.tsx': \`import React, { useState, useCallback } from 'react';
import { generateTerraformConfig } from '../../services/index.ts';
import { CpuChipIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

export const TerraformGenerator: React.FC = () => {
    const [description, setDescription] = useState('An S3 bucket for static website hosting');
    const [cloud, setCloud] = useState<'aws' | 'gcp'>('aws');
    const [config, setConfig] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleGenerate = useCallback(async () => {
        if (!description.trim()) {
            setError('Please provide a description.');
            return;
        }
        setIsLoading(true);
        setError('');
        setConfig('');
        try {
            // Context is stubbed for now but demonstrates future capability
            const context = 'User might have existing VPCs. Check before creating new ones.';
            const result = await generateTerraformConfig(cloud, description, context);
            setConfig(result);
        } catch (err) {
            setError(err instanceof Error ? err.message : 'Failed to generate config.');
        } finally {
            setIsLoading(false);
        }
    }, [description, cloud]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><CpuChipIcon /><span className="ml-3">AI Terraform Generator</span></h1>
                <p className="text-text-secondary mt-1">Generate infrastructure-as-code from a description, with context from your cloud provider.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                 <div className="flex flex-col flex-1 min-h-0">
                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label className="block text-sm">Cloud Provider</label>
                            <select value={cloud} onChange={e => setCloud(e.target.value as 'aws' | 'gcp')} className="w-full mt-1 p-2 bg-surface border rounded">
                                <option value="aws">AWS</option>
                                <option value="gcp">GCP</option>
                            </select>
                        </div>
                        <div className="md:col-span-2">
                            <label className="block text-sm">Describe the infrastructure</label>
                            <input type="text" value={description} onChange={e => setDescription(e.target.value)} className="w-full mt-1 p-2 bg-surface border rounded"/>
                        </div>
                    </div>
                     <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center py-2"><SparklesIcon /> {isLoading ? 'Generating...' : 'Generate Configuration'}</button>
                </div>
                 <div className="flex flex-col flex-grow min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">Generated Terraform (.tf)</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !config && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {config && <MarkdownRenderer content={config} />}
                         {!isLoading && !config && !error && <div className="text-text-secondary h-full flex items-center justify-center">Generated config will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/ThemeDesigner.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { SparklesIcon, ArrowDownTrayIcon, PhotoIcon } from '../icons.tsx';
import { generateSemanticTheme } from '../../services/index.ts';
import { fileToBase64 } from '../../services/fileUtils.ts';
import type { SemanticColorTheme, ColorTheme } from '../../types.ts';
import { LoadingSpinner } from '../shared/index.tsx';
import { useTheme } from '../../hooks/useTheme.ts';

const ColorDisplay: React.FC<{ name: string; color: { name: string; value: string; } }> = ({ name, color }) => (
    <div className="flex items-center justify-between p-2 bg-background rounded-md border border-border">
        <div className="flex items-center gap-3">
            <div className="w-6 h-6 rounded-full border border-border" style={{ backgroundColor: color.value }} />
            <div>
                <p className="text-sm font-semibold text-text-primary capitalize">{name}</p>
                <p className="text-xs text-text-secondary">{color.name}</p>
            </div>
        </div>
        <span className="font-mono text-sm text-text-secondary">{color.value}</span>
    </div>
);

const AccessibilityCheck: React.FC<{ name: string, check: { ratio: number; score: string; } }> = ({ name, check }) => {
    const scoreColor = check.score === 'AAA' ? 'text-green-600' : check.score === 'AA' ? 'text-emerald-600' : 'text-red-600';
    return (
        <div className="flex items-center justify-between p-2 bg-background rounded-md border border-border text-sm">
            <p className="text-text-secondary">{name}</p>
            <div className="flex items-center gap-2">
                <span className="font-mono">{check.ratio.toFixed(2)}</span>
                <span className={\\\`font-bold px-2 py-0.5 rounded-full text-xs \\\${scoreColor} \\\${scoreColor.replace('text-', 'bg-')}/10\\\`}>{check.score}</span>
            </div>
        </div>
    );
}

export const ThemeDesigner: React.FC = () => {
    const [theme, setTheme] = useState<SemanticColorTheme | null>(null);
    const [prompt, setPrompt] = useState('A calming, minimalist theme for a blog');
    const [image, setImage] = useState<{ base64: string, name: string } | null>(null);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const [, , applyCustomTheme] = useTheme();

    const handleGenerate = useCallback(async () => {
        const textPart = { text: \\\`Generate a theme based on this description: "\\\${prompt}"\\\` };
        const imagePart = image ? { inlineData: { mimeType: 'image/png', data: image.base64 } } : null;
        const parts = imagePart ? [textPart, imagePart] : [textPart];

        setIsLoading(true); setError('');
        try {
            const newTheme = await generateSemanticTheme({ parts });
            setTheme(newTheme);
        } catch (err) {
            setError(err instanceof Error ? err.message : "An unknown error occurred.");
        } finally {
            setIsLoading(false);
        }
    }, [prompt, image]);
    
    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            const base64 = await fileToBase64(file);
            setImage({ base64, name: file.name });
            setPrompt(\\\`A theme based on the uploaded image: \\\${file.name}\\\`);
        }
    };
    
    useEffect(() => { handleGenerate(); }, []);

    const handleApplyTheme = () => {
        if (!theme) return;
        const colorsToApply: ColorTheme = {
            primary: theme.palette.primary.value,
            background: theme.theme.background.value,
            surface: theme.theme.surface.value,
            textPrimary: theme.theme.textPrimary.value,
            textSecondary: theme.theme.textSecondary.value,
            textOnPrimary: theme.theme.textOnPrimary.value,
            border: theme.theme.border.value,
        };
        applyCustomTheme(colorsToApply, theme.mode);
    };

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><SparklesIcon /><span className="ml-3">AI Theme Designer</span></h1>
                <p className="text-text-secondary mt-1">Generate a full design system from a description or image.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">
                <div className="md:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg overflow-y-auto">
                    <h3 className="text-xl font-bold">Describe or Upload</h3>
                    <textarea value={prompt} onChange={e => setPrompt(e.target.value)} className="p-2 bg-background border border-border rounded-md resize-none text-sm h-24" placeholder="e.g., A light, airy theme for a blog" />
                     <div className="relative border border-dashed border-border rounded-lg p-4 text-center">
                        <input type="file" onChange={handleFileChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        <PhotoIcon/>
                        <p className="text-sm mt-1">{image ? \\\`Image: \\\${image.name}\\\` : 'Upload an image (optional)'}</p>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={handleGenerate} disabled={isLoading} className="btn-primary flex-grow flex items-center justify-center gap-2 px-4 py-2">
                            {isLoading ? <LoadingSpinner /> : 'Generate New Theme'}
                        </button>
                         <button onClick={handleApplyTheme} disabled={isLoading || !theme} className="px-4 py-2 bg-emerald-600 text-white font-bold rounded-md hover:opacity-90 transition-all disabled:opacity-50 shadow-md">
                            Apply to App
                        </button>
                    </div>
                    {error && <p className="text-red-500 text-xs text-center">{error}</p>}

                    {theme && !isLoading && (
                        <div className="mt-4 border-t border-border pt-4 space-y-4">
                            <div><h3 className="text-lg font-bold mb-2">Palette</h3><div className="space-y-2"><ColorDisplay name="Primary" color={theme.palette.primary}/><ColorDisplay name="Secondary" color={theme.palette.secondary}/><ColorDisplay name="Accent" color={theme.palette.accent}/><ColorDisplay name="Neutral" color={theme.palette.neutral}/></div></div>
                            <div><h3 className="text-lg font-bold mb-2">Theme Roles</h3><div className="space-y-2"><ColorDisplay name="Background" color={theme.theme.background}/><ColorDisplay name="Surface" color={theme.theme.surface}/><ColorDisplay name="Text Primary" color={theme.theme.textPrimary}/><ColorDisplay name="Text Secondary" color={theme.theme.textSecondary}/><ColorDisplay name="Text on Primary" color={theme.theme.textOnPrimary}/><ColorDisplay name="Border" color={theme.theme.border}/></div></div>
                            <div><h3 className="text-lg font-bold mb-2">Accessibility (WCAG 2.1)</h3><div className="space-y-2"><AccessibilityCheck name="Primary on Surface" check={theme.accessibility.primaryOnSurface}/><AccessibilityCheck name="Text on Surface" check={theme.accessibility.textPrimaryOnSurface}/><AccessibilityCheck name="Subtle Text on Surface" check={theme.accessibility.textSecondaryOnSurface}/><AccessibilityCheck name="Text on Primary" check={theme.accessibility.textOnPrimaryOnPrimary}/></div></div>
                        </div>
                    )}
                </div>
                <div className="md:col-span-1 rounded-lg p-8 overflow-y-auto border border-border" style={{ backgroundColor: theme?.theme.background.value, color: theme?.theme.textPrimary.value }}>
                     <h3 className="text-2xl font-bold mb-6">Live Preview</h3>
                     {theme ? (
                         <div className="p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-6" style={{ backgroundColor: theme.theme.surface.value }}>
                            <div className="space-y-4">
                                <h4 className="text-lg font-bold">Sample Card</h4>
                                <p className="text-sm" style={{color: theme.theme.textSecondary.value}}>This is a sample card to demonstrate the theme colors. It contains a primary button and some secondary text.</p>
                                <button className="px-4 py-2 rounded-md font-bold transition-colors" style={{ backgroundColor: theme.palette.primary.value, color: theme.theme.textOnPrimary.value }}>Primary Button</button>
                            </div>
                             <div className="space-y-4">
                                <input type="text" placeholder="Text input" className="w-full px-3 py-2 rounded-md border" style={{backgroundColor: theme.theme.background.value, borderColor: theme.theme.border.value, color: theme.theme.textPrimary.value}} />
                                <div className="p-3 border rounded" style={{borderColor: theme.theme.border.value, color: theme.theme.textSecondary.value}}>
                                    <p>A bordered container.</p>
                                </div>
                             </div>
                         </div>
                     ) : <div className="flex items-center justify-center h-full text-text-secondary">Theme preview will appear here.</div>}
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/TypographyLab.tsx': \`import React, { useState, useEffect } from 'react';
import { TypographyLabIcon } from '../icons.tsx';

const popularFonts = [
    'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Source Sans Pro', 'Raleway', 'Poppins', 'Nunito', 'Merriweather',
    'Playfair Display', 'Lora', 'Noto Sans', 'Ubuntu', 'PT Sans', 'Slabo 27px'
];

export const TypographyLab: React.FC = () => {
    const [headingFont, setHeadingFont] = useState('Oswald');
    const [bodyFont, setBodyFont] = useState('Roboto');

    useEffect(() => {
        const fontsToLoad = [headingFont, bodyFont].filter(Boolean).join('|');
        if (fontsToLoad) {
            const linkId = 'font-pairing-stylesheet';
            let link = document.getElementById(linkId) as HTMLLinkElement;
            if (!link) {
                link = document.createElement('link');
                link.id = linkId;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
            link.href = \\\`https://fonts.googleapis.com/css?family=\\\${fontsToLoad.replace(/ /g, '+')}:400,700&display=swap\\\`;
        }
    }, [headingFont, bodyFont]);
    
    const FontSelector: React.FC<{ label: string, value: string, onChange: (font: string) => void }> = ({ label, value, onChange }) => (
        <div>
            <label className="block text-sm font-medium text-text-secondary">{label}</label>
            <select value={value} onChange={e => onChange(e.target.value)} className="w-full mt-1 px-3 py-2 rounded-md bg-surface border border-border">
                {popularFonts.map(font => <option key={font} value={font}>{font}</option>)}
            </select>
        </div>
    );

    const headingImport = \\\`@import url('https://fonts.googleapis.com/css?family=\\\${headingFont.replace(/ /g, '+')}:700&display=swap');\\\`;
    const bodyImport = \\\`@import url('https://fonts.googleapis.com/css?family=\\\${bodyFont.replace(/ /g, '+')}:400&display=swap');\\\`;
    const headingRule = \\\`font-family: '\\\${headingFont}', sans-serif;\\\`;
    const bodyRule = \\\`font-family: '\\\${bodyFont}', sans-serif;\\\`;

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <TypographyLabIcon />
                    <span className="ml-3">Typography Lab</span>
                </h1>
                <p className="text-text-secondary mt-1">Preview font pairings and get the necessary CSS rules.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                <div className="lg:col-span-1 flex flex-col gap-4 bg-surface border border-border p-6 rounded-lg">
                    <h3 className="text-xl font-bold">Controls</h3>
                    <FontSelector label="Heading Font" value={headingFont} onChange={setHeadingFont} />
                    <FontSelector label="Body Font" value={bodyFont} onChange={setBodyFont} />
                    <div className="space-y-2 mt-4 pt-4 border-t border-border">
                        <label className="block text-sm font-medium text-text-secondary">CSS Rules</label>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{headingImport}</pre><button onClick={() => navigator.clipboard.writeText(headingImport)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{headingRule}</pre><button onClick={() => navigator.clipboard.writeText(headingRule)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{bodyImport}</pre><button onClick={() => navigator.clipboard.writeText(bodyImport)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                        <div className="relative"><pre className="bg-background p-2 rounded-md text-primary text-xs overflow-x-auto">{bodyRule}</pre><button onClick={() => navigator.clipboard.writeText(bodyRule)} className="absolute top-1 right-1 px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy</button></div>
                    </div>
                </div>
                <div className="lg:col-span-2 bg-background border border-border rounded-lg p-8 overflow-y-auto">
                    <h2 className="text-4xl font-bold mb-4" style={{ fontFamily: \\\`'\\\${headingFont}', sans-serif\\\` }}>
                        The Quick Brown Fox Jumps Over the Lazy Dog
                    </h2>
                    <p className="text-lg" style={{ fontFamily: \\\`'\\\${bodyFont}', sans-serif\\\` }}>
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat.
                    </p>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/VisualGitTree.tsx': \`import React, { useState, useCallback, useEffect, useMemo } from 'react';
import { GitBranchIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { generateChangelogFromLogStream } from '../../services/aiService.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const exampleLog = \\\`* commit 3a4b5c6d7e8f9g0h1i2j3k4l5m6n7o8p9q0r (HEAD -> main, origin/main)
|\\\\\\\\  Merge: 1a2b3c4 2d3e4f5
| | Author: Dev One <dev.one@example.com>
| | Date:   Mon Jul 15 11:30:00 2024 -0400
| |
| |     feat: Implement collapsible sidebar navigation
| |
* | commit 2d3e4f5g6h7i8j9k0l1m2n3o4p5q6r7s8t9u (feature/new-sidebar)
| | Author: Dev Two <dev.two@example.com>
| | Date:   Mon Jul 15 10:00:00 2024 -0400
| |
| |     feat: Add icons to sidebar items
| |
* | commit 1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r
|/  Author: Dev One <dev.one@example.com>
|   Date:   Fri Jul 12 16:45:00 2024 -0400
|
|       fix: Correct user authentication bug\\\`;

const CommitGraph = ({ logInput }: { logInput: string }) => {
    const commits = useMemo(() => {
        const lines = logInput.split('\\\\n');
        const parsedCommits: any[] = [];
        let currentCommit: any = null;

        lines.forEach(line => {
            const commitMatch = line.match(/^.?[\\\\\\\\|/ ]*\\\\* commit (\\\\w+)(.*)/);
            if (commitMatch) {
                if (currentCommit) parsedCommits.push(currentCommit);
                currentCommit = {
                    hash: commitMatch[1],
                    shortHash: commitMatch[1].substring(0, 7),
                    refs: commitMatch[2].trim(),
                    message: '',
                    author: '',
                };
            } else if (currentCommit) {
                 if (line.includes('Author:')) currentCommit.author = line.split('Author:')[1].trim();
                 else if (line.trim().length > 0 && !line.match(/^[\\\\\\\\|/ ]*[\\\\\\\\|/ ]/)) {
                     currentCommit.message += line.trim() + ' ';
                 }
            }
        });
        if (currentCommit) parsedCommits.push(currentCommit);
        
        return parsedCommits.map((c, i) => ({ ...c, x: 50, y: 50 + i * 60 }));
    }, [logInput]);

    return (
         <svg width="100%" height={50 + commits.length * 60} className="min-h-[200px]">
            {commits.map((commit, i) => {
                const parent = commits[i + 1];
                return (
                    <g key={commit.hash}>
                        {parent && <line x1={commit.x} y1={commit.y} x2={parent.x} y2={parent.y} stroke="var(--color-border)" strokeWidth="2" />}
                        <g className="group cursor-pointer">
                            <circle cx={commit.x} cy={commit.y} r="8" fill="var(--color-primary)" stroke="var(--color-surface)" strokeWidth="3" />
                            <foreignObject x={commit.x + 20} y={commit.y - 25} width="350" height="50">
                                <div className="text-sm p-1">
                                    <p className="font-bold truncate text-text-primary">{commit.message}</p>
                                    <p className="text-xs text-text-secondary font-mono">{commit.shortHash} <span className="text-amber-600">{commit.refs}</span></p>
                                </div>
                            </foreignObject>
                            <title>{\\\`Commit: \\\${commit.hash}\\\\nAuthor: \\\${commit.author}\\\\n\\\\n\\\${commit.message}\\\`}</title>
                        </g>
                    </g>
                );
            })}
        </svg>
    );
};

export const VisualGitTree: React.FC<{ logInput?: string }> = ({ logInput: initialLogInput }) => {
    const [logInput, setLogInput] = useState(initialLogInput || exampleLog);
    const [analysis, setAnalysis] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleAnalyze = useCallback(async (logToAnalyze: string) => {
        if (!logToAnalyze.trim()) {
            setError('Please paste git log output.');
            return;
        }
        setIsLoading(true);
        setError('');
        setAnalysis('');
        try {
            const stream = generateChangelogFromLogStream(logToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setAnalysis(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to analyze log: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialLogInput) {
            setLogInput(initialLogInput);
            handleAnalyze(initialLogInput);
        }
    }, [initialLogInput, handleAnalyze]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <GitBranchIcon />
                    <span className="ml-3">Visual Git Tree</span>
                </h1>
                <p className="text-text-secondary mt-1">Paste your \\\`git log --graph\\\` output to visualize the history and get an AI summary.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 h-full overflow-hidden">
                <div className="flex flex-col h-full">
                    <label htmlFor="log-input" className="text-sm font-medium text-text-secondary mb-2">Git Log Output</label>
                    <textarea
                        id="log-input"
                        value={logInput}
                        onChange={(e) => setLogInput(e.target.value)}
                        placeholder="Paste your git log output here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                    <button
                        onClick={() => handleAnalyze(logInput)}
                        disabled={isLoading}
                        className="btn-primary mt-4 w-full flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Analyze & Summarize'}
                    </button>
                </div>
                <div className="flex flex-col h-full gap-4">
                    <div className="flex flex-col h-1/2">
                        <label className="text-sm font-medium text-text-secondary mb-2">Commit Graph</label>
                        <div className="flex-grow p-2 bg-surface border border-border rounded-md overflow-auto">
                            <CommitGraph logInput={logInput} />
                        </div>
                    </div>
                     <div className="flex flex-col h-1/2">
                        <div className="flex justify-between items-center mb-2">
                            <label className="text-sm font-medium text-text-secondary">AI Summary</label>
                            {analysis && !isLoading && (
                                <button onClick={() => downloadFile(analysis, 'summary.md', 'text/markdown')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                    <ArrowDownTrayIcon className="w-4 h-4"/> Download Summary
                                </button>
                            )}
                        </div>
                        <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                            {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                            {error && <p className="text-red-500">{error}</p>}
                            {analysis && !isLoading && <MarkdownRenderer content={analysis} />}
                            {!isLoading && !analysis && !error && <div className="text-text-secondary h-full flex items-center justify-center">AI summary will appear here.</div>}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/WeeklyDigestGenerator.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { generateWeeklyDigest } from '../../services/index.ts';
import { getCommitHistory } from '../../services/githubService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { useOctokit } from '../../contexts/OctokitContext.tsx';
import { MailIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';

const dummyTelemetry = {
    avgPageLoad: 120,
    errorRate: '0.5%',
    uptime: '99.98%'
};

export const WeeklyDigestGenerator: React.FC = () => {
    const { addNotification } = useNotification();
    const { state } = useGlobalState();
    const { selectedRepo } = state;
    const { octokit, reinitialize } = useOctokit();

    const [emailHtml, setEmailHtml] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    
    // Re-check for Octokit client if it's not available initially
    useEffect(() => {
        if (!octokit) {
            reinitialize();
        }
    }, [octokit, reinitialize]);

    const handleGenerate = useCallback(async () => {
        if (!selectedRepo || !octokit) {
            addNotification('Please select a repository and ensure GitHub is connected.', 'error');
            return;
        }

        setIsLoading(true);
        setEmailHtml('');
        try {
            const [owner, repo] = selectedRepo.full_name.split('/');
            const commits = await getCommitHistory(octokit, owner, repo);
            const commitLogs = commits.map(c => c.commit.message).join('\\\\n');
            
            const html = await generateWeeklyDigest(commitLogs, dummyTelemetry);
            setEmailHtml(html);
            addNotification('Digest content generated!', 'success');
        } catch (e) {
            addNotification(e instanceof Error ? e.message : 'Failed to generate digest', 'error');
        } finally {
            setIsLoading(false);
        }
    }, [addNotification, octokit, selectedRepo]);


    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center"><MailIcon /><span className="ml-3">Weekly Digest Generator</span></h1>
                <p className="text-text-secondary mt-1">Generate an AI-powered weekly summary based on project data.</p>
            </header>

            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col items-center justify-center text-center">
                    <h3 className="text-lg font-bold">Generate Digest</h3>
                    <p className="text-sm text-text-secondary my-4">
                        This tool will use the commit history from your selected repository ({selectedRepo ? selectedRepo.full_name : 'none selected'}) to generate a summary. The send functionality has been removed due to updated permissions.
                    </p>
                    <div className="flex flex-col gap-4 w-full max-w-xs">
                        <button onClick={handleGenerate} disabled={isLoading || !selectedRepo || !octokit} className="btn-primary flex items-center justify-center gap-2 py-3">
                            {isLoading ? <LoadingSpinner /> : <><SparklesIcon /> Generate Digest</>}
                        </button>
                    </div>
                </div>

                <div className="bg-surface p-4 border border-border rounded-lg flex flex-col">
                    <h3 className="text-lg font-bold mb-2">Email Preview</h3>
                    <div className="flex-grow bg-white border rounded overflow-hidden">
                        {isLoading && <div className="flex justify-center items-center h-full"><LoadingSpinner /></div>}
                        {emailHtml && <iframe srcDoc={emailHtml} title="Email Preview" className="w-full h-full" />}
                        {!isLoading && !emailHtml && <div className="flex justify-center items-center h-full text-text-secondary">Preview will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/WorkerThreadDebugger.tsx': \`import React, { useState, useCallback, useEffect } from 'react';
import { BugAntIcon, ArrowDownTrayIcon } from '../icons.tsx';
import { analyzeConcurrencyStream } from '../../services/index.ts';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';
import { downloadFile } from '../../services/fileUtils.ts';

const exampleCode = \\\`// main.js
const worker = new Worker('worker.js');

// This object is sent back and forth.
// A race condition can occur because both threads
// read the counter, increment it, and send it back.
// The final value depends on which thread's message
// is processed last.
const data = { counter: 0 };

worker.onmessage = function(e) {
  // Main thread reads and updates
  data.counter = e.data.counter;
  console.log('Main received:', data.counter);
  data.counter++;
  worker.postMessage(data);
};

// Start the process
console.log('Main starting with:', data.counter);
data.counter++;
worker.postMessage(data);


// worker.js
// onmessage = function(e) {
//   // Worker reads and updates
//   let receivedCounter = e.data.counter;
//   console.log('Worker received:', receivedCounter);
//   receivedCounter++;
//   postMessage({ counter: receivedCounter });
// }
\\\`;

export const WorkerThreadDebugger: React.FC<{ codeInput?: string }> = ({ codeInput: initialCode }) => {
    const [codeInput, setCodeInput] = useState(initialCode || exampleCode);
    const [analysis, setAnalysis] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleAnalyze = useCallback(async (codeToAnalyze: string) => {
        if (!codeToAnalyze.trim()) {
            setError('Please paste some code to analyze.');
            return;
        }
        setIsLoading(true);
        setError('');
        setAnalysis('');
        try {
            const stream = analyzeConcurrencyStream(codeToAnalyze);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setAnalysis(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to analyze code: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    useEffect(() => {
        if (initialCode) {
            setCodeInput(initialCode);
            handleAnalyze(initialCode);
        }
    }, [initialCode, handleAnalyze]);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <BugAntIcon />
                    <span className="ml-3">AI Concurrency Analyzer</span>
                </h1>
                <p className="text-text-secondary mt-1">Analyze JavaScript code for potential Web Worker concurrency issues.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="code-input" className="text-sm font-medium text-text-secondary mb-2">JavaScript Code</label>
                    <textarea
                        id="code-input"
                        value={codeInput}
                        onChange={(e) => setCodeInput(e.target.value)}
                        placeholder="Paste your worker-related JS code here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={() => handleAnalyze(codeInput)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Analyze Code'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <div className="flex justify-between items-center mb-2">
                        <label className="text-sm font-medium text-text-secondary">AI Analysis</label>
                        {analysis && !isLoading && (
                             <button onClick={() => downloadFile(analysis, 'analysis.md', 'text/markdown')} className="flex items-center gap-1 px-3 py-1 bg-gray-100 text-xs rounded-md hover:bg-gray-200">
                                <ArrowDownTrayIcon className="w-4 h-4"/> Download
                            </button>
                        )}
                    </div>
                    <div className="flex-grow p-4 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="text-red-500">{error}</p>}
                        {analysis && !isLoading && <MarkdownRenderer content={analysis} />}
                        {!isLoading && !analysis && !error && <div className="text-text-secondary h-full flex items-center justify-center">Analysis will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/WorkspaceConnectorHub.tsx': \`import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { validateToken } from '../../services/authService.ts';
import { ACTION_REGISTRY, executeWorkspaceAction } from '../../services/workspaceConnectorService.ts';
import { RectangleGroupIcon, GithubIcon, SparklesIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import { signInWithGoogle } from '../../services/googleAuthService.ts';
import { useVaultModal } from '../../contexts/VaultModalContext.tsx';

const ServiceConnectionCard: React.FC<{
    serviceName: string;
    icon: React.ReactNode;
    fields: { id: string; label: string; placeholder: string }[];
    onConnect: (credentials: Record<string, string>) => Promise<void>;
    onDisconnect: () => Promise<void>;
    status: string;
    isLoading: boolean;
}> = ({ serviceName, icon, fields, onConnect, onDisconnect, status, isLoading }) => {
    const [creds, setCreds] = useState<Record<string, string>>({});

    const handleConnect = () => {
        onConnect(creds);
    };

    const isConnected = status.startsWith('Connected');

    return (
        <div className="bg-surface border border-border rounded-lg p-6">
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                    <div className="w-10 h-10">{icon}</div>
                    <div>
                        <h3 className="text-lg font-bold text-text-primary">{serviceName}</h3>
                        <p className={\\\`text-sm \\\${isConnected ? 'text-green-600' : 'text-text-secondary'}\\\`}>{status}</p>
                    </div>
                </div>
                {isConnected && (
                    <button onClick={onDisconnect} className="px-4 py-2 bg-red-500/10 text-red-600 font-semibold rounded-lg hover:bg-red-500/20">
                        Disconnect
                    </button>
                )}
            </div>
            {!isConnected && (
                <div className="mt-4 pt-4 border-t border-border space-y-2">
                    {fields.map(field => (
                        <div key={field.id}>
                            <label className="text-xs text-text-secondary">{field.label}</label>
                            <input
                                type={field.id.includes('token') || field.id.includes('pat') ? 'password' : 'text'}
                                value={creds[field.id] || ''}
                                onChange={e => setCreds(prev => ({ ...prev, [field.id]: e.target.value }))}
                                placeholder={field.placeholder}
                                className="w-full mt-1 p-2 bg-background border border-border rounded-md text-sm"
                            />
                        </div>
                    ))}
                    <button onClick={handleConnect} disabled={isLoading} className="btn-primary w-full mt-2 py-2 flex items-center justify-center">
                        {isLoading ? <LoadingSpinner /> : 'Connect'}
                    </button>
                </div>
            )}
        </div>
    );
};


export const WorkspaceConnectorHub: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, vaultState } = state;
    const { addNotification } = useNotification();
    const { requestUnlock, requestCreation } = useVaultModal();
    const [loadingStates, setLoadingStates] = useState<Record<string, boolean>>({});
    const [connectionStatuses, setConnectionStatuses] = useState<Record<string, string>>({});
    
    // Manual action state
    const [selectedActionId, setSelectedActionId] = useState<string>([...ACTION_REGISTRY.keys()][0]);
    const [actionParams, setActionParams] = useState<Record<string, any>>({});
    const [isExecuting, setIsExecuting] = useState(false);
    const [actionResult, setActionResult] = useState<string>('');

    const services = useMemo(() => {
        const serviceMap = new Map();
        ACTION_REGISTRY.forEach(action => {
            if (!serviceMap.has(action.service)) {
                serviceMap.set(action.service, {
                    name: action.service,
                    actions: [],
                });
            }
            serviceMap.get(action.service).actions.push(action);
        });
        return Array.from(serviceMap.values());
    }, []);

    const checkConnections = useCallback(async () => {
        if (!user || !vaultState.isUnlocked) return;
        
        const checkCred = async (credId: string, serviceName: string, successMessage: string) => {
             const token = await vaultService.getDecryptedCredential(credId);
             setConnectionStatuses(s => ({ ...s, [serviceName]: token ? successMessage : 'Not Connected' }));
        };

        await checkCred('github_pat', 'GitHub', githubUser ? \\\`Connected as \\\${githubUser.login}\\\`: 'Connected');
        await checkCred('jira_pat', 'Jira', 'Connected');
        await checkCred('slack_bot_token', 'Slack', 'Connected');

    }, [user, vaultState.isUnlocked, githubUser]);

    useEffect(() => {
        checkConnections();
    }, [checkConnections]);
    
    const withVault = useCallback(async (callback: () => Promise<void>) => {
        if (!vaultState.isInitialized) {
            const created = await requestCreation();
            if (!created) { addNotification('Vault setup is required.', 'error'); return; }
        }
        if (!vaultState.isUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) { addNotification('Vault must be unlocked to manage connections.', 'error'); return; }
        }
        await callback();
    }, [vaultState, requestCreation, requestUnlock, addNotification]);


    const handleConnect = async (serviceName: string, credentials: Record<string, string>) => {
        await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const [key, value] of Object.entries(credentials)) {
                    if (value) await vaultService.saveCredential(key, value);
                }
                if (serviceName === 'GitHub' && credentials.github_pat) {
                     const githubProfile = await validateToken(credentials.github_pat);
                     dispatch({ type: 'SET_GITHUB_USER', payload: githubProfile });
                     await vaultService.saveCredential('github_user', JSON.stringify(githubProfile));
                }
                addNotification(\\\`\\\${serviceName} connected successfully!\\\`, 'success');
                checkConnections();
            } catch (e) {
                addNotification(\\\`Failed to connect \\\${serviceName}: \\\${e instanceof Error ? e.message : 'Unknown error'}\\\`, 'error');
            } finally {
                setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
        });
    };
    
    const handleDisconnect = async (serviceName: string, credIds: string[]) => {
       await withVault(async () => {
            setLoadingStates(s => ({ ...s, [serviceName]: true }));
            try {
                for (const id of credIds) {
                     await vaultService.saveCredential(id, ''); // Overwrite with empty string
                }
                 if (serviceName === 'GitHub') {
                     dispatch({ type: 'SET_GITHUB_USER', payload: null });
                     await vaultService.saveCredential('github_user', '');
                }
                addNotification(\\\`\\\${serviceName} disconnected.\\\`, 'info');
                checkConnections();
            } catch(e) {
                addNotification(\\\`Failed to disconnect \\\${serviceName}.\\\`, 'error');
            } finally {
                 setLoadingStates(s => ({ ...s, [serviceName]: false }));
            }
       });
    };
    
    const handleExecuteAction = async () => {
        await withVault(async () => {
            setIsExecuting(true);
            setActionResult('');
            try {
                const result = await executeWorkspaceAction(selectedActionId, actionParams);
                setActionResult(JSON.stringify(result, null, 2));
                addNotification('Action executed successfully!', 'success');
            } catch(e) {
                setActionResult(\\\`Error: \\\${e instanceof Error ? e.message : 'Unknown Error'}\\\`);
                addNotification('Action failed.', 'error');
            } finally {
                setIsExecuting(false);
            }
        });
    };

    const handleSignIn = () => {
        signInWithGoogle();
        // The result is handled by the global callback set in App.tsx
    };

    const selectedAction = ACTION_REGISTRY.get(selectedActionId);
    const actionParameters = selectedAction ? selectedAction.getParameters() : {};

    if (!user) {
        return (
            <div className="h-full flex items-center justify-center">
                <div className="text-center bg-surface p-8 rounded-lg border border-border max-w-md">
                    <h2 className="text-xl font-bold">Sign In Required</h2>
                    <p className="text-text-secondary my-4">Please sign in with your Google account to manage workspace connections.</p>
                    <button onClick={handleSignIn} className="btn-primary px-6 py-3 flex items-center justify-center gap-2 mx-auto">
                        Sign in with Google
                    </button>
                </div>
            </div>
        );
    }
    
    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
             <header className="mb-8">
                <h1 className="text-4xl font-extrabold tracking-tight flex items-center"><RectangleGroupIcon /><span className="ml-3">Workspace Connector Hub</span></h1>
                <p className="mt-2 text-lg text-text-secondary">Connect to your development services to unlock cross-platform AI actions.</p>
            </header>
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                <div className="flex flex-col gap-6 overflow-y-auto pr-4">
                    <h2 className="text-2xl font-bold">Service Connections</h2>
                    <ServiceConnectionCard 
                        serviceName="GitHub"
                        icon={<GithubIcon />}
                        fields={[{ id: 'github_pat', label: 'Personal Access Token', placeholder: 'ghp_...' }]}
                        onConnect={(creds) => handleConnect('GitHub', creds)}
                        onDisconnect={() => handleDisconnect('GitHub', ['github_pat'])}
                        status={connectionStatuses.GitHub || 'Checking...'}
                        isLoading={loadingStates.GitHub}
                    />
                     {/* Placeholder cards for Jira and Slack */}
                    <ServiceConnectionCard 
                        serviceName="Jira"
                        icon={<div className="w-10 h-10 bg-[#0052CC] rounded flex items-center justify-center text-white font-bold text-xl">J</div>}
                        fields={[
                            { id: 'jira_domain', label: 'Jira Domain', placeholder: 'your-company.atlassian.net' },
                            { id: 'jira_email', label: 'Your Jira Email', placeholder: 'you@example.com' },
                            { id: 'jira_pat', label: 'API Token', placeholder: 'Your API Token' },
                        ]}
                        onConnect={(creds) => handleConnect('Jira', creds)}
                        onDisconnect={() => handleDisconnect('Jira', ['jira_domain', 'jira_email', 'jira_pat'])}
                        status={connectionStatuses.Jira || 'Checking...'}
                        isLoading={loadingStates.Jira}
                    />
                    <ServiceConnectionCard 
                        serviceName="Slack"
                        icon={<div className="w-10 h-10 bg-[#4A154B] rounded flex items-center justify-center text-white font-bold text-2xl">#</div>}
                        fields={[{ id: 'slack_bot_token', label: 'Bot User OAuth Token', placeholder: 'xoxb-...' }]}
                        onConnect={(creds) => handleConnect('Slack', creds)}
                        onDisconnect={() => handleDisconnect('Slack', ['slack_bot_token'])}
                        status={connectionStatuses.Slack || 'Checking...'}
                        isLoading={loadingStates.Slack}
                    />
                </div>
                <div className="flex flex-col gap-6 bg-surface p-6 border border-border rounded-lg">
                    <h2 className="text-2xl font-bold">Manual Action Runner</h2>
                    <div className="space-y-4">
                         <div>
                            <label className="text-sm font-medium">Action</label>
                            <select value={selectedActionId} onChange={e => setSelectedActionId(e.target.value)} className="w-full mt-1 p-2 bg-background border rounded">
                                {services.map(service => (
                                    <optgroup label={service.name} key={service.name}>
                                        {service.actions.map((action: any) => (
                                            <option key={action.id} value={action.id}>{action.description}</option>
                                        ))}
                                    </optgroup>
                                ))}
                            </select>
                        </div>
                        {Object.entries(actionParameters).map(([key, param]: [string, any]) => (
                            <div key={key}>
                                <label className="text-sm font-medium">{key} {param.required && '*'}</label>
                                <input 
                                    type={param.type}
                                    value={actionParams[key] || ''}
                                    onChange={e => setActionParams(p => ({...p, [key]: e.target.value}))}
                                    placeholder={param.default || ''}
                                    className="w-full mt-1 p-2 bg-background border rounded"
                                />
                            </div>
                        ))}
                        <button onClick={handleExecuteAction} disabled={isExecuting} className="btn-primary w-full py-2 flex items-center justify-center gap-2">
                           {isExecuting ? <LoadingSpinner/> : <><SparklesIcon /> Execute Action</>}
                        </button>
                    </div>
                    <div>
                        <label className="text-sm font-medium">Result</label>
                        <pre className="w-full h-48 mt-1 p-2 bg-background border rounded overflow-auto text-xs">{actionResult || 'Action results will appear here.'}</pre>
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/XbrlConverter.tsx': \`import React, { useState, useCallback } from 'react';
import { convertJsonToXbrlStream } from '../../services/aiService.ts';
import { XbrlConverterIcon } from '../icons.tsx';
import { LoadingSpinner, MarkdownRenderer } from '../shared/index.tsx';

const exampleJson = \\\`{
  "company": "ExampleCorp",
  "year": 2024,
  "quarter": 2,
  "revenue": {
    "amount": 1500000,
    "currency": "USD"
  },
  "profit": {
    "amount": 250000,
    "currency": "USD"
  }
}\\\`;

export const XbrlConverter: React.FC<{ jsonInput?: string }> = ({ jsonInput: initialJsonInput }) => {
    const [jsonInput, setJsonInput] = useState<string>(initialJsonInput || exampleJson);
    const [xbrlOutput, setXbrlOutput] = useState<string>('');
    const [isLoading, setIsLoading] = useState<boolean>(false);
    const [error, setError] = useState<string>('');

    const handleConvert = useCallback(async (jsonToConvert: string) => {
        if (!jsonToConvert.trim()) {
            setError('Please enter valid JSON to convert.');
            return;
        }
        setIsLoading(true);
        setError('');
        setXbrlOutput('');
        try {
            const stream = convertJsonToXbrlStream(jsonToConvert);
            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk;
                setXbrlOutput(fullResponse);
            }
        } catch (err) {
            const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
            setError(\\\`Failed to convert: \\\${errorMessage}\\\`);
        } finally {
            setIsLoading(false);
        }
    }, []);

    return (
        <div className="h-full flex flex-col p-4 sm:p-6 lg:p-8 text-text-primary">
            <header className="mb-6">
                <h1 className="text-3xl font-bold flex items-center">
                    <XbrlConverterIcon />
                    <span className="ml-3">JSON to XBRL Converter</span>
                </h1>
                <p className="text-text-secondary mt-1">Convert JSON data into a simplified XBRL-like XML format using AI.</p>
            </header>
            <div className="flex-grow flex flex-col gap-4 min-h-0">
                <div className="flex flex-col flex-1 min-h-0">
                    <label htmlFor="json-input" className="text-sm font-medium text-text-secondary mb-2">JSON Input</label>
                    <textarea
                        id="json-input"
                        value={jsonInput}
                        onChange={(e) => setJsonInput(e.target.value)}
                        placeholder="Paste your JSON here..."
                        className="flex-grow p-4 bg-surface border border-border rounded-md resize-none font-mono text-sm"
                    />
                </div>
                 <div className="flex-shrink-0">
                    <button
                        onClick={() => handleConvert(jsonInput)}
                        disabled={isLoading}
                        className="btn-primary w-full max-w-xs mx-auto flex items-center justify-center px-6 py-3"
                    >
                        {isLoading ? <LoadingSpinner /> : 'Convert to XBRL'}
                    </button>
                </div>
                <div className="flex flex-col flex-1 min-h-0">
                    <label className="text-sm font-medium text-text-secondary mb-2">XBRL-like XML Output</label>
                    <div className="relative flex-grow p-1 bg-background border border-border rounded-md overflow-y-auto">
                        {isLoading && !xbrlOutput && <div className="flex items-center justify-center h-full"><LoadingSpinner /></div>}
                        {error && <p className="p-4 text-red-500">{error}</p>}
                        {xbrlOutput && <MarkdownRenderer content={'\\\`\\\`\\\`xml\\\\n' + xbrlOutput.replace(/\\\`\\\`\\\`xml\\\\n|\\\`\\\`\\\`/g, '') + '\\\\n\\\`\\\`\\\`'} />}
                        {!isLoading && xbrlOutput && <button onClick={() => navigator.clipboard.writeText(xbrlOutput)} className="absolute top-2 right-2 px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-xs">Copy XML</button>}
                        {!isLoading && !xbrlOutput && !error && <div className="text-text-secondary h-full flex items-center justify-center">Output will appear here.</div>}
                    </div>
                </div>
            </div>
        </div>
    );
};\`,
  'components/features/index.ts': \`import React from 'react';
import type { Feature } from '../../types.ts';
import { RAW_FEATURES } from '../../constants.tsx';
import { lazyWithRetry } from '../../services/componentLoader.ts';

const componentMap: Record<string, React.FC<any>> = {
    'ai-command-center': lazyWithRetry(() => import('./AiCommandCenter.tsx'), 'AiCommandCenter'),
    'project-explorer': lazyWithRetry(() => import('./ProjectExplorer.tsx'), 'ProjectExplorer'),
    'workspace-connector-hub': lazyWithRetry(() => import('./WorkspaceConnectorHub.tsx'), 'WorkspaceConnectorHub'),
    'ai-code-explainer': lazyWithRetry(() => import('./AiCodeExplainer.tsx'), 'AiCodeExplainer'),
    'ai-feature-builder': lazyWithRetry(() => import('./AiFeatureBuilder.tsx'), 'AiFeatureBuilder'),
    'regex-sandbox': lazyWithRetry(() => import('./RegexSandbox.tsx'), 'RegexSandbox'),
    'portable-snippet-vault': lazyWithRetry(() => import('./SnippetVault.tsx'), 'SnippetVault'),
    'css-grid-editor': lazyWithRetry(() => import('./CssGridEditor.tsx'), 'CssGridEditor'),
    'ai-commit-generator': lazyWithRetry(() => import('./AiCommitGenerator.tsx'), 'AiCommitGenerator'),
    'json-tree-navigator': lazyWithRetry(() => import('./JsonTreeNavigator.tsx'), 'JsonTreeNavigator'),
    'xbrl-converter': lazyWithRetry(() => import('./XbrlConverter.tsx'), 'XbrlConverter'),
    'ai-unit-test-generator': lazyWithRetry(() => import('./AiUnitTestGenerator.tsx'), 'AiUnitTestGenerator'),
    'prompt-craft-pad': lazyWithRetry(() => import('./PromptCraftPad.tsx'), 'PromptCraftPad'),
    'linter-formatter': lazyWithRetry(() => import('./CodeFormatter.tsx'), 'CodeFormatter'),
    'schema-designer': lazyWithRetry(() => import('./SchemaDesigner.tsx'), 'SchemaDesigner'),
    'pwa-manifest-editor': lazyWithRetry(() => import('./PwaManifestEditor.tsx'), 'PwaManifestEditor'),
    'markdown-slides-generator': lazyWithRetry(() => import('./MarkdownSlides.tsx'), 'MarkdownSlides'),
    'screenshot-to-component': lazyWithRetry(() => import('./ScreenshotToComponent.tsx'), 'ScreenshotToComponent'),
    'digital-whiteboard': lazyWithRetry(() => import('./DigitalWhiteboard.tsx'), 'DigitalWhiteboard'),
    'theme-designer': lazyWithRetry(() => import('./ThemeDesigner.tsx'), 'ThemeDesigner'),
    'svg-path-editor': lazyWithRetry(() => import('./SvgPathEditor.tsx'), 'SvgPathEditor'),
    'ai-style-transfer': lazyWithRetry(() => import('./AiStyleTransfer.tsx'), 'AiStyleTransfer'),
    'ai-coding-challenge': lazyWithRetry(() => import('./AiCodingChallenge.tsx'), 'AiCodingChallenge'),
    'typography-lab': lazyWithRetry(() => import('./TypographyLab.tsx'), 'TypographyLab'),
    'code-review-bot': lazyWithRetry(() => import('./CodeReviewBot.tsx'), 'CodeReviewBot'),
    'ai-pull-request-assistant': lazyWithRetry(() => import('./AiPullRequestAssistant.tsx'), 'AiPullRequestAssistant'),
    'changelog-generator': lazyWithRetry(() => import('./ChangelogGenerator.tsx'), 'ChangelogGenerator'),
    'cron-job-builder': lazyWithRetry(() => import('./CronJobBuilder.tsx'), 'CronJobBuilder'),
    'ai-code-migrator': lazyWithRetry(() => import('./AiCodeMigrator.tsx'), 'AiCodeMigrator'),
    'visual-git-tree': lazyWithRetry(() => import('./VisualGitTree.tsx'), 'VisualGitTree'),
    'worker-thread-debugger': lazyWithRetry(() => import('./WorkerThreadDebugger.tsx'), 'WorkerThreadDebugger'),
    'ai-image-generator': lazyWithRetry(() => import('./AiImageGenerator.tsx'), 'AiImageGenerator'),
    'async-call-tree-viewer': lazyWithRetry(() => import('./AsyncCallTreeViewer.tsx'), 'AsyncCallTreeViewer'),
    'audio-to-code': lazyWithRetry(() => import('./AudioToCode.tsx'), 'AudioToCode'),
    'code-diff-ghost': lazyWithRetry(() => import('./CodeDiffGhost.tsx'), 'CodeDiffGhost'),
    'code-spell-checker': lazyWithRetry(() => import('./CodeSpellChecker.tsx'), 'CodeSpellChecker'),
    'color-palette-generator': lazyWithRetry(() => import('./ColorPaletteGenerator.tsx'), 'ColorPaletteGenerator'),
    'logic-flow-builder': lazyWithRetry(() => import('./LogicFlowBuilder.tsx'), 'LogicFlowBuilder'),
    'meta-tag-editor': lazyWithRetry(() => import('./MetaTagEditor.tsx'), 'MetaTagEditor'),
    'network-visualizer': lazyWithRetry(() => import('./NetworkVisualizer.tsx'), 'NetworkVisualizer'),
    'responsive-tester': lazyWithRetry(() => import('./ResponsiveTester.tsx'), 'ResponsiveTester'),
    'sass-scss-compiler': lazyWithRetry(() => import('./SassScssCompiler.tsx'), 'SassScssCompiler'),
    'api-mock-generator': lazyWithRetry(() => import('./ApiMockGenerator.tsx'), 'ApiMockGenerator'),
    'env-manager': lazyWithRetry(() => import('./EnvManager.tsx'), 'EnvManager'),
    'performance-profiler': lazyWithRetry(() => import('./PerformanceProfiler.tsx'), 'PerformanceProfiler'),
    'a11y-auditor': lazyWithRetry(() => import('./AccessibilityAuditor.tsx'), 'AccessibilityAuditor'),
    'ci-cd-generator': lazyWithRetry(() => import('./CiCdPipelineGenerator.tsx'), 'CiCdPipelineGenerator'),
    'deployment-preview': lazyWithRetry(() => import('./DeploymentPreview.tsx'), 'DeploymentPreview'),
    'security-scanner': lazyWithRetry(() => import('./SecurityScanner.tsx'), 'SecurityScanner'),
    'terraform-generator': lazyWithRetry(() => import('./TerraformGenerator.tsx'), 'TerraformGenerator'),
    'ai-personality-forge': lazyWithRetry(() => import('./AiPersonalityForge.tsx'), 'AiPersonalityForge'),
    'weekly-digest-generator': lazyWithRetry(() => import('./WeeklyDigestGenerator.tsx'), 'WeeklyDigestGenerator'),
    'one-click-refactor': lazyWithRetry(() => import('./OneClickRefactor.tsx'), 'OneClickRefactor'),
    'bug-reproducer': lazyWithRetry(() => import('./BugReproducer.tsx'), 'BugReproducer'),
    'tech-debt-sonar': lazyWithRetry(() => import('./TechDebtSonar.tsx'), 'TechDebtSonar'),
    'iam-policy-generator': lazyWithRetry(() => import('./IamPolicyGenerator.tsx'), 'IamPolicyGenerator'),
    'iam-policy-visualizer': lazyWithRetry(() => import('./IamPolicyVisualizer.tsx'), 'IamPolicyVisualizer'),
    'gmail-addon-simulator': lazyWithRetry(() => import('./GmailAddonSimulator.tsx'), 'GmailAddonSimulator'),
    'pr-summary-generator': lazyWithRetry(() => import('./PrSummaryGenerator.tsx'), 'PrSummaryGenerator'),
    'project-moodboard': lazyWithRetry(() => import('./ProjectMoodboard.tsx'), 'ProjectMoodboard'),
    'font-preview-picker': lazyWithRetry(() => import('./FontPreviewPicker.tsx'), 'FontPreviewPicker'),
    'font-pairing-tool': lazyWithRetry(() => import('./FontPairingTool.tsx'), 'FontPairingTool'),
};

export const ALL_FEATURES: Feature[] = RAW_FEATURES.map(feature => ({
    ...feature,
    component: componentMap[feature.id],
}));

export const FEATURES_MAP = new Map(ALL_FEATURES.map(f => [f.id, f]));\`,
  'components/features/manifest.ts': \`// This file can be used to export feature metadata or related constants.
// For now, it's a placeholder.
export {};
\`,
  'components/features/shared/.placeholder': \`\`,
  'components/features/shared/LoadingSpinner.tsx': \`
import React from 'react';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);
\`,
  'components/features/shared/index.tsx': \`import React, { useState, useEffect } from 'react';
import { marked } from 'marked';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);

interface MarkdownRendererProps {
    content: string;
}

export const MarkdownRenderer: React.FC<MarkdownRendererProps> = ({ content }) => {
    const [sanitizedHtml, setSanitizedHtml] = useState<string | TrustedHTML>('');

    useEffect(() => {
        const parse = async () => {
            if (content) {
                const html = await marked.parse(content);
                setSanitizedHtml(html);
            } else {
                setSanitizedHtml('');
            }
        };
        parse();
    }, [content]);

    return (
        <div
            className="prose prose-sm max-w-none prose-headings:text-text-primary prose-p:text-text-primary prose-strong:text-text-primary prose-code:text-primary prose-code:before:content-none prose-code:after:content-none prose-pre:bg-gray-50 prose-pre:border prose-pre:border-border prose-pre:p-4 prose-pre:m-0"
            dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
        />
    );
};
\`,
  'components/icons.tsx': \`

import React from 'react';

const IconWrapper: React.FC<{children: React.ReactNode; className?: string}> = ({ children, className }) => (
    <div className={className ?? 'w-6 h-6'}>{children}</div>
);

// --- From InterfaceIcons.tsx ---
export const CpuChipIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M8.25 21v-1.5M4.5 15.75H3m18 0h-1.5M21 8.25v7.5A2.25 2.25 0 0 1 18.75 18H5.25A2.25 2.25 0 0 1 3 15.75v-7.5A2.25 2.25 0 0 1 5.25 6h13.5A2.25 2.25 0 0 1 21 8.25ZM12 18V6" /></svg></IconWrapper>;
export const DocumentIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const FolderIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" /></svg></IconWrapper>;
export const LinkIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg></IconWrapper>;
export const ArchiveBoxIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg></IconWrapper>;
export const ClipboardDocumentIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876C9.083 2.25 6.105 5.106 6.105 9.125v3.375c0 .621.504 1.125 1.125 1.125h9.75Z" /></svg></IconWrapper>;
export const ArrowDownTrayIcon: React.FC<{className?: string}> = ({className}) => <IconWrapper className={className}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg></IconWrapper>;
export const XMarkIcon: React.FC<{className?: string}> = ({className}) => <IconWrapper className={className}><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></IconWrapper>;
export const PlusIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></IconWrapper>;
export const TrashIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></IconWrapper>;
export const PencilIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></IconWrapper>;
export const MagnifyingGlassIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg></IconWrapper>;
export const Cog6ToothIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-1.008 1.11-1.212l2.39-1.062a1.25 1.25 0 0 1 1.415.602l.62 1.24a1.25 1.25 0 0 0 1.282.693l2.394-.852a1.25 1.25 0 0 1 1.415 1.415l-.852 2.394a1.25 1.25 0 0 0 .693 1.282l1.24.62a1.25 1.25 0 0 1 .602 1.415l-1.062 2.39a1.25 1.25 0 0 0-1.212 1.11l-.22 1.319a1.25 1.25 0 0 1-1.393 1.053l-2.32-.82a1.25 1.25 0 0 0-1.353 0l-2.32.82a1.25 1.25 0 0 1-1.393-1.053l-.22-1.319a1.25 1.25 0 0 0-1.212-1.11l-1.062-2.39a1.25 1.25 0 0 1 .602-1.415l1.24-.62a1.25 1.25 0 0 0 .693-1.282l-.852-2.394a1.25 1.25 0 0 1 1.415-1.415l2.394.852a1.25 1.25 0 0 0 1.282-.693l.62-1.24a1.25 1.25 0 0 1 1.415-.602l-2.39 1.062a1.25 1.25 0 0 0-1.11 1.212Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></IconWrapper>;
export const HomeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg></IconWrapper>;
export const ChevronDownIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg></IconWrapper>;
export const SunIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg></IconWrapper>;
export const MoonIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg></IconWrapper>;
export const ArrowLeftOnRectangleIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H5" /></svg></IconWrapper>;
export const ArrowUpOnSquareIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3v12" /></svg></IconWrapper>;
const WindowIconWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => (<div className="w-4 h-4">{children}</div>);
export const MinimizeIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14" /></svg></WindowIconWrapper>;
export const MaximizeIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 4.5h15v15h-15z" /></svg></WindowIconWrapper>;
export const RestoreIcon: React.FC = () => <WindowIconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={3} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.5 8.5h11v11h-11z M4.5 4.5h11v11h-11z" /></svg></WindowIconWrapper>;

// --- From FeatureIcons.tsx ---
export const FileCodeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const GitBranchIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 3v4a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3V3M6 21v-4a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v4M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" /></svg></IconWrapper>;
export const SparklesIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg></IconWrapper>;
export const EyeIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639l4.368-7.28A1.012 1.012 0 0 1 7.105 4.5h9.79a1.012 1.012 0 0 1 .701.293l4.368 7.28c.15.25.228.538.228.828s-.078.578-.228.828l-4.368 7.28a1.012 1.012 0 0 1-.701.293h-9.79a1.012 1.012 0 0 1-.701-.293l-4.368-7.28Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></IconWrapper>;
export const MapIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 6.75V15m6-6v8.25m.5-10.5h-7a.5.5 0 0 0-.5.5v13.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V4.25a.5.5 0 0 0-.5-.5Z" /></svg></IconWrapper>;
export const BeakerIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c.139-.02.28-.032.427-.032.147 0 .288.012.427.032M5 14.5h14M14.25 3.104v5.714c0 .822-.394 1.573-.986 2.05l-2.014.915a2.25 2.25 0 0 0-.659 1.591v5.714m-3.468-18.222.01.001" /></svg></IconWrapper>;
export const CommandLineIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 7.5 3 11.25l3.75 3.75M17.25 7.5 21 11.25l-3.75 3.75" /></svg></IconWrapper>;
export const LockClosedIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg></IconWrapper>;
export const CodeBracketSquareIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.25 9.75 16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg></IconWrapper>;
export const PhotoIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg></IconWrapper>;
export const BellIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg></IconWrapper>;
export const ChartBarIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625Zm6.75-5.25c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V3.375Z" /></svg></IconWrapper>;
export const BugAntIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m15.182 16.318A4.5 4.5 0 0 0 18 12a4.5 4.5 0 0 0-3.818-4.318m-3.564 4.318a4.5 4.5 0 0 1 3.564 0M6 12a4.5 4.5 0 0 1 3.818-4.318M12 12a4.5 4.5 0 0 1-3.818-4.318m0 8.636a4.5 4.5 0 0 1 3.818 0M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Zm0 0a8.949 8.949 0 0 0 5.482-1.611m-10.964 0A8.949 8.949 0 0 1 12 21Zm0 0a8.949 8.949 0 0 0-5.482-1.611m10.964 0A8.949 8.949 0 0 0 12 21Zm-5.482 1.61a8.973 8.973 0 0 1-2.18-1.001m10.342 0a8.973 8.973 0 0 0-2.18-1.001m-6-1.611a8.973 8.973 0 0 1-2.18-1.001M18 12a8.973 8.973 0 0 0-2.18-1.001m-6 0a8.973 8.973 0 0 1-2.18-1.001M6 12a8.973 8.973 0 0 0-2.18-1.001m10.342 0a8.973 8.973 0 0 0-2.18-1.001M12 3a8.973 8.973 0 0 1 2.18 1.001m-4.36 0A8.973 8.973 0 0 1 12 3m0 18a8.973 8.973 0 0 0 2.18-1.001m-4.36 0A8.973 8.973 0 0 0 12 21Zm0-18a8.973 8.973 0 0 0-2.18-1.001m4.36 0A8.973 8.973 0 0 0 12 3Z" /></svg></IconWrapper>;
export const TerminalIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 7.5l3.75 3.75L6.75 15m6-7.5h4.5" /></svg></IconWrapper>;
export const ServerStackIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 20.25h12m-7.5-3.75v3.75m3.75-3.75v3.75M12 3c-5.12 0-9.25 4.13-9.25 9.25s4.13 9.25 9.25 9.25 9.25-4.13 9.25-9.25S17.12 3 12 3Z" /></svg></IconWrapper>;
export const CloudIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15a4.5 4.5 0 0 0 4.5 4.5H18a3.75 3.75 0 0 0 1.332-7.257 3 3 0 0 0-5.056-2.287 4.5 4.5 0 0 0-8.25-2.287 4.5 4.5 0 0 0-1.25 8.25Z" /></svg></IconWrapper>;
export const PaperAirplaneIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg></IconWrapper>;
export const ShieldCheckIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286Z" /></svg></IconWrapper>;
export const ArrowPathIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 11.667 0l3.181-3.183m-4.991-2.691V5.25a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75" /></svg></IconWrapper>;
export const RectangleGroupIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 7.125A2.25 2.25 0 0 1 4.5 4.875h15A2.25 2.25 0 0 1 21.75 7.125v10.5A2.25 2.25 0 0 1 19.5 19.875h-15A2.25 2.25 0 0 1 2.25 17.625v-10.5ZM11.25 4.875v10.5a2.25 2.25 0 0 1-2.25 2.25h-1.5a2.25 2.25 0 0 1-2.25-2.25v-10.5a2.25 2.25 0 0 1 2.25-2.25h1.5a2.25 2.25 0 0 1 2.25 2.25Z" /></svg></IconWrapper>;
export const MusicalNoteIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9 9V4.5M9 9c0 .54.06.913.175 1.313M9 9H4.5M9.175 10.313C9.06 10.087 9 9.85 9 9.6V4.5a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v5.1a.75.75 0 0 1-.75.75h-.625a.75.75 0 0 1-.75-.75V9.75" /></svg></IconWrapper>;
export const VideoCameraIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9A2.25 2.25 0 0 0 13.5 5.25h-9A2.25 2.25 0 0 0 2.25 7.5v9A2.25 2.25 0 0 0 4.5 18.75Z" /></svg></IconWrapper>;
export const DocumentTextIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg></IconWrapper>;
export const PaintBrushIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></IconWrapper>;
export const PuzzlePieceIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.25 6.087c0-1.036-.84-1.875-1.875-1.875s-1.875.84-1.875 1.875v.563c-1.036 0-1.875.84-1.875 1.875v1.5c0 1.036.84 1.875 1.875 1.875h1.5c1.036 0 1.875-.84 1.875-1.875v-1.5c0-1.036-.84-1.875-1.875-1.875v-.563Zm-4.5 0v.563c-1.036 0-1.875.84-1.875 1.875v1.5c0 1.036.84 1.875 1.875 1.875h1.5c1.036 0 1.875-.84 1.875-1.875v-1.5c0-1.036-.84-1.875-1.875-1.875v-.563a1.875 1.875 0 0 0-3.75 0Z" /></svg></IconWrapper>;
export const MicrophoneIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m12 4.5v-1.5a6 6 0 0 0-12 0v1.5m12 0v-1.5a6 6 0 0 0-12 0v1.5m6 3.75a3 3 0 0 1-3-3V6.75a3 3 0 0 1 6 0v6a3 3 0 0 1-3 3Z" /></svg></IconWrapper>;
export const MailIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg></IconWrapper>;


// --- From CustomFeatureIcons.tsx ---
export const CommandCenterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 9V5l-7 7 7 7v-4.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 14.5V19l7-7-7-7v4.5" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"/></svg></IconWrapper>;
export const ProjectExplorerIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></IconWrapper>;
export const ConnectionsIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg></IconWrapper>;
export const CodeExplainerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><circle cx="12" cy="15" r="3"/><path d="M12 18v2"/></svg></IconWrapper>;
export const FeatureBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/><path d="M17 8.5l-5 2.5-5-2.5"/><path d="M12 17.5V14"/></svg></IconWrapper>;
export const CodeMigratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 22H5a2 2 0 01-2-2V4a2 2 0 012-2h5"/><path d="M14 2h5a2 2 0 012 2v16a2 2 0 01-2 2h-5"/><path d="M7 8h2m-2 4h4m-4 4h2"/></svg></IconWrapper>;
export const ThemeDesignerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 000 20z"/><path d="M22 12c-5.523 0-10-4.477-10-10"/></svg></IconWrapper>;
export const SnippetVaultIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"/><circle cx="12" cy="12" r="3"/><path d="M8 12h8m-4-4v8"/></svg></IconWrapper>;
export const DigitalWhiteboardIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><path d="M7 8h4m-4 4h8m-8 4h6" /></svg></IconWrapper>;
export const UnitTestGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4.5 12.5l3-3 3 3 6-6"/><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></IconWrapper>;
export const CommitGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></IconWrapper>;
export const GitLogAnalyzerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M6 3v18"/><path d="M18 3v18"/><path d="M12 3v18"/><circle cx="6" cy="6" r="3" fill="currentColor" opacity="0.4"/><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"/><circle cx="18" cy="18" r="3" fill="currentColor" opacity="0.4"/></svg></IconWrapper>;
export const ConcurrencyAnalyzerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M18 6l-6 6-6-6"/><path d="M18 18l-6-6-6 6"/></svg></IconWrapper>;
export const RegexSandboxIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M15 4l-8 16"/><path d="M22 12H2"/><path d="M10 3L6 21"/></svg></IconWrapper>;
export const PromptCraftPadIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></IconWrapper>;
export const CodeFormatterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h3m-3 6h3m-3 6h3M9 6h12M9 12h12M9 18h12"/></svg></IconWrapper>;
export const JsonTreeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 21v-4a2 2 0 012-2h8"/><path d="M10 17H5a2 2 0 01-2-2V5a2 2 0 012-2h8a2 2 0 012 2v2"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const XbrlConverterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M8 8l-4 4 4 4m8-8l4 4-4-4" strokeLinecap="round" strokeLinejoin="round"/><path d="M14.5 5.5l-5 13" strokeLinecap="round"/></svg></IconWrapper>;
export const CssGridEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></IconWrapper>;
export const SchemaDesignerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4 7V4h16v3"/><path d="M4 12h16"/><path d="M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const PwaManifestEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 22a10 10 0 100-20 10 10 0 000 20z"/><path d="M12 12l4-4m-4 8l-4-4"/></svg></IconWrapper>;
export const MarkdownSlidesIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20 3H4a2 2 0 00-2 2v14a2 2 0 002 2h16a2 2 0 002-2V5a2 2 0 00-2-2z"/><path d="M9 16V8h6"/></svg></IconWrapper>;
export const ScreenshotToComponentIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><path d="M7 10l5-5 5 5m-5 8v-13"/></svg></IconWrapper>;
export const TypographyLabIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M4 7V4h16v3"/><path d="M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" ry="2" opacity="0.2"/></svg></IconWrapper>;
export const SvgPathEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 20.9l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 20.9z"/></svg></IconWrapper>;
export const StyleTransferIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69z"/><path d="M12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69zM12 2.69l.94-2.69.94 2.69L16.5 3l-2.69.94L13 6.58 12 4l-1 2.58L8.31 4 5.62 3l2.69.94.94 2.69.94-2.69zM3.5 13.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5-3.806 8.5-8.5 8.5-8.5-3.806-8.5-8.5z"/></svg></IconWrapper>;
export const CodingChallengeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 8V6m0 12v-2m-4-6H6m12 0h-2m-2-4l-1.5-1.5M18 18l-1.5-1.5M6 18l1.5-1.5M6 6l1.5 1.5"/><circle cx="12" cy="12" r="3"/></svg></IconWrapper>;
export const CodeReviewBotIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 20V10m0 0V4m0 6h8m-8 0H4"/><path d="M12 20a8 8 0 100-16 8 8 0 000 16z"/></svg></IconWrapper>;
export const AiPullRequestAssistantIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><path d="M13 2v7h7"/><path d="M17.5 2.5l-2-2m2 2l2-2m-2 2v4"/></svg></IconWrapper>;
export const ChangelogGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8m8 4H8m-1-8l-2-2-2 2"/></svg></IconWrapper>;
export const CronJobBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></IconWrapper>;
export const AsyncCallTreeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h18M3 12h18M3 18h18"/><path d="M6 3v18m12-18v18"/></svg></IconWrapper>;
export const AudioToCodeIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><path d="M12 19v4"/></svg></IconWrapper>;
export const CodeDiffGhostIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M16 16l-4-4 4-4m-8 8l4-4-4-4"/></svg></IconWrapper>;
export const CodeSpellCheckerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.72-1.72"/></svg></IconWrapper>;
export const ColorPaletteGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></IconWrapper>;
export const LogicFlowBuilderIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h18m-9 6H3m9 6H3"/><path d="M8 3v18m8-18v18"/></svg></IconWrapper>;
export const MetaTagEditorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><path d="M7 7h.01"/></svg></IconWrapper>;
export const NetworkVisualizerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M18 10h4V6h-4V2l-4 4 4 4zM6 14H2v4h4v4l4-4-4-4z"/><path d="M10 14v-4h4v4"/></svg></IconWrapper>;
export const ResponsiveTesterIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M21 12a9 9 0 00-9-9m9 9a9 9 0 01-9 9"/></svg></IconWrapper>;
export const SassCompilerIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21.168 18.168A10 10 0 118.832 2.832m12.336 15.336L8.832 2.832"/></svg></IconWrapper>;
export const ImageGeneratorIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></IconWrapper>;
export const GithubIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fillRule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clipRule="evenodd" /></svg></IconWrapper>;
export const HuggingFaceIcon: React.FC = () => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.25,4.01A2.25,2.25,0,0,0,18,1.76H6A2.25,2.25,0,0,0,3.75,4.01V15.5A2.25,2.25,0,0,0,6,17.75H8.6l3.4,3.4,3.4-3.4H18a2.25,2.25,0,0,0,2.25-2.25V4.01ZM8.5,12.06a1,1,0,0,1,1,1,1,1,0,0,1-2,0,1,1,0,0,1,1-1Zm4.9,0a1,1,0,0,1,1,1,1,1,0,0,1-2,0,1,1,0,0,1,1-1Zm2.6,3.44a3.25,3.25,0,0,1-6,0,.75.75,0,0,1,1.5,0,1.75,1.75,0,0,0,3,0,.75.75,0,0,1,1.5,0Z"/></svg></IconWrapper>;
export const GcpIcon: React.FC = () => <IconWrapper><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2L2 7l10 5 10-5-10-5z" fill="#4285F4" stroke="none"/><path d="M2 12l10 5 10-5-10-5-10 5z" fill="#34A853" stroke="none" opacity="0.7"/><path d="M12 22L2 17l10-5 10 5-10 5z" fill="#FBBC05" stroke="none" opacity="0.7"/></svg></IconWrapper>;
\`,
  'components/shared/.placeholder': \`\`,
  'components/shared/LoadingSpinner.tsx': \`
import React from 'react';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);
\`,
  'components/shared/Notification.tsx': \`// This file is intentionally left blank. 
// The NotificationProvider in contexts/NotificationContext.tsx handles rendering.
// This simplifies the architecture by co-locating the rendering logic with the state management.
export {};
\`,
  'components/shared/index.tsx': \`import React, { useState, useEffect } from 'react';
import { marked } from 'marked';

export const LoadingSpinner: React.FC = () => (
    <div className="flex items-center justify-center space-x-1" aria-label="Loading">
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.2s' }}></div>
        <div className="w-2 h-2 rounded-full bg-current animate-pulse" style={{ animationDelay: '0.4s' }}></div>
    </div>
);

interface MarkdownRendererProps {
    content: string;
}

export const MarkdownRenderer: React.FC<MarkdownRendererProps> = ({ content }) => {
    const [sanitizedHtml, setSanitizedHtml] = useState<string | TrustedHTML>('');

    useEffect(() => {
        const parse = async () => {
            if (content) {
                const html = await marked.parse(content);
                setSanitizedHtml(html);
            } else {
                setSanitizedHtml('');
            }
        };
        parse();
    }, [content]);

    return (
        <div
            className="prose prose-sm max-w-none prose-headings:text-text-primary prose-p:text-text-primary prose-strong:text-text-primary prose-code:text-primary prose-code:before:content-none prose-code:after:content-none prose-pre:bg-gray-50 prose-pre:border prose-pre:border-border prose-pre:p-4 prose-pre:m-0"
            dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
        />
    );
};
\`,
  'components/vault/.placeholder': \`\`,
  'components/vault/CreateMasterPasswordModal.tsx': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState } from 'react';
import * as vaultService from '../../services/vaultService.ts';
import { LoadingSpinner } from '../shared/LoadingSpinner.tsx';

interface Props {
    onSuccess: () => void;
    onCancel: () => void;
}

export const CreateMasterPasswordModal: React.FC<Props> = ({ onSuccess, onCancel }) => {
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');

        if (password.length < 8) {
            setError('Password must be at least 8 characters long.');
            return;
        }
        if (password !== confirmPassword) {
            setError('Passwords do not match.');
            return;
        }

        setIsLoading(true);
        try {
            await vaultService.initializeVault(password);
            onSuccess();
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-md m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Create Master Password</h2>
                <p className="text-sm text-text-secondary mb-4">
                    This password encrypts your API keys locally on your device. It is never stored or sent anywhere.
                    <strong> If you forget it, your data will be unrecoverable.</strong>
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">New Master Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Confirm Password</label>
                        <input
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-100 rounded-md">Cancel</button>
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[120px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Create Vault'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
\`,
  'components/vault/UnlockVaultModal.tsx': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState } from 'react';
import * as vaultService from '../../services/vaultService.ts';
import { LoadingSpinner } from '../shared/LoadingSpinner.tsx';

interface Props {
    onSuccess: () => void;
    onCancel: () => void;
}

export const UnlockVaultModal: React.FC<Props> = ({ onSuccess, onCancel }) => {
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);

        try {
            await vaultService.unlockVault(password);
            onSuccess();
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unexpected error occurred.');
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
            <div className="bg-surface border border-border rounded-lg shadow-2xl w-full max-w-sm m-4 p-6 animate-pop-in">
                <h2 className="text-xl font-bold mb-2">Unlock Vault</h2>
                <p className="text-sm text-text-secondary mb-4">
                    Enter your Master Password to access your encrypted API keys for this session.
                </p>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">Master Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full mt-1 p-2 bg-background border border-border rounded-md"
                            required
                            autoFocus
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-100 rounded-md">Cancel</button>
                        <button type="submit" disabled={isLoading} className="btn-primary px-4 py-2 min-w-[100px] flex justify-center">
                            {isLoading ? <LoadingSpinner /> : 'Unlock'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};
\`,
  'components/vault/VaultProvider.tsx': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { useState, useCallback, useMemo } from 'react';
import { VaultModalContext } from '../../contexts/VaultModalContext.tsx';
import { CreateMasterPasswordModal } from './CreateMasterPasswordModal.tsx';
import { UnlockVaultModal } from './UnlockVaultModal.tsx';
import * as vaultService from '../../services/vaultService.ts';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';

type PromiseResolver = (value: boolean) => void;

export const VaultProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const { dispatch } = useGlobalState();
    const [isCreateModalOpen, setCreateModalOpen] = useState(false);
    const [isUnlockModalOpen, setUnlockModalOpen] = useState(false);
    const [createPromise, setCreatePromise] = useState<{ resolve: PromiseResolver } | null>(null);
    const [unlockPromise, setUnlockPromise] = useState<{ resolve: PromiseResolver } | null>(null);

    const requestCreation = useCallback(() => {
        return new Promise<boolean>((resolve) => {
            setCreatePromise({ resolve });
            setCreateModalOpen(true);
        });
    }, []);

    const requestUnlock = useCallback(() => {
        return new Promise<boolean>((resolve) => {
            setUnlockPromise({ resolve });
            setUnlockModalOpen(true);
        });
    }, []);

    const handleCreateSuccess = () => {
        dispatch({ type: 'SET_VAULT_STATE', payload: { isInitialized: true, isUnlocked: true } });
        createPromise?.resolve(true);
        setCreateModalOpen(false);
        setCreatePromise(null);
    };

    const handleCreateCancel = () => {
        createPromise?.resolve(false);
        setCreateModalOpen(false);
        setCreatePromise(null);
    };

    const handleUnlockSuccess = () => {
        dispatch({ type: 'SET_VAULT_STATE', payload: { isUnlocked: true } });
        unlockPromise?.resolve(true);
        setUnlockModalOpen(false);
        setUnlockPromise(null);
    };

    const handleUnlockCancel = () => {
        unlockPromise?.resolve(false);
        setUnlockModalOpen(false);
        setUnlockPromise(null);
    };

    const contextValue = useMemo(() => ({ requestUnlock, requestCreation }), [requestUnlock, requestCreation]);

    return (
        <VaultModalContext.Provider value={contextValue}>
            {children}
            {isCreateModalOpen && (
                <CreateMasterPasswordModal
                    onSuccess={handleCreateSuccess}
                    onCancel={handleCreateCancel}
                />
            )}
            {isUnlockModalOpen && (
                <UnlockVaultModal
                    onSuccess={handleUnlockSuccess}
                    onCancel={handleUnlockCancel}
                />
            )}
        </VaultModalContext.Provider>
    );
};
\`,
  'constants.tsx': \`

import React from 'react';
import {
    CommandCenterIcon, CodeExplainerIcon, FeatureBuilderIcon, CodeMigratorIcon, ThemeDesignerIcon, SnippetVaultIcon,
    UnitTestGeneratorIcon, CommitGeneratorIcon, GitLogAnalyzerIcon, ConcurrencyAnalyzerIcon, RegexSandboxIcon,
    PromptCraftPadIcon, CodeFormatterIcon, JsonTreeIcon, CssGridEditorIcon, SchemaDesignerIcon, PwaManifestEditorIcon,
    MarkdownSlidesIcon, ScreenshotToComponentIcon, SvgPathEditorIcon, StyleTransferIcon, CodingChallengeIcon,
    CodeReviewBotIcon, ChangelogGeneratorIcon, CronJobBuilderIcon,
    AsyncCallTreeIcon, AudioToCodeIcon, CodeDiffGhostIcon, CodeSpellCheckerIcon, ColorPaletteGeneratorIcon, LogicFlowBuilderIcon,
    MetaTagEditorIcon, NetworkVisualizerIcon, ResponsiveTesterIcon, SassCompilerIcon, ImageGeneratorIcon, XbrlConverterIcon,
    DigitalWhiteboardIcon, TypographyLabIcon, AiPullRequestAssistantIcon, ProjectExplorerIcon,
    ServerStackIcon, DocumentTextIcon, ChartBarIcon, EyeIcon, PaperAirplaneIcon, CloudIcon, ShieldCheckIcon, CpuChipIcon, SparklesIcon,
    MailIcon, BugAntIcon, MagnifyingGlassIcon, RectangleGroupIcon, GcpIcon, HomeIcon, PhotoIcon
} from './components/icons.tsx';

export const CHROME_VIEW_IDS = ['features-list'] as const;

export const FEATURE_CATEGORIES = ['Core', 'AI Tools', 'Frontend', 'Testing', 'Database', 'Data', 'Productivity', 'Git', 'Local Dev', 'Performance & Auditing', 'Deployment & CI/CD', 'Security', 'Workflow', 'Cloud'] as const;
export type FeatureCategory = typeof FEATURE_CATEGORIES[number];

export type SlotCategory = FeatureCategory;
export const SLOTS: SlotCategory[] = ['Core', 'AI Tools', 'Frontend', 'Testing', 'Git', 'Productivity'];

interface RawFeature {
    id: string;
    name: string;
    description: string;
    icon: React.ReactNode;
    category: FeatureCategory;
}

export const RAW_FEATURES: RawFeature[] = [
    // --- Domain 1: Local Development & Testing Parity ---
    { id: "api-mock-generator", name: "API Mock Server", description: "Generate mock API data from a description and serve it locally.", icon: <ServerStackIcon />, category: "Local Dev" },
    { id: "env-manager", name: ".env Manager", description: "A graphical interface for creating and managing .env files.", icon: <DocumentTextIcon />, category: "Local Dev" },

    // --- Domain 2: Performance & Optimization Intelligence ---
    { id: "performance-profiler", name: "AI Performance Profiler", description: "Analyze runtime traces and bundle stats with AI-powered advice.", icon: <ChartBarIcon />, category: "Performance & Auditing" },
    { id: "a11y-auditor", name: "Accessibility Auditor", description: "Audit a live URL for accessibility issues and get AI-powered fixes.", icon: <EyeIcon />, category: "Performance & Auditing" },
    { id: "tech-debt-sonar", name: "Tech Debt Sonar", description: "Scan code to find code smells and areas with high complexity.", icon: <MagnifyingGlassIcon />, category: "Performance & Auditing" },

    // --- Domain 3: Deployment & CI/CD Automation ---
    { id: "ci-cd-generator", name: "AI CI/CD Architect", description: "Generate CI/CD config files from a natural language description.", icon: <PaperAirplaneIcon />, category: "Deployment & CI/CD" },
    { id: "deployment-preview", name: "Static Deployment Preview", description: "See a live preview of files generated by the AI Feature Builder.", icon: <CloudIcon />, category: "Deployment & CI/CD" },
    { id: "terraform-generator", name: "AI Terraform Generator", description: "Generate Terraform config from a description and cloud context.", icon: <CpuChipIcon />, category: "Deployment & CI/CD" },

    // --- Domain 4: Security & Vulnerability Scanning ---
    { id: "security-scanner", name: "AI Security Scanner", description: "Find common vulnerabilities in code with static analysis and AI.", icon: <ShieldCheckIcon />, category: "Security" },
    { id: "iam-policy-generator", name: "IAM Policy Generator", description: "Generate AWS or GCP IAM policies from a natural language description.", icon: <ShieldCheckIcon />, category: "Security" },
    { id: "iam-policy-visualizer", name: "GCP IAM Policy Visualizer", description: "Visually test and audit GCP IAM permissions in real-time across your resources.", icon: <GcpIcon />, category: "Cloud" },

    // --- Existing Features (Re-categorized and Ordered) ---
    { id: "ai-command-center", name: "AI Command Center", description: "Use natural language to navigate and control the toolkit.", icon: <CommandCenterIcon />, category: "Core" },
    { id: "project-explorer", name: "Project Explorer", description: "Manage and edit files from your connected repositories.", icon: <ProjectExplorerIcon />, category: "Core" },
    { id: "workspace-connector-hub", name: "Workspace Connector Hub", description: "Connect to services like Jira, Slack & GitHub to orchestrate actions with AI.", icon: <RectangleGroupIcon />, category: "Workflow" },
    { id: "linter-formatter", name: "AI Code Formatter", description: "AI-powered, real-time code formatting.", icon: <CodeFormatterIcon />, category: "Core" },
    { id: "json-tree-navigator", name: "JSON Tree Navigator", description: "Navigate large JSON objects as a collapsible tree.", icon: <JsonTreeIcon />, category: "Core" },
    
    { id: "ai-image-generator", name: "AI Image Generator", description: "Generate high-quality images from a text prompt.", icon: <ImageGeneratorIcon />, category: "AI Tools" },
    { id: "ai-code-explainer", name: "AI Code Explainer", description: "Get a structured analysis of code, including complexity.", icon: <CodeExplainerIcon />, category: "AI Tools" },
    { id: "ai-feature-builder", name: "AI Feature Builder", description: "Generate code, tests, and commit messages from a prompt or API schema.", icon: <FeatureBuilderIcon />, category: "AI Tools" },
    { id: "ai-personality-forge", name: "AI Personality Forge", description: "Architect, test, and save complex system prompts to create different 'AI personalities'.", icon: <SparklesIcon />, category: "AI Tools" },
    { id: "ai-code-migrator", name: "AI Code Migrator", description: "Translate code between languages & frameworks.", icon: <CodeMigratorIcon />, category: "AI Tools" },
    { id: "theme-designer", name: "AI Theme Designer", description: "Generate, fine-tune, and export UI color themes from a text description or image.", icon: <ThemeDesignerIcon />, category: "AI Tools" },
    { id: "one-click-refactor", name: "One-Click Refactor", description: "Apply common refactoring patterns to your code with a single click.", icon: <SparklesIcon />, category: "AI Tools" },
    { id: "ai-commit-generator", name: "AI Commit Message Generator", description: "Smart, conventional commits via AI.", icon: <CommitGeneratorIcon />, category: "AI Tools" },
    { id: "prompt-craft-pad", name: "Prompt Craft Pad", description: "Save, edit, and manage your custom AI prompts with variable testing.", icon: <PromptCraftPadIcon />, category: "AI Tools" },
    { id: "screenshot-to-component", name: "Screenshot to Component", description: "Turn UI screenshots into functional component code.", icon: <ScreenshotToComponentIcon />, category: "AI Tools" },
    { id: "ai-style-transfer", name: "AI Code Style Transfer", description: "Rewrite code to match a specific style guide.", icon: <StyleTransferIcon />, category: "AI Tools" },
    { id: "ai-coding-challenge", name: "AI Coding Challenge Generator", description: "Generate unique coding exercises.", icon: <CodingChallengeIcon />, category: "AI Tools" },
    { id: "code-review-bot", name: "AI Code Review Bot", description: "Get an automated code review with one-click refactoring.", icon: <CodeReviewBotIcon />, category: "AI Tools" },
    { id: "ai-pull-request-assistant", name: "AI Pull Request Assistant", description: "Generate a structured PR summary from code diffs and populate a full template.", icon: <AiPullRequestAssistantIcon />, category: "AI Tools" },
    { id: "pr-summary-generator", name: "PR Summary Generator", description: "Generate a structured PR summary from code diffs.", icon: <AiPullRequestAssistantIcon />, category: "AI Tools" },
    { id: "audio-to-code", name: "AI Audio-to-Code", description: "Speak your programming ideas and watch them turn into code.", icon: <AudioToCodeIcon />, category: "AI Tools" },
    
    { id: "css-grid-editor", name: "CSS Grid Visual Editor", description: "Drag-based layout builder for CSS Grid.", icon: <CssGridEditorIcon />, category: "Frontend" },
    { id: "pwa-manifest-editor", name: "PWA Manifest Editor", description: "Configure and preview Progressive Web App manifests with a home screen simulator.", icon: <PwaManifestEditorIcon />, category: "Frontend" },
    { id: "typography-lab", name: "Typography Lab", description: "Preview font pairings and get CSS import rules.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "font-preview-picker", name: "Font Preview Picker", description: "Preview custom text with different fonts.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "font-pairing-tool", name: "Font Pairing Tool", description: "Experiment with different font pairings for headings and body text.", icon: <TypographyLabIcon />, category: "Frontend" },
    { id: "svg-path-editor", name: "SVG Path Editor", description: "Visually create and manipulate SVG path data with an interactive canvas.", icon: <SvgPathEditorIcon />, category: "Frontend" },
    { id: "color-palette-generator", name: "AI Color Palette Generator", description: "Pick a base color and let Gemini design a beautiful palette.", icon: <ColorPaletteGeneratorIcon />, category: "Frontend" },
    { id: "meta-tag-editor", name: "Meta Tag Editor", description: "Generate SEO/social media meta tags with a live social card preview.", icon: <MetaTagEditorIcon />, category: "Frontend" },
    { id: "responsive-tester", name: "Responsive Tester", description: "Preview your web pages at different screen sizes and custom resolutions.", icon: <ResponsiveTesterIcon />, category: "Frontend" },
    { id: "sass-scss-compiler", name: "SASS/SCSS Compiler", description: "A real-time SASS/SCSS to CSS compiler.", icon: <SassCompilerIcon />, category: "Frontend" },
    
    { id: "ai-unit-test-generator", name: "AI Unit Test Generator", description: "Generate unit tests from source code.", icon: <UnitTestGeneratorIcon />, category: "Testing" },
    { id: "bug-reproducer", name: "Bug Reproducer", description: "Paste a stack trace to automatically generate a failing unit test.", icon: <BugAntIcon />, category: "Testing" },
    { id: "worker-thread-debugger", name: "AI Concurrency Analyzer", description: "Analyze JS for Web Worker issues like race conditions.", icon: <ConcurrencyAnalyzerIcon />, category: "Testing" },
    { id: "regex-sandbox", name: "RegEx Sandbox", description: "Visually test regular expressions, generate them with AI, and inspect match groups.", icon: <RegexSandboxIcon />, category: "Testing" },
    { id: "async-call-tree-viewer", name: "Async Call Tree Viewer", description: "Visualize a tree of asynchronous function calls from JSON data.", icon: <AsyncCallTreeIcon />, category: "Testing" },
    { id: "code-spell-checker", name: "Code Spell Checker", description: "A spell checker that finds common typos in code.", icon: <CodeSpellCheckerIcon />, category: "Testing" },
    { id: "network-visualizer", name: "Network Visualizer", description: "Inspect network resources with a summary and visual waterfall chart.", icon: <NetworkVisualizerIcon />, category: "Testing" },
    
    { id: "visual-git-tree", name: "Visual Git Tree", description: "Visually trace your git commit history with an interactive graph and an AI-powered summary.", icon: <GitLogAnalyzerIcon />, category: "Git" },
    { id: "changelog-generator", name: "AI Changelog Generator", description: "Auto-build changelogs from raw git logs.", icon: <ChangelogGeneratorIcon />, category: "Git" },
    { id: "code-diff-ghost", name: "Code Diff Ghost", description: "Visualize code changes with a 'ghost typing' effect.", icon: <CodeDiffGhostIcon />, category: "Git" },
    
    { id: "cron-job-builder", name: "AI Cron Job Builder", description: "Visually tool to configure cron jobs, with AI.", icon: <CronJobBuilderIcon />, category: "Deployment & CI/CD" },
    
    { id: "portable-snippet-vault", name: "Snippet Vault", description: "Store, search, tag, and enhance reusable code snippets with AI.", icon: <SnippetVaultIcon />, category: "Productivity" },
    { id: "digital-whiteboard", name: "Digital Whiteboard", description: "Organize ideas with interactive sticky notes and get AI-powered summaries.", icon: <DigitalWhiteboardIcon />, category: "Productivity" },
    { id: "project-moodboard", name: "Project Moodboard", description: "A visual space to gather ideas, images, and notes.", icon: <PhotoIcon />, category: "Productivity" },
    { id: "markdown-slides-generator", name: "Markdown Slides", description: "Turn markdown into a fullscreen presentation with an interactive overlay.", icon: <MarkdownSlidesIcon />, category: "Productivity" },
    { id: "weekly-digest-generator", name: "Weekly Digest Generator", description: "Generate and send a weekly project summary email via Gmail.", icon: <MailIcon />, category: "Productivity" },
    { id: "gmail-addon-simulator", name: "Gmail Add-on Simulator", description: "A simulation of how contextual add-on scopes would work inside Gmail.", icon: <MailIcon />, category: "Productivity" },
    
    { id: "schema-designer", name: "Schema Designer", description: "Visually design a database schema with a drag-and-drop interface and SQL export.", icon: <SchemaDesignerIcon />, category: "Database" },
    { id: "xbrl-converter", name: "XBRL Converter", description: "Convert JSON data to a simplified XBRL-like XML format using AI.", icon: <XbrlConverterIcon />, category: "Data" },
    { id: "logic-flow-builder", name: "Logic Flow Builder", description: "A visual tool for building application logic flows.", icon: <LogicFlowBuilderIcon />, category: "Workflow" },
];

export const ALL_FEATURE_IDS = RAW_FEATURES.map(f => f.id);\`,
  'contexts/.placeholder': \`\`,
  'contexts/GlobalStateContext.tsx': \`import React, { createContext, useReducer, useContext, useEffect } from 'react';
import type { ViewType, AppUser, GitHubUser, FileNode } from '../types.ts';

// State shape
interface GlobalState {
  activeView: ViewType;
  viewProps: any;
  hiddenFeatures: string[];
  user: AppUser | null;
  githubUser: GitHubUser | null;
  projectFiles: FileNode | null;
  // Fix: Expand selectedRepo to include full_name and name for consistent usage across components
  selectedRepo: { owner: string; repo: string; full_name: string; name: string; } | null;
  vaultState: {
    isInitialized: boolean;
    isUnlocked: boolean;
  };
  isApiKeyMissing: boolean;
}

// Action types
type Action =
  | { type: 'SET_VIEW'; payload: { view: ViewType, props?: any } }
  | { type: 'TOGGLE_FEATURE_VISIBILITY'; payload: { featureId: string } }
  | { type: 'SET_APP_USER', payload: AppUser | null }
  | { type: 'SET_GITHUB_USER', payload: GitHubUser | null }
  | { type: 'LOAD_PROJECT_FILES'; payload: FileNode | null }
  // Fix: Expand selectedRepo payload to include full_name and name
  | { type: 'SET_SELECTED_REPO'; payload: { owner: string; repo: string; full_name: string; name: string; } | null }
  | { type: 'SET_VAULT_STATE'; payload: Partial<{ isInitialized: boolean, isUnlocked: boolean }> }
  | { type: 'SET_API_KEY_MISSING', payload: boolean };


const initialState: GlobalState = {
  activeView: 'project-explorer',
  viewProps: {},
  hiddenFeatures: [],
  user: null,
  githubUser: null,
  projectFiles: null,
  selectedRepo: null,
  vaultState: {
    isInitialized: false,
    isUnlocked: false,
  },
  isApiKeyMissing: false,
};

const reducer = (state: GlobalState, action: Action): GlobalState => {
  switch (action.type) {
    case 'SET_VIEW':
      return { ...state, activeView: action.payload.view, viewProps: action.payload.props || {} };
    case 'TOGGLE_FEATURE_VISIBILITY': {
        const { featureId } = action.payload;
        const isHidden = state.hiddenFeatures.includes(featureId);
        const newHiddenFeatures = isHidden
            ? state.hiddenFeatures.filter(id => id !== featureId)
            : [...state.hiddenFeatures, featureId];
        return { ...state, hiddenFeatures: newHiddenFeatures };
    }
    case 'SET_APP_USER':
        if (action.payload === null) { // User logged out
            return {
                ...initialState, // Reset to initial state on logout
                user: null,
            }
        }
        return { ...state, user: action.payload };
    case 'SET_GITHUB_USER':
        return {
            ...state,
            githubUser: action.payload,
             // Reset repo-specific data if disconnected
            selectedRepo: action.payload ? state.selectedRepo : null,
            projectFiles: action.payload ? state.projectFiles : null,
        }
    case 'LOAD_PROJECT_FILES':
      return { ...state, projectFiles: action.payload };
    case 'SET_SELECTED_REPO':
      return { ...state, selectedRepo: action.payload, projectFiles: null }; // Reset files on repo change
    case 'SET_VAULT_STATE':
        return {
            ...state,
            vaultState: { ...state.vaultState, ...action.payload },
        };
    case 'SET_API_KEY_MISSING':
        return { ...state, isApiKeyMissing: action.payload };
    default:
      return state;
  }
};

const GlobalStateContext = createContext<{
  state: GlobalState;
  dispatch: React.Dispatch<Action>;
}>({
  state: initialState,
  dispatch: () => null,
});

const LOCAL_STORAGE_KEY = 'devcore_snapshot';
const CONSENT_KEY = 'devcore_ls_consent';

export const GlobalStateProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const canPersist = (() => {
        try {
            return localStorage.getItem(CONSENT_KEY) === 'granted';
        } catch (e) {
            return false;
        }
    })();

    const [state, dispatch] = useReducer(reducer, initialState, (initial) => {
        if (!canPersist) return initial;
        
        try {
            const storedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedStateJSON) return initial;
            
            const storedState = JSON.parse(storedStateJSON);
            const hydratedState = { ...initial };

            // Hydrate state from local storage
            if (storedState.selectedRepo) hydratedState.selectedRepo = storedState.selectedRepo;
            if (storedState.activeView) hydratedState.activeView = storedState.activeView;
            if (storedState.viewProps) hydratedState.viewProps = storedState.viewProps;
            if (storedState.hiddenFeatures) hydratedState.hiddenFeatures = storedState.hiddenFeatures;
            
            return hydratedState;
        } catch (error) {
            console.error("Failed to parse state from localStorage", error);
            return initial;
        }
    });

    useEffect(() => {
        if (!canPersist) return;

        const handler = setTimeout(() => {
            try {
                const stateToSave = { 
                    selectedRepo: state.selectedRepo,
                    activeView: state.activeView,
                    viewProps: state.viewProps,
                    hiddenFeatures: state.hiddenFeatures, 
                };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (error) {
                console.error("Failed to save state to localStorage", error);
            }
        }, 500);

        return () => clearTimeout(handler);
    }, [state, canPersist]);

    return (
        <GlobalStateContext.Provider value={{ state, dispatch }}>
            {children}
        </GlobalStateContext.Provider>
    );
};

export const useGlobalState = () => useContext(GlobalStateContext);\`,
  'contexts/NotificationContext.tsx': \`import React, { createContext, useContext, useState, useCallback } from 'react';

type NotificationType = 'success' | 'error' | 'info';

interface Notification {
  id: number;
  message: string;
  type: NotificationType;
}

interface NotificationContextType {
  addNotification: (message: string, type?: NotificationType) => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export const useNotification = () => {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotification must be used within a NotificationProvider');
  }
  return context;
};

export const NotificationProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [notifications, setNotifications] = useState<Notification[]>([]);

  const addNotification = useCallback((message: string, type: NotificationType = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 4000);
  }, []);
  
  const typeStyles = {
    success: 'bg-emerald-500 border-emerald-600',
    error: 'bg-red-500 border-red-600',
    info: 'bg-sky-500 border-sky-600'
  };

  return (
    <NotificationContext.Provider value={{ addNotification }}>
      {children}
      <div className="fixed bottom-4 right-4 z-[100] space-y-2 w-full max-w-sm">
        {notifications.map(notification => (
           <div key={notification.id} role="alert" className={\\\`relative animate-pop-in shadow-lg rounded-lg text-white font-medium p-4 border-b-4 \\\${typeStyles[notification.type]}\\\`}>
               {notification.message}
           </div>
        ))}
      </div>
    </NotificationContext.Provider>
  );
};\`,
  'contexts/OctokitContext.tsx': \`import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import type { Octokit } from 'octokit';
import { initializeOctokit } from '../services/authService.ts';
import { getDecryptedCredential } from '../services/vaultService.ts';
import { useGlobalState } from './GlobalStateContext.tsx';
import { useVaultModal } from './VaultModalContext.tsx';
import { useNotification } from './NotificationContext.tsx';

interface OctokitContextType {
    octokit: Octokit | null;
    reinitialize: () => Promise<void>;
}

const OctokitContext = createContext<OctokitContextType | undefined>(undefined);

export const useOctokit = (): OctokitContextType => {
    const context = useContext(OctokitContext);
    if (!context) {
        throw new Error('useOctokit must be used within an OctokitProvider');
    }
    return context;
};

export const OctokitProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [octokit, setOctokit] = useState<Octokit | null>(null);
    const { state, dispatch } = useGlobalState();
    const { user, vaultState } = state;
    const { requestUnlock } = useVaultModal();
    const { addNotification } = useNotification();
    
    const initialize = useCallback(async () => {
        if (!user) {
            setOctokit(null);
            return;
        }

        let isVaultUnlocked = vaultState.isUnlocked;

        if (!isVaultUnlocked) {
            const unlocked = await requestUnlock();
            if (!unlocked) {
                setOctokit(null);
                return;
            }
        }

        try {
            const token = await getDecryptedCredential('github_pat');
            if (token) {
                const client = initializeOctokit(token);
                setOctokit(client);
            } else {
                setOctokit(null); // No token stored, so no client.
            }
        } catch (e) {
            if (e instanceof Error && e.message.includes('Decryption failed')) {
                 dispatch({ type: 'SET_VAULT_STATE', payload: { isUnlocked: false } });
            }
            addNotification('Failed to initialize GitHub client.', 'error');
            setOctokit(null);
        }

    }, [user, vaultState.isUnlocked, requestUnlock, addNotification, dispatch]);

    useEffect(() => {
        // Initialize when the user logs in or vault state changes to unlocked
        if (user && vaultState.isUnlocked) {
            initialize();
        } else {
            setOctokit(null);
        }
    }, [user, vaultState.isUnlocked, initialize]);

    return (
        <OctokitContext.Provider value={{ octokit, reinitialize: initialize }}>
            {children}
        </OctokitContext.Provider>
    );
};\`,
  'contexts/VaultModalContext.tsx': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import React, { createContext, useContext } from 'react';

interface VaultModalContextType {
    requestUnlock: () => Promise<boolean>;
    requestCreation: () => Promise<boolean>;
}

export const VaultModalContext = createContext<VaultModalContextType | undefined>(undefined);

export const useVaultModal = (): VaultModalContextType => {
    const context = useContext(VaultModalContext);
    if (!context) {
        throw new Error('useVaultModal must be used within a VaultProvider');
    }
    return context;
};
\`,
  'githubService.ts': \`import type { Octokit } from 'octokit';
import type { Repo, FileNode } from './types.ts';
import { logEvent, logError, measurePerformance } from './services/index.ts';

// --- Repository-Level Functions ---

/**
 * Fetches the repositories for the authenticated user.
 * @param octokit An authenticated Octokit instance.
 * @returns A promise that resolves to an array of Repo objects.
 */
export const getRepos = async (octokit: Octokit): Promise<Repo[]> => {
    return measurePerformance('getRepos', async () => {
        logEvent('getRepos_start');
        try {
            const { data } = await octokit.request('GET /user/repos', {
                type: 'owner',
                sort: 'updated',
                per_page: 100,
            });
            logEvent('getRepos_success', { count: data.length });
            return data as Repo[];
        } catch (error) {
            logError(error as Error, { context: 'getRepos' });
            throw new Error(\\\`Failed to fetch repositories: \\\${(error as Error).message}\\\`);
        }
    });
};

/**
 * Deletes a repository. This is a destructive action.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves when the deletion is complete.
 */
export const deleteRepo = async (octokit: Octokit, owner: string, repo: string): Promise<void> => {
     return measurePerformance('deleteRepo', async () => {
        logEvent('deleteRepo_start', { owner, repo });
        try {
            await octokit.request('DELETE /repos/{owner}/{repo}', {
                owner,
                repo,
            });
            logEvent('deleteRepo_success', { owner, repo });
        } catch (error) {
            logError(error as Error, { context: 'deleteRepo', owner, repo });
            throw new Error(\\\`Failed to delete repository: \\\${(error as Error).message}\\\`);
        }
    });
};

// --- File and Tree Functions ---

/**
 * Fetches the file tree for a repository recursively.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to the root FileNode of the repository.
 */
export const getRepoTree = async (octokit: Octokit, owner: string, repo: string): Promise<FileNode> => {
     return measurePerformance('getRepoTree', async () => {
        logEvent('getRepoTree_start', { owner, repo });
        try {
            const { data: repoData } = await octokit.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defaultBranch = repoData.default_branch;

            const { data: branch } = await octokit.request('GET /repos/{owner}/{repo}/branches/{branch}', {
                owner,
                repo,
                branch: defaultBranch,
            });
            const treeSha = branch.commit.commit.tree.sha;
            
            const { data: treeData } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
                owner,
                repo,
                tree_sha: treeSha,
                recursive: 'true',
            });

            const root: FileNode = { name: repo, type: 'folder', path: '', children: [] };
            
            treeData.tree.forEach((item: any) => {
                const pathParts = item.path.split('/');
                let currentNode = root;

                pathParts.forEach((part) => {
                    if (!currentNode.children) {
                        currentNode.children = [];
                    }
                    let childNode = currentNode.children.find(child => child.name === part);

                    if (!childNode) {
                        childNode = {
                            name: part,
                            path: item.path,
                            type: item.type === 'tree' ? 'folder' : 'file',
                        };
                        if(item.type === 'tree') childNode.children = [];
                        currentNode.children.push(childNode);
                    }
                    currentNode = childNode;
                });
            });

            logEvent('getRepoTree_success', { owner, repo, items: treeData.tree.length });
            return root;
        } catch (error) {
            logError(error as Error, { context: 'getRepoTree', owner, repo });
            throw new Error(\\\`Failed to fetch repository tree: \\\${(error as Error).message}\\\`);
        }
    });
};

/**
 * Fetches the content of a specific file from a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param path The full path to the file within the repository.
 * @returns A promise that resolves to the string content of the file.
 */
export const getFileContent = async (octokit: Octokit, owner: string, repo: string, path: string): Promise<string> => {
    return measurePerformance('getFileContent', async () => {
        logEvent('getFileContent_start', { owner, repo, path });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                owner,
                repo,
                path,
            });

            if (Array.isArray(data) || data.type !== 'file' || typeof data.content !== 'string') {
                 throw new Error("Path did not point to a valid file or content was missing.");
            }

            // The content is Base64 encoded, so we need to decode it.
            const content = atob(data.content);
            logEvent('getFileContent_success', { owner, repo, path });
            return content;
        } catch (error) {
             logError(error as Error, { context: 'getFileContent', owner, repo, path });
             throw new Error(\\\`Failed to fetch file content: \\\${(error as Error).message}\\\`);
        }
    });
};

// --- Commit and Branching Functions ---

/**
 * Commits one or more files to a repository in a single commit.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param files An array of file objects with path and content.
 * @param message The commit message.
 * @param branch The branch to commit to (defaults to 'main').
 * @returns A promise that resolves with the URL of the new commit.
 */
export const commitFiles = async (
    octokit: Octokit,
    owner: string,
    repo: string,
    files: { path: string; content: string }[],
    message: string,
    branch: string = 'main'
): Promise<string> => {
    return measurePerformance('commitFiles', async () => {
        logEvent('commitFiles_start', { owner, repo, fileCount: files.length, branch });

        try {
            // 1. Get the latest commit SHA and base tree SHA
            const { data: refData } = await octokit.request('GET /repos/{owner}/{repo}/git/ref/{ref}', {
                owner,
                repo,
                ref: \\\`heads/\\\${branch}\\\`,
            });
            const latestCommitSha = refData.object.sha;
            const { data: commitData } = await octokit.request('GET /repos/{owner}/{repo}/git/commits/{commit_sha}', {
                owner,
                repo,
                commit_sha: latestCommitSha,
            });
            const baseTreeSha = commitData.tree.sha;

            // 2. Create blobs for all new file contents
            const blobPromises = files.map(file =>
                octokit.request('POST /repos/{owner}/{repo}/git/blobs', {
                    owner,
                    repo,
                    content: file.content,
                    encoding: 'utf-8',
                })
            );
            const blobs = await Promise.all(blobPromises);
            
            // 3. Create the tree object
            const tree = blobs.map((blob, index) => ({
                path: files[index].path,
                mode: '100644' as const, // file mode
                type: 'blob' as const,
                sha: blob.data.sha,
            }));

            // 4. Create a new tree
            const { data: newTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
                owner,
                repo,
                base_tree: baseTreeSha,
                tree,
            });

            // 5. Create a new commit
            const { data: newCommit } = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
                owner,
                repo,
                message,
                tree: newTree.sha,
                parents: [latestCommitSha],
            });

            // 6. Update the branch reference (fast-forward)
            await octokit.request('PATCH /repos/{owner}/{repo}/git/refs/{ref}', {
                owner,
                repo,
                ref: \\\`heads/\\\${branch}\\\`,
                sha: newCommit.sha,
            });

            logEvent('commitFiles_success', { commitUrl: newCommit.html_url });
            return newCommit.html_url;

        } catch (error) {
            logError(error as Error, { context: 'commitFiles', owner, repo, branch });
            throw new Error(\\\`Failed to commit files: \\\${(error as Error).message}\\\`);
        }
    });
};\`,
  'globals.d.ts': \`// globals.d.ts
declare global {
  /**
   * Loads the Pyodide WebAssembly module.
   * @param config Optional configuration for Pyodide.
   */
  function loadPyodide(config?: { indexURL?: string }): Promise<any>;

  interface Window {
    google?: {
      accounts: {
        id: {
          disableAutoSelect: () => void;
        };
      };
    };
  }
}

// This export statement is required to make the file a module.
export {};\`,
  'hooks/.placeholder': \`\`,
  'hooks/useAiPersonalities.ts': \`import { useLocalStorage } from './useLocalStorage.ts';
import type { SystemPrompt } from '../types.ts';

const defaultPersonalities: SystemPrompt[] = [
    {
        id: '1',
        name: 'Default Reviewer',
        persona: 'You are a senior software engineer performing a code review. You are meticulous, helpful, and provide constructive feedback.',
        rules: ['Be clear and concise.', 'Provide code examples for suggestions.', 'Explain the "why" behind your suggestions.'],
        outputFormat: 'markdown',
        exampleIO: []
    },
    {
        id: '2',
        name: 'Sarcastic Senior Dev',
        persona: 'You are a cynical, sarcastic, but brilliant senior software engineer. Your feedback is brutally honest and often humorous, but always technically correct.',
        rules: ['Use a sarcastic tone.', 'Point out rookie mistakes without mercy.', 'Your code suggestions must be flawless.'],
        outputFormat: 'markdown',
        exampleIO: [
            {
                input: 'I wrote this function: \\\`function add(a,b){return a+b}\\\`',
                output: 'Wow, a function that adds two numbers. Groundbreaking. Did you consider that maybe, just maybe, you should add a semicolon at the end? \\\`function add(a, b) { return a + b; };\\\`'
            }
        ]
    }
];


/**
 * A custom hook to access the list of saved AI personalities.
 * @returns An array of SystemPrompt objects.
 */
export const useAiPersonalities = (): [SystemPrompt[], (value: SystemPrompt[] | ((val: SystemPrompt[]) => SystemPrompt[])) => void] => {
    const [personalities, setPersonalities] = useLocalStorage<SystemPrompt[]>('devcore_ai_personalities', defaultPersonalities);
    return [personalities, setPersonalities];
};\`,
  'hooks/useLocalStorage.ts': \`import { useState } from 'react';

export const useLocalStorage = <T,>(key: string, initialValue: T) => {
    const [storedValue, setStoredValue] = useState<T>(() => {
        try {
            const consent = window.localStorage.getItem('devcore_ls_consent');
            if (consent !== 'granted') return initialValue;

            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
        } catch (error) {
            console.error(\\\`Error reading localStorage key “\\\${key}”:\\\`, error);
            return initialValue;
        }
    });

    const setValue = (value: T | ((val: T) => T)) => {
        try {
            const consent = window.localStorage.getItem('devcore_ls_consent');
            if (consent !== 'granted') {
                // If consent is not granted, only update the in-memory state
                const valueToStore = value instanceof Function ? value(storedValue) : value;
                setStoredValue(valueToStore);
                return;
            };

            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (error) {
            console.error(\\\`Error setting localStorage key “\\\${key}”:\\\`, error);
        }
    };

    return [storedValue, setValue] as const;
};\`,
  'hooks/useTheme.ts': \`import { useEffect } from 'react';
import { useLocalStorage } from './useLocalStorage.ts';
import type { ThemeState, ColorTheme, Theme } from '../types.ts';

const defaultThemeState: ThemeState = {
    mode: 'light',
    customColors: null,
};

const applyColors = (colors: ColorTheme | null) => {
    const root = window.document.documentElement;
    if (colors) {
        root.style.setProperty('--color-primary', colors.primary);
        root.style.setProperty('--color-background', colors.background);
        root.style.setProperty('--color-surface', colors.surface);
        root.style.setProperty('--color-text-primary', colors.textPrimary);
        root.style.setProperty('--color-text-secondary', colors.textSecondary);
        root.style.setProperty('--color-text-on-primary', colors.textOnPrimary);
        root.style.setProperty('--color-border', colors.border);
        const rgb = colors.primary.match(/\\\\w\\\\w/g)?.map(x => parseInt(x, 16));
        if (rgb) {
             root.style.setProperty('--color-primary-rgb', rgb.join(', '));
        }
    } else {
        // Clear inline styles to revert to CSS-defined variables
        root.style.removeProperty('--color-primary');
        root.style.removeProperty('--color-background');
        root.style.removeProperty('--color-surface');
        root.style.removeProperty('--color-text-primary');
        root.style.removeProperty('--color-text-secondary');
        root.style.removeProperty('--color-text-on-primary');
        root.style.removeProperty('--color-border');
        root.style.removeProperty('--color-primary-rgb');
    }
}

export const useTheme = (): [ThemeState, () => void, (colors: ColorTheme, mode: Theme) => void, () => void] => {
    const [themeState, setThemeState] = useLocalStorage<ThemeState>('devcore_theme_state', defaultThemeState);

    useEffect(() => {
        const root = window.document.documentElement;
        root.classList.remove('light', 'dark');
        root.classList.add(themeState.mode);
        applyColors(themeState.customColors);
    }, [themeState]);

    const toggleTheme = () => {
        setThemeState(prev => ({
            ...prev,
            mode: prev.mode === 'light' ? 'dark' : 'light'
        }));
    };
    
    const applyCustomTheme = (colors: ColorTheme, mode: Theme) => {
        setThemeState({ mode, customColors: colors });
    };

    const clearCustomTheme = () => {
        // We keep the mode, but clear custom colors
        setThemeState(prev => ({ ...prev, customColors: null }));
    };

    return [themeState, toggleTheme, applyCustomTheme, clearCustomTheme];
};
\`,
  'index.css': \`@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --color-primary: #0047AB; /* Cobalt Blue */
  --color-primary-rgb: 0, 71, 171;
  --color-background: #F5F7FA; /* Light silver-blue */
  --color-surface: #FFFFFF;
  --color-text-primary: #111827; /* Gray 900 */
  --color-text-secondary: #6B7280; /* Gray 500 */
  --color-text-on-primary: #FFFFFF;
  --color-border: #E5E7EB; /* Gray 200 */
}

.dark {
  --color-primary: #38bdf8; /* sky-400 */
  --color-primary-rgb: 56, 189, 248;
  --color-background: #0f172a; /* slate-900 */
  --color-surface: #1e293b; /* slate-800 */
  --color-text-primary: #f8fafc; /* slate-50 */
  --color-text-secondary: #94a3b8; /* slate-400 */
  --color-text-on-primary: #0f172a; /* slate-900 */
  --color-border: #334155; /* slate-700 */
}

/* Custom global styles */
body {
  @apply bg-background text-text-primary transition-colors duration-300;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

html.dark body {
    background-image: none;
}


#root {
  position: relative;
  z-index: 1;
}

#root::before {
  content: 'CitiBank demo business inc';
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-family: theme('fontFamily.serif');
  font-size: clamp(2rem, 8vw, 6rem); /* Responsive font size */
  font-weight: bold;
  color: theme('colors.gold');
  opacity: 0.08;
  pointer-events: none;
  z-index: -1;
  white-space: nowrap;
}

h1, h2, h3, h4, h5, h6 {
  @apply font-serif text-text-primary;
}

h1 {
  @apply text-text-primary;
}

/* Update primary buttons for a professional look */
.btn-primary {
  @apply bg-primary text-text-on-primary font-bold rounded-md hover:opacity-90 transition-all disabled:opacity-50 shadow-md;
}

/* Custom scrollbars for the new light theme */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  @apply bg-gray-100 dark:bg-slate-800;
}
::-webkit-scrollbar-thumb {
  @apply bg-gray-400 dark:bg-slate-600 rounded;
}
::-webkit-scrollbar-thumb:hover {
  @apply bg-gray-500 dark:bg-slate-500;
}

/* Base transitions for interactive elements */
button, a, input, textarea, select {
  transition: all 0.2s ease-in-out;
}

/* Keyframe Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes shake {
  10%, 90% { transform: translateX(-1px); }
  20%, 80% { transform: translateX(2px); }
  30%, 50%, 70% { transform: translateX(-3px); }
  40%, 60% { transform: translateX(3px); }
}

@keyframes pop-in {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
.animate-shake { animation: shake 0.4s ease-in-out; }
.animate-pop-in { animation: pop-in 0.3s ease-out forwards; }

/* For hiding scrollbar but keeping functionality */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { 
  -ms-overflow-style: none; 
  scrollbar-width: none; 
  scroll-behavior: smooth;
}\`,
  'index.html': \`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Citibank Demo Business Inc</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      html, body, #root {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
  <link rel="stylesheet" href="/index.css">
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "vite": "https://aistudiocdn.com/vite@^7.1.3",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "url": "https://aistudiocdn.com/url@^0.11.4",
    "marked": "https://aistudiocdn.com/marked@^16.2.0",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.15.0",
    "react-colorful": "https://aistudiocdn.com/react-colorful@^5.6.1",
    "mermaid": "https://aistudiocdn.com/mermaid@^11.10.1",
    "idb": "https://aistudiocdn.com/idb@^8.0.3",
    "axe-core": "https://aistudiocdn.com/axe-core@^4.10.3",
    "@tailwindcss/typography": "https://aistudiocdn.com/@tailwindcss/typography@^0.5.16",
    "diff": "https://aistudiocdn.com/diff@^8.0.2",
    "octokit": "https://aistudiocdn.com/octokit@^5.0.3",
    "jszip": "https://aistudiocdn.com/jszip@^3.10.1",
    "fs": "https://aistudiocdn.com/fs@^0.0.1-security"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script id="gsi-client" src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>\`,
  'index.tsx': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.tsx';
import { GlobalStateProvider } from './contexts/GlobalStateContext.tsx';
import './index.css';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <GlobalStateProvider>
        <App />
    </GlobalStateProvider>
  </React.StrictMode>
);\`,
  'metadata.json': \`{
  "name": "as",
  "description": "A scaffolded project with a professional directory structure for building scalable and maintainable front-end applications.",
  "requestFramePermissions": []
}\`,
  'package.json': \`{
  "name": "devcore-ai-toolkit",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "prebuild": "node --loader ts-node/esm ./scripts/generateSourceRegistry.ts",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.12.0",
    "axe-core": "^4.9.1",
    "diff": "^5.2.0",
    "idb": "^8.0.0",
    "jszip": "^3.10.1",
    "marked": "^13.0.2",
    "mermaid": "^10.9.1",
    "octokit": "^4.0.2",
    "react": "^18.2.0",
    "react-colorful": "^5.6.1",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@tailwindcss/typography": "^0.5.13",
    "@types/diff": "^5.2.1",
    "@types/jszip": "^3.4.1",
    "@types/marked": "^6.0.0",
    "@types/node": "^20.14.9",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "autoprefixer": "^10.4.19",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "ts-node": "^10.9.2",
    "typescript": "^5.5.2",
    "vite": "^7.1.2"
  }
}\`,
  'postcss.config.js': \`export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
\`,
  'public/.placeholder': \`\`,
  'public/mock-service-worker.js': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const MOCK_ROUTES = new Map();

self.addEventListener('install', (event) => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});

self.addEventListener('message', (event) => {
  if (event.data.type === 'SET_ROUTES') {
    const routes = event.data.routes || [];
    MOCK_ROUTES.clear();
    routes.forEach(route => {
        // Simple wildcard support
        const regex = new RegExp('^' + route.path.replace(/\\\\*/g, '.*') + '\\\$');
        MOCK_ROUTES.set(regex, {
            method: route.method,
            response: route.response,
        });
    });
  }
});

self.addEventListener('fetch', (event) => {
  const url = new URL(event.request.url);
  const path = url.pathname;
  const method = event.request.method;

  for (const [routeRegex, routeInfo] of MOCK_ROUTES.entries()) {
    if (routeRegex.test(path) && routeInfo.method === method) {
      event.respondWith(
        new Response(JSON.stringify(routeInfo.response.body), {
          status: routeInfo.response.status,
          headers: { 'Content-Type': 'application/json', ...routeInfo.response.headers },
        })
      );
      return;
    }
  }

  // If no mock route matches, fall back to the network.
  event.respondWith(fetch(event.request));
});
\`,
  'services/aiProviderState.ts': \`\`,
  'services/aiService.ts': \`import { GoogleGenAI, Type, GenerateContentResponse, FunctionDeclaration, Modality } from "@google/genai";
import type { GeneratedFile, StructuredPrSummary, StructuredExplanation, ColorTheme, SemanticColorTheme, StructuredReview, SlideSummary, SecurityVulnerability, CodeSmell } from '../types.ts';
import { logError } from './telemetryService.ts';
import { getDecryptedCredential, isUnlocked, isVaultInitialized } from './vaultService.ts';

let ai: GoogleGenAI | null = null;

export async function isApiKeyConfigured(): Promise<boolean> {
    const envKey = process.env.GEMINI_API_KEY;
    if (envKey && envKey !== 'undefined' && envKey !== '') return true;
    
    // Only check vault if it's initialized and unlocked.
    if (await isVaultInitialized() && isUnlocked()) {
        try {
            const vaultKey = await getDecryptedCredential('gemini_api_key');
            return !!vaultKey;
        } catch (e) {
            console.error("Could not check for API key in vault:", e);
            return false;
        }
    }
    return false;
}

export async function initializeAiClient(): Promise<GoogleGenAI> {
    if (ai) return ai;

    let apiKey = process.env.GEMINI_API_KEY;
    
    if (!apiKey || apiKey === 'undefined' || apiKey === '') {
        try {
             apiKey = await getDecryptedCredential('gemini_api_key');
        } catch(e) {
             throw new Error("Vault is locked. Cannot retrieve API Key.");
        }
    }
    
    if (!apiKey) {
      throw new Error("Gemini API key not found. Please provide it when prompted.");
    }
    
    ai = new GoogleGenAI({ apiKey });
    return ai;
}

const getAi = async () => {
    if (!ai) {
        return await initializeAiClient();
    }
    return ai;
}


const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// --- Unified AI Helpers ---

export async function* streamContent(prompt: string | { parts: any[] }, systemInstruction: string, temperature = 0.5) {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContentStream({
            model: 'gemini-2.5-flash',
            contents: prompt as any,
            config: { systemInstruction, temperature }
        });

        for await (const chunk of response) {
            yield chunk.text;
        }
    } catch (error) {
        console.error("Error streaming from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        if (error instanceof Error) {
            yield \\\`An error occurred while communicating with the AI model: \\\${error.message}\\\`;
        } else {
            yield "An unknown error occurred while generating the response.";
        }
    }
}

export async function generateContent(prompt: string, systemInstruction: string, temperature = 0.5): Promise<string> {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: { systemInstruction, temperature }
        });
        return response.text;
    } catch (error) {
         console.error("Error generating content from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        throw error;
    }
}


export async function generateJson<T>(prompt: any, systemInstruction: string, schema: any, temperature = 0.2): Promise<T> {
    try {
        const aiClient = await getAi();
        const response = await aiClient.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
            config: {
                systemInstruction,
                responseMimeType: "application/json",
                responseSchema: schema,
                temperature,
            }
        });
        return JSON.parse(response.text.trim());
    } catch (error) {
        console.error("Error generating JSON from AI model:", error);
        logError(error as Error, { prompt, systemInstruction });
        throw error;
    }
}


// --- Unified Feature Functions (Streaming) ---

export const explainCodeStream = (code: string) => streamContent(
    \\\`Please explain the following code snippet:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert software engineer providing a clear, concise explanation of code."
);

export const generateRegExStream = (description: string) => streamContent(
    \\\`Generate a single valid JavaScript regex literal (e.g., /abc/gi) for the following description. Respond with ONLY the regex literal and nothing else: "\\\${description}"\\\`,
    "You are an expert in regular expressions. You only output valid JavaScript regex literals.",
    0.7
);

export const generateCommitMessageStream = (diff: string) => streamContent(
    \\\`Generate a conventional commit message for the following context of new files being added:\\\\n\\\\n\\\${diff}\\\`,
    "You are an expert programmer who writes excellent, conventional commit messages. The response should be only the commit message text.",
    0.8
);

export const generateUnitTestsStream = (code: string) => streamContent(
    \\\`Generate Vitest unit tests for this React component code:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`tsx\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a software quality engineer specializing in writing comprehensive and clear unit tests using Vitest and React Testing Library.",
    0.6
);

export const formatCodeStream = (code: string) => streamContent(
    \\\`Format this code:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`javascript\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a code formatter. Your only purpose is to format code. Respond with only the formatted code, enclosed in a single markdown block.",
    0.2
);

export const generateComponentFromImageStream = (base64Image: string) => streamContent(
    {
        parts: [
            { text: "Generate a single-file React component using Tailwind CSS that looks like this image. Respond with only the code in a markdown block." },
            { inlineData: { mimeType: 'image/png', data: base64Image } }
        ]
    },
    "You are an expert frontend developer specializing in React and Tailwind CSS. You create clean, functional components from screenshots."
);

export const transcribeAudioToCodeStream = (base64Audio: string, mimeType: string) => streamContent(
    {
        parts: [
            { text: "Transcribe my speech into a code snippet. If I describe a function or component, write it out." },
            { inlineData: { mimeType, data: base64Audio } }
        ]
    },
    "You are an expert programmer. You listen to a user's voice and transcribe their ideas into code."
);

export const transferCodeStyleStream = (args: { code: string, styleGuide: string }) => streamContent(
    \\\`Rewrite the following code to match the provided style guide.\\\\n\\\\nStyle Guide:\\\\n\\\${args.styleGuide}\\\\n\\\\nCode to rewrite:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${args.code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an AI assistant that rewrites code to match a specific style guide. Respond with only the rewritten code in a markdown block.",
    0.3
);

export const generateCodingChallengeStream = (_: any) => streamContent(
    \\\`Generate a new, interesting coding challenge suitable for an intermediate developer. Include a clear problem description, one or two examples, and any constraints. Format it in markdown.\\\`,
    "You are an AI that creates unique and interesting coding challenges for software developers.",
    0.9
);

export const reviewCodeStream = (code: string, systemInstruction?: string) => streamContent(
    \\\`Please perform a detailed code review on the following code snippet. Identify potential bugs, suggest improvements for readability and performance, and point out any anti-patterns. Structure your feedback with clear headings.\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    systemInstruction || "You are a senior software engineer performing a code review. You are meticulous, helpful, and provide constructive feedback.",
    0.6
);

export const generateChangelogFromLogStream = (log: string) => streamContent(
    \\\`Analyze this git log and create a changelog:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${log}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a git expert and project manager. Analyze the provided git log and generate a clean, categorized changelog in Markdown format. Group changes under 'Features' and 'Fixes'.",
    0.6
);

export const enhanceSnippetStream = (code: string) => streamContent(
    \\\`Enhance this code snippet. Add comments, improve variable names, and refactor for clarity or performance if possible.\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a senior software engineer who excels at improving code. Respond with only the enhanced code in a markdown block.",
    0.5
);

export const summarizeNotesStream = (notes: string) => streamContent(
    \\\`Summarize these developer notes into a bulleted list of key points and action items:\\\\n\\\\n\\\${notes}\\\`,
    "You are a productivity assistant who is an expert at summarizing technical notes.",
    0.7
);

export const migrateCodeStream = (code: string, from: string, to: string) => streamContent(
    \\\`Translate this \\\${from} code to \\\${to}. Respond with only the translated code in a markdown block.\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    \\\`You are an expert polyglot programmer who specializes in migrating code between languages and frameworks.\\\`,
    0.4
);

export const analyzeConcurrencyStream = (code: string) => streamContent(
    \\\`Analyze this JavaScript code for potential concurrency issues, especially related to Web Workers. Identify race conditions, deadlocks, or inefficient data passing.\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`javascript\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert in JavaScript concurrency, web workers, and multi-threaded programming concepts.",
    0.6
);

export const debugErrorStream = (error: Error) => streamContent(
    \\\`I encountered an error in my React application. Here are the details:\\\\n    \\\\n    Message: \\\${error.message}\\\\n    \\\\n    Stack Trace:\\\\n    \\\${error.stack}\\\\n    \\\\n    Please analyze this error. Provide a brief explanation of the likely cause, followed by a bulleted list of potential solutions or debugging steps. Structure your response in clear, concise markdown.\\\`,
    "You are an expert software engineer specializing in debugging React applications. You provide clear, actionable advice to help developers solve errors."
);

export const convertJsonToXbrlStream = (json: string) => streamContent(
    \\\`Convert the following JSON to a simplified, XBRL-like XML format. Use meaningful tags based on the JSON keys. The root element should be <xbrl>. Do not include XML declarations or namespaces.\\\\n\\\\nJSON:\\\\n\\\${json}\\\`,
    "You are an expert in data formats who converts JSON to clean, XBRL-like XML."
);

// --- New Streaming Functions ---

export const refactorForPerformance = (code: string) => streamContent(
    \\\`Refactor the following code for maximum performance. Focus on algorithmic efficiency, efficient data structures, and avoiding unnecessary computations. Respond with only the refactored code in a markdown block.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert software engineer specializing in code performance optimization."
);

export const refactorForReadability = (code: string) => streamContent(
    \\\`Refactor the following code for maximum readability. Focus on clear variable names, breaking down complex functions, and adding helpful comments. Respond with only the refactored code in a markdown block.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert software engineer who writes exceptionally clean and readable code."
);

export const convertToFunctionalComponent = (classComponent: string) => streamContent(
    \\\`Convert the following React class component to a functional component using hooks (useState, useEffect, etc.). Ensure all lifecycle methods are correctly mapped. Respond with only the refactored code in a markdown block.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${classComponent}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a React expert specializing in modernizing codebases by converting class components to functional components with hooks."
);

export const generateJsDoc = (code: string) => streamContent(
    \\\`Generate a complete JSDoc block for the following function or component. Include descriptions for the function, its parameters, and what it returns. Respond with only the JSDoc block and the original function.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an AI assistant that writes comprehensive and accurate JSDoc documentation."
);

export const translateComments = (code: string, targetLanguage: string) => streamContent(
    \\\`Translate only the code comments in the following snippet to \\\${targetLanguage}. Do not alter the code itself. Respond with the full code snippet including the translated comments.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an AI assistant that translates code comments into different languages without changing any of the code."
);

export const generateDockerfile = (framework: string) => streamContent(
    \\\`Generate a basic, multi-stage Dockerfile for a \\\${framework} project. The Dockerfile should be production-ready, including build and serve stages. Respond with only the Dockerfile content in a markdown block.\\\`,
    "You are a DevOps expert specializing in containerization with Docker."
);

export const convertCssToTailwind = (css: string) => streamContent(
    \\\`Convert the following CSS code to Tailwind CSS utility classes. Provide the equivalent HTML structure with the Tailwind classes. Respond with only the HTML in a markdown block.\\\\n\\\\nCSS:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`css\\\\n\\\${css}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert in Tailwind CSS and modern CSS practices."
);

export const applySpecificRefactor = (code: string, instruction: string) => streamContent(
    \\\`Apply this specific refactoring instruction to the code: "\\\${instruction}". Respond with only the complete, refactored code in a markdown block.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an AI assistant that precisely applies refactoring instructions to code."
);

export const generateBugReproductionTestStream = (stackTrace: string, context?: string) => streamContent(
    \\\`Generate a minimal, runnable unit test (using Vitest) that reproduces the bug described by the following stack trace. Respond with only the code in a markdown block.\\\\n\\\\nStack Trace:\\\\n\\\${stackTrace}\\\\n\\\\n\\\${context ? \\\`Additional Context:\\\\n\\\${context}\\\` : ''}\\\`,
    "You are a senior software engineer specializing in debugging and automated testing. You create concise, effective unit tests to reproduce bugs."
);

export const generateIamPolicyStream = (description: string, platform: 'aws' | 'gcp') => streamContent(
    \\\`Generate a valid \\\${platform.toUpperCase()} IAM policy in JSON format based on this description: "\\\${description}". Respond with only the JSON policy in a markdown block.\\\`,
    "You are a cloud security expert specializing in IAM policies for AWS and GCP."
);


// --- Simple Generate Content ---
export const generatePipelineCode = (flow: string): Promise<string> => generateContent(\\\`Based on the following described workflow, generate a single asynchronous JavaScript function that orchestrates the steps. Use placeholder functions for the actual tool logic. The workflow is: \\\${flow}\\\`, "You are an expert software architect who writes clean, asynchronous JavaScript code to orchestrate complex workflows based on a description.", 0.5);

export const generateCiCdConfig = (platform: string, description: string): Promise<string> => generateContent(
    \\\`Generate a CI/CD configuration file for \\\${platform} based on this description: "\\\${description}". Respond with only the YAML/config file content inside a markdown block.\\\`,
    "You are a DevOps expert specializing in CI/CD pipelines."
);

export const analyzePerformanceTrace = (trace: object): Promise<string> => generateContent(
    \\\`Analyze the following performance trace data and provide optimization suggestions in markdown format. Data: \\\${JSON.stringify(trace, null, 2)}\\\`,
    "You are an expert performance engineer."
);

export const suggestA11yFix = (issue: object): Promise<string> => generateContent(
    \\\`Explain this accessibility issue and suggest a code fix in markdown. Issue: \\\${JSON.stringify(issue, null, 2)}\\\`,
    "You are an expert in web accessibility (a11y)."
);

export const createApiDocumentation = (apiCode: string): Promise<string> => generateContent(
    \\\`Generate Markdown documentation for the following API endpoint code. Include the endpoint, HTTP method, parameters, and example request/response.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${apiCode}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a technical writer who creates clear and concise API documentation."
);

export const jsonToTypescriptInterface = (json: string): Promise<string> => generateContent(
    \\\`Generate a TypeScript interface from this JSON object. Respond with only the TypeScript code in a markdown block.\\\\n\\\\nJSON:\\\\n\\\${json}\\\`,
    "You are an expert in TypeScript and data modeling."
);

export const suggestAlternativeLibraries = (code: string): Promise<string> => generateContent(
    \\\`Analyze the following code, particularly its import statements and common patterns (like date manipulation). Suggest modern, more efficient library alternatives where applicable (e.g., suggest 'date-fns' or 'dayjs' over 'moment.js'). Explain why.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are a senior software engineer with deep knowledge of the JavaScript ecosystem."
);

export const explainRegex = (regex: string): Promise<string> => generateContent(
    \\\`Provide a step-by-step explanation of what each part of this regular expression does: \\\\\\\`\\\${regex}\\\\\\\`\\\`,
    "You are an expert in regular expressions who can explain complex patterns simply."
);

export const generateMermaidJs = (code: string): Promise<string> => generateContent(
    \\\`Generate a Mermaid.js flowchart string that represents the logic of the following code. Respond with only the Mermaid.js code in a markdown block (e.g., \\\\\\\`\\\\\\\`\\\\\\\`mermaid\\\\n...\\\\n\\\\\\\`\\\\\\\`\\\\\\\`).\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`,
    "You are an expert in code analysis and can visualize logic flows using Mermaid.js."
);

export const generateWeeklyDigest = (commitLogs: string, telemetryData: object): Promise<string> => generateContent(
    \\\`Generate a concise, professional weekly summary email in HTML format based on the following data.
    
    Commit Logs:
    \\\\\\\`\\\\\\\`\\\\\\\`
    \\\${commitLogs}
    \\\\\\\`\\\\\\\`\\\\\\\`
    
    Performance Telemetry:
    \\\\\\\`\\\\\\\`\\\\\\\`json
    \\\${JSON.stringify(telemetryData, null, 2)}
    \\\\\\\`\\\\\\\`\\\\\\\`
    
    The email should have sections for "New Features", "Bug Fixes", and "Performance Notes". It should be visually clean and easy to read.\\\`,
    "You are an AI assistant that generates weekly engineering progress reports in HTML format."
);

export const generateTechnicalSpecFromDiff = (diff: string, summary: StructuredPrSummary): Promise<string> => generateContent(
    \\\`Generate a comprehensive technical specification document in Markdown format based on the following pull request information.

The spec should include the following sections:
- **Problem:** A brief description of the issue being addressed.
- **Solution:** A detailed explanation of the changes made.
- **Technical Details:** An overview of the implementation, including any new functions, components, or patterns.
- **Impact:** How this change affects other parts of the application.

**PR Title:** \\\${summary.title}
**PR Summary:** \\\${summary.summary}

**Code Diff:**
\\\\\\\`\\\\\\\`\\\\\\\`diff
\\\${diff}
\\\\\\\`\\\\\\\`\\\\\\\`
\\\`,
    "You are an expert programmer who writes excellent, clear, and comprehensive technical specification documents from pull request data."
);

// --- STRUCTURED JSON ---

export const explainCodeStructured = async (code: string): Promise<StructuredExplanation> => {
    const systemInstruction = "You are an expert software engineer providing a structured analysis of a code snippet. In the summary, identify any imported dependencies and explain their purpose within the code.";
    const prompt = \\\`Analyze this code: \\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = { type: Type.OBJECT, properties: { summary: { type: Type.STRING }, lineByLine: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { lines: { type: Type.STRING }, explanation: { type: Type.STRING } }, required: ["lines", "explanation"] } }, complexity: { type: Type.OBJECT, properties: { time: { type: Type.STRING }, space: { type: Type.STRING } }, required: ["time", "space"] }, suggestions: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["summary", "lineByLine", "complexity", "suggestions"] };
    return generateJson(prompt, systemInstruction, schema);
}

export const generateThemeFromDescription = async (description: string): Promise<ColorTheme> => {
    const systemInstruction = "You are a UI/UX design expert specializing in color theory. Generate a color theme based on the user's description. Provide hex codes for each color.";
    const prompt = \\\`Generate a color theme for: "\\\${description}"\\\`;
    const schema = { type: Type.OBJECT, properties: { primary: { type: Type.STRING }, background: { type: Type.STRING }, surface: { type: Type.STRING }, textPrimary: { type: Type.STRING }, textSecondary: { type: Type.STRING }, textOnPrimary: { type: Type.STRING }, border: { type: Type.STRING } }, required: ["primary", "background", "surface", "textPrimary", "textSecondary", "textOnPrimary", "border"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateSemanticTheme = (prompt: { parts: any[] }): Promise<SemanticColorTheme> => {
    const systemInstruction = \\\`You are a world-class UI/UX designer with an expert understanding of color theory, accessibility, and branding.
    Your task is to generate a comprehensive, semantically named color theme from a user's prompt (which could be text or an image).
    - Determine if the theme should be 'light' or 'dark' mode.
    - Palette colors should be harmonious and versatile.
    - Theme colors must be derived from the palette and assigned to specific UI roles (background, text, border, etc.).
    - 'textOnPrimary' MUST have a high contrast ratio against 'primary'.
    - You MUST calculate the WCAG 2.1 contrast ratio for key text/background pairs and provide a score (AAA, AA, or Fail).
    - Provide creative, evocative names for each color (e.g., "Midnight Blue", "Dune Sand").\\\`;

    const colorObjectSchema = {
        type: Type.OBJECT,
        properties: {
            value: { type: Type.STRING, description: "The hex code of the color, e.g., #RRGGBB" },
            name: { type: Type.STRING, description: "A creative, evocative name for the color." }
        },
        required: ["value", "name"]
    };

    const accessibilityCheckSchema = {
        type: Type.OBJECT,
        properties: {
            ratio: { type: Type.NUMBER, description: "The calculated contrast ratio." },
            score: { type: Type.STRING, enum: ["AAA", "AA", "Fail"], description: "The WCAG 2.1 accessibility score." }
        },
        required: ["ratio", "score"]
    };

    const schema = {
        type: Type.OBJECT,
        properties: {
            mode: {
                type: Type.STRING, enum: ["light", "dark"],
                description: "The recommended UI mode for this theme, 'light' or 'dark'."
            },
            palette: {
                type: Type.OBJECT,
                description: "A harmonious 4-color palette extracted from the prompt.",
                properties: {
                    primary: colorObjectSchema,
                    secondary: colorObjectSchema,
                    accent: colorObjectSchema,
                    neutral: colorObjectSchema,
                },
                required: ["primary", "secondary", "accent", "neutral"]
            },
            theme: {
                type: Type.OBJECT,
                description: "Specific color assignments for UI elements, derived from the palette.",
                properties: {
                    background: colorObjectSchema,
                    surface: colorObjectSchema,
                    textPrimary: colorObjectSchema,
                    textSecondary: colorObjectSchema,
                    textOnPrimary: colorObjectSchema,
                    border: colorObjectSchema,
                },
                required: ["background", "surface", "textPrimary", "textSecondary", "textOnPrimary", "border"]
            },
            accessibility: {
                type: Type.OBJECT,
                description: "WCAG 2.1 contrast ratio checks for common text/background pairings.",
                properties: {
                    primaryOnSurface: accessibilityCheckSchema,
                    textPrimaryOnSurface: accessibilityCheckSchema,
                    textSecondaryOnSurface: accessibilityCheckSchema,
                    textOnPrimaryOnPrimary: accessibilityCheckSchema,
                },
                required: ["primaryOnSurface", "textPrimaryOnSurface", "textSecondaryOnSurface", "textOnPrimaryOnPrimary"]
            }
        },
        required: ["mode", "palette", "theme", "accessibility"]
    };
    return generateJson(prompt, systemInstruction, schema);
};


export const generatePrSummaryStructured = (diff: string): Promise<StructuredPrSummary> => {
    const systemInstruction = "You are an expert programmer who writes excellent PR summaries.";
    const prompt = \\\`Generate a PR summary for the following diff:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`diff\\\\n\\\${diff}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = { type: Type.OBJECT, properties: { title: { type: Type.STRING }, summary: { type: Type.STRING }, changes: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["title", "summary", "changes"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateFeature = (prompt: string, framework: string, styling: string): Promise<GeneratedFile[]> => {
    const systemInstruction = \\\`You are an AI that generates complete, production-ready components. Create all necessary files for the requested framework and styling option.
    IMPORTANT: When the user's prompt is about maps, location, addresses, or stores, you MUST use the Google Maps JavaScript API. Generate a component that accepts an 'apiKey' prop and uses it to load the Maps script.\\\`;
    const userPrompt = \\\`Generate the files for a \\\${framework} component using \\\${styling} for the following feature request: "\\\${prompt}". Make sure to include a .tsx component file.\\\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(userPrompt, systemInstruction, schema);
};

export const generateFullStackFeature = (prompt: string, framework: string, styling: string): Promise<GeneratedFile[]> => {
    const systemInstruction = \\\`You are an AI that generates complete, production-ready full-stack features.
    You must generate three files:
    1. A frontend \\\${framework} component using \\\${styling}. File path should be 'Component.tsx'.
    2. A backend Google Cloud Function in Node.js. File path should be a simple HTTP-triggered function.
    3. Firestore Security Rules that allow public reads but only authenticated writes. File path should be 'firestore.rules'.
    Ensure the frontend component knows how to call the cloud function.
    IMPORTANT: When the user's prompt is about maps, location, addresses, or stores, you MUST prioritize using the Google Maps JavaScript API in the frontend component. Generate a component that accepts an 'apiKey' prop and uses it to load the Maps script.\\\`;
    const userPrompt = \\\`Generate a full-stack feature for: "\\\${prompt}"\\\`;
    const schema = {
        type: Type.ARRAY,
        items: {
            type: Type.OBJECT,
            properties: {
                filePath: { type: Type.STRING, enum: ['Component.tsx', 'functions/index.js', 'firestore.rules'] },
                content: { type: Type.STRING },
                description: { type: Type.STRING }
            },
            required: ["filePath", "content", "description"]
        }
    };
    return generateJson(userPrompt, systemInstruction, schema);
};

export interface CronParts { minute: string; hour: string; dayOfMonth: string; month: string; dayOfWeek: string; }
export const generateCronFromDescription = (description: string): Promise<CronParts> => {
    const systemInstruction = "You are an expert in cron expressions. Convert the user's description into a valid cron expression parts.";
    const prompt = \\\`Convert this schedule to a cron expression: "\\\${description}"\\\`;
    const schema = { type: Type.OBJECT, properties: { minute: { type: Type.STRING }, hour: { type: Type.STRING }, dayOfMonth: { type: Type.STRING }, month: { type: Type.STRING }, dayOfWeek: { type: Type.STRING } }, required: ["minute", "hour", "dayOfMonth", "month", "dayOfWeek"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateColorPalette = (baseColor: string): Promise<{ colors: string[] }> => {
    const systemInstruction = "You are a color theory expert. Generate a 6-color palette based on the given base color.";
    const prompt = \\\`Generate a harmonious 6-color palette based on the color \\\${baseColor}.\\\`;
    const schema = { type: Type.OBJECT, properties: { colors: { type: Type.ARRAY, items: { type: Type.STRING } } }, required: ["colors"] };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateMockData = (description: string, count: number): Promise<object[]> => {
    const systemInstruction = "You are an expert data scientist who creates realistic mock data based on a schema description. You must respond with only a valid JSON array of objects.";
    const prompt = \\\`Generate an array of \\\${count} mock data objects based on the following schema description. Respond with only the JSON array.\\\\n\\\\nSchema: "\\\${description}"\\\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: {} }}; // Freeform objects
    return generateJson(prompt, systemInstruction, schema, 0.8);
};

export const analyzeCodeForVulnerabilities = (code: string): Promise<SecurityVulnerability[]> => {
    const systemInstruction = "You are an expert security engineer. Analyze the code for vulnerabilities. For each vulnerability, provide a structured response including a potential cURL command or code snippet to demonstrate the exploit.";
    const prompt = \\\`Analyze this code for security issues like XSS, injection, hardcoded secrets, etc. Provide detailed explanations, mitigation advice, and an exploit suggestion.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = {
        type: Type.ARRAY,
        items: {
            type: Type.OBJECT,
            properties: {
                vulnerability: { type: Type.STRING },
                severity: { type: Type.STRING, enum: ['Critical', 'High', 'Medium', 'Low', 'Informational'] },
                description: { type: Type.STRING },
                mitigation: { type: Type.STRING },
                exploitSuggestion: { type: Type.STRING, description: "A cURL command, code snippet, or description of how to exploit the vulnerability." }
            },
            required: ['vulnerability', 'severity', 'description', 'mitigation', 'exploitSuggestion']
        }
    };
    return generateJson(prompt, systemInstruction, schema);
};

export const sqlToApiEndpoints = (schema: string, framework: 'express' | 'fastify'): Promise<GeneratedFile[]> => {
    const systemInstruction = "You are an expert backend developer who generates boilerplate CRUD API endpoints from a SQL schema.";
    const prompt = \\\`Generate boilerplate CRUD API endpoint files for a \\\${framework} server based on the following SQL table schema. Create separate files for routes, controllers, and models.\\\\n\\\\nSQL:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`sql\\\\n\\\${schema}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(prompt, systemInstruction, filesSchema);
};

export const detectCodeSmells = (code: string): Promise<CodeSmell[]> => {
    const systemInstruction = "You are an expert software engineer who identifies code smells like long methods, large classes, feature envy, etc.";
    const prompt = \\\`Analyze the following code for code smells and provide explanations.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { smell: { type: Type.STRING }, line: { type: Type.INTEGER }, explanation: { type: Type.STRING } }, required: ["smell", "line", "explanation"] } };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateTagsForCode = (code: string): Promise<string[]> => {
    const systemInstruction = "You are an AI assistant that analyzes code and suggests relevant tags.";
    const prompt = \\\`Generate 3-5 relevant, single-word, lowercase tags for this code snippet to help categorize it. Respond with only a JSON array of strings.\\\\n\\\\nCode:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = { type: Type.ARRAY, items: { type: Type.STRING } };
    return generateJson(prompt, systemInstruction, schema);
};

export const reviewCodeStructured = (code: string): Promise<StructuredReview> => {
    const systemInstruction = "You are a senior software engineer performing a meticulous code review. Provide a summary and a list of specific, actionable suggestions for improvement.";
    const prompt = \\\`Review this code and provide structured feedback:\\\\n\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${code}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const schema = {
        type: Type.OBJECT,
        properties: {
            summary: { type: Type.STRING, description: "A high-level summary of the code quality, identifying the main issues." },
            suggestions: {
                type: Type.ARRAY,
                items: {
                    type: Type.OBJECT,
                    properties: {
                        suggestion: { type: Type.STRING, description: "A concise description of the suggested change." },
                        codeBlock: { type: Type.STRING, description: "The exact block of code that should be replaced." },
                        explanation: { type: Type.STRING, description: "Why the change is recommended (e.g., performance, readability)." }
                    },
                    required: ["suggestion", "codeBlock", "explanation"]
                }
            }
        },
        required: ["summary", "suggestions"]
    };
    return generateJson(prompt, systemInstruction, schema);
};

export const generateClientFromApiSchema = (schema: string, framework: string): Promise<GeneratedFile[]> => {
    const systemInstruction = "You are an expert full-stack developer. Generate client-side code from an API schema.";
    const prompt = \\\`Generate all necessary files for a \\\${framework} client based on the following OpenAPI/GraphQL schema. This should include data-fetching hooks, type definitions, and basic display components.\\\\n\\\\nSchema:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${schema}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\`;
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(prompt, systemInstruction, filesSchema);
};

export const generateTerraformConfig = (cloud: 'aws' | 'gcp', description: string, context?: string): Promise<string> => {
    const systemInstruction = \\\`You are a DevOps expert specializing in Terraform. Generate a complete .tf file based on the user's description.\\\`;
    const prompt = \\\`Generate a Terraform configuration for \\\${cloud}.
    Description: "\\\${description}"
    \\\${context ? \\\`\\\\n\\\\nCloud Context (e.g., existing resources):\\\\n\\\${context}\\\` : ''}
    Respond with only the HCL code in a markdown block.\\\`;
    return generateContent(prompt, systemInstruction);
};


// --- FUNCTION CALLING ---
export interface CommandResponse { text: string; functionCalls?: { name: string; args: any; }[]; }
export const getInferenceFunction = async (prompt: string, functionDeclarations: FunctionDeclaration[], knowledgeBase: string): Promise<CommandResponse> => {
    try {
        const aiClient = await getAi();
        const response: GenerateContentResponse = await aiClient.models.generateContent({ model: "gemini-2.5-flash", contents: prompt, config: { systemInstruction: \\\`You are a helpful assistant for a developer tool. You must decide which function to call to satisfy the user's request, based on your knowledge base. If no specific tool seems appropriate, respond with text.\\\\n\\\\nKnowledge Base:\\\\n\\\${knowledgeBase}\\\`, tools: [{ functionDeclarations }] } });
        const functionCalls: { name: string, args: any }[] = [];
        const parts = response.candidates?.[0]?.content?.parts ?? [];
        for (const part of parts) { if (part.functionCall) { functionCalls.push({ name: part.functionCall.name, args: part.functionCall.args }); } }
        return { text: response.text, functionCalls: functionCalls.length > 0 ? functionCalls : undefined };
    } catch (error) {
        logError(error as Error, { prompt });
        throw error;
    }
};


// --- IMAGE & VIDEO GENERATION ---
export const generateImage = async (prompt: string): Promise<string> => {
    const aiClient = await getAi();
    const response = await aiClient.models.generateImages({
        model: 'imagen-4.0-generate-001',
        prompt: prompt,
        config: { numberOfImages: 1, outputMimeType: 'image/png' },
    });
    const base64ImageBytes: string = response.generatedImages[0].image.imageBytes;
    return \\\`data:image/png;base64,\\\${base64ImageBytes}\\\`;
};

export const generateImageFromImageAndText = async (prompt: string, base64Image: string, mimeType: string): Promise<string> => {
    const aiClient = await getAi();
    const response = await aiClient.models.generateContent({
        model: 'gemini-2.5-flash-image-preview',
        contents: {
            parts: [
                { inlineData: { data: base64Image, mimeType: mimeType } },
                { text: prompt },
            ],
        },
        config: {
            responseModalities: [Modality.IMAGE, Modality.TEXT],
        },
    });

    for (const part of response.candidates[0].content.parts) {
        if (part.inlineData) {
            const base64ImageBytes: string = part.inlineData.data;
            return \\\`data:\\\${part.inlineData.mimeType};base64,\\\${base64ImageBytes}\\\`;
        }
    }

    throw new Error("AI did not return an image. It may have refused the request.");
};


export const generateMultiComponentFlowFromVideo = async (videoBase64: string, mimeType: string, onUpdate: (message: string) => void): Promise<GeneratedFile[]> => {
    const aiClient = await getAi();
    const systemInstruction = "You are an expert frontend developer. Analyze the user flow in this screen recording and generate all the necessary React components and routing logic to replicate it. Create separate files for each component.";
    
    onUpdate("Starting video analysis...");
    let operation = await aiClient.models.generateVideos({
      model: 'veo-2.0-generate-001',
      prompt: "A short, silent video showing a user interacting with a web UI. Transcribe the actions and UI elements into a step-by-step description of the user flow.",
      config: { numberOfVideos: 1 }
    });

    onUpdate("Video processing initiated. This may take several minutes...");
    while (!operation.done) {
      await sleep(10000);
      onUpdate("Checking video status...");
      operation = await aiClient.operations.getVideosOperation({operation: operation});
    }

    onUpdate("Video processing complete. Generating code from flow...");
    // This is a conceptual placeholder. A real implementation would require a multimodal model that can output structured data from video.
    const flowDescription = operation.response?.generatedVideos?.[0]?.video?.uri || "A user clicks a list item, sees a detail page, and clicks a button.";
    
    const filesSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { filePath: { type: Type.STRING }, content: { type: Type.STRING }, description: { type: Type.STRING } }, required: ["filePath", "content", "description"] } };
    return generateJson(flowDescription, systemInstruction, filesSchema);
};\`,
  'services/auditing/.placeholder': \`\`,
  'services/auditing/accessibilityService.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
import * as axe from 'axe-core';

// Configure axe-core to be less noisy in the console
axe.configure({
    reporter: 'v2',
    rules: [
        { id: 'region', enabled: false } // A common false positive in isolated components
    ]
});

export type AxeResult = axe.AxeResults;

/**
 * Runs an axe accessibility audit on a given HTML element.
 * @param context The element or selector string to run the audit on.
 * @returns A promise that resolves with the axe audit results.
 */
export const runAxeAudit = async (context: axe.ElementContext): Promise<AxeResult> => {
    try {
        const results = await axe.run(context, {
             resultTypes: ['violations', 'incomplete']
        });
        return results;
    } catch (error) {
        console.error('Error running axe audit:', error);
        throw new Error('Accessibility audit failed to execute.');
    }
};\`,
  'services/authService.ts': \`import { Octokit } from 'octokit';
import type { GitHubUser as User } from '../types.ts';
import { logEvent } from './telemetryService.ts';

/**
 * Creates a new Octokit instance with the provided token.
 * This function is now stateless and should be called with a plaintext token
 * that has been securely decrypted from the vault just before use.
 * @param token The plaintext GitHub Personal Access Token.
 * @returns A new Octokit instance.
 */
export const initializeOctokit = (token: string): Octokit => {
    if (!token) {
        throw new Error("Cannot initialize Octokit without a token.");
    }
    logEvent('octokit_initialized');
    return new Octokit({ auth: token, request: { headers: { 'X-GitHub-Api-Version': '2022-11-28' } } });
};

/**
 * Validates a plaintext token by fetching the user profile.
 * @param token The plaintext GitHub token to validate.
 * @returns A promise that resolves to the user's profile information.
 */
export const validateToken = async (token: string): Promise<User> => {
    const tempOctokit = new Octokit({ auth: token });
    const { data: user } = await tempOctokit.request('GET /user');
    return user as unknown as User;
};\`,
  'services/componentLoader.ts': \`import React, { lazy } from 'react';

/**
 * A wrapper around React.lazy to retry loading a component if it fails.
 * This is useful for handling "chunk load failed" errors that can occur
 * when a user has an old version of the site and a new version is deployed.
 *
 * @param componentImport A function that returns a dynamic import, e.g., () => import('./MyComponent')
 * @param exportName The named export of the component to be loaded.
 * @returns A lazy-loaded React component.
 */
export const lazyWithRetry = <T extends React.ComponentType<any>>(
    componentImport: () => Promise<{ [key: string]: T }>,
    exportName: string
) => {
    return lazy(async () => {
        const MAX_RETRIES = 3;
        const RETRY_DELAY_MS = 1000;

        for (let i = 0; i < MAX_RETRIES; i++) {
            try {
                const module = await componentImport();
                if (module[exportName]) {
                    return { default: module[exportName] };
                }
                // This would be a developer error (wrong export name), not a chunk load error.
                throw new Error(\\\`Named export '\\\${exportName}' not found in module.\\\`);
            } catch (error) {
                console.error(error); // Log error for debugging
                if (i < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                } else {
                    // After all retries, force a page reload.
                    // This is the most effective way to solve stale chunk issues after a new deployment.
                    console.error("Failed to load component after multiple retries. Reloading page.");
                    window.location.reload();
                    // Throw to allow an ErrorBoundary to catch this, although reload will likely intervene.
                    throw error;
                }
            }
        }
        // This part of the code should not be reachable
        throw new Error('Component failed to load and retries were exhausted.');
    });
};\`,
  'services/cryptoService.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const KEY_ALGORITHM = 'AES-GCM';
const KEY_LENGTH = 256;
const PBKDF2_ALGORITHM = 'PBKDF2';
const PBKDF2_HASH = 'SHA-256';
const PBKDF2_ITERATIONS = 100000;
const SALT_LENGTH_BYTES = 16;
const IV_LENGTH_BYTES = 12;

const textEncoder = new TextEncoder();
const textDecoder = new TextDecoder();

/**
 * Derives a cryptographic key from a master password and a salt using PBKDF2.
 * @param password The master password string.
 * @param salt The salt as an ArrayBuffer.
 * @returns A promise that resolves to a CryptoKey.
 */
export const deriveKey = async (password: string, salt: ArrayBuffer): Promise<CryptoKey> => {
    const masterKey = await crypto.subtle.importKey(
        'raw',
        textEncoder.encode(password),
        { name: PBKDF2_ALGORITHM },
        false,
        ['deriveKey']
    );

    return await crypto.subtle.deriveKey(
        {
            name: PBKDF2_ALGORITHM,
            salt,
            iterations: PBKDF2_ITERATIONS,
            hash: PBKDF2_HASH,
        },
        masterKey,
        { name: KEY_ALGORITHM, length: KEY_LENGTH },
        true,
        ['encrypt', 'decrypt']
    );
};

/**
 * Generates a cryptographically secure random salt.
 * @returns A new salt as an ArrayBuffer.
 */
export const generateSalt = (): ArrayBuffer => {
    return crypto.getRandomValues(new Uint8Array(SALT_LENGTH_BYTES)).buffer;
};

/**
 * Encrypts a plaintext string using a derived key.
 * @param plaintext The string to encrypt.
 * @param key The CryptoKey to use for encryption.
 * @returns A promise that resolves to an object containing the encrypted data (ciphertext), and the initialization vector (iv).
 */
export const encrypt = async (plaintext: string, key: CryptoKey): Promise<{ ciphertext: ArrayBuffer, iv: Uint8Array }> => {
    const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH_BYTES));
    const encodedPlaintext = textEncoder.encode(plaintext);

    const ciphertext = await crypto.subtle.encrypt(
        {
            name: KEY_ALGORITHM,
            iv,
        },
        key,
        encodedPlaintext
    );

    return { ciphertext, iv };
};

/**
 * Decrypts a ciphertext ArrayBuffer using a derived key and IV.
 * @param ciphertext The ArrayBuffer of the encrypted data.
 * @param key The CryptoKey to use for decryption.
 * @param iv The initialization vector used during encryption.
 * @returns A promise that resolves to the decrypted plaintext string.
 */
export const decrypt = async (ciphertext: ArrayBuffer, key: CryptoKey, iv: Uint8Array): Promise<string> => {
    const decrypted = await crypto.subtle.decrypt(
        {
            name: KEY_ALGORITHM,
            iv,
        },
        key,
        ciphertext
    );

    return textDecoder.decode(decrypted);
};
\`,
  'services/dbService.ts': \`import { openDB, DBSchema } from 'idb';
import type { GeneratedFile, EncryptedData } from '../types.ts';

const DB_NAME = 'devcore-db';
const DB_VERSION = 2;
const FILES_STORE_NAME = 'generated-files';
const VAULT_STORE_NAME = 'vault-data';
const ENCRYPTED_TOKENS_STORE_NAME = 'encrypted-tokens';


interface DevCoreDB extends DBSchema {
  [FILES_STORE_NAME]: {
    key: string;
    value: GeneratedFile;
    indexes: { 'by-filePath': string };
  };
  [VAULT_STORE_NAME]: {
    key: string;
    value: any;
  };
  [ENCRYPTED_TOKENS_STORE_NAME]: {
    key: string;
    value: EncryptedData;
  };
}

const dbPromise = openDB<DevCoreDB>(DB_NAME, DB_VERSION, {
  upgrade(db, oldVersion) {
    switch (oldVersion) {
        case 0: {
            const store = db.createObjectStore(FILES_STORE_NAME, {
                keyPath: 'filePath',
            });
            store.createIndex('by-filePath', 'filePath');
        }
        // fall-through for new installations
        case 1: {
            if (!db.objectStoreNames.contains(VAULT_STORE_NAME)) {
                db.createObjectStore(VAULT_STORE_NAME);
            }
            if (!db.objectStoreNames.contains(ENCRYPTED_TOKENS_STORE_NAME)) {
                db.createObjectStore(ENCRYPTED_TOKENS_STORE_NAME, { keyPath: 'id' });
            }
        }
    }
  },
});

// --- Generated Files Store ---
export const saveFile = async (file: GeneratedFile): Promise<void> => {
  const db = await dbPromise;
  await db.put(FILES_STORE_NAME, file);
};

export const getAllFiles = async (): Promise<GeneratedFile[]> => {
  const db = await dbPromise;
  return db.getAll(FILES_STORE_NAME);
};

export const getFileByPath = async (filePath: string): Promise<GeneratedFile | undefined> => {
  const db = await dbPromise;
  return db.get(FILES_STORE_NAME, filePath);
};

export const clearAllFiles = async (): Promise<void> => {
  const db = await dbPromise;
  await db.clear(FILES_STORE_NAME);
};

// --- Vault Store ---
export const saveVaultData = async (key: string, value: any): Promise<void> => {
  const db = await dbPromise;
  await db.put(VAULT_STORE_NAME, value, key);
};

export const getVaultData = async (key: string): Promise<any | undefined> => {
  const db = await dbPromise;
  return db.get(VAULT_STORE_NAME, key);
};

// --- Encrypted Tokens Store ---
export const saveEncryptedToken = async (data: EncryptedData): Promise<void> => {
  const db = await dbPromise;
  await db.put(ENCRYPTED_TOKENS_STORE_NAME, data);
};

export const getEncryptedToken = async (id: string): Promise<EncryptedData | undefined> => {
  const db = await dbPromise;
  return db.get(ENCRYPTED_TOKENS_STORE_NAME, id);
};

export const getAllEncryptedTokenIds = async (): Promise<string[]> => {
    const db = await dbPromise;
    return db.getAllKeys(ENCRYPTED_TOKENS_STORE_NAME);
};


// --- Global Actions ---
export const clearAllData = async (): Promise<void> => {
    const db = await dbPromise;
    await db.clear(FILES_STORE_NAME);
    await db.clear(VAULT_STORE_NAME);
    await db.clear(ENCRYPTED_TOKENS_STORE_NAME);
}\`,
  'services/fileUtils.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

/**
 * A robust way to convert an ArrayBuffer to a Base64 string.
 * @param buffer The ArrayBuffer to convert.
 * @returns The Base64 encoded string.
 */
const arrayBufferToBase64 = (buffer: ArrayBuffer): string => {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
};

/**
 * Converts a Blob object to a Base64 encoded string.
 * This implementation uses readAsArrayBuffer for greater robustness across environments.
 * @param blob The Blob object to convert.
 * @returns A promise that resolves with the Base64 string.
 */
export const blobToBase64 = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            resolve(arrayBufferToBase64(reader.result as ArrayBuffer));
        };
        reader.onerror = (error) => reject(error);
        reader.readAsArrayBuffer(blob);
    });
};

/**
 * Converts a File object to a Base64 encoded string.
 * This function is an alias for blobToBase64.
 * @param file The File object to convert.
 * @returns A promise that resolves with the Base64 string.
 */
export const fileToBase64 = (file: File): Promise<string> => {
    return blobToBase64(file);
};

/**
 * Converts a Blob object to a Data URL string.
 * This implementation uses readAsArrayBuffer for greater robustness across environments.
 * This function keeps the Data URL prefix (e.g., "data:image/png;base64,").
 * @param blob The Blob object to convert.
 * @returns A promise that resolves with the Data URL string.
 */
export const blobToDataURL = (blob: Blob): Promise<string> => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64 = arrayBufferToBase64(reader.result as ArrayBuffer);
            resolve(\\\`data:\\\${blob.type};base64,\\\${base64}\\\`);
        };
        reader.onerror = (error) => reject(error);
        reader.readAsArrayBuffer(blob);
    });
};

/**
 * Triggers a browser download for the given content.
 * @param content The string content to download.
 * @param filename The name of the file.
 * @param mimeType The MIME type of the file.
 */
export const downloadFile = (content: string, filename: string, mimeType: string = 'text/plain') => {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

/**
 * Generates and triggers a download for a .env formatted file.
 * @param env A record of key-value pairs for the environment variables.
 */
export const downloadEnvFile = (env: Record<string, string>): void => {
    const content = Object.entries(env)
        .map(([key, value]) => \\\`\\\${key}=\\\${JSON.stringify(value)}\\\`)
        .join('\\\\n');
    downloadFile(content, '.env', 'text/plain');
};

/**
 * Generates and triggers a download for a JSON file.
 * @param data The JavaScript object to stringify and download.
 * @param filename The name of the file.
 */
export const downloadJson = (data: object, filename: string): void => {
    const content = JSON.stringify(data, null, 2);
    downloadFile(content, filename, 'application/json');
};\`,
  'services/gcpService.ts': \`import { ensureGapiClient } from './googleApiService.ts';
import { logError, measurePerformance } from './telemetryService.ts';

declare var gapi: any;

/**
 * Tests a set of permissions against a specified GCP resource.
 * @param resource The full resource name of the GCP resource (e.g., '//cloudresourcemanager.googleapis.com/projects/my-project').
 * @param permissions An array of permission strings to test (e.g., ['storage.objects.create', 'storage.objects.get']).
 * @returns A promise that resolves with the API response, containing the set of permissions the caller is allowed.
 */
export const testIamPermissions = async (resource: string, permissions: string[]): Promise<{ permissions: string[] }> => {
    return measurePerformance('gcp.testIamPermissions', async () => {
        try {
            const isReady = await ensureGapiClient();
            if (!isReady) throw new Error("Google API client not ready.");

            // The resource name for IAM API is slightly different
            const iamResourcePath = resource.startsWith('//') ? resource.substring(2) : resource;

            const response = await gapi.client.iam.permissions.testIamPermissions({
                resource: iamResourcePath,
                resource_body: { permissions }
            });

            return response.result;
        } catch (error) {
            logError(error as Error, {
                service: 'gcpService',
                function: 'testIamPermissions',
                resource
            });
            // Re-throw a more user-friendly error
            const gapiError = error as any;
            if (gapiError.result?.error?.message) {
                 throw new Error(\\\`GCP API Error: \\\${gapiError.result.error.message}\\\`);
            }
            throw error;
        }
    });
};\`,
  'services/geminiService.ts': \`\`,
  'services/githubService.ts': \`import type { Octokit } from 'octokit';
import type { Repo, FileNode } from '../types.ts';
import { logEvent, logError, measurePerformance } from './index.ts';

// --- Repository-Level Functions ---

/**
 * Fetches the repositories for the authenticated user.
 * @param octokit An authenticated Octokit instance.
 * @returns A promise that resolves to an array of Repo objects.
 */
export const getRepos = async (octokit: Octokit): Promise<Repo[]> => {
    return measurePerformance('getRepos', async () => {
        logEvent('getRepos_start');
        try {
            const { data } = await octokit.request('GET /user/repos', {
                type: 'owner',
                sort: 'updated',
                per_page: 100,
            });
            logEvent('getRepos_success', { count: data.length });
            return data as Repo[];
        } catch (error) {
            logError(error as Error, { context: 'getRepos' });
            throw error;
        }
    });
};

/**
 * Deletes a repository. This is a destructive action.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves when the deletion is complete.
 */
export const deleteRepo = async (octokit: Octokit, owner: string, repo: string): Promise<void> => {
     return measurePerformance('deleteRepo', async () => {
        logEvent('deleteRepo_start', { owner, repo });
        try {
            await octokit.request('DELETE /repos/{owner}/{repo}', {
                owner,
                repo,
            });
            logEvent('deleteRepo_success', { owner, repo });
        } catch (error) {
            logError(error as Error, { context: 'deleteRepo', owner, repo });
            throw error;
        }
    });
};

/**
 * Fetches the last 30 commits for a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to an array of commit objects.
 */
export const getCommitHistory = async (octokit: Octokit, owner: string, repo: string): Promise<any[]> => {
    return measurePerformance('getCommitHistory', async () => {
        logEvent('getCommitHistory_start', { owner, repo });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/commits', {
                owner,
                repo,
                per_page: 30,
            });
            logEvent('getCommitHistory_success', { count: data.length });
            return data;
        } catch (error) {
            logError(error as Error, { context: 'getCommitHistory' });
            throw error;
        }
    });
};

// --- File and Tree Functions ---

/**
 * Fetches the file tree for a repository recursively.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @returns A promise that resolves to the root FileNode of the repository.
 */
export const getRepoTree = async (octokit: Octokit, owner: string, repo: string): Promise<FileNode> => {
     return measurePerformance('getRepoTree', async () => {
        logEvent('getRepoTree_start', { owner, repo });
        try {
            const { data: repoData } = await octokit.request('GET /repos/{owner}/{repo}', { owner, repo });
            const defaultBranch = repoData.default_branch;

            const { data: branch } = await octokit.request('GET /repos/{owner}/{repo}/branches/{branch}', {
                owner,
                repo,
                branch: defaultBranch,
            });
            const treeSha = branch.commit.commit.tree.sha;
            
            const { data: treeData } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
                owner,
                repo,
                tree_sha: treeSha,
                recursive: 'true',
            });

            const root: FileNode = { name: repo, type: 'folder', path: '', children: [] };
            
            treeData.tree.forEach((item: any) => {
                const pathParts = item.path.split('/');
                let currentNode = root;

                pathParts.forEach((part, index) => {
                    if (!currentNode.children) {
                        currentNode.children = [];
                    }
                    const currentPath = pathParts.slice(0, index + 1).join('/');
                    let childNode = currentNode.children.find(child => child.name === part && child.path === currentPath);

                    if (!childNode) {
                        childNode = {
                            name: part,
                            path: item.path,
                            type: item.type === 'tree' ? 'folder' : 'file',
                        };
                        if(item.type === 'tree') {
                            childNode.children = [];
                            childNode.path = currentPath; 
                        }
                        currentNode.children.push(childNode);
                    }
                    currentNode = childNode;
                });
            });

            logEvent('getRepoTree_success', { owner, repo, items: treeData.tree.length });
            return root;
        } catch (error) {
            logError(error as Error, { context: 'getRepoTree', owner, repo });
            throw new Error(\\\`Failed to fetch repository tree: \\\${(error as Error).message}\\\`);
        }
    });
};

/**
 * Fetches the content of a specific file from a repository.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param path The full path to the file within the repository.
 * @returns A promise that resolves to the string content of the file.
 */
export const getFileContent = async (octokit: Octokit, owner: string, repo: string, path: string): Promise<string> => {
    return measurePerformance('getFileContent', async () => {
        logEvent('getFileContent_start', { owner, repo, path });
        try {
            const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                owner,
                repo,
                path,
            });

            if (Array.isArray(data) || data.type !== 'file' || typeof data.content !== 'string') {
                 throw new Error("Path did not point to a valid file or content was missing.");
            }

            // The content is Base64 encoded, so we need to decode it.
            const content = atob(data.content);
            logEvent('getFileContent_success', { owner, repo, path });
            return content;
        } catch (error) {
             logError(error as Error, { context: 'getFileContent', owner, repo, path });
             throw new Error(\\\`Failed to fetch file content: \\\${(error as Error).message}\\\`);
        }
    });
};

// --- Commit and Branching Functions ---

/**
 * Commits one or more files to a repository in a single commit.
 * @param octokit An authenticated Octokit instance.
 * @param owner The repository owner's login.
 * @param repo The repository name.
 * @param files An array of file objects with path and content.
 * @param message The commit message.
 * @param branch The branch to commit to (defaults to 'main').
 * @returns A promise that resolves with the URL of the new commit.
 */
export const commitFiles = async (
    octokit: Octokit,
    owner: string,
    repo: string,
    files: { path: string; content: string }[],
    message: string,
    branch: string = 'main'
): Promise<string> => {
    return measurePerformance('commitFiles', async () => {
        logEvent('commitFiles_start', { owner, repo, fileCount: files.length, branch });

        try {
            // 1. Get the latest commit SHA and base tree SHA
            const { data: refData } = await octokit.request('GET /repos/{owner}/{repo}/git/ref/{ref}', {
                owner,
                repo,
                ref: \\\`heads/\\\${branch}\\\`,
            });
            const latestCommitSha = refData.object.sha;
            const { data: commitData } = await octokit.request('GET /repos/{owner}/{repo}/git/commits/{commit_sha}', {
                owner,
                repo,
                commit_sha: latestCommitSha,
            });
            const baseTreeSha = commitData.tree.sha;

            // 2. Create blobs for all new file contents
            const blobPromises = files.map(file =>
                octokit.request('POST /repos/{owner}/{repo}/git/blobs', {
                    owner,
                    repo,
                    content: file.content,
                    encoding: 'utf-8',
                })
            );
            const blobs = await Promise.all(blobPromises);
            
            // 3. Create the tree object
            const tree = blobs.map((blob, index) => ({
                path: files[index].path,
                mode: '100644' as const, // file mode
                type: 'blob' as const,
                sha: blob.data.sha,
            }));

            // 4. Create a new tree
            const { data: newTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
                owner,
                repo,
                base_tree: baseTreeSha,
                tree,
            });

            // 5. Create a new commit
            const { data: newCommit } = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
                owner,
                repo,
                message,
                tree: newTree.sha,
                parents: [latestCommitSha],
            });

            // 6. Update the branch reference (fast-forward)
            await octokit.request('PATCH /repos/{owner}/{repo}/git/refs/{ref}', {
                owner,
                repo,
                ref: \\\`heads/\\\${branch}\\\`,
                sha: newCommit.sha,
            });

            logEvent('commitFiles_success', { commitUrl: newCommit.html_url });
            return newCommit.html_url;

        } catch (error) {
            logError(error as Error, { context: 'commitFiles', owner, repo, branch });
            throw new Error(\\\`Failed to commit files: \\\${(error as Error).message}\\\`);
        }
    });
};\`,
  'services/googleApiService.ts': \`// services/googleApiService.ts
const API_KEY = process.env.GEMINI_API_KEY;
const CLIENT_ID = "555179712981-36hlicm802genhfo9iq1ufnp1n8cikt9.apps.googleusercontent.com";

declare global { interface Window { gapi: any; } }

let gapiInitialized = false;

const loadGapiScript = () => new Promise<void>((resolve, reject) => {
    if (window.gapi) {
        window.gapi.load('client', resolve);
        return;
    };
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.onload = () => window.gapi.load('client', resolve);
    script.onerror = reject;
    document.body.appendChild(script);
});

export const ensureGapiClient = async (): Promise<boolean> => {
    if (gapiInitialized) return true;
    
    try {
        await loadGapiScript();

        await window.gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
                "https://docs.googleapis.com/\\\$discovery/rest?version=v1",
                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
                "https://iam.googleapis.com/\\\$discovery/rest?version=v1"
            ],
        });

        const accessToken = sessionStorage.getItem('google_access_token');
        if (!accessToken) {
            console.error("GAPI: Access token not found. User may need to sign in again.");
            return false;
        }
        
        window.gapi.client.setToken({ access_token: accessToken });
        gapiInitialized = true;
        return true;
    } catch (error) {
        console.error("GAPI client initialization failed:", error);
        gapiInitialized = false;
        return false;
    }
};\`,
  'services/googleAuthService.ts': \`import type { AppUser } from '../types.ts';
import { logError } from './telemetryService.ts';

declare global {
  const google: any;
}

const GOOGLE_CLIENT_ID = "555179712981-36hlicm802genhfo9iq1ufnp1n8cikt9.apps.googleusercontent.com";

const SCOPES = [
    'openid',
    'https://www.googleapis.com/auth/userinfo.profile',
    'https://www.googleapis.com/auth/userinfo.email',
    'https://www.googleapis.com/auth/drive.appdata',
    'https://www.googleapis.com/auth/drive.install',
    'https://www.googleapis.com/auth/drive.file',
    'https://www.googleapis.com/auth/iam.test',
    'https://www.googleapis.com/auth/gmail.addons.current.action.compose',
    'https://www.googleapis.com/auth/gmail.addons.current.message.action'
].join(' ');

let tokenClient: any;
let onUserChangedCallback: (user: AppUser | null) => void = () => {};

const getGoogleUserProfile = async (accessToken: string) => {
    const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: \\\`Bearer \\\${accessToken}\\\` },
    });
    if (!response.ok) {
        throw new Error('Failed to fetch user profile');
    }
    return response.json();
};

export function initGoogleAuth(callback: (user: AppUser | null) => void) {
  if (!GOOGLE_CLIENT_ID) {
    console.error('Google Client ID not configured.');
    return;
  }
  onUserChangedCallback = callback;
  
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: async (tokenResponse: any) => {
      if (tokenResponse && tokenResponse.access_token) {
        sessionStorage.setItem('google_access_token', tokenResponse.access_token);
        try {
            const profile = await getGoogleUserProfile(tokenResponse.access_token);
            const appUser: AppUser = {
                uid: profile.sub, // 'sub' is the standard OIDC field for user ID
                displayName: profile.name,
                email: profile.email,
                photoURL: profile.picture,
                tier: 'free',
            };
            onUserChangedCallback(appUser);
        } catch (error) {
            logError(error as Error, { context: 'googleAuthInitCallback' });
            onUserChangedCallback(null);
        }
      } else {
        logError(new Error('Google sign-in failed: No access token received.'), { tokenResponse });
        onUserChangedCallback(null);
      }
    },
  });
}

export function signInWithGoogle() {
  if (tokenClient) {
    tokenClient.requestAccessToken({ prompt: 'consent' });
  } else {
    logError(new Error("Google Token Client not initialized."));
  }
}

export function signOutUser() {
  const token = sessionStorage.getItem('google_access_token');
  if (token && window.google) {
      google.accounts.oauth2.revoke(token, () => {
        console.log('Google token revoked');
      });
  }
  sessionStorage.removeItem('google_access_token');
  onUserChangedCallback(null);
}\`,
  'services/index.ts': \`

export * from './aiService.ts';
export * from './fileUtils.ts';
export * from './telemetryService.ts';
export * from './dbService.ts';
export * from './googleAuthService.ts';
export * from './githubService.ts';
export * from './componentLoader.ts';
export * from './taxonomyService.ts';
export * from './mocking/mockServer.ts';
export * from './mocking/db.ts';
export * from './profiling/performanceService.ts';
export * from './profiling/bundleAnalyzer.ts';
export * from './auditing/accessibilityService.ts';
export * from './security/staticAnalysisService.ts';
export * from './googleApiService.ts';
export * from './workspaceService.ts';
export * from './gcpService.ts';
export * from './workspaceConnectorService.ts';\`,
  'services/mocking/.placeholder': \`\`,
  'services/mocking/db.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import { openDB, DBSchema } from 'idb';

const DB_NAME = 'devcore-mock-db';
const DB_VERSION = 1;
const STORE_NAME = 'mock-collections';

interface MockDB extends DBSchema {
  [STORE_NAME]: {
    key: string;
    value: {
        id: string;
        schemaDescription: string;
        data: any[];
    };
  };
}

const dbPromise = openDB<MockDB>(DB_NAME, DB_VERSION, {
  upgrade(db) {
    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
  },
});

export const saveMockCollection = async (collection: { id: string; schemaDescription: string; data: any[] }): Promise<void> => {
  const db = await dbPromise;
  await db.put(STORE_NAME, collection);
};

export const getMockCollection = async (id: string): Promise<{ id: string; schemaDescription: string; data: any[] } | undefined> => {
  const db = await dbPromise;
  return db.get(STORE_NAME, id);
};

export const getAllMockCollections = async (): Promise<{ id: string; schemaDescription: string; data: any[] }[]> => {
    const db = await dbPromise;
    return db.getAll(STORE_NAME);
}

export const deleteMockCollection = async (id: string): Promise<void> => {
  const db = await dbPromise;
  await db.delete(STORE_NAME, id);
};
\`,
  'services/mocking/mockServer.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

const SERVICE_WORKER_URL = '/mock-service-worker.js';
let registration: ServiceWorkerRegistration | null = null;

export const startMockServer = (): Promise<void> => {
    return new Promise(async (resolve, reject) => {
        if (!('serviceWorker' in navigator)) {
            return reject(new Error('Service workers are not supported in this browser.'));
        }
        
        try {
            registration = await navigator.serviceWorker.register(SERVICE_WORKER_URL);
            
            if (registration.installing) {
                registration.installing.addEventListener('statechange', () => {
                    if (registration.installing?.state === 'installed') {
                        // The new worker is installed, now wait for it to activate
                    }
                });
            }

            if (registration.active) {
                 console.log('Mock Service Worker already active.');
                 return resolve();
            }

            // Wait for the worker to become active
            await navigator.serviceWorker.ready;
            console.log('Mock Service Worker registered and ready with scope:', registration.scope);
            resolve();
            
        } catch (error) {
            console.error('Mock Service Worker registration failed:', error);
            reject(new Error('Could not start mock server.'));
        }
    });
};

export const stopMockServer = async (): Promise<void> => {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
        await reg.unregister();
        registration = null;
        console.log('Mock Service Worker unregistered.');
    }
};

export const isMockServerRunning = (): boolean => {
    // Check registration and controller status to determine if server is active.
    return !!registration && !!navigator.serviceWorker.controller;
};

interface MockRoute {
    path: string; // e.g., /api/users/*
    method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';
    response: {
        status: number;
        body: any;
        headers?: Record<string, string>;
    }
}

export const setMockRoutes = (routes: MockRoute[]): void => {
    if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'SET_ROUTES',
            routes
        });
        console.log('Mock routes sent to service worker:', routes);
    } else {
        console.warn('Mock server is not active. Routes were not set.');
    }
};\`,
  'services/profiling/.placeholder': \`\`,
  'services/profiling/bundleAnalyzer.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface BundleStatsNode {
    name: string;
    value: number;
    children?: BundleStatsNode[];
}

// This is a simplified parser for Vite's \\\`stats.json\\\` output.
// A real-world implementation would need to handle different formats (Webpack, Rollup, etc.).
export const parseViteStats = (statsJson: string): BundleStatsNode => {
    try {
        const stats = JSON.parse(statsJson);
        const root: BundleStatsNode = { name: 'root', value: 0, children: [] };

        if (stats.output) { // Vite 5+ stats format
             Object.entries(stats.output).forEach(([path, chunk]: [string, any]) => {
                const node: BundleStatsNode = {
                    name: path,
                    value: chunk.size,
                };
                root.children?.push(node);
                root.value += chunk.size;
            });
        }

        return root;
    } catch (error) {
        console.error("Failed to parse bundle stats:", error);
        throw new Error("Invalid stats JSON format.");
    }
};
\`,
  'services/profiling/performanceService.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface TraceEntry {
    name: string;
    startTime: number;
    duration: number;
    entryType: 'mark' | 'measure';
}

let isTracing = false;
const TRACE_PREFIX = 'devcore-trace-';

export const startTracing = (): void => {
    if (isTracing) {
        console.warn('Tracing is already active.');
        return;
    }
    performance.clearMarks();
    performance.clearMeasures();
    isTracing = true;
    console.log('Performance tracing started.');
};

export const stopTracing = (): TraceEntry[] => {
    if (!isTracing) {
        console.warn('Tracing is not active.');
        return [];
    }
    isTracing = false;
    console.log('Performance tracing stopped.');

    const entries = performance.getEntries().filter(
        entry => entry.name.startsWith(TRACE_PREFIX)
    );

    performance.clearMarks();
    performance.clearMeasures();

    return entries.map(entry => ({
        name: entry.name.replace(TRACE_PREFIX, ''),
        startTime: entry.startTime,
        duration: entry.duration,
        entryType: entry.entryType as 'mark' | 'measure',
    }));
};

export const mark = (name: string): void => {
    if (!isTracing) return;
    performance.mark(\\\`\\\${TRACE_PREFIX}\\\${name}\\\`);
};

export const measure = (name: string, startMark: string, endMark: string): void => {
    if (!isTracing) return;
    try {
        performance.measure(\\\`\\\${TRACE_PREFIX}\\\${name}\\\`, \\\`\\\${TRACE_PREFIX}\\\${startMark}\\\`, \\\`\\\${TRACE_PREFIX}\\\${endMark}\\\`);
    } catch (e) {
        console.error(\\\`Failed to measure '\\\${name}'\\\`, e);
    }
};
\`,
  'services/security/.placeholder': \`\`,
  'services/security/staticAnalysisService.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

export interface SecurityIssue {
    line: number;
    type: string;
    description: string;
    severity: 'High' | 'Medium' | 'Low';
}

const rules = [
    {
        name: 'Hardcoded Secret',
        regex: /(key|secret|token|password)['"]?\\\\s*[:=]\\\\s*['"]([a-zA-Z0-9-_.]{16,})['"]/gi,
        description: 'A hardcoded secret or API key was found. These should be stored in environment variables.',
        severity: 'High' as const,
    },
    {
        name: 'dangerouslySetInnerHTML',
        regex: /dangerouslySetInnerHTML/g,
        description: 'Use of dangerouslySetInnerHTML can open your application to XSS attacks. Ensure the source is sanitized.',
        severity: 'Medium' as const,
    },
    {
        name: 'eval() usage',
        regex: /eval\\\\(/g,
        description: 'The use of eval() is a major security risk as it can execute arbitrary code.',
        severity: 'High' as const,
    },
    {
        name: 'Insecure URL',
        regex: /http:\\\\/\\\\//g,
        description: 'Found an insecure "http://" URL. Use "https://" for all external resources.',
        severity: 'Low' as const,
    }
];

export const runStaticScan = (code: string): SecurityIssue[] => {
    const issues: SecurityIssue[] = [];
    const lines = code.split('\\\\n');

    lines.forEach((line, index) => {
        rules.forEach(rule => {
            if (rule.regex.test(line)) {
                issues.push({
                    line: index + 1,
                    type: rule.name,
                    description: rule.description,
                    severity: rule.severity,
                });
            }
        });
    });

    return issues;
};
\`,
  'services/sourceRegistry.ts': \`// This file is a registry of all source code files in the application.
// It's used by the ActionManager to create a downloadable zip of the entire app source.

export const sourceFiles: Record<string, string> = {
  'index.html': \\\`<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Citibank Demo Business Inc</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
      html, body, #root {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
  <link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    <script id="gsi-client" src="https://accounts.google.com/gsi/client" async defer></script>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>\\\`,
  'index.tsx': \\\`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.tsx';
import { GlobalStateProvider } from './contexts/GlobalStateContext.tsx';
import './index.css';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <GlobalStateProvider>
      <App />
    </GlobalStateProvider>
  </React.StrictMode>
);\\\`,
  'App.tsx': \\\`
import React, { Suspense, useCallback, useMemo, useState, useEffect } from 'react';
import { ErrorBoundary } from './components/ErrorBoundary.tsx';
import { useGlobalState } from './contexts/GlobalStateContext.tsx';
import { logEvent } from './services/telemetryService.ts';
import { ALL_FEATURES, FEATURES_MAP } from './components/features/index.ts';
import type { ViewType, SidebarItem, AppUser } from './types.ts';
import { ActionManager } from './components/ActionManager.tsx';
import { LeftSidebar } from './components/LeftSidebar.tsx';
import { StatusBar } from './components/StatusBar.tsx';
import { CommandPalette } from './components/CommandPalette.tsx';
import { SettingsView } from './components/SettingsView.tsx';
import { Cog6ToothIcon, HomeIcon, FolderIcon, RectangleGroupIcon } from './components/icons.tsx';
import { AiCommandCenter } from './components/features/AiCommandCenter.tsx';
import { NotificationProvider } from './contexts/NotificationContext.tsx';
import { useTheme } from './hooks/useTheme.ts';
import { VaultProvider } from './components/vault/VaultProvider.tsx';
import { initGoogleAuth } from './services/googleAuthService.ts';


export const LoadingIndicator: React.FC = () => (
    <div className="w-full h-full flex items-center justify-center bg-surface">
        <div className="flex items-center justify-center space-x-2">
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.2s' }}></div>
            <div className="w-4 h-4 rounded-full bg-primary animate-pulse" style={{ animationDelay: '0.4s' }}></div>
            <span className="text-text-secondary ml-2">Loading Feature...</span>
        </div>
    </div>
);

interface LocalStorageConsentModalProps {
  onAccept: () => void;
  onDecline: () => void;
}

const LocalStorageConsentModal: React.FC<LocalStorageConsentModalProps> = ({ onAccept, onDecline }) => {
  return (
    <div className="fixed inset-0 bg-gray-900/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
      <div 
        className="bg-surface border border-border rounded-2xl shadow-2xl shadow-black/50 w-full max-w-md m-4 p-8 text-center animate-pop-in"
      >
        <h2 className="text-2xl mb-4">Store Data Locally?</h2>
        <p className="text-text-secondary mb-6">
          This application uses your browser's local storage to save your settings and remember your progress between sessions. This data stays on your computer and is not shared.
        </p>
        <div className="flex justify-center gap-4">
          <button
            onClick={onDecline}
            className="px-6 py-2 bg-surface border border-border text-text-primary font-bold rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
          >
            Decline
          </button>
          <button
            onClick={onAccept}
            className="btn-primary px-6 py-2"
          >
            Accept
          </button>
        </div>
      </div>
    </div>
  );
};

const AppContent: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { activeView, viewProps, hiddenFeatures } = state;
    const [isCommandPaletteOpen, setCommandPaletteOpen] = useState(false);
  
    useEffect(() => {
      const handleKeyDown = (e: KeyboardEvent) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              setCommandPaletteOpen(isOpen => !isOpen);
          }
      };
      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }, []);
  
    const handleViewChange = useCallback((view: ViewType, props: any = {}) => {
      dispatch({ type: 'SET_VIEW', payload: { view, props } });
      logEvent('view_changed', { view });
      setCommandPaletteOpen(false);
    }, [dispatch]);
  
    const sidebarItems: SidebarItem[] = useMemo(() => {
        const coreFeatures = ['ai-command-center', 'project-explorer', 'workspace-connector-hub'];
        return [
            { id: 'ai-command-center', label: 'Command Center', icon: <HomeIcon />, view: 'ai-command-center' },
            { id: 'project-explorer', label: 'Project Explorer', icon: <FolderIcon />, view: 'project-explorer' },
            { id: 'workspace-connector-hub', label: 'Workspace Hub', icon: <RectangleGroupIcon />, view: 'workspace-connector-hub' },
            ...ALL_FEATURES
                .filter(feature => !hiddenFeatures.includes(feature.id) && !coreFeatures.includes(feature.id))
                .map(feature => ({
                    id: feature.id,
                    label: feature.name,
                    icon: feature.icon,
                    view: feature.id as ViewType,
                })),
            { id: 'settings', label: 'Settings', icon: <Cog6ToothIcon />, view: 'settings' },
        ];
    }, [hiddenFeatures]);
  
    const ActiveComponent = useMemo(() => {
        if (activeView === 'settings') return SettingsView;
        return FEATURES_MAP.get(activeView as string)?.component ?? AiCommandCenter;
    }, [activeView]);
    
    return (
        <div className="relative flex h-full w-full">
            <LeftSidebar items={sidebarItems} activeView={state.activeView} onNavigate={handleViewChange} />
            <div className="flex-1 flex min-w-0">
                <div className="flex-1 flex flex-col min-w-0">
                    <main className="relative flex-1 min-w-0 bg-surface/50 dark:bg-slate-900/50 overflow-y-auto">
                        <ErrorBoundary>
                            <Suspense fallback={<LoadingIndicator />}>
                                <div key={activeView} className="fade-in w-full h-full">
                                    <ActiveComponent {...viewProps} />
                                </div>
                            </Suspense>
                        </ErrorBoundary>
                        <ActionManager />
                    </main>
                    <StatusBar bgImageStatus="loaded" />
                </div>
            </div>
            <CommandPalette isOpen={isCommandPaletteOpen} onClose={() => setCommandPaletteOpen(false)} onSelect={handleViewChange} />
        </div>
    )
}


const App: React.FC = () => {
    const [showConsentModal, setShowConsentModal] = useState(false);
    const { dispatch } = useGlobalState();
    useTheme(); // Initialize theme hook

    useEffect(() => {
      try {
          const consent = localStorage.getItem('devcore_ls_consent');
          if (!consent) {
              setShowConsentModal(true);
          }
      } catch (e) {
          console.warn("Could not access localStorage.", e);
      }
    }, []);

    useEffect(() => {
        const handleUserChanged = (user: AppUser | null) => {
            dispatch({ type: 'SET_APP_USER', payload: user });
        };

        const init = () => {
            if (window.google) {
                initGoogleAuth(handleUserChanged);
            }
        };

        const gsiScript = document.getElementById('gsi-client');
        if (window.google) {
            init();
        } else if (gsiScript) {
            gsiScript.addEventListener('load', init);
            return () => gsiScript.removeEventListener('load', init);
        }
    }, [dispatch]);
  
    const handleAcceptConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'granted');
          window.location.reload();
      } catch (e) {
          console.error("Could not write to localStorage.", e);
          setShowConsentModal(false);
      }
    };
  
    const handleDeclineConsent = () => {
      try {
          localStorage.setItem('devcore_ls_consent', 'denied');
      } catch (e) {
          console.error("Could not write to localStorage.", e);
      }
      setShowConsentModal(false);
    };

    return (
        <div className="h-screen w-screen font-sans overflow-hidden bg-background">
            <NotificationProvider>
                <VaultProvider>
                    {showConsentModal && <LocalStorageConsentModal onAccept={handleAcceptConsent} onDecline={handleDeclineConsent} />}
                    <AppContent />
                </VaultProvider>
            </NotificationProvider>
        </div>
    );
};

export default App;
\\\`,
  // Add all other application files here...
  'index.css': \\\`@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --color-primary: #0047AB; /* Cobalt Blue */
  --color-primary-rgb: 0, 71, 171;
  --color-background: #F5F7FA; /* Light silver-blue */
  --color-surface: #FFFFFF;
  --color-text-primary: #111827; /* Gray 900 */
  --color-text-secondary: #6B7280; /* Gray 500 */
  --color-text-on-primary: #FFFFFF;
  --color-border: #E5E7EB; /* Gray 200 */
}

.dark {
  --color-primary: #38bdf8; /* sky-400 */
  --color-primary-rgb: 56, 189, 248;
  --color-background: #0f172a; /* slate-900 */
  --color-surface: #1e293b; /* slate-800 */
  --color-text-primary: #f8fafc; /* slate-50 */
  --color-text-secondary: #94a3b8; /* slate-400 */
  --color-text-on-primary: #0f172a; /* slate-900 */
  --color-border: #334155; /* slate-700 */
}

/* Custom global styles */
body {
  @apply bg-background text-text-primary transition-colors duration-300;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

html.dark body {
    background-image: none;
}


#root {
  position: relative;
  z-index: 1;
}

#root::before {
  content: 'CitiBank demo business inc';
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-30deg);
  font-family: theme('fontFamily.serif');
  font-size: clamp(2rem, 8vw, 6rem); /* Responsive font size */
  font-weight: bold;
  color: theme('colors.gold');
  opacity: 0.08;
  pointer-events: none;
  z-index: -1;
  white-space: nowrap;
}

h1, h2, h3, h4, h5, h6 {
  @apply font-serif text-text-primary;
}

h1 {
  @apply text-text-primary;
}

/* Update primary buttons for a professional look */
.btn-primary {
  @apply bg-primary text-text-on-primary font-bold rounded-md hover:opacity-90 transition-all disabled:opacity-50 shadow-md;
}

/* Custom scrollbars for the new light theme */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  @apply bg-gray-100 dark:bg-slate-800;
}
::-webkit-scrollbar-thumb {
  @apply bg-gray-400 dark:bg-slate-600 rounded;
}
::-webkit-scrollbar-thumb:hover {
  @apply bg-gray-500 dark:bg-slate-500;
}

/* Base transitions for interactive elements */
button, a, input, textarea, select {
  transition: all 0.2s ease-in-out;
}

/* Keyframe Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes shake {
  10%, 90% { transform: translateX(-1px); }
  20%, 80% { transform: translateX(2px); }
  30%, 50%, 70% { transform: translateX(-3px); }
  40%, 60% { transform: translateX(3px); }
}

@keyframes pop-in {
  from {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
.animate-shake { animation: shake 0.4s ease-in-out; }
.animate-pop-in { animation: pop-in 0.3s ease-out forwards; }

/* For hiding scrollbar but keeping functionality */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { 
  -ms-overflow-style: none; 
  scrollbar-width: none; 
  scroll-behavior: smooth;
}\\\`,
  'tailwind.config.js': \\\`import typography from '@tailwindcss/typography';

/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class',
  content: [
    "./index.html",
    "./App.tsx",
    "./index.tsx",
    "./constants.ts",
    "./types.ts",
    "./components/**/*.{js,ts,jsx,tsx}",
    "./contexts/**/*.{js,ts,jsx,tsx}",
    "./hooks/**/*.{js,ts,jsx,tsx}",
    "./services/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        serif: ['"EB Garamond"', 'serif'],
        calligraphy: ['"Great Vibes"', 'cursive'],
      },
      colors: {
        'primary': 'var(--color-primary)',
        'background': 'var(--color-background)',
        'surface': 'var(--color-surface)',
        'text': {
          'primary': 'var(--color-text-primary)',
          'secondary': 'var(--color-text-secondary)',
          'on-primary': 'var(--color-text-on-primary)',
        },
        'border': 'var(--color-border)',
        'gold': '#B8860B', // DarkGoldenRod - better for watermark
      },
       boxShadow: {
        'focus-primary': '0 0 0 3px rgba(var(--color-primary-rgb), 0.4)',
        'md': '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
      },
    },
  },
  plugins: [
     typography,
  ],
}\\\`,
  'vite.config.ts': \\\`

import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');

    return {
      optimizeDeps: {
        exclude: [
          'axe-core'
        ]
      },
      define: {
        // The API key is injected into the app during the build process.
        // It's crucial that this variable is set in your deployment environment.
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GOOGLE_CLIENT_ID': JSON.stringify(env.GOOGLE_CLIENT_ID),
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      },
      server: {
        // Disable CORS to mitigate vulnerability where malicious sites can request source files.
        cors: false,
      },
      build: {
        outDir: 'web', // Emit assets to a 'web' directory.
        sourcemap: true, // Enable source maps for easier debugging in production.
        rollupOptions: {
          output: {
            // Improve caching by splitting vendor code into separate chunks.
            manualChunks(id) {
              if (id.includes('node_modules')) {
                return id.toString().split('node_modules/')[1].split('/')[0].toString();
              }
            }
          }
        }
      }
    };
});\\\`,
'components/features/ProjectExplorer.tsx': \\\`import React, { useState, useEffect, useCallback } from 'react';
import { useGlobalState } from '../../contexts/GlobalStateContext.tsx';
import { useNotification } from '../../contexts/NotificationContext.tsx';
import { initializeOctokit } from '../../services/authService.ts';
import { getDecryptedCredential } from '../../services/vaultService.ts';
import { getRepos, getRepoTree, getFileContent, commitFiles } from '../../services/githubService.ts';
import { generateCommitMessageStream } from '../../services/index.ts';
import type { Repo, FileNode } from '../../types.ts';
import { FolderIcon, DocumentIcon } from '../icons.tsx';
import { LoadingSpinner } from '../shared/index.tsx';
import * as Diff from 'diff';

const FileTree: React.FC<{ node: FileNode, onFileSelect: (path: string, name: string) => void, activePath: string | null }> = ({ node, onFileSelect, activePath }) => {
    const [isOpen, setIsOpen] = useState(true);

    if (node.type === 'file') {
        const isActive = activePath === node.path;
        return (
            <div
                className={\\\\\\\`flex items-center space-x-2 pl-4 py-1 cursor-pointer rounded \\\\\\\${isActive ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}\\\\\\\`}
                onClick={() => onFileSelect(node.path, node.name)}
            >
                <DocumentIcon />
                <span>{node.name}</span>
            </div>
        );
    }

    return (
        <div>
            <div
                className="flex items-center space-x-2 py-1 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 rounded"
                onClick={() => setIsOpen(!isOpen)}
            >
                <div className={\\\\\\\`transform transition-transform \\\\\\\${isOpen ? 'rotate-90' : ''}\\\\\\\`}>▶</div>
                <FolderIcon />
                <span className="font-semibold">{node.name}</span>
            </div>
            {isOpen && node.children && (
                <div className="pl-4 border-l border-border ml-3">
                    {node.children.map(child => <FileTree key={child.path} node={child} onFileSelect={onFileSelect} activePath={activePath} />)}
                </div>
            )}
        </div>
    );
};

export const ProjectExplorer: React.FC = () => {
    const { state, dispatch } = useGlobalState();
    const { user, githubUser, selectedRepo, projectFiles } = state;
    const { addNotification } = useNotification();
    const [repos, setRepos] = useState<Repo[]>([]);
    const [isLoading, setIsLoading] = useState<'repos' | 'tree' | 'file' | 'commit' | null>(null);
    const [error, setError] = useState('');
    const [activeFile, setActiveFile] = useState<{ path: string; name: string; originalContent: string; editedContent: string} | null>(null);
    
    const getApiClient = useCallback(async () => {
        if (!user) {
            throw new Error("You must be logged in to use the Project Explorer.");
        }
        // NOTE: This assumes the vault is unlocked. A more robust implementation
        // might use the useVaultModal hook to prompt for unlock if needed.
        const token = await getDecryptedCredential('github_pat');
        if (!token) {
            throw new Error("GitHub token not found. Please add it on the Connections page.");
        }
        return initializeOctokit(token);
    }, [user]);


    useEffect(() => {
        const loadRepos = async () => {
            if (user && githubUser) {
                setIsLoading('repos');
                setError('');
                try {
                    const octokit = await getApiClient();
                    const userRepos = await getRepos(octokit);
                    setRepos(userRepos);
                } catch (err) {
                    setError(err instanceof Error ? err.message : 'Failed to load repositories');
                } finally {
                    setIsLoading(null);
                }
            } else {
                setRepos([]);
            }
        };
        loadRepos();
    }, [user, githubUser, getApiClient]);

    useEffect(() => {
        const loadTree = async () => {
             if (selectedRepo && user && githubUser) {
                setIsLoading('tree');
                setError('');
                setActiveFile(null);
                try {
                    const octokit = await getApiClient();
                    const tree = await getRepoTree(octokit, selectedRepo.owner, selectedRepo.repo);
                    dispatch({ type: 'LOAD_PROJECT_FILES', payload: tree });
                } catch (err) {
                     setError(err instanceof Error ? err.message : 'Failed to load repository tree');
                } finally {
                    setIsLoading(null);
                }
            }
        };
        loadTree();
    }, [selectedRepo, user, githubUser, dispatch, getApiClient]);

    const handleFileSelect = async (path: string, name: string) => {
        if (!selectedRepo) return;
        setIsLoading('file');
        try {
            const octokit = await getApiClient();
            const content = await getFileContent(octokit, selectedRepo.owner, selectedRepo.repo, path);
            setActiveFile({ path, name, originalContent: content, editedContent: content });
        } catch (err) {
            setError((err as Error).message);
        } finally {
            setIsLoading(null);
        }
    };

    const handleCommit = async () => {
        if (!activeFile || !selectedRepo || activeFile.originalContent === activeFile.editedContent) return;

        setIsLoading('commit');
        setError('');
        try {
            const diff = Diff.createPatch(activeFile.path, activeFile.originalContent, activeFile.editedContent);
            
            const stream = generateCommitMessageStream(diff);
            let commitMessage = '';
            for await (const chunk of stream) { commitMessage += chunk; }
            
            const finalMessage = window.prompt("Confirm or edit commit message:", commitMessage);
            if (!finalMessage) {
                setIsLoading(null);
                return;
            }

            const octokit = await getApiClient();
            await commitFiles(
                octokit,
                selectedRepo.owner,
                selectedRepo.repo,
                [{ path: activeFile.path, content: activeFile.editedContent }],
                finalMessage
            );
            
            addNotification(\\\\\\\`Successfully committed to \\\\\\\${selectedRepo.repo}\\\\\\\`, 'success');
            setActiveFile(prev => prev ? { ...prev, originalContent: prev.editedContent } : null);

        } catch (err) {
            const message = err instanceof Error ? err.message : 'Failed to commit changes';
            setError(message);
            addNotification(message, 'error');
        } finally {
            setIsLoading(null);
        }
    };
    
    if (!user) {
        return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Please Sign In</h2>
                <p>Sign in via the "Connections" tab to explore your repositories.</p>
            </div>
        );
    }
    
    if (!githubUser) {
         return (
            <div className="h-full flex flex-col items-center justify-center text-center text-text-secondary p-4">
                <FolderIcon />
                <h2 className="text-lg font-semibold mt-2">Connect to GitHub</h2>
                <p>Please go to the "Connections" tab and provide a Personal Access Token to explore your repositories.</p>
            </div>
        );
    }

    const hasChanges = activeFile ? activeFile.originalContent !== activeFile.editedContent : false;

    return (
        <div className="h-full flex flex-col text-text-primary">
            <header className="p-4 border-b border-border flex-shrink-0">
                <h1 className="text-xl font-bold flex items-center"><FolderIcon /><span className="ml-3">Project Explorer</span></h1>
                <div className="mt-2">
                    <select
                        value={selectedRepo ? \\\\\\\`\\\\\\\${selectedRepo.owner}/\\\\\\\${selectedRepo.repo}\\\\\\\` : ''}
                        onChange={e => {
                            const [owner, repo] = e.target.value.split('/');
                            dispatch({ type: 'SET_SELECTED_REPO', payload: { owner, repo } });
                        }}
                        className="w-full p-2 bg-surface border border-border rounded-md text-sm"
                    >
                        <option value="" disabled>{isLoading === 'repos' ? 'Loading...' : 'Select a repository'}</option>
                        {repos.map(r => <option key={r.id} value={r.full_name}>{r.full_name}</option>)}
                    </select>
                </div>
                {error && <p className="text-red-500 text-xs mt-2">{error}</p>}
            </header>
            <div className="flex-grow flex min-h-0">
                <aside className="w-1/3 bg-background border-r border-border p-4 overflow-y-auto">
                    {isLoading === 'tree' && <div className="flex justify-center"><LoadingSpinner /></div>}
                    {projectFiles && <FileTree node={projectFiles} onFileSelect={handleFileSelect} activePath={activeFile?.path ?? null} />}
                </aside>
                <main className="flex-1 bg-surface flex flex-col">
                     <div className="flex justify-between items-center p-2 border-b border-border bg-gray-50 dark:bg-slate-800">
                        <span className="text-sm font-semibold">{activeFile?.name || 'No file selected'}</span>
                        <button onClick={handleCommit} disabled={!hasChanges || isLoading === 'commit'} className="btn-primary px-4 py-1 text-sm flex items-center justify-center min-w-[100px]">
                           {isLoading === 'commit' ? <LoadingSpinner/> : 'Commit'}
                        </button>
                     </div>
                     {isLoading === 'file' ? <div className="flex items-center justify-center h-full"><LoadingSpinner /></div> :
                        <textarea 
                            value={activeFile?.editedContent ?? 'Select a file to view its content.'}
                            onChange={e => setActiveFile(prev => prev ? { ...prev, editedContent: e.target.value } : null)}
                            disabled={!activeFile}
                            className="w-full h-full p-4 text-sm font-mono bg-transparent resize-none focus:outline-none"
                        />
                    }
                </main>
            </div>
        </div>
    );
};\\\`,
};\`,
  'services/taxonomyService.ts': \`export interface FeatureTaxonomy {
    id: string;
    name: string;
    description: string;
    category: string;
    inputs: string;
}

export const FEATURE_TAXONOMY: FeatureTaxonomy[] = [
    {
        id: "ai-command-center",
        name: "AI Command Center",
        description: "The main entry point. Use natural language to navigate and control the entire toolkit. Can call other tools.",
        category: "Core",
        inputs: "A natural language prompt describing what the user wants to do. Examples: 'explain this code: ...', 'design a theme with space vibes'."
    },
    {
        id: "workspace-connector-hub",
        name: "Workspace Connector Hub",
        description: "A central hub to execute actions on connected third-party services like Jira, Slack, GitHub, Vercel, and more. This is the primary tool for inter-service orchestration. The AI should use the 'runWorkspaceAction' function to interact with it.",
        category: "Workflow",
        inputs: "A natural language command describing a sequence of actions. Examples: 'create a jira ticket and post to slack', 'deploy the \\\`dev\\\` branch to vercel', 'summarize the last 5 commits and create a Confluence page'."
    },
    {
        id: "ai-code-explainer",
        name: "AI Code Explainer",
        description: "Accepts a code snippet and provides a detailed, structured analysis including summary, line-by-line breakdown, complexity, suggestions, and a visual flowchart.",
        category: "AI Tools",
        inputs: "A string containing a code snippet."
    },
    {
        id: "theme-designer",
        name: "AI Theme Designer",
        description: "Generates a complete UI color theme, including a semantic palette and accessibility scores, from a simple text description or an uploaded image.",
        category: "AI Tools",
        inputs: "A string describing the desired aesthetic (e.g., 'a calm, minimalist theme for a blog') or an image file."
    },
    {
        id: "regex-sandbox",
        name: "RegEx Sandbox",
        description: "Generates a regular expression from a natural language description. Also allows testing expressions against a string.",
        category: "Testing",
        inputs: "A string describing the pattern to match. Example: 'find all email addresses'."
    },
    {
        id: "ai-pull-request-assistant",
        name: "AI Pull Request Assistant",
        description: "Takes 'before' and 'after' code snippets, calculates the diff, generates a structured pull request summary (title, description, changes), and populates a full PR template.",
        category: "AI Tools",
        inputs: "Two strings: 'beforeCode' and 'afterCode'."
    },
     {
        id: "visual-git-tree",
        name: "AI Git Log Analyzer",
        description: "Intelligently parses a raw 'git log' output to create a categorized and well-formatted changelog, separating new features from bug fixes.",
        category: "Git",
        inputs: "A string containing the raw output of a 'git log' command."
    },
    {
        id: "cron-job-builder",
        name: "AI Cron Job Builder",
        description: "Generates a valid cron expression from a natural language description of a schedule.",
        category: "Deployment",
        inputs: "A string describing a schedule. Example: 'every weekday at 5pm'."
    },
    {
        id: "ai-code-migrator",
        name: "AI Code Migrator",
        description: "Translate code between languages & frameworks.",
        category: "AI Tools",
        inputs: "A string of code to convert, a string for the source language, and a string for the target language. e.g. 'migrate this SASS to CSS: ...'"
    },
    {
        id: "ai-commit-generator",
        name: "AI Commit Message Generator",
        description: "Generates a conventional commit message from a git diff.",
        category: "AI Tools",
        inputs: "A string containing a git diff."
    },
    {
        id: "worker-thread-debugger",
        name: "AI Concurrency Analyzer",
        description: "Analyzes JavaScript code for potential Web Worker concurrency issues like race conditions.",
        category: "Testing",
        inputs: "A string of JavaScript code to analyze for concurrency issues."
    },
    {
        id: "xbrl-converter",
        name: "XBRL Converter",
        description: "Converts a JSON object into a simplified XBRL-like XML format.",
        category: "Data",
        inputs: "A string containing valid JSON."
    },
    {
        id: "api-mock-generator",
        name: "API Mock Server",
        description: "Generates mock API data from a description and serves it locally using a service worker.",
        category: "Local Dev",
        inputs: "A text description of a data schema (e.g., 'a user with id, name, and email')."
    },
    {
        id: "env-manager",
        name: ".env Manager",
        description: "A graphical interface for creating and managing .env files.",
        category: "Local Dev",
        inputs: "Key-value pairs for environment variables."
    },
    {
        id: "performance-profiler",
        name: "AI Performance Profiler",
        description: "Analyze runtime performance traces and bundle stats to get AI-powered optimization advice.",
        category: "Performance & Auditing",
        inputs: "Runtime performance data or pasted bundle statistics JSON."
    },
    {
        id: "a11y-auditor",
        name: "Accessibility Auditor",
        description: "Audit a live URL for accessibility issues and get AI-powered suggestions for fixes.",
        category: "Performance & Auditing",
        inputs: "A URL to a website or web application."
    },
    {
        id: "ci-cd-generator",
        name: "AI CI/CD Pipeline Architect",
        description: "Generate CI/CD configuration files (e.g., GitHub Actions YAML) from a natural language description.",
        category: "Deployment & CI/CD",
        inputs: "A text description of deployment stages (e.g., 'install, test, build, deploy')."
    },
    {
        id: "deployment-preview",
        name: "Static Deployment Previewer",
        description: "See a live preview of files generated by the AI Feature Builder as if they were statically deployed.",
        category: "Deployment & CI/CD",
        inputs: "Files stored in the app's local database from the AI Feature Builder."
    },
    {
        id: "security-scanner",
        name: "AI Security Scanner",
        description: "Perform static analysis on code snippets to find common vulnerabilities and get AI-driven mitigation advice.",
        category: "Security",
        inputs: "A string containing a code snippet."
    },
    {
        id: "gmail-addon-simulator",
        name: "Gmail Add-on Simulator",
        description: "A simulation of how this app could use contextual Gmail Add-on scopes to read the current email and compose replies with AI assistance.",
        category: "Productivity",
        inputs: "A mock email context. No user input required to launch the simulation."
    },
    {
        id: "iam-policy-visualizer",
        name: "GCP IAM Policy Visualizer",
        description: "Visually test what a user can and cannot do across a set of Google Cloud resources.",
        category: "Cloud",
        inputs: "A list of full GCP resource names and a list of permission strings to test."
    }
];\`,
  'services/telemetryService.ts': \`

const isTelemetryEnabled = true; // Could be controlled by a setting

const sanitizePayload = (payload: Record<string, any>): Record<string, any> => {
    const sanitized: Record<string, any> = {};
    for (const key in payload) {
        if (Object.prototype.hasOwnProperty.call(payload, key)) {
            const value = payload[key];
            // Truncate long strings to avoid polluting the console (e.g., base64 data)
            if (typeof value === 'string' && value.length > 500) {
                sanitized[key] = \\\`\\\${value.substring(0, 100)}... (truncated)\\\`;
            } else {
                sanitized[key] = value;
            }
        }
    }
    return sanitized;
};


export const logEvent = (eventName: string, payload: Record<string, any> = {}) => {
  if (!isTelemetryEnabled) return;

  console.log(
    \\\`%c[TELEMETRY EVENT]%c \\\${eventName}\\\`,
    'color: #84cc16; font-weight: bold;',
    'color: inherit;',
    sanitizePayload(payload)
  );
};

export const logError = (error: Error, context: Record<string, any> = {}) => {
  if (!isTelemetryEnabled) return;

  console.error(
    \\\`%c[TELEMETRY ERROR]%c \\\${error.message}\\\`,
    'color: #ef4444; font-weight: bold;',
    'color: inherit;',
    {
      error,
      context: sanitizePayload(context),
      stack: error.stack,
    }
  );
};

export const measurePerformance = async <T>(
  metricName: string,
  operation: () => Promise<T>
): Promise<T> => {
  const start = performance.now();
  try {
    const result = await operation();
    const end = performance.now();
    const duration = end - start;

    if (isTelemetryEnabled) {
      console.log(
        \\\`%c[TELEMETRY PERF]%c \\\${metricName}\\\`,
        'color: #3b82f6; font-weight: bold;',
        'color: inherit;',
        { duration: \\\`\\\${duration.toFixed(2)}ms\\\` }
      );
    }
    return result;
  } catch (error) {
    const end = performance.now();
    const duration = end - start;
     if (isTelemetryEnabled) {
        console.warn(
          \\\`%c[TELEMETRY PERF FAILED]%c \\\${metricName}\\\`,
          'color: #f97316; font-weight: bold;',
          'color: inherit;',
          { duration: \\\`\\\${duration.toFixed(2)}ms\\\`, error }
        );
      }
    throw error;
  }
};\`,
  'services/vaultService.ts': \`/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import * as crypto from './cryptoService.ts';
import * as db from './dbService.ts';
import type { EncryptedData } from '../types.ts';

let sessionKey: CryptoKey | null = null;

export const isVaultInitialized = async (): Promise<boolean> => {
    const salt = await db.getVaultData('pbkdf2-salt');
    return !!salt;
};

export const initializeVault = async (masterPassword: string): Promise<void> => {
    if (await isVaultInitialized()) {
        throw new Error("Vault is already initialized.");
    }
    const salt = crypto.generateSalt();
    await db.saveVaultData('pbkdf2-salt', salt);
    sessionKey = await crypto.deriveKey(masterPassword, salt);
};

export const isUnlocked = (): boolean => {
    return sessionKey !== null;
};

export const unlockVault = async (masterPassword: string): Promise<void> => {
    const salt = await db.getVaultData('pbkdf2-salt');
    if (!salt) {
        throw new Error("Vault not initialized.");
    }
    try {
        sessionKey = await crypto.deriveKey(masterPassword, salt);
    } catch (e) {
        console.error("Key derivation failed, likely incorrect password", e);
        throw new Error("Invalid Master Password.");
    }
};

export const lockVault = (): void => {
    sessionKey = null;
};

export const saveCredential = async (id: string, plaintext: string): Promise<void> => {
    if (!sessionKey) {
        throw new Error("Vault is locked. Cannot save credential.");
    }
    const { ciphertext, iv } = await crypto.encrypt(plaintext, sessionKey);
    const encryptedData: EncryptedData = {
        id,
        ciphertext,
        iv
    };
    await db.saveEncryptedToken(encryptedData);
};

export const getDecryptedCredential = async (id: string): Promise<string | null> => {
    if (!sessionKey) {
        throw new Error("Vault is locked. Cannot retrieve credential.");
    }
    const encryptedData = await db.getEncryptedToken(id);
    if (!encryptedData) {
        return null;
    }
    try {
        return await crypto.decrypt(encryptedData.ciphertext, sessionKey, encryptedData.iv);
    } catch (e) {
        console.error(\\\`Decryption failed for \\\${id}\\\`, e);
        lockVault(); // Relock the vault on decryption failure as a security measure
        throw new Error("Decryption failed. The vault has been locked.");
    }
};

export const listCredentials = async (): Promise<string[]> => {
    return db.getAllEncryptedTokenIds();
};

export const resetVault = async (): Promise<void> => {
    await db.clearAllData();
    lockVault();
}\`,
  'services/workspaceConnectorService.ts': \`import * as vaultService from './vaultService.ts';
import { logError, logEvent } from './telemetryService.ts';
import { getDecryptedCredential } from './vaultService.ts';

// Interface for any action
export interface WorkspaceAction {
  id: string; // e.g., 'jira_create_ticket'
  service: 'Jira' | 'Slack' | 'GitHub'; // etc.
  description: string;
  // Function to define the necessary input fields for this action
  getParameters: () => { [key: string]: { type: 'string' | 'number', required: boolean, default?: string } };
  // The actual logic to execute the action
  execute: (params: any) => Promise<any>;
}

// THE REGISTRY: This is the pattern for all services.
export const ACTION_REGISTRY: Map<string, WorkspaceAction> = new Map();

// --- JIRA EXAMPLE ---
ACTION_REGISTRY.set('jira_create_ticket', {
  id: 'jira_create_ticket',
  service: 'Jira',
  description: 'Creates a new issue in a Jira project.',
  getParameters: () => ({
    projectKey: { type: 'string', required: true },
    summary: { type: 'string', required: true },
    description: { type: 'string', required: false },
    issueType: { type: 'string', required: true, default: 'Task' }
  }),
  execute: async (params) => {
    const domain = await getDecryptedCredential('jira_domain');
    const token = await getDecryptedCredential('jira_pat');
    const email = await getDecryptedCredential('jira_email');

    if (!domain || !token || !email) {
        throw new Error("Jira credentials not found in vault. Please connect Jira in the Workspace Connector Hub.");
    }
    
    // The Atlassian Document Format for the description field
    const descriptionDoc = {
      type: 'doc',
      version: 1,
      content: [
        {
          type: 'paragraph',
          content: [
            {
              text: params.description || '',
              type: 'text'
            }
          ]
        }
      ]
    };

    const response = await fetch(\\\`https://\\\${domain}/rest/api/3/issue\\\`, {
      method: 'POST',
      headers: {
        'Authorization': \\\`Basic \\\${btoa(\\\`\\\${email}:\\\${token}\\\`)}\\\`,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fields: {
           project: { key: params.projectKey },
           summary: params.summary,
           description: descriptionDoc,
           issuetype: { name: params.issueType || 'Task' }
        }
      })
    });
    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(\\\`Jira API Error (\\\${response.status}): \\\${errorBody}\\\`);
    }
    return response.json();
  }
});

// --- SLACK EXAMPLE ---
ACTION_REGISTRY.set('slack_post_message', {
  id: 'slack_post_message',
  service: 'Slack',
  description: 'Posts a message to a Slack channel.',
  getParameters: () => ({
    channel: { type: 'string', required: true }, // e.g., #engineering or C1234567
    text: { type: 'string', required: true }
  }),
  execute: async (params) => {
    const token = await getDecryptedCredential('slack_bot_token');
    if (!token) {
        throw new Error("Slack credentials not found in vault. Please connect Slack in the Workspace Connector Hub.");
    }
    const response = await fetch('https://slack.com/api/chat.postMessage', {
        method: 'POST',
        headers: {
            'Authorization': \\\`Bearer \\\${token}\\\`,
            'Content-Type': 'application/json; charset=utf-8'
        },
        body: JSON.stringify({
            channel: params.channel,
            text: params.text
        })
    });
     if (!response.ok) {
        const errorBody = await response.json();
        throw new Error(\\\`Slack API Error: \\\${errorBody.error}\\\`);
    }
    return response.json();
  }
});


// --- CENTRAL EXECUTION FUNCTION ---
export async function executeWorkspaceAction(actionId: string, params: any): Promise<any> {
    const action = ACTION_REGISTRY.get(actionId);
    if (!action) {
        throw new Error(\\\`Action "\\\${actionId}" not found.\\\`);
    }
    logEvent('workspace_action_execute', { actionId });
    try {
        const result = await action.execute(params);
        logEvent('workspace_action_success', { actionId });
        return result;
    } catch (error) {
        logError(error as Error, { context: 'executeWorkspaceAction', actionId });
        throw error;
    }
}\`,
  'services/workspaceService.ts': \`

import { ensureGapiClient } from './googleApiService.ts';
import { logError } from './telemetryService.ts';
import type { SlideSummary } from '../types.ts';

declare var gapi: any;

// --- Docs Service ---
export const createDocument = async (title: string): Promise<{ documentId: string; webViewLink: string }> => {
    try {
        const isReady = await ensureGapiClient();
        if (!isReady) throw new Error("Google API client not ready.");
        
        await gapi.client.load('https://docs.googleapis.com/\\\$discovery/rest?version=v1');

        const response = await gapi.client.docs.documents.create({ title });
        const doc = response.result;
        return { documentId: doc.documentId, webViewLink: \\\`https://docs.google.com/document/d/\\\${doc.documentId}/edit\\\` };
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'createDocument' });
        throw error;
    }
};

export const insertText = async (documentId: string, text: string): Promise<void> => {
     try {
        const isReady = await ensureGapiClient();
        if (!isReady) throw new Error("Google API client not ready.");

        await gapi.client.load('https://docs.googleapis.com/\\\$discovery/rest?version=v1');

        await gapi.client.docs.documents.batchUpdate({
            documentId,
            resource: {
                requests: [{
                    insertText: {
                        text: text,
                        location: { index: 1 }
                    }
                }]
            }
        });
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'insertText' });
        throw error;
    }
};

// --- Drive Service ---

const getDriveClient = async () => {
    const isReady = await ensureGapiClient();
    if (!isReady) throw new Error("Google API client not ready.");
    await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
    return gapi.client.drive;
};

export const findOrCreateFolder = async (folderName: string): Promise<string> => {
    try {
        const drive = await getDriveClient();
        const query = \\\`mimeType='application/vnd.google-apps.folder' and name='\\\${folderName}' and trashed=false\\\`;
        const response = await drive.files.list({ q: query, fields: 'files(id, name)' });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id;
        } else {
            const fileMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            const createResponse = await drive.files.create({ resource: fileMetadata, fields: 'id' });
            return createResponse.result.id;
        }
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'findOrCreateFolder' });
        throw error;
    }
};

export const uploadFile = async (folderId: string, fileName: string, content: string, mimeType: string): Promise<any> => {
    try {
        await getDriveClient(); // Ensures client is loaded
        
        const metadata = {
            name: fileName,
            parents: [folderId],
            mimeType,
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: mimeType }));

        const token = sessionStorage.getItem('google_access_token');
        if (!token) throw new Error("Not authenticated");

        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                Authorization: \\\`Bearer \\\${token}\\\`
            },
            body: form
        });
        
        if (!res.ok) {
            const errorBody = await res.json();
            throw new Error(\\\`Failed to upload file: \\\${errorBody.error.message}\\\`);
        }

        return await res.json();
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'uploadFile' });
        throw error;
    }
};

// Stubs for other Workspace services
export const appendRowToSheet = async (sheetId: string, rowData: any[]) => { console.log('appendRowToSheet called', sheetId, rowData); };
export const createTask = async (listId: string, title: string, notes: string) => { console.log('createTask called', listId, title, notes); };
export const createCalendarEvent = async (title: string, description: string, date: string) => { console.log('createCalendarEvent called', title, description, date); };\`,
  'tailwind.config.js': \`import typography from '@tailwindcss/typography';

/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class',
  content: [
    "./index.html",
    "./App.tsx",
    "./index.tsx",
    "./constants.tsx",
    "./types.ts",
    "./components/**/*.{js,ts,jsx,tsx}",
    "./contexts/**/*.{js,ts,jsx,tsx}",
    "./hooks/**/*.{js,ts,jsx,tsx}",
    "./services/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        serif: ['"EB Garamond"', 'serif'],
        calligraphy: ['"Great Vibes"', 'cursive'],
      },
      colors: {
        'primary': 'var(--color-primary)',
        'background': 'var(--color-background)',
        'surface': 'var(--color-surface)',
        'text': {
          'primary': 'var(--color-text-primary)',
          'secondary': 'var(--color-text-secondary)',
          'on-primary': 'var(--color-text-on-primary)',
        },
        'border': 'var(--color-border)',
        'gold': '#B8860B', // DarkGoldenRod - better for watermark
      },
       boxShadow: {
        'focus-primary': '0 0 0 3px rgba(var(--color-primary-rgb), 0.4)',
        'md': '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
      },
    },
  },
  plugins: [
     typography,
  ],
}\`,
  'tsconfig.json': \`
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ES2022",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}\`,
  'tsconfig.server.json': \`
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "CommonJS",
    "moduleResolution": "node",
    "outDir": "./",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true
  }
}
\`,
  'types.ts': \`import type React from 'react';
import { CHROME_VIEW_IDS, FEATURE_CATEGORIES } from './constants.tsx';

export type ChromeViewType = typeof CHROME_VIEW_IDS[number];
export type FeatureId = string;
export type FeatureCategory = typeof FEATURE_CATEGORIES[number];

export interface Feature {
  id: FeatureId;
  name: string;
  description: string;
  icon: React.ReactNode;
  category: FeatureCategory;
  component: React.FC<any>;
  aiConfig?: {
    model: string;
    systemInstruction?: string;
  };
}

export type ViewType = FeatureId | ChromeViewType;

export interface GeneratedFile {
  filePath: string;
  content: string;
  description: string;
}

export interface SidebarItem {
  id: string;
  label: string;
  icon: React.ReactNode;
  view: ViewType;
  props?: any;
  action?: () => void;
}

export interface StructuredPrSummary {
    title: string;
    summary: string;
    changes: string[];
}

export interface AppUser {
  uid: string;
  displayName: string | null;
  email: string | null;
  photoURL: string | null;
  tier: 'free' | 'pro';
}

export interface GitHubUser {
  login: string;
  id: number;
  avatar_url: string;
  html_url: string;
  name: string | null;
  email: string | null;
}

export interface FileNode {
  name: string;
  type: 'file' | 'folder';
  path: string;
  content?: string;
  children?: FileNode[];
}

export type Theme = 'light' | 'dark';

export interface StructuredExplanation {
    summary: string;
    lineByLine: { lines: string; explanation: string }[];
    complexity: { time: string; space: string };
    suggestions: string[];
}

export interface ColorTheme {
    primary: string;
    background: string;
    surface: string;
    textPrimary: string;
    textSecondary: string;
    textOnPrimary: string;
    border: string;
}

export interface ThemeState {
    mode: Theme;
    customColors: ColorTheme | null;
}

export interface SemanticColorTheme {
    mode: 'light' | 'dark';
    palette: {
        primary: { value: string; name: string; };
        secondary: { value: string; name: string; };
        accent: { value: string; name: string; };
        neutral: { value: string; name: string; };
    };
    theme: {
        background: { value: string; name: string; };
        surface: { value: string; name: string; };
        textPrimary: { value: string; name: string; };
        textSecondary: { value: string; name: string; };
        textOnPrimary: { value: string; name: string; };
        border: { value: string; name: string; };
    };
    accessibility: {
        primaryOnSurface: { ratio: number; score: string; };
        textPrimaryOnSurface: { ratio: number; score:string; };
        textSecondaryOnSurface: { ratio: number; score: string; };
        textOnPrimaryOnPrimary: { ratio: number; score: string; };
    };
}

export interface SlideSummary {
    title: string;
    body: string;
}

export interface Repo {
  id: number;
  name: string;
  full_name: string;
  private: boolean;
  html_url: string;
  description: string | null;
  // Fix: Add owner property to match GitHub API response shape
  owner: { login: string; };
}

// --- Code Review Types ---
export interface StructuredReviewSuggestion {
    suggestion: string;
    codeBlock: string;
    explanation: string;
}

export interface StructuredReview {
    summary: string;
    suggestions: StructuredReviewSuggestion[];
}

// --- AI Personality Forge Types ---
export interface SystemPrompt {
  id: string;
  name: string;
  persona: string;
  rules: string[];
  outputFormat: 'json' | 'markdown' | 'text';
  exampleIO: { input: string; output: string }[];
}

// --- Vault Types ---
export interface EncryptedData {
    id: string;
    ciphertext: ArrayBuffer;
    iv: Uint8Array;
}

// --- New Types for Implemented Features ---
export interface SecurityVulnerability {
    vulnerability: string;
    severity: 'Critical' | 'High' | 'Medium' | 'Low' | 'Informational';
    description: string;
    mitigation: string;
    exploitSuggestion?: string;
}

export interface CodeSmell {
    smell: string;
    line: number;
    explanation: string;
}\`,
  'utils/.placeholder': \`\`,
  'utils/promptUtils.ts': \`import type { SystemPrompt } from '../types.ts';

/**
 * Converts a structured SystemPrompt object into a single string
 * that can be used as the \\\`systemInstruction\\\` for the Gemini API.
 * @param prompt The SystemPrompt object.
 * @returns A formatted string representing the system prompt.
 */
export const formatSystemPromptToString = (prompt: SystemPrompt): string => {
    if (!prompt) return "You are a helpful assistant.";

    let instruction = \\\`**PERSONA:**\\\\n\\\${prompt.persona}\\\\n\\\\n\\\`;

    if (prompt.rules && prompt.rules.length > 0) {
        instruction += \\\`**RULES:**\\\\n\\\${prompt.rules.map(rule => \\\`- \\\${rule}\\\`).join('\\\\n')}\\\\n\\\\n\\\`;
    }

    if (prompt.outputFormat) {
        instruction += \\\`**OUTPUT FORMAT:**\\\\nYou must respond in \\\${prompt.outputFormat} format.\\\\n\\\\n\\\`;
    }

    if (prompt.exampleIO && prompt.exampleIO.length > 0) {
        instruction += \\\`**EXAMPLES:**\\\\n\\\`;
        prompt.exampleIO.forEach(ex => {
            if (ex.input && ex.output) {
                instruction += \\\`User Input:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${ex.input}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\`;
                instruction += \\\`Your Output:\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n\\\${ex.output}\\\\n\\\\\\\`\\\\\\\`\\\\\\\`\\\\n---\\\\n\\\`;
            }
        });
    }

    return instruction.trim();
};\`,
  'vite.config.ts': \`import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');

    return {
      base: './',
      optimizeDeps: {
        exclude: [
          'axe-core'
        ]
      },
      define: {
        // The Google Client ID is still needed for the auth library to initialize.
        'process.env.GOOGLE_CLIENT_ID': JSON.stringify(env.GOOGLE_CLIENT_ID),
        // The Gemini key is now handled at runtime, so we ensure the variable exists but may be empty.
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY),
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      },
      server: {
        // Disable CORS to mitigate vulnerability where malicious sites can request source files.
        cors: false,
      },
      build: {
        outDir: 'web', // Emit assets to a 'web' directory.
        sourcemap: true, // Enable source maps for easier debugging in production.
        rollupOptions: {
          output: {
            // Use relative paths for chunks to ensure module resolution works
            // in environments that inline scripts as data: URIs, which breaks
            // root-relative pathing.
            entryFileNames: \\\`assets/[name]-[hash].js\\\`,
            chunkFileNames: \\\`assets/[name]-[hash].js\\\`,
            assetFileNames: \\\`assets/[name]-[hash].[ext]\\\`,
            // Improve caching by splitting vendor code into separate chunks.
            manualChunks(id) {
              if (id.includes('node_modules')) {
                return id.toString().split('node_modules/')[1].split('/')[0].toString();
              }
            }
          }
        }
      }
    };
});\`,
};
`,
  'services/taxonomyService.ts': `export interface FeatureTaxonomy {
    id: string;
    name: string;
    description: string;
    category: string;
    inputs: string;
}

export const FEATURE_TAXONOMY: FeatureTaxonomy[] = [
    {
        id: "ai-command-center",
        name: "AI Command Center",
        description: "The main entry point. Use natural language to navigate and control the entire toolkit. Can call other tools.",
        category: "Core",
        inputs: "A natural language prompt describing what the user wants to do. Examples: 'explain this code: ...', 'design a theme with space vibes'."
    },
    {
        id: "workspace-connector-hub",
        name: "Workspace Connector Hub",
        description: "A central hub to execute actions on connected third-party services like Jira, Slack, GitHub, Vercel, and more. This is the primary tool for inter-service orchestration. The AI should use the 'runWorkspaceAction' function to interact with it.",
        category: "Workflow",
        inputs: "A natural language command describing a sequence of actions. Examples: 'create a jira ticket and post to slack', 'deploy the \`dev\` branch to vercel', 'summarize the last 5 commits and create a Confluence page'."
    },
    {
        id: "ai-code-explainer",
        name: "AI Code Explainer",
        description: "Accepts a code snippet and provides a detailed, structured analysis including summary, line-by-line breakdown, complexity, suggestions, and a visual flowchart.",
        category: "AI Tools",
        inputs: "A string containing a code snippet."
    },
    {
        id: "theme-designer",
        name: "AI Theme Designer",
        description: "Generates a complete UI color theme, including a semantic palette and accessibility scores, from a simple text description or an uploaded image.",
        category: "AI Tools",
        inputs: "A string describing the desired aesthetic (e.g., 'a calm, minimalist theme for a blog') or an image file."
    },
    {
        id: "regex-sandbox",
        name: "RegEx Sandbox",
        description: "Generates a regular expression from a natural language description. Also allows testing expressions against a string.",
        category: "Testing",
        inputs: "A string describing the pattern to match. Example: 'find all email addresses'."
    },
    {
        id: "ai-pull-request-assistant",
        name: "AI Pull Request Assistant",
        description: "Takes 'before' and 'after' code snippets, calculates the diff, generates a structured pull request summary (title, description, changes), and populates a full PR template.",
        category: "AI Tools",
        inputs: "Two strings: 'beforeCode' and 'afterCode'."
    },
     {
        id: "visual-git-tree",
        name: "AI Git Log Analyzer",
        description: "Intelligently parses a raw 'git log' output to create a categorized and well-formatted changelog, separating new features from bug fixes.",
        category: "Git",
        inputs: "A string containing the raw output of a 'git log' command."
    },
    {
        id: "cron-job-builder",
        name: "AI Cron Job Builder",
        description: "Generates a valid cron expression from a natural language description of a schedule.",
        category: "Deployment",
        inputs: "A string describing a schedule. Example: 'every weekday at 5pm'."
    },
    {
        id: "ai-code-migrator",
        name: "AI Code Migrator",
        description: "Translate code between languages & frameworks.",
        category: "AI Tools",
        inputs: "A string of code to convert, a string for the source language, and a string for the target language. e.g. 'migrate this SASS to CSS: ...'"
    },
    {
        id: "ai-commit-generator",
        name: "AI Commit Message Generator",
        description: "Generates a conventional commit message from a git diff.",
        category: "AI Tools",
        inputs: "A string containing a git diff."
    },
    {
        id: "worker-thread-debugger",
        name: "AI Concurrency Analyzer",
        description: "Analyzes JavaScript code for potential Web Worker concurrency issues like race conditions.",
        category: "Testing",
        inputs: "A string of JavaScript code to analyze for concurrency issues."
    },
    {
        id: "xbrl-converter",
        name: "XBRL Converter",
        description: "Converts a JSON object into a simplified XBRL-like XML format.",
        category: "Data",
        inputs: "A string containing valid JSON."
    },
    {
        id: "api-mock-generator",
        name: "API Mock Server",
        description: "Generates mock API data from a description and serves it locally using a service worker.",
        category: "Local Dev",
        inputs: "A text description of a data schema (e.g., 'a user with id, name, and email')."
    },
    {
        id: "env-manager",
        name: ".env Manager",
        description: "A graphical interface for creating and managing .env files.",
        category: "Local Dev",
        inputs: "Key-value pairs for environment variables."
    },
    {
        id: "performance-profiler",
        name: "AI Performance Profiler",
        description: "Analyze runtime performance traces and bundle stats to get AI-powered optimization advice.",
        category: "Performance & Auditing",
        inputs: "Runtime performance data or pasted bundle statistics JSON."
    },
    {
        id: "a11y-auditor",
        name: "Accessibility Auditor",
        description: "Audit a live URL for accessibility issues and get AI-powered suggestions for fixes.",
        category: "Performance & Auditing",
        inputs: "A URL to a website or web application."
    },
    {
        id: "ci-cd-generator",
        name: "AI CI/CD Pipeline Architect",
        description: "Generate CI/CD configuration files (e.g., GitHub Actions YAML) from a natural language description.",
        category: "Deployment & CI/CD",
        inputs: "A text description of deployment stages (e.g., 'install, test, build, deploy')."
    },
    {
        id: "deployment-preview",
        name: "Static Deployment Previewer",
        description: "See a live preview of files generated by the AI Feature Builder as if they were statically deployed.",
        category: "Deployment & CI/CD",
        inputs: "Files stored in the app's local database from the AI Feature Builder."
    },
    {
        id: "security-scanner",
        name: "AI Security Scanner",
        description: "Perform static analysis on code snippets to find common vulnerabilities and get AI-driven mitigation advice.",
        category: "Security",
        inputs: "A string containing a code snippet."
    },
    {
        id: "gmail-addon-simulator",
        name: "Gmail Add-on Simulator",
        description: "A simulation of how this app could use contextual Gmail Add-on scopes to read the current email and compose replies with AI assistance.",
        category: "Productivity",
        inputs: "A mock email context. No user input required to launch the simulation."
    },
    {
        id: "iam-policy-visualizer",
        name: "GCP IAM Policy Visualizer",
        description: "Visually test what a user can and cannot do across a set of Google Cloud resources.",
        category: "Cloud",
        inputs: "A list of full GCP resource names and a list of permission strings to test."
    }
];`,
  'services/telemetryService.ts': `

const isTelemetryEnabled = true; // Could be controlled by a setting

const sanitizePayload = (payload: Record<string, any>): Record<string, any> => {
    const sanitized: Record<string, any> = {};
    for (const key in payload) {
        if (Object.prototype.hasOwnProperty.call(payload, key)) {
            const value = payload[key];
            // Truncate long strings to avoid polluting the console (e.g., base64 data)
            if (typeof value === 'string' && value.length > 500) {
                sanitized[key] = \`\${value.substring(0, 100)}... (truncated)\`;
            } else {
                sanitized[key] = value;
            }
        }
    }
    return sanitized;
};


export const logEvent = (eventName: string, payload: Record<string, any> = {}) => {
  if (!isTelemetryEnabled) return;

  console.log(
    \`%c[TELEMETRY EVENT]%c \${eventName}\`,
    'color: #84cc16; font-weight: bold;',
    'color: inherit;',
    sanitizePayload(payload)
  );
};

export const logError = (error: Error, context: Record<string, any> = {}) => {
  if (!isTelemetryEnabled) return;

  console.error(
    \`%c[TELEMETRY ERROR]%c \${error.message}\`,
    'color: #ef4444; font-weight: bold;',
    'color: inherit;',
    {
      error,
      context: sanitizePayload(context),
      stack: error.stack,
    }
  );
};

export const measurePerformance = async <T>(
  metricName: string,
  operation: () => Promise<T>
): Promise<T> => {
  const start = performance.now();
  try {
    const result = await operation();
    const end = performance.now();
    const duration = end - start;

    if (isTelemetryEnabled) {
      console.log(
        \`%c[TELEMETRY PERF]%c \${metricName}\`,
        'color: #3b82f6; font-weight: bold;',
        'color: inherit;',
        { duration: \`\${duration.toFixed(2)}ms\` }
      );
    }
    return result;
  } catch (error) {
    const end = performance.now();
    const duration = end - start;
     if (isTelemetryEnabled) {
        console.warn(
          \`%c[TELEMETRY PERF FAILED]%c \${metricName}\`,
          'color: #f97316; font-weight: bold;',
          'color: inherit;',
          { duration: \`\${duration.toFixed(2)}ms\`, error }
        );
      }
    throw error;
  }
};`,
  'services/vaultService.ts': `/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/

import * as crypto from './cryptoService.ts';
import * as db from './dbService.ts';
import type { EncryptedData } from '../types.ts';

let sessionKey: CryptoKey | null = null;

export const isVaultInitialized = async (): Promise<boolean> => {
    const salt = await db.getVaultData('pbkdf2-salt');
    return !!salt;
};

export const initializeVault = async (masterPassword: string): Promise<void> => {
    if (await isVaultInitialized()) {
        throw new Error("Vault is already initialized.");
    }
    const salt = crypto.generateSalt();
    await db.saveVaultData('pbkdf2-salt', salt);
    sessionKey = await crypto.deriveKey(masterPassword, salt);
};

export const isUnlocked = (): boolean => {
    return sessionKey !== null;
};

export const unlockVault = async (masterPassword: string): Promise<void> => {
    const salt = await db.getVaultData('pbkdf2-salt');
    if (!salt) {
        throw new Error("Vault not initialized.");
    }
    try {
        sessionKey = await crypto.deriveKey(masterPassword, salt);
    } catch (e) {
        console.error("Key derivation failed, likely incorrect password", e);
        throw new Error("Invalid Master Password.");
    }
};

export const lockVault = (): void => {
    sessionKey = null;
};

export const saveCredential = async (id: string, plaintext: string): Promise<void> => {
    if (!sessionKey) {
        throw new Error("Vault is locked. Cannot save credential.");
    }
    const { ciphertext, iv } = await crypto.encrypt(plaintext, sessionKey);
    const encryptedData: EncryptedData = {
        id,
        ciphertext,
        iv
    };
    await db.saveEncryptedToken(encryptedData);
};

export const getDecryptedCredential = async (id: string): Promise<string | null> => {
    if (!sessionKey) {
        throw new Error("Vault is locked. Cannot retrieve credential.");
    }
    const encryptedData = await db.getEncryptedToken(id);
    if (!encryptedData) {
        return null;
    }
    try {
        return await crypto.decrypt(encryptedData.ciphertext, sessionKey, encryptedData.iv);
    } catch (e) {
        console.error(\`Decryption failed for \${id}\`, e);
        lockVault(); // Relock the vault on decryption failure as a security measure
        throw new Error("Decryption failed. The vault has been locked.");
    }
};

export const listCredentials = async (): Promise<string[]> => {
    return db.getAllEncryptedTokenIds();
};

export const resetVault = async (): Promise<void> => {
    await db.clearAllData();
    lockVault();
}`,
  'services/workspaceConnectorService.ts': `import * as vaultService from './vaultService.ts';
import { logError, logEvent } from './telemetryService.ts';
import { getDecryptedCredential } from './vaultService.ts';

// Interface for any action
export interface WorkspaceAction {
  id: string; // e.g., 'jira_create_ticket'
  service: 'Jira' | 'Slack' | 'GitHub'; // etc.
  description: string;
  // Function to define the necessary input fields for this action
  getParameters: () => { [key: string]: { type: 'string' | 'number', required: boolean, default?: string } };
  // The actual logic to execute the action
  execute: (params: any) => Promise<any>;
}

// THE REGISTRY: This is the pattern for all services.
export const ACTION_REGISTRY: Map<string, WorkspaceAction> = new Map();

// --- JIRA EXAMPLE ---
ACTION_REGISTRY.set('jira_create_ticket', {
  id: 'jira_create_ticket',
  service: 'Jira',
  description: 'Creates a new issue in a Jira project.',
  getParameters: () => ({
    projectKey: { type: 'string', required: true },
    summary: { type: 'string', required: true },
    description: { type: 'string', required: false },
    issueType: { type: 'string', required: true, default: 'Task' }
  }),
  execute: async (params) => {
    const domain = await getDecryptedCredential('jira_domain');
    const token = await getDecryptedCredential('jira_pat');
    const email = await getDecryptedCredential('jira_email');

    if (!domain || !token || !email) {
        throw new Error("Jira credentials not found in vault. Please connect Jira in the Workspace Connector Hub.");
    }
    
    // The Atlassian Document Format for the description field
    const descriptionDoc = {
      type: 'doc',
      version: 1,
      content: [
        {
          type: 'paragraph',
          content: [
            {
              text: params.description || '',
              type: 'text'
            }
          ]
        }
      ]
    };

    const response = await fetch(\`https://\${domain}/rest/api/3/issue\`, {
      method: 'POST',
      headers: {
        'Authorization': \`Basic \${btoa(\`\${email}:\${token}\`)}\`,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fields: {
           project: { key: params.projectKey },
           summary: params.summary,
           description: descriptionDoc,
           issuetype: { name: params.issueType || 'Task' }
        }
      })
    });
    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(\`Jira API Error (\${response.status}): \${errorBody}\`);
    }
    return response.json();
  }
});

// --- SLACK EXAMPLE ---
ACTION_REGISTRY.set('slack_post_message', {
  id: 'slack_post_message',
  service: 'Slack',
  description: 'Posts a message to a Slack channel.',
  getParameters: () => ({
    channel: { type: 'string', required: true }, // e.g., #engineering or C1234567
    text: { type: 'string', required: true }
  }),
  execute: async (params) => {
    const token = await getDecryptedCredential('slack_bot_token');
    if (!token) {
        throw new Error("Slack credentials not found in vault. Please connect Slack in the Workspace Connector Hub.");
    }
    const response = await fetch('https://slack.com/api/chat.postMessage', {
        method: 'POST',
        headers: {
            'Authorization': \`Bearer \${token}\`,
            'Content-Type': 'application/json; charset=utf-8'
        },
        body: JSON.stringify({
            channel: params.channel,
            text: params.text
        })
    });
     if (!response.ok) {
        const errorBody = await response.json();
        throw new Error(\`Slack API Error: \${errorBody.error}\`);
    }
    return response.json();
  }
});


// --- CENTRAL EXECUTION FUNCTION ---
export async function executeWorkspaceAction(actionId: string, params: any): Promise<any> {
    const action = ACTION_REGISTRY.get(actionId);
    if (!action) {
        throw new Error(\`Action "\${actionId}" not found.\`);
    }
    logEvent('workspace_action_execute', { actionId });
    try {
        const result = await action.execute(params);
        logEvent('workspace_action_success', { actionId });
        return result;
    } catch (error) {
        logError(error as Error, { context: 'executeWorkspaceAction', actionId });
        throw error;
    }
}`,
  'services/workspaceService.ts': `

import { ensureGapiClient } from './googleApiService.ts';
import { logError } from './telemetryService.ts';
import type { SlideSummary } from '../types.ts';

declare var gapi: any;

// --- Docs Service ---
export const createDocument = async (title: string): Promise<{ documentId: string; webViewLink: string }> => {
    try {
        const isReady = await ensureGapiClient();
        if (!isReady) throw new Error("Google API client not ready.");
        
        await gapi.client.load('https://docs.googleapis.com/\$discovery/rest?version=v1');

        const response = await gapi.client.docs.documents.create({ title });
        const doc = response.result;
        return { documentId: doc.documentId, webViewLink: \`https://docs.google.com/document/d/\${doc.documentId}/edit\` };
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'createDocument' });
        throw error;
    }
};

export const insertText = async (documentId: string, text: string): Promise<void> => {
     try {
        const isReady = await ensureGapiClient();
        if (!isReady) throw new Error("Google API client not ready.");

        await gapi.client.load('https://docs.googleapis.com/\$discovery/rest?version=v1');

        await gapi.client.docs.documents.batchUpdate({
            documentId,
            resource: {
                requests: [{
                    insertText: {
                        text: text,
                        location: { index: 1 }
                    }
                }]
            }
        });
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'insertText' });
        throw error;
    }
};

// --- Drive Service ---

const getDriveClient = async () => {
    const isReady = await ensureGapiClient();
    if (!isReady) throw new Error("Google API client not ready.");
    await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
    return gapi.client.drive;
};

export const findOrCreateFolder = async (folderName: string): Promise<string> => {
    try {
        const drive = await getDriveClient();
        const query = \`mimeType='application/vnd.google-apps.folder' and name='\${folderName}' and trashed=false\`;
        const response = await drive.files.list({ q: query, fields: 'files(id, name)' });
        
        if (response.result.files && response.result.files.length > 0) {
            return response.result.files[0].id;
        } else {
            const fileMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            const createResponse = await drive.files.create({ resource: fileMetadata, fields: 'id' });
            return createResponse.result.id;
        }
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'findOrCreateFolder' });
        throw error;
    }
};

export const uploadFile = async (folderId: string, fileName: string, content: string, mimeType: string): Promise<any> => {
    try {
        await getDriveClient(); // Ensures client is loaded
        
        const metadata = {
            name: fileName,
            parents: [folderId],
            mimeType,
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: mimeType }));

        const token = sessionStorage.getItem('google_access_token');
        if (!token) throw new Error("Not authenticated");

        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                Authorization: \`Bearer \${token}\`
            },
            body: form
        });
        
        if (!res.ok) {
            const errorBody = await res.json();
            throw new Error(\`Failed to upload file: \${errorBody.error.message}\`);
        }

        return await res.json();
    } catch (error) {
        logError(error as Error, { service: 'workspaceService', function: 'uploadFile' });
        throw error;
    }
};

// Stubs for other Workspace services
export const appendRowToSheet = async (sheetId: string, rowData: any[]) => { console.log('appendRowToSheet called', sheetId, rowData); };
export const createTask = async (listId: string, title: string, notes: string) => { console.log('createTask called', listId, title, notes); };
export const createCalendarEvent = async (title: string, description: string, date: string) => { console.log('createCalendarEvent called', title, description, date); };`,
  'tailwind.config.js': `import typography from '@tailwindcss/typography';

/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class',
  content: [
    "./index.html",
    "./App.tsx",
    "./index.tsx",
    "./constants.tsx",
    "./types.ts",
    "./components/**/*.{js,ts,jsx,tsx}",
    "./contexts/**/*.{js,ts,jsx,tsx}",
    "./hooks/**/*.{js,ts,jsx,tsx}",
    "./services/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        serif: ['"EB Garamond"', 'serif'],
        calligraphy: ['"Great Vibes"', 'cursive'],
      },
      colors: {
        'primary': 'var(--color-primary)',
        'background': 'var(--color-background)',
        'surface': 'var(--color-surface)',
        'text': {
          'primary': 'var(--color-text-primary)',
          'secondary': 'var(--color-text-secondary)',
          'on-primary': 'var(--color-text-on-primary)',
        },
        'border': 'var(--color-border)',
        'gold': '#B8860B', // DarkGoldenRod - better for watermark
      },
       boxShadow: {
        'focus-primary': '0 0 0 3px rgba(var(--color-primary-rgb), 0.4)',
        'md': '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
      },
    },
  },
  plugins: [
     typography,
  ],
}`,
  'tsconfig.json': `
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ES2022",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}`,
  'tsconfig.server.json': `
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "CommonJS",
    "moduleResolution": "node",
    "outDir": "./",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true
  }
}
`,
  'types.ts': `import type React from 'react';
import { CHROME_VIEW_IDS, FEATURE_CATEGORIES } from './constants.tsx';

export type ChromeViewType = typeof CHROME_VIEW_IDS[number];
export type FeatureId = string;
export type FeatureCategory = typeof FEATURE_CATEGORIES[number];

export interface Feature {
  id: FeatureId;
  name: string;
  description: string;
  icon: React.ReactNode;
  category: FeatureCategory;
  component: React.FC<any>;
  aiConfig?: {
    model: string;
    systemInstruction?: string;
  };
}

export type ViewType = FeatureId | ChromeViewType;

export interface GeneratedFile {
  filePath: string;
  content: string;
  description: string;
}

export interface SidebarItem {
  id: string;
  label: string;
  icon: React.ReactNode;
  view: ViewType;
  props?: any;
  action?: () => void;
}

export interface StructuredPrSummary {
    title: string;
    summary: string;
    changes: string[];
}

export interface AppUser {
  uid: string;
  displayName: string | null;
  email: string | null;
  photoURL: string | null;
  tier: 'free' | 'pro';
}

export interface GitHubUser {
  login: string;
  id: number;
  avatar_url: string;
  html_url: string;
  name: string | null;
  email: string | null;
}

export interface FileNode {
  name: string;
  type: 'file' | 'folder';
  path: string;
  content?: string;
  children?: FileNode[];
}

export type Theme = 'light' | 'dark';

export interface StructuredExplanation {
    summary: string;
    lineByLine: { lines: string; explanation: string }[];
    complexity: { time: string; space: string };
    suggestions: string[];
}

export interface ColorTheme {
    primary: string;
    background: string;
    surface: string;
    textPrimary: string;
    textSecondary: string;
    textOnPrimary: string;
    border: string;
}

export interface ThemeState {
    mode: Theme;
    customColors: ColorTheme | null;
}

export interface SemanticColorTheme {
    mode: 'light' | 'dark';
    palette: {
        primary: { value: string; name: string; };
        secondary: { value: string; name: string; };
        accent: { value: string; name: string; };
        neutral: { value: string; name: string; };
    };
    theme: {
        background: { value: string; name: string; };
        surface: { value: string; name: string; };
        textPrimary: { value: string; name: string; };
        textSecondary: { value: string; name: string; };
        textOnPrimary: { value: string; name: string; };
        border: { value: string; name: string; };
    };
    accessibility: {
        primaryOnSurface: { ratio: number; score: string; };
        textPrimaryOnSurface: { ratio: number; score:string; };
        textSecondaryOnSurface: { ratio: number; score: string; };
        textOnPrimaryOnPrimary: { ratio: number; score: string; };
    };
}

export interface SlideSummary {
    title: string;
    body: string;
}

export interface Repo {
  id: number;
  name: string;
  full_name: string;
  private: boolean;
  html_url: string;
  description: string | null;
  // Fix: Add owner property to match GitHub API response shape
  owner: { login: string; };
}

// --- Code Review Types ---
export interface StructuredReviewSuggestion {
    suggestion: string;
    codeBlock: string;
    explanation: string;
}

export interface StructuredReview {
    summary: string;
    suggestions: StructuredReviewSuggestion[];
}

// --- AI Personality Forge Types ---
export interface SystemPrompt {
  id: string;
  name: string;
  persona: string;
  rules: string[];
  outputFormat: 'json' | 'markdown' | 'text';
  exampleIO: { input: string; output: string }[];
}

// --- Vault Types ---
export interface EncryptedData {
    id: string;
    ciphertext: ArrayBuffer;
    iv: Uint8Array;
}

// --- New Types for Implemented Features ---
export interface SecurityVulnerability {
    vulnerability: string;
    severity: 'Critical' | 'High' | 'Medium' | 'Low' | 'Informational';
    description: string;
    mitigation: string;
    exploitSuggestion?: string;
}

export interface CodeSmell {
    smell: string;
    line: number;
    explanation: string;
}`,
  'utils/.placeholder': ``,
  'utils/promptUtils.ts': `import type { SystemPrompt } from '../types.ts';

/**
 * Converts a structured SystemPrompt object into a single string
 * that can be used as the \`systemInstruction\` for the Gemini API.
 * @param prompt The SystemPrompt object.
 * @returns A formatted string representing the system prompt.
 */
export const formatSystemPromptToString = (prompt: SystemPrompt): string => {
    if (!prompt) return "You are a helpful assistant.";

    let instruction = \`**PERSONA:**\\n\${prompt.persona}\\n\\n\`;

    if (prompt.rules && prompt.rules.length > 0) {
        instruction += \`**RULES:**\\n\${prompt.rules.map(rule => \`- \${rule}\`).join('\\n')}\\n\\n\`;
    }

    if (prompt.outputFormat) {
        instruction += \`**OUTPUT FORMAT:**\\nYou must respond in \${prompt.outputFormat} format.\\n\\n\`;
    }

    if (prompt.exampleIO && prompt.exampleIO.length > 0) {
        instruction += \`**EXAMPLES:**\\n\`;
        prompt.exampleIO.forEach(ex => {
            if (ex.input && ex.output) {
                instruction += \`User Input:\\n\\\`\\\`\\\`\\n\${ex.input}\\n\\\`\\\`\\\`\\n\`;
                instruction += \`Your Output:\\n\\\`\\\`\\\`\\n\${ex.output}\\n\\\`\\\`\\\`\\n---\\n\`;
            }
        });
    }

    return instruction.trim();
};`,
  'vite.config.ts': `import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');

    return {
      base: './',
      optimizeDeps: {
        exclude: [
          'axe-core'
        ]
      },
      define: {
        // The Google Client ID is still needed for the auth library to initialize.
        'process.env.GOOGLE_CLIENT_ID': JSON.stringify(env.GOOGLE_CLIENT_ID),
        // The Gemini key is now handled at runtime, so we ensure the variable exists but may be empty.
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY),
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      },
      server: {
        // Disable CORS to mitigate vulnerability where malicious sites can request source files.
        cors: false,
      },
      build: {
        outDir: 'web', // Emit assets to a 'web' directory.
        sourcemap: true, // Enable source maps for easier debugging in production.
        rollupOptions: {
          output: {
            // Use relative paths for chunks to ensure module resolution works
            // in environments that inline scripts as data: URIs, which breaks
            // root-relative pathing.
            entryFileNames: \`assets/[name]-[hash].js\`,
            chunkFileNames: \`assets/[name]-[hash].js\`,
            assetFileNames: \`assets/[name]-[hash].[ext]\`,
            // Improve caching by splitting vendor code into separate chunks.
            manualChunks(id) {
              if (id.includes('node_modules')) {
                return id.toString().split('node_modules/')[1].split('/')[0].toString();
              }
            }
          }
        }
      }
    };
});`,
};
ode_modules/')[1].split('/')[0].toString();
              }
            }
          }
        }
      }
    };
});`,
};
